# 负荷数据校验功能 - 业务需求文档 (BRD)

**文档版本: 1.4 (最终版)**

## 1. 项目背景与目标

### 1.1 背景

在现有的客户档案管理模块中，我们需要为电力市场交易员和客户经理提供一个强大的工具，用于评估和分析用户负荷数据的完整性和准确性。当前，系统存在两种核心的负荷数据来源：

1.  **手工导入的电表示数数据**:
    *   **来源**: 用户现场电表，通过文件手工导入。
    *   **粒度**: 96点/日（15分钟）。
    *   **特点**: 数据周期长（可达1年以上），但**更新频率较低（如每日一次或按需导入），是获取近期（如T-1日）数据的最快途径**。此过程依赖人工操作，可能存在操作失误。数据为电能表示数（累计值）。

2.  **RPA自动采集的结算数据**:
    *   **来源**: 电力交易中心平台，通过RPA程序自动爬取。
    *   **粒度**: 48点/日（30分钟）。
    *   **特点**: 权威性高（用于最终结算），自动化获取。但数据周期短（仅客户签约后），**延迟高（T-2，即今天只能获取前天的数据）**。数据为计量点级别的时段用电量（差值）。

这两种数据源在粒度、时效性、数据类型和覆盖范围上存在显著差异。为了确保结算的准确性、识别潜在的数据质量问题并为客户提供精细化服务，必须对这两者进行融合分析，并建立一套健壮的容错机制。

### 1.2 业务目标

1.  **提升数据质量监控能力**: 建立一个可视化界面，直观展示每个客户、每个计量点的数据完整度，主动识别数据缺失或异常。
2.  **保障结算准确性**: 通过对比权威的结算数据和及时的计量数据，提前发现和定位可能导致结算争议的差异点。
3.  **提高运营效率**: 减少人工核对数据的工作量，将交易员从繁琐的数据检查工作中解放出来，专注于分析和决策。
4.  **构建健壮的分析基础**: 为未来高级功能（如负荷预测、偏差分析等）提供可靠、完整的数据基础。**确保核心分析功能在部分数据缺失时，通过自动化的数据补充和回退机制，依然能够可靠运行。**

## 2. 目标用户

| 用户角色 | 主要诉求 |
| :--- | :--- |
| **电力交易员/数据分析师** | 需要快速评估用于分析和预测的数据是否完整、准确，并信任系统能够在数据不完美时依然给出可靠的分析结果。 |
| **客户经理** | 当出现数据问题时，需要清晰了解数据来源（是手工导入还是结算补充），并与客户进行有效沟通。 |
| **系统管理员** | 监控数据导入和采集流程，确保数据按预期流入系统。 |

## 3. 功能需求 (Functional Requirements)

### FR-1: 负荷数据校验概览

*   **FR-1.1**: 提供一个全局监控仪表盘（见FR-4），展示所有客户的数据完整度和差异概况。
*   **FR-1.2**: 提供一个面向单个计量点的深度分析视图（见FR-2），包含日历热力图、对比曲线和明细数据表。

### FR-2: 日度数据对比分析视图

当用户在全局仪表盘点击详情或直接选择某个计量点后，可进入此视图。

*   **FR-2.1: 数据处理与对齐**
    *   **FR-2.1.1 (粒度统一)**: 系统需自动将96点的手工导入数据聚合为48点，以便与RPA数据进行比较。
    *   **FR-2.1.2 (类型统一)**: 手工导入的电表示数（累计值）需转换为时段用电量（差值）。
    *   **FR-2.1.3 (层级统一)**: 手工导入数据是基于电表的，系统需自动将其按所属计量点进行加总。

*   **FR-2.2: 可视化对比图表**
    *   **FR-2.2.1**: 在一个图表中同时绘制两条曲线：
        1.  **曲线A**: “预测曲线库”中的数据（源自手工导入）。
        2.  **曲线B**: “结算曲线库”中的数据（源自RPA）。
    *   **FR-2.2.2**: 图表应支持缩放、平移，并提供工具提示（Tooltip）显示在任一时点两条曲线的具体数值和差异值。
    *   **FR-2.2.3**: 对于两个数据源数值差异超过阈值（例如 5%）的时点，在图表上应有特殊标记。

*   **FR-2.3: 差异明细数据表**
    *   **FR-2.3.1**: 在图表下方提供一个数据表格，逐行展示48个时间点的数据对比情况。
    *   **FR-2.3.2**: 表格列应包括：序号、时间点、手工导入数据(kWh)、RPA结算数据(kWh)、差异值(kWh)、差异率(%)。

*   **FR-2.4: 数据校准与补偿功能**
    *   **FR-2.4.1**: 在日度数据对比分析视图中，系统应提供一个“计算补偿系数”的功能。
    *   **FR-2.4.2**: 用户点击后，系统可基于当前时间范围（如过去30天）内两条曲线的系统性偏差，自动计算出一个建议的补偿系数（或固定差值）。
    *   **FR-2.4.3**: 用户可以确认并保存此补偿系数。

### FR-3: 数据导出功能

*   **FR-3.1**: 用户应能将日度数据对比分析的明细表格（FR-2.3）导出为 Excel 文件。

### FR-4: 全局数据完整度监控仪表盘 (支持下钻)

#### FR-4.1 核心交互模式

1.  **默认视图（客户层级）**: 表格的每一行代表一个**客户**。
2.  **展开视图（计量点层级）**: 用户可点击展开客户行，查看其下属每个计量点的详细数据。

#### FR-4.2 客户层级表格设计 (默认视图)

| 列名 | 数据说明 | 示例 | 备注 |
| :--- | :--- | :--- | :--- |
| **客户名称** | 客户的名称。 | `XX化工` | 支持筛选和排序 |
| **计量点数量** | 该客户下的计量点总数。 | `3` | |
| **数据健康度** | 一个综合性的状态灯。 | 🟢 / 🟡 / 🔴 | 绿色:一切正常; 黄色:有缺失/差异; 红色:问题严重 |
| **数据覆盖范围** | 该客户最早和最晚的数据日期。 | `2024-01-15 ~ 2025-11-09` | |
| **平均完整度(手工)** | 所有计量点手工导入数据的加权平均完整度。 | `99.1%` | |
| **平均完整度(RPA)** | 所有计量点RPA结算数据的加权平均完整度。 | `99.8%` | |
| **问题计量点(缺失)** | 有数据缺失的计量点数量 / 总数量。 | `1 / 3` | **关键问题指标** |
| **问题计量点(差异)** | 与结算数据存在偏差的计量点数量 / 总数量。 | `2 / 3` | **关键问题指标** |
| **操作** | 提供一个操作入口。 | `[查看详情]` | 点击后跳转到该客户的深度分析页面 |

#### FR-4.3 后端与缓存策略

*   **API 设计**: 后端将提供一个API，一次性返回这个两级嵌套结构的数据。
*   **缓存策略**: 该缓存的**刷新机制是事件驱动的**：在手工导入或RPA采集成功后触发。

## 4. 核心业务逻辑与数据分析策略 (v1.4 最终版)

### 4.1 数据处理与存储策略 (数据源纯粹性原则)

1.  **原始数据保留**: 手工导入的96点电能表示数原始文件或数据记录应予以保留，作为不可更改的原始凭证。
2.  **标准化曲线存储**: 系统将维护**两份完全独立**的核心48点负荷曲线数据库，均以**计量点**为存储单位：
    *   **预测曲线库 (源自手工导入)**: 由96点手工导入数据经过聚合和转换（示数转用电量）后生成的48点曲线。**此数据库只包含源于手工导入的数据。**
    *   **结算曲线库 (源自RPA)**: 由RPA采集的48点结算数据直接存储形成。**此数据库只包含源于RPA的数据。**
    *   **重要**: 系统中**不存在**一个混合的、持久化的“统一负荷曲线”数据库。

### 4.2 数据校准与补偿

*   **目的**: 分析并量化“预测曲线库”与“结算曲线库”之间的系统性偏差，为其他模块提供校准依据。
*   **逻辑**:
    1.  在数据分析视图中，用户可触发“计算补偿系数”功能 (FR-2.4)。
    2.  系统选取两条曲线均存在的时段，计算整体偏差的统计特征（如平均差异率或平均差值）。
    3.  用户可将此系数保存，作为该计量点的“校准模型”。此模型独立存储，不改变任何曲线库的原始数据。

### 4.3 应用层数据借用逻辑 (替代“统一曲线”)

当下游功能（如负荷预测）需要数据时，它将在其**自身后端代码**中，**临时地、在内存中**执行以下数据获取逻辑，**绝不修改数据库**：

#### **优先级 1：经校准的手工导入数据**
*   **逻辑：** 尝试从“预测曲线库”获取数据。如果获取成功，并存在已保存的“校准模型”，则应用该模型进行计算后返回。
*   **理由：** 这是最及时、最精细，且最接近结算口径的数据。

#### **优先级 2：RPA 结算数据**
*   **逻辑：** 如果“预测曲线库”中无数据，则尝试从“结算曲线库”中获取数据作为替代。
*   **理由：** 这是权威的结算数据，是最佳的补充。

### 4.4 负荷预测模块集成逻辑

1.  **双模型策略**:
    *   **模式A (T-1高精度预测)**: 输入数据来自**应用层数据借用逻辑**，并成功获取了T-1日的数据（通常来自手工导入）。
    *   **模式B (T-2备用预测)**: 输入数据来自**应用层数据借用逻辑**，但未能获取T-1日数据，只能获取到T-2日的数据（通常来自RPA补充）。
2.  **自动化执行**:
    *   系统每日自动触发一次负荷预测。
    *   优先尝试执行**模式A**。如果数据借用逻辑无法返回T-1日的数据，则自动**降级**执行**模式B**。
    *   **如果数据借用逻辑最终仍无法为预测模型提供有效的数据输入（即两天数据均无），则当天的自动预测将不会执行，并应在系统中标记为“数据不足，无法预测”。**
3.  **手动覆盖**:
    *   当用户当天补充导入了昨日的手工数据后，可以**手动触发**一次新的预测。
    *   这次手动预测将执行模式A，其生成的更高精度的结果将**覆盖**早上自动生成的备用结果。

### 4.5 预结算模块集成逻辑

1.  **RPA数据优先**: 在进行预结算时，应**优先使用**权威的“结算曲线库”（RPA数据）。
2.  **手工数据临时代理**: 当需要对昨日（T-1）进行预结算模拟，而此时RPA数据尚未发布时，模块可**临时调用**“预测曲线库”（手工数据）作为代理数据进行估算。
3.  **数据缺失处理**: 如果进行预结算所需日期的两条曲线库中均无数据，则相关计算无法完成，系统应给出明确提示。

## 5. UI/UX 设计建议

*   **整体布局**:
    *   **全局监控页 (FR-4)**: 提供一个独立的、以客户为中心的两级可展开表格，用于宏观监控。
    *   **深度分析页 (FR-2)**: 采用经典的“筛选器-概览-详情”上下布局，用于单个计量点的钻取分析。
*   **交互设计**:
    *   点击日历中的某一天，下方区域**异步加载**并显示该日的详细分析，避免页面整体刷新。
    *   图表和表格应紧密联动。
    *   在数据表格中，应清晰展示两条曲线各自的数值，以及它们的差异。
*   **组件风格**: 遵循项目现有的 Material-UI 设计规范。
*   **响应式设计**: 确保在移动端可用。

## 6. 非功能性需求 (Non-Functional Requirements)

| 类别 | 需求描述 |
| :--- | :--- |
| **性能** | - 全局监控页加载时间应在5秒以内。<br>- 深度分析页加载时间应在3秒以内。 |
| **可用性** | - 界面应直观易懂，关键指标应有明确的视觉提示。 |
| **可靠性** | - 数据转换和计算逻辑必须经过充分测试。<br>- **系统必须能优雅地处理数据源缺失的情况。如果因数据不足导致功能无法执行，应有明确的系统状态或日志记录。** |
| **可扩展性** | - 差异告警的阈值应设计为可配置项。<br>- 数据校准模型应支持未来扩展更复杂的算法。 |

## 7. 假设与依赖
*(无变更)*

## 8. 超出范围 (Out of Scope)
*(无变更)*

---
**创建日期**: 2025年11月10日
**最后更新**: 2025年11月10日