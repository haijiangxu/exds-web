# 零售套餐管理模块 - 详细技术设计方案 (V2)

> V2 版本根据最新讨论进行了全面修订，主要变更包括：
> 1.  **列表页**：重构为“上查询、下列表”的双卡片布局。
> 2.  **编辑/新建页**：从原有的页签式/分步式设计，统一修改为单页滚动式表单布局。
> 3.  **移除校验**：根据要求，移除了所有前后端的价格比例、数据格式等校验逻辑。
> 4.  **代码结构**：明确新增/编辑页面的所有UI部分在单一组件文件中实现。
> 5.  **样式统一**：强调所有颜色、字体等样式遵循项目现有Material-UI主题，而非外部参考。

---

## 一、系统架构设计

### 1.1 功能模块划分

```
零售套餐管理模块
├── 套餐列表管理
│   ├── 列表展示与筛选
│   ├── 搜索功能
│   └── 快速操作（新增/导出/编辑/复制/归档）
├── 套餐配置管理 (单页表单)
│   ├── 基本信息配置
│   ├── 定价模式配置（固定+联动 / 价差分成）
│   └── 附加条款配置（绿电 / 封顶价）
└── 套餐状态管理
    ├── 草稿 → 生效
    ├── 生效 → 归档
```

### 1.2 技术栈

**前端**：
- React 18 + TypeScript
- Material-UI v7
- React Hook Form（表单管理）

**后端**：
- FastAPI（Python）
- Pydantic（数据模型）
- MongoDB（套餐数据存储）

---

## 二、UI 需求方案

### 2.1. 主视图（套餐列表页）

页面采用“上查询、下列表”的双卡片布局，不设页面主标题。

#### 2.1.1. 查询条件卡片

- **描述**：页面顶部的独立 `Paper` 组件，用于封装所有过滤和搜索功能。
- **查询字段**:
    - **套餐名称**: `TextField`，支持模糊搜索。
    - **套餐类型**: `Select`，选项：所有、分时段、不分时段。
    - **定价模式**: `Select`，选项：所有、固定+联动、价差分成。
    - **状态**: `Select`，选项：所有、草稿、生效、归档。
- **操作按钮**:
    - 位于卡片右侧。
    - **[ 查询 ]** 按钮 (`variant="contained"`, `color="primary"`)。
    - **[ 重置 ]** 按钮 (`variant="outlined"`)。

#### 2.1.2. 套餐列表卡片

- **描述**：页面下方的独立 `Paper` 组件，用于展示数据列表及其相关操作。
- **内部工具栏**:
    - 位于列表格的上方。
    - **左侧**:
        - **[ + 新增 ]** 按钮 (`variant="contained"`, `color="primary"`)。
        - **[ 导出 ]** 按钮 (`variant="outlined"`)。
- **数据表格 (`Table`)**:
    - **列**: 套餐名称, 套餐类型, 定价模式, 附加套餐, 状态, 创建时间, 操作。
    - **操作列**: 每行包含 `[ 编辑 ]`, `[ 复制 ]`, `[ 归档 ]` 等文本或图标按钮。
- **分页组件 (`TablePagination`)**:
    - 位于表格的底部。

### 2.2. 新建/编辑/查看视图

采用单页滚动式表单设计，统一桌面端和移动端体验。

- **整体布局**:
    - **桌面端**: 使用 `Dialog` 弹窗。
    - **移动端**: `Dialog` 自动切换为 `fullScreen` 全屏模式。
- **内容组织**:
    - `DialogContent` 内部是一个可滚动的容器。
    - 内容被划分为三个独立的 `Paper` 卡片区域，垂直排列，每个卡片都有明确的标题。
- **卡片一：基本信息**
    - 标题：“基本信息”。
    - 包含“套餐名称”、“套餐描述”、“套餐类型”等表单控件。
- **卡片二：定价模式**
    - 标题：“定价模式”。
    - 内部首先是“选择定价模式”的单选按钮。
    - 根据用户的选择，在当前卡片内部动态渲染“固定+联动”或“价差分成”的详细表单。
- **卡片三：附加条款**
    - 标题：“附加条款”。
    - 包含“绿色电力套餐”和“封顶价格条款”的 `Switch` 开关。
    - 启用开关后，相关的配置项会在其下方动态出现。
- **操作栏**:
    - `DialogActions` 固定在弹窗/页面的底部，始终可见。
    - 包含 `[ 取消 ]`, `[ 保存为草稿 ]`, `[ 保存并生效 ]` 按钮。

---

## 三、数据库设计

### 3.1 MongoDB 集合：`retail_packages`

```javascript
{
  _id: ObjectId,
  package_name: String,              // 套餐名称
  package_description: String,       // 套餐描述
  package_type: String,              // 套餐类型："time_based" | "non_time_based"

  // 定价模式
  pricing_mode: String,              // "fixed_linked" | "price_spread"

  // 固定+联动定价模式
  fixed_linked_config: {
    // 固定价格
    fixed_price: {
      pricing_method: String,        // "custom" | "reference"
      // 自定义价格（分时段）
      custom_prices: {
        peak: Number,                // 尖峰时段价格
        high: Number,                // 峰时段价格
        flat: Number,                // 平时段价格
        valley: Number,              // 谷时段价格
        deep_valley: Number          // 深谷时段价格
      },
      // 参考价格
      reference_target: String,      // "grid_agency_price" | "market_monthly_avg"
    },
    // 联动价格
    linked_price: {
      ratio: Number,                 // 联动比例 α
      target: String                 // "day_ahead_avg" | "real_time_avg"
    },
    // 浮动费用
    floating_fee: Number             // 元/kWh
  },

  // 价差分成定价模式
  price_spread_config: {
    reference_price: {
      target: String,                // "market_monthly_avg" | "grid_agency" | "wholesale_settlement"
    },
    price_spread: {
      agreed_spread: Number,         // 约定价差（元/MWh）
      sharing_ratio: Number          // 分成比例 k
    },
    floating_fee: Number             // 浮动费用（元）
  },

  // 附加条款
  additional_terms: {
    // 绿色电力套餐
    green_power: {
      enabled: Boolean,
      monthly_env_value: Number,     // 月度绿色电力环境价值（元/MWh）
      deviation_compensation_ratio: Number  // 偏差补偿比例（%）
    },
    // 封顶价格条款
    price_cap: {
      enabled: Boolean,
      reference_target: String,      // 参考价格标的
      non_peak_markup: Number,       // 非尖峰月份上浮（%）
      peak_markup: Number            // 尖峰月份上浮（%）
    }
  },

  // 状态管理
  status: String,                    // "draft" | "active" | "archived"

  // 元数据
  created_by: String,
  created_at: Date,
  updated_at: Date,
  activated_at: Date,
  archived_at: Date
}
```

---

## 四、API 设计

### 4.1 套餐管理 API

#### 1. 获取套餐列表
`GET /api/v1/retail-packages`
- **Query Parameters**: `keyword`, `package_type`, `pricing_mode`, `status`, `page`, `page_size`

#### 2. 获取套餐详情
`GET /api/v1/retail-packages/{package_id}`

#### 3. 创建套餐
`POST /api/v1/retail-packages`
- **Request Body**: 包含套餐所有配置的 JSON 对象。
- **Query Parameter**: `save_as_draft: bool`
- **Response**: `{ "id": "...", "status": "...", "created_at": "..." }`

#### 4. 更新套餐
`PUT /api/v1/retail-packages/{package_id}`
- **Request Body**: 同创建。

#### 5. 复制套餐
`POST /api/v1/retail-packages/{package_id}/copy`

#### 6. 激活套餐
`POST /api/v1/retail-packages/{package_id}/activate`

#### 7. 归档套餐
`POST /api/v1/retail-packages/{package_id}/archive`

---

## 五、前端组件设计

### 5.1 组件树结构

```
RetailPackagePage
├── QueryCard (Paper)
└── ListCard (Paper)
    ├── Toolbar (Box)
    └── PackageTable (Table)

PackageEditorDialog
// (内部通过辅助渲染函数构建UI，不拆分独立组件文件)
```

### 5.2 核心组件实现策略

#### `PackageEditorDialog.tsx`

- **单一文件实现**：组件内部通过定义多个**辅助渲染函数**（如 `renderBasicInfoSection`, `renderPricingModeSection`）来构建UI，每个函数负责渲染一个 `Paper` 卡片区域。
- **状态管理**：使用 `useForm` Hook 统一管理整个表单的数据和状态。所有辅助渲染函数都从主组件接收 `control`, `watch` 等 `useForm` 的返回对象。
- **无校验**：`useForm` 将不配置 `resolver`，表单提交时直接获取当前数据。

```tsx
// 示例: PackageEditorDialog.tsx 内部结构

// ... imports

// 辅助渲染函数
const renderBasicInfoSection = (control) => (
  <Paper sx={{ p: 2, mb: 2 }}>
    <Typography variant="h6">基本信息</Typography>
    {/* ...表单字段... */}
  </Paper>
);

// 主组件
export const PackageEditorDialog = ({ open, onClose }) => {
  const { control, handleSubmit, watch } = useForm({ /* 无校验 */ });
  const isMobile = useMediaQuery(/* ... */);

  const onSubmit = (data) => { /* ... */ };

  return (
    <Dialog open={open} onClose={onClose} fullScreen={isMobile}>
      <DialogTitle>...</DialogTitle>
      <DialogContent>
        {renderBasicInfoSection(control)}
        {/* ... 其他卡片渲染 ... */}
      </DialogContent>
      <DialogActions>
        {/* ... 操作按钮 ... */}
      </DialogActions>
    </Dialog>
  );
};
```

---

## 六、响应式设计策略

为了在不同尺寸的设备上都提供最佳体验，我们将采用以下响应式策略，覆盖手机、平板和桌面端：

### 6.1 列表页 (`RetailPackagePage`)

-   **桌面端与平板端 (`md` 及以上断点)**: 采用完整的双卡片布局，查询字段横向排列，列表区域显示为数据表格 (`Table`)。
-   **手机端 (`sm` 及以下断点)**: 
    -   查询卡片内的字段垂直堆叠。
    -   列表卡片的内容从数据表格切换为**卡片列表视图**，以优化竖屏阅读和触摸体验。

### 6.2 新建/编辑页 (`PackageEditorDialog`)

-   **桌面端与平板端 (`md` 及以上断点)**: 
    -   采用**弹窗 (Dialog) 模式**。
    -   表单内部的字段可以根据屏幕宽度采用**两列布局**（例如，`Grid size={{ xs: 12, md: 6 }}`），以提高信息密度，减少滚动。
-   **手机端 (`sm` 及以下断点)**: 
    -   采用**全屏 (fullScreen) 模式**。
    -   表单内部所有字段强制为单列垂直布局，以保证可读性。

### 6.3 策略总结

| 屏幕尺寸 | 设备类型 | 列表页 (`RetailPackagePage`) | 新建/编辑页 (`PackageEditorDialog`) |
| :--- | :--- | :--- | :--- |
| `xs`, `sm` | 手机 | **卡片列表视图** | **全屏模式**，纯垂直布局 |
| `md` | 平板电脑 | **表格视图** (同桌面) | **弹窗模式**，表单内可变为**两列布局** |
| `lg`, `xl` | 桌面电脑 | **表格视图** | **弹窗模式**，表单内为两列布局 |


---

## 七、开发注意事项

- **数据一致性**：由于移除了前端校验，需要确保后端能够正确处理各种形式的输入数据。
- **性能优化**：列表页使用分页加载；`useForm` Hook 能有效减少表单重渲染次数。
- **用户体验**：所有操作（如保存、删除）应有明确的加载和反馈状态（如 `LoadingButton`, `Snackbar`）。危险操作（如归档）应有二次确认。
- **遵循项目规范**：严格遵循 `GEMINI.md` 中定义的开发规范，特别是 Material-UI v7 `Grid` 组件的 `size` 属性用法。
