# é›¶å”®åˆåŒç®¡ç†æ¨¡å— - ä¼šè¯2ï¼šå¯¼å…¥å¯¼å‡ºåŠŸèƒ½

## ğŸ“‹ ä¼šè¯ç›®æ ‡

å®ç°é›¶å”®åˆåŒç®¡ç†æ¨¡å—çš„ Excel å¯¼å…¥å¯¼å‡ºåŠŸèƒ½ï¼Œå¹¶è¿›è¡Œå®Œæ•´çš„éªŒè¯æµ‹è¯•ã€‚

**é¢„è®¡å·¥æ—¶**ï¼š2-3å°æ—¶

**å‰ç½®æ¡ä»¶**ï¼šä¼šè¯1å·²å®Œæˆï¼Œåç«¯åŸºç¡€ API æ­£å¸¸å·¥ä½œ

---

## âš ï¸ å¼€å§‹å‰å¿…è¯»

åœ¨ç¼–å†™ä»»ä½•ä»£ç ä¹‹å‰ï¼Œè¯·ç¡®è®¤ï¼š

1. âœ… ä¼šè¯1å·²å®Œæˆå¹¶é€šè¿‡æ‰€æœ‰éªŒæ”¶æ ‡å‡†
2. âœ… åç«¯æœåŠ¡æ­£å¸¸è¿è¡Œï¼ˆhttp://127.0.0.1:8005ï¼‰
3. âœ… å·²æœ‰æµ‹è¯•æ•°æ®ï¼ˆè‡³å°‘2ä¸ªå·²ç”Ÿæ•ˆçš„å¥—é¤å’Œ2ä¸ªæ­£å¸¸çŠ¶æ€çš„å®¢æˆ·ï¼‰
4. âœ… å·²é˜…è¯»è®¾è®¡æ–¹æ¡ˆç¬¬9èŠ‚ï¼ˆå¯¼å…¥å¯¼å‡ºåŠŸèƒ½è®¾è®¡ï¼‰

---

## ğŸ” ç¬¬ä¸€æ­¥ï¼šå¼ºåˆ¶ä»£ç åˆ†æï¼ˆå¿…é¡»å®Œæˆï¼‰

**é‡è¦æç¤º**ï¼šæ£€æŸ¥ç°æœ‰æ¨¡å—æ˜¯å¦å·²å®ç°å¯¼å…¥å¯¼å‡ºåŠŸèƒ½ï¼Œå¦‚æœ‰åˆ™å¤ç”¨å…¶æ¨¡å¼ã€‚

### ä»»åŠ¡1ï¼šæ£€æŸ¥é›¶å”®å¥—é¤æ¨¡å—çš„å¯¼å…¥å¯¼å‡ºå®ç°

**è¯·è¯»å–å¹¶åˆ†æ**ï¼š

```
webapp/api/v1_retail_packages.py
```

**åˆ†æé‡ç‚¹**ï¼š
- [ ] æ˜¯å¦æœ‰ `/import` ç«¯ç‚¹ï¼Ÿå¦‚æœæœ‰ï¼Œåˆ†æå…¶å®ç°ï¼š
  - `UploadFile` çš„ä½¿ç”¨æ–¹å¼
  - Excel æ–‡ä»¶çš„è¯»å–æ–¹å¼ï¼ˆpandasï¼Ÿopenpyxlï¼Ÿï¼‰
  - æ•°æ®æ ¡éªŒçš„å®ç°æ¨¡å¼
  - é”™è¯¯ä¿¡æ¯çš„æ”¶é›†å’Œè¿”å›æ ¼å¼
  - æ‰¹é‡æ’å…¥çš„å®ç°æ–¹å¼

- [ ] æ˜¯å¦æœ‰ `/export` ç«¯ç‚¹ï¼Ÿå¦‚æœæœ‰ï¼Œåˆ†æå…¶å®ç°ï¼š
  - Excel æ–‡ä»¶çš„ç”Ÿæˆæ–¹å¼
  - `StreamingResponse` çš„ä½¿ç”¨
  - æ–‡ä»¶åçš„æ ¼å¼
  - å“åº”å¤´çš„è®¾ç½®

### ä»»åŠ¡2ï¼šæ£€æŸ¥å®¢æˆ·æ¡£æ¡ˆæ¨¡å—çš„å¯¼å…¥å¯¼å‡ºå®ç°

**è¯·è¯»å–å¹¶åˆ†æ**ï¼š

```
webapp/api/v1_customers.py
```

**åˆ†æé‡ç‚¹**ï¼šåŒä¸Š

### ä»»åŠ¡3ï¼šæ£€æŸ¥æ˜¯å¦æœ‰é€šç”¨çš„ Excel å¤„ç†å·¥å…·

**è¯·æ£€æŸ¥ä»¥ä¸‹ä½ç½®**ï¼š

```
webapp/utils/excel_utils.py
webapp/tools/excel_helper.py
webapp/common/excel.py
```

**åˆ†æé‡ç‚¹**ï¼š
- [ ] æ˜¯å¦æœ‰å°è£…å¥½çš„ Excel è¯»å–å‡½æ•°ï¼Ÿ
- [ ] æ˜¯å¦æœ‰å°è£…å¥½çš„ Excel ç”Ÿæˆå‡½æ•°ï¼Ÿ
- [ ] æ˜¯å¦æœ‰æ•°æ®æ ¡éªŒçš„é€šç”¨å‡½æ•°ï¼Ÿ

**è¯·åœ¨ç»ˆç«¯è¾“å‡ºä½ çš„åˆ†æç»“è®º**ï¼Œä¾‹å¦‚ï¼š
```
âœ“ é›¶å”®å¥—é¤æ¨¡å—æœªå®ç°å¯¼å…¥å¯¼å‡ºåŠŸèƒ½
âœ“ å®¢æˆ·æ¡£æ¡ˆæ¨¡å—å®ç°äº†å¯¼å…¥åŠŸèƒ½ï¼Œä½¿ç”¨ pandas.read_excel()
âœ“ é¡¹ç›®ä¸­æœªå‘ç°é€šç”¨çš„ Excel å¤„ç†å·¥å…·
âœ“ éœ€è¦å®‰è£… pandas å’Œ openpyxl åº“
...
```

---

## ğŸ’» ç¬¬äºŒæ­¥ï¼šå¼€å‘ä»»åŠ¡

### 2.1 å®‰è£…ä¾èµ–ï¼ˆå¦‚éœ€è¦ï¼‰

**æ£€æŸ¥å¹¶å®‰è£…**ï¼š

```bash
# æ£€æŸ¥ requirements.txt
cat webapp/requirements.txt | grep -E "pandas|openpyxl|python-multipart"

# å¦‚æœç¼ºå°‘ï¼Œæ·»åŠ åˆ° requirements.txt
pip install pandas openpyxl python-multipart
```

### 2.2 å®ç°å¯¼å…¥åŠŸèƒ½

**æ–‡ä»¶ä½ç½®**ï¼š`webapp/api/v1_retail_contracts.py`

**æ·»åŠ å¯¼å…¥ç«¯ç‚¹**ï¼š

```python
from fastapi import UploadFile, File
import pandas as pd
import io
from typing import List, Dict, Any
from datetime import datetime
from bson import ObjectId

@router.post("/import", summary="å¯¼å…¥åˆåŒæ•°æ®")
async def import_contracts(
    file: UploadFile = File(..., description="Excelæ–‡ä»¶(.xlsx/.xls)"),
    current_user: User = Depends(get_current_active_user)
):
    """
    æ‰¹é‡å¯¼å…¥åˆåŒæ•°æ®ï¼ˆåŒæ­¥æ–¹æ¡ˆï¼‰

    Excelæ–‡ä»¶æ ¼å¼è¦æ±‚ï¼š
    - å¿…éœ€åˆ—ï¼šå¥—é¤åç§°, å®¢æˆ·åç§°, è´­ä¹°ç”µé‡, è´­ç”µå¼€å§‹æœˆä»½, è´­ç”µç»“æŸæœˆä»½
    - å¥—é¤åç§°å¿…é¡»å­˜åœ¨äºç³»ç»Ÿä¸­ä¸”çŠ¶æ€ä¸ºå·²ç”Ÿæ•ˆ
    - å®¢æˆ·åç§°å¿…é¡»å­˜åœ¨äºç³»ç»Ÿä¸­ä¸”çŠ¶æ€ä¸ºæ­£å¸¸
    - æ—¥æœŸæ ¼å¼ï¼šYYYY-MM æˆ– YYYY-MM-DD
    - è´­ä¹°ç”µé‡å¿…é¡»å¤§äº0
    - è´­ç”µç»“æŸæœˆä»½å¿…é¡» >= è´­ç”µå¼€å§‹æœˆä»½

    è¿”å›ï¼š
    - total: æ€»è¡Œæ•°
    - success: æˆåŠŸå¯¼å…¥çš„æ•°é‡
    - failed: å¤±è´¥çš„æ•°é‡
    - errors: é”™è¯¯è¯¦æƒ…åˆ—è¡¨
    """
    try:
        # 1. è¯»å– Excel æ–‡ä»¶
        contents = await file.read()
        df = pd.read_excel(io.BytesIO(contents))

        # 2. éªŒè¯æ–‡ä»¶ç»“æ„
        required_columns = ['å¥—é¤åç§°', 'å®¢æˆ·åç§°', 'è´­ä¹°ç”µé‡', 'è´­ç”µå¼€å§‹æœˆä»½', 'è´­ç”µç»“æŸæœˆä»½']
        missing_columns = [col for col in required_columns if col not in df.columns]
        if missing_columns:
            raise HTTPException(
                status_code=400,
                detail=f"Excelæ–‡ä»¶ç¼ºå°‘å¿…éœ€åˆ—ï¼š{', '.join(missing_columns)}"
            )

        # 3. é€è¡Œæ ¡éªŒå’Œå¯¼å…¥
        success_count = 0
        failed_count = 0
        errors: List[Dict[str, Any]] = []

        for index, row in df.iterrows():
            row_number = index + 2  # Excel ä»1å¼€å§‹ï¼Œä¸”æœ‰è¡¨å¤´

            try:
                # æ•°æ®æ ¡éªŒ
                validation_errors = validate_contract_row(row, row_number)

                if validation_errors:
                    errors.extend(validation_errors)
                    failed_count += 1
                    continue

                # æŸ¥è¯¢å¥—é¤ID
                package = DATABASE["retail_packages"].find_one({
                    "package_name": row['å¥—é¤åç§°'],
                    "status": "active"
                })

                # æŸ¥è¯¢å®¢æˆ·ID
                customer = DATABASE["customers"].find_one({
                    "user_name": row['å®¢æˆ·åç§°'],
                    "status": "active"
                })

                # æ„å»ºåˆåŒæ•°æ®
                contract_data = {
                    "package_name": row['å¥—é¤åç§°'],
                    "package_id": str(package["_id"]),
                    "customer_name": row['å®¢æˆ·åç§°'],
                    "customer_id": str(customer["_id"]),
                    "purchasing_electricity_quantity": float(row['è´­ä¹°ç”µé‡']),
                    "purchase_start_month": parse_month(row['è´­ç”µå¼€å§‹æœˆä»½']),
                    "purchase_end_month": parse_month(row['è´­ç”µç»“æŸæœˆä»½']),
                    "created_by": current_user.username,
                    "created_at": datetime.utcnow(),
                    "updated_by": current_user.username,
                    "updated_at": datetime.utcnow()
                }

                # æ’å…¥æ•°æ®åº“
                DATABASE["retail_contracts"].insert_one(contract_data)
                success_count += 1

            except Exception as e:
                errors.append({
                    "row": row_number,
                    "field": "general",
                    "message": str(e)
                })
                failed_count += 1

        # 4. è¿”å›ç»“æœ
        return {
            "total": len(df),
            "success": success_count,
            "failed": failed_count,
            "errors": errors
        }

    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(status_code=400, detail=f"å¯¼å…¥å¤±è´¥ï¼š{str(e)}")


def validate_contract_row(row: pd.Series, row_number: int) -> List[Dict[str, Any]]:
    """
    æ ¡éªŒå•è¡ŒåˆåŒæ•°æ®

    Args:
        row: DataFrame çš„ä¸€è¡Œæ•°æ®
        row_number: Excel ä¸­çš„è¡Œå·

    Returns:
        é”™è¯¯åˆ—è¡¨ï¼Œå¦‚æœä¸ºç©ºåˆ™è¡¨ç¤ºæ ¡éªŒé€šè¿‡
    """
    errors = []

    # 1. å¿…å¡«é¡¹æ ¡éªŒ
    if pd.isna(row['å¥—é¤åç§°']) or str(row['å¥—é¤åç§°']).strip() == '':
        errors.append({
            "row": row_number,
            "field": "å¥—é¤åç§°",
            "message": "ä¸èƒ½ä¸ºç©º"
        })

    if pd.isna(row['å®¢æˆ·åç§°']) or str(row['å®¢æˆ·åç§°']).strip() == '':
        errors.append({
            "row": row_number,
            "field": "å®¢æˆ·åç§°",
            "message": "ä¸èƒ½ä¸ºç©º"
        })

    # 2. æ•°å­—æ ¼å¼æ ¡éªŒ
    try:
        quantity = float(row['è´­ä¹°ç”µé‡'])
        if quantity <= 0:
            errors.append({
                "row": row_number,
                "field": "è´­ä¹°ç”µé‡",
                "message": "å¿…é¡»å¤§äº0"
            })
    except (ValueError, TypeError):
        errors.append({
            "row": row_number,
            "field": "è´­ä¹°ç”µé‡",
            "message": "æ ¼å¼é”™è¯¯ï¼Œå¿…é¡»ä¸ºæ•°å­—"
        })

    # 3. å¥—é¤å­˜åœ¨æ€§æ ¡éªŒ
    if not pd.isna(row['å¥—é¤åç§°']):
        package = DATABASE["retail_packages"].find_one({
            "package_name": row['å¥—é¤åç§°'],
            "status": "active"
        })
        if not package:
            errors.append({
                "row": row_number,
                "field": "å¥—é¤åç§°",
                "message": "å¥—é¤ä¸å­˜åœ¨æˆ–æœªç”Ÿæ•ˆ"
            })

    # 4. å®¢æˆ·å­˜åœ¨æ€§æ ¡éªŒ
    if not pd.isna(row['å®¢æˆ·åç§°']):
        customer = DATABASE["customers"].find_one({
            "user_name": row['å®¢æˆ·åç§°'],
            "status": "active"
        })
        if not customer:
            errors.append({
                "row": row_number,
                "field": "å®¢æˆ·åç§°",
                "message": "å®¢æˆ·ä¸å­˜åœ¨æˆ–éæ­£å¸¸çŠ¶æ€"
            })

    # 5. æ—¶é—´é€»è¾‘æ ¡éªŒ
    try:
        start_month = parse_month(row['è´­ç”µå¼€å§‹æœˆä»½'])
        end_month = parse_month(row['è´­ç”µç»“æŸæœˆä»½'])

        start_month_first = datetime(start_month.year, start_month.month, 1)
        end_month_first = datetime(end_month.year, end_month.month, 1)

        if end_month_first < start_month_first:
            errors.append({
                "row": row_number,
                "field": "è´­ç”µæœˆä»½",
                "message": "è´­ç”µç»“æŸæœˆä»½ä¸èƒ½æ—©äºå¼€å§‹æœˆä»½"
            })
    except (ValueError, TypeError) as e:
        errors.append({
            "row": row_number,
            "field": "è´­ç”µæœˆä»½",
            "message": f"æ—¥æœŸæ ¼å¼é”™è¯¯ï¼š{str(e)}"
        })

    return errors


def parse_month(date_value) -> datetime:
    """
    è§£ææœˆä»½å­—ç¬¦ä¸²æˆ–æ—¥æœŸå¯¹è±¡ä¸º datetimeï¼ˆæ¯æœˆ1å·ï¼‰

    æ”¯æŒæ ¼å¼ï¼š
    - datetime å¯¹è±¡
    - "YYYY-MM"
    - "YYYY-MM-DD"
    - "YYYY/MM"
    - "YYYY/MM/DD"
    """
    if isinstance(date_value, datetime):
        return datetime(date_value.year, date_value.month, 1)

    if pd.isna(date_value):
        raise ValueError("æ—¥æœŸä¸èƒ½ä¸ºç©º")

    date_str = str(date_value).strip()

    # å°è¯•å¤šç§æ ¼å¼
    formats = [
        "%Y-%m-%d",
        "%Y-%m",
        "%Y/%m/%d",
        "%Y/%m"
    ]

    for fmt in formats:
        try:
            dt = datetime.strptime(date_str, fmt)
            return datetime(dt.year, dt.month, 1)
        except ValueError:
            continue

    raise ValueError(f"æ— æ³•è§£ææ—¥æœŸæ ¼å¼ï¼š{date_str}ï¼Œæ”¯æŒçš„æ ¼å¼ï¼šYYYY-MM æˆ– YYYY-MM-DD")
```

### 2.3 å®ç°å¯¼å‡ºåŠŸèƒ½

**åœ¨ `v1_retail_contracts.py` ä¸­æ·»åŠ **ï¼š

```python
from fastapi.responses import StreamingResponse

@router.get("/export", summary="å¯¼å‡ºåˆåŒæ•°æ®")
async def export_contracts(
    package_name: Optional[str] = Query(None, description="å¥—é¤åç§°ç­›é€‰"),
    customer_name: Optional[str] = Query(None, description="å®¢æˆ·åç§°ç­›é€‰"),
    status: Optional[str] = Query(None, description="åˆåŒçŠ¶æ€ç­›é€‰"),
    current_user: User = Depends(get_current_active_user)
):
    """
    å¯¼å‡ºåˆåŒæ•°æ®ä¸º Excel æ–‡ä»¶

    æ”¯æŒç­›é€‰ï¼š
    - package_name: å¥—é¤åç§°ï¼ˆæ¨¡ç³Šæœç´¢ï¼‰
    - customer_name: å®¢æˆ·åç§°ï¼ˆæ¨¡ç³Šæœç´¢ï¼‰
    - status: åˆåŒçŠ¶æ€ï¼ˆpending/active/expiredï¼‰
    """
    try:
        # 1. æ„å»ºæŸ¥è¯¢æ¡ä»¶
        query = {}
        if package_name:
            query["package_name"] = {"$regex": package_name, "$options": "i"}
        if customer_name:
            query["customer_name"] = {"$regex": customer_name, "$options": "i"}

        # 2. æŸ¥è¯¢æ•°æ®
        contracts = list(DATABASE["retail_contracts"].find(query))

        # 3. è®¡ç®—è™šæ‹ŸçŠ¶æ€å¹¶æ·»åŠ åˆ°æ•°æ®ä¸­
        for contract in contracts:
            contract["status"] = calculate_contract_status(
                contract["purchase_start_month"],
                contract["purchase_end_month"]
            )
            # è½¬æ¢ ObjectId ä¸ºå­—ç¬¦ä¸²
            contract["_id"] = str(contract["_id"])

        # 4. è¿‡æ»¤çŠ¶æ€
        if status and status != "all":
            contracts = [c for c in contracts if c.get("status") == status]

        # 5. è½¬æ¢ä¸º DataFrame
        df = pd.DataFrame(contracts)

        if df.empty:
            # å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œåˆ›å»ºç©ºçš„ DataFrame å¸¦åˆ—å
            df = pd.DataFrame(columns=[
                "_id", "package_name", "customer_name",
                "purchasing_electricity_quantity",
                "purchase_start_month", "purchase_end_month",
                "status", "created_at", "updated_at"
            ])
        else:
            # é€‰æ‹©è¦å¯¼å‡ºçš„åˆ—
            columns_to_export = [
                "_id", "package_name", "customer_name",
                "purchasing_electricity_quantity",
                "purchase_start_month", "purchase_end_month",
                "status", "created_at", "updated_at"
            ]
            df = df[columns_to_export]

        # 6. æ ¼å¼åŒ–æ—¥æœŸåˆ—
        if not df.empty:
            df["purchase_start_month"] = pd.to_datetime(df["purchase_start_month"]).dt.strftime("%Y-%m")
            df["purchase_end_month"] = pd.to_datetime(df["purchase_end_month"]).dt.strftime("%Y-%m")
            df["created_at"] = pd.to_datetime(df["created_at"]).dt.strftime("%Y-%m-%d %H:%M:%S")
            df["updated_at"] = pd.to_datetime(df["updated_at"]).dt.strftime("%Y-%m-%d %H:%M:%S")

        # 7. é‡å‘½ååˆ—ä¸ºä¸­æ–‡
        df.columns = [
            "åˆåŒç¼–å·", "å¥—é¤åç§°", "å®¢æˆ·åç§°",
            "è´­ä¹°ç”µé‡", "è´­ç”µå¼€å§‹æœˆä»½", "è´­ç”µç»“æŸæœˆä»½",
            "çŠ¶æ€", "åˆ›å»ºæ—¶é—´", "æ›´æ–°æ—¶é—´"
        ]

        # 8. çŠ¶æ€è½¬æ¢ä¸ºä¸­æ–‡
        if not df.empty:
            status_map = {
                "pending": "å¾…ç”Ÿæ•ˆ",
                "active": "ç”Ÿæ•ˆ",
                "expired": "å·²è¿‡æœŸ"
            }
            df["çŠ¶æ€"] = df["çŠ¶æ€"].map(status_map)

        # 9. ç”Ÿæˆ Excel æ–‡ä»¶
        output = io.BytesIO()
        with pd.ExcelWriter(output, engine='openpyxl') as writer:
            df.to_excel(writer, index=False, sheet_name='åˆåŒæ•°æ®')

            # è‡ªåŠ¨è°ƒæ•´åˆ—å®½
            worksheet = writer.sheets['åˆåŒæ•°æ®']
            for column in worksheet.columns:
                max_length = 0
                column_letter = column[0].column_letter
                for cell in column:
                    try:
                        if len(str(cell.value)) > max_length:
                            max_length = len(str(cell.value))
                    except:
                        pass
                adjusted_width = min(max_length + 2, 50)
                worksheet.column_dimensions[column_letter].width = adjusted_width

        output.seek(0)

        # 10. è¿”å›æ–‡ä»¶æµ
        filename = f"contracts_{datetime.now().strftime('%Y%m%d_%H%M%S')}.xlsx"

        return StreamingResponse(
            output,
            media_type="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
            headers={"Content-Disposition": f"attachment; filename={filename}"}
        )

    except Exception as e:
        raise HTTPException(status_code=500, detail=f"å¯¼å‡ºå¤±è´¥ï¼š{str(e)}")
```

---

## âœ… ç¬¬ä¸‰æ­¥ï¼šéªŒè¯æµ‹è¯•

### 3.1 å‡†å¤‡æµ‹è¯•æ•°æ®

**åˆ›å»ºæµ‹è¯• Excel æ–‡ä»¶**ï¼š`test_contracts.xlsx`

| å¥—é¤åç§° | å®¢æˆ·åç§° | è´­ä¹°ç”µé‡ | è´­ç”µå¼€å§‹æœˆä»½ | è´­ç”µç»“æŸæœˆä»½ |
|---------|---------|---------|-------------|-------------|
| 2024å¹´å•†ä¸šå°–å³°å¹³è°·å¥—é¤ | ä¸°åŸè¶…èƒœå¡‘ä¸šæœ‰é™å…¬å¸ | 100000 | 2024-01 | 2024-12 |
| 2024å¹´å•†ä¸šå°–å³°å¹³è°·å¥—é¤ | æµ‹è¯•å®¢æˆ·å…¬å¸ | 50000 | 2024-06 | 2024-12 |
| ä¸å­˜åœ¨çš„å¥—é¤ | ä¸°åŸè¶…èƒœå¡‘ä¸šæœ‰é™å…¬å¸ | 80000 | 2024-01 | 2024-12 |
| 2024å¹´å•†ä¸šå°–å³°å¹³è°·å¥—é¤ | ä¸å­˜åœ¨çš„å®¢æˆ· | 120000 | 2024-01 | 2024-12 |
| 2024å¹´å•†ä¸šå°–å³°å¹³è°·å¥—é¤ | ä¸°åŸè¶…èƒœå¡‘ä¸šæœ‰é™å…¬å¸ | -1000 | 2024-01 | 2024-12 |
| 2024å¹´å•†ä¸šå°–å³°å¹³è°·å¥—é¤ | ä¸°åŸè¶…èƒœå¡‘ä¸šæœ‰é™å…¬å¸ | 90000 | 2024-12 | 2024-01 |

**é¢„æœŸç»“æœ**ï¼š
- ç¬¬1ã€2è¡Œåº”è¯¥æˆåŠŸå¯¼å…¥
- ç¬¬3è¡Œåº”å¤±è´¥ï¼šå¥—é¤ä¸å­˜åœ¨
- ç¬¬4è¡Œåº”å¤±è´¥ï¼šå®¢æˆ·ä¸å­˜åœ¨
- ç¬¬5è¡Œåº”å¤±è´¥ï¼šè´­ä¹°ç”µé‡å¿…é¡»å¤§äº0
- ç¬¬6è¡Œåº”å¤±è´¥ï¼šç»“æŸæœˆä»½æ—©äºå¼€å§‹æœˆä»½

### 3.2 æµ‹è¯•å¯¼å…¥åŠŸèƒ½

```powershell
# ç¡®ä¿å·²ç™»å½•å¹¶è·å– Token
$response = Invoke-RestMethod -Uri "http://127.0.0.1:8005/token" -Method Post -Body @{username="admin";password="!234qwer"} -ContentType "application/x-www-form-urlencoded"
$TOKEN = $response.access_token

# å¯¼å…¥åˆåŒæ•°æ®
$filePath = "test_contracts.xlsx"
$uri = "http://127.0.0.1:8005/api/v1/retail-contracts/import"

# ä½¿ç”¨ curlï¼ˆæ¨èï¼‰
curl -X POST $uri `
  -H "Authorization: Bearer $TOKEN" `
  -F "file=@$filePath"

# æˆ–ä½¿ç”¨ Invoke-RestMethod
$boundary = [System.Guid]::NewGuid().ToString()
$fileName = Split-Path $filePath -Leaf
$fileBytes = [System.IO.File]::ReadAllBytes($filePath)
$fileEnc = [System.Text.Encoding]::GetEncoding('ISO-8859-1').GetString($fileBytes)

$bodyLines = (
    "--$boundary",
    "Content-Disposition: form-data; name=`"file`"; filename=`"$fileName`"",
    "Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
    "",
    $fileEnc,
    "--$boundary--"
) -join "`r`n"

$result = Invoke-RestMethod -Uri $uri -Method Post -ContentType "multipart/form-data; boundary=$boundary" -Body $bodyLines -Headers @{Authorization="Bearer $TOKEN"}

Write-Host "å¯¼å…¥ç»“æœ:"
Write-Host "æ€»æ•°: $($result.total)"
Write-Host "æˆåŠŸ: $($result.success)"
Write-Host "å¤±è´¥: $($result.failed)"
Write-Host "é”™è¯¯è¯¦æƒ…:"
$result.errors | Format-Table
```

**éªŒè¯ç‚¹**ï¼š
- [ ] æˆåŠŸå¯¼å…¥2æ¡è®°å½•
- [ ] å¤±è´¥4æ¡è®°å½•
- [ ] é”™è¯¯ä¿¡æ¯è¯¦ç»†ä¸”å‡†ç¡®ï¼š
  - [ ] æŒ‡å‡ºå…·ä½“çš„è¡Œå·
  - [ ] æŒ‡å‡ºå…·ä½“çš„å­—æ®µ
  - [ ] æä¾›æ˜ç¡®çš„é”™è¯¯åŸå› 
- [ ] éƒ¨åˆ†æˆåŠŸåœºæ™¯å¤„ç†æ­£ç¡®

### 3.3 æµ‹è¯•å¯¼å‡ºåŠŸèƒ½

```powershell
# 1. å¯¼å‡ºæ‰€æœ‰åˆåŒ
$exportUri = "http://127.0.0.1:8005/api/v1/retail-contracts/export"
Invoke-WebRequest -Uri $exportUri -Headers @{Authorization="Bearer $TOKEN"} -OutFile "contracts_all.xlsx"
Write-Host "âœ“ å¯¼å‡ºæ‰€æœ‰åˆåŒåˆ° contracts_all.xlsx"

# 2. æŒ‰çŠ¶æ€å¯¼å‡ºï¼ˆå¾…ç”Ÿæ•ˆï¼‰
Invoke-WebRequest -Uri "$exportUri`?status=pending" -Headers @{Authorization="Bearer $TOKEN"} -OutFile "contracts_pending.xlsx"
Write-Host "âœ“ å¯¼å‡ºå¾…ç”Ÿæ•ˆåˆåŒåˆ° contracts_pending.xlsx"

# 3. æŒ‰å¥—é¤åç§°å¯¼å‡º
Invoke-WebRequest -Uri "$exportUri`?package_name=å•†ä¸š" -Headers @{Authorization="Bearer $TOKEN"} -OutFile "contracts_business.xlsx"
Write-Host "âœ“ å¯¼å‡ºå•†ä¸šå¥—é¤åˆåŒåˆ° contracts_business.xlsx"

# 4. ç»„åˆç­›é€‰å¯¼å‡º
Invoke-WebRequest -Uri "$exportUri`?package_name=å•†ä¸š&status=active" -Headers @{Authorization="Bearer $TOKEN"} -OutFile "contracts_filtered.xlsx"
Write-Host "âœ“ å¯¼å‡ºå·²ç”Ÿæ•ˆçš„å•†ä¸šå¥—é¤åˆåŒåˆ° contracts_filtered.xlsx"
```

**éªŒè¯ç‚¹**ï¼š
- [ ] å¯¼å‡ºçš„ Excel æ–‡ä»¶å¯ä»¥æ­£å¸¸æ‰“å¼€
- [ ] åˆ—åä¸ºä¸­æ–‡ä¸”æ¸…æ™°
- [ ] æ•°æ®å®Œæ•´ä¸”å‡†ç¡®
- [ ] æ—¥æœŸæ ¼å¼æ­£ç¡®ï¼ˆYYYY-MMï¼‰
- [ ] çŠ¶æ€æ˜¾ç¤ºä¸ºä¸­æ–‡ï¼ˆå¾…ç”Ÿæ•ˆ/ç”Ÿæ•ˆ/å·²è¿‡æœŸï¼‰
- [ ] åˆ—å®½è‡ªåŠ¨è°ƒæ•´é€‚å½“
- [ ] ç­›é€‰æ¡ä»¶æœ‰æ•ˆ
- [ ] ç©ºç»“æœæ—¶å¯¼å‡ºç©º Excelï¼ˆå¸¦åˆ—åï¼‰

### 3.4 å¯¼å…¥å¯¼å‡ºå¾ªç¯æµ‹è¯•

```powershell
# 1. å…ˆå¯¼å‡ºç°æœ‰æ•°æ®
Invoke-WebRequest -Uri "$exportUri" -Headers @{Authorization="Bearer $TOKEN"} -OutFile "contracts_export.xlsx"

# 2. æ‰‹åŠ¨ä¿®æ”¹ Excel æ–‡ä»¶ï¼ˆæ·»åŠ æ–°è¡Œï¼‰

# 3. é‡æ–°å¯¼å…¥
curl -X POST "http://127.0.0.1:8005/api/v1/retail-contracts/import" `
  -H "Authorization: Bearer $TOKEN" `
  -F "file=@contracts_export.xlsx"

# 4. å†æ¬¡å¯¼å‡ºéªŒè¯
Invoke-WebRequest -Uri "$exportUri" -Headers @{Authorization="Bearer $TOKEN"} -OutFile "contracts_export2.xlsx"

# 5. å¯¹æ¯”ä¸¤ä¸ªæ–‡ä»¶ï¼ŒéªŒè¯æ•°æ®ä¸€è‡´æ€§
```

### 3.5 æ€§èƒ½æµ‹è¯•

```powershell
# åˆ›å»ºåŒ…å«100è¡Œæ•°æ®çš„æµ‹è¯•æ–‡ä»¶
# æµ‹è¯•å¯¼å…¥æ€§èƒ½
Measure-Command {
    curl -X POST "http://127.0.0.1:8005/api/v1/retail-contracts/import" `
      -H "Authorization: Bearer $TOKEN" `
      -F "file=@large_test_contracts.xlsx"
}

# æµ‹è¯•å¯¼å‡ºæ€§èƒ½
Measure-Command {
    Invoke-WebRequest -Uri "$exportUri" -Headers @{Authorization="Bearer $TOKEN"} -OutFile "large_export.xlsx"
}
```

**éªŒè¯ç‚¹**ï¼š
- [ ] 100è¡Œæ•°æ®å¯¼å…¥æ—¶é—´ < 10ç§’
- [ ] 100è¡Œæ•°æ®å¯¼å‡ºæ—¶é—´ < 5ç§’

---

## ğŸ“ éªŒæ”¶æ ‡å‡†

åœ¨å®Œæˆå¼€å‘åï¼Œè¯·é€é¡¹æ£€æŸ¥ï¼š

**å¯¼å…¥åŠŸèƒ½**ï¼š
- [ ] æ”¯æŒæ ‡å‡† Excel æ ¼å¼ï¼ˆ.xlsxï¼‰
- [ ] æ–‡ä»¶ç»“æ„æ ¡éªŒæ­£ç¡®ï¼ˆç¼ºå°‘åˆ—æ—¶æŠ¥é”™æ¸…æ™°ï¼‰
- [ ] å¿…å¡«é¡¹æ ¡éªŒå®Œæ•´
- [ ] æ•°æ®æ ¼å¼æ ¡éªŒå‡†ç¡®ï¼ˆæ•°å­—ã€æ—¥æœŸï¼‰
- [ ] å…³è”æ•°æ®æ ¡éªŒæœ‰æ•ˆï¼š
  - [ ] å¥—é¤å¿…é¡»å­˜åœ¨ä¸”ä¸ºå·²ç”Ÿæ•ˆçŠ¶æ€
  - [ ] å®¢æˆ·å¿…é¡»å­˜åœ¨ä¸”ä¸ºæ­£å¸¸çŠ¶æ€
- [ ] ä¸šåŠ¡é€»è¾‘æ ¡éªŒæ­£ç¡®ï¼š
  - [ ] è´­ä¹°ç”µé‡ > 0
  - [ ] ç»“æŸæœˆä»½ >= å¼€å§‹æœˆä»½
- [ ] é”™è¯¯ä¿¡æ¯è¯¦ç»†ä¸”æ˜“äºç†è§£ï¼š
  - [ ] åŒ…å«è¡Œå·
  - [ ] åŒ…å«å­—æ®µå
  - [ ] åŒ…å«å…·ä½“é”™è¯¯åŸå› 
- [ ] éƒ¨åˆ†æˆåŠŸåœºæ™¯å¤„ç†æ­£ç¡®
- [ ] å¤§æ–‡ä»¶å¤„ç†æ€§èƒ½å¯æ¥å—ï¼ˆ100è¡Œ < 10ç§’ï¼‰

**å¯¼å‡ºåŠŸèƒ½**ï¼š
- [ ] å¯¼å‡ºçš„ Excel æ–‡ä»¶æ ¼å¼è§„èŒƒ
- [ ] åˆ—åä¸ºä¸­æ–‡ä¸”æ¸…æ™°
- [ ] æ•°æ®å®Œæ•´ä¸”å‡†ç¡®
- [ ] æ—¥æœŸæ ¼å¼ç»Ÿä¸€ï¼ˆYYYY-MMï¼‰
- [ ] çŠ¶æ€æ˜¾ç¤ºä¸ºä¸­æ–‡
- [ ] åˆ—å®½è‡ªåŠ¨è°ƒæ•´é€‚å½“
- [ ] æ”¯æŒç­›é€‰æ¡ä»¶ï¼ˆå¥—é¤ã€å®¢æˆ·ã€çŠ¶æ€ï¼‰
- [ ] ç©ºç»“æœæ—¶å¯¼å‡ºç©º Excelï¼ˆå¸¦åˆ—åï¼‰
- [ ] æ–‡ä»¶ååŒ…å«æ—¶é—´æˆ³
- [ ] å¤§æ•°æ®é‡å¯¼å‡ºæ€§èƒ½å¯æ¥å—ï¼ˆ100è¡Œ < 5ç§’ï¼‰

**ä»£ç è´¨é‡**ï¼š
- [ ] ä»£ç æ·»åŠ äº†å®Œæ•´çš„ç±»å‹æç¤º
- [ ] éµå¾ª PEP 8 è§„èŒƒ
- [ ] é”™è¯¯å¤„ç†å®Œå–„
- [ ] å‡½æ•°æœ‰æ¸…æ™°çš„ docstring
- [ ] æ—¥æœŸè§£ææ”¯æŒå¤šç§æ ¼å¼

**æ–‡æ¡£**ï¼š
- [ ] API æ–‡æ¡£ä¸­å¯¼å…¥å¯¼å‡ºç«¯ç‚¹æè¿°æ¸…æ™°
- [ ] åŒ…å«è¯·æ±‚/å“åº”ç¤ºä¾‹
- [ ] åŒ…å«é”™è¯¯å“åº”ç¤ºä¾‹

---

## ğŸš¨ å¸¸è§é—®é¢˜å’Œæ³¨æ„äº‹é¡¹

1. **pandas è¯»å– Excel é”™è¯¯**ï¼š
   - ç¡®ä¿å®‰è£…äº† openpyxlï¼š`pip install openpyxl`
   - æ£€æŸ¥ Excel æ–‡ä»¶æ˜¯å¦æŸå
   - ç¡®è®¤æ–‡ä»¶æ‰©å±•åä¸º .xlsx

2. **æ—¥æœŸè§£æé—®é¢˜**ï¼š
   - pandas è¯»å–çš„æ—¥æœŸå¯èƒ½æ˜¯ `Timestamp` å¯¹è±¡
   - ç¡®ä¿ `parse_month` å‡½æ•°å¤„ç†å¤šç§è¾“å…¥ç±»å‹
   - ç»Ÿä¸€å­˜å‚¨ä¸ºæ¯æœˆ1å·

3. **å¯¼å‡ºæ–‡ä»¶ä¸­æ–‡ä¹±ç **ï¼š
   - ç¡®ä¿ä½¿ç”¨ `openpyxl` å¼•æ“
   - ä¸éœ€è¦æ‰‹åŠ¨è®¾ç½®ç¼–ç ï¼ˆopenpyxl è‡ªåŠ¨å¤„ç†ï¼‰

4. **å†…å­˜é—®é¢˜**ï¼š
   - å¤§æ–‡ä»¶å¯¼å…¥æ—¶ï¼Œè€ƒè™‘åˆ†æ‰¹å¤„ç†
   - å¯¼å‡ºæ—¶ä½¿ç”¨æµå¼å†™å…¥

5. **æ–‡ä»¶ä¸Šä¼ å¤§å°é™åˆ¶**ï¼š
   - æ£€æŸ¥ FastAPI çš„ `max_file_size` é…ç½®
   - æ£€æŸ¥ Nginx/ä»£ç†æœåŠ¡å™¨çš„é™åˆ¶

---

## ğŸ“š å‚è€ƒæ–‡æ¡£

- **è®¾è®¡æ–¹æ¡ˆç¬¬9èŠ‚**ï¼š`docs/pages/é›¶å”®åˆåŒç®¡ç†/é›¶å”®åˆåŒç®¡ç†æ¨¡å—è®¾è®¡æ–¹æ¡ˆ.md#ä¹å¯¼å…¥å¯¼å‡ºåŠŸèƒ½è®¾è®¡`
- **å¼€å‘è§„åˆ’ä¼šè¯2**ï¼š`docs/pages/é›¶å”®åˆåŒç®¡ç†/é›¶å”®åˆåŒç®¡ç†æ¨¡å—å¼€å‘è§„åˆ’.md#ä¼šè¯-2å¯¼å…¥å¯¼å‡ºåŠŸèƒ½`
- **pandas æ–‡æ¡£**ï¼šhttps://pandas.pydata.org/docs/
- **openpyxl æ–‡æ¡£**ï¼šhttps://openpyxl.readthedocs.io/

---

## âœ… å®Œæˆåçš„è¡ŒåŠ¨

åœ¨å®Œæˆæœ¬ä¼šè¯çš„æ‰€æœ‰å¼€å‘å’Œæµ‹è¯•åï¼š

1. æ›´æ–°å¼€å‘è§„åˆ’æ–‡æ¡£ä¸­çš„è¿›åº¦è¡¨
2. æ¸…ç†æµ‹è¯•æ–‡ä»¶
3. æäº¤ä»£ç åˆ° Gitï¼ˆå¦‚æœé¡¹ç›®ä½¿ç”¨ç‰ˆæœ¬æ§åˆ¶ï¼‰
4. å‡†å¤‡è¿›å…¥ä¼šè¯3ï¼ˆå‰ç«¯åˆ—è¡¨å’Œç¼–è¾‘åŠŸèƒ½ï¼‰

**ä¼šè¯3æç¤ºè¯**ï¼š`docs/pages/é›¶å”®åˆåŒç®¡ç†/ä¼šè¯3-å‰ç«¯åˆ—è¡¨ç¼–è¾‘æç¤ºè¯.md`
