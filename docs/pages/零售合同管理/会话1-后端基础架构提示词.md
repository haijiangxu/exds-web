# é›¶å”®åˆåŒç®¡ç†æ¨¡å— - ä¼šè¯1ï¼šåç«¯åŸºç¡€æ¶æ„ + API

## ğŸ“‹ ä¼šè¯ç›®æ ‡

å®Œæˆé›¶å”®åˆåŒç®¡ç†æ¨¡å—çš„åç«¯æ•°æ®æ¨¡å‹å’ŒåŸºç¡€ CRUD APIï¼Œå¹¶è¿›è¡Œå®Œæ•´çš„éªŒè¯æµ‹è¯•ã€‚

**é¢„è®¡å·¥æ—¶**ï¼š2-3å°æ—¶

---

## âš ï¸ å¼€å§‹å‰å¿…è¯»

åœ¨ç¼–å†™ä»»ä½•ä»£ç ä¹‹å‰ï¼Œè¯·ç¡®è®¤ï¼š

1. âœ… å·²é˜…è¯» `docs/pages/é›¶å”®åˆåŒç®¡ç†/é›¶å”®åˆåŒç®¡ç†æ¨¡å—è®¾è®¡æ–¹æ¡ˆ.md`
2. âœ… å·²é˜…è¯» `docs/pages/é›¶å”®åˆåŒç®¡ç†/é›¶å”®åˆåŒç®¡ç†æ¨¡å—å¼€å‘è§„åˆ’.md`
3. âœ… å·²é˜…è¯» `CLAUDE.md` ä¸­çš„åç«¯å¼€å‘è§„èŒƒ
4. âœ… æµ‹è¯•è´¦å·ä¿¡æ¯ï¼šç”¨æˆ·å `admin`ï¼Œå¯†ç  `!234qwer`

---

## ğŸ” ç¬¬ä¸€æ­¥ï¼šå¼ºåˆ¶ä»£ç åˆ†æï¼ˆå¿…é¡»å®Œæˆï¼‰

**é‡è¦æç¤º**ï¼šç¦æ­¢ç›´æ¥å¼€å§‹ç¼–ç ï¼å¿…é¡»å…ˆåˆ†æå‚è€ƒæ¨¡å—çš„å®é™…ä»£ç å®ç°ã€‚

### ä»»åŠ¡1ï¼šåˆ†æé›¶å”®å¥—é¤æ¨¡å—çš„åç«¯å®ç°

**è¯·ä¾æ¬¡è¯»å–å¹¶åˆ†æä»¥ä¸‹æ–‡ä»¶**ï¼š

```
1. webapp/models/retail_package.py
2. webapp/api/v1_retail_packages.py
3. webapp/services/retail_package_service.py (å¦‚æœå­˜åœ¨)
```

**åˆ†æé‡ç‚¹å¹¶å›ç­”ä»¥ä¸‹é—®é¢˜**ï¼š

**å…³äºæ•°æ®æ¨¡å‹**ï¼š
- [ ] `BaseMongoModel` æ˜¯å¦‚ä½•å®šä¹‰çš„ï¼Ÿå®ƒç»§æ‰¿è‡ªä»€ä¹ˆï¼Ÿ
- [ ] `PyObjectId` ç±»å‹æ˜¯å¦‚ä½•å¤„ç†çš„ï¼Ÿå…·ä½“å®ç°ä»£ç æ˜¯ä»€ä¹ˆï¼Ÿ
- [ ] å®¡è®¡å­—æ®µï¼ˆcreated_at, created_by, updated_at, updated_byï¼‰çš„å®šä¹‰æ–¹å¼å’Œé»˜è®¤å€¼æ˜¯ä»€ä¹ˆï¼Ÿ
- [ ] å¦‚æœæœ‰åµŒå¥—æ¨¡å‹ï¼Œå®ƒä»¬æ˜¯å¦‚ä½•å®šä¹‰çš„ï¼Ÿ
- [ ] Pydantic çš„ `model_config` é…ç½®äº†å“ªäº›é€‰é¡¹ï¼Ÿ

**å…³äº API è·¯ç”±**ï¼š
- [ ] API è·¯ç”±çš„å‰ç¼€æ˜¯ä»€ä¹ˆï¼Ÿï¼ˆä¾‹å¦‚ `/api/v1/retail-packages`ï¼‰
- [ ] `APIRouter` æ˜¯å¦‚ä½•åˆå§‹åŒ–çš„ï¼Ÿtags å‚æ•°æ˜¯ä»€ä¹ˆï¼Ÿ
- [ ] JWT è®¤è¯æ˜¯å¦‚ä½•é›†æˆçš„ï¼Ÿ`Depends(get_current_active_user)` çš„å…·ä½“ç”¨æ³•ï¼Ÿ
- [ ] åˆ›å»ºæ“ä½œä½¿ç”¨ä»€ä¹ˆå“åº”çŠ¶æ€ç ï¼Ÿï¼ˆ201 Createdï¼Ÿï¼‰
- [ ] åˆ é™¤æ“ä½œä½¿ç”¨ä»€ä¹ˆå“åº”çŠ¶æ€ç ï¼Ÿï¼ˆ204 No Contentï¼Ÿï¼‰
- [ ] `HTTPException` æ˜¯å¦‚ä½•ä½¿ç”¨çš„ï¼Ÿé”™è¯¯æ¶ˆæ¯çš„æ ¼å¼æ˜¯ä»€ä¹ˆï¼Ÿ

**å…³äºæ•°æ®åº“æ“ä½œ**ï¼š
- [ ] `DATABASE` æ˜¯å¦‚ä½•å¯¼å…¥çš„ï¼Ÿï¼ˆä»å“ªä¸ªæ¨¡å—ï¼Ÿï¼‰
- [ ] é›†åˆæ˜¯å¦‚ä½•è®¿é—®çš„ï¼Ÿï¼ˆ`DATABASE["collection_name"]` è¿˜æ˜¯å…¶ä»–æ–¹å¼ï¼Ÿï¼‰
- [ ] æŸ¥è¯¢æ“ä½œçš„æ ‡å‡†æ¨¡å¼æ˜¯ä»€ä¹ˆï¼Ÿ
- [ ] åˆ†é¡µæŸ¥è¯¢æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ
- [ ] æ’å…¥ã€æ›´æ–°ã€åˆ é™¤æ“ä½œçš„å…·ä½“ä»£ç æ¨¡å¼ï¼Ÿ

**å…³äºä¸šåŠ¡é€»è¾‘**ï¼š
- [ ] çŠ¶æ€æœºæ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿæœ‰ç‹¬ç«‹çš„å‡½æ•°å—ï¼Ÿ
- [ ] è™šæ‹Ÿå­—æ®µï¼ˆå¦‚çŠ¶æ€ï¼‰æ˜¯å¦‚ä½•è®¡ç®—çš„ï¼Ÿ
- [ ] æ•°æ®æ ¡éªŒåœ¨å“ªé‡Œè¿›è¡Œï¼Ÿï¼ˆPydantic æ¨¡å‹ï¼ŸAPI å±‚ï¼ŸæœåŠ¡å±‚ï¼Ÿï¼‰

**è¯·åœ¨ç»ˆç«¯è¾“å‡ºä½ çš„åˆ†æç»“è®º**ï¼Œä¾‹å¦‚ï¼š
```
âœ“ BaseMongoModel ç»§æ‰¿è‡ª BaseModelï¼ŒåŒ…å« PyObjectId ç±»å‹çš„ id å­—æ®µï¼Œä½¿ç”¨ alias="_id"
âœ“ API è·¯ç”±å‰ç¼€ä¸º /api/v1/retail-packagesï¼Œä½¿ç”¨ APIRouter(prefix=..., tags=["Retail Packages"])
âœ“ æ‰€æœ‰å—ä¿æŠ¤è·¯ç”±ä½¿ç”¨ current_user: User = Depends(get_current_active_user) å‚æ•°
âœ“ æ•°æ®åº“æ“ä½œé€šè¿‡ from webapp.tools.mongo import DATABASEï¼Œç„¶å DATABASE["retail_packages"]
âœ“ åˆ›å»ºæ“ä½œè¿”å› 201ï¼Œä½¿ç”¨ status_code=201 è£…é¥°å™¨å‚æ•°
âœ“ åˆ é™¤æ“ä½œè¿”å› 204ï¼Œä½¿ç”¨ status_code=204 è£…é¥°å™¨å‚æ•°
...
```

### ä»»åŠ¡2ï¼šåˆ†æå®¢æˆ·æ¡£æ¡ˆæ¨¡å—çš„åç«¯å®ç°

**è¯·è¯»å–å¹¶åˆ†æ**ï¼š

```
1. webapp/models/customer.py
2. webapp/api/v1_customers.py
```

**åˆ†æé‡ç‚¹**ï¼š
- [ ] åµŒå¥—æ•°æ®æ¨¡å‹çš„å®šä¹‰æ–¹å¼ï¼ˆå¦‚æœæœ‰ï¼‰
- [ ] åµŒå¥—èµ„æºçš„ API è®¾è®¡ï¼ˆå¦‚æˆ·å·ã€è®¡é‡ç‚¹ç®¡ç†ï¼‰
- [ ] æ•°æ®å…³è”çš„å¤„ç†æ–¹å¼

---

## ğŸ’» ç¬¬äºŒæ­¥ï¼šå¼€å‘ä»»åŠ¡

### 2.1 åˆ›å»ºæ•°æ®æ¨¡å‹æ–‡ä»¶

**æ–‡ä»¶ä½ç½®**ï¼š`webapp/models/contract.py`

**è¦æ±‚**ï¼š
- ä¸¥æ ¼å‚è€ƒé›¶å”®å¥—é¤æ¨¡å—çš„æ¨¡å‹å®šä¹‰æ–¹å¼
- å¿…é¡»åŒ…å« `BaseMongoModel`ã€`PyObjectId` çš„å®šä¹‰ï¼ˆå¦‚æœé¡¹ç›®ä¸­æ²¡æœ‰ç»Ÿä¸€çš„åŸºç±»ï¼‰
- å®šä¹‰ä»¥ä¸‹æ¨¡å‹ï¼š
  - `ContractCreate`ï¼šåˆ›å»ºåˆåŒçš„è¾“å…¥æ¨¡å‹
  - `ContractUpdate`ï¼šæ›´æ–°åˆåŒçš„è¾“å…¥æ¨¡å‹ï¼ˆå¯é€‰ï¼‰
  - `Contract`ï¼šå®Œæ•´çš„åˆåŒæ•°æ®æ¨¡å‹ï¼Œç»§æ‰¿ `BaseMongoModel` å’Œ `ContractCreate`

**æ•°æ®å­—æ®µ**ï¼ˆå‚è€ƒè®¾è®¡æ–¹æ¡ˆç¬¬3èŠ‚ï¼‰ï¼š
```python
class ContractCreate(BaseModel):
    package_name: str = Field(..., min_length=1)
    package_id: str = Field(..., min_length=1)
    customer_name: str = Field(..., min_length=1)
    customer_id: str = Field(..., min_length=1)
    purchasing_electricity_quantity: float = Field(..., gt=0)
    purchase_start_month: datetime  # å­˜å‚¨ä¸ºæ¯æœˆ1å·
    purchase_end_month: datetime    # å­˜å‚¨ä¸ºæ¯æœˆ1å·

class Contract(BaseMongoModel, ContractCreate):
    created_by: Optional[str] = None
    created_at: datetime = Field(default_factory=datetime.utcnow)
    updated_by: Optional[str] = None
    updated_at: datetime = Field(default_factory=datetime.utcnow)

    # è™šæ‹Ÿå­—æ®µï¼ˆç”±åç«¯è®¡ç®—ï¼Œä¸å­˜å‚¨åœ¨æ•°æ®åº“ï¼‰
    status: Optional[str] = None  # 'pending' | 'active' | 'expired'
```

### 2.2 åˆ›å»ºçŠ¶æ€è®¡ç®—å‡½æ•°

**åœ¨ `webapp/models/contract.py` æˆ–ç‹¬ç«‹çš„å·¥å…·æ–‡ä»¶ä¸­**ï¼š

```python
def calculate_contract_status(purchase_start_month: datetime, purchase_end_month: datetime) -> str:
    """
    è®¡ç®—åˆåŒçŠ¶æ€ï¼ˆè™šæ‹Ÿå­—æ®µï¼‰

    è§„åˆ™ï¼š
    - å¾…ç”Ÿæ•ˆ (pending): å½“å‰æœˆä»½ < è´­ç”µå¼€å§‹æœˆä»½
    - ç”Ÿæ•ˆ (active): å½“å‰æœˆä»½ >= è´­ç”µå¼€å§‹æœˆä»½ ä¸” <= è´­ç”µç»“æŸæœˆä»½
    - å·²è¿‡æœŸ (expired): å½“å‰æœˆä»½ > è´­ç”µç»“æŸæœˆä»½
    """
    from datetime import datetime

    now = datetime.now()
    current_month = datetime(now.year, now.month, 1)
    start_month = datetime(purchase_start_month.year, purchase_start_month.month, 1)
    end_month = datetime(purchase_end_month.year, purchase_end_month.month, 1)

    if current_month < start_month:
        return "pending"
    elif current_month > end_month:
        return "expired"
    else:
        return "active"
```

### 2.3 åˆ›å»º API è·¯ç”±æ–‡ä»¶

**æ–‡ä»¶ä½ç½®**ï¼š`webapp/api/v1_retail_contracts.py`

**è¦æ±‚**ï¼š
- ä¸¥æ ¼å‚è€ƒ `v1_retail_packages.py` çš„è·¯ç”±ç»“æ„
- å®ç°ä»¥ä¸‹ç«¯ç‚¹ï¼š

```python
from fastapi import APIRouter, Depends, HTTPException, Query
from typing import Optional, List
from webapp.models.contract import Contract, ContractCreate, calculate_contract_status
from webapp.tools.mongo import DATABASE
from webapp.api.dependencies import get_current_active_user  # æ ¹æ®å®é™…é¡¹ç›®è°ƒæ•´å¯¼å…¥è·¯å¾„

router = APIRouter(prefix="/api/v1/retail-contracts", tags=["Retail Contracts"])

# 1. è·å–åˆåŒåˆ—è¡¨ï¼ˆæ”¯æŒç­›é€‰ã€åˆ†é¡µï¼‰
@router.get("", response_model=dict)
async def get_contracts(
    package_name: Optional[str] = None,
    customer_name: Optional[str] = None,
    status: Optional[str] = None,
    page: int = Query(1, ge=1),
    page_size: int = Query(10, ge=1, le=100),
    current_user: User = Depends(get_current_active_user)
):
    """
    è·å–åˆåŒåˆ—è¡¨

    æ”¯æŒç­›é€‰ï¼š
    - package_name: å¥—é¤åç§°ï¼ˆæ¨¡ç³Šæœç´¢ï¼‰
    - customer_name: å®¢æˆ·åç§°ï¼ˆæ¨¡ç³Šæœç´¢ï¼‰
    - status: åˆåŒçŠ¶æ€ï¼ˆpending/active/expiredï¼‰

    æ”¯æŒåˆ†é¡µï¼š
    - page: é¡µç ï¼ˆä»1å¼€å§‹ï¼‰
    - page_size: æ¯é¡µæ•°é‡
    """
    # TODO: å®ç°æŸ¥è¯¢é€»è¾‘
    # 1. æ„å»ºæŸ¥è¯¢æ¡ä»¶
    # 2. æ‰§è¡Œæ•°æ®åº“æŸ¥è¯¢
    # 3. ä¸ºæ¯æ¡è®°å½•è®¡ç®—è™šæ‹ŸçŠ¶æ€å­—æ®µ
    # 4. å¦‚æœæœ‰ status ç­›é€‰ï¼Œè¿‡æ»¤ç»“æœ
    # 5. è¿”å›åˆ†é¡µç»“æœ
    pass

# 2. åˆ›å»ºåˆåŒ
@router.post("", status_code=201, response_model=Contract)
async def create_contract(
    contract: ContractCreate,
    current_user: User = Depends(get_current_active_user)
):
    """åˆ›å»ºåˆåŒ"""
    # TODO: å®ç°åˆ›å»ºé€»è¾‘
    # 1. éªŒè¯å¥—é¤å­˜åœ¨ä¸”çŠ¶æ€ä¸º active
    # 2. éªŒè¯å®¢æˆ·å­˜åœ¨ä¸”çŠ¶æ€ä¸º active
    # 3. éªŒè¯è´­ç”µç»“æŸæœˆä»½ >= è´­ç”µå¼€å§‹æœˆä»½
    # 4. æ·»åŠ å®¡è®¡å­—æ®µ
    # 5. æ’å…¥æ•°æ®åº“
    # 6. è®¡ç®—å¹¶æ·»åŠ è™šæ‹ŸçŠ¶æ€å­—æ®µ
    # 7. è¿”å›åˆ›å»ºçš„åˆåŒ
    pass

# 3. è·å–åˆåŒè¯¦æƒ…
@router.get("/{contract_id}", response_model=Contract)
async def get_contract(
    contract_id: str,
    current_user: User = Depends(get_current_active_user)
):
    """è·å–åˆåŒè¯¦æƒ…"""
    # TODO: å®ç°è·å–é€»è¾‘
    # 1. æŸ¥è¯¢æ•°æ®åº“
    # 2. å¦‚æœä¸å­˜åœ¨ï¼Œè¿”å› 404
    # 3. è®¡ç®—å¹¶æ·»åŠ è™šæ‹ŸçŠ¶æ€å­—æ®µ
    # 4. è¿”å›åˆåŒ
    pass

# 4. æ›´æ–°åˆåŒ
@router.put("/{contract_id}", response_model=Contract)
async def update_contract(
    contract_id: str,
    contract: ContractCreate,
    current_user: User = Depends(get_current_active_user)
):
    """æ›´æ–°åˆåŒï¼ˆä»…å¾…ç”Ÿæ•ˆçŠ¶æ€ï¼‰"""
    # TODO: å®ç°æ›´æ–°é€»è¾‘
    # 1. æŸ¥è¯¢ç°æœ‰åˆåŒ
    # 2. è®¡ç®—å½“å‰çŠ¶æ€
    # 3. å¦‚æœçŠ¶æ€ä¸æ˜¯ pendingï¼Œè¿”å› 400 é”™è¯¯
    # 4. éªŒè¯å¥—é¤å’Œå®¢æˆ·å­˜åœ¨æ€§
    # 5. æ›´æ–°å®¡è®¡å­—æ®µ
    # 6. æ‰§è¡Œæ›´æ–°
    # 7. è¿”å›æ›´æ–°åçš„åˆåŒ
    pass

# 5. åˆ é™¤åˆåŒ
@router.delete("/{contract_id}", status_code=204)
async def delete_contract(
    contract_id: str,
    current_user: User = Depends(get_current_active_user)
):
    """åˆ é™¤åˆåŒï¼ˆä»…å¾…ç”Ÿæ•ˆçŠ¶æ€ï¼‰"""
    # TODO: å®ç°åˆ é™¤é€»è¾‘
    # 1. æŸ¥è¯¢ç°æœ‰åˆåŒ
    # 2. è®¡ç®—å½“å‰çŠ¶æ€
    # 3. å¦‚æœçŠ¶æ€ä¸æ˜¯ pendingï¼Œè¿”å› 400 é”™è¯¯
    # 4. æ‰§è¡Œåˆ é™¤
    # 5. è¿”å› 204 No Content
    pass
```

### 2.4 æ›´æ–°ä¸»è·¯ç”±

**æ–‡ä»¶ä½ç½®**ï¼š`webapp/api/v1.py`

**ä¿®æ”¹**ï¼š
```python
from webapp.api import v1_retail_contracts

# åœ¨è·¯ç”±æ³¨å†Œéƒ¨åˆ†æ·»åŠ 
router.include_router(v1_retail_contracts.router)
```

### 2.5 åˆ›å»ºæ•°æ®åº“ç´¢å¼•

**æ–‡ä»¶ä½ç½®**ï¼š`scripts/create_contract_indexes.py`

```python
from webapp.tools.mongo import DATABASE

def create_indexes():
    """åˆ›å»ºåˆåŒé›†åˆçš„ç´¢å¼•"""
    collection = DATABASE["retail_contracts"]

    # å•å­—æ®µç´¢å¼•
    collection.create_index("package_name")
    collection.create_index("customer_name")
    collection.create_index("purchase_start_month")
    collection.create_index("purchase_end_month")

    # å¤åˆç´¢å¼•ï¼ˆä¼˜åŒ–ç­›é€‰æŸ¥è¯¢ï¼‰
    collection.create_index([
        ("package_name", 1),
        ("purchase_start_month", -1)
    ])

    print("âœ“ åˆåŒé›†åˆç´¢å¼•åˆ›å»ºå®Œæˆ")

if __name__ == "__main__":
    create_indexes()
```

---

## âœ… ç¬¬ä¸‰æ­¥ï¼šéªŒè¯æµ‹è¯•

### 3.1 å¯åŠ¨åç«¯æœåŠ¡

ä½¿ç”¨è‡ªåŠ¨åŒ–åç«¯æœåŠ¡å™¨ç®¡ç†ï¼ˆPowerShellï¼‰ï¼š

```powershell
# å¯åŠ¨åç«¯ï¼ˆæ—¥å¿—é‡å®šå‘ï¼‰
Start-Process uvicorn -ArgumentList "webapp.main:app", "--reload", "--host", "0.0.0.0", "--port", "8005"  -RedirectStandardOutput "tmp\uvicorn.out.log" -RedirectStandardError "tmp\uvicorn.err.log"

# æ£€æŸ¥å¯åŠ¨æ—¥å¿—
cat tmp\uvicorn.err.log
```

### 3.2 è·å– JWT Token

```powershell
# PowerShell
$response = Invoke-RestMethod -Uri "http://127.0.0.1:8005/token" -Method Post -Body @{username="admin";password="!234qwer"} -ContentType "application/x-www-form-urlencoded"
$TOKEN = $response.access_token
Write-Host "Token: $TOKEN"
```

### 3.3 è¿è¡Œå®Œæ•´çš„ API æµ‹è¯•

**æµ‹è¯•è„šæœ¬**ï¼ˆè¯·ä¾æ¬¡æ‰§è¡Œï¼‰ï¼š

```powershell
# 1. è·å–å·²ç”Ÿæ•ˆçš„å¥—é¤åˆ—è¡¨
Invoke-RestMethod -Uri "http://127.0.0.1:8005/api/v1/retail-packages?status=active" -Headers @{Authorization="Bearer $TOKEN"}

# 2. è·å–æ­£å¸¸çŠ¶æ€çš„å®¢æˆ·åˆ—è¡¨
Invoke-RestMethod -Uri "http://127.0.0.1:8005/api/v1/customers?status=active" -Headers @{Authorization="Bearer $TOKEN"}

# 3. åˆ›å»ºåˆåŒï¼ˆä½¿ç”¨ä¸Šé¢è·å–çš„å¥—é¤IDå’Œå®¢æˆ·IDï¼‰
$contractData = @{
    package_name = "2024å¹´å•†ä¸šå°–å³°å¹³è°·å¥—é¤"
    package_id = "<ä»æ­¥éª¤1è·å–çš„å¥—é¤ID>"
    customer_name = "ä¸°åŸè¶…èƒœå¡‘ä¸šæœ‰é™å…¬å¸"
    customer_id = "<ä»æ­¥éª¤2è·å–çš„å®¢æˆ·ID>"
    purchasing_electricity_quantity = 100000
    purchase_start_month = "2024-01-01T00:00:00Z"
    purchase_end_month = "2024-12-01T00:00:00Z"
} | ConvertTo-Json

$newContract = Invoke-RestMethod -Uri "http://127.0.0.1:8005/api/v1/retail-contracts" -Method Post -Headers @{Authorization="Bearer $TOKEN"; "Content-Type"="application/json"} -Body $contractData
$contractId = $newContract._id
Write-Host "åˆ›å»ºçš„åˆåŒID: $contractId"

# 4. è·å–åˆåŒåˆ—è¡¨
Invoke-RestMethod -Uri "http://127.0.0.1:8005/api/v1/retail-contracts" -Headers @{Authorization="Bearer $TOKEN"}

# 5. æŒ‰å¥—é¤åç§°ç­›é€‰
Invoke-RestMethod -Uri "http://127.0.0.1:8005/api/v1/retail-contracts?package_name=å•†ä¸š" -Headers @{Authorization="Bearer $TOKEN"}

# 6. æŒ‰çŠ¶æ€ç­›é€‰ï¼ˆå¾…ç”Ÿæ•ˆï¼‰
Invoke-RestMethod -Uri "http://127.0.0.1:8005/api/v1/retail-contracts?status=pending" -Headers @{Authorization="Bearer $TOKEN"}

# 7. åˆ†é¡µæŸ¥è¯¢
Invoke-RestMethod -Uri "http://127.0.0.1:8005/api/v1/retail-contracts?page=1&page_size=5" -Headers @{Authorization="Bearer $TOKEN"}

# 8. è·å–åˆåŒè¯¦æƒ…
Invoke-RestMethod -Uri "http://127.0.0.1:8005/api/v1/retail-contracts/$contractId" -Headers @{Authorization="Bearer $TOKEN"}

# 9. æ›´æ–°åˆåŒï¼ˆå¾…ç”Ÿæ•ˆçŠ¶æ€åº”è¯¥æˆåŠŸï¼‰
$updateData = @{
    package_name = "2024å¹´å•†ä¸šå°–å³°å¹³è°·å¥—é¤ï¼ˆå·²æ›´æ–°ï¼‰"
    package_id = "<å¥—é¤ID>"
    customer_name = "ä¸°åŸè¶…èƒœå¡‘ä¸šæœ‰é™å…¬å¸"
    customer_id = "<å®¢æˆ·ID>"
    purchasing_electricity_quantity = 150000
    purchase_start_month = "2024-02-01T00:00:00Z"
    purchase_end_month = "2024-12-01T00:00:00Z"
} | ConvertTo-Json

Invoke-RestMethod -Uri "http://127.0.0.1:8005/api/v1/retail-contracts/$contractId" -Method Put -Headers @{Authorization="Bearer $TOKEN"; "Content-Type"="application/json"} -Body $updateData

# 10. åˆ é™¤åˆåŒï¼ˆå¾…ç”Ÿæ•ˆçŠ¶æ€åº”è¯¥æˆåŠŸï¼‰
Invoke-RestMethod -Uri "http://127.0.0.1:8005/api/v1/retail-contracts/$contractId" -Method Delete -Headers @{Authorization="Bearer $TOKEN"}

# 11. æµ‹è¯•çŠ¶æ€æœºï¼šå°è¯•æ›´æ–°å·²ç”Ÿæ•ˆçš„åˆåŒï¼ˆåº”è¿”å›400é”™è¯¯ï¼‰
# åˆ›å»ºä¸€ä¸ªè´­ç”µå¼€å§‹æœˆä»½ä¸ºè¿‡å»çš„åˆåŒ
$activeContractData = @{
    package_name = "2024å¹´å•†ä¸šå°–å³°å¹³è°·å¥—é¤"
    package_id = "<å¥—é¤ID>"
    customer_name = "ä¸°åŸè¶…èƒœå¡‘ä¸šæœ‰é™å…¬å¸"
    customer_id = "<å®¢æˆ·ID>"
    purchasing_electricity_quantity = 100000
    purchase_start_month = "2023-01-01T00:00:00Z"
    purchase_end_month = "2025-12-01T00:00:00Z"
} | ConvertTo-Json

$activeContract = Invoke-RestMethod -Uri "http://127.0.0.1:8005/api/v1/retail-contracts" -Method Post -Headers @{Authorization="Bearer $TOKEN"; "Content-Type"="application/json"} -Body $activeContractData
$activeContractId = $activeContract._id

# å°è¯•æ›´æ–°ï¼ˆåº”è¯¥å¤±è´¥ï¼‰
try {
    Invoke-RestMethod -Uri "http://127.0.0.1:8005/api/v1/retail-contracts/$activeContractId" -Method Put -Headers @{Authorization="Bearer $TOKEN"; "Content-Type"="application/json"} -Body $updateData
} catch {
    Write-Host "âœ“ æ­£ç¡®æ‹’ç»äº†æ›´æ–°å·²ç”Ÿæ•ˆåˆåŒçš„è¯·æ±‚: $($_.Exception.Message)"
}

# å°è¯•åˆ é™¤ï¼ˆåº”è¯¥å¤±è´¥ï¼‰
try {
    Invoke-RestMethod -Uri "http://127.0.0.1:8005/api/v1/retail-contracts/$activeContractId" -Method Delete -Headers @{Authorization="Bearer $TOKEN"}
} catch {
    Write-Host "âœ“ æ­£ç¡®æ‹’ç»äº†åˆ é™¤å·²ç”Ÿæ•ˆåˆåŒçš„è¯·æ±‚: $($_.Exception.Message)"
}
```

### 3.4 è®¿é—® API æ–‡æ¡£

æµè§ˆå™¨è®¿é—®ï¼šhttp://127.0.0.1:8005/docs

æ£€æŸ¥ï¼š
- [ ] `/api/v1/retail-contracts` è·¯ç”±ç»„æ˜¯å¦å‡ºç°
- [ ] æ‰€æœ‰ç«¯ç‚¹çš„è¯·æ±‚/å“åº”æ¨¡å‹æ˜¯å¦æ­£ç¡®
- [ ] èƒ½å¦é€šè¿‡äº¤äº’å¼æ–‡æ¡£æµ‹è¯•æ‰€æœ‰ API

### 3.5 æ•°æ®åº“éªŒè¯

ä½¿ç”¨ mongosh æˆ– MongoDB Compassï¼š

```bash
# è¿æ¥æ•°æ®åº“
mongosh "mongodb://admin:425415@192.168.0.14:27017/exds?authSource=admin&authMechanism=SCRAM-SHA-256"

# æŸ¥çœ‹åˆåŒæ•°æ®
db.retail_contracts.find().pretty()

# éªŒè¯ç´¢å¼•
db.retail_contracts.getIndexes()

# æŸ¥è¯¢å¾…ç”Ÿæ•ˆçš„åˆåŒ
db.retail_contracts.find({
  purchase_start_month: { $gt: new Date() }
})

# æŸ¥è¯¢å·²ç”Ÿæ•ˆçš„åˆåŒ
db.retail_contracts.find({
  purchase_start_month: { $lte: new Date() },
  purchase_end_month: { $gte: new Date() }
})
```

---

## ğŸ“ éªŒæ”¶æ ‡å‡†

åœ¨å®Œæˆå¼€å‘åï¼Œè¯·é€é¡¹æ£€æŸ¥ï¼š

**åŠŸèƒ½æ€§**ï¼š
- [ ] æ‰€æœ‰ 5 ä¸ª CRUD API æ­£å¸¸å·¥ä½œ
- [ ] JWT è®¤è¯é›†æˆæ­£å¸¸ï¼ˆæœªè®¤è¯è¯·æ±‚è¿”å› 401ï¼‰
- [ ] è™šæ‹ŸçŠ¶æ€å­—æ®µè®¡ç®—æ­£ç¡®ï¼ˆpending/active/expiredï¼‰
- [ ] çŠ¶æ€æœºæƒé™æ§åˆ¶æœ‰æ•ˆï¼š
  - [ ] å¾…ç”Ÿæ•ˆåˆåŒå¯ä»¥ç¼–è¾‘
  - [ ] å¾…ç”Ÿæ•ˆåˆåŒå¯ä»¥åˆ é™¤
  - [ ] å·²ç”Ÿæ•ˆåˆåŒä¸å¯ç¼–è¾‘ï¼ˆè¿”å› 400ï¼‰
  - [ ] å·²ç”Ÿæ•ˆåˆåŒä¸å¯åˆ é™¤ï¼ˆè¿”å› 400ï¼‰
  - [ ] å·²è¿‡æœŸåˆåŒä¸å¯ç¼–è¾‘ï¼ˆè¿”å› 400ï¼‰
  - [ ] å·²è¿‡æœŸåˆåŒä¸å¯åˆ é™¤ï¼ˆè¿”å› 400ï¼‰
- [ ] åˆ†é¡µåŠŸèƒ½æ­£å¸¸
- [ ] ç­›é€‰åŠŸèƒ½æ­£å¸¸ï¼ˆå¥—é¤åç§°ã€å®¢æˆ·åç§°ã€çŠ¶æ€ï¼‰

**æ•°æ®åº“**ï¼š
- [ ] ç´¢å¼•åˆ›å»ºæˆåŠŸ
- [ ] æ•°æ®ç»“æ„ç¬¦åˆè®¾è®¡æ–¹æ¡ˆ
- [ ] å®¡è®¡å­—æ®µè‡ªåŠ¨å¡«å……

**ä»£ç è´¨é‡**ï¼š
- [ ] æ‰€æœ‰ä»£ç æ·»åŠ äº†ç±»å‹æç¤º
- [ ] éµå¾ª PEP 8 è§„èŒƒ
- [ ] ä½¿ç”¨ `DATABASE` å…¨å±€å®ä¾‹æ“ä½œæ•°æ®åº“
- [ ] ä½¿ç”¨ `HTTPException` å¤„ç†é”™è¯¯
- [ ] å‘½åè§„èŒƒï¼šsnake_caseï¼ˆå˜é‡/å‡½æ•°ï¼‰ã€PascalCaseï¼ˆç±»ï¼‰

**æ–‡æ¡£**ï¼š
- [ ] API æ–‡æ¡£è‡ªåŠ¨ç”Ÿæˆä¸”å‡†ç¡®
- [ ] æ‰€æœ‰ç«¯ç‚¹æœ‰æ¸…æ™°çš„ docstring
- [ ] é”™è¯¯å“åº”æœ‰æ˜ç¡®çš„ detail æ¶ˆæ¯

---

## ğŸš¨ å¸¸è§é—®é¢˜å’Œæ³¨æ„äº‹é¡¹

1. **PyObjectId ç±»å‹é”™è¯¯**ï¼š
   - ç¡®ä¿ `PyObjectId` çš„ `__get_pydantic_json_schema__` æ–¹æ³•æ­£ç¡®å®ç°
   - ç¡®ä¿åœ¨ `model_config` ä¸­è®¾ç½® `json_encoders={ObjectId: str}`

2. **JWT è®¤è¯å¯¼å…¥é”™è¯¯**ï¼š
   - æ£€æŸ¥ `get_current_active_user` å‡½æ•°çš„å¯¼å…¥è·¯å¾„
   - å¯èƒ½åœ¨ `webapp/api/dependencies.py` æˆ– `webapp/auth.py` ä¸­

3. **DATABASE å¯¼å…¥é”™è¯¯**ï¼š
   - ç¡®è®¤ `webapp/tools/mongo.py` æ–‡ä»¶å­˜åœ¨
   - ç¡®è®¤ `DATABASE` æ˜¯æ­£ç¡®å¯¼å‡ºçš„å…¨å±€å˜é‡

4. **æ—¥æœŸå¤„ç†é—®é¢˜**ï¼š
   - ç¡®ä¿æœˆä»½ç»Ÿä¸€å­˜å‚¨ä¸ºæ¯æœˆ1å·ï¼ˆ`datetime(year, month, 1)`ï¼‰
   - ä½¿ç”¨ UTC æ—¶é—´ï¼ˆ`datetime.utcnow()`ï¼‰

5. **çŠ¶æ€è®¡ç®—é€»è¾‘**ï¼š
   - ç¡®ä¿çŠ¶æ€è®¡ç®—å‡½æ•°åœ¨æ¯æ¬¡è¿”å›æ•°æ®æ—¶éƒ½è¢«è°ƒç”¨
   - çŠ¶æ€å­—æ®µä¸åº”å­˜å‚¨åœ¨æ•°æ®åº“ä¸­ï¼ˆå®ƒæ˜¯è™šæ‹Ÿå­—æ®µï¼‰

---

## ğŸ“š å‚è€ƒæ–‡æ¡£

- **è®¾è®¡æ–¹æ¡ˆ**ï¼š`docs/pages/é›¶å”®åˆåŒç®¡ç†/é›¶å”®åˆåŒç®¡ç†æ¨¡å—è®¾è®¡æ–¹æ¡ˆ.md`
- **å¼€å‘è§„åˆ’**ï¼š`docs/pages/é›¶å”®åˆåŒç®¡ç†/é›¶å”®åˆåŒç®¡ç†æ¨¡å—å¼€å‘è§„åˆ’.md`
- **é¡¹ç›®è§„èŒƒ**ï¼š`CLAUDE.md`
- **å‚è€ƒä»£ç **ï¼š
  - `webapp/models/retail_package.py`
  - `webapp/api/v1_retail_packages.py`
  - `webapp/models/customer.py`
  - `webapp/api/v1_customers.py`

---

## âœ… å®Œæˆåçš„è¡ŒåŠ¨

åœ¨å®Œæˆæœ¬ä¼šè¯çš„æ‰€æœ‰å¼€å‘å’Œæµ‹è¯•åï¼š

1. æ›´æ–°å¼€å‘è§„åˆ’æ–‡æ¡£ä¸­çš„è¿›åº¦è¡¨
2. æäº¤ä»£ç åˆ° Gitï¼ˆå¦‚æœé¡¹ç›®ä½¿ç”¨ç‰ˆæœ¬æ§åˆ¶ï¼‰
3. å‡†å¤‡è¿›å…¥ä¼šè¯2ï¼ˆå¯¼å…¥å¯¼å‡ºåŠŸèƒ½ï¼‰

**ä¼šè¯2æç¤ºè¯**ï¼š`docs/pages/é›¶å”®åˆåŒç®¡ç†/ä¼šè¯2-å¯¼å…¥å¯¼å‡ºåŠŸèƒ½æç¤ºè¯.md`
