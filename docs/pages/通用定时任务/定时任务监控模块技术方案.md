# å®šæ—¶ä»»åŠ¡ç›‘æ§æ¨¡å—æŠ€æœ¯æ–¹æ¡ˆ

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**åˆ›å»ºæ—¥æœŸ**: 2025-11-12
**ä½œè€…**: å¼€å‘å›¢é˜Ÿ
**çŠ¶æ€**: å¾…å®æ–½

---

## ğŸ“‹ ç›®å½•

1. [æ¦‚è¿°](#æ¦‚è¿°)
2. [åŠŸèƒ½è®¾è®¡](#åŠŸèƒ½è®¾è®¡)
3. [æŠ€æœ¯æ¶æ„](#æŠ€æœ¯æ¶æ„)
4. [æ•°æ®åº“è®¾è®¡](#æ•°æ®åº“è®¾è®¡)
5. [åç«¯å®ç°](#åç«¯å®ç°)
6. [å‰ç«¯å®ç°](#å‰ç«¯å®ç°)
7. [å®æ–½è®¡åˆ’](#å®æ–½è®¡åˆ’)
8. [æµ‹è¯•æ–¹æ¡ˆ](#æµ‹è¯•æ–¹æ¡ˆ)
9. [è¿ç»´æŒ‡å—](#è¿ç»´æŒ‡å—)

---

## æ¦‚è¿°

### èƒŒæ™¯

éšç€ç”µåŠ›äº¤æ˜“è¾…åŠ©å†³ç­–ç³»ç»Ÿä¸šåŠ¡åŠŸèƒ½çš„ä¸æ–­æ‰©å±•ï¼Œç³»ç»Ÿéœ€è¦æ‰§è¡Œè¶Šæ¥è¶Šå¤šçš„å®šæ—¶ä»»åŠ¡ï¼ŒåŒ…æ‹¬ï¼š
- **çŠ¶æ€æµè½¬åˆ¤æ–­**: å®¢æˆ·çŠ¶æ€è‡ªåŠ¨æ›´æ–°ã€åˆåŒçŠ¶æ€è‡ªåŠ¨è¿‡æœŸ
- **æ•°æ®åŠ å·¥**: è´Ÿè·æ•°æ®é¢„å¤„ç†ã€ä»·æ ¼æ•°æ®æ¸…æ´—
- **é¢„æµ‹è®¡ç®—**: è´Ÿè·é¢„æµ‹æ¨¡å‹è®­ç»ƒã€äº¤æ˜“ç­–ç•¥ä¼˜åŒ–
- **é¢„ç»“ç®—**: æœˆåº¦ç”µè´¹é¢„ç»“ç®—ã€åˆåŒæ‰§è¡Œæƒ…å†µç»Ÿè®¡
- **æŠ¥è¡¨ç”Ÿæˆ**: æ—¥æŠ¥ã€å‘¨æŠ¥ã€æœˆæŠ¥è‡ªåŠ¨ç”Ÿæˆ

ä¸ºäº†ç»Ÿä¸€ç®¡ç†è¿™äº›å®šæ—¶ä»»åŠ¡ï¼Œæä¾›å¯è§†åŒ–çš„ç›‘æ§å’Œç®¡ç†ç•Œé¢ï¼Œæˆ‘ä»¬éœ€è¦å¼€å‘ä¸€ä¸ª**é€šç”¨çš„å®šæ—¶ä»»åŠ¡ç›‘æ§æ¨¡å—**ã€‚

### ç›®æ ‡

1. **ç»Ÿä¸€ç®¡ç†**: æ‰€æœ‰ä¸šåŠ¡æ¨¡å—çš„å®šæ—¶ä»»åŠ¡ä½¿ç”¨ç»Ÿä¸€çš„è°ƒåº¦æ¡†æ¶
2. **å¯è§†åŒ–ç›‘æ§**: æä¾›ç›´è§‚çš„ç›‘æ§ç•Œé¢ï¼Œå®æ—¶æŸ¥çœ‹ä»»åŠ¡çŠ¶æ€
3. **è¿ç»´ä¾¿åˆ©**: æ”¯æŒæ‰‹åŠ¨è§¦å‘ã€å¯ç”¨/ç¦ç”¨ä»»åŠ¡ï¼Œæ— éœ€é‡å¯æœåŠ¡
4. **é—®é¢˜æ’æŸ¥**: è¯¦ç»†çš„æ‰§è¡Œæ—¥å¿—å’Œé”™è¯¯ä¿¡æ¯ï¼Œå¿«é€Ÿå®šä½é—®é¢˜
5. **æ€§èƒ½åˆ†æ**: ä»»åŠ¡æ‰§è¡Œæ—¶é•¿è¶‹åŠ¿ã€æˆåŠŸç‡ç»Ÿè®¡ï¼Œä¼˜åŒ–ç³»ç»Ÿæ€§èƒ½

### åŠŸèƒ½èŒƒå›´

æœ¬æ–¹æ¡ˆå®ç°**å®Œæ•´ç‰ˆç›‘æ§æ¨¡å—**ï¼ŒåŒ…å«ä»¥ä¸‹åŠŸèƒ½ï¼š

| åŠŸèƒ½ç±»åˆ« | åŠŸèƒ½é¡¹ | ä¼˜å…ˆçº§ |
|---------|-------|--------|
| **åŸºç¡€ç›‘æ§** | ä»»åŠ¡åˆ—è¡¨æŸ¥çœ‹ã€å®æ—¶çŠ¶æ€ç›‘æ§ã€æ‰§è¡Œå†å²æŸ¥çœ‹ | P0 |
| **ä»»åŠ¡æ§åˆ¶** | æ‰‹åŠ¨è§¦å‘æ‰§è¡Œã€å¯ç”¨/ç¦ç”¨ä»»åŠ¡ | P0 |
| **æ—¥å¿—åˆ†æ** | æ‰§è¡Œæ—¥å¿—æŸ¥çœ‹ã€é”™è¯¯ä¿¡æ¯å±•ç¤º | P0 |
| **æ€§èƒ½ç»Ÿè®¡** | æ‰§è¡Œæ—¶é•¿è¶‹åŠ¿ã€æˆåŠŸç‡ç»Ÿè®¡ã€ä»»åŠ¡è´Ÿè½½åˆ†æ | P1 |
| **æ•°æ®å±•ç¤º** | ç»Ÿè®¡å¡ç‰‡ã€è¶‹åŠ¿å›¾è¡¨ã€ä»»åŠ¡åˆ—è¡¨è¡¨æ ¼ | P0 |

---

## åŠŸèƒ½è®¾è®¡

### 2.1 é¡µé¢å¸ƒå±€ï¼ˆæ··åˆå¼ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç³»ç»Ÿç®¡ç† > å®šæ—¶ä»»åŠ¡ç›‘æ§                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ æ€»ä»»åŠ¡æ•°  â”‚  â”‚ è¿è¡Œä¸­   â”‚  â”‚ æˆåŠŸç‡   â”‚  â”‚ å¤±è´¥æ•°   â”‚   â”‚
â”‚  â”‚   12     â”‚  â”‚    3     â”‚  â”‚  98.5%   â”‚  â”‚    2     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ä»»åŠ¡æ‰§è¡Œè¶‹åŠ¿ (æœ€è¿‘7å¤©)                   [å…¨å±æŒ‰é’®]    â”‚ â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚ â”‚                                                    â”‚  â”‚ â”‚
â”‚  â”‚ â”‚        æŠ˜çº¿å›¾ï¼šæˆåŠŸä»»åŠ¡æ•° vs å¤±è´¥ä»»åŠ¡æ•°              â”‚  â”‚ â”‚
â”‚  â”‚ â”‚                                                    â”‚  â”‚ â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ä»»åŠ¡åˆ—è¡¨                                               â”‚ â”‚
â”‚  â”‚ [æœç´¢æ¡†] [ç±»åˆ«ç­›é€‰] [çŠ¶æ€ç­›é€‰] [åˆ·æ–°]                   â”‚ â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚ â”‚#  â”‚ä»»åŠ¡åç§°  â”‚ç±»åˆ«   â”‚çŠ¶æ€  â”‚ä¸‹æ¬¡ â”‚å¹³å‡ â”‚æ“ä½œ    â”‚  â”‚ â”‚
â”‚  â”‚ â”œâ”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚ â”‚
â”‚  â”‚ â”‚1  â”‚å®¢æˆ·çŠ¶æ€  â”‚customerâ”‚å¯ç”¨  â”‚2h   â”‚2.3s â”‚[è¯¦æƒ…]  â”‚  â”‚ â”‚
â”‚  â”‚ â”‚   â”‚è‡ªåŠ¨æ›´æ–°  â”‚       â”‚      â”‚     â”‚     â”‚[æ‰§è¡Œ]  â”‚  â”‚ â”‚
â”‚  â”‚ â”‚   â”‚         â”‚       â”‚      â”‚     â”‚     â”‚[æ—¥å¿—]  â”‚  â”‚ â”‚
â”‚  â”‚ â”œâ”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚ â”‚
â”‚  â”‚ â”‚2  â”‚åˆåŒåˆ°æœŸ  â”‚contractâ”‚å¯ç”¨  â”‚14h  â”‚1.8s â”‚[è¯¦æƒ…]  â”‚  â”‚ â”‚
â”‚  â”‚ â”‚   â”‚æé†’     â”‚       â”‚      â”‚     â”‚     â”‚[æ‰§è¡Œ]  â”‚  â”‚ â”‚
â”‚  â”‚ â”‚   â”‚         â”‚       â”‚      â”‚     â”‚     â”‚[æ—¥å¿—]  â”‚  â”‚ â”‚
â”‚  â”‚ â””â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â”‚ [åˆ†é¡µ: 1-10 of 12]                                     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ ¸å¿ƒåŠŸèƒ½è¯¦è§£

#### 2.2.1 ç»Ÿè®¡å¡ç‰‡

**æ•°æ®æº**: å®æ—¶èšåˆæ•°æ®åº“ä¸­çš„ä»»åŠ¡é…ç½®å’Œæ‰§è¡Œæ—¥å¿—

| å¡ç‰‡ | è®¡ç®—é€»è¾‘ | é¢œè‰² |
|------|---------|------|
| æ€»ä»»åŠ¡æ•° | `task_configs` é›†åˆçš„æ–‡æ¡£æ•°é‡ | é»˜è®¤ (ç°è‰²) |
| è¿è¡Œä¸­ | å½“å‰æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡æ•° (`task_execution_logs` ä¸­ status=`started` ä¸”æœªå®Œæˆçš„è®°å½•) | æˆåŠŸè‰² (ç»¿è‰²) |
| æˆåŠŸç‡ | æœ€è¿‘24å°æ—¶æˆåŠŸä»»åŠ¡æ•° / æ€»æ‰§è¡Œæ¬¡æ•° Ã— 100% | ä¿¡æ¯è‰² (è“è‰²) |
| å¤±è´¥æ•° | æœ€è¿‘24å°æ—¶å¤±è´¥ä»»åŠ¡æ•° (`status=failed`) | é”™è¯¯è‰² (çº¢è‰²) |

**å®ç°ç»„ä»¶**:
```typescript
interface StatCardProps {
    title: string;
    value: string | number;
    icon: React.ReactNode;
    color?: string;
    loading?: boolean;
}

const StatCard: React.FC<StatCardProps> = ({ title, value, icon, color, loading }) => {
    return (
        <Paper variant="outlined" sx={{ p: 2, display: 'flex', alignItems: 'center', gap: 2 }}>
            <Box
                sx={{
                    width: 48,
                    height: 48,
                    borderRadius: 2,
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    backgroundColor: color ? `${color}.lighter` : 'grey.100',
                    color: color || 'grey.700'
                }}
            >
                {icon}
            </Box>
            <Box sx={{ flex: 1 }}>
                <Typography variant="body2" color="text.secondary">
                    {title}
                </Typography>
                <Typography variant="h5" fontWeight="bold">
                    {loading ? <Skeleton width={60} /> : value}
                </Typography>
            </Box>
        </Paper>
    );
};
```

#### 2.2.2 ä»»åŠ¡æ‰§è¡Œè¶‹åŠ¿å›¾è¡¨

**æ•°æ®æº**: æœ€è¿‘7å¤©çš„ä»»åŠ¡æ‰§è¡Œæ—¥å¿—

**å›¾è¡¨ç±»å‹**: Recharts `LineChart` æˆ– `AreaChart`

**æ•°æ®ç»“æ„**:
```typescript
interface TrendDataPoint {
    date: string;           // "2025-11-12"
    success_count: number;  // æˆåŠŸä»»åŠ¡æ•°
    failed_count: number;   // å¤±è´¥ä»»åŠ¡æ•°
    total_count: number;    // æ€»ä»»åŠ¡æ•°
    avg_duration: number;   // å¹³å‡æ‰§è¡Œæ—¶é•¿ï¼ˆç§’ï¼‰
}
```

**èšåˆæŸ¥è¯¢**ï¼ˆåç«¯ï¼‰:
```python
def get_execution_trend(days: int = 7) -> List[Dict]:
    """è·å–ä»»åŠ¡æ‰§è¡Œè¶‹åŠ¿æ•°æ®"""
    pipeline = [
        {
            "$match": {
                "created_at": {
                    "$gte": datetime.utcnow() - timedelta(days=days)
                }
            }
        },
        {
            "$group": {
                "_id": {
                    "$dateToString": {
                        "format": "%Y-%m-%d",
                        "date": "$created_at"
                    }
                },
                "total_count": {"$sum": 1},
                "success_count": {
                    "$sum": {
                        "$cond": [{"$eq": ["$status", "completed"]}, 1, 0]
                    }
                },
                "failed_count": {
                    "$sum": {
                        "$cond": [{"$eq": ["$status", "failed"]}, 1, 0]
                    }
                },
                "avg_duration": {"$avg": "$execution_time"}
            }
        },
        {"$sort": {"_id": 1}}
    ]

    results = list(DATABASE.task_execution_logs.aggregate(pipeline))
    return [
        {
            "date": r["_id"],
            "total_count": r["total_count"],
            "success_count": r["success_count"],
            "failed_count": r["failed_count"],
            "avg_duration": round(r.get("avg_duration", 0), 2)
        }
        for r in results
    ]
```

**å›¾è¡¨é…ç½®**:
```typescript
<ResponsiveContainer width="100%" height="100%">
    <LineChart data={trendData}>
        <CartesianGrid strokeDasharray="3 3" />
        <XAxis dataKey="date" />
        <YAxis />
        <Tooltip />
        <Legend />
        <Line
            type="monotone"
            dataKey="success_count"
            stroke="#4caf50"
            strokeWidth={2}
            name="æˆåŠŸ"
        />
        <Line
            type="monotone"
            dataKey="failed_count"
            stroke="#f44336"
            strokeWidth={2}
            name="å¤±è´¥"
        />
    </LineChart>
</ResponsiveContainer>
```

#### 2.2.3 ä»»åŠ¡åˆ—è¡¨è¡¨æ ¼

**æ•°æ®æº**: `task_configs` é›†åˆ + æœ€æ–°æ‰§è¡Œè®°å½•

**è¡¨æ ¼å­—æ®µ**:

| å­—æ®µ | è¯´æ˜ | æ•°æ®æº |
|------|------|--------|
| ä»»åŠ¡åç§° | ä»»åŠ¡çš„æ˜¾ç¤ºåç§° | `task_configs.display_name` |
| ç±»åˆ« | ä»»åŠ¡åˆ†ç±»ï¼ˆcustomer/contract/data/reportï¼‰ | `task_configs.category` |
| çŠ¶æ€ | å¯ç”¨/ç¦ç”¨ | `task_configs.enabled` |
| ä¸‹æ¬¡æ‰§è¡Œ | è·ç¦»ä¸‹æ¬¡æ‰§è¡Œçš„æ—¶é—´ | APScheduler `next_run_time` |
| å¹³å‡æ—¶é•¿ | æœ€è¿‘10æ¬¡æ‰§è¡Œçš„å¹³å‡æ—¶é•¿ | èšåˆè®¡ç®— |
| æœ€åæ‰§è¡Œ | æœ€åä¸€æ¬¡æ‰§è¡Œçš„çŠ¶æ€å’Œæ—¶é—´ | `task_execution_logs` æœ€æ–°è®°å½• |
| æ“ä½œ | è¯¦æƒ…ã€æ‰§è¡Œã€æ—¥å¿—ã€å¯ç”¨/ç¦ç”¨ | - |

**ç­›é€‰åŠŸèƒ½**:
- **æœç´¢æ¡†**: æŒ‰ä»»åŠ¡åç§°æ¨¡ç³Šæœç´¢
- **ç±»åˆ«ç­›é€‰**: customer / contract / data / report / all
- **çŠ¶æ€ç­›é€‰**: å¯ç”¨ / ç¦ç”¨ / å…¨éƒ¨

**æ’åºåŠŸèƒ½**:
- é»˜è®¤æŒ‰ `created_at` é™åº
- æ”¯æŒæŒ‰ä»»åŠ¡åç§°ã€ç±»åˆ«ã€ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´æ’åº

#### 2.2.4 ä»»åŠ¡è¯¦æƒ…å¯¹è¯æ¡†

**è§¦å‘æ–¹å¼**: ç‚¹å‡»ä»»åŠ¡åˆ—è¡¨ä¸­çš„"è¯¦æƒ…"æŒ‰é’®

**å¯¹è¯æ¡†å†…å®¹**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä»»åŠ¡è¯¦æƒ…: å®¢æˆ·çŠ¶æ€è‡ªåŠ¨æ›´æ–°            [X] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                          â”‚
â”‚ [åŸºæœ¬ä¿¡æ¯] [è°ƒåº¦é…ç½®] [æ‰§è¡Œå†å²]        â”‚
â”‚                                          â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ åŸºæœ¬ä¿¡æ¯                          â”‚   â”‚
â”‚ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚   â”‚
â”‚ â”‚ ä»»åŠ¡åç§°: å®¢æˆ·çŠ¶æ€è‡ªåŠ¨æ›´æ–°         â”‚   â”‚
â”‚ â”‚ ç±»åˆ«:     customer                â”‚   â”‚
â”‚ â”‚ çŠ¶æ€:     â— å¯ç”¨                  â”‚   â”‚
â”‚ â”‚ æè¿°:     æ¯æ—¥å‡Œæ™¨2:00æ‰§è¡Œï¼Œæ ¹æ®... â”‚   â”‚
â”‚ â”‚ åˆ›å»ºæ—¶é—´: 2025-11-10 10:00:00    â”‚   â”‚
â”‚ â”‚ æ›´æ–°æ—¶é—´: 2025-11-12 02:00:15    â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                          â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ è°ƒåº¦é…ç½®                          â”‚   â”‚
â”‚ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚   â”‚
â”‚ â”‚ Cronè¡¨è¾¾å¼: 0 2 * * *             â”‚   â”‚
â”‚ â”‚ æ—¶åŒº:       Asia/Shanghai         â”‚   â”‚
â”‚ â”‚ ä¸‹æ¬¡æ‰§è¡Œ:   2025-11-13 02:00:00   â”‚   â”‚
â”‚ â”‚ æœ€å¤§å¹¶å‘æ•°: 1                     â”‚   â”‚
â”‚ â”‚ è¶…æ—¶æ—¶é—´:   300ç§’                 â”‚   â”‚
â”‚ â”‚ é‡è¯•æ¬¡æ•°:   3                     â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                          â”‚
â”‚ [æ‰‹åŠ¨æ‰§è¡Œ] [å¯ç”¨/ç¦ç”¨] [æŸ¥çœ‹æ—¥å¿—] [å…³é—­] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 2.2.5 æ‰§è¡Œå†å²è¡¨æ ¼ï¼ˆä»»åŠ¡è¯¦æƒ…å†…ï¼‰

**æ•°æ®æº**: `task_execution_logs` é›†åˆ

**è¡¨æ ¼å­—æ®µ**:
- æ‰§è¡ŒID
- æ‰§è¡Œæ—¶é—´
- çŠ¶æ€ï¼ˆæˆåŠŸ/å¤±è´¥/è¿è¡Œä¸­ï¼‰
- æ‰§è¡Œæ—¶é•¿
- å¤„ç†è®°å½•æ•°ï¼ˆä» `result` å­—æ®µæå–ï¼‰
- é”™è¯¯ä¿¡æ¯ï¼ˆä»…å¤±è´¥æ—¶æ˜¾ç¤ºï¼‰
- æ“ä½œï¼ˆæŸ¥çœ‹è¯¦æƒ…ï¼‰

**åˆ†é¡µ**: æ¯é¡µ20æ¡ï¼Œé»˜è®¤æŒ‰æ‰§è¡Œæ—¶é—´é™åº

#### 2.2.6 æ‰§è¡Œæ—¥å¿—å¯¹è¯æ¡†

**è§¦å‘æ–¹å¼**: ç‚¹å‡»ä»»åŠ¡åˆ—è¡¨æˆ–æ‰§è¡Œå†å²ä¸­çš„"æ—¥å¿—"æŒ‰é’®

**å¯¹è¯æ¡†å†…å®¹**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ‰§è¡Œæ—¥å¿—: å®¢æˆ·çŠ¶æ€è‡ªåŠ¨æ›´æ–°            [X] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ‰§è¡ŒID: exec_20251112020015              â”‚
â”‚ æ‰§è¡Œæ—¶é—´: 2025-11-12 02:00:15           â”‚
â”‚ çŠ¶æ€: âœ“ æˆåŠŸ                            â”‚
â”‚ æ‰§è¡Œæ—¶é•¿: 2.34ç§’                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                          â”‚
â”‚ [æ ‡å‡†è¾“å‡º] [é”™è¯¯è¾“å‡º] [æ‰§è¡Œç»“æœ]        â”‚
â”‚                                          â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ [02:00:15] ä»»åŠ¡å¼€å§‹æ‰§è¡Œ            â”‚   â”‚
â”‚ â”‚ [02:00:15] æ‰«æå®¢æˆ·æ•°é‡: 156       â”‚   â”‚
â”‚ â”‚ [02:00:16] æ£€æµ‹åˆ°çŠ¶æ€ä¸ä¸€è‡´: 3     â”‚   â”‚
â”‚ â”‚ [02:00:17] å®¢æˆ·ID 123: pendingâ†’activeâ”‚ â”‚
â”‚ â”‚ [02:00:17] å®¢æˆ·ID 456: activeâ†’terminatedâ”‚
â”‚ â”‚ [02:00:18] å®¢æˆ·ID 789: prospectâ†’pendingâ”‚
â”‚ â”‚ [02:00:18] ä»»åŠ¡æ‰§è¡Œå®Œæˆ            â”‚   â”‚
â”‚ â”‚ [02:00:18] æˆåŠŸæ›´æ–°: 3, å¤±è´¥: 0    â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                          â”‚
â”‚ [ä¸‹è½½æ—¥å¿—] [å…³é—­]                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ—¥å¿—å­˜å‚¨æ–¹å¼**:
- æ—¥å¿—å†…å®¹ä¿å­˜åœ¨ `task_execution_logs.log_content` å­—æ®µï¼ˆTextç±»å‹ï¼‰
- æ”¯æŒæŒ‰è¡Œåˆ†å‰²å±•ç¤º
- æ”¯æŒè¯­æ³•é«˜äº®ï¼ˆå¯é€‰ï¼‰

#### 2.2.7 æ‰‹åŠ¨æ‰§è¡Œä»»åŠ¡

**è§¦å‘æ–¹å¼**: ç‚¹å‡»ä»»åŠ¡åˆ—è¡¨æˆ–è¯¦æƒ…å¯¹è¯æ¡†ä¸­çš„"æ‰§è¡Œ"æŒ‰é’®

**æ‰§è¡Œæµç¨‹**:
```
ç”¨æˆ·ç‚¹å‡»"æ‰§è¡Œ"æŒ‰é’®
    â†“
æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡† ("ç¡®å®šè¦ç«‹å³æ‰§è¡Œæ­¤ä»»åŠ¡å—ï¼Ÿ")
    â†“
ç”¨æˆ·ç¡®è®¤
    â†“
è°ƒç”¨ POST /api/v1/scheduler/tasks/{task_name}/execute
    â†“
åç«¯æ£€æŸ¥ä»»åŠ¡æ˜¯å¦æ­£åœ¨è¿è¡Œ
    â†“
å¦‚æœæ­£åœ¨è¿è¡Œ â†’ è¿”å›é”™è¯¯ "ä»»åŠ¡æ­£åœ¨æ‰§è¡Œä¸­ï¼Œè¯·ç¨åå†è¯•"
    â†“
å¦‚æœæœªè¿è¡Œ â†’ åˆ›å»ºæ–°çš„æ‰§è¡Œè®°å½• â†’ å¼‚æ­¥æ‰§è¡Œä»»åŠ¡
    â†“
å‰ç«¯æ˜¾ç¤º "ä»»åŠ¡å·²åŠ å…¥æ‰§è¡Œé˜Ÿåˆ—" â†’ è‡ªåŠ¨åˆ·æ–°ä»»åŠ¡åˆ—è¡¨
    â†“
ç”¨æˆ·å¯ä»¥åœ¨æ‰§è¡Œå†å²ä¸­æŸ¥çœ‹æ‰§è¡Œè¿›åº¦
```

**é˜²é‡å¤æ‰§è¡Œ**:
- åŒä¸€ä»»åŠ¡åŒæ—¶åªèƒ½æœ‰ä¸€ä¸ªå®ä¾‹è¿è¡Œ
- APScheduler é…ç½®: `max_instances=1`
- å‰ç«¯æŒ‰é’®ç¦ç”¨é€»è¾‘: å¦‚æœä»»åŠ¡æ­£åœ¨è¿è¡Œï¼Œ"æ‰§è¡Œ"æŒ‰é’®æ˜¾ç¤ºä¸ºç¦ç”¨çŠ¶æ€

#### 2.2.8 å¯ç”¨/ç¦ç”¨ä»»åŠ¡

**è§¦å‘æ–¹å¼**:
- ä»»åŠ¡åˆ—è¡¨ä¸­çš„å¼€å…³æŒ‰é’®
- ä»»åŠ¡è¯¦æƒ…å¯¹è¯æ¡†ä¸­çš„"å¯ç”¨/ç¦ç”¨"æŒ‰é’®

**æ‰§è¡Œæµç¨‹**:
```
ç”¨æˆ·ç‚¹å‡»å¼€å…³
    â†“
è°ƒç”¨ POST /api/v1/scheduler/tasks/{task_name}/toggle
    â†“
åç«¯æ›´æ–° task_configs.enabled å­—æ®µ
    â†“
å¦‚æœç¦ç”¨: æš‚åœAPSchedulerä¸­çš„å¯¹åº”Job (scheduler.pause_job)
å¦‚æœå¯ç”¨: æ¢å¤APSchedulerä¸­çš„å¯¹åº”Job (scheduler.resume_job)
    â†“
è¿”å›æ“ä½œç»“æœ
    â†“
å‰ç«¯æ›´æ–°UIçŠ¶æ€
```

**æƒé™æ§åˆ¶**:
- æ ¹æ®éœ€æ±‚é…ç½®ï¼Œå½“å‰æ–¹æ¡ˆä¸º"æ— é™åˆ¶"ï¼ˆæ‰€æœ‰ç™»å½•ç”¨æˆ·å¯æ“ä½œï¼‰
- å¦‚éœ€æ·»åŠ æƒé™ï¼Œå¯åœ¨åç«¯æ·»åŠ  `role` æ£€æŸ¥

---

## æŠ€æœ¯æ¶æ„

### 3.1 æ€»ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å‰ç«¯å±‚ (React)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  SchedulerMonitorPage                                        â”‚
â”‚  â”œâ”€â”€ StatCards (ç»Ÿè®¡å¡ç‰‡)                                    â”‚
â”‚  â”œâ”€â”€ TrendChart (è¶‹åŠ¿å›¾è¡¨)                                   â”‚
â”‚  â”œâ”€â”€ TaskListTable (ä»»åŠ¡åˆ—è¡¨)                                â”‚
â”‚  â”œâ”€â”€ TaskDetailDialog (ä»»åŠ¡è¯¦æƒ…å¯¹è¯æ¡†)                        â”‚
â”‚  â””â”€â”€ ExecutionLogDialog (æ‰§è¡Œæ—¥å¿—å¯¹è¯æ¡†)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“ HTTP/REST API
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       åç«¯APIå±‚ (FastAPI)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  v1_scheduler.py                                             â”‚
â”‚  â”œâ”€â”€ GET  /api/v1/scheduler/statistics                      â”‚
â”‚  â”œâ”€â”€ GET  /api/v1/scheduler/tasks                           â”‚
â”‚  â”œâ”€â”€ GET  /api/v1/scheduler/tasks/{task_name}               â”‚
â”‚  â”œâ”€â”€ POST /api/v1/scheduler/tasks/{task_name}/execute       â”‚
â”‚  â”œâ”€â”€ POST /api/v1/scheduler/tasks/{task_name}/toggle        â”‚
â”‚  â”œâ”€â”€ GET  /api/v1/scheduler/tasks/{task_name}/history       â”‚
â”‚  â”œâ”€â”€ GET  /api/v1/scheduler/execution-logs/{execution_id}   â”‚
â”‚  â””â”€â”€ GET  /api/v1/scheduler/trend                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ä¸šåŠ¡æœåŠ¡å±‚ (Services)                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  SchedulerService (è°ƒåº¦ç®¡ç†)                                 â”‚
â”‚  â”œâ”€â”€ get_all_tasks()                                         â”‚
â”‚  â”œâ”€â”€ get_task_detail(task_name)                             â”‚
â”‚  â”œâ”€â”€ execute_task(task_name)                                â”‚
â”‚  â”œâ”€â”€ toggle_task(task_name, enabled)                        â”‚
â”‚  â””â”€â”€ get_next_run_time(task_name)                           â”‚
â”‚                                                              â”‚
â”‚  TaskMonitorService (ä»»åŠ¡ç›‘æ§)                               â”‚
â”‚  â”œâ”€â”€ get_statistics()                                        â”‚
â”‚  â”œâ”€â”€ get_execution_trend(days)                              â”‚
â”‚  â”œâ”€â”€ get_task_history(task_name, limit)                     â”‚
â”‚  â””â”€â”€ get_execution_log(execution_id)                        â”‚
â”‚                                                              â”‚
â”‚  TaskExecutionService (ä»»åŠ¡æ‰§è¡Œ)                             â”‚
â”‚  â”œâ”€â”€ start_execution(task_name)                             â”‚
â”‚  â”œâ”€â”€ finish_execution(execution_id, result)                 â”‚
â”‚  â””â”€â”€ log_execution(execution_id, message)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      è°ƒåº¦å¼•æ“ (APScheduler)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  BackgroundScheduler                                         â”‚
â”‚  â”œâ”€â”€ JobStore: MongoDBJobStore                              â”‚
â”‚  â”œâ”€â”€ Executor: ThreadPoolExecutor (5 workers)               â”‚
â”‚  â””â”€â”€ Trigger: CronTrigger                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ä¸šåŠ¡ä»»åŠ¡å±‚ (Tasks)                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  BaseTask (æŠ½è±¡åŸºç±»)                                         â”‚
â”‚  â”œâ”€â”€ execute() - å¿…é¡»å®ç°                                    â”‚
â”‚  â”œâ”€â”€ run() - åŒ…è£…æ‰§è¡Œé€»è¾‘                                     â”‚
â”‚  â””â”€â”€ _log() - æ—¥å¿—è®°å½•                                       â”‚
â”‚                                                              â”‚
â”‚  CustomerStatusUpdateTask                                    â”‚
â”‚  ContractExpirationReminderTask                              â”‚
â”‚  ContractAutoExpirationTask                                  â”‚
â”‚  DataCleanupTask                                             â”‚
â”‚  DailyReportGenerationTask                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æ•°æ®æŒä¹…åŒ–å±‚ (MongoDB)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Collections:                                                â”‚
â”‚  â”œâ”€â”€ scheduler_jobs (APSchedulerç®¡ç†)                        â”‚
â”‚  â”œâ”€â”€ task_configs (ä»»åŠ¡é…ç½®)                                 â”‚
â”‚  â””â”€â”€ task_execution_logs (æ‰§è¡Œæ—¥å¿—)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 æŠ€æœ¯æ ˆ

| å±‚çº§ | æŠ€æœ¯é€‰å‹ | ç‰ˆæœ¬ | è¯´æ˜ |
|------|---------|------|------|
| å‰ç«¯æ¡†æ¶ | React | 18.x | ç°æœ‰æŠ€æœ¯æ ˆ |
| UIç»„ä»¶åº“ | Material-UI | 7.x | Grid v7è¯­æ³• |
| å›¾è¡¨åº“ | Recharts | 2.x | ç°æœ‰æŠ€æœ¯æ ˆ |
| HTTPå®¢æˆ·ç«¯ | Axios | 1.x | é¢„é…ç½®JWTæ‹¦æˆªå™¨ |
| åç«¯æ¡†æ¶ | FastAPI | 0.104+ | ç°æœ‰æŠ€æœ¯æ ˆ |
| è°ƒåº¦å¼•æ“ | APScheduler | 3.10+ | æ–°å¢ä¾èµ– |
| æ•°æ®åº“ | MongoDB | 4.4+ | ç°æœ‰æŠ€æœ¯æ ˆ |
| æ•°æ®éªŒè¯ | Pydantic | 2.x | ç°æœ‰æŠ€æœ¯æ ˆ |

### 3.3 æ ¸å¿ƒä¾èµ–

**åç«¯æ–°å¢ä¾èµ–** (`requirements.txt`):
```
apscheduler>=3.10.0
pytz>=2023.3
```

**å‰ç«¯æ— æ–°å¢ä¾èµ–**ï¼ˆä½¿ç”¨ç°æœ‰ç»„ä»¶åº“ï¼‰

---

## æ•°æ®åº“è®¾è®¡

### 4.1 é›†åˆç»“æ„

#### 4.1.1 scheduler_jobsï¼ˆAPSchedulerç®¡ç†ï¼‰

**ç”¨é€”**: APSchedulerè‡ªåŠ¨ç®¡ç†çš„ä½œä¸šä¿¡æ¯

**å­—æ®µ**:
```javascript
{
  _id: ObjectId("..."),
  next_run_time: ISODate("2025-11-13T02:00:00Z"),  // ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´
  job_state: Binary("..."),                         // åºåˆ—åŒ–çš„Jobå¯¹è±¡
}
```

**ç´¢å¼•**:
```javascript
db.scheduler_jobs.createIndex({ "next_run_time": 1 })
```

**è¯´æ˜**: æ­¤é›†åˆç”±APSchedulerè‡ªåŠ¨åˆ›å»ºå’Œç®¡ç†ï¼Œæ— éœ€æ‰‹åŠ¨æ“ä½œ

#### 4.1.2 task_configsï¼ˆä»»åŠ¡é…ç½®ï¼‰

**ç”¨é€”**: å­˜å‚¨æ‰€æœ‰ä»»åŠ¡çš„é…ç½®ä¿¡æ¯

**å­—æ®µ**:
```javascript
{
  _id: ObjectId("..."),
  task_name: String,              // ä»»åŠ¡å”¯ä¸€æ ‡è¯† (å¦‚ "customer_status_update")
  display_name: String,           // æ˜¾ç¤ºåç§° (å¦‚ "å®¢æˆ·çŠ¶æ€è‡ªåŠ¨æ›´æ–°")
  category: String,               // ç±»åˆ« (customer/contract/data/report)
  description: String,            // ä»»åŠ¡æè¿°
  enabled: Boolean,               // æ˜¯å¦å¯ç”¨
  schedule_config: {              // è°ƒåº¦é…ç½®
    cron_expression: String,      // Cronè¡¨è¾¾å¼ (å¦‚ "0 2 * * *")
    timezone: String,             // æ—¶åŒº (å¦‚ "Asia/Shanghai")
    max_instances: Number,        // æœ€å¤§å¹¶å‘å®ä¾‹æ•°
    misfire_grace_time: Number,   // é”™è¿‡æ‰§è¡Œçš„å®¹å¿æ—¶é—´(ç§’)
    coalesce: Boolean             // æ˜¯å¦åˆå¹¶å †ç§¯çš„æ‰§è¡Œ
  },
  retry_config: {                 // é‡è¯•é…ç½®
    max_retries: Number,          // æœ€å¤§é‡è¯•æ¬¡æ•°
    retry_interval: Number        // é‡è¯•é—´éš”(ç§’)
  },
  timeout: Number,                // è¶…æ—¶æ—¶é—´(ç§’)
  priority: Number,               // ä¼˜å…ˆçº§ (1-10)
  created_at: ISODate,
  updated_at: ISODate,
  created_by: String,
  updated_by: String
}
```

**ç´¢å¼•**:
```javascript
db.task_configs.createIndex({ "task_name": 1 }, { unique: true })
db.task_configs.createIndex({ "category": 1 })
db.task_configs.createIndex({ "enabled": 1 })
```

**ç¤ºä¾‹æ•°æ®**:
```javascript
{
  "_id": ObjectId("673308f5e4b0a1b2c3d4e5f6"),
  "task_name": "customer_status_update",
  "display_name": "å®¢æˆ·çŠ¶æ€è‡ªåŠ¨æ›´æ–°",
  "category": "customer",
  "description": "æ¯æ—¥å‡Œæ™¨2:00æ‰§è¡Œï¼Œæ ¹æ®å®¢æˆ·çš„åˆåŒçŠ¶æ€è‡ªåŠ¨æ›´æ–°å®¢æˆ·æ¡£æ¡ˆçŠ¶æ€",
  "enabled": true,
  "schedule_config": {
    "cron_expression": "0 2 * * *",
    "timezone": "Asia/Shanghai",
    "max_instances": 1,
    "misfire_grace_time": 3600,
    "coalesce": true
  },
  "retry_config": {
    "max_retries": 3,
    "retry_interval": 300
  },
  "timeout": 600,
  "priority": 8,
  "created_at": ISODate("2025-11-10T10:00:00Z"),
  "updated_at": ISODate("2025-11-12T02:00:15Z"),
  "created_by": "admin",
  "updated_by": "system"
}
```

#### 4.1.3 task_execution_logsï¼ˆæ‰§è¡Œæ—¥å¿—ï¼‰

**ç”¨é€”**: è®°å½•æ¯æ¬¡ä»»åŠ¡æ‰§è¡Œçš„è¯¦ç»†ä¿¡æ¯

**å­—æ®µ**:
```javascript
{
  _id: ObjectId("..."),
  execution_id: String,           // æ‰§è¡Œå”¯ä¸€ID (æ ¼å¼: "exec_YYYYMMDDHHmmss")
  task_name: String,              // ä»»åŠ¡åç§°
  status: String,                 // çŠ¶æ€: started/completed/failed
  trigger_type: String,           // è§¦å‘æ–¹å¼: scheduled/manual
  triggered_by: String,           // è§¦å‘äºº (manualæ—¶è®°å½•ç”¨æˆ·ï¼Œscheduledæ—¶ä¸º"system")

  start_time: ISODate,            // å¼€å§‹æ—¶é—´
  end_time: ISODate,              // ç»“æŸæ—¶é—´
  execution_time: Number,         // æ‰§è¡Œæ—¶é•¿(ç§’)

  result: {                       // æ‰§è¡Œç»“æœï¼ˆä»»åŠ¡è‡ªå®šä¹‰ï¼‰
    success: Boolean,
    message: String,
    data: Object                  // ä»»åŠ¡è¿”å›çš„ä¸šåŠ¡æ•°æ®
  },

  error_info: {                   // é”™è¯¯ä¿¡æ¯ï¼ˆä»…å¤±è´¥æ—¶æœ‰å€¼ï¼‰
    error_type: String,           // é”™è¯¯ç±»å‹
    error_message: String,        // é”™è¯¯æ¶ˆæ¯
    traceback: String             // å †æ ˆè·Ÿè¸ª
  },

  log_content: String,            // ä»»åŠ¡æ‰§è¡Œçš„å®Œæ•´æ—¥å¿—ï¼ˆæ¢è¡Œåˆ†éš”ï¼‰

  performance: {                  // æ€§èƒ½æŒ‡æ ‡
    memory_usage: Number,         // å†…å­˜ä½¿ç”¨(MB)
    cpu_usage: Number,            // CPUä½¿ç”¨ç‡(%)
    records_processed: Number     // å¤„ç†è®°å½•æ•°
  },

  created_at: ISODate             // åˆ›å»ºæ—¶é—´
}
```

**ç´¢å¼•**:
```javascript
db.task_execution_logs.createIndex({ "execution_id": 1 }, { unique: true })
db.task_execution_logs.createIndex({ "task_name": 1, "created_at": -1 })
db.task_execution_logs.createIndex({ "status": 1 })
db.task_execution_logs.createIndex({ "created_at": -1 })
```

**TTLç´¢å¼•**ï¼ˆå¯é€‰ï¼Œè‡ªåŠ¨æ¸…ç†90å¤©å‰çš„æ—¥å¿—ï¼‰:
```javascript
db.task_execution_logs.createIndex(
    { "created_at": 1 },
    { expireAfterSeconds: 7776000 }  // 90å¤© = 90 * 24 * 60 * 60
)
```

**ç¤ºä¾‹æ•°æ®**:
```javascript
{
  "_id": ObjectId("673308f5e4b0a1b2c3d4e5f7"),
  "execution_id": "exec_20251112020015",
  "task_name": "customer_status_update",
  "status": "completed",
  "trigger_type": "scheduled",
  "triggered_by": "system",

  "start_time": ISODate("2025-11-12T02:00:15Z"),
  "end_time": ISODate("2025-11-12T02:00:18Z"),
  "execution_time": 2.34,

  "result": {
    "success": true,
    "message": "å®¢æˆ·çŠ¶æ€åŒæ­¥å®Œæˆ",
    "data": {
      "total_customers": 156,
      "updated_customers": 3,
      "failed_customers": 0
    }
  },

  "error_info": null,

  "log_content": "[02:00:15] ä»»åŠ¡å¼€å§‹æ‰§è¡Œ\n[02:00:15] æ‰«æå®¢æˆ·æ•°é‡: 156\n[02:00:16] æ£€æµ‹åˆ°çŠ¶æ€ä¸ä¸€è‡´: 3\n[02:00:17] å®¢æˆ·ID 123: pendingâ†’active\n[02:00:17] å®¢æˆ·ID 456: activeâ†’terminated\n[02:00:18] å®¢æˆ·ID 789: prospectâ†’pending\n[02:00:18] ä»»åŠ¡æ‰§è¡Œå®Œæˆ\n[02:00:18] æˆåŠŸæ›´æ–°: 3, å¤±è´¥: 0",

  "performance": {
    "memory_usage": 45.2,
    "cpu_usage": 12.5,
    "records_processed": 156
  },

  "created_at": ISODate("2025-11-12T02:00:15Z")
}
```

### 4.2 æ•°æ®åˆå§‹åŒ–è„šæœ¬

**æ–‡ä»¶ä½ç½®**: `scripts/init_scheduler_db.py`

```python
#!/usr/bin/env python
"""
åˆå§‹åŒ–å®šæ—¶ä»»åŠ¡ç›¸å…³çš„æ•°æ®åº“é›†åˆå’Œç´¢å¼•
"""
from webapp.tools.mongo import DATABASE
from datetime import datetime

def init_scheduler_database():
    """åˆå§‹åŒ–å®šæ—¶ä»»åŠ¡æ•°æ®åº“"""

    # 1. åˆ›å»º task_configs é›†åˆç´¢å¼•
    DATABASE.task_configs.create_index("task_name", unique=True)
    DATABASE.task_configs.create_index("category")
    DATABASE.task_configs.create_index("enabled")

    # 2. åˆ›å»º task_execution_logs é›†åˆç´¢å¼•
    DATABASE.task_execution_logs.create_index("execution_id", unique=True)
    DATABASE.task_execution_logs.create_index([("task_name", 1), ("created_at", -1)])
    DATABASE.task_execution_logs.create_index("status")
    DATABASE.task_execution_logs.create_index("created_at")

    # 3. åˆ›å»ºTTLç´¢å¼•ï¼ˆ90å¤©åè‡ªåŠ¨æ¸…ç†ï¼‰
    DATABASE.task_execution_logs.create_index(
        "created_at",
        expireAfterSeconds=7776000  # 90å¤©
    )

    print("âœ“ å®šæ—¶ä»»åŠ¡æ•°æ®åº“åˆå§‹åŒ–å®Œæˆ")

if __name__ == "__main__":
    init_scheduler_database()
```

---

## åç«¯å®ç°

### 5.1 ç›®å½•ç»“æ„

```
webapp/
â”œâ”€â”€ scheduler/                           # è°ƒåº¦æ¨¡å—ï¼ˆæ–°å¢ï¼‰
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ scheduler_service.py            # è°ƒåº¦æœåŠ¡
â”‚   â”œâ”€â”€ task_monitor_service.py         # ç›‘æ§æœåŠ¡
â”‚   â””â”€â”€ task_execution_service.py       # æ‰§è¡ŒæœåŠ¡
â”œâ”€â”€ tasks/                               # ä¸šåŠ¡ä»»åŠ¡ï¼ˆæ–°å¢ï¼‰
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ base_task.py                    # ä»»åŠ¡åŸºç±»
â”‚   â””â”€â”€ customer/
â”‚       â”œâ”€â”€ __init__.py
â”‚       â””â”€â”€ status_update_task.py       # å®¢æˆ·çŠ¶æ€æ›´æ–°ä»»åŠ¡
â”œâ”€â”€ api/
â”‚   â””â”€â”€ v1_scheduler.py                 # å®šæ—¶ä»»åŠ¡ç®¡ç†APIï¼ˆæ–°å¢ï¼‰
â””â”€â”€ main.py                              # åº”ç”¨å…¥å£ï¼ˆä¿®æ”¹ï¼‰
```

### 5.2 æ ¸å¿ƒæœåŠ¡å®ç°

#### 5.2.1 è°ƒåº¦æœåŠ¡ (scheduler_service.py)

```python
"""
å®šæ—¶ä»»åŠ¡è°ƒåº¦æœåŠ¡
"""
from apscheduler.schedulers.background import BackgroundScheduler
from apscheduler.jobstores.mongodb import MongoDBJobStore
from apscheduler.executors.pool import ThreadPoolExecutor
from apscheduler.triggers.cron import CronTrigger
import logging
from typing import Dict, List, Optional
from datetime import datetime

logger = logging.getLogger("scheduler")


class SchedulerService:
    """å®šæ—¶ä»»åŠ¡è°ƒåº¦æœåŠ¡"""

    def __init__(self, db):
        self.db = db
        self.scheduler = None
        self._init_scheduler()

    def _init_scheduler(self):
        """åˆå§‹åŒ–è°ƒåº¦å™¨"""
        # é…ç½®ä½œä¸šå­˜å‚¨
        jobstores = {
            'default': MongoDBJobStore(
                database=self.db.name,
                collection='scheduler_jobs',
                client=self.db.client
            )
        }

        # é…ç½®æ‰§è¡Œå™¨
        executors = {
            'default': ThreadPoolExecutor(max_workers=5)
        }

        # ä½œä¸šé»˜è®¤é…ç½®
        job_defaults = {
            'coalesce': True,           # åˆå¹¶å †ç§¯çš„ä»»åŠ¡
            'max_instances': 1,         # åŒä¸€ä»»åŠ¡åŒæ—¶åªè¿è¡Œä¸€ä¸ªå®ä¾‹
            'misfire_grace_time': 3600  # é”™è¿‡æ‰§è¡Œæ—¶é—´1å°æ—¶å†…ä»å¯æ‰§è¡Œ
        }

        self.scheduler = BackgroundScheduler(
            jobstores=jobstores,
            executors=executors,
            job_defaults=job_defaults,
            timezone='Asia/Shanghai'
        )

    def start(self):
        """å¯åŠ¨è°ƒåº¦å™¨"""
        if not self.scheduler.running:
            self.scheduler.start()
            logger.info("å®šæ—¶ä»»åŠ¡è°ƒåº¦å™¨å·²å¯åŠ¨")

    def shutdown(self, wait=True):
        """å…³é—­è°ƒåº¦å™¨"""
        if self.scheduler.running:
            self.scheduler.shutdown(wait=wait)
            logger.info("å®šæ—¶ä»»åŠ¡è°ƒåº¦å™¨å·²å…³é—­")

    def register_task(self, task_instance, task_config: Dict):
        """
        æ³¨å†Œä»»åŠ¡åˆ°è°ƒåº¦å™¨

        Args:
            task_instance: ä»»åŠ¡å®ä¾‹ï¼ˆBaseTaskå­ç±»ï¼‰
            task_config: ä»»åŠ¡é…ç½®ï¼ˆä»task_configsé›†åˆè¯»å–ï¼‰
        """
        job_id = task_config["task_name"]
        cron_expr = task_config["schedule_config"]["cron_expression"]

        # è§£æCronè¡¨è¾¾å¼
        cron_parts = cron_expr.split()
        trigger = CronTrigger(
            minute=cron_parts[0],
            hour=cron_parts[1],
            day=cron_parts[2],
            month=cron_parts[3],
            day_of_week=cron_parts[4],
            timezone='Asia/Shanghai'
        )

        # æ·»åŠ ä»»åŠ¡
        self.scheduler.add_job(
            func=task_instance.run,
            trigger=trigger,
            id=job_id,
            replace_existing=True,
            max_instances=task_config["schedule_config"].get("max_instances", 1),
            misfire_grace_time=task_config["schedule_config"].get("misfire_grace_time", 3600)
        )

        logger.info(f"å·²æ³¨å†Œå®šæ—¶ä»»åŠ¡: {job_id}, Cron: {cron_expr}")

    def execute_task_now(self, task_name: str) -> str:
        """
        ç«‹å³æ‰§è¡Œä»»åŠ¡ï¼ˆæ‰‹åŠ¨è§¦å‘ï¼‰

        Args:
            task_name: ä»»åŠ¡åç§°

        Returns:
            execution_id: æ‰§è¡ŒID
        """
        job = self.scheduler.get_job(task_name)
        if not job:
            raise ValueError(f"ä»»åŠ¡ä¸å­˜åœ¨: {task_name}")

        # æ£€æŸ¥ä»»åŠ¡æ˜¯å¦æ­£åœ¨è¿è¡Œ
        running_logs = self.db.task_execution_logs.find_one({
            "task_name": task_name,
            "status": "started"
        })
        if running_logs:
            raise ValueError(f"ä»»åŠ¡æ­£åœ¨æ‰§è¡Œä¸­ï¼Œè¯·ç¨åå†è¯•")

        # æ‰‹åŠ¨è§¦å‘ä»»åŠ¡
        job.func()

        # è·å–åˆšåˆšåˆ›å»ºçš„æ‰§è¡Œè®°å½•
        latest_log = self.db.task_execution_logs.find_one(
            {"task_name": task_name},
            sort=[("created_at", -1)]
        )

        return latest_log["execution_id"] if latest_log else None

    def toggle_task(self, task_name: str, enabled: bool):
        """
        å¯ç”¨/ç¦ç”¨ä»»åŠ¡

        Args:
            task_name: ä»»åŠ¡åç§°
            enabled: True=å¯ç”¨, False=ç¦ç”¨
        """
        job = self.scheduler.get_job(task_name)
        if not job:
            raise ValueError(f"ä»»åŠ¡ä¸å­˜åœ¨: {task_name}")

        if enabled:
            self.scheduler.resume_job(task_name)
            logger.info(f"å·²å¯ç”¨ä»»åŠ¡: {task_name}")
        else:
            self.scheduler.pause_job(task_name)
            logger.info(f"å·²ç¦ç”¨ä»»åŠ¡: {task_name}")

        # æ›´æ–°æ•°æ®åº“é…ç½®
        self.db.task_configs.update_one(
            {"task_name": task_name},
            {"$set": {
                "enabled": enabled,
                "updated_at": datetime.utcnow()
            }}
        )

    def get_next_run_time(self, task_name: str) -> Optional[datetime]:
        """è·å–ä»»åŠ¡ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´"""
        job = self.scheduler.get_job(task_name)
        return job.next_run_time if job else None

    def get_all_jobs(self) -> List[Dict]:
        """è·å–æ‰€æœ‰ä»»åŠ¡çš„è°ƒåº¦ä¿¡æ¯"""
        jobs = []
        for job in self.scheduler.get_jobs():
            jobs.append({
                "task_name": job.id,
                "next_run_time": job.next_run_time,
                "pending": job.pending
            })
        return jobs
```

#### 5.2.2 ç›‘æ§æœåŠ¡ (task_monitor_service.py)

```python
"""
ä»»åŠ¡ç›‘æ§æœåŠ¡
"""
from typing import Dict, List
from datetime import datetime, timedelta
from bson import ObjectId


class TaskMonitorService:
    """ä»»åŠ¡ç›‘æ§æœåŠ¡"""

    def __init__(self, db):
        self.db = db

    def get_statistics(self) -> Dict:
        """
        è·å–ç»Ÿè®¡æ•°æ®

        Returns:
            {
                "total_tasks": 12,
                "running_tasks": 3,
                "success_rate": 98.5,
                "failed_count": 2
            }
        """
        # æ€»ä»»åŠ¡æ•°
        total_tasks = self.db.task_configs.count_documents({})

        # è¿è¡Œä¸­ä»»åŠ¡æ•°
        running_tasks = self.db.task_execution_logs.count_documents({
            "status": "started",
            "end_time": None
        })

        # æœ€è¿‘24å°æ—¶çš„æˆåŠŸç‡å’Œå¤±è´¥æ•°
        yesterday = datetime.utcnow() - timedelta(hours=24)
        total_executions = self.db.task_execution_logs.count_documents({
            "created_at": {"$gte": yesterday}
        })
        successful_executions = self.db.task_execution_logs.count_documents({
            "created_at": {"$gte": yesterday},
            "status": "completed"
        })
        failed_count = self.db.task_execution_logs.count_documents({
            "created_at": {"$gte": yesterday},
            "status": "failed"
        })

        success_rate = (successful_executions / total_executions * 100) if total_executions > 0 else 0

        return {
            "total_tasks": total_tasks,
            "running_tasks": running_tasks,
            "success_rate": round(success_rate, 1),
            "failed_count": failed_count
        }

    def get_execution_trend(self, days: int = 7) -> List[Dict]:
        """
        è·å–æ‰§è¡Œè¶‹åŠ¿æ•°æ®ï¼ˆæœ€è¿‘Nå¤©ï¼‰

        Args:
            days: å¤©æ•°

        Returns:
            [
                {
                    "date": "2025-11-12",
                    "total_count": 24,
                    "success_count": 23,
                    "failed_count": 1,
                    "avg_duration": 2.34
                },
                ...
            ]
        """
        start_date = datetime.utcnow() - timedelta(days=days)

        pipeline = [
            {
                "$match": {
                    "created_at": {"$gte": start_date}
                }
            },
            {
                "$group": {
                    "_id": {
                        "$dateToString": {
                            "format": "%Y-%m-%d",
                            "date": "$created_at",
                            "timezone": "Asia/Shanghai"
                        }
                    },
                    "total_count": {"$sum": 1},
                    "success_count": {
                        "$sum": {
                            "$cond": [{"$eq": ["$status", "completed"]}, 1, 0]
                        }
                    },
                    "failed_count": {
                        "$sum": {
                            "$cond": [{"$eq": ["$status", "failed"]}, 1, 0]
                        }
                    },
                    "avg_duration": {"$avg": "$execution_time"}
                }
            },
            {"$sort": {"_id": 1}}
        ]

        results = list(self.db.task_execution_logs.aggregate(pipeline))

        return [
            {
                "date": r["_id"],
                "total_count": r["total_count"],
                "success_count": r["success_count"],
                "failed_count": r["failed_count"],
                "avg_duration": round(r.get("avg_duration", 0), 2)
            }
            for r in results
        ]

    def get_task_history(self, task_name: str, limit: int = 50) -> List[Dict]:
        """
        è·å–ä»»åŠ¡æ‰§è¡Œå†å²

        Args:
            task_name: ä»»åŠ¡åç§°
            limit: è¿”å›è®°å½•æ•°

        Returns:
            æ‰§è¡Œå†å²åˆ—è¡¨
        """
        logs = self.db.task_execution_logs.find(
            {"task_name": task_name},
            sort=[("created_at", -1)],
            limit=limit
        )

        return [self._format_execution_log(log) for log in logs]

    def get_execution_log(self, execution_id: str) -> Dict:
        """
        è·å–å•æ¬¡æ‰§è¡Œçš„è¯¦ç»†æ—¥å¿—

        Args:
            execution_id: æ‰§è¡ŒID

        Returns:
            æ‰§è¡Œæ—¥å¿—è¯¦æƒ…
        """
        log = self.db.task_execution_logs.find_one({"execution_id": execution_id})
        if not log:
            raise ValueError(f"æ‰§è¡Œè®°å½•ä¸å­˜åœ¨: {execution_id}")

        return self._format_execution_log(log, include_log_content=True)

    def _format_execution_log(self, log: Dict, include_log_content: bool = False) -> Dict:
        """æ ¼å¼åŒ–æ‰§è¡Œæ—¥å¿—"""
        formatted = {
            "id": str(log["_id"]),
            "execution_id": log["execution_id"],
            "task_name": log["task_name"],
            "status": log["status"],
            "trigger_type": log.get("trigger_type", "scheduled"),
            "triggered_by": log.get("triggered_by", "system"),
            "start_time": log["start_time"].isoformat() if log.get("start_time") else None,
            "end_time": log["end_time"].isoformat() if log.get("end_time") else None,
            "execution_time": log.get("execution_time"),
            "result": log.get("result"),
            "error_info": log.get("error_info"),
            "performance": log.get("performance")
        }

        if include_log_content:
            formatted["log_content"] = log.get("log_content", "")

        return formatted
```

### 5.3 APIæ¥å£å®ç°

**æ–‡ä»¶ä½ç½®**: `webapp/api/v1_scheduler.py`

```python
"""
å®šæ—¶ä»»åŠ¡ç®¡ç†API
"""
from fastapi import APIRouter, Depends, HTTPException, Query
from typing import Optional, List
from webapp.tools.security import get_current_active_user
from webapp.tools.mongo import DATABASE
from webapp.scheduler.scheduler_service import SchedulerService
from webapp.scheduler.task_monitor_service import TaskMonitorService
from pydantic import BaseModel

router = APIRouter(prefix="/api/v1/scheduler", tags=["Scheduler"])

# å…¨å±€æœåŠ¡å®ä¾‹ï¼ˆåœ¨main.pyä¸­åˆå§‹åŒ–ï¼‰
scheduler_service: Optional[SchedulerService] = None
monitor_service = TaskMonitorService(DATABASE)


# ============ Pydantic Models ============

class TaskToggleRequest(BaseModel):
    """ä»»åŠ¡å¯ç”¨/ç¦ç”¨è¯·æ±‚"""
    enabled: bool


# ============ API Endpoints ============

@router.get("/statistics")
async def get_statistics(current_user=Depends(get_current_active_user)):
    """
    è·å–ç»Ÿè®¡æ•°æ®

    Returns:
        {
            "total_tasks": 12,
            "running_tasks": 3,
            "success_rate": 98.5,
            "failed_count": 2
        }
    """
    return monitor_service.get_statistics()


@router.get("/trend")
async def get_execution_trend(
    days: int = Query(7, ge=1, le=30),
    current_user=Depends(get_current_active_user)
):
    """
    è·å–æ‰§è¡Œè¶‹åŠ¿æ•°æ®

    Args:
        days: å¤©æ•°ï¼ˆ1-30ï¼‰

    Returns:
        [
            {
                "date": "2025-11-12",
                "total_count": 24,
                "success_count": 23,
                "failed_count": 1,
                "avg_duration": 2.34
            },
            ...
        ]
    """
    return monitor_service.get_execution_trend(days)


@router.get("/tasks")
async def list_tasks(
    category: Optional[str] = Query(None),
    enabled: Optional[bool] = Query(None),
    current_user=Depends(get_current_active_user)
):
    """
    è·å–ä»»åŠ¡åˆ—è¡¨

    Args:
        category: ä»»åŠ¡ç±»åˆ«ç­›é€‰ï¼ˆcustomer/contract/data/reportï¼‰
        enabled: å¯ç”¨çŠ¶æ€ç­›é€‰ï¼ˆtrue/falseï¼‰

    Returns:
        [
            {
                "task_name": "customer_status_update",
                "display_name": "å®¢æˆ·çŠ¶æ€è‡ªåŠ¨æ›´æ–°",
                "category": "customer",
                "enabled": true,
                "next_run_time": "2025-11-13T02:00:00",
                "last_execution": {...}
            },
            ...
        ]
    """
    # æ„å»ºæŸ¥è¯¢æ¡ä»¶
    query = {}
    if category:
        query["category"] = category
    if enabled is not None:
        query["enabled"] = enabled

    # æŸ¥è¯¢ä»»åŠ¡é…ç½®
    tasks = list(DATABASE.task_configs.find(query).sort("created_at", 1))

    # è·å–è°ƒåº¦ä¿¡æ¯
    jobs_info = {job["task_name"]: job for job in scheduler_service.get_all_jobs()}

    # ç»„è£…è¿”å›æ•°æ®
    result = []
    for task in tasks:
        task_name = task["task_name"]

        # è·å–æœ€åä¸€æ¬¡æ‰§è¡Œè®°å½•
        last_execution = DATABASE.task_execution_logs.find_one(
            {"task_name": task_name},
            sort=[("created_at", -1)]
        )

        # è·å–æœ€è¿‘10æ¬¡æ‰§è¡Œçš„å¹³å‡æ—¶é•¿
        recent_logs = list(DATABASE.task_execution_logs.find(
            {"task_name": task_name, "execution_time": {"$exists": True}},
            sort=[("created_at", -1)],
            limit=10
        ))
        avg_duration = sum(log["execution_time"] for log in recent_logs) / len(recent_logs) if recent_logs else 0

        result.append({
            "id": str(task["_id"]),
            "task_name": task_name,
            "display_name": task["display_name"],
            "category": task["category"],
            "description": task.get("description", ""),
            "enabled": task["enabled"],
            "next_run_time": jobs_info.get(task_name, {}).get("next_run_time"),
            "avg_duration": round(avg_duration, 2),
            "last_execution": {
                "execution_id": last_execution["execution_id"],
                "status": last_execution["status"],
                "start_time": last_execution["start_time"].isoformat(),
                "execution_time": last_execution.get("execution_time")
            } if last_execution else None
        })

    return result


@router.get("/tasks/{task_name}")
async def get_task_detail(
    task_name: str,
    current_user=Depends(get_current_active_user)
):
    """
    è·å–ä»»åŠ¡è¯¦æƒ…

    Args:
        task_name: ä»»åŠ¡åç§°

    Returns:
        {
            "task_name": "customer_status_update",
            "display_name": "å®¢æˆ·çŠ¶æ€è‡ªåŠ¨æ›´æ–°",
            "category": "customer",
            "description": "...",
            "enabled": true,
            "schedule_config": {...},
            "retry_config": {...},
            "created_at": "2025-11-10T10:00:00",
            "updated_at": "2025-11-12T02:00:15",
            "next_run_time": "2025-11-13T02:00:00"
        }
    """
    task = DATABASE.task_configs.find_one({"task_name": task_name})
    if not task:
        raise HTTPException(status_code=404, detail=f"ä»»åŠ¡ä¸å­˜åœ¨: {task_name}")

    # è·å–ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´
    next_run_time = scheduler_service.get_next_run_time(task_name)

    return {
        "id": str(task["_id"]),
        "task_name": task["task_name"],
        "display_name": task["display_name"],
        "category": task["category"],
        "description": task.get("description", ""),
        "enabled": task["enabled"],
        "schedule_config": task["schedule_config"],
        "retry_config": task.get("retry_config", {}),
        "timeout": task.get("timeout"),
        "priority": task.get("priority"),
        "created_at": task["created_at"].isoformat(),
        "updated_at": task["updated_at"].isoformat(),
        "next_run_time": next_run_time.isoformat() if next_run_time else None
    }


@router.post("/tasks/{task_name}/execute")
async def execute_task(
    task_name: str,
    current_user=Depends(get_current_active_user)
):
    """
    æ‰‹åŠ¨æ‰§è¡Œä»»åŠ¡

    Args:
        task_name: ä»»åŠ¡åç§°

    Returns:
        {
            "success": true,
            "message": "ä»»åŠ¡å·²åŠ å…¥æ‰§è¡Œé˜Ÿåˆ—",
            "execution_id": "exec_20251112120000"
        }
    """
    try:
        execution_id = scheduler_service.execute_task_now(task_name)
        return {
            "success": True,
            "message": "ä»»åŠ¡å·²åŠ å…¥æ‰§è¡Œé˜Ÿåˆ—",
            "execution_id": execution_id
        }
    except ValueError as e:
        raise HTTPException(status_code=400, detail=str(e))


@router.post("/tasks/{task_name}/toggle")
async def toggle_task(
    task_name: str,
    request: TaskToggleRequest,
    current_user=Depends(get_current_active_user)
):
    """
    å¯ç”¨/ç¦ç”¨ä»»åŠ¡

    Args:
        task_name: ä»»åŠ¡åç§°
        request: {"enabled": true}

    Returns:
        {
            "success": true,
            "message": "ä»»åŠ¡å·²å¯ç”¨"
        }
    """
    try:
        scheduler_service.toggle_task(task_name, request.enabled)
        message = "ä»»åŠ¡å·²å¯ç”¨" if request.enabled else "ä»»åŠ¡å·²ç¦ç”¨"
        return {
            "success": True,
            "message": message
        }
    except ValueError as e:
        raise HTTPException(status_code=400, detail=str(e))


@router.get("/tasks/{task_name}/history")
async def get_task_history(
    task_name: str,
    limit: int = Query(50, ge=1, le=200),
    current_user=Depends(get_current_active_user)
):
    """
    è·å–ä»»åŠ¡æ‰§è¡Œå†å²

    Args:
        task_name: ä»»åŠ¡åç§°
        limit: è¿”å›è®°å½•æ•°ï¼ˆ1-200ï¼‰

    Returns:
        [
            {
                "execution_id": "exec_20251112020015",
                "status": "completed",
                "start_time": "2025-11-12T02:00:15",
                "execution_time": 2.34,
                "result": {...}
            },
            ...
        ]
    """
    return monitor_service.get_task_history(task_name, limit)


@router.get("/execution-logs/{execution_id}")
async def get_execution_log(
    execution_id: str,
    current_user=Depends(get_current_active_user)
):
    """
    è·å–æ‰§è¡Œæ—¥å¿—è¯¦æƒ…

    Args:
        execution_id: æ‰§è¡ŒID

    Returns:
        {
            "execution_id": "exec_20251112020015",
            "task_name": "customer_status_update",
            "status": "completed",
            "start_time": "2025-11-12T02:00:15",
            "end_time": "2025-11-12T02:00:18",
            "execution_time": 2.34,
            "result": {...},
            "log_content": "...",
            "performance": {...}
        }
    """
    try:
        return monitor_service.get_execution_log(execution_id)
    except ValueError as e:
        raise HTTPException(status_code=404, detail=str(e))
```

### 5.4 é›†æˆåˆ°ä¸»åº”ç”¨

**æ–‡ä»¶ä½ç½®**: `webapp/main.py`

**ä¿®æ”¹å†…å®¹**:

```python
# åœ¨æ–‡ä»¶é¡¶éƒ¨æ·»åŠ å¯¼å…¥
from webapp.scheduler.scheduler_service import SchedulerService
from webapp.api import v1_scheduler

# å…¨å±€è°ƒåº¦å™¨å®ä¾‹
scheduler_service: Optional[SchedulerService] = None

@app.on_event("startup")
async def startup_event():
    """åº”ç”¨å¯åŠ¨æ—¶æ‰§è¡Œ"""
    global scheduler_service

    # åˆå§‹åŒ–è°ƒåº¦å™¨
    scheduler_service = SchedulerService(DATABASE)

    # æ³¨å†Œæ‰€æœ‰ä»»åŠ¡ï¼ˆä»task_configsè¯»å–ï¼‰
    task_configs = DATABASE.task_configs.find({"enabled": True})
    for config in task_configs:
        # åŠ¨æ€å¯¼å…¥ä»»åŠ¡ç±»
        task_class = import_task_class(config["task_name"])
        task_instance = task_class(DATABASE)
        scheduler_service.register_task(task_instance, config)

    # å¯åŠ¨è°ƒåº¦å™¨
    scheduler_service.start()

    # å°†è°ƒåº¦å™¨å®ä¾‹æ³¨å…¥åˆ°APIæ¨¡å—
    v1_scheduler.scheduler_service = scheduler_service

    logger.info("åº”ç”¨å¯åŠ¨å®Œæˆï¼Œå®šæ—¶ä»»åŠ¡è°ƒåº¦å™¨å·²å¯åŠ¨")

@app.on_event("shutdown")
async def shutdown_event():
    """åº”ç”¨å…³é—­æ—¶æ‰§è¡Œ"""
    if scheduler_service:
        scheduler_service.shutdown()
    logger.info("åº”ç”¨å·²å…³é—­ï¼Œå®šæ—¶ä»»åŠ¡è°ƒåº¦å™¨å·²åœæ­¢")

# æ³¨å†Œè·¯ç”±
app.include_router(v1_scheduler.router, dependencies=[Depends(get_current_active_user)])
```

---

## å‰ç«¯å®ç°

### 6.1 é¡µé¢ç»„ä»¶

**æ–‡ä»¶ä½ç½®**: `frontend/src/pages/SchedulerMonitorPage.tsx`

```typescript
import React, { useState, useEffect, useRef } from 'react';
import {
    Box,
    Grid,
    Paper,
    Typography,
    Table,
    TableBody,
    TableCell,
    TableContainer,
    TableHead,
    TableRow,
    IconButton,
    Chip,
    TextField,
    MenuItem,
    Button,
    Skeleton,
    Alert
} from '@mui/material';
import {
    Task as TaskIcon,
    PlayArrow as PlayArrowIcon,
    CheckCircle as CheckCircleIcon,
    Error as ErrorIcon,
    Refresh as RefreshIcon,
    Info as InfoIcon,
    Article as ArticleIcon,
    PlayCircle as ExecuteIcon,
    ToggleOff as ToggleOffIcon,
    ToggleOn as ToggleOnIcon
} from '@mui/icons-material';
import { ResponsiveContainer, LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend } from 'recharts';
import apiClient from '../api/client';
import { useChartFullscreen } from '../hooks/useChartFullscreen';

// ============ æ¥å£å®šä¹‰ ============

interface Statistics {
    total_tasks: number;
    running_tasks: number;
    success_rate: number;
    failed_count: number;
}

interface TrendDataPoint {
    date: string;
    total_count: number;
    success_count: number;
    failed_count: number;
    avg_duration: number;
}

interface Task {
    id: string;
    task_name: string;
    display_name: string;
    category: string;
    description: string;
    enabled: boolean;
    next_run_time: string | null;
    avg_duration: number;
    last_execution: {
        execution_id: string;
        status: string;
        start_time: string;
        execution_time: number;
    } | null;
}

// ============ ç»Ÿè®¡å¡ç‰‡ç»„ä»¶ ============

interface StatCardProps {
    title: string;
    value: string | number;
    icon: React.ReactNode;
    color?: string;
    loading?: boolean;
}

const StatCard: React.FC<StatCardProps> = ({ title, value, icon, color, loading }) => {
    return (
        <Paper
            variant="outlined"
            sx={{
                p: 2,
                display: 'flex',
                alignItems: 'center',
                gap: 2
            }}
        >
            <Box
                sx={{
                    width: 48,
                    height: 48,
                    borderRadius: 2,
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    backgroundColor: color ? `${color}.lighter` : 'grey.100',
                    color: color || 'grey.700'
                }}
            >
                {icon}
            </Box>
            <Box sx={{ flex: 1 }}>
                <Typography variant="body2" color="text.secondary">
                    {title}
                </Typography>
                <Typography variant="h5" fontWeight="bold">
                    {loading ? <Skeleton width={60} /> : value}
                </Typography>
            </Box>
        </Paper>
    );
};

// ============ ä¸»é¡µé¢ç»„ä»¶ ============

export const SchedulerMonitorPage: React.FC = () => {
    // çŠ¶æ€ç®¡ç†
    const [loading, setLoading] = useState(false);
    const [error, setError] = useState<string | null>(null);
    const [statistics, setStatistics] = useState<Statistics | null>(null);
    const [trendData, setTrendData] = useState<TrendDataPoint[]>([]);
    const [tasks, setTasks] = useState<Task[]>([]);
    const [categoryFilter, setCategoryFilter] = useState<string>('all');
    const [searchKeyword, setSearchKeyword] = useState<string>('');

    const chartRef = useRef<HTMLDivElement>(null);

    // å›¾è¡¨å…¨å±Hook
    const { isFullscreen, FullscreenEnterButton, FullscreenExitButton, FullscreenTitle } = useChartFullscreen({
        chartRef,
        title: 'ä»»åŠ¡æ‰§è¡Œè¶‹åŠ¿ï¼ˆæœ€è¿‘7å¤©ï¼‰'
    });

    // åŠ è½½æ•°æ®
    const fetchData = async () => {
        setLoading(true);
        setError(null);
        try {
            const [statsRes, trendRes, tasksRes] = await Promise.all([
                apiClient.get('/api/v1/scheduler/statistics'),
                apiClient.get('/api/v1/scheduler/trend?days=7'),
                apiClient.get('/api/v1/scheduler/tasks')
            ]);

            setStatistics(statsRes.data);
            setTrendData(trendRes.data);
            setTasks(tasksRes.data);
        } catch (err: any) {
            console.error('åŠ è½½æ•°æ®å¤±è´¥:', err);
            setError(err.response?.data?.detail || err.message || 'åŠ è½½æ•°æ®å¤±è´¥');
        } finally {
            setLoading(false);
        }
    };

    // åˆå§‹åŠ è½½
    useEffect(() => {
        fetchData();
    }, []);

    // æ‰‹åŠ¨æ‰§è¡Œä»»åŠ¡
    const handleExecuteTask = async (taskName: string) => {
        if (!confirm('ç¡®å®šè¦ç«‹å³æ‰§è¡Œæ­¤ä»»åŠ¡å—ï¼Ÿ')) return;

        try {
            await apiClient.post(`/api/v1/scheduler/tasks/${taskName}/execute`);
            alert('ä»»åŠ¡å·²åŠ å…¥æ‰§è¡Œé˜Ÿåˆ—');
            fetchData(); // åˆ·æ–°æ•°æ®
        } catch (err: any) {
            alert(err.response?.data?.detail || 'æ‰§è¡Œä»»åŠ¡å¤±è´¥');
        }
    };

    // å¯ç”¨/ç¦ç”¨ä»»åŠ¡
    const handleToggleTask = async (taskName: string, enabled: boolean) => {
        try {
            await apiClient.post(`/api/v1/scheduler/tasks/${taskName}/toggle`, { enabled: !enabled });
            fetchData(); // åˆ·æ–°æ•°æ®
        } catch (err: any) {
            alert(err.response?.data?.detail || 'æ“ä½œå¤±è´¥');
        }
    };

    // ç­›é€‰ä»»åŠ¡
    const filteredTasks = tasks.filter(task => {
        const matchCategory = categoryFilter === 'all' || task.category === categoryFilter;
        const matchKeyword = task.display_name.toLowerCase().includes(searchKeyword.toLowerCase());
        return matchCategory && matchKeyword;
    });

    // æ ¼å¼åŒ–ç›¸å¯¹æ—¶é—´
    const formatRelativeTime = (isoString: string | null) => {
        if (!isoString) return '-';
        const diff = new Date(isoString).getTime() - new Date().getTime();
        const hours = Math.floor(diff / 3600000);
        const minutes = Math.floor((diff % 3600000) / 60000);
        if (hours > 0) return `${hours}å°æ—¶å`;
        if (minutes > 0) return `${minutes}åˆ†é’Ÿå`;
        return 'å³å°†æ‰§è¡Œ';
    };

    return (
        <Box sx={{ p: { xs: 1, sm: 3 } }}>
            {/* é¡µé¢æ ‡é¢˜ */}
            <Typography variant="h4" gutterBottom>
                å®šæ—¶ä»»åŠ¡ç›‘æ§
            </Typography>

            {/* é”™è¯¯æç¤º */}
            {error && (
                <Alert severity="error" sx={{ mb: 2 }}>
                    {error}
                </Alert>
            )}

            {/* ç»Ÿè®¡å¡ç‰‡ */}
            <Grid container spacing={{ xs: 1, sm: 2 }}>
                <Grid size={{ xs: 6, sm: 6, md: 3 }}>
                    <StatCard
                        title="æ€»ä»»åŠ¡æ•°"
                        value={statistics?.total_tasks || 0}
                        icon={<TaskIcon />}
                        loading={loading && !statistics}
                    />
                </Grid>
                <Grid size={{ xs: 6, sm: 6, md: 3 }}>
                    <StatCard
                        title="è¿è¡Œä¸­"
                        value={statistics?.running_tasks || 0}
                        icon={<PlayArrowIcon />}
                        color="success.main"
                        loading={loading && !statistics}
                    />
                </Grid>
                <Grid size={{ xs: 6, sm: 6, md: 3 }}>
                    <StatCard
                        title="æˆåŠŸç‡"
                        value={`${statistics?.success_rate || 0}%`}
                        icon={<CheckCircleIcon />}
                        color="info.main"
                        loading={loading && !statistics}
                    />
                </Grid>
                <Grid size={{ xs: 6, sm: 6, md: 3 }}>
                    <StatCard
                        title="å¤±è´¥æ•°"
                        value={statistics?.failed_count || 0}
                        icon={<ErrorIcon />}
                        color="error.main"
                        loading={loading && !statistics}
                    />
                </Grid>
            </Grid>

            {/* è¶‹åŠ¿å›¾è¡¨ */}
            <Paper variant="outlined" sx={{ p: { xs: 1, sm: 2 }, mt: 2 }}>
                <Typography variant="h6" gutterBottom>
                    ä»»åŠ¡æ‰§è¡Œè¶‹åŠ¿ï¼ˆæœ€è¿‘7å¤©ï¼‰
                </Typography>
                <Box
                    ref={chartRef}
                    sx={{
                        height: { xs: 350, sm: 400 },
                        position: 'relative',
                        backgroundColor: isFullscreen ? 'background.paper' : 'transparent',
                        p: isFullscreen ? 2 : 0,
                        ...(isFullscreen && {
                            position: 'fixed',
                            top: 0,
                            left: 0,
                            width: '100vw',
                            height: '100vh',
                            zIndex: 1400
                        })
                    }}
                >
                    <FullscreenEnterButton />
                    <FullscreenExitButton />
                    <FullscreenTitle />

                    {!trendData || trendData.length === 0 ? (
                        <Box sx={{ display: 'flex', height: '100%', alignItems: 'center', justifyContent: 'center' }}>
                            <Typography>æ— æ•°æ®</Typography>
                        </Box>
                    ) : (
                        <ResponsiveContainer width="100%" height="100%">
                            <LineChart data={trendData}>
                                <CartesianGrid strokeDasharray="3 3" />
                                <XAxis dataKey="date" />
                                <YAxis />
                                <Tooltip />
                                <Legend />
                                <Line
                                    type="monotone"
                                    dataKey="success_count"
                                    stroke="#4caf50"
                                    strokeWidth={2}
                                    name="æˆåŠŸ"
                                />
                                <Line
                                    type="monotone"
                                    dataKey="failed_count"
                                    stroke="#f44336"
                                    strokeWidth={2}
                                    name="å¤±è´¥"
                                />
                            </LineChart>
                        </ResponsiveContainer>
                    )}
                </Box>
            </Paper>

            {/* ä»»åŠ¡åˆ—è¡¨ */}
            <Paper variant="outlined" sx={{ p: { xs: 1, sm: 2 }, mt: 2 }}>
                <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', mb: 2, flexWrap: 'wrap', gap: 1 }}>
                    <Typography variant="h6">ä»»åŠ¡åˆ—è¡¨</Typography>
                    <Box sx={{ display: 'flex', gap: 1, flexWrap: 'wrap' }}>
                        <TextField
                            size="small"
                            placeholder="æœç´¢ä»»åŠ¡..."
                            value={searchKeyword}
                            onChange={(e) => setSearchKeyword(e.target.value)}
                            sx={{ width: { xs: '100%', sm: 200 } }}
                        />
                        <TextField
                            select
                            size="small"
                            value={categoryFilter}
                            onChange={(e) => setCategoryFilter(e.target.value)}
                            sx={{ width: { xs: '100%', sm: 120 } }}
                        >
                            <MenuItem value="all">å…¨éƒ¨ç±»åˆ«</MenuItem>
                            <MenuItem value="customer">å®¢æˆ·</MenuItem>
                            <MenuItem value="contract">åˆåŒ</MenuItem>
                            <MenuItem value="data">æ•°æ®</MenuItem>
                            <MenuItem value="report">æŠ¥è¡¨</MenuItem>
                        </TextField>
                        <IconButton onClick={fetchData} disabled={loading}>
                            <RefreshIcon />
                        </IconButton>
                    </Box>
                </Box>

                <TableContainer>
                    <Table
                        sx={{
                            '& .MuiTableCell-root': {
                                fontSize: { xs: '0.75rem', sm: '0.875rem' },
                                px: { xs: 0.5, sm: 2 }
                            }
                        }}
                    >
                        <TableHead>
                            <TableRow>
                                <TableCell>#</TableCell>
                                <TableCell>ä»»åŠ¡åç§°</TableCell>
                                <TableCell>ç±»åˆ«</TableCell>
                                <TableCell>çŠ¶æ€</TableCell>
                                <TableCell>ä¸‹æ¬¡æ‰§è¡Œ</TableCell>
                                <TableCell>å¹³å‡æ—¶é•¿</TableCell>
                                <TableCell align="right">æ“ä½œ</TableCell>
                            </TableRow>
                        </TableHead>
                        <TableBody>
                            {filteredTasks.map((task, index) => (
                                <TableRow key={task.id}>
                                    <TableCell>{index + 1}</TableCell>
                                    <TableCell>{task.display_name}</TableCell>
                                    <TableCell>
                                        <Chip label={task.category} size="small" />
                                    </TableCell>
                                    <TableCell>
                                        <Chip
                                            label={task.enabled ? 'å¯ç”¨' : 'ç¦ç”¨'}
                                            color={task.enabled ? 'success' : 'default'}
                                            size="small"
                                        />
                                    </TableCell>
                                    <TableCell>{formatRelativeTime(task.next_run_time)}</TableCell>
                                    <TableCell>{task.avg_duration.toFixed(2)}s</TableCell>
                                    <TableCell align="right">
                                        <IconButton
                                            size="small"
                                            title="æ‰‹åŠ¨æ‰§è¡Œ"
                                            onClick={() => handleExecuteTask(task.task_name)}
                                        >
                                            <ExecuteIcon />
                                        </IconButton>
                                        <IconButton
                                            size="small"
                                            title={task.enabled ? 'ç¦ç”¨' : 'å¯ç”¨'}
                                            onClick={() => handleToggleTask(task.task_name, task.enabled)}
                                        >
                                            {task.enabled ? <ToggleOnIcon /> : <ToggleOffIcon />}
                                        </IconButton>
                                    </TableCell>
                                </TableRow>
                            ))}
                        </TableBody>
                    </Table>
                </TableContainer>
            </Paper>
        </Box>
    );
};
```

### 6.2 æ›´æ–°è·¯ç”±é…ç½®

**æ–‡ä»¶1**: `frontend/src/config/routes.tsx`

```typescript
// ä¿®æ”¹ç³»ç»Ÿç®¡ç†è·¯ç”±
import { SchedulerMonitorPage } from '../pages/SchedulerMonitorPage';

export const routes = [
    // ... å…¶ä»–è·¯ç”± ...

    // ç³»ç»Ÿç®¡ç†
    { path: '/system-settings/user-permissions', title: 'ç”¨æˆ·ä¸æƒé™', component: PlaceholderPage },
    { path: '/system-settings/data-access', title: 'æ•°æ®æ¥å…¥ç®¡ç†', component: PlaceholderPage },
    { path: '/system-settings/model-parameters', title: 'é¢„æµ‹æ¨¡å‹å‚æ•°', component: PlaceholderPage },
    { path: '/system-settings/scheduler-monitor', title: 'å®šæ—¶ä»»åŠ¡ç›‘æ§', component: SchedulerMonitorPage }, // æ–°å¢
];
```

**æ–‡ä»¶2**: `frontend/src/components/Sidebar.tsx`

```typescript
// åœ¨ç³»ç»Ÿç®¡ç†èœå•ä¸­æ·»åŠ æ–°é¡¹
<ListItem
    button
    component={Link}
    to="/system-settings/scheduler-monitor"
    onClick={() => handleMenuClick('/system-settings/scheduler-monitor')}
    selected={location.pathname === '/system-settings/scheduler-monitor'}
>
    <ListItemIcon>
        <TaskIcon />
    </ListItemIcon>
    <ListItemText primary="å®šæ—¶ä»»åŠ¡ç›‘æ§" />
</ListItem>
```

**æ–‡ä»¶3**: `frontend/src/App.tsx`ï¼ˆç§»åŠ¨ç«¯è·¯ç”±ï¼‰

```typescript
// åœ¨ç§»åŠ¨ç«¯è·¯ç”±ä¸­æ·»åŠ 
<Route path="/system-settings/scheduler-monitor" element={<SchedulerMonitorPage />} />
```

---

## å®æ–½è®¡åˆ’

### 7.1 æ€»ä½“æ—¶é—´è¡¨

| é˜¶æ®µ | ä»»åŠ¡ | å·¥æ—¶ | æ—¶é—´å®‰æ’ |
|------|------|------|---------|
| **Phase 1** | åç«¯åŸºç¡€æ¡†æ¶ | 8h | Day 1 |
| **Phase 2** | åç«¯APIæ¥å£ | 6h | Day 2 |
| **Phase 3** | å‰ç«¯ç›‘æ§ç•Œé¢ | 10h | Day 3-4 |
| **Phase 4** | ä¸šåŠ¡ä»»åŠ¡å®ç° | 6h | Day 4-5 |
| **Phase 5** | æµ‹è¯•å’Œä¼˜åŒ– | 6h | Day 5 |

**æ€»è®¡**: çº¦ 36 å°æ—¶ï¼ˆ5 ä¸ªå·¥ä½œæ—¥ï¼‰

### 7.2 è¯¦ç»†å®æ–½æ­¥éª¤

#### Day 1: åç«¯åŸºç¡€æ¡†æ¶ï¼ˆ8å°æ—¶ï¼‰

**ä¸Šåˆï¼ˆ4å°æ—¶ï¼‰**:
- [ ] åˆ›å»ºç›®å½•ç»“æ„ (`webapp/scheduler/`, `webapp/tasks/`)
- [ ] å®ç° `BaseTask` åŸºç±» (`tasks/base_task.py`)
- [ ] å®ç° `SchedulerService` (`scheduler/scheduler_service.py`)
- [ ] å®‰è£…APSchedulerä¾èµ– (`pip install apscheduler`)

**ä¸‹åˆï¼ˆ4å°æ—¶ï¼‰**:
- [ ] å®ç° `TaskMonitorService` (`scheduler/task_monitor_service.py`)
- [ ] å®ç° `TaskExecutionService` (`scheduler/task_execution_service.py`)
- [ ] åˆ›å»ºæ•°æ®åº“åˆå§‹åŒ–è„šæœ¬ (`scripts/init_scheduler_db.py`)
- [ ] è¿è¡Œåˆå§‹åŒ–è„šæœ¬ï¼Œåˆ›å»ºé›†åˆå’Œç´¢å¼•

#### Day 2: åç«¯APIæ¥å£ï¼ˆ6å°æ—¶ï¼‰

**ä¸Šåˆï¼ˆ3å°æ—¶ï¼‰**:
- [ ] åˆ›å»º `v1_scheduler.py` APIæ–‡ä»¶
- [ ] å®ç°ç»Ÿè®¡ã€è¶‹åŠ¿ã€ä»»åŠ¡åˆ—è¡¨æ¥å£
- [ ] å®ç°ä»»åŠ¡è¯¦æƒ…æ¥å£

**ä¸‹åˆï¼ˆ3å°æ—¶ï¼‰**:
- [ ] å®ç°æ‰‹åŠ¨æ‰§è¡Œã€å¯ç”¨/ç¦ç”¨æ¥å£
- [ ] å®ç°æ‰§è¡Œå†å²ã€æ—¥å¿—æŸ¥çœ‹æ¥å£
- [ ] åœ¨ `main.py` ä¸­é›†æˆè°ƒåº¦å™¨å’ŒAPI
- [ ] ä½¿ç”¨ `/docs` æµ‹è¯•æ‰€æœ‰æ¥å£

#### Day 3: å‰ç«¯ç›‘æ§ç•Œé¢ï¼ˆç¬¬1éƒ¨åˆ†ï¼Œ5å°æ—¶ï¼‰

**ä¸Šåˆï¼ˆ3å°æ—¶ï¼‰**:
- [ ] åˆ›å»º `SchedulerMonitorPage.tsx` æ–‡ä»¶
- [ ] å®ç°ç»Ÿè®¡å¡ç‰‡ç»„ä»¶ (`StatCard`)
- [ ] å®ç°æ•°æ®åŠ è½½é€»è¾‘ (`fetchData`)
- [ ] é›†æˆç»Ÿè®¡å¡ç‰‡åˆ°é¡µé¢

**ä¸‹åˆï¼ˆ2å°æ—¶ï¼‰**:
- [ ] å®ç°è¶‹åŠ¿å›¾è¡¨ï¼ˆRecharts LineChartï¼‰
- [ ] é›†æˆ `useChartFullscreen` Hook
- [ ] æµ‹è¯•å›¾è¡¨å…¨å±åŠŸèƒ½

#### Day 4: å‰ç«¯ç›‘æ§ç•Œé¢ï¼ˆç¬¬2éƒ¨åˆ†ï¼Œ5å°æ—¶ï¼‰+ ä¸šåŠ¡ä»»åŠ¡ï¼ˆ3å°æ—¶ï¼‰

**ä¸Šåˆï¼ˆ3å°æ—¶ï¼‰**:
- [ ] å®ç°ä»»åŠ¡åˆ—è¡¨è¡¨æ ¼
- [ ] å®ç°ç­›é€‰å’Œæœç´¢åŠŸèƒ½
- [ ] å®ç°æ‰‹åŠ¨æ‰§è¡Œä»»åŠ¡æŒ‰é’®
- [ ] å®ç°å¯ç”¨/ç¦ç”¨ä»»åŠ¡å¼€å…³

**ä¸‹åˆï¼ˆ2å°æ—¶å‰ç«¯ + 3å°æ—¶åç«¯ï¼‰**:
- [ ] æ›´æ–°è·¯ç”±é…ç½® (`routes.tsx`, `Sidebar.tsx`, `App.tsx`)
- [ ] æµ‹è¯•å‰ç«¯é¡µé¢äº¤äº’

**åç«¯ä¸šåŠ¡ä»»åŠ¡ï¼ˆ3å°æ—¶ï¼‰**:
- [ ] å®ç° `CustomerStatusUpdateTask` (å®¢æˆ·çŠ¶æ€æ›´æ–°)
- [ ] å®ç° `ContractAutoExpirationTask` (åˆåŒè‡ªåŠ¨è¿‡æœŸ)
- [ ] ç¼–å†™ä»»åŠ¡å•å…ƒæµ‹è¯•

#### Day 5: å…¶ä»–ä¸šåŠ¡ä»»åŠ¡ï¼ˆ3å°æ—¶ï¼‰+ æµ‹è¯•ä¼˜åŒ–ï¼ˆ6å°æ—¶ï¼‰

**ä¸Šåˆï¼ˆ3å°æ—¶ä¸šåŠ¡ä»»åŠ¡ + 2å°æ—¶æµ‹è¯•ï¼‰**:
- [ ] å®ç° `DataCleanupTask` (æ•°æ®æ¸…ç†)
- [ ] å®ç° `DailyReportGenerationTask` (æ—¥æŠ¥ç”Ÿæˆ)
- [ ] é›†æˆæµ‹è¯•ï¼šè°ƒåº¦å™¨å¯åŠ¨ã€ä»»åŠ¡æ³¨å†Œ

**ä¸‹åˆï¼ˆ4å°æ—¶æµ‹è¯•å’Œä¼˜åŒ–ï¼‰**:
- [ ] å‰åç«¯è”è°ƒæµ‹è¯•
- [ ] ç§»åŠ¨ç«¯å“åº”å¼æµ‹è¯•
- [ ] æ€§èƒ½æµ‹è¯•ï¼ˆæŸ¥è¯¢ä¼˜åŒ–ï¼‰
- [ ] Bugä¿®å¤å’Œä»£ç ä¼˜åŒ–
- [ ] ç¼–å†™éƒ¨ç½²æ–‡æ¡£

---

## æµ‹è¯•æ–¹æ¡ˆ

### 8.1 åç«¯æµ‹è¯•

#### 8.1.1 å•å…ƒæµ‹è¯•

**æ–‡ä»¶ä½ç½®**: `tests/test_scheduler_service.py`

```python
import pytest
from webapp.scheduler.scheduler_service import SchedulerService
from webapp.tools.mongo import DATABASE

class TestSchedulerService:
    """è°ƒåº¦æœåŠ¡æµ‹è¯•"""

    def test_scheduler_start_stop(self):
        """æµ‹è¯•è°ƒåº¦å™¨å¯åŠ¨å’Œåœæ­¢"""
        service = SchedulerService(DATABASE)

        service.start()
        assert service.scheduler.running is True

        service.shutdown()
        assert service.scheduler.running is False

    def test_register_task(self):
        """æµ‹è¯•ä»»åŠ¡æ³¨å†Œ"""
        # ... æµ‹è¯•ä»£ç  ...

    def test_execute_task_now(self):
        """æµ‹è¯•æ‰‹åŠ¨æ‰§è¡Œä»»åŠ¡"""
        # ... æµ‹è¯•ä»£ç  ...

    def test_toggle_task(self):
        """æµ‹è¯•å¯ç”¨/ç¦ç”¨ä»»åŠ¡"""
        # ... æµ‹è¯•ä»£ç  ...
```

#### 8.1.2 APIæ¥å£æµ‹è¯•

**ä½¿ç”¨FastAPIçš„ `/docs` äº¤äº’å¼æ–‡æ¡£è¿›è¡Œæ‰‹åŠ¨æµ‹è¯•**:

1. è®¿é—® `http://127.0.0.1:8005/docs`
2. ä¾æ¬¡æµ‹è¯•ä»¥ä¸‹æ¥å£ï¼š
   - GET `/api/v1/scheduler/statistics` - è·å–ç»Ÿè®¡æ•°æ®
   - GET `/api/v1/scheduler/trend?days=7` - è·å–è¶‹åŠ¿æ•°æ®
   - GET `/api/v1/scheduler/tasks` - è·å–ä»»åŠ¡åˆ—è¡¨
   - POST `/api/v1/scheduler/tasks/{task_name}/execute` - æ‰‹åŠ¨æ‰§è¡Œä»»åŠ¡
   - POST `/api/v1/scheduler/tasks/{task_name}/toggle` - å¯ç”¨/ç¦ç”¨ä»»åŠ¡

### 8.2 å‰ç«¯æµ‹è¯•

#### 8.2.1 åŠŸèƒ½æµ‹è¯•æ¸…å•

- [ ] é¡µé¢åŠ è½½æ­£å¸¸ï¼Œæ— é”™è¯¯æç¤º
- [ ] ç»Ÿè®¡å¡ç‰‡æ˜¾ç¤ºæ­£ç¡®æ•°æ®
- [ ] è¶‹åŠ¿å›¾è¡¨æ¸²æŸ“æ­£å¸¸
- [ ] å›¾è¡¨å…¨å±åŠŸèƒ½æ­£å¸¸ï¼ˆè¿›å…¥/é€€å‡ºï¼‰
- [ ] ä»»åŠ¡åˆ—è¡¨è¡¨æ ¼æ˜¾ç¤ºæ­£ç¡®
- [ ] ç±»åˆ«ç­›é€‰åŠŸèƒ½æ­£å¸¸
- [ ] æœç´¢åŠŸèƒ½æ­£å¸¸
- [ ] æ‰‹åŠ¨æ‰§è¡Œä»»åŠ¡æˆåŠŸ
- [ ] å¯ç”¨/ç¦ç”¨ä»»åŠ¡æˆåŠŸ
- [ ] åˆ·æ–°æŒ‰é’®æ­£å¸¸

#### 8.2.2 å“åº”å¼æµ‹è¯•

**æµ‹è¯•è®¾å¤‡**:
- iPhone SE (375pxå®½)
- iPad (768pxå®½)
- æ¡Œé¢ç«¯ (1200px+å®½)

**æµ‹è¯•ç‚¹**:
- [ ] ç»Ÿè®¡å¡ç‰‡å¸ƒå±€æ­£ç¡®ï¼ˆç§»åŠ¨ç«¯2åˆ—ï¼Œæ¡Œé¢ç«¯4åˆ—ï¼‰
- [ ] å›¾è¡¨é«˜åº¦å“åº”å¼ï¼ˆç§»åŠ¨ç«¯350pxï¼Œæ¡Œé¢ç«¯400pxï¼‰
- [ ] è¡¨æ ¼å­—ä½“å’Œå†…è¾¹è·å“åº”å¼
- [ ] ç­›é€‰æ§ä»¶åœ¨ç§»åŠ¨ç«¯æ­£ç¡®æ¢è¡Œ

### 8.3 æ€§èƒ½æµ‹è¯•

#### 8.3.1 æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½

**æµ‹è¯•åœºæ™¯**: 1000ä¸ªä»»åŠ¡é…ç½® + 10000æ¡æ‰§è¡Œæ—¥å¿—

**æ€§èƒ½æŒ‡æ ‡**:
- ä»»åŠ¡åˆ—è¡¨æŸ¥è¯¢ < 500ms
- è¶‹åŠ¿æ•°æ®èšåˆ < 1s
- æ‰§è¡Œå†å²æŸ¥è¯¢ < 300ms

**ä¼˜åŒ–æªæ–½**:
- ç¡®ä¿æ‰€æœ‰æŸ¥è¯¢éƒ½ä½¿ç”¨ç´¢å¼•
- ä½¿ç”¨èšåˆç®¡é“ä¼˜åŒ–ç»Ÿè®¡æŸ¥è¯¢
- å¯¹æ‰§è¡Œå†å²è®¾ç½®åˆç†çš„limit

#### 8.3.2 å‰ç«¯æ¸²æŸ“æ€§èƒ½

**æ€§èƒ½æŒ‡æ ‡**:
- åˆå§‹é¡µé¢åŠ è½½ < 2s
- ç­›é€‰/æœç´¢å“åº” < 200ms
- å›¾è¡¨æ¸²æŸ“ < 500ms

---

## è¿ç»´æŒ‡å—

### 9.1 éƒ¨ç½²æ¸…å•

#### 9.1.1 åç«¯éƒ¨ç½²

1. **å®‰è£…ä¾èµ–**:
   ```bash
   pip install -r requirements.txt
   ```

2. **åˆå§‹åŒ–æ•°æ®åº“**:
   ```bash
   python scripts/init_scheduler_db.py
   ```

3. **å¯¼å…¥ä»»åŠ¡é…ç½®** (å¯é€‰):
   ```bash
   python scripts/import_task_configs.py
   ```

4. **å¯åŠ¨åº”ç”¨**:
   ```bash
   uvicorn webapp.main:app --reload --host 0.0.0.0 --port 8005
   ```

#### 9.1.2 å‰ç«¯éƒ¨ç½²

1. **å®‰è£…ä¾èµ–**:
   ```bash
   npm install --prefix frontend
   ```

2. **æ„å»ºç”Ÿäº§ç‰ˆæœ¬**:
   ```bash
   npm run build --prefix frontend
   ```

3. **æ£€æŸ¥æ„å»ºé”™è¯¯**:
   - ç¡®ä¿æ— TypeScriptç¼–è¯‘é”™è¯¯
   - ç¡®ä¿æ— Grid v7è¯­æ³•é”™è¯¯

### 9.2 ç›‘æ§å’Œå‘Šè­¦

#### 9.2.1 ç›‘æ§æŒ‡æ ‡

**åº”ç”¨å±‚ç›‘æ§**:
- è°ƒåº¦å™¨è¿è¡ŒçŠ¶æ€ï¼ˆé€šè¿‡æ—¥å¿—ï¼‰
- ä»»åŠ¡æ‰§è¡ŒæˆåŠŸç‡
- ä»»åŠ¡æ‰§è¡Œè€—æ—¶

**æ•°æ®åº“ç›‘æ§**:
- `task_execution_logs` é›†åˆå¤§å°
- æŸ¥è¯¢å“åº”æ—¶é—´
- ç´¢å¼•ä½¿ç”¨ç‡

**ç³»ç»Ÿå±‚ç›‘æ§**:
- CPUä½¿ç”¨ç‡
- å†…å­˜ä½¿ç”¨é‡
- ç£ç›˜ç©ºé—´

#### 9.2.2 å‘Šè­¦è§„åˆ™

| å‘Šè­¦é¡¹ | é˜ˆå€¼ | å¤„ç†æ–¹å¼ |
|-------|------|---------|
| ä»»åŠ¡è¿ç»­å¤±è´¥3æ¬¡ | 3æ¬¡ | å‘é€é‚®ä»¶/é’‰é’‰é€šçŸ¥ |
| ä»»åŠ¡æ‰§è¡Œæ—¶é•¿è¶…è¿‡é¢„æœŸ | 2å€å¹³å‡æ—¶é•¿ | è®°å½•è­¦å‘Šæ—¥å¿— |
| è°ƒåº¦å™¨åœæ­¢è¿è¡Œ | ç«‹å³ | å‘é€ç´§æ€¥é€šçŸ¥ï¼Œè‡ªåŠ¨é‡å¯ |
| æ‰§è¡Œæ—¥å¿—é›†åˆå¤§å° | > 10GB | æ¸…ç†90å¤©å‰çš„æ—¥å¿— |

### 9.3 æ•…éšœæ’æŸ¥

#### 9.3.1 å¸¸è§é—®é¢˜

**é—®é¢˜1: ä»»åŠ¡æœªæŒ‰æ—¶æ‰§è¡Œ**

**æ’æŸ¥æ­¥éª¤**:
1. æ£€æŸ¥è°ƒåº¦å™¨æ˜¯å¦è¿è¡Œ: `scheduler.running`
2. æ£€æŸ¥ä»»åŠ¡æ˜¯å¦è¢«æš‚åœ: `GET /api/v1/scheduler/tasks/{task_name}`
3. æ£€æŸ¥æœåŠ¡å™¨æ—¶åŒºè®¾ç½®: `timezone='Asia/Shanghai'`
4. æŸ¥çœ‹APScheduleræ—¥å¿—: `scheduler_jobs` é›†åˆ

**é—®é¢˜2: ä»»åŠ¡æ‰§è¡Œå¤±è´¥**

**æ’æŸ¥æ­¥éª¤**:
1. æŸ¥çœ‹æ‰§è¡Œæ—¥å¿—: `GET /api/v1/scheduler/execution-logs/{execution_id}`
2. æ£€æŸ¥é”™è¯¯å †æ ˆ: `error_info.traceback` å­—æ®µ
3. æ£€æŸ¥æ•°æ®åº“è¿æ¥: MongoDBè¿æ¥æ˜¯å¦æ­£å¸¸
4. æ£€æŸ¥ä»»åŠ¡ä»£ç : æ˜¯å¦æœ‰ä¸šåŠ¡é€»è¾‘é”™è¯¯

**é—®é¢˜3: å‰ç«¯é¡µé¢æ— æ•°æ®**

**æ’æŸ¥æ­¥éª¤**:
1. æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼ŒæŸ¥çœ‹Consoleé”™è¯¯
2. æ£€æŸ¥APIè¯·æ±‚æ˜¯å¦æˆåŠŸï¼ˆNetworké¢æ¿ï¼‰
3. æ£€æŸ¥JWT Tokenæ˜¯å¦æœ‰æ•ˆ
4. æ£€æŸ¥åç«¯APIæ˜¯å¦æ­£å¸¸è¿è¡Œ

### 9.4 æ—¥å¸¸ç»´æŠ¤

#### 9.4.1 æ—¥å¿—æ¸…ç†

**æ‰‹åŠ¨æ¸…ç†90å¤©å‰çš„æ—¥å¿—**:
```javascript
// MongoDB Shell
use exds_db
db.task_execution_logs.deleteMany({
    created_at: { $lt: new Date(Date.now() - 90 * 24 * 60 * 60 * 1000) }
})
```

**æˆ–è€…å¯ç”¨TTLç´¢å¼•è‡ªåŠ¨æ¸…ç†** (å·²åœ¨æ•°æ®åº“è®¾è®¡ä¸­é…ç½®)

#### 9.4.2 æ€§èƒ½ä¼˜åŒ–

**å®šæœŸåˆ†ææ…¢æŸ¥è¯¢**:
```javascript
// æŸ¥çœ‹æ…¢æŸ¥è¯¢
db.setProfilingLevel(1, { slowms: 1000 });
db.system.profile.find().sort({ ts: -1 }).limit(10);
```

**å®šæœŸé‡å»ºç´¢å¼•**:
```javascript
db.task_execution_logs.reIndex();
```

---

## é™„å½•

### A. ç›¸å…³æ–‡ä»¶æ¸…å•

#### æ–°å¢æ–‡ä»¶ï¼ˆ12ä¸ªï¼‰

**åç«¯**:
1. `webapp/scheduler/scheduler_service.py` - è°ƒåº¦æœåŠ¡
2. `webapp/scheduler/task_monitor_service.py` - ç›‘æ§æœåŠ¡
3. `webapp/scheduler/task_execution_service.py` - æ‰§è¡ŒæœåŠ¡
4. `webapp/tasks/base_task.py` - ä»»åŠ¡åŸºç±»
5. `webapp/api/v1_scheduler.py` - APIæ¥å£
6. `scripts/init_scheduler_db.py` - æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬
7. `tests/test_scheduler_service.py` - å•å…ƒæµ‹è¯•

**å‰ç«¯**:
8. `frontend/src/pages/SchedulerMonitorPage.tsx` - ç›‘æ§é¡µé¢
9. `frontend/src/api/scheduler.ts` - APIå®¢æˆ·ç«¯ï¼ˆå¯é€‰ï¼‰

**æ–‡æ¡£**:
10. `docs/pages/é€šç”¨å®šæ—¶ä»»åŠ¡/å®šæ—¶ä»»åŠ¡ç›‘æ§æ¨¡å—æŠ€æœ¯æ–¹æ¡ˆ.md` - æœ¬æ–‡æ¡£
11. `docs/pages/é€šç”¨å®šæ—¶ä»»åŠ¡/è¿ç»´æ‰‹å†Œ.md` - è¿ç»´æ‰‹å†Œ
12. `docs/pages/é€šç”¨å®šæ—¶ä»»åŠ¡/å¼€å‘æŒ‡å—.md` - å¼€å‘æŒ‡å—

#### ä¿®æ”¹æ–‡ä»¶ï¼ˆ5ä¸ªï¼‰

1. `webapp/main.py` - é›†æˆè°ƒåº¦å™¨
2. `requirements.txt` - æ·»åŠ apschedulerä¾èµ–
3. `frontend/src/config/routes.tsx` - æ·»åŠ è·¯ç”±
4. `frontend/src/components/Sidebar.tsx` - æ·»åŠ èœå•
5. `frontend/src/App.tsx` - æ·»åŠ ç§»åŠ¨ç«¯è·¯ç”±

### B. æ•°æ®åº“é›†åˆ

| é›†åˆå | ç”¨é€” | é¢„ä¼°å¤§å° |
|-------|------|---------|
| scheduler_jobs | APSchedulerä½œä¸šå­˜å‚¨ | < 1MB |
| task_configs | ä»»åŠ¡é…ç½® | < 1MB |
| task_execution_logs | æ‰§è¡Œæ—¥å¿— | å¢é•¿å‹ï¼ˆè®¾ç½®TTLï¼‰ |

### C. ä¾èµ–é¡¹

**æ–°å¢PythonåŒ…**:
```
apscheduler>=3.10.0
pytz>=2023.3
```

**æ— éœ€æ–°å¢å‰ç«¯ä¾èµ–**

### D. å‚è€ƒæ–‡æ¡£

1. [APSchedulerå®˜æ–¹æ–‡æ¡£](https://apscheduler.readthedocs.io/)
2. [é€šç”¨å®šæ—¶ä»»åŠ¡æ¨¡å—è®¾è®¡æ–¹æ¡ˆ](./é€šç”¨å®šæ—¶ä»»åŠ¡æ¨¡å—è®¾è®¡æ–¹æ¡ˆ.md)
3. [ä¸šåŠ¡ä»»åŠ¡å®ç°ç¤ºä¾‹](./ä¸šåŠ¡ä»»åŠ¡å®ç°ç¤ºä¾‹.md)
4. [å‰ç«¯é¡µé¢è®¾è®¡è§„èŒƒ](../../å‰ç«¯é¡µé¢è®¾è®¡è§„èŒƒ.md)
5. [CLAUDE.md](../../../CLAUDE.md)

---

**æ–‡æ¡£ç»“æŸ**
