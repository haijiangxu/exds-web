# é›¶å”®å¥—é¤ç®¡ç†æ¨¡å— - ä»£ç å®¡æŸ¥ä¸å®Œå–„æ–¹æ¡ˆ

> å®¡æŸ¥æ—¥æœŸï¼š2025-11-05
> åŸºäºè®¾è®¡æ–‡æ¡£ï¼šé›¶å”®å¥—é¤ç®¡ç†æ¨¡å—è®¾è®¡æ–¹æ¡ˆ_v2.md
> å®¡æŸ¥èŒƒå›´ï¼šåç«¯APIã€æ•°æ®æ¨¡å‹ã€å‰ç«¯ç»„ä»¶ã€çŠ¶æ€ç®¡ç†ã€æ ¡éªŒé€»è¾‘

---

## ğŸ“‹ ä¸€ã€æ€»ä½“è¯„ä¼°

### å·²å®Œæˆéƒ¨åˆ† âœ…

- âœ… åŸºæœ¬çš„APIè·¯ç”±æ¡†æ¶ (7/9ä¸ªAPIç«¯ç‚¹)
- âœ… æ•°æ®æ¨¡å‹å®šä¹‰ (åŸºæœ¬å®Œæ•´)
- âœ… å‰ç«¯é¡µé¢å¸ƒå±€ (ç¬¦åˆåŒå¡ç‰‡è®¾è®¡)
- âœ… è¡¨å•ç»„ä»¶åŸºç¡€å®ç°
- âœ… è·¯ç”±æ³¨å†Œå’Œæƒé™æ§åˆ¶

### éœ€è¦å®Œå–„çš„æ ¸å¿ƒåŠŸèƒ½ âŒ

- âŒ åç«¯æœåŠ¡å±‚æ–¹æ³•ç¼ºå¤± (update/delete/copy/get_by_id)
- âŒ çŠ¶æ€æœºç®¡ç†é€»è¾‘æœªå®ç°
- âŒ å¥—é¤åç§°å”¯ä¸€æ€§æ ¡éªŒæœªå®ç°
- âŒ å‰ç«¯UI/UXä¼˜åŒ–æœªå®Œæˆ
- âŒ ä»·æ ¼æ¯”ä¾‹æ ¡éªŒé›†æˆç¼ºå¤±
- âŒ æ•°æ®æ¨¡å‹å­—æ®µç¼ºå¤±

### ä»£ç å®Œæˆåº¦è¯„ä¼°

| æ¨¡å— | å®Œæˆåº¦ | è¯´æ˜ |
|------|--------|------|
| åç«¯APIè·¯ç”± | 80% | ç¼ºå°‘GETè¯¦æƒ…å’ŒDELETEç«¯ç‚¹ |
| åç«¯Serviceå±‚ | 40% | ç¼ºå°‘4ä¸ªæ ¸å¿ƒæ–¹æ³• |
| æ•°æ®æ¨¡å‹ | 85% | ç¼ºå°‘validationå­—æ®µ |
| å‰ç«¯åˆ—è¡¨é¡µ | 70% | ç¼ºå°‘åˆ é™¤åŠŸèƒ½å’ŒçŠ¶æ€æ§åˆ¶ |
| å‰ç«¯ç¼–è¾‘è¡¨å• | 75% | ç¼ºå°‘é”™è¯¯å¤„ç†å’Œæ ¡éªŒæç¤º |
| çŠ¶æ€æœºç®¡ç† | 0% | å®Œå…¨æœªå®ç° |
| æ ¡éªŒé€»è¾‘ | 50% | å·²æœ‰å¼•æ“ä½†æœªé›†æˆ |
| **æ€»ä½“** | **çº¦60%** | åŸºç¡€æ¶æ„å®Œæ•´ï¼Œæ ¸å¿ƒé€»è¾‘ç¼ºå¤± |

---

## ğŸ”´ äºŒã€åç«¯éœ€è¦å®Œå–„çš„å†…å®¹

### 2.1 PackageService ç¼ºå¤±çš„æ–¹æ³•

**é—®é¢˜ä½ç½®ï¼š** `webapp/services/package_service.py`

**è®¾è®¡æ–‡æ¡£ä¾æ®ï¼š** ç¬¬4.1èŠ‚ - APIè®¾è®¡

#### ç¼ºå¤±æ–¹æ³•1ï¼š`get_package_by_id()`

**ç”¨é€”ï¼š** è·å–å¥—é¤è¯¦æƒ…
**APIç«¯ç‚¹ï¼š** `GET /api/v1/retail-packages/{package_id}`
**è®¾è®¡è¦æ±‚ï¼š** ç¬¬4.1èŠ‚ç¬¬2ç‚¹

**å½“å‰çŠ¶å†µï¼š**
- âŒ Serviceæ–¹æ³•ä¸å­˜åœ¨
- âŒ APIç«¯ç‚¹ä¸å­˜åœ¨
- âŒ å‰ç«¯ç¼–è¾‘/å¤åˆ¶åŠŸèƒ½è¢«é˜»å¡

**å®ç°æ–¹æ¡ˆï¼š**

```python
# webapp/services/package_service.py

def get_package_by_id(self, package_id: str) -> dict:
    """
    æ ¹æ®IDè·å–å¥—é¤è¯¦æƒ…

    Args:
        package_id: å¥—é¤ID

    Returns:
        å¥—é¤å®Œæ•´ä¿¡æ¯å­—å…¸

    Raises:
        ValueError: å¥—é¤ä¸å­˜åœ¨
    """
    try:
        doc = self.collection.find_one({"_id": ObjectId(package_id)})
    except Exception as e:
        raise ValueError(f"æ— æ•ˆçš„å¥—é¤ID: {package_id}")

    if not doc:
        raise ValueError(f"å¥—é¤ä¸å­˜åœ¨: {package_id}")

    package = RetailPackage(**doc)
    return package.dict(by_alias=True, exclude_none=True)
```

**å¯¹åº”APIç«¯ç‚¹ï¼š**

```python
# webapp/api/v1_retail_packages.py

@router.get("/{package_id}", response_model=dict)
async def get_package(
    package_id: str,
    current_user: User = Depends(get_current_active_user)
):
    """è·å–å¥—é¤è¯¦æƒ…"""
    service = PackageService(DATABASE)
    try:
        result = service.get_package_by_id(package_id)
        return result
    except ValueError as e:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail=str(e)
        )
```

**ä¼˜å…ˆçº§ï¼š** ğŸ”´ é«˜ - é˜»å¡ç¼–è¾‘/å¤åˆ¶åŠŸèƒ½

---

#### ç¼ºå¤±æ–¹æ³•2ï¼š`update_package()`

**ç”¨é€”ï¼š** æ›´æ–°å¥—é¤
**APIç«¯ç‚¹ï¼š** `PUT /api/v1/retail-packages/{package_id}`
**è®¾è®¡è¦æ±‚ï¼š** ç¬¬4.1èŠ‚ç¬¬4ç‚¹

**å½“å‰çŠ¶å†µï¼š**
- âŒ Serviceæ–¹æ³•ä¸å­˜åœ¨
- âš ï¸ APIç«¯ç‚¹å­˜åœ¨ä½†è°ƒç”¨ä¸å­˜åœ¨çš„æ–¹æ³•
- âŒ çŠ¶æ€æ ¡éªŒæœªå®ç°
- âŒ åç§°å†²çªå¤„ç†æœªå®ç°

**å®ç°æ–¹æ¡ˆï¼š**

```python
# webapp/services/package_service.py

def update_package(
    self,
    package_id: str,
    package_data: dict,
    operator: str
) -> dict:
    """
    æ›´æ–°å¥—é¤

    Args:
        package_id: å¥—é¤ID
        package_data: æ›´æ–°çš„æ•°æ®
        operator: æ“ä½œäºº

    Returns:
        æ›´æ–°åçš„å¥—é¤ä¿¡æ¯

    Raises:
        ValueError: å¥—é¤ä¸å­˜åœ¨ã€çŠ¶æ€ä¸å…è®¸æ›´æ–°ã€åç§°å†²çª
    """
    # 1. æ£€æŸ¥å¥—é¤æ˜¯å¦å­˜åœ¨
    try:
        existing_doc = self.collection.find_one({"_id": ObjectId(package_id)})
    except Exception as e:
        raise ValueError(f"æ— æ•ˆçš„å¥—é¤ID: {package_id}")

    if not existing_doc:
        raise ValueError(f"å¥—é¤ä¸å­˜åœ¨: {package_id}")

    # 2. çŠ¶æ€æœºæ ¡éªŒï¼šåªæœ‰è‰ç¨¿çŠ¶æ€æ‰èƒ½ç¼–è¾‘
    if existing_doc.get("status") != "draft":
        raise ValueError("åªæœ‰è‰ç¨¿çŠ¶æ€çš„å¥—é¤æ‰èƒ½è¢«ç¼–è¾‘")

    # 3. æ£€æŸ¥åç§°å†²çªï¼ˆå¦‚æœä¿®æ”¹äº†åç§°ï¼‰
    new_name = package_data.get("package_name")
    if new_name and new_name != existing_doc.get("package_name"):
        existing_name = self.collection.find_one({
            "package_name": new_name,
            "_id": {"$ne": ObjectId(package_id)}
        })
        if existing_name:
            raise ValueError("å¥—é¤åç§°å·²å­˜åœ¨")

    # 4. æ›´æ–°æ•°æ®
    package_data["updated_by"] = operator
    package_data["updated_at"] = datetime.utcnow()

    # 5. å¦‚æœæœ‰ä»·æ ¼é…ç½®ï¼Œè¿›è¡Œæ ¡éªŒ
    if (package_data.get("pricing_mode") == "fixed_linked" and
        package_data.get("fixed_linked_config", {})
            .get("fixed_price", {})
            .get("pricing_method") == "custom"):

        custom_prices_data = (
            package_data.get("fixed_linked_config", {})
                .get("fixed_price", {})
                .get("custom_prices", {})
        )

        if custom_prices_data:
            from webapp.services.pricing_engine import PricingEngine
            from webapp.models.retail_package import CustomPrices

            custom_prices = CustomPrices(**custom_prices_data)
            validation_result = PricingEngine.validate_price_ratio(custom_prices)
            package_data["validation"] = validation_result

    # 6. æ‰§è¡Œæ›´æ–°
    result = self.collection.update_one(
        {"_id": ObjectId(package_id)},
        {"$set": package_data}
    )

    if result.matched_count == 0:
        raise ValueError(f"æ›´æ–°å¤±è´¥: {package_id}")

    # 7. è¿”å›æ›´æ–°åçš„æ•°æ®
    return self.get_package_by_id(package_id)
```

**APIç«¯ç‚¹ä¿®æ”¹ï¼š**

```python
# webapp/api/v1_retail_packages.py

@router.put("/{package_id}", response_model=dict)
async def update_package(
    package_id: str,
    package: RetailPackage,
    current_user: User = Depends(get_current_active_user)
):
    """æ›´æ–°å¥—é¤"""
    service = PackageService(DATABASE)
    try:
        result = service.update_package(
            package_id=package_id,
            package_data=package.dict(exclude_unset=True),
            operator=current_user.username
        )
        return result
    except ValueError as e:
        error_msg = str(e)
        # æ ¹æ®é”™è¯¯ç±»å‹è¿”å›ä¸åŒçš„çŠ¶æ€ç 
        if "åç§°å·²å­˜åœ¨" in error_msg:
            raise HTTPException(
                status_code=status.HTTP_409_CONFLICT,
                detail=error_msg
            )
        elif "çŠ¶æ€" in error_msg or "ä¸å­˜åœ¨" in error_msg:
            raise HTTPException(
                status_code=status.HTTP_400_BAD_REQUEST,
                detail=error_msg
            )
        else:
            raise HTTPException(
                status_code=status.HTTP_404_NOT_FOUND,
                detail=error_msg
            )
```

**ä¼˜å…ˆçº§ï¼š** ğŸ”´ é«˜ - æ ¸å¿ƒCRUDåŠŸèƒ½

---

#### ç¼ºå¤±æ–¹æ³•3ï¼š`delete_package()`

**ç”¨é€”ï¼š** åˆ é™¤å¥—é¤ï¼ˆä»…è‰ç¨¿çŠ¶æ€ï¼‰
**APIç«¯ç‚¹ï¼š** `DELETE /api/v1/retail-packages/{package_id}`
**è®¾è®¡è¦æ±‚ï¼š** ç¬¬4.1èŠ‚ç¬¬5ç‚¹ï¼ˆV2æ–°å¢åŠŸèƒ½ï¼‰

**å½“å‰çŠ¶å†µï¼š**
- âŒ Serviceæ–¹æ³•ä¸å­˜åœ¨
- âŒ APIç«¯ç‚¹ä¸å­˜åœ¨
- âŒ å‰ç«¯åˆ é™¤æŒ‰é’®ä¸å­˜åœ¨

**å®ç°æ–¹æ¡ˆï¼š**

```python
# webapp/services/package_service.py

def delete_package(self, package_id: str) -> None:
    """
    åˆ é™¤å¥—é¤

    Args:
        package_id: å¥—é¤ID

    Raises:
        ValueError: å¥—é¤ä¸å­˜åœ¨æˆ–çŠ¶æ€ä¸å…è®¸åˆ é™¤
    """
    # 1. æ£€æŸ¥å¥—é¤æ˜¯å¦å­˜åœ¨
    try:
        existing_doc = self.collection.find_one({"_id": ObjectId(package_id)})
    except Exception as e:
        raise ValueError(f"æ— æ•ˆçš„å¥—é¤ID: {package_id}")

    if not existing_doc:
        raise ValueError(f"å¥—é¤ä¸å­˜åœ¨: {package_id}")

    # 2. çŠ¶æ€æœºæ ¡éªŒï¼šåªæœ‰è‰ç¨¿çŠ¶æ€æ‰èƒ½åˆ é™¤
    if existing_doc.get("status") != "draft":
        raise ValueError("åªæœ‰è‰ç¨¿çŠ¶æ€çš„å¥—é¤æ‰èƒ½è¢«åˆ é™¤")

    # 3. æ‰§è¡Œåˆ é™¤
    result = self.collection.delete_one({"_id": ObjectId(package_id)})

    if result.deleted_count == 0:
        raise ValueError(f"åˆ é™¤å¤±è´¥: {package_id}")
```

**å¯¹åº”APIç«¯ç‚¹ï¼š**

```python
# webapp/api/v1_retail_packages.py

@router.delete("/{package_id}", status_code=status.HTTP_204_NO_CONTENT)
async def delete_package(
    package_id: str,
    current_user: User = Depends(get_current_active_user)
):
    """åˆ é™¤å¥—é¤ï¼ˆä»…è‰ç¨¿çŠ¶æ€ï¼‰"""
    service = PackageService(DATABASE)
    try:
        service.delete_package(package_id)
        return None  # 204 No Content
    except ValueError as e:
        error_msg = str(e)
        if "çŠ¶æ€" in error_msg:
            raise HTTPException(
                status_code=status.HTTP_400_BAD_REQUEST,
                detail=error_msg
            )
        else:
            raise HTTPException(
                status_code=status.HTTP_404_NOT_FOUND,
                detail=error_msg
            )
```

**ä¼˜å…ˆçº§ï¼š** ğŸ”´ é«˜ - æ ¸å¿ƒCRUDåŠŸèƒ½

---

#### ç¼ºå¤±æ–¹æ³•4ï¼š`copy_package()`

**ç”¨é€”ï¼š** å¤åˆ¶å¥—é¤
**APIç«¯ç‚¹ï¼š** `POST /api/v1/retail-packages/{package_id}/copy`
**è®¾è®¡è¦æ±‚ï¼š** ç¬¬4.1èŠ‚ç¬¬6ç‚¹

**å½“å‰çŠ¶å†µï¼š**
- âŒ Serviceæ–¹æ³•ä¸å­˜åœ¨
- âš ï¸ APIç«¯ç‚¹å­˜åœ¨ä½†è°ƒç”¨ä¸å­˜åœ¨çš„æ–¹æ³•

**å®ç°æ–¹æ¡ˆï¼š**

```python
# webapp/services/package_service.py

def copy_package(self, package_id: str, operator: str) -> dict:
    """
    å¤åˆ¶å¥—é¤

    Args:
        package_id: è¦å¤åˆ¶çš„å¥—é¤ID
        operator: æ“ä½œäºº

    Returns:
        æ–°åˆ›å»ºçš„å¥—é¤ä¿¡æ¯

    Raises:
        ValueError: å¥—é¤ä¸å­˜åœ¨
    """
    # 1. è·å–åŸå¥—é¤
    try:
        original_doc = self.collection.find_one({"_id": ObjectId(package_id)})
    except Exception as e:
        raise ValueError(f"æ— æ•ˆçš„å¥—é¤ID: {package_id}")

    if not original_doc:
        raise ValueError(f"å¥—é¤ä¸å­˜åœ¨: {package_id}")

    # 2. åˆ›å»ºå‰¯æœ¬æ•°æ®
    new_package_data = dict(original_doc)

    # ç§»é™¤ä¸åº”å¤åˆ¶çš„å­—æ®µ
    fields_to_remove = [
        "_id", "created_at", "updated_at", "created_by", "updated_by",
        "activated_at", "archived_at"
    ]
    for field in fields_to_remove:
        new_package_data.pop(field, None)

    # 3. ç”Ÿæˆæ–°çš„å¥—é¤åç§°ï¼ˆé¿å…å†²çªï¼‰
    original_name = original_doc.get("package_name", "")
    new_name = f"{original_name}_å‰¯æœ¬"

    # å¦‚æœæ–°åç§°ä¹Ÿå­˜åœ¨ï¼Œè¿½åŠ æ•°å­—åç¼€
    counter = 1
    while self.collection.find_one({"package_name": new_name}):
        counter += 1
        new_name = f"{original_name}_å‰¯æœ¬{counter}"

    new_package_data["package_name"] = new_name

    # 4. è®¾ç½®ä¸ºè‰ç¨¿çŠ¶æ€
    new_package_data["status"] = "draft"

    # 5. ä½¿ç”¨create_packageæ–¹æ³•åˆ›å»ºæ–°å¥—é¤
    return self.create_package(
        package_data=new_package_data,
        operator=operator,
        status="draft"
    )
```

**ä¼˜å…ˆçº§ï¼š** ğŸ”´ é«˜ - æ ¸å¿ƒåŠŸèƒ½

---

### 2.2 çŠ¶æ€æœºç®¡ç†é€»è¾‘æœªå®ç°

**é—®é¢˜ä½ç½®ï¼š** `webapp/services/package_service.py`

**è®¾è®¡æ–‡æ¡£ä¾æ®ï¼š** ç¬¬8èŠ‚ - çŠ¶æ€æœºç®¡ç†

**å½“å‰çŠ¶å†µï¼š**
- `change_status()` æ–¹æ³•æ²¡æœ‰ä»»ä½•çŠ¶æ€è½¬æ¢æ ¡éªŒ
- ä»»ä½•çŠ¶æ€éƒ½å¯ä»¥è½¬æ¢åˆ°ä»»ä½•çŠ¶æ€ï¼ˆä¸¥é‡è¿åè®¾è®¡ï¼‰

**è®¾è®¡è¦æ±‚çš„çŠ¶æ€æœºè§„åˆ™ï¼š**

| å½“å‰çŠ¶æ€ | å…è®¸æ“ä½œ | ç›®æ ‡çŠ¶æ€ | æ ¡éªŒé€»è¾‘ |
|---------|---------|---------|---------|
| **draft** | ç¼–è¾‘ã€åˆ é™¤ã€æ¿€æ´»ã€å¤åˆ¶ | draft / (åˆ é™¤) / active / draft | âœ… å…¨éƒ¨å…è®¸ |
| **active** | å½’æ¡£ã€å¤åˆ¶ | archived / draft | âŒ ç¦æ­¢ç¼–è¾‘/åˆ é™¤ |
| **archived** | å¤åˆ¶ | draft | âŒ ç¦æ­¢å…¶ä»–æ‰€æœ‰æ“ä½œ |

**å®ç°æ–¹æ¡ˆï¼š**

```python
# webapp/services/package_service.py

class PackageService:
    """æœåŠ¡å±‚ç±»"""

    # çŠ¶æ€è½¬æ¢çŸ©é˜µ
    STATE_TRANSITIONS = {
        "draft": ["active"],           # è‰ç¨¿å¯ä»¥æ¿€æ´»
        "active": ["archived"],        # ç”Ÿæ•ˆå¯ä»¥å½’æ¡£
        "archived": []                 # å½’æ¡£ä¸èƒ½è½¬æ¢åˆ°å…¶ä»–çŠ¶æ€
    }

    def change_status(
        self,
        package_id: str,
        new_status: str,
        operator: str
    ) -> dict:
        """
        å˜æ›´å¥—é¤çŠ¶æ€

        Args:
            package_id: å¥—é¤ID
            new_status: ç›®æ ‡çŠ¶æ€
            operator: æ“ä½œäºº

        Returns:
            æ›´æ–°åçš„çŠ¶æ€ä¿¡æ¯

        Raises:
            ValueError: çŠ¶æ€è½¬æ¢ä¸åˆæ³•
        """
        # 1. è·å–å½“å‰å¥—é¤
        try:
            existing_doc = self.collection.find_one({"_id": ObjectId(package_id)})
        except Exception as e:
            raise ValueError(f"æ— æ•ˆçš„å¥—é¤ID: {package_id}")

        if not existing_doc:
            raise ValueError(f"å¥—é¤ä¸å­˜åœ¨: {package_id}")

        current_status = existing_doc.get("status")

        # 2. æ ¡éªŒçŠ¶æ€è½¬æ¢æ˜¯å¦åˆæ³•
        if new_status not in self.STATE_TRANSITIONS.get(current_status, []):
            raise ValueError(
                f"ä¸å…è®¸çš„çŠ¶æ€è½¬æ¢: {current_status} -> {new_status}ã€‚"
                f"å½“å‰çŠ¶æ€ '{current_status}' åªèƒ½è½¬æ¢åˆ°: "
                f"{self.STATE_TRANSITIONS.get(current_status, [])}"
            )

        # 3. å‡†å¤‡æ›´æ–°å­—æ®µ
        update_fields = {
            "status": new_status,
            "updated_by": operator,
            "updated_at": datetime.utcnow()
        }

        # è®°å½•çŠ¶æ€å˜æ›´æ—¶é—´
        if new_status == "active":
            update_fields["activated_at"] = datetime.utcnow()
        elif new_status == "archived":
            update_fields["archived_at"] = datetime.utcnow()

        # 4. æ‰§è¡Œæ›´æ–°
        result = self.collection.update_one(
            {"_id": ObjectId(package_id)},
            {"$set": update_fields}
        )

        if result.matched_count == 0:
            raise ValueError(f"æ›´æ–°å¤±è´¥: {package_id}")

        # 5. è¿”å›ç»“æœ
        return {
            "id": package_id,
            "status": new_status,
            "updated_at": update_fields["updated_at"].isoformat(),
            f"{new_status}_at": update_fields.get(
                f"{new_status}_at",
                update_fields["updated_at"]
            ).isoformat()
        }
```

**ä¼˜å…ˆçº§ï¼š** ğŸ”´ é«˜ - æ ¸å¿ƒä¸šåŠ¡é€»è¾‘

---

### 2.3 å¥—é¤åç§°å”¯ä¸€æ€§æ ¡éªŒ

**é—®é¢˜ä½ç½®ï¼š** æ•°æ®åº“ç´¢å¼• + `PackageService`

**è®¾è®¡æ–‡æ¡£ä¾æ®ï¼š** ç¬¬3.1èŠ‚ - æ•°æ®åº“è®¾è®¡

**å½“å‰çŠ¶å†µï¼š**
- âŒ MongoDBæ²¡æœ‰åˆ›å»ºå”¯ä¸€ç´¢å¼•
- âŒ Serviceå±‚æ²¡æœ‰æ•è·é‡åé”™è¯¯
- âŒ APIå±‚æ²¡æœ‰è¿”å›409çŠ¶æ€ç 

**å®ç°æ–¹æ¡ˆï¼š**

#### æ­¥éª¤1ï¼šåˆ›å»ºMongoDBå”¯ä¸€ç´¢å¼•

```javascript
// åœ¨MongoDB Shellä¸­æ‰§è¡Œ
use exds_database;  // æ›¿æ¢ä¸ºå®é™…æ•°æ®åº“å

db.retail_packages.createIndex(
    { "package_name": 1 },
    { unique: true, name: "idx_package_name_unique" }
);
```

#### æ­¥éª¤2ï¼šServiceå±‚æ•è·é”™è¯¯

```python
# webapp/services/package_service.py

from pymongo.errors import DuplicateKeyError

def create_package(self, package_data: dict, operator: str, status: str = "draft") -> dict:
    """åˆ›å»ºå¥—é¤"""
    package = RetailPackage(**package_data)
    package.created_by = operator
    package.updated_by = operator
    package.status = status

    # ä»·æ ¼æ¯”ä¾‹æ ¡éªŒï¼ˆå¦‚æœéœ€è¦ï¼‰
    if (package.pricing_mode == "fixed_linked" and
        package.fixed_linked_config and
        package.fixed_linked_config.fixed_price.pricing_method == "custom"):

        custom_prices = package.fixed_linked_config.fixed_price.custom_prices
        if custom_prices:
            from webapp.services.pricing_engine import PricingEngine
            validation_result = PricingEngine.validate_price_ratio(custom_prices)

            # åˆ›å»ºvalidationå¯¹è±¡
            from webapp.models.retail_package import ValidationResult
            package.validation = ValidationResult(**validation_result)

    # å°è¯•æ’å…¥
    try:
        insert_result = self.collection.insert_one(package.dict(by_alias=True))
    except DuplicateKeyError:
        raise ValueError(f"å¥—é¤åç§°å·²å­˜åœ¨: {package.package_name}")

    return {
        "id": str(insert_result.inserted_id),
        "status": package.status,
        "validation": package.validation.dict() if package.validation else None,
        "created_at": package.created_at.isoformat()
    }
```

#### æ­¥éª¤3ï¼šAPIå±‚è¿”å›409

```python
# webapp/api/v1_retail_packages.py

@router.post("", response_model=dict, status_code=status.HTTP_201_CREATED)
async def create_package(
    package: RetailPackage,
    save_as_draft: bool = True,
    current_user: User = Depends(get_current_active_user)
):
    """åˆ›å»ºå¥—é¤"""
    service = PackageService(DATABASE)
    try:
        result = service.create_package(
            package_data=package.dict(exclude_unset=True),
            status="draft" if save_as_draft else "active",
            operator=current_user.username
        )
        return result
    except ValueError as e:
        error_msg = str(e)
        if "åç§°å·²å­˜åœ¨" in error_msg:
            raise HTTPException(
                status_code=status.HTTP_409_CONFLICT,
                detail=error_msg
            )
        else:
            raise HTTPException(
                status_code=status.HTTP_400_BAD_REQUEST,
                detail=error_msg
            )
```

**ä¼˜å…ˆçº§ï¼š** ğŸŸ¡ ä¸­ - æ•°æ®å®Œæ•´æ€§ä¿è¯

---

### 2.4 æ•°æ®æ¨¡å‹å­—æ®µç¼ºå¤±

**é—®é¢˜ä½ç½®ï¼š** `webapp/models/retail_package.py`

**å½“å‰é—®é¢˜ï¼š**

```python
# webapp/services/package_service.py:31-32
return {
    "validation": package.validation.dict(),  # âŒ AttributeError
}
```

**åŸå› ï¼š** `RetailPackage` æ¨¡å‹æ²¡æœ‰ `validation` å­—æ®µ

**å®ç°æ–¹æ¡ˆï¼š**

```python
# webapp/models/retail_package.py

from typing import Optional, Literal, List
from pydantic import BaseModel, Field

# æ–°å¢ï¼šæ ¡éªŒç»“æœæ¨¡å‹
class ValidationResult(BaseModel):
    """ä»·æ ¼æ¯”ä¾‹æ ¡éªŒç»“æœ"""
    price_ratio_compliant: bool = Field(default=True, description="æ˜¯å¦ç¬¦åˆ463å·æ–‡æ¯”ä¾‹")
    actual_ratios: dict = Field(default_factory=dict, description="å®é™…æ¯”ä¾‹")
    expected_ratios: dict = Field(default_factory=dict, description="æ ‡å‡†æ¯”ä¾‹")
    warnings: List[str] = Field(default_factory=list, description="è­¦å‘Šä¿¡æ¯")

# ä¿®æ”¹ï¼šRetailPackageæ¨¡å‹
class RetailPackage(BaseMongoModel):
    package_name: str = Field(...)
    package_description: Optional[str] = None
    package_type: Literal["time_based", "non_time_based"]
    pricing_mode: Literal["fixed_linked", "price_spread"]

    fixed_linked_config: Optional[FixedLinkedConfig] = None
    price_spread_config: Optional[PriceSpreadConfig] = None

    additional_terms: AdditionalTerms = Field(default_factory=AdditionalTerms)

    status: Literal["draft", "active", "archived"] = "draft"

    # æ–°å¢ï¼šæ ¡éªŒä¿¡æ¯å­—æ®µ
    validation: Optional[ValidationResult] = None

    created_by: Optional[str] = None
    created_at: datetime = Field(default_factory=datetime.utcnow)
    updated_at: datetime = Field(default_factory=datetime.utcnow)
    updated_by: Optional[str] = None
    activated_at: Optional[datetime] = None
    archived_at: Optional[datetime] = None
```

**ä¼˜å…ˆçº§ï¼š** ğŸ”´ é«˜ - å¯¼è‡´è¿è¡Œæ—¶é”™è¯¯

---

### 2.5 ä»·æ ¼æ¯”ä¾‹æ ¡éªŒé›†æˆç¼ºå¤±

**é—®é¢˜ä½ç½®ï¼š** `webapp/services/package_service.py:24`

**å½“å‰çŠ¶å†µï¼š**

```python
# TODO: Add validation logic from pricing_engine
```

**å®ç°æ–¹æ¡ˆï¼š** å·²åœ¨2.3èŠ‚çš„ `create_package()` å’Œ 2.1èŠ‚çš„ `update_package()` ä¸­åŒ…å«

**ä¼˜å…ˆçº§ï¼š** ğŸŸ¡ ä¸­ - å·²é€šè¿‡å…¶ä»–å®ç°è¦†ç›–

---

## ğŸŸ¡ ä¸‰ã€å‰ç«¯éœ€è¦å®Œå–„çš„å†…å®¹

### 3.1 åˆ é™¤åŠŸèƒ½å®Œå…¨ç¼ºå¤±

**é—®é¢˜ä½ç½®ï¼š** `frontend/src/pages/RetailPackagePage.tsx`

**è®¾è®¡æ–‡æ¡£ä¾æ®ï¼š** ç¬¬2.1.2èŠ‚ - æ“ä½œåˆ—åŒ…å«åˆ é™¤æŒ‰é’®ï¼ˆä»…è‰ç¨¿çŠ¶æ€å¯è§ï¼‰

**å½“å‰çŠ¶å†µï¼š**
- âŒ æ“ä½œåˆ—ä¸­æ²¡æœ‰åˆ é™¤æŒ‰é’®
- âŒ æ²¡æœ‰ `handleDelete` æ–¹æ³•
- âŒ åç«¯DELETE APIç«¯ç‚¹ä¸å­˜åœ¨ï¼ˆè§2.1.3èŠ‚ï¼‰

**å®ç°æ–¹æ¡ˆï¼š**

```tsx
// frontend/src/pages/RetailPackagePage.tsx

import DeleteIcon from '@mui/icons-material/Delete';
import { Dialog, DialogTitle, DialogContent, DialogContentText, DialogActions } from '@mui/material';

const RetailPackagePage: React.FC = () => {
  // ... ç°æœ‰çŠ¶æ€ ...

  const [deleteDialogOpen, setDeleteDialogOpen] = useState(false);
  const [packageToDelete, setPackageToDelete] = useState<string | null>(null);
  const [deleteError, setDeleteError] = useState<string | null>(null);

  // æ‰“å¼€åˆ é™¤ç¡®è®¤å¯¹è¯æ¡†
  const handleDeleteClick = (packageId: string) => {
    setPackageToDelete(packageId);
    setDeleteDialogOpen(true);
    setDeleteError(null);
  };

  // ç¡®è®¤åˆ é™¤
  const handleDeleteConfirm = async () => {
    if (!packageToDelete) return;

    try {
      await apiClient.delete(`/api/v1/retail-packages/${packageToDelete}`);
      setDeleteDialogOpen(false);
      setPackageToDelete(null);
      fetchPackages(); // åˆ·æ–°åˆ—è¡¨

      // TODO: æ˜¾ç¤ºæˆåŠŸæç¤ºï¼ˆSnackbarï¼‰
    } catch (error: any) {
      console.error("åˆ é™¤å¤±è´¥", error);
      const errorMsg = error.response?.data?.detail || "åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•";
      setDeleteError(errorMsg);
    }
  };

  // å–æ¶ˆåˆ é™¤
  const handleDeleteCancel = () => {
    setDeleteDialogOpen(false);
    setPackageToDelete(null);
    setDeleteError(null);
  };

  return (
    <Box>
      {/* ... ç°æœ‰å†…å®¹ ... */}

      {/* è¡¨æ ¼æ“ä½œåˆ— - æ¡Œé¢ç«¯ */}
      <TableCell align="right">
        <IconButton size="small" onClick={() => handleEdit(pkg.id)}>
          <EditIcon />
        </IconButton>
        <IconButton size="small" onClick={() => handleCopy(pkg.id)}>
          <ContentCopyIcon />
        </IconButton>
        <IconButton size="small" onClick={() => handleArchive(pkg.id)}>
          <ArchiveIcon />
        </IconButton>

        {/* æ–°å¢ï¼šåˆ é™¤æŒ‰é’®ï¼ˆä»…è‰ç¨¿å¯è§ï¼‰ */}
        {pkg.status === 'draft' && (
          <IconButton
            size="small"
            onClick={() => handleDeleteClick(pkg.id)}
            color="error"
          >
            <DeleteIcon />
          </IconButton>
        )}
      </TableCell>

      {/* ç§»åŠ¨ç«¯æ“ä½œæŒ‰é’® */}
      <Box sx={{ display: 'flex', justifyContent: 'flex-end', mt: 2 }}>
        {/* ... ç°æœ‰æŒ‰é’® ... */}

        {/* æ–°å¢ï¼šåˆ é™¤æŒ‰é’®ï¼ˆä»…è‰ç¨¿å¯è§ï¼‰ */}
        {pkg.status === 'draft' && (
          <IconButton
            size="small"
            onClick={() => handleDeleteClick(pkg.id)}
            color="error"
          >
            <DeleteIcon />
          </IconButton>
        )}
      </Box>

      {/* åˆ é™¤ç¡®è®¤å¯¹è¯æ¡† */}
      <Dialog
        open={deleteDialogOpen}
        onClose={handleDeleteCancel}
        aria-labelledby="delete-dialog-title"
      >
        <DialogTitle id="delete-dialog-title">ç¡®è®¤åˆ é™¤</DialogTitle>
        <DialogContent>
          <DialogContentText>
            ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¥—é¤å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚
          </DialogContentText>
          {deleteError && (
            <Alert severity="error" sx={{ mt: 2 }}>
              {deleteError}
            </Alert>
          )}
        </DialogContent>
        <DialogActions>
          <Button onClick={handleDeleteCancel}>å–æ¶ˆ</Button>
          <Button onClick={handleDeleteConfirm} color="error" variant="contained">
            åˆ é™¤
          </Button>
        </DialogActions>
      </Dialog>
    </Box>
  );
};
```

**ä¼˜å…ˆçº§ï¼š** ğŸ”´ é«˜ - æ ¸å¿ƒåŠŸèƒ½ç¼ºå¤±

---

### 3.2 æ“ä½œæŒ‰é’®ç¼ºå°‘çŠ¶æ€æœºæ§åˆ¶

**é—®é¢˜ä½ç½®ï¼š** `frontend/src/pages/RetailPackagePage.tsx:357-366`

**è®¾è®¡æ–‡æ¡£ä¾æ®ï¼š** ç¬¬8.2èŠ‚ - å‰ç«¯å¼•å¯¼ç”¨æˆ·æ‰§è¡Œåˆæ³•æ“ä½œ

**å½“å‰çŠ¶å†µï¼š** æ‰€æœ‰æŒ‰é’®éƒ½æ˜¯å¯ç”¨çŠ¶æ€ï¼Œæ²¡æœ‰æ ¹æ®çŠ¶æ€ç¦ç”¨

**å®ç°æ–¹æ¡ˆï¼š**

```tsx
// frontend/src/pages/RetailPackagePage.tsx

const RetailPackagePage: React.FC = () => {
  // ... ç°æœ‰ä»£ç  ...

  // çŠ¶æ€åˆ¤æ–­å‡½æ•°ï¼ˆæ ¹æ®çŠ¶æ€æœºè§„åˆ™ï¼‰
  const canEdit = (status: string) => status === 'draft';
  const canDelete = (status: string) => status === 'draft';
  const canActivate = (status: string) => status === 'draft';
  const canArchive = (status: string) => status === 'active';
  const canCopy = (status: string) => true; // æ‰€æœ‰çŠ¶æ€éƒ½èƒ½å¤åˆ¶

  return (
    <Box>
      {/* æ¡Œé¢ç«¯è¡¨æ ¼ */}
      <TableCell align="right">
        <Tooltip title={canEdit(pkg.status) ? "ç¼–è¾‘å¥—é¤" : "åªæœ‰è‰ç¨¿çŠ¶æ€æ‰èƒ½ç¼–è¾‘"}>
          <span> {/* Tooltipéœ€è¦åŒ…è£¹spanï¼Œå› ä¸ºdisabledçš„IconButtonä¸è§¦å‘hover */}
            <IconButton
              size="small"
              onClick={() => handleEdit(pkg.id)}
              disabled={!canEdit(pkg.status)}
            >
              <EditIcon />
            </IconButton>
          </span>
        </Tooltip>

        <Tooltip title="å¤åˆ¶å¥—é¤">
          <IconButton size="small" onClick={() => handleCopy(pkg.id)}>
            <ContentCopyIcon />
          </IconButton>
        </Tooltip>

        <Tooltip title={canArchive(pkg.status) ? "å½’æ¡£å¥—é¤" : "åªæœ‰ç”Ÿæ•ˆçŠ¶æ€æ‰èƒ½å½’æ¡£"}>
          <span>
            <IconButton
              size="small"
              onClick={() => handleArchive(pkg.id)}
              disabled={!canArchive(pkg.status)}
            >
              <ArchiveIcon />
            </IconButton>
          </span>
        </Tooltip>

        {pkg.status === 'draft' && (
          <Tooltip title="åˆ é™¤å¥—é¤">
            <IconButton
              size="small"
              onClick={() => handleDeleteClick(pkg.id)}
              color="error"
            >
              <DeleteIcon />
            </IconButton>
          </Tooltip>
        )}
      </TableCell>

      {/* ç§»åŠ¨ç«¯å¡ç‰‡ï¼ˆç±»ä¼¼å¤„ç†ï¼‰ */}
    </Box>
  );
};
```

**ä¼˜å…ˆçº§ï¼š** ğŸŸ¡ ä¸­ - UXæ”¹è¿›

---

### 3.3 UI/UXä¼˜åŒ–æœªå®ç°

**é—®é¢˜ä½ç½®ï¼š** å¤šä¸ªç»„ä»¶

**è®¾è®¡æ–‡æ¡£ä¾æ®ï¼š** ç¬¬2.1.3èŠ‚ - UI/UXä¼˜åŒ–

#### 3.3.1 æ“ä½œåé¦ˆ (Snackbar)

**å®ç°æ–¹æ¡ˆï¼š**

```tsx
// frontend/src/pages/RetailPackagePage.tsx

import { Snackbar, Alert } from '@mui/material';

const RetailPackagePage: React.FC = () => {
  const [snackbar, setSnackbar] = useState<{
    open: boolean;
    message: string;
    severity: 'success' | 'error' | 'info' | 'warning';
  }>({
    open: false,
    message: '',
    severity: 'success'
  });

  const showSnackbar = (message: string, severity: 'success' | 'error' = 'success') => {
    setSnackbar({ open: true, message, severity });
  };

  const handleSnackbarClose = () => {
    setSnackbar(prev => ({ ...prev, open: false }));
  };

  const handleSave = async (data: any, asDraft: boolean) => {
    try {
      // ... ä¿å­˜é€»è¾‘ ...
      showSnackbar(`å¥—é¤${editorMode === 'edit' ? 'æ›´æ–°' : 'åˆ›å»º'}æˆåŠŸ`, 'success');
    } catch (error: any) {
      showSnackbar(error.response?.data?.detail || 'æ“ä½œå¤±è´¥', 'error');
    }
  };

  const handleDeleteConfirm = async () => {
    try {
      // ... åˆ é™¤é€»è¾‘ ...
      showSnackbar('å¥—é¤åˆ é™¤æˆåŠŸ', 'success');
    } catch (error: any) {
      showSnackbar(error.response?.data?.detail || 'åˆ é™¤å¤±è´¥', 'error');
    }
  };

  const handleArchive = async (packageId: string) => {
    try {
      await apiClient.post(`/api/v1/retail-packages/${packageId}/archive`);
      fetchPackages();
      showSnackbar('å¥—é¤å½’æ¡£æˆåŠŸ', 'success');
    } catch (error: any) {
      showSnackbar(error.response?.data?.detail || 'å½’æ¡£å¤±è´¥', 'error');
    }
  };

  return (
    <Box>
      {/* ... ç°æœ‰å†…å®¹ ... */}

      {/* Snackbarç»„ä»¶ */}
      <Snackbar
        open={snackbar.open}
        autoHideDuration={3000}
        onClose={handleSnackbarClose}
        anchorOrigin={{ vertical: 'top', horizontal: 'center' }}
      >
        <Alert
          onClose={handleSnackbarClose}
          severity={snackbar.severity}
          sx={{ width: '100%' }}
        >
          {snackbar.message}
        </Alert>
      </Snackbar>
    </Box>
  );
};
```

#### 3.3.2 å½’æ¡£æ“ä½œäºŒæ¬¡ç¡®è®¤

**å®ç°æ–¹æ¡ˆï¼š**

```tsx
// frontend/src/pages/RetailPackagePage.tsx

const [archiveDialogOpen, setArchiveDialogOpen] = useState(false);
const [packageToArchive, setPackageToArchive] = useState<string | null>(null);

const handleArchiveClick = (packageId: string) => {
  setPackageToArchive(packageId);
  setArchiveDialogOpen(true);
};

const handleArchiveConfirm = async () => {
  if (!packageToArchive) return;

  try {
    await apiClient.post(`/api/v1/retail-packages/${packageToArchive}/archive`);
    setArchiveDialogOpen(false);
    setPackageToArchive(null);
    fetchPackages();
    showSnackbar('å¥—é¤å½’æ¡£æˆåŠŸ', 'success');
  } catch (error: any) {
    showSnackbar(error.response?.data?.detail || 'å½’æ¡£å¤±è´¥', 'error');
  }
};

return (
  <Box>
    {/* ... */}

    {/* å½’æ¡£ç¡®è®¤å¯¹è¯æ¡† */}
    <Dialog
      open={archiveDialogOpen}
      onClose={() => setArchiveDialogOpen(false)}
    >
      <DialogTitle>ç¡®è®¤å½’æ¡£</DialogTitle>
      <DialogContent>
        <DialogContentText>
          å½’æ¡£åçš„å¥—é¤å°†ä¸èƒ½å†ç¼–è¾‘æˆ–æ¿€æ´»ï¼Œç¡®å®šè¦å½’æ¡£å—ï¼Ÿ
        </DialogContentText>
      </DialogContent>
      <DialogActions>
        <Button onClick={() => setArchiveDialogOpen(false)}>å–æ¶ˆ</Button>
        <Button onClick={handleArchiveConfirm} color="warning" variant="contained">
          å½’æ¡£
        </Button>
      </DialogActions>
    </Dialog>
  </Box>
);
```

**ä¼˜å…ˆçº§ï¼š** ğŸŸ¡ ä¸­ - ç”¨æˆ·ä½“éªŒ

---

### 3.4 ä»·æ ¼æ¯”ä¾‹è­¦å‘Šæç¤ºç¼ºå¤±

**é—®é¢˜ä½ç½®ï¼š** `frontend/src/components/PackageEditorDialog.tsx`

**è®¾è®¡æ–‡æ¡£ä¾æ®ï¼š** ç¬¬5.2èŠ‚ - å‰ç«¯æ ¡éªŒï¼ˆæµ®åŠ¨æ¯”ä¾‹æ ¡éªŒï¼‰

**å®ç°æ–¹æ¡ˆï¼š**

```tsx
// frontend/src/components/PackageEditorDialog.tsx

import { Alert } from '@mui/material';

const renderPricingModeSection = (control: Control<PackageFormData>) => {
  const pricingMode = watch('pricing_mode');
  const packageType = watch('package_type');
  const fixedPricingMethod = watch('fixed_linked_config.fixed_price.pricing_method');

  // ç›‘å¬è‡ªå®šä¹‰ä»·æ ¼å˜åŒ–
  const customPrices = watch('fixed_linked_config.fixed_price.custom_prices');

  // è®¡ç®—ä»·æ ¼æ¯”ä¾‹
  const calculateRatioCompliance = () => {
    if (!customPrices || !customPrices.flat || customPrices.flat === 0) {
      return { compliant: true, ratios: null };
    }

    const ratios = {
      high_to_flat: customPrices.high / customPrices.flat,
      valley_to_flat: customPrices.valley / customPrices.flat,
      deep_valley_to_flat: customPrices.deep_valley / customPrices.flat,
    };

    const STANDARD_RATIOS = {
      high_to_flat: 1.6,
      valley_to_flat: 0.4,
      deep_valley_to_flat: 0.3,
    };

    const compliant =
      Math.abs(ratios.high_to_flat - STANDARD_RATIOS.high_to_flat) < 0.01 &&
      Math.abs(ratios.valley_to_flat - STANDARD_RATIOS.valley_to_flat) < 0.01 &&
      Math.abs(ratios.deep_valley_to_flat - STANDARD_RATIOS.deep_valley_to_flat) < 0.01;

    return { compliant, ratios };
  };

  const { compliant, ratios } = calculateRatioCompliance();

  return (
    <Paper variant="outlined" sx={{ p: { xs: 1, sm: 2 }, mb: 2 }}>
      <Typography variant="h6" gutterBottom>å®šä»·æ¨¡å¼</Typography>
      <Grid container spacing={{ xs: 1, sm: 2 }}>
        {/* ... ç°æœ‰å®šä»·æ¨¡å¼é€‰æ‹© ... */}

        {pricingMode === 'fixed_linked' && (
          <Grid size={{ xs: 12 }}>
            <Paper variant="outlined" sx={{ p: { xs: 1, sm: 2 }, mt: 2 }}>
              <Typography variant="subtitle1" gutterBottom>å›ºå®š+è”åŠ¨å®šä»·é…ç½®</Typography>

              {/* ... ç°æœ‰è¡¨å•å­—æ®µ ... */}

              {/* æ–°å¢ï¼šä»·æ ¼æ¯”ä¾‹è­¦å‘Š */}
              {packageType === 'time_based' &&
               fixedPricingMethod === 'custom' &&
               ratios && !compliant && (
                <Grid size={{ xs: 12 }}>
                  <Alert severity="warning" sx={{ mt: 2 }}>
                    å½“å‰è‡ªå®šä¹‰ä»·æ ¼æ¯”ä¾‹ä¸æ»¡è¶³463å·æ–‡è¦æ±‚ï¼Œç»“ç®—æ—¶å°†è‡ªåŠ¨è°ƒæ•´ä¸ºæ ‡å‡†æ¯”ä¾‹ (1.6:1:0.4:0.3)ã€‚
                    <br />
                    <Typography variant="caption" sx={{ mt: 1, display: 'block' }}>
                      å½“å‰æ¯”ä¾‹ï¼šå³°/å¹³={ratios.high_to_flat.toFixed(2)},
                      è°·/å¹³={ratios.valley_to_flat.toFixed(2)},
                      æ·±è°·/å¹³={ratios.deep_valley_to_flat.toFixed(2)}
                    </Typography>
                  </Alert>
                </Grid>
              )}
            </Paper>
          </Grid>
        )}
      </Grid>
    </Paper>
  );
};
```

**ä¼˜å…ˆçº§ï¼š** ğŸŸ¡ ä¸­ - ä¸šåŠ¡è§„åˆ™æç¤º

---

### 3.5 å¥—é¤åç§°å”¯ä¸€æ€§é”™è¯¯å¤„ç†

**é—®é¢˜ä½ç½®ï¼š** `frontend/src/components/PackageEditorDialog.tsx`

**è®¾è®¡æ–‡æ¡£ä¾æ®ï¼š** ç¬¬5.2èŠ‚ - åœ¨å¯¹åº”è¡¨å•å­—æ®µä¸Šæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯

**å®ç°æ–¹æ¡ˆï¼š**

```tsx
// frontend/src/components/PackageEditorDialog.tsx

export const PackageEditorDialog: React.FC<PackageEditorDialogProps> = ({
  open, packageId, mode, onClose, onSave
}) => {
  const { control, handleSubmit, watch, reset, setError, clearErrors } = usePackageForm();
  const [loadingPackageData, setLoadingPackageData] = useState(false);
  const [saving, setSaving] = useState(false);

  // ä¿å­˜å¤„ç†
  const handleSaveClick = async (asDraft: boolean) => {
    handleSubmit(async (data: PackageFormData) => {
      setSaving(true);
      clearErrors(); // æ¸…é™¤ä¹‹å‰çš„é”™è¯¯

      try {
        await onSave(data, asDraft);
        // onSaveæˆåŠŸåä¼šå…³é—­å¯¹è¯æ¡†
      } catch (error: any) {
        // å¤„ç†409å†²çªé”™è¯¯
        if (error.response?.status === 409) {
          setError('package_name', {
            type: 'manual',
            message: 'å¥—é¤åç§°å·²å­˜åœ¨ï¼Œè¯·ä½¿ç”¨å…¶ä»–åç§°'
          });
        } else {
          // å…¶ä»–é”™è¯¯åœ¨çˆ¶ç»„ä»¶å¤„ç†ï¼ˆé€šè¿‡Snackbaræ˜¾ç¤ºï¼‰
          console.error('ä¿å­˜å¤±è´¥', error);
        }
      } finally {
        setSaving(false);
      }
    })();
  };

  // åŸºæœ¬ä¿¡æ¯éƒ¨åˆ†
  const renderBasicInfoSection = (control: Control<PackageFormData>) => (
    <Paper variant="outlined" sx={{ p: { xs: 1, sm: 2 }, mb: 2 }}>
      <Typography variant="h6" gutterBottom>åŸºæœ¬ä¿¡æ¯</Typography>
      <Grid container spacing={{ xs: 1, sm: 2 }}>
        <Grid size={{ xs: 12 }}>
          <Controller
            name="package_name"
            control={control}
            rules={{ required: 'å¥—é¤åç§°ä¸èƒ½ä¸ºç©º' }}
            render={({ field, fieldState: { error } }) => (
              <TextField
                {...field}
                label="å¥—é¤åç§°"
                fullWidth
                required
                error={!!error}
                helperText={error?.message}
                onChange={(e) => {
                  field.onChange(e);
                  clearErrors('package_name'); // è¾“å…¥æ—¶æ¸…é™¤é”™è¯¯
                }}
              />
            )}
          />
        </Grid>
        {/* ... å…¶ä»–å­—æ®µ ... */}
      </Grid>
    </Paper>
  );

  return (
    <Dialog open={open} onClose={onClose} fullScreen={isMobile} maxWidth="md" fullWidth>
      {/* ... DialogTitleå’ŒDialogContent ... */}

      <DialogActions>
        <Button onClick={onClose} disabled={loadingPackageData || saving}>
          å–æ¶ˆ
        </Button>
        <Button
          variant="outlined"
          onClick={() => handleSaveClick(true)}
          disabled={loadingPackageData || saving}
        >
          ä¿å­˜ä¸ºè‰ç¨¿
        </Button>
        <Button
          variant="contained"
          onClick={() => handleSaveClick(false)}
          disabled={loadingPackageData || saving}
        >
          {saving ? 'ä¿å­˜ä¸­...' : 'ä¿å­˜å¹¶ç”Ÿæ•ˆ'}
        </Button>
      </DialogActions>
    </Dialog>
  );
};
```

**ä¼˜å…ˆçº§ï¼š** ğŸŸ¡ ä¸­ - ç”¨æˆ·ä½“éªŒ

---

## ğŸ“… å››ã€å®ç°ä¼˜å…ˆçº§ä¸æ­¥éª¤è§„åˆ’

### é˜¶æ®µä¸€ï¼šæ ¸å¿ƒCRUDåŠŸèƒ½å®Œå–„ï¼ˆğŸ”´ é«˜ä¼˜å…ˆçº§ï¼‰

**é¢„ä¼°æ—¶é—´ï¼š4-6å°æ—¶**

#### æ­¥éª¤1ï¼šåç«¯Serviceå±‚è¡¥å…¨ï¼ˆ2å°æ—¶ï¼‰

- [ ] å®ç° `get_package_by_id()` æ–¹æ³•
- [ ] å®ç° `update_package()` æ–¹æ³•ï¼ˆå«çŠ¶æ€æ ¡éªŒï¼‰
- [ ] å®ç° `delete_package()` æ–¹æ³•ï¼ˆå«çŠ¶æ€æ ¡éªŒï¼‰
- [ ] å®ç° `copy_package()` æ–¹æ³•
- [ ] ä¿®å¤ `create_package()` è¿”å›å€¼é—®é¢˜

**å…³é”®æ–‡ä»¶ï¼š**
- `webapp/services/package_service.py`

#### æ­¥éª¤2ï¼šæ•°æ®æ¨¡å‹ä¿®å¤ï¼ˆ30åˆ†é’Ÿï¼‰

- [ ] æ·»åŠ  `ValidationResult` æ¨¡å‹
- [ ] åœ¨ `RetailPackage` ä¸­æ·»åŠ  `validation` å­—æ®µ
- [ ] æµ‹è¯•æ¨¡å‹åºåˆ—åŒ–/ååºåˆ—åŒ–

**å…³é”®æ–‡ä»¶ï¼š**
- `webapp/models/retail_package.py`

#### æ­¥éª¤3ï¼šåç«¯APIç«¯ç‚¹è¡¥å…¨ï¼ˆ1å°æ—¶ï¼‰

- [ ] æ·»åŠ  `GET /api/v1/retail-packages/{package_id}` ç«¯ç‚¹
- [ ] æ·»åŠ  `DELETE /api/v1/retail-packages/{package_id}` ç«¯ç‚¹
- [ ] å®Œå–„æ‰€æœ‰ç«¯ç‚¹çš„é”™è¯¯å¤„ç†ï¼ˆ409ã€400çŠ¶æ€ç ï¼‰
- [ ] æµ‹è¯•æ‰€æœ‰APIç«¯ç‚¹

**å…³é”®æ–‡ä»¶ï¼š**
- `webapp/api/v1_retail_packages.py`

#### æ­¥éª¤4ï¼šå‰ç«¯åˆ é™¤åŠŸèƒ½ï¼ˆ1.5å°æ—¶ï¼‰

- [ ] æ·»åŠ åˆ é™¤æŒ‰é’®ï¼ˆä»…è‰ç¨¿å¯è§ï¼‰
- [ ] å®ç°åˆ é™¤ç¡®è®¤å¯¹è¯æ¡†
- [ ] å®ç° `handleDelete` æ–¹æ³•
- [ ] æµ‹è¯•ç«¯åˆ°ç«¯åˆ é™¤æµç¨‹ï¼ˆæ¡Œé¢ç«¯+ç§»åŠ¨ç«¯ï¼‰

**å…³é”®æ–‡ä»¶ï¼š**
- `frontend/src/pages/RetailPackagePage.tsx`

#### æ­¥éª¤5ï¼šç«¯åˆ°ç«¯æµ‹è¯•ï¼ˆ1å°æ—¶ï¼‰

- [ ] æµ‹è¯•åˆ›å»ºå¥—é¤ï¼ˆè‰ç¨¿+ç”Ÿæ•ˆï¼‰
- [ ] æµ‹è¯•ç¼–è¾‘å¥—é¤
- [ ] æµ‹è¯•åˆ é™¤å¥—é¤
- [ ] æµ‹è¯•å¤åˆ¶å¥—é¤
- [ ] æµ‹è¯•è·å–è¯¦æƒ…

---

### é˜¶æ®µäºŒï¼šçŠ¶æ€æœºç®¡ç†ä¸æ ¡éªŒï¼ˆğŸŸ¡ ä¸­ä¼˜å…ˆçº§ï¼‰

**é¢„ä¼°æ—¶é—´ï¼š3-4å°æ—¶**

#### æ­¥éª¤6ï¼šåç«¯çŠ¶æ€æœºé€»è¾‘ï¼ˆ1.5å°æ—¶ï¼‰

- [ ] åœ¨ `change_status()` ä¸­å®ç°çŠ¶æ€è½¬æ¢çŸ©é˜µ
- [ ] åœ¨ `update_package()` ä¸­æ·»åŠ çŠ¶æ€æ£€æŸ¥ï¼ˆå·²åŒ…å«ï¼‰
- [ ] åœ¨ `delete_package()` ä¸­æ·»åŠ çŠ¶æ€æ£€æŸ¥ï¼ˆå·²åŒ…å«ï¼‰
- [ ] ç¼–å†™å•å…ƒæµ‹è¯•éªŒè¯æ‰€æœ‰éæ³•æ“ä½œè¢«æ‹’ç»

**å…³é”®æ–‡ä»¶ï¼š**
- `webapp/services/package_service.py`
- `tests/test_package_service.py`ï¼ˆæ–°å»ºï¼‰

#### æ­¥éª¤7ï¼šå¥—é¤åç§°å”¯ä¸€æ€§ï¼ˆ1å°æ—¶ï¼‰

- [ ] åˆ›å»ºMongoDBå”¯ä¸€ç´¢å¼•
- [ ] åœ¨Serviceå±‚æ•è· `DuplicateKeyError`
- [ ] APIå±‚è¿”å›409çŠ¶æ€ç 
- [ ] å‰ç«¯æ˜¾ç¤ºé”™è¯¯æç¤ºï¼ˆå·²åœ¨æ­¥éª¤3.5åŒ…å«ï¼‰

**å…³é”®æ–‡ä»¶ï¼š**
- MongoDBå‘½ä»¤è¡Œ
- `webapp/services/package_service.py`
- `webapp/api/v1_retail_packages.py`
- `frontend/src/components/PackageEditorDialog.tsx`

#### æ­¥éª¤8ï¼šä»·æ ¼æ¯”ä¾‹æ ¡éªŒé›†æˆï¼ˆ1å°æ—¶ï¼‰

- [ ] åœ¨ `create_package()` ä¸­è°ƒç”¨ `PricingEngine`
- [ ] åœ¨ `update_package()` ä¸­è°ƒç”¨ `PricingEngine`
- [ ] ä¿å­˜æ ¡éªŒç»“æœåˆ° `validation` å­—æ®µ
- [ ] å‰ç«¯æ˜¾ç¤ºè­¦å‘Šä¿¡æ¯ï¼ˆå®æ—¶è®¡ç®—ï¼‰

**å…³é”®æ–‡ä»¶ï¼š**
- `webapp/services/package_service.py`
- `frontend/src/components/PackageEditorDialog.tsx`

---

### é˜¶æ®µä¸‰ï¼šUI/UXä¼˜åŒ–ï¼ˆğŸŸ¡ ä¸­ä¼˜å…ˆçº§ï¼‰

**é¢„ä¼°æ—¶é—´ï¼š2-3å°æ—¶**

#### æ­¥éª¤9ï¼šæ“ä½œæŒ‰é’®çŠ¶æ€æ§åˆ¶ï¼ˆ1å°æ—¶ï¼‰

- [ ] å®ç°çŠ¶æ€åˆ¤æ–­å‡½æ•°
- [ ] æ ¹æ®çŠ¶æ€ç¦ç”¨æŒ‰é’®
- [ ] æ·»åŠ  Tooltip æç¤º
- [ ] æµ‹è¯•æ‰€æœ‰çŠ¶æ€ä¸‹çš„æŒ‰é’®æ˜¾ç¤º

**å…³é”®æ–‡ä»¶ï¼š**
- `frontend/src/pages/RetailPackagePage.tsx`

#### æ­¥éª¤10ï¼šç”¨æˆ·åé¦ˆæœºåˆ¶ï¼ˆ1-1.5å°æ—¶ï¼‰

- [ ] åˆ›å»ºå½’æ¡£ç¡®è®¤å¯¹è¯æ¡†
- [ ] é›†æˆ Snackbar å…¨å±€æç¤º
- [ ] æ‰€æœ‰æ“ä½œå®Œæˆåæ˜¾ç¤ºåé¦ˆ
- [ ] æµ‹è¯•æ‰€æœ‰æ“ä½œçš„åé¦ˆ

**å…³é”®æ–‡ä»¶ï¼š**
- `frontend/src/pages/RetailPackagePage.tsx`

#### æ­¥éª¤11ï¼šè¡¨å•æ ¡éªŒä¸é”™è¯¯å¤„ç†ï¼ˆ30åˆ†é’Ÿï¼‰

- [ ] å¥—é¤åç§°é‡åé”™è¯¯æ˜¾ç¤ºï¼ˆå·²åœ¨æ­¥éª¤7åŒ…å«ï¼‰
- [ ] ä»·æ ¼æ¯”ä¾‹è­¦å‘Šæç¤ºï¼ˆå·²åœ¨æ­¥éª¤8åŒ…å«ï¼‰
- [ ] è¡¨å•å¿…å¡«é¡¹æ ¡éªŒï¼ˆä½¿ç”¨react-hook-formçš„rulesï¼‰

**å…³é”®æ–‡ä»¶ï¼š**
- `frontend/src/components/PackageEditorDialog.tsx`
- `frontend/src/hooks/usePackageForm.ts`

---

### æ€»è®¡å·¥ä½œé‡

| é˜¶æ®µ | é¢„ä¼°æ—¶é—´ | å…³é”®äº§å‡º |
|------|---------|---------|
| é˜¶æ®µä¸€ | 4-6å°æ—¶ | å®Œæ•´çš„CRUDåŠŸèƒ½ |
| é˜¶æ®µäºŒ | 3-4å°æ—¶ | çŠ¶æ€æœºã€å”¯ä¸€æ€§ã€æ ¡éªŒ |
| é˜¶æ®µä¸‰ | 2-3å°æ—¶ | ä¼˜åŒ–çš„ç”¨æˆ·ä½“éªŒ |
| **æ€»è®¡** | **9-13å°æ—¶** | ç¬¦åˆV2è®¾è®¡çš„å®Œæ•´æ¨¡å— |

---

## âš ï¸ äº”ã€æŠ€æœ¯å€ºåŠ¡ä¸é£é™©æç¤º

### 5.1 æ¶æ„å±‚é¢

1. **å¼‚æ­¥æ–¹æ³•å£°æ˜ä¸ä¸€è‡´**
   - **é—®é¢˜ï¼š** PackageService çš„æ–¹æ³•æœªå£°æ˜ä¸º `async`ï¼Œä½†APIå±‚ä½¿ç”¨ `await` è°ƒç”¨
   - **å½±å“ï¼š** ä»£ç è¯­ä¹‰ä¸æ¸…æ™°ï¼Œå¯èƒ½å¯¼è‡´æ··æ·†
   - **å»ºè®®ï¼š** ç»Ÿä¸€ä¸ºå¼‚æ­¥æ–¹æ³•ï¼ˆå¦‚æœä½¿ç”¨å¼‚æ­¥æ•°æ®åº“é©±åŠ¨ï¼‰æˆ–ç§»é™¤ `await`

2. **ç¼ºå°‘äº‹åŠ¡æ”¯æŒ**
   - **é—®é¢˜ï¼š** å¤åˆ¶å¥—é¤ç­‰æ“ä½œæœªä½¿ç”¨äº‹åŠ¡
   - **å½±å“ï¼š** å¯èƒ½å¯¼è‡´æ•°æ®ä¸ä¸€è‡´ï¼ˆå¦‚å¤åˆ¶æ—¶åŸå¥—é¤è¢«åˆ é™¤ï¼‰
   - **å»ºè®®ï¼š** ä½¿ç”¨MongoDBäº‹åŠ¡ä¿è¯åŸå­æ€§

3. **é”™è¯¯å¤„ç†ä¸å¤Ÿç»†ç²’åº¦**
   - **é—®é¢˜ï¼š** ç»Ÿä¸€ä½¿ç”¨ `ValueError`ï¼Œéš¾ä»¥åŒºåˆ†ä¸åŒé”™è¯¯ç±»å‹
   - **å»ºè®®ï¼š** å®šä¹‰è‡ªå®šä¹‰å¼‚å¸¸ç±»ï¼ˆå¦‚ `PackageNotFoundError`, `StateTransitionError`ï¼‰

### 5.2 æµ‹è¯•è¦†ç›–

1. **ç¼ºå°‘å•å…ƒæµ‹è¯•**
   - **å½±å“ï¼š** çŠ¶æ€æœºé€»è¾‘å¤æ‚ï¼Œç¼ºå°‘æµ‹è¯•å®¹æ˜“å¼•å…¥bug
   - **å»ºè®®ï¼š** ä½¿ç”¨ pytest è¦†ç›–ä»¥ä¸‹åœºæ™¯ï¼š
     - æ‰€æœ‰åˆæ³•çš„çŠ¶æ€è½¬æ¢
     - æ‰€æœ‰éæ³•çš„çŠ¶æ€è½¬æ¢
     - åç§°å†²çªå¤„ç†
     - ä»·æ ¼æ¯”ä¾‹æ ¡éªŒ

2. **ç¼ºå°‘é›†æˆæµ‹è¯•**
   - **å»ºè®®ï¼š** æµ‹è¯•å®Œæ•´çš„ç«¯åˆ°ç«¯æµç¨‹ï¼ˆåˆ›å»ºâ†’ç¼–è¾‘â†’æ¿€æ´»â†’å½’æ¡£ï¼‰

### 5.3 å‰ç«¯ç±»å‹å®‰å…¨

1. **APIå“åº”ç±»å‹æœªå®šä¹‰**
   - **é—®é¢˜ï¼š** ä½¿ç”¨ `any` ç±»å‹ï¼Œå¤±å»TypeScriptçš„ç±»å‹æ£€æŸ¥
   - **å»ºè®®ï¼š** åˆ›å»º `types/retail-package.ts` å®šä¹‰å®Œæ•´çš„ç±»å‹

```typescript
// frontend/src/types/retail-package.ts

export interface RetailPackage {
  id: string;
  package_name: string;
  package_type: 'time_based' | 'non_time_based';
  pricing_mode: 'fixed_linked' | 'price_spread';
  // ... å…¶ä»–å­—æ®µ
  status: 'draft' | 'active' | 'archived';
  created_at: string;
  updated_at: string;
}

export interface PackageListResponse {
  total: number;
  page: number;
  page_size: number;
  items: RetailPackage[];
}
```

### 5.4 å›½é™…åŒ–

1. **é”™è¯¯ä¿¡æ¯ç¡¬ç¼–ç ä¸­æ–‡**
   - **å½±å“ï¼š** æœªæ¥æ‰©å±•æ—¶éœ€è¦å¤§é‡é‡æ„
   - **å»ºè®®ï¼š** è€ƒè™‘ä½¿ç”¨ i18n åº“ï¼ˆå¦‚æœæœ‰å¤šè¯­è¨€éœ€æ±‚ï¼‰

### 5.5 æ€§èƒ½ä¼˜åŒ–

1. **åˆ—è¡¨æŸ¥è¯¢ç¼ºå°‘ç´¢å¼•**
   - **å»ºè®®ï¼š** ä¸ºå¸¸ç”¨æŸ¥è¯¢å­—æ®µåˆ›å»ºç´¢å¼•ï¼š
     ```javascript
     db.retail_packages.createIndex({ "status": 1 });
     db.retail_packages.createIndex({ "package_type": 1 });
     db.retail_packages.createIndex({ "created_at": -1 });
     ```

2. **å‰ç«¯åˆ—è¡¨æœªå®ç°è™šæ‹Ÿæ»šåŠ¨**
   - **å½±å“ï¼š** å¤§é‡å¥—é¤æ—¶æ€§èƒ½ä¸‹é™
   - **å»ºè®®ï¼š** å·²ä½¿ç”¨åˆ†é¡µï¼Œæš‚æ—¶è¶³å¤Ÿï¼›æœªæ¥å¯è€ƒè™‘æ— é™æ»šåŠ¨

---

## ğŸ“Š å…­ã€éªŒæ”¶æ ‡å‡†

### 6.1 åŠŸèƒ½éªŒæ”¶

**åç«¯APIï¼š**
- [ ] æ‰€æœ‰9ä¸ªAPIç«¯ç‚¹æ­£å¸¸å·¥ä½œ
- [ ] çŠ¶æ€æœºè§„åˆ™æ­£ç¡®å®æ–½ï¼ˆéæ³•æ“ä½œè¿”å›400ï¼‰
- [ ] åç§°å†²çªæ­£ç¡®å¤„ç†ï¼ˆè¿”å›409ï¼‰
- [ ] æ‰€æœ‰é”™è¯¯è¿”å›åˆé€‚çš„HTTPçŠ¶æ€ç å’Œé”™è¯¯ä¿¡æ¯

**å‰ç«¯åŠŸèƒ½ï¼š**
- [ ] åˆ—è¡¨é¡µæ­£ç¡®æ˜¾ç¤ºæ‰€æœ‰å¥—é¤
- [ ] ç­›é€‰å’Œåˆ†é¡µåŠŸèƒ½æ­£å¸¸
- [ ] æ–°å»º/ç¼–è¾‘/å¤åˆ¶/åˆ é™¤/å½’æ¡£åŠŸèƒ½æ­£å¸¸
- [ ] æ“ä½œæŒ‰é’®æ ¹æ®çŠ¶æ€æ­£ç¡®å¯ç”¨/ç¦ç”¨
- [ ] åˆ é™¤å’Œå½’æ¡£æœ‰äºŒæ¬¡ç¡®è®¤
- [ ] æ‰€æœ‰æ“ä½œæœ‰æ˜ç¡®çš„æˆåŠŸ/å¤±è´¥åé¦ˆ

**æ ¡éªŒé€»è¾‘ï¼š**
- [ ] å¥—é¤åç§°é‡å¤æ—¶æç¤ºé”™è¯¯
- [ ] ä»·æ ¼æ¯”ä¾‹ä¸ç¬¦åˆæ—¶æ˜¾ç¤ºè­¦å‘Š
- [ ] éæ³•çŠ¶æ€è½¬æ¢è¢«é˜»æ­¢

### 6.2 ç”¨æˆ·ä½“éªŒéªŒæ”¶

- [ ] ç§»åŠ¨ç«¯å’Œæ¡Œé¢ç«¯å¸ƒå±€æ­£å¸¸
- [ ] æ‰€æœ‰å›¾æ ‡æŒ‰é’®æœ‰Tooltipæç¤º
- [ ] LoadingçŠ¶æ€æ¸…æ™°å¯è§
- [ ] é”™è¯¯ä¿¡æ¯æ˜ç¡®å…·ä½“
- [ ] æ“ä½œå“åº”åŠæ—¶ï¼ˆ<2ç§’ï¼‰

### 6.3 ä»£ç è´¨é‡éªŒæ”¶

- [ ] æ— TypeScriptç±»å‹é”™è¯¯
- [ ] æ— Pythonç±»å‹æ£€æŸ¥é”™è¯¯ï¼ˆå¦‚ä½¿ç”¨mypyï¼‰
- [ ] éµå¾ªé¡¹ç›®ä»£ç é£æ ¼
- [ ] å…³é”®é€»è¾‘æœ‰æ³¨é‡Šè¯´æ˜
- [ ] æ— æ˜æ˜¾çš„ä»£ç é‡å¤

---

## ğŸ¯ ä¸ƒã€ä¸‹ä¸€æ­¥è¡ŒåŠ¨å»ºè®®

åŸºäºä¸Šè¿°åˆ†æï¼Œå»ºè®®æŒ‰ä»¥ä¸‹é¡ºåºå®æ–½ï¼š

### ç«‹å³æ‰§è¡Œï¼ˆé˜»å¡æ€§é—®é¢˜ï¼‰

1. **ä¿®å¤æ•°æ®æ¨¡å‹** - æ·»åŠ  `ValidationResult` å’Œ `validation` å­—æ®µ
2. **å®ç°Serviceå±‚ç¼ºå¤±æ–¹æ³•** - 4ä¸ªæ ¸å¿ƒæ–¹æ³•
3. **æ·»åŠ ç¼ºå¤±çš„APIç«¯ç‚¹** - GETè¯¦æƒ…ã€DELETE

### é«˜ä¼˜å…ˆçº§ï¼ˆ1-2å¤©å†…ï¼‰

4. **å®ç°å‰ç«¯åˆ é™¤åŠŸèƒ½** - å®Œæ•´çš„ç«¯åˆ°ç«¯æµç¨‹
5. **å®ç°çŠ¶æ€æœºé€»è¾‘** - åç«¯å¼ºåˆ¶+å‰ç«¯å¼•å¯¼
6. **é›†æˆä»·æ ¼æ¯”ä¾‹æ ¡éªŒ** - åç«¯è®¡ç®—+å‰ç«¯æç¤º

### ä¸­ä¼˜å…ˆçº§ï¼ˆ1å‘¨å†…ï¼‰

7. **å®Œå–„UI/UX** - Tooltipã€Snackbarã€ç¡®è®¤å¯¹è¯æ¡†
8. **æ·»åŠ å•å…ƒæµ‹è¯•** - è¦†ç›–çŠ¶æ€æœºå’Œæ ¡éªŒé€»è¾‘
9. **ä¼˜åŒ–é”™è¯¯å¤„ç†** - ç»†ç²’åº¦å¼‚å¸¸+å‰ç«¯å‹å¥½æç¤º

### ä½ä¼˜å…ˆçº§ï¼ˆæœ‰æ—¶é—´å†åšï¼‰

10. **åˆ›å»ºTypeScriptç±»å‹å®šä¹‰** - æé«˜å‰ç«¯ç±»å‹å®‰å…¨
11. **æ·»åŠ MongoDBç´¢å¼•** - ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
12. **ç¼–å†™é›†æˆæµ‹è¯•** - ç«¯åˆ°ç«¯æµ‹è¯•è‡ªåŠ¨åŒ–

---

## ğŸ“ å…«ã€é™„å½•

### 8.1 ç›¸å…³æ–‡ä»¶æ¸…å•

**åç«¯æ–‡ä»¶ï¼š**
- `webapp/services/package_service.py` - æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
- `webapp/api/v1_retail_packages.py` - APIè·¯ç”±
- `webapp/models/retail_package.py` - æ•°æ®æ¨¡å‹
- `webapp/services/pricing_engine.py` - æ ¡éªŒå¼•æ“
- `webapp/main.py` - è·¯ç”±æ³¨å†Œ

**å‰ç«¯æ–‡ä»¶ï¼š**
- `frontend/src/pages/RetailPackagePage.tsx` - åˆ—è¡¨é¡µ
- `frontend/src/components/PackageEditorDialog.tsx` - ç¼–è¾‘è¡¨å•
- `frontend/src/hooks/usePackageForm.ts` - è¡¨å•Hook
- `frontend/src/api/client.ts` - APIå®¢æˆ·ç«¯

### 8.2 è®¾è®¡æ–‡æ¡£å‚è€ƒ

- é›¶å”®å¥—é¤ç®¡ç†æ¨¡å—è®¾è®¡æ–¹æ¡ˆ_v2.md - å®Œæ•´è®¾è®¡æ–‡æ¡£
- ç¬¬3.1èŠ‚ - æ•°æ®åº“è®¾è®¡
- ç¬¬4.1èŠ‚ - APIè®¾è®¡
- ç¬¬5.2èŠ‚ - å‰ç«¯ç»„ä»¶å®ç°ç­–ç•¥
- ç¬¬8èŠ‚ - çŠ¶æ€æœºç®¡ç†

### 8.3 Gitæäº¤å»ºè®®

å»ºè®®å°†å®ç°å·¥ä½œæ‹†åˆ†ä¸ºä»¥ä¸‹æäº¤ï¼š

1. `fix: æ·»åŠ RetailPackageçš„validationå­—æ®µä»¥ä¿®å¤è¿è¡Œæ—¶é”™è¯¯`
2. `feat: å®ç°PackageServiceçš„get/update/delete/copyæ–¹æ³•`
3. `feat: æ·»åŠ GETè¯¦æƒ…å’ŒDELETEå¥—é¤çš„APIç«¯ç‚¹`
4. `feat: å®ç°å‰ç«¯åˆ é™¤å¥—é¤åŠŸèƒ½ï¼ˆå«ç¡®è®¤å¯¹è¯æ¡†ï¼‰`
5. `feat: å®ç°çŠ¶æ€æœºç®¡ç†é€»è¾‘ï¼ˆåç«¯æ ¡éªŒ+å‰ç«¯æŒ‰é’®æ§åˆ¶ï¼‰`
6. `feat: é›†æˆå¥—é¤åç§°å”¯ä¸€æ€§æ ¡éªŒï¼ˆæ•°æ®åº“ç´¢å¼•+å‰ç«¯æç¤ºï¼‰`
7. `feat: é›†æˆä»·æ ¼æ¯”ä¾‹æ ¡éªŒï¼ˆåç«¯éªŒè¯+å‰ç«¯è­¦å‘Šï¼‰`
8. `feat: æ·»åŠ æ“ä½œåé¦ˆæœºåˆ¶ï¼ˆSnackbar+Tooltipï¼‰`
9. `test: æ·»åŠ çŠ¶æ€æœºå’Œæ ¡éªŒé€»è¾‘çš„å•å…ƒæµ‹è¯•`
10. `docs: æ›´æ–°é›¶å”®å¥—é¤ç®¡ç†æ¨¡å—æ–‡æ¡£`

---

**å®¡æŸ¥å®Œæˆæ—¥æœŸï¼š** 2025-11-05
**å®¡æŸ¥äººï¼š** Claude Code
**ä¸‹ä¸€æ­¥ï¼š** ç­‰å¾…å¼€å‘å›¢é˜Ÿç¡®è®¤å®æ–½è®¡åˆ’
