# 客户档案管理模块设计方案 v2

## 概述

基于项目设计规范和零售套餐页面的成功模式，设计客户档案管理模块的完整实现方案。采用单一集合数据库架构和前端单一分区显示模式，避免使用Tab标签页，简化用户操作流程。

---

## 1. 数据库设计：单一集合（嵌入式）

### 1.1 集合结构

**集合名称：** `customers`

此集合将合并 `user_profiles`、`meters` 和 `measure_point` 的信息，并扩展联系信息字段。

### 1.2 完整数据结构 (Schema v2)

```json
// "customers" 集合
{
  "_id": ObjectId(),

  // --- 客户基本信息 (来自 user_profiles + 扩展字段) ---
  "user_name": "丰城超胜塑业有限公司",
  "short_name": "超胜塑业",
  "user_type": "标准工商业",
  "industry": "制造业",
  "voltage": "10kV",
  "region": "宜春市",
  "district": "丰城市",
  "address": "丰城市工业园区...",
  "location": {
    "type": "Point",
    "coordinates": [ 115.78, 28.19 ]
  },

  // --- 新增联系信息字段 ---
  "contact_person": "张三",
  "contact_phone": "13800138000",

  // --- 状态管理 ---
  "status": "active",

  // --- 审计字段 ---
  "created_at": "2024-01-01T00:00:00Z",
  "updated_at": "2024-01-01T00:00:00Z",
  "created_by": "admin",
  "updated_by": "admin",

  // --- 嵌入的电力资产信息 ---
  "utility_accounts": [
    {
      "account_id": "3600581282967",
      "metering_points": [
        {
          "metering_point_id": "235904607",
          "allocation_percentage": 97.0,
          "meter": {
            "meter_id": "3630001201800010787577",
            "multiplier": 1.5,
          }
        },
        {
          "metering_point_id": "235904611",
          "allocation_percentage": 3.0,
          "meter": {
            "meter_id": "3630001201800010787577",
            "multiplier": 1.5,
          }
        }
      ]
    }
  ]
}
```

### 1.3 方案优缺点分析

**优点 (Pros):**
* **读取性能极高**：获取一个客户的**所有**档案信息只需要**一次数据库查询**
* **开发简单直观**：数据结构与业务对象和UI界面完全匹配
* **数据原子性**：对单个客户的修改在单个文档内完成，是原子操作
* **查询效率**：支持丰富的客户信息查询和筛选条件

**缺点 (Cons) - 小规模下可接受:**
* **数据冗余**：电表信息可能在多个计量点中重复存储
* **更新复杂度高**：更新电表信息需要在多个位置同步修改
* **查询灵活性差**：无法简单地查询所有电表列表

### 1.4 重要约束

**必须分离的数据**：
- `mp_load_curve` (计量点负荷曲线)
- `meter_data` (电表数据)
- `real_time_spot_price` (现货价格)
- `spot_settlement_period` (分时结算明细)

这些时间序列数据**绝对不能**嵌入到 `customers` 集合中。

---

## 2. 后端API设计

### 2.1 API路由结构

```python
# webapp/api/v1_customers.py
router = APIRouter(prefix="/api/v1/customers", tags=["Customers"])

# 标准CRUD操作
@router.get("")                    # 获取客户列表 (支持筛选分页)
@router.post("", status_code=201)  # 创建客户
@router.get("/{customer_id}")      # 获取客户详情
@router.put("/{customer_id}")      # 更新客户
@router.delete("/{customer_id}")   # 删除客户

# 嵌套资源管理
@router.post("/{customer_id}/accounts")              # 添加户号
@router.put("/{customer_id}/accounts/{account_id}")   # 更新户号
@router.delete("/{customer_id}/accounts/{account_id}") # 删除户号

@router.post("/{customer_id}/accounts/{account_id}/metering-points")  # 添加计量点
@router.put("/{customer_id}/accounts/{account_id}/metering-points/{mp_id}") # 更新计量点
@router.delete("/{customer_id}/accounts/{account_id}/metering-points/{mp_id}") # 删除计量点

# 数据一致性管理
@router.post("/meters/{meter_id}/sync-update")  # 同步更新电表信息
@router.get("/meter-info/{meter_id}")           # 获取电表信息(用于自动填充)
```

### 2.2 数据模型定义

```python
# webapp/models/customer.py
class BaseMongoModel(BaseModel):
    model_config = ConfigDict(
        populate_by_name=True,
        arbitrary_types_allowed=True
    )
    id: PyObjectId = Field(default_factory=PyObjectId, alias="_id")

class Meter(BaseModel):
    meter_id: str
    multiplier: float

class MeteringPoint(BaseModel):
    metering_point_id: str
    allocation_percentage: float = Field(ge=0, le=100)
    meter: Meter

class UtilityAccount(BaseModel):
    account_id: str
    metering_points: List[MeteringPoint] = Field(default_factory=list)

class CustomerCreate(BaseModel):
    user_name: str = Field(..., min_length=1)
    short_name: str = Field(..., min_length=1)
    user_type: Optional[str] = None
    industry: Optional[str] = None
    voltage: Optional[str] = None
    region: Optional[str] = None
    district: Optional[str] = None
    address: Optional[str] = None
    contact_person: Optional[str] = None
    contact_phone: Optional[str] = None
    tax_number: Optional[str] = None
    utility_accounts: List[UtilityAccount] = Field(default_factory=list)

class Customer(BaseMongoModel, CustomerCreate):
    status: Literal["active", "inactive", "deleted"] = "active"
    created_at: datetime = Field(default_factory=datetime.utcnow)
    updated_at: datetime = Field(default_factory=datetime.utcnow)
    created_by: Optional[str] = None
    updated_by: Optional[str] = None
```

---

## 3. 前端UI设计 v2（单一分区显示）

### 3.1 设计原则

基于项目设计规范和零售套餐页面的成功模式：
- **不使用Tab标签页**，采用单一分区显示
- **对话框模式**进行编辑操作
- **响应式设计**，移动端友好
- **遵循项目UI规范**

### 3.2 主页面：客户列表 (CustomerManagementPage)

#### 页面结构
```tsx
// 外层容器 (遵循设计规范)
<Box sx={{ width: '100%' }}>
  {/* 页面标题 */}
  <Breadcrumbs aria-label="breadcrumb" sx={{ mb: 2 }}>
    <Typography sx={{ fontSize: '1.2rem', fontWeight: 600 }}>
      系统管理
    </Typography>
    <Typography sx={{ fontSize: '1.2rem', fontWeight: 600 }}>
      客户档案管理
    </Typography>
  </Breadcrumbs>

  {/* 查询区域 */}
  <Paper variant="outlined" sx={{ p: { xs: 1, sm: 2 }, mb: 2 }}>
    {/* 搜索和筛选器 */}
  </Paper>

  {/* 列表区域 */}
  <Paper variant="outlined" sx={{ p: { xs: 1, sm: 2 } }}>
    {/* 响应式表格/卡片列表 */}
  </Paper>
</Box>
```

#### 查询区域功能
- **搜索框**：按客户全称、简称搜索（带搜索图标）
- **筛选器**：客户类型、行业、电压等级、地区、状态下拉菜单
- **操作按钮**：刷新、重置筛选条件、新增客户

#### 列表显示
- **桌面端**：响应式表格
- **移动端**：卡片式布局
- **分页控件**：支持每页数量调整

#### 表格列定义
| 列名 | 字段 | 说明 |
|------|------|------|
| 客户全称 | `user_name` | 主链接，点击查看详情 |
| 客户类型 | `user_type` | 下拉选择 |
| 行业 | `industry` | 文本显示 |
| 电压等级 | `voltage` | 文本显示 |
| 地区 | `region` | 文本显示 |
| 户号数量 | `utility_accounts.length` | 计算值 |
| 状态 | `status` | Chip显示（正常/停用） |
| 更新时间 | `updated_at` | 格式化显示 |
| 操作 | - | 编辑、复制、删除按钮 |

### 3.3 客户编辑对话框 (CustomerEditorDialog)

#### 对话框特性
- **尺寸**：`maxWidth="md"` 宽屏显示
- **行为**：阻止外部点击关闭（`disableEnforceFocus`）
- **模式**：支持新建、编辑、复制三种模式

#### 分区显示结构

##### 分区 1: 客户基本信息（默认展开）
```tsx
<Accordion defaultExpanded>
  <AccordionSummary expandIcon={<ExpandMoreIcon />}>
    <Typography variant="h6">客户基本信息</Typography>
  </AccordionSummary>
  <AccordionDetails>
    <Grid container spacing={{ xs: 1, sm: 2 }}>
      <Grid size={{ xs: 12, md: 6 }}>
        <TextField fullWidth label="客户全称" required />
      </Grid>
      <Grid size={{ xs: 12, md: 6 }}>
        <TextField fullWidth label="客户简称" required />
      </Grid>
      {/* 其他基本信息字段... */}
    </Grid>
  </AccordionDetails>
</Accordion>
```

**字段列表**：
- 客户全称（必填）
- 客户简称（必填）
- 客户类型（下拉选择）
- 行业（下拉选择）
- 电压等级（下拉选择）
- 地区（文本输入）
- 区县（文本输入）
- 详细地址（多行文本）
- 状态（下拉选择）

##### 分区 2: 联系信息（可折叠）
```tsx
<Accordion>
  <AccordionSummary expandIcon={<ExpandMoreIcon />}>
    <Typography variant="h6">联系信息</Typography>
  </AccordionSummary>
  <AccordionDetails>
    <Grid container spacing={{ xs: 1, sm: 2 }}>
      {/* 联系信息字段... */}
    </Grid>
  </AccordionDetails>
</Accordion>
```

**字段列表**：
- 联系人、联系电话、联系邮箱
- 开票联系人、开票电话、开票邮箱
- 税号

##### 分区 3: 户号与计量点管理（可折叠）
```tsx
<Accordion>
  <AccordionSummary expandIcon={<ExpandMoreIcon />}>
    <Typography variant="h6">户号与计量点</Typography>
  </AccordionSummary>
  <AccordionDetails>
    {/* 户号列表管理 */}
  </AccordionDetails>
</Accordion>
```

### 3.4 户号管理对话框

#### 添加户号对话框
- **户号**：必填文本输入

#### 户号卡片显示
每个户号显示为一张卡片，包含：
- 户号信息展示
- 计量点表格
- 添加计量点、删除户号按钮

### 3.5 计量点管理对话框

#### 表单字段
- **计量点ID**：必填文本输入

#### 电表信息
- **电表资产号**：必填文本输入
- **倍率**：数字输入

- **分摊比例(%)**：数字输入（0-100）

### 3.6 客户详情对话框

只读查看客户完整信息，包含三个分区的展示内容和操作按钮（编辑、复制、关闭）。

---

## 4. 数据一致性管理功能

### 4.1 智能辅助功能

#### 自动填充
- **触发时机**：用户在电表资产号字段输入时
- **检测逻辑**：在当前客户文档中搜索该电表资产号
- **自动填充**：如果找到匹配项，自动填充倍率、电表类型等信息
- **提示信息**：显示"ⓘ 检测到该电表已在别处使用 (倍率 1.5)，已自动填充"

#### 同步更新确认
- **触发时机**：用户修改已有电表信息时
- **检测逻辑**：检查该电表在客户文档中的使用次数
- **确认对话框**：
  > **同步更新？**
  >
  > 您修改了电表 `{meter_id}` 的倍率。该电表在此客户名下共被 `{count}` 个计量点使用。
  >
  > * `[ (•) 仅更新此计量点 ]` (可能导致数据不一致)
  > * `[ ( ) 同步更新所有 {count} 个计量点 ]` (推荐)
  >
  > **[ 确认 ]** **[ 取消 ]**

### 4.2 重复检测

实时检测以下字段的重复：
- 客户全称（全局唯一）
- 户号（客户内唯一）
- 计量点ID（户号内唯一）
- 电表资产号（支持重复，但需要同步管理）

---

## 5. 响应式设计规范

### 5.1 移动端适配
- **查询区域**：筛选器垂直排列，搜索框全宽
- **列表区域**：使用卡片式布局替代表格
- **对话框**：全屏显示，确保操作体验
- **字体大小**：移动端使用较小字体（`xs: 0.75rem`）
- **间距调整**：移动端减小内边距（`xs: 1`）

### 5.2 交互体验
- **加载状态**：数据加载时显示 `CircularProgress`
- **空状态**：无数据时显示友好提示
- **错误处理**：统一的 `Snackbar` 错误提示
- **操作反馈**：所有操作成功后显示成功提示

### 5.3 状态管理
- **客户状态机**：正常 → 停用 → 已删除
- **操作权限控制**：根据状态动态控制按钮可用性
- **Tooltip提示**：显示按钮禁用原因

---

## 6. 删除确认机制

### 6.1 删除客户确认
- **确认对话框**：显示删除影响范围
- **提示内容**："确定要删除客户「{客户名称}」吗？删除后将同时删除其所有户号和计量点信息，此操作不可恢复。"

### 6.2 删除户号确认
- **提示内容**："确定要删除户号 {户号} 吗？删除后将同时删除其所有计量点信息。"

### 6.3 删除计量点确认
- **提示内容**："确定要删除计量点 {计量点ID} 吗？"

---

## 7. 实施计划

### 7.1 开发阶段

#### 阶段1：基础CRUD功能（1周）
- 后端数据模型和API
- 前端客户列表页面
- 基本信息编辑功能

#### 阶段2：联系信息扩展（0.5周）
- 联系信息字段添加
- 表单验证和UI优化

#### 阶段3：嵌套数据管理（1.5周）
- 户号管理功能
- 计量点管理功能
- 数据关联关系处理

#### 阶段4：数据一致性功能（1周）
- 智能辅助功能
- 同步更新机制
- 重复检测逻辑

#### 阶段5：测试和优化（0.5周）
- 功能测试
- 性能优化
- 用户体验优化

### 7.2 关键里程碑
- **Week 1**：基础功能上线
- **Week 2**：完整编辑功能
- **Week 3**：高级管理功能
- **Week 4**：数据一致性保障

### 7.3 风险控制
- **数据一致性风险**：通过智能辅助和同步更新机制降低
- **性能风险**：数据库索引优化，查询性能测试
- **用户体验风险**：严格遵循项目UI设计规范

---

## 8. 技术规范

### 8.1 代码规范
- **后端**：遵循PEP 8规范，使用类型提示
- **前端**：使用TypeScript，遵循Material-UI规范
- **命名**：使用语义化命名，保持一致性

### 8.2 测试要求
- **单元测试**：覆盖所有业务逻辑
- **集成测试**：API接口测试
- **UI测试**：关键用户流程测试

### 8.3 文档要求
- **API文档**：自动生成的OpenAPI文档
- **用户手册**：操作说明文档
- **开发文档**：代码注释和架构说明

---

## 结论

这个v2设计方案完全遵循项目现有技术架构和设计规范，采用零售套餐页面的成功模式，通过单一分区显示和对话框交互，提供流畅的用户体验和强大的数据管理能力。方案充分考虑了数据一致性问题，通过智能辅助功能有效降低了单一集合架构的风险，同时保持了开发和使用的简便性。