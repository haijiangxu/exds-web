# å®¢æˆ·æ¡£æ¡ˆç®¡ç†æ¨¡å—å¼€å‘è§„åˆ’ï¼ˆå®Œå–„ç‰ˆï¼‰

## é¡¹ç›®æ¦‚è¿°

åŸºäºé¡¹ç›®è®¾è®¡è§„èŒƒå’Œé›¶å”®å¥—é¤é¡µé¢çš„æˆåŠŸæ¨¡å¼ï¼Œå¼€å‘å®¢æˆ·æ¡£æ¡ˆç®¡ç†æ¨¡å—ã€‚é‡‡ç”¨å•ä¸€é›†åˆæ•°æ®åº“æ¶æ„å’Œå‰ç«¯å•ä¸€åˆ†åŒºæ˜¾ç¤ºæ¨¡å¼ï¼Œåˆ†4ä¸ªä¼šè¯å®Œæˆå¼€å‘ã€‚
è®¾è®¡æ–¹æ¡ˆè§ã€Šå®¢æˆ·æ¡£æ¡ˆç®¡ç†æ¨¡å—è®¾è®¡æ–¹æ¡ˆv2.mdã€‹

**æµ‹è¯•è´¦å·ä¿¡æ¯**ï¼š
- ç”¨æˆ·åï¼šadmin
- å¯†ç ï¼š!234qwer

---

## ä¼šè¯è§„åˆ’æ€»è§ˆ

| ä¼šè¯ | ä¸»è¦å†…å®¹ | é¢„è®¡å·¥æ—¶ | éªŒè¯é‡ç‚¹ |
|------|----------|----------|----------|
| ä¼šè¯1 | åç«¯åŸºç¡€æ¶æ„ | 2-3å°æ—¶ | APIåŸºç¡€åŠŸèƒ½æµ‹è¯• |
| ä¼šè¯2 | åµŒå¥—æ•°æ®ç®¡ç† | 2-3å°æ—¶ | å¤æ‚æ•°æ®æ“ä½œæµ‹è¯• |
| ä¼šè¯3 | å‰ç«¯åŸºç¡€åŠŸèƒ½ | 2-3å°æ—¶ | UIäº¤äº’æµ‹è¯• |
| ä¼šè¯4 | é«˜çº§åŠŸèƒ½å’Œé›†æˆ | 2-3å°æ—¶ | ç«¯åˆ°ç«¯æµ‹è¯• |


## ä¼šè¯ 1ï¼šåç«¯åŸºç¡€æ¶æ„ + éªŒè¯æµ‹è¯•

**ç›®æ ‡**ï¼šå®Œæˆåç«¯æ•°æ®æ¨¡å‹å’ŒåŸºç¡€APIï¼Œå¹¶å®ŒæˆéªŒè¯æµ‹è¯•

### å¼€å‘ä»»åŠ¡

1. **åˆ›å»ºåç«¯æ•°æ®æ¨¡å‹æ–‡ä»¶**ï¼š
   - æ–‡ä»¶ä½ç½®ï¼š`webapp/models/customer.py`
   - åŒ…å«ï¼š`Meter`ã€`MeteringPoint`ã€`UtilityAccount`ã€`CustomerCreate`ã€`Customer`ç­‰å®Œæ•´æ¨¡å‹å®šä¹‰
   - éµå¾ªé¡¹ç›®Pydanticæ¨¡å‹è§„èŒƒï¼Œä½¿ç”¨`PyObjectId`å¤„ç†MongoDB _id

2. **å®ç°åç«¯APIè·¯ç”±**ï¼š
   - æ–‡ä»¶ä½ç½®ï¼š`webapp/api/v1_customers.py`
   - å®ç°æ ‡å‡†CRUDæ“ä½œï¼š`GET /`ã€`POST /`ã€`GET /{id}`ã€`PUT /{id}`ã€`DELETE /{id}`
   - é›†æˆJWTè®¤è¯ï¼šä½¿ç”¨`Depends(get_current_active_user)`
   - æ·»åŠ é”™è¯¯å¤„ç†ï¼š`HTTPException`å’Œä¸šåŠ¡å¼‚å¸¸
   - å®ç°åˆ†é¡µæŸ¥è¯¢å’Œç­›é€‰åŠŸèƒ½

3. **åˆ›å»ºæ•°æ®åº“æœåŠ¡å±‚**ï¼š
   - æ–‡ä»¶ä½ç½®ï¼š`webapp/services/customer_service.py`
   - å®ç°`CustomerService`ç±»ï¼Œå°è£…æ•°æ®åº“æ“ä½œ
   - æ·»åŠ æ•°æ®éªŒè¯å’Œä¸šåŠ¡é€»è¾‘

4. **æ›´æ–°ä¸»è·¯ç”±**ï¼š
   - åœ¨`webapp/api/v1.py`ä¸­`include_router`æ–°çš„customerè·¯ç”±

### éªŒè¯æµ‹è¯•æ­¥éª¤

1. **å¯åŠ¨åç«¯æœåŠ¡**ï¼š
   ```bash
   cd webapp
   uvicorn main:app --reload --host 0.0.0.0 --port 8005
   ```

2. **è·å–JWT Token**ï¼š
   ```bash
   # ä½¿ç”¨curlè·å–token
   curl -X POST "http://127.0.0.1:8005/token" \
        -H "Content-Type: application/x-www-form-urlencoded" \
        -d "username=admin&password=!234qwer"
   ```

3. **APIåŠŸèƒ½æµ‹è¯•**ï¼š
   ```bash
   # è®¾ç½®tokenå˜é‡
   TOKEN="your_jwt_token_here"

   # 1. åˆ›å»ºå®¢æˆ·ï¼ˆæ ¹æ®è®¾è®¡æ–¹æ¡ˆv2ï¼‰
   curl -X POST "http://127.0.0.1:8005/api/v1/customers" \
        -H "Authorization: Bearer $TOKEN" \
        -H "Content-Type: application/json" \
        -d '{
          "user_name": "æµ‹è¯•å®¢æˆ·æœ‰é™å…¬å¸",
          "short_name": "æµ‹è¯•å®¢æˆ·",
          "user_type": "æ ‡å‡†å·¥å•†ä¸š",
          "industry": "åˆ¶é€ ä¸š",
          "voltage": "10kV",
          "region": "å—æ˜Œå¸‚",
          "district": "çº¢è°·æ»©åŒº",
          "address": "å—æ˜Œå¸‚çº¢è°·æ»©æ–°åŒº",
          "contact_person": "æå››",
          "contact_phone": "13900139000"
        }'

   # 2. è·å–å®¢æˆ·åˆ—è¡¨
   curl -X GET "http://127.0.0.1:8005/api/v1/customers" \
        -H "Authorization: Bearer $TOKEN"

   # 3. è·å–å®¢æˆ·è¯¦æƒ…ï¼ˆä½¿ç”¨è¿”å›çš„IDï¼‰
   curl -X GET "http://127.0.0.1:8005/api/v1/customers/{customer_id}" \
        -H "Authorization: Bearer $TOKEN"

   # 4. æ›´æ–°å®¢æˆ·
   curl -X PUT "http://127.0.0.1:8005/api/v1/customers/{customer_id}" \
        -H "Authorization: Bearer $TOKEN" \
        -H "Content-Type: application/json" \
        -d '{
          "user_name": "æµ‹è¯•å®¢æˆ·æœ‰é™å…¬å¸ï¼ˆå·²æ›´æ–°ï¼‰",
          "short_name": "æµ‹è¯•å®¢æˆ·",
          "user_type": "æ ‡å‡†å·¥å•†ä¸š",
          "industry": "åˆ¶é€ ä¸š",
          "voltage": "10kV",
          "region": "å®œæ˜¥å¸‚",
          "district": "ä¸°åŸå¸‚",
          "address": "å®œæ˜¥å¸‚ä¸°åŸå¸‚å·¥ä¸šå›­åŒº",
          "contact_person": "ç‹äº”",
          "contact_phone": "13700137000"
        }'

   # 5. åˆ é™¤å®¢æˆ·
   curl -X DELETE "http://127.0.0.1:8005/api/v1/customers/{customer_id}" \
        -H "Authorization: Bearer $TOKEN"
   ```

4. **è®¿é—®APIæ–‡æ¡£**ï¼š
   - æµè§ˆå™¨è®¿é—®ï¼šhttp://127.0.0.1:8005/docs
   - æµ‹è¯•æ‰€æœ‰APIç«¯ç‚¹çš„äº¤äº’å¼æ–‡æ¡£

5. **æ•°æ®åº“éªŒè¯**ï¼š
   - ä½¿ç”¨MongoDB Compassè¿æ¥æ•°æ®åº“
   - éªŒè¯`customers`é›†åˆä¸­çš„æ•°æ®ç»“æ„
   - æ£€æŸ¥ç´¢å¼•æ˜¯å¦æ­£ç¡®åˆ›å»º

---

## ä¼šè¯ 2ï¼šåµŒå¥—æ•°æ®ç®¡ç† + éªŒè¯æµ‹è¯•

**ç›®æ ‡**ï¼šå®Œæˆæˆ·å·å’Œè®¡é‡ç‚¹çš„åµŒå¥—æ•°æ®ç®¡ç†åŠŸèƒ½ï¼Œå¹¶å®ŒæˆéªŒè¯æµ‹è¯•

### å¼€å‘ä»»åŠ¡

1. **æ‰©å±•APIè·¯ç”±**ï¼š
   - æˆ·å·ç®¡ç†æ¥å£ï¼š
     - `POST /{customer_id}/accounts` - æ·»åŠ æˆ·å·
     - `PUT /{customer_id}/accounts/{account_id}` - æ›´æ–°æˆ·å·
     - `DELETE /{customer_id}/accounts/{account_id}` - åˆ é™¤æˆ·å·
   - è®¡é‡ç‚¹ç®¡ç†æ¥å£ï¼šæ·»åŠ ã€æ›´æ–°ã€åˆ é™¤è®¡é‡ç‚¹

2. **å®ç°æ•°æ®ä¸€è‡´æ€§ç®¡ç†**ï¼š
   - `POST /meters/{meter_id}/sync-update` - åŒæ­¥æ›´æ–°ç”µè¡¨ä¿¡æ¯
   - `GET /meter-info/{meter_id}` - è·å–ç”µè¡¨ä¿¡æ¯(ç”¨äºè‡ªåŠ¨å¡«å……)
   - å®ç°ç”µè¡¨é‡å¤æ£€æµ‹å’Œæ™ºèƒ½å¡«å……é€»è¾‘

3. **æ‰©å±•æœåŠ¡å±‚**ï¼š
   - åœ¨`CustomerService`ä¸­æ·»åŠ åµŒå¥—æ•°æ®æ“ä½œæ–¹æ³•
   - å®ç°å¤æ‚çš„æ•°æ®å…³è”ç®¡ç†
   - æ·»åŠ æ•°æ®å®Œæ•´æ€§éªŒè¯

4. **æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–**ï¼š
   - ä¸º`customers`é›†åˆåˆ›å»ºå¿…è¦çš„ç´¢å¼•
   - ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½

### éªŒè¯æµ‹è¯•æ­¥éª¤

1. **æµ‹è¯•æˆ·å·ç®¡ç†**ï¼š
   ```bash
   # 1. åˆ›å»ºå¸¦æˆ·å·çš„å®¢æˆ·ï¼ˆæ ¹æ®è®¾è®¡æ–¹æ¡ˆv2ï¼‰
   curl -X POST "http://127.0.0.1:8005/api/v1/customers" \
        -H "Authorization: Bearer $TOKEN" \
        -H "Content-Type: application/json" \
        -d '{
          "user_name": "ä¸°åŸè¶…èƒœå¡‘ä¸šæœ‰é™å…¬å¸",
          "short_name": "è¶…èƒœå¡‘ä¸š",
          "user_type": "æ ‡å‡†å·¥å•†ä¸š",
          "industry": "åˆ¶é€ ä¸š",
          "voltage": "10kV",
          "region": "å®œæ˜¥å¸‚",
          "district": "ä¸°åŸå¸‚",
          "address": "ä¸°åŸå¸‚å·¥ä¸šå›­åŒº",
          "contact_person": "å¼ ä¸‰",
          "contact_phone": "13800138000",
          "utility_accounts": [
            {
              "account_id": "3600581282967",
              "metering_points": [
                {
                  "metering_point_id": "235904607",
                  "allocation_percentage": 97.0,
                  "meter": {
                    "meter_id": "3630001201800010787577",
                    "multiplier": 1.5
                  }
                }
              ]
            }
          ]
        }'

   # 2. æ·»åŠ æˆ·å·
   curl -X POST "http://127.0.0.1:8005/api/v1/customers/{customer_id}/accounts" \
        -H "Authorization: Bearer $TOKEN" \
        -H "Content-Type: application/json" \
        -d '{
          "account_id": "3600581282968",
          "metering_points": []
        }'

   # 3. æ·»åŠ è®¡é‡ç‚¹
   curl -X POST "http://127.0.0.1:8005/api/v1/customers/{customer_id}/accounts/{account_id}/metering-points" \
        -H "Authorization: Bearer $TOKEN" \
        -H "Content-Type: application/json" \
        -d '{
          "metering_point_id": "235904611",
          "allocation_percentage": 100.0,
          "meter": {
            "meter_id": "3630001201800010787578",
            "multiplier": 2.0
          }
        }'
   ```

2. **æµ‹è¯•æ•°æ®ä¸€è‡´æ€§**ï¼š
   ```bash
   # 1. è·å–ç”µè¡¨ä¿¡æ¯
   curl -X GET "http://127.0.0.1:8005/api/v1/meter-info/3630001201800010787577" \
        -H "Authorization: Bearer $TOKEN"

   # 2. åŒæ­¥æ›´æ–°ç”µè¡¨ä¿¡æ¯
   curl -X POST "http://127.0.0.1:8005/api/v1/meters/3630001201800010787577/sync-update" \
        -H "Authorization: Bearer $TOKEN" \
        -H "Content-Type: application/json" \
        -d '{
          "multiplier": 2.0,
          "sync_all": true
        }'
   ```

3. **å¤æ‚æ•°æ®ç»“æ„æµ‹è¯•**ï¼š
   - åˆ›å»ºåŒ…å«å¤šä¸ªæˆ·å·ã€å¤šä¸ªè®¡é‡ç‚¹çš„å¤æ‚å®¢æˆ·
   - æµ‹è¯•åµŒå¥—æ•°æ®çš„å¢åˆ æ”¹æŸ¥
   - éªŒè¯æ•°æ®å…³è”å…³ç³»

---

## ä¼šè¯ 3ï¼šå‰ç«¯åŸºç¡€åŠŸèƒ½ + éªŒè¯æµ‹è¯•

**ç›®æ ‡**ï¼šå®Œæˆå‰ç«¯å®¢æˆ·åˆ—è¡¨å’ŒåŸºç¡€ç¼–è¾‘åŠŸèƒ½ï¼Œå¹¶å®ŒæˆéªŒè¯æµ‹è¯•

### å¼€å‘ä»»åŠ¡

1. **åˆ›å»ºå‰ç«¯APIå®¢æˆ·ç«¯**ï¼š
   - æ–‡ä»¶ä½ç½®ï¼š`frontend/src/api/customer.ts`
   - å®ç°æ‰€æœ‰APIè°ƒç”¨æ–¹æ³•ï¼Œéµå¾ªé¡¹ç›®`api/client.ts`çš„æ¨¡å¼
   - æ·»åŠ ç±»å‹å®šä¹‰å’Œé”™è¯¯å¤„ç†

2. **åˆ›å»ºå®¢æˆ·åˆ—è¡¨é¡µé¢**ï¼š
   - æ–‡ä»¶ä½ç½®ï¼š`frontend/src/pages/CustomerManagementPage.tsx`
   - éµå¾ªé¡¹ç›®å‰ç«¯é¡µé¢è®¾è®¡è§„èŒƒ
   - å®ç°æŸ¥è¯¢åŒºåŸŸï¼šæœç´¢æ¡†+ç­›é€‰å™¨
   - å®ç°å“åº”å¼è¡¨æ ¼/å¡ç‰‡åˆ—è¡¨
   - æ·»åŠ åˆ†é¡µåŠŸèƒ½

3. **åˆ›å»ºå®¢æˆ·ç¼–è¾‘å¯¹è¯æ¡†**ï¼š
   - æ–‡ä»¶ä½ç½®ï¼š`frontend/src/components/CustomerEditorDialog.tsx`
   - ä½¿ç”¨Accordionåˆ†åŒºæ˜¾ç¤ºï¼šåŸºæœ¬ä¿¡æ¯ã€è”ç³»ä¿¡æ¯ã€æˆ·å·è®¡é‡ç‚¹
   - å®ç°æ–°å»ºã€ç¼–è¾‘ã€å¤åˆ¶ä¸‰ç§æ¨¡å¼

4. **æ·»åŠ è·¯ç”±é…ç½®**ï¼š
   - æ›´æ–°`frontend/src/App.tsx`æ·»åŠ å®¢æˆ·ç®¡ç†è·¯ç”±
   - é›†æˆ`ProtectedRoute`æƒé™ä¿æŠ¤


### éªŒè¯æµ‹è¯•æ­¥éª¤

**é‡è¦**ï¼šåœ¨è¿›è¡Œå‰ç«¯å¼€å‘ä»»åŠ¡æ—¶ï¼Œåº”é»˜è®¤ä½¿ç”¨chrome-devtoolsè¿›è¡Œè°ƒè¯•ï¼Œç™»å½•å‰ç«¯ç½‘ç«™åœ°å€`http://localhost:3000`ï¼Œä»¥ç”¨æˆ·å`admin`å’Œå¯†ç `!234qwer`ç™»å½•ï¼Œé€šè¿‡è‡ªåŠ¨æ“ä½œåŠŸèƒ½é¡µé¢ï¼Œè·å–æµè§ˆå™¨ç½‘ç»œè¯·æ±‚å’Œæ§åˆ¶å°æ¶ˆæ¯ï¼Œä»¥ä¾¿è‡ªä¸»è¯Šæ–­ç¼–è¯‘é”™è¯¯ï¼š

1. **å¯åŠ¨å‰ç«¯æœåŠ¡**ï¼š
   **é‡è¦**ï¼šåœ¨å¼€å§‹å‰ç«¯å¼€å‘ä»»åŠ¡æ—¶ï¼Œåº”é¦–å…ˆåœ¨åå°å¯åŠ¨å¼€å‘æœåŠ¡å™¨ï¼Œå¹¶å°†æ—¥å¿—è¾“å‡ºåˆ°æŒ‡å®šæ–‡ä»¶ï¼Œä»¥ä¾¿è‡ªä¸»è¯Šæ–­ç¼–è¯‘é”™è¯¯ï¼š
   ```bash
      npm start --prefix frontend > tmp\frontend_dev.log 2>&1 &
   ```
   å½“é‡åˆ°ç¼–è¯‘é”™è¯¯æ—¶ï¼Œé¦–è¦è¡ŒåŠ¨æ˜¯è¯»å– `frontend_dev.log` æ–‡ä»¶å†…å®¹ä»¥è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯ï¼Œç„¶åè¿›è¡Œä¿®å¤ã€‚

   - ä¿®æ”¹å‰ç«¯ä»£ç åï¼Œä¸è¦é¢‘ç¹é‡å¯å‰ç«¯æœåŠ¡ï¼Œä¼˜å…ˆé€šè¿‡è¯»å–æ—¥å¿—æ£€æµ‹ç¼–è¯‘é”™è¯¯ï¼Œä¸è¡Œçš„è¯å†é€šè¿‡è¿è¡Œæ„å»ºæŒ‡ä»¤`npm run build --prefix frontend`ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰ç¼–è¯‘é”™è¯¯ï¼Œå¹¶è‡ªåŠ¨ä¿®å¤ã€‚


2. **ç™»å½•ç³»ç»Ÿ**ï¼š
   
   - è®¿é—®ï¼šhttp://localhost:3000
   - ä½¿ç”¨æµ‹è¯•è´¦å·ï¼šadmin / !234qwer

3. **é¡µé¢åŠŸèƒ½æµ‹è¯•**ï¼š
   - å¯¼èˆªåˆ°å®¢æˆ·æ¡£æ¡ˆç®¡ç†é¡µé¢
   - æµ‹è¯•é¡µé¢åŠ è½½æ˜¯å¦æ­£å¸¸
   - éªŒè¯é¢åŒ…å±‘å¯¼èˆªæ˜¾ç¤ºæ­£ç¡®

4. **åˆ—è¡¨åŠŸèƒ½æµ‹è¯•**ï¼š
   - éªŒè¯å®¢æˆ·åˆ—è¡¨æ­£å¸¸æ˜¾ç¤º
   - æµ‹è¯•æœç´¢åŠŸèƒ½ï¼šè¾“å…¥å®¢æˆ·åç§°æœç´¢
   - æµ‹è¯•ç­›é€‰åŠŸèƒ½ï¼šæŒ‰è¡Œä¸šã€åœ°åŒºç­‰ç­›é€‰
   - æµ‹è¯•åˆ†é¡µåŠŸèƒ½ï¼šåˆ‡æ¢é¡µç ã€è°ƒæ•´æ¯é¡µæ•°é‡
   - æµ‹è¯•æ–°å¢æŒ‰é’®åŠŸèƒ½

5. **ç¼–è¾‘åŠŸèƒ½æµ‹è¯•**ï¼š
   - ç‚¹å‡»"æ–°å¢å®¢æˆ·"æŒ‰é’®
   - å¡«å†™å®¢æˆ·åŸºæœ¬ä¿¡æ¯
   - ä¿å­˜å¹¶éªŒè¯æˆåŠŸæç¤º
   - ç¼–è¾‘ç°æœ‰å®¢æˆ·ä¿¡æ¯
   - æµ‹è¯•å¤åˆ¶å®¢æˆ·åŠŸèƒ½
   - æµ‹è¯•åˆ é™¤å®¢æˆ·åŠŸèƒ½

6. **å“åº”å¼è®¾è®¡æµ‹è¯•**ï¼š
   - ä½¿ç”¨Chrome DevToolsåˆ‡æ¢è®¾å¤‡è§†å›¾
   - æµ‹è¯•ç§»åŠ¨ç«¯å¸ƒå±€
   - éªŒè¯è§¦æ‘¸æ“ä½œ
   - æ£€æŸ¥å­—ä½“å¤§å°å’Œé—´è·é€‚é…

7. **æµè§ˆå™¨æ§åˆ¶å°æ£€æŸ¥**ï¼š
   - æ£€æŸ¥æ˜¯å¦æœ‰JavaScripté”™è¯¯
   - éªŒè¯APIè°ƒç”¨æ˜¯å¦æ­£å¸¸
   - æ£€æŸ¥ç½‘ç»œè¯·æ±‚çŠ¶æ€

---

## ä¼šè¯ 4ï¼šé«˜çº§åŠŸèƒ½å’Œé›†æˆæµ‹è¯•

**ç›®æ ‡**ï¼šå®Œæˆæ•°æ®ä¸€è‡´æ€§åŠŸèƒ½ã€æˆ·å·è®¡é‡ç‚¹ç®¡ç†å’Œå®Œæ•´çš„é›†æˆæµ‹è¯•

### å¼€å‘ä»»åŠ¡

1. **å®ç°æˆ·å·ç®¡ç†ç»„ä»¶**ï¼š
   - æ–‡ä»¶ä½ç½®ï¼š`frontend/src/components/AccountManagement.tsx`
   - æˆ·å·å¡ç‰‡åˆ—è¡¨æ˜¾ç¤º
   - æ·»åŠ æˆ·å·å¯¹è¯æ¡†ï¼š`AccountDialog.tsx`
   - åˆ é™¤æˆ·å·ç¡®è®¤åŠŸèƒ½

2. **å®ç°è®¡é‡ç‚¹ç®¡ç†ç»„ä»¶**ï¼š
   - æ–‡ä»¶ä½ç½®ï¼š`frontend/src/components/MeteringPointDialog.tsx`
   - è®¡é‡ç‚¹è¡¨å•ï¼šè®¡é‡ç‚¹IDã€åˆ†æ‘Šæ¯”ä¾‹ã€ç”µè¡¨ä¿¡æ¯
   - ç”µè¡¨æ™ºèƒ½å¡«å……åŠŸèƒ½
   - åŒæ­¥æ›´æ–°ç¡®è®¤å¯¹è¯æ¡†

3. **å®ç°æ•°æ®ä¸€è‡´æ€§åŠŸèƒ½**ï¼š
   - ç”µè¡¨èµ„äº§å·è¾“å…¥æ—¶çš„è‡ªåŠ¨æ£€æµ‹å’Œå¡«å……
   - ä¿®æ”¹ç”µè¡¨ä¿¡æ¯æ—¶çš„åŒæ­¥æ›´æ–°ç¡®è®¤
   - é‡å¤æ•°æ®æ£€æµ‹å’Œæç¤º

4. **åˆ›å»ºå®¢æˆ·è¯¦æƒ…å¯¹è¯æ¡†**ï¼š
   - æ–‡ä»¶ä½ç½®ï¼š`frontend/src/components/CustomerDetailsDialog.tsx`
   - åªè¯»æ˜¾ç¤ºå®¢æˆ·å®Œæ•´ä¿¡æ¯
   - æä¾›ç¼–è¾‘å’Œå¤åˆ¶å…¥å£

### éªŒè¯æµ‹è¯•æ­¥éª¤

1. **ç«¯åˆ°ç«¯åŠŸèƒ½æµ‹è¯•**ï¼š
   ```
   æµ‹è¯•åœºæ™¯1ï¼šå®Œæ•´å®¢æˆ·åˆ›å»ºæµç¨‹
   1. ç™»å½•ç³»ç»Ÿ
   2. å¯¼èˆªåˆ°å®¢æˆ·æ¡£æ¡ˆç®¡ç†
   3. ç‚¹å‡»"æ–°å¢å®¢æˆ·"
   4. å¡«å†™åŸºæœ¬ä¿¡æ¯ï¼ˆå®¢æˆ·åç§°ã€è¡Œä¸šã€ç”µå‹ç­‰ï¼‰
   5. å¡«å†™è”ç³»ä¿¡æ¯ï¼ˆè”ç³»äººã€ç”µè¯ã€é‚®ç®±ç­‰ï¼‰
   6. æ·»åŠ ç¬¬ä¸€ä¸ªæˆ·å·
   7. ä¸ºæˆ·å·æ·»åŠ è®¡é‡ç‚¹
   8. å¡«å†™ç”µè¡¨ä¿¡æ¯
   9. ä¿å­˜å¹¶éªŒè¯æˆåŠŸ

   æµ‹è¯•åœºæ™¯2ï¼šæ•°æ®ä¸€è‡´æ€§åŠŸèƒ½
   1. ç¼–è¾‘å·²å­˜åœ¨çš„å®¢æˆ·
   2. æ·»åŠ ç¬¬äºŒä¸ªæˆ·å·
   3. åœ¨ç¬¬äºŒä¸ªæˆ·å·ä¸­æ·»åŠ è®¡é‡ç‚¹
   4. ä½¿ç”¨ä¸ç¬¬ä¸€ä¸ªè®¡é‡ç‚¹ç›¸åŒçš„ç”µè¡¨èµ„äº§å·
   5. éªŒè¯è‡ªåŠ¨å¡«å……åŠŸèƒ½
   6. ä¿®æ”¹ç”µè¡¨å€ç‡
   7. éªŒè¯åŒæ­¥æ›´æ–°ç¡®è®¤å¯¹è¯æ¡†
   8. é€‰æ‹©åŒæ­¥æ›´æ–°æ‰€æœ‰è®¡é‡ç‚¹
   9. éªŒè¯æ•°æ®ä¸€è‡´æ€§
   ```

2. **é”™è¯¯å¤„ç†æµ‹è¯•**ï¼š
   - æµ‹è¯•å¿…å¡«å­—æ®µéªŒè¯
   - æµ‹è¯•é‡å¤æ•°æ®æ£€æµ‹
   - æµ‹è¯•ç½‘ç»œé”™è¯¯å¤„ç†
   - æµ‹è¯•æƒé™æ§åˆ¶
   - æµ‹è¯•è¾¹ç•Œå€¼è¾“å…¥

3. **æ€§èƒ½æµ‹è¯•**ï¼š
   - åˆ›å»ºå¤§é‡æµ‹è¯•æ•°æ®ï¼ˆ100+å®¢æˆ·ï¼‰
   - æµ‹è¯•åˆ—è¡¨åŠ è½½æ€§èƒ½
   - æµ‹è¯•æœç´¢å“åº”æ—¶é—´
   - æµ‹è¯•å¤æ‚ç¼–è¾‘æ“ä½œæ€§èƒ½

4. **å…¼å®¹æ€§æµ‹è¯•**ï¼š
   - Chromeæµè§ˆå™¨å®Œæ•´åŠŸèƒ½æµ‹è¯•
   - Firefoxæµè§ˆå™¨å…¼å®¹æ€§æµ‹è¯•
   - Safariæµè§ˆå™¨å…¼å®¹æ€§æµ‹è¯•
   - ç§»åŠ¨è®¾å¤‡æµ‹è¯•ï¼ˆiPhoneã€Androidï¼‰

5. **é›†æˆæµ‹è¯•è„šæœ¬**ï¼š
   ```bash
   # è¿è¡Œå‰ç«¯æ„å»º
   cd frontend
   npm run build

   # æ£€æŸ¥æ„å»ºç»“æœ
   # éªŒè¯æ˜¯å¦æœ‰ç¼–è¯‘é”™è¯¯æˆ–è­¦å‘Š

   # å¯åŠ¨ç”Ÿäº§ç¯å¢ƒæµ‹è¯•
   npm serve -s build
   ```

6. **æœ€ç»ˆéªŒæ”¶æ ‡å‡†**ï¼š
   - [ ] æ‰€æœ‰CRUDæ“ä½œæ­£å¸¸å·¥ä½œ
   - [ ] æ•°æ®ä¸€è‡´æ€§åŠŸèƒ½æ­£å¸¸
   - [ ] å“åº”å¼è®¾è®¡åœ¨æ‰€æœ‰è®¾å¤‡ä¸Šæ­£å¸¸
   - [ ] æ— JavaScripté”™è¯¯æˆ–è­¦å‘Š
   - [ ] APIå“åº”æ—¶é—´ < 2ç§’
   - [ ] ç§»åŠ¨ç«¯ä½“éªŒæµç•…
   - [ ] ä»£ç ç¬¦åˆé¡¹ç›®è§„èŒƒ
   - [ ] æ–‡æ¡£å®Œæ•´

---

## å¼€å‘ç¯å¢ƒå’Œå·¥å…·

### å¿…éœ€å·¥å…·
- **åç«¯**ï¼šPython 3.8+, MongoDB, uvicorn
- **å‰ç«¯**ï¼šNode.js, npm, React 18+
- **æµ‹è¯•**ï¼šChrome DevTools, MongoDB Compass
- **APIæµ‹è¯•**ï¼šcurl, Postmanï¼ˆå¯é€‰ï¼‰

### å¼€å‘å‘½ä»¤é€ŸæŸ¥

```bash
# åç«¯å¼€å‘

ä¸ºäº†æé«˜è°ƒè¯•æ•ˆç‡ï¼Œæˆ‘å°†é‡‡ç”¨ä»¥ä¸‹è‡ªåŠ¨åŒ–æµç¨‹æ¥ç®¡ç†åç«¯ `uvicorn` æœåŠ¡å™¨ï¼š

1.  **å¯åŠ¨æœåŠ¡å™¨**:
    - æˆ‘å°†ä½¿ç”¨ PowerShell çš„ `Start-Process` å‘½ä»¤åœ¨åå°å¯åŠ¨ `uvicorn` æœåŠ¡å™¨ã€‚
    - å‘½ä»¤ç¤ºä¾‹: `Start-Process uvicorn -ArgumentList "webapp.main:app", "--reload", "--host", "0.0.0.0", "--port", "8005" -NoNewWindow -RedirectStandardOutput "d:\Gitworks\exds-web\tmp\uvicorn.out.log" -RedirectStandardError "d:\Gitworks\exds-web\tmp\uvicorn.err.log"`
    - æ‰€æœ‰åç«¯æ—¥å¿—ï¼ˆæ ‡å‡†è¾“å‡ºå’Œé”™è¯¯ï¼‰å°†è¢«é‡å®šå‘åˆ° `d:\Gitworks\exds-web\tmp\` ç›®å½•ä¸‹çš„ `uvicorn.out.log` å’Œ `uvicorn.err.log` æ–‡ä»¶ã€‚

2.  **ç›‘æ§æ—¥å¿—**:
    - å½“éœ€è¦æ£€æŸ¥åç«¯çŠ¶æ€æ—¶ï¼Œæˆ‘å°†è¯»å– `uvicorn.err.log` æ–‡ä»¶æ¥è‡ªåŠ¨è¯Šæ–­å¯åŠ¨æˆ–è¿è¡Œæ—¶çš„é”™è¯¯ã€‚

3.  **é‡å¯æœåŠ¡å™¨**:
    - å½“éœ€è¦é‡å¯æ—¶ï¼Œæˆ‘å°†æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š
        a. ä½¿ç”¨ `netstat -aon | findstr ":8005"` å‘½ä»¤æŸ¥æ‰¾æ­£åœ¨ç›‘å¬ `8005` ç«¯å£çš„è¿›ç¨‹PIDã€‚
        b. ä½¿ç”¨ `taskkill /F /PID <PID>` å‘½ä»¤ç»ˆæ­¢è¯¥è¿›ç¨‹ã€‚

# å‰ç«¯å¼€å‘
cd frontend
npm start

# å‰ç«¯æ„å»º
npm run build

# è·å–æµ‹è¯•Token
curl -X POST "http://127.0.0.1:8005/token" \
     -H "Content-Type: application/x-www-form-urlencoded" \
     -d "username=admin&password=!234qwer"
```

---

## æ³¨æ„äº‹é¡¹

### ğŸ”§ å¼€å‘è§„èŒƒå’Œå¼ºåˆ¶è¦æ±‚

**âš ï¸ é‡è¦æç¤ºï¼šå¼€å§‹å¼€å‘å‰å¿…é¡»é˜…è¯»ä»¥ä¸‹æ–‡æ¡£**

1. **è®¾è®¡æ–¹æ¡ˆ**ï¼š`docs/pages/å®¢æˆ·æ¡£æ¡ˆç®¡ç†/å®¢æˆ·æ¡£æ¡ˆç®¡ç†æ¨¡å—è®¾è®¡æ–¹æ¡ˆv2.md`
   - å¿…é¡»å®Œå…¨æŒ‰ç…§ v2 è®¾è®¡æ–¹æ¡ˆä¸­çš„å•ä¸€é›†åˆæ¶æ„å®æ–½
   - ä¸¥æ ¼æŒ‰ç…§ç¬¬ 2 èŠ‚çš„æ•°æ®æ¨¡å‹å®šä¹‰å®ç°
   - éµå¾ªç¬¬ 3 èŠ‚çš„å‰ç«¯UIè®¾è®¡è§„èŒƒï¼ˆå•ä¸€åˆ†åŒºæ˜¾ç¤ºï¼Œä¸ä½¿ç”¨Tabï¼‰

2. **å‰ç«¯é¡µé¢è®¾è®¡è§„èŒƒ**ï¼š`docs/å‰ç«¯é¡µé¢è®¾è®¡è§„èŒƒ.md`
   - **å¼ºåˆ¶éµå¾ª**ç¬¬ 1 èŠ‚é¡µé¢ç»“æ„è§„èŒƒï¼ˆå¤–å±‚å®¹å™¨ã€é¡µé¢æ ‡é¢˜ï¼‰
   - **å¼ºåˆ¶éµå¾ª**ç¬¬ 2 èŠ‚ç»„ä»¶æ ·å¼è§„èŒƒï¼ˆPaperã€Typographyã€Grid v7ï¼‰
   - **å¼ºåˆ¶éµå¾ª**ç¬¬ 4 èŠ‚å“åº”å¼è®¾è®¡è§„èŒƒï¼ˆç§»åŠ¨ç«¯ä¼˜å…ˆã€å…¨å±åŠŸèƒ½ï¼‰

3. **CLAUDE.md é¡¹ç›®æŒ‡å¯¼æ–‡æ¡£**
   - ä¸¥æ ¼éµå¾ªç¬¬ 4 èŠ‚ Material-UI Grid ç»„ä»¶è¯­æ³•ï¼ˆv7ç‰ˆæœ¬ï¼‰
   - ä¸¥æ ¼éµå¾ªç¬¬ 5 èŠ‚å›¾è¡¨æ¨ªå±å…¨å±åŠŸèƒ½è¦æ±‚
   - ä¸¥æ ¼éµå¾ªç¬¬ 6 èŠ‚ç§»åŠ¨ç«¯å“åº”å¼è®¾è®¡è§„èŒƒ
   - ä¸¥æ ¼éµå¾ªç¬¬ 7 èŠ‚ Tab ç»„ä»¶å¼€å‘æ¨¡æ¿ï¼ˆè™½ç„¶æ­¤æ¨¡å—ä¸ä½¿ç”¨Tabï¼Œä½†æ¨¡æ¿ä¸­çš„å¼€å‘æ¨¡å¼å¿…é¡»éµå¾ªï¼‰

#### ğŸ“‹ å¼ºåˆ¶æ€§å¼€å‘æ£€æŸ¥æ¸…å•

**åç«¯å¼€å‘**ï¼š
- [ ] ä½¿ç”¨ `webapp/tools.mongo.DATABASE` å…¨å±€å®ä¾‹è¿›è¡Œæ‰€æœ‰æ•°æ®åº“æ“ä½œ
- [ ] æ‰€æœ‰æ–°ä»£ç å¿…é¡»æ·»åŠ æ˜ç¡®çš„ Python ç±»å‹æç¤º
- [ ] éµå¾ª PEP 8 è§„èŒƒï¼Œä½¿ç”¨ `Black` æˆ– `Ruff` è¿›è¡Œæ ¼å¼åŒ–
- [ ] ä½¿ç”¨ `PyObjectId` å¤„ç† MongoDB _id å­—æ®µ
- [ ] æ‰€æœ‰ API è·¯ç”±å¿…é¡»é›†æˆ JWT è®¤è¯ï¼š`Depends(get_current_active_user)`
- [ ] ä½¿ç”¨ `HTTPException` å¤„ç†å®¢æˆ·ç«¯é”™è¯¯
- [ ] åœ¨ `webapp/api/v1.py` ä¸­ `include_router` æ–°çš„è·¯ç”±

**å‰ç«¯å¼€å‘**ï¼š
- [ ] é¡µé¢ç»“æ„ï¼šä½¿ç”¨ `<Box sx={{ width: '100%' }}>` ä½œä¸ºå¤–å±‚å®¹å™¨
- [ ] é¡µé¢æ ‡é¢˜ï¼šä½¿ç”¨ `Breadcrumbs`ï¼Œæ ·å¼ `fontSize: '1.2rem', fontWeight: 600`
- [ ] **ç¦æ­¢ä½¿ç”¨** `Container` ç»„ä»¶å’Œ `PageHeader` ç»„ä»¶
- [ ] Grid ç»„ä»¶ï¼šå¿…é¡»ä½¿ç”¨ `size` å±æ€§ï¼Œå¦‚ `<Grid size={{ xs: 12, md: 6 }}>`
- [ ] Paper æ ·å¼ï¼šTab å¯¼èˆªå®¹å™¨ä½¿ç”¨ `variant="outlined"`ï¼Œå›¾è¡¨è¡¨æ ¼å®¹å™¨ä½¿ç”¨é»˜è®¤æ ·å¼
- [ ] æ‰€æœ‰ API è¯·æ±‚å¿…é¡»é€šè¿‡ `frontend/src/api/client.ts` å‘å‡º
- [ ] ä½¿ç”¨ TypeScriptï¼Œç»„ä»¶å‘½å PascalCaseï¼Œå˜é‡å‡½æ•°ä½¿ç”¨ camelCase

**å“åº”å¼è®¾è®¡**ï¼š
- [ ] é‡‡ç”¨ç§»åŠ¨ç«¯ä¼˜å…ˆçš„å“åº”å¼è®¾è®¡
- [ ] ä½¿ç”¨ Material-UI æ ‡å‡†æ–­ç‚¹ï¼š`xs` (0px+)ã€`sm` (600px+)ã€`md` (900px+)ã€`lg` (1200px+)
- [ ] è¡¨æ ¼æ·»åŠ  `overflowX: 'auto'` ç¡®ä¿æ¨ªå‘æ»šåŠ¨
- [ ] å­—ä½“å¤§å°å“åº”å¼ï¼š`{ xs: '0.75rem', sm: '0.875rem' }`
- [ ] å†…è¾¹è·å“åº”å¼ï¼š`{ xs: 1, sm: 2 }`

**ä»£ç è´¨é‡**ï¼š
- [ ] éµå¾ªé¡¹ç›®å‘½åçº¦å®šï¼šåç«¯ `snake_case`ï¼Œå‰ç«¯ `camelCase`/`PascalCase`
- [ ] å®Œå–„çš„é”™è¯¯å¤„ç†å’Œç”¨æˆ·åé¦ˆ
- [ ] æ·»åŠ å¿…è¦çš„ä»£ç æ³¨é‡Šå’Œç±»å‹å®šä¹‰
- [ ] å‰ç«¯ä¿®æ”¹åè¿è¡Œ `npm run build --prefix frontend` æ£€æŸ¥ç¼–è¯‘é”™è¯¯

#### ğŸš« ä¸¥æ ¼ç¦æ­¢çš„é”™è¯¯åšæ³•

1. **åç«¯ç¦æ­¢**ï¼š
   - ç›´æ¥ä½¿ç”¨ MongoDB å®¢æˆ·ç«¯è€Œä¸é€šè¿‡ `DATABASE` å…¨å±€å®ä¾‹
   - ä¸æ·»åŠ ç±»å‹æç¤ºçš„ä»£ç 
   - ç¡¬ç¼–ç æ•°æ®åº“è¿æ¥ä¿¡æ¯

2. **å‰ç«¯ç¦æ­¢**ï¼š
   - ä½¿ç”¨ MUI v5 çš„ Grid è¯­æ³•ï¼š`<Grid item xs={12}>`
   - ä½¿ç”¨ `Container maxWidth="xl">` å®¹å™¨
   - å›¾è¡¨ä¸æ”¯æŒç§»åŠ¨ç«¯æ¨ªå±å…¨å±åŠŸèƒ½
   - ä¸ä½¿ç”¨é¡¹ç›®å†…ç½®çš„ Hooksï¼ˆå¦‚ `useChartFullscreen`ï¼‰

#### ğŸ“– å¿…è¯»å‚è€ƒç¤ºä¾‹

**åç«¯å‚è€ƒ**ï¼š
- `webapp/api/v1_retail_packages.py` - æ ‡å‡†çš„ CRUD API å®ç°
- `webapp/models/retail_package.py` - æ ‡å‡†çš„ Pydantic æ•°æ®æ¨¡å‹

**å‰ç«¯å‚è€ƒ**ï¼š
- `frontend/src/pages/LoadAnalysisPage.tsx` - Tab å¼å¯¼èˆªå¸ƒå±€æ ‡å‡†
- `frontend/src/pages/MarketPriceAnalysisPage.tsx` - å“åº”å¼è®¾è®¡æ ‡å‡†
- `frontend/src/pages/GridAgencyPricePage.tsx` - ä»ªè¡¨æ¿å¼å¸ƒå±€æ ‡å‡†

### æ•°æ®å®‰å…¨
1. **æƒé™æ§åˆ¶**ï¼šæ‰€æœ‰APIéœ€è¦JWTè®¤è¯
2. **è¾“å…¥éªŒè¯**ï¼šä¸¥æ ¼çš„æ•°æ®éªŒè¯å’Œæ¸…ç†
3. **æ•æ„Ÿä¿¡æ¯**ï¼šä¸åœ¨å‰ç«¯æš´éœ²æ•æ„Ÿæ•°æ®

### æµ‹è¯•é‡ç‚¹
1. **æ•°æ®ä¸€è‡´æ€§**ï¼šé‡ç‚¹å…³æ³¨ç”µè¡¨ä¿¡æ¯çš„åŒæ­¥æ›´æ–°
2. **ç”¨æˆ·ä½“éªŒ**ï¼šç¡®ä¿æ“ä½œæµç¨‹ç®€å•ç›´è§‚
3. **æ€§èƒ½è¡¨ç°**ï¼šå¤§æ•°æ®é‡ä¸‹çš„å“åº”é€Ÿåº¦
4. **å…¼å®¹æ€§**ï¼šå¤šæµè§ˆå™¨å’Œå¤šè®¾å¤‡æ”¯æŒ

---

## è¿›åº¦è·Ÿè¸ª

æ¯ä¸ªä¼šè¯å®Œæˆåï¼Œè¯·æ›´æ–°ä»¥ä¸‹è¿›åº¦è¡¨ï¼š

| ä¼šè¯ | å®ŒæˆçŠ¶æ€ | å®Œæˆæ—¥æœŸ | æµ‹è¯•ç»“æœ | å¤‡æ³¨ |
|------|----------|----------|----------|------|
| ä¼šè¯1 | â­• å¾…å¼€å§‹ | - | - | åç«¯åŸºç¡€æ¶æ„ |
| ä¼šè¯2 | â­• å¾…å¼€å§‹ | - | - | åµŒå¥—æ•°æ®ç®¡ç† |
| ä¼šè¯3 | â­• å¾…å¼€å§‹ | - | - | å‰ç«¯åŸºç¡€åŠŸèƒ½ |
| ä¼šè¯4 | â­• å¾…å¼€å§‹ | - | - | é«˜çº§åŠŸèƒ½å’Œé›†æˆ |

---

è¿™ä¸ªå®Œå–„çš„å¼€å‘è§„åˆ’ç¡®ä¿äº†æ¯ä¸ªé˜¶æ®µéƒ½æœ‰æ˜ç¡®çš„å¼€å‘ç›®æ ‡ã€è¯¦ç»†çš„éªŒè¯æ­¥éª¤å’Œå®Œæ•´çš„æµ‹è¯•æ ‡å‡†ï¼Œä¸ºé«˜è´¨é‡å®Œæˆå®¢æˆ·æ¡£æ¡ˆç®¡ç†æ¨¡å—æä¾›äº†åšå®çš„åŸºç¡€ã€‚




## æ•°æ®è¿ç§»ä»»åŠ¡

### è¿ç§»ç›®æ ‡
å°†åœ¨ä¼šè¯1å®Œæˆåï¼Œå°†ç°æœ‰æ•°æ®é›†`user_profiles`ã€`meters`ã€`measure_point`ä¸­çš„æ•°æ®è¿ç§»åˆ°æ–°çš„`customers`é›†åˆä¸­ã€‚

### è¿ç§»æ•°æ®æº
1. **user_profilesé›†åˆ**ï¼šå®¢æˆ·åŸºæœ¬ä¿¡æ¯
2. **metersé›†åˆ**ï¼šç”µè¡¨ä¿¡æ¯ï¼ˆå€ç‡ç­‰ï¼‰
3. **measure_pointé›†åˆ**ï¼šè®¡é‡ç‚¹ä¿¡æ¯
4. **user_hierarchy_final.json**ï¼šç”¨æˆ·å±‚çº§å…³ç³»æ•°æ®

### è¿ç§»è„šæœ¬
åœ¨ä¼šè¯1æµ‹è¯•å®Œæˆåï¼Œåˆ›å»ºä»¥ä¸‹è¿ç§»è„šæœ¬ï¼š

```python
# scripts/migrate_customer_data.py
import json
from datetime import datetime
from webapp.tools.mongo import DATABASE

def migrate_customer_data():
    """è¿ç§»å®¢æˆ·æ•°æ®åˆ°æ–°çš„customersé›†åˆ"""

    # 1. è¯»å–ç”¨æˆ·å±‚çº§å…³ç³»æ•°æ®
    with open('docs/pages/å®¢æˆ·æ¡£æ¡ˆç®¡ç†/user_hierarchy_final.json', 'r', encoding='utf-8') as f:
        user_hierarchy = json.load(f)

    # 2. è·å–ç”¨æˆ·æ¡£æ¡ˆæ•°æ®
    user_profiles = DATABASE['user_profiles'].find({})
    profiles_dict = {profile['user_name']: profile for profile in user_profiles}

    # 3. è·å–ç”µè¡¨æ•°æ®
    meters = DATABASE['meters'].find({})
    meters_dict = {meter['_id']: meter for meter in meters}

    # 4. è·å–è®¡é‡ç‚¹æ•°æ®
    measure_points = DATABASE['measure_point'].find({})
    measure_points_dict = {mp['_id']: mp for mp in measure_points}

    # 5. æ„å»ºå®¢æˆ·æ•°æ®
    customers = []

    for user_data in user_hierarchy:
        user_name = user_data['user_name']
        profile = profiles_dict.get(user_name, {})

        # æ„å»ºå®¢æˆ·åŸºæœ¬ä¿¡æ¯
        customer = {
            'user_name': user_name,
            'short_name': profile.get('short_name', user_name[:10]),
            'user_type': profile.get('user_type', 'æ ‡å‡†å·¥å•†ä¸š'),
            'industry': profile.get('industry', ''),
            'voltage': profile.get('voltage', ''),
            'region': profile.get('region', ''),
            'district': profile.get('district', ''),
            'address': profile.get('address', ''),
            'location': profile.get('location'),
            'contact_person': '',
            'contact_phone': '',
            'status': 'active',
            'created_at': datetime.utcnow(),
            'updated_at': datetime.utcnow(),
            'created_by': 'system_migration',
            'updated_by': 'system_migration',
            'utility_accounts': []
        }

        # æ„å»ºæˆ·å·å’Œè®¡é‡ç‚¹ä¿¡æ¯
        for account_data in user_data['utility_accounts']:
            account_id = account_data['account_id']

            utility_account = {
                'account_id': account_id,
                'metering_points': []
            }

            for mp_data in account_data['metering_points']:
                metering_point_id = mp_data['metering_point_id']
                meter_id = mp_data['meter_id']

                # è·å–ç”µè¡¨ä¿¡æ¯
                meter_info = meters_dict.get(meter_id, {})

                metering_point = {
                    'metering_point_id': metering_point_id,
                    'allocation_percentage': mp_data['allocation_percentage'],
                    'meter': {
                        'meter_id': meter_id,
                        'multiplier': meter_info.get('multiplier', 1.0),
                    }
                }

                utility_account['metering_points'].append(metering_point)

            customer['utility_accounts'].append(utility_account)

        customers.append(customer)

    # 6. æ’å…¥åˆ°customersé›†åˆ
    if customers:
        DATABASE['customers'].insert_many(customers)
        print(f"æˆåŠŸè¿ç§» {len(customers)} ä¸ªå®¢æˆ·æ•°æ®")
    else:
        print("æ²¡æœ‰æ‰¾åˆ°éœ€è¦è¿ç§»çš„æ•°æ®")

if __name__ == "__main__":
    migrate_customer_data()
```

### è¿ç§»éªŒè¯æ­¥éª¤

1. **è¿è¡Œè¿ç§»è„šæœ¬**ï¼š
   ```bash
   cd webapp
   python scripts/migrate_customer_data.py
   ```

2. **éªŒè¯æ•°æ®è¿ç§»**ï¼š
   ```bash
   # ä½¿ç”¨MongoDB CompassæŸ¥çœ‹customersé›†åˆ
   # éªŒè¯æ•°æ®ç»“æ„æ˜¯å¦æ­£ç¡®
   ```

3. **APIæµ‹è¯•éªŒè¯**ï¼š
   ```bash
   # è·å–JWT Token
   TOKEN=$(curl -s -X POST "http://127.0.0.1:8005/token" \
        -H "Content-Type: application/x-www-form-urlencoded" \
        -d "username=admin&password=!234qwer" | grep -o '"access_token":"[^"]*' | cut -d'"' -f4)

   # æµ‹è¯•è·å–å®¢æˆ·åˆ—è¡¨
   curl -X GET "http://127.0.0.1:8005/api/v1/customers" \
        -H "Authorization: Bearer $TOKEN"

   # æµ‹è¯•è·å–ç‰¹å®šå®¢æˆ·è¯¦æƒ…ï¼ˆä½¿ç”¨å·²çŸ¥çš„å®¢æˆ·IDï¼‰
   curl -X GET "http://127.0.0.1:8005/api/v1/customers/{customer_id}" \
        -H "Authorization: Bearer $TOKEN"
   ```

4. **æ•°æ®å®Œæ•´æ€§æ£€æŸ¥**ï¼š
   - æ£€æŸ¥å®¢æˆ·æ•°é‡æ˜¯å¦ä¸é¢„æœŸä¸€è‡´
   - éªŒè¯æˆ·å·å’Œè®¡é‡ç‚¹çš„å…³è”å…³ç³»
   - ç¡®è®¤ç”µè¡¨å€ç‡ä¿¡æ¯æ­£ç¡®è¿ç§»
   - æ£€æŸ¥åœ°ç†åæ ‡ä¿¡æ¯æ˜¯å¦ä¿ç•™

### è¿ç§»æ³¨æ„äº‹é¡¹

1. **å¤‡ä»½æ•°æ®**ï¼šè¿ç§»å‰å¤‡ä»½åŸå§‹é›†åˆ
2. **æ•°æ®æ¸…ç†**ï¼šæ£€æŸ¥å¹¶æ¸…ç†æ— æ•ˆæ•°æ®
3. **æ€§èƒ½è€ƒè™‘**ï¼šå¤§é‡æ•°æ®æ—¶åˆ†æ‰¹è¿ç§»
4. **é”™è¯¯å¤„ç†**ï¼šè®°å½•è¿ç§»è¿‡ç¨‹ä¸­çš„é”™è¯¯
5. **å›æ»šæ–¹æ¡ˆ**ï¼šå‡†å¤‡è¿ç§»å¤±è´¥æ—¶çš„å›æ»šç­–ç•¥

---