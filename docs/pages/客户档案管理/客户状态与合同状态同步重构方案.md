# å®¢æˆ·çŠ¶æ€ä¸åˆåŒçŠ¶æ€åŒæ­¥é‡æ„æ–¹æ¡ˆ

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**åˆ›å»ºæ—¥æœŸ**: 2025-11-12
**ä½œè€…**: Claude Code
**çŠ¶æ€**: å¾…å®æ–½

---

## ğŸ“‹ ç›®å½•

1. [èƒŒæ™¯ä¸é—®é¢˜åˆ†æ](#èƒŒæ™¯ä¸é—®é¢˜åˆ†æ)
2. [ç°çŠ¶æ¢³ç†](#ç°çŠ¶æ¢³ç†)
3. [é‡æ„ç›®æ ‡](#é‡æ„ç›®æ ‡)
4. [æŠ€æœ¯æ–¹æ¡ˆ](#æŠ€æœ¯æ–¹æ¡ˆ)
5. [å®æ–½è®¡åˆ’](#å®æ–½è®¡åˆ’)
6. [éªŒæ”¶æ ‡å‡†](#éªŒæ”¶æ ‡å‡†)
7. [é£é™©è¯„ä¼°](#é£é™©è¯„ä¼°)

---

## èƒŒæ™¯ä¸é—®é¢˜åˆ†æ

### æ ¸å¿ƒé—®é¢˜

å½“å‰ç³»ç»Ÿä¸­å®¢æˆ·çŠ¶æ€ä¸åˆåŒçŠ¶æ€ä¹‹é—´å­˜åœ¨ä»¥ä¸‹å…³é”®é—®é¢˜ï¼š

1. **ä¸šåŠ¡é€»è¾‘çŸ›ç›¾**
   - åˆ›å»ºåˆåŒæ—¶è¦æ±‚å®¢æˆ·çŠ¶æ€å¿…é¡»æ˜¯ `active`
   - ä½†æ–°å®¢æˆ·çš„æ­£å¸¸æµç¨‹æ˜¯ `prospect` â†’ `pending` â†’ `active`
   - å¯¼è‡´æ— æ³•ä¸ºæ–°å®¢æˆ·ç›´æ¥åˆ›å»ºåˆåŒ

2. **ç¼ºå¤±è‡ªåŠ¨åŒæ­¥æœºåˆ¶**
   - åˆåŒåˆ°æœŸï¼ˆactive â†’ expiredï¼‰æ—¶ï¼Œå®¢æˆ·çŠ¶æ€ä¸ä¼šè‡ªåŠ¨æ›´æ–°
   - åˆåŒç”Ÿæ•ˆï¼ˆpending â†’ activeï¼‰æ—¶ï¼Œå®¢æˆ·çŠ¶æ€ä¸ä¼šè‡ªåŠ¨æ›´æ–°
   - éœ€è¦æ‰‹åŠ¨è¿è¡Œè„šæœ¬ `fix_customer_status_by_contract.py` ä¿®æ­£

3. **æ•°æ®ä¸€è‡´æ€§é£é™©**
   - å®¢æˆ·çŠ¶æ€ä¸å®é™…ä¸šåŠ¡çŠ¶æ€å¯èƒ½ä¸ä¸€è‡´
   - å½±å“è´Ÿè·é¢„æµ‹ã€äº¤æ˜“å†³ç­–ç­‰ä¸‹æ¸¸æ¨¡å—çš„å‡†ç¡®æ€§

4. **å·²å›æ»šçš„åŠŸèƒ½**
   - æ ¹æ® git æäº¤ `e0b25f5`ï¼ˆ2025-11-11ï¼‰ï¼Œå®¢æˆ·æ¡£æ¡ˆçŠ¶æ€è‡ªåŠ¨æ›´æ–°åŠŸèƒ½å·²è¢«å›æ»š
   - é€šç”¨å®šæ—¶ä»»åŠ¡æ¨¡å—æœ‰è®¾è®¡æ–¹æ¡ˆä½†æœªå®æ–½

### å½±å“èŒƒå›´

- **ä¸šåŠ¡æµç¨‹å—é˜»**: æ— æ³•é¡ºç•…åœ°ä¸ºæ–°å®¢æˆ·åˆ›å»ºåˆåŒ
- **æ•°æ®è´¨é‡ä¸‹é™**: å®¢æˆ·çŠ¶æ€ä¸å®é™…ä¸ç¬¦ï¼Œå½±å“æŠ¥è¡¨å‡†ç¡®æ€§
- **è¿ç»´æˆæœ¬å¢åŠ **: éœ€è¦å®šæœŸæ‰‹åŠ¨æ‰§è¡Œè„šæœ¬ä¿®æ­£æ•°æ®
- **ç”¨æˆ·ä½“éªŒå·®**: å‰ç«¯æ˜¾ç¤ºçš„å®¢æˆ·çŠ¶æ€å¯èƒ½è¯¯å¯¼ç”¨æˆ·

---

## ç°çŠ¶æ¢³ç†

### å®¢æˆ·çŠ¶æ€ä½“ç³»

å®¢æˆ·çŠ¶æ€ä¸º**å­˜å‚¨å­—æ®µ**ï¼Œå…±5ä¸ªçŠ¶æ€ï¼š

| çŠ¶æ€ä»£ç  | ä¸­æ–‡åç§° | ä¸šåŠ¡å«ä¹‰ | ç¼–è¾‘æƒé™ | åˆ é™¤æƒé™ |
|---------|---------|---------|---------|---------|
| `prospect` | æ„å‘å®¢æˆ· | åˆå§‹çŠ¶æ€ï¼Œæœªç­¾çº¦ | å®Œå…¨å¯ç¼–è¾‘ | å¯åˆ é™¤ |
| `pending` | å¾…ç”Ÿæ•ˆ | å·²ç­¾çº¦ä½†æœªå¼€å§‹æœåŠ¡ | æœ‰é™ç¼–è¾‘ | ä¸å¯åˆ é™¤ |
| `active` | æ‰§è¡Œä¸­ | æ­£åœ¨æä¾›æœåŠ¡ | ä¸¥æ ¼å—æ§ | ä¸å¯åˆ é™¤ |
| `suspended` | å·²æš‚åœ | ä¸´æ—¶å†»ç»“çŠ¶æ€ | ä¸¥æ ¼å—æ§ | ä¸å¯åˆ é™¤ |
| `terminated` | å·²ç»ˆæ­¢ | åˆåŒç»“æŸ | å®Œå…¨åªè¯» | ä¸å¯åˆ é™¤ |

**æ ‡å‡†çŠ¶æ€æµè½¬**:
```
prospect (æ„å‘å®¢æˆ·)
  â†“ [ç­¾çº¦æ“ä½œ]
pending (å¾…ç”Ÿæ•ˆ)
  â†“ [ç”Ÿæ•ˆæ“ä½œ]          â†“ [æ’¤é”€æ“ä½œ]
active (æ‰§è¡Œä¸­)     terminated (å·²ç»ˆæ­¢)
  â†“ [æš‚åœæ“ä½œ]
suspended (å·²æš‚åœ)
  â†“ [æ¢å¤æ“ä½œ]
active (æ‰§è¡Œä¸­)
  â†“ [ç»ˆæ­¢æ“ä½œ]
terminated (å·²ç»ˆæ­¢)
```

### åˆåŒçŠ¶æ€ä½“ç³»

åˆåŒçŠ¶æ€ä¸º**è™šæ‹Ÿå­—æ®µ**ï¼ŒåŸºäºæ—¥æœŸå®æ—¶è®¡ç®—ï¼Œå…±3ä¸ªçŠ¶æ€ï¼š

| çŠ¶æ€ä»£ç  | ä¸­æ–‡åç§° | è®¡ç®—è§„åˆ™ |
|---------|---------|---------|
| `pending` | å¾…ç”Ÿæ•ˆ | å½“å‰æœˆä»½ < è´­ç”µå¼€å§‹æœˆä»½ |
| `active` | ç”Ÿæ•ˆ | è´­ç”µå¼€å§‹æœˆä»½ <= å½“å‰æœˆä»½ <= è´­ç”µç»“æŸæœˆä»½ |
| `expired` | å·²è¿‡æœŸ | å½“å‰æœˆä»½ > è´­ç”µç»“æŸæœˆä»½ |

**è®¡ç®—å‡½æ•°**: `webapp/models/contract.py:calculate_contract_status()`

**ä¼˜ç‚¹**:
- çŠ¶æ€å‡†ç¡®ï¼Œéšæ—¶é—´è‡ªåŠ¨å˜åŒ–
- æ— éœ€æ‰‹åŠ¨ç»´æŠ¤åˆåŒçŠ¶æ€

**ç¼ºç‚¹**:
- å®¢æˆ·çŠ¶æ€æ— æ³•è‡ªåŠ¨è·ŸéšåˆåŒçŠ¶æ€å˜åŒ–

### å½“å‰å…³è”å…³ç³»

```
customers é›†åˆ                    retail_contracts é›†åˆ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ _id (ObjectId)  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ customer_id (FK)     â”‚
â”‚ user_name       â”‚           â””â”€â”€â”‚ customer_name        â”‚
â”‚ status (å­˜å‚¨)   â”‚              â”‚ purchase_start_month â”‚
â”‚ created_at      â”‚              â”‚ purchase_end_month   â”‚
â”‚ updated_at      â”‚              â”‚ status (è™šæ‹Ÿå­—æ®µ)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†‘                                  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           éœ€è¦è‡ªåŠ¨åŒæ­¥ï¼ˆå½“å‰ç¼ºå¤±ï¼‰
```

### ç°æœ‰ä»£ç ä½ç½®

#### æ•°æ®æ¨¡å‹
- `webapp/models/customer.py` - å®¢æˆ·æ•°æ®æ¨¡å‹ï¼ˆ5çŠ¶æ€å®šä¹‰ï¼‰
- `webapp/models/contract.py` - åˆåŒæ•°æ®æ¨¡å‹ï¼ˆè™šæ‹ŸçŠ¶æ€è®¡ç®—ï¼‰

#### æœåŠ¡å±‚
- `webapp/services/customer_service.py` - å®¢æˆ·ä¸šåŠ¡é€»è¾‘
  - L755-803: `sign_contract()` - ç­¾çº¦æ“ä½œ
  - L854-895: `activate()` - ç”Ÿæ•ˆæ“ä½œ
  - L992-1039: `terminate()` - ç»ˆæ­¢æ“ä½œ

- `webapp/services/contract_service.py` - åˆåŒä¸šåŠ¡é€»è¾‘
  - L65-132: `create_contract()` - åˆ›å»ºåˆåŒï¼ˆ**é—®é¢˜ç‚¹**ï¼šè¦æ±‚å®¢æˆ· activeï¼‰
  - L244-341: `update_contract()` - æ›´æ–°åˆåŒ
  - L343-375: `delete_contract()` - åˆ é™¤åˆåŒ

#### è„šæœ¬å·¥å…·
- `scripts/fix_customer_status_by_contract.py` - æ‰‹åŠ¨ä¿®æ­£å®¢æˆ·çŠ¶æ€

---

## é‡æ„ç›®æ ‡

### æ€»ä½“ç›®æ ‡

å®ç°å®¢æˆ·çŠ¶æ€ä¸åˆåŒçŠ¶æ€çš„**è‡ªåŠ¨åŒ–åŒæ­¥**ï¼Œé‡‡ç”¨**æ··åˆæ¨¡å¼**ï¼ˆå®æ—¶åŒæ­¥ + å®šæ—¶ä»»åŠ¡å…œåº•ï¼‰ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§å’Œä¸šåŠ¡é€»è¾‘æ­£ç¡®æ€§ã€‚

### å…·ä½“ç›®æ ‡

1. **ä¿®å¤ä¸šåŠ¡é€»è¾‘çŸ›ç›¾**
   - å…è®¸ä»»ä½•é `terminated` çŠ¶æ€çš„å®¢æˆ·åˆ›å»ºåˆåŒ
   - åˆ›å»ºåˆåŒæ—¶è‡ªåŠ¨æ›´æ–°å®¢æˆ·çŠ¶æ€

2. **å®ç°çŠ¶æ€è‡ªåŠ¨åŒæ­¥**
   - åˆåŒåˆ›å»º/æ›´æ–°/åˆ é™¤æ—¶å®æ—¶åŒæ­¥å®¢æˆ·çŠ¶æ€
   - å®šæ—¶ä»»åŠ¡æ¯æ—¥å‡Œæ™¨æ£€æŸ¥å¹¶ä¿®æ­£ä¸ä¸€è‡´çŠ¶æ€

3. **å®æ–½é€šç”¨å®šæ—¶ä»»åŠ¡æ¨¡å—**
   - åŸºäº APScheduler æ„å»ºå¯æ‰©å±•çš„å®šæ—¶ä»»åŠ¡æ¡†æ¶
   - æ”¯æŒä»»åŠ¡æ³¨å†Œã€ç›‘æ§ã€æ—¥å¿—è®°å½•

4. **ä¼˜åŒ–ç­¾çº¦ç”µé‡è®¡ç®—**
   - æ ¹æ®å®¢æˆ·çŠ¶æ€è®¡ç®—ä¸åŒç±»å‹çš„ç­¾çº¦ç”µé‡
   - æé«˜æ•°æ®å±•ç¤ºçš„å‡†ç¡®æ€§

5. **å®Œå–„æ–‡æ¡£å’Œæµ‹è¯•**
   - ç¼–å†™æŠ€æœ¯æ–‡æ¡£å’Œå•å…ƒæµ‹è¯•
   - ç¡®ä¿æ–¹æ¡ˆå¯ç»´æŠ¤ã€å¯æ‰©å±•

---

## æŠ€æœ¯æ–¹æ¡ˆ

### æ–¹æ¡ˆæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å®¢æˆ·çŠ¶æ€åŒæ­¥æ¶æ„                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åˆåŒæœåŠ¡       â”‚
â”‚  Contract       â”‚
â”‚  Service        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ è°ƒç”¨
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            å®æ—¶åŒæ­¥å±‚ (Real-time Sync)                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  CustomerStatusSyncService                      â”‚    â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€          â”‚    â”‚
â”‚  â”‚  â€¢ sync_status_on_contract_create()             â”‚    â”‚
â”‚  â”‚  â€¢ sync_status_on_contract_update()             â”‚    â”‚
â”‚  â”‚  â€¢ sync_status_on_contract_delete()             â”‚    â”‚
â”‚  â”‚  â€¢ calculate_customer_status()                  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚ æ›´æ–°
                         â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚  customers   â”‚
                  â”‚  é›†åˆ        â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â–²
                         â”‚ ä¿®æ­£
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            å®šæ—¶ä»»åŠ¡å±‚ (Scheduled Task)                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  CustomerStatusSyncTask (æ¯æ—¥2:00æ‰§è¡Œ)          â”‚    â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€          â”‚    â”‚
â”‚  â”‚  â€¢ æ‰«ææ‰€æœ‰å®¢æˆ·                                  â”‚    â”‚
â”‚  â”‚  â€¢ æ ¹æ®åˆåŒçŠ¶æ€è®¡ç®—åº”æœ‰çŠ¶æ€                       â”‚    â”‚
â”‚  â”‚  â€¢ ä¿®æ­£ä¸ä¸€è‡´çš„å®¢æˆ·çŠ¶æ€                          â”‚    â”‚
â”‚  â”‚  â€¢ ç”Ÿæˆä¿®æ­£æŠ¥å‘Š                                  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                          â”‚
â”‚  åŸºäº APScheduler è°ƒåº¦å™¨                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Phase 1: ä¿®å¤ä¸šåŠ¡é€»è¾‘çŸ›ç›¾ï¼ˆä¼˜å…ˆçº§ï¼šğŸ”´ ç´§æ€¥ï¼‰

#### 1.1 ä¿®æ­£åˆåŒåˆ›å»ºæ—¶çš„å®¢æˆ·çŠ¶æ€æ ¡éªŒ

**æ–‡ä»¶**: `webapp/services/contract_service.py`

**å½“å‰ä»£ç ** (L96-101):
```python
customer = self.db.customers.find_one({
    "_id": ObjectId(customer_id),
    "status": "active"  # âŒ åªæ¥å— active
})
if not customer:
    raise ValueError(f"å®¢æˆ·ä¸å­˜åœ¨æˆ–çŠ¶æ€ä¸æ˜¯æ­£å¸¸")
```

**ä¿®æ”¹æ–¹æ¡ˆ**:
```python
# å…è®¸ä»»ä½•é terminated çŠ¶æ€çš„å®¢æˆ·åˆ›å»ºåˆåŒ
customer = self.db.customers.find_one({
    "_id": ObjectId(customer_id),
    "status": {"$ne": "terminated"}  # âœ… æ’é™¤å·²ç»ˆæ­¢å®¢æˆ·
})
if not customer:
    raise ValueError(f"å®¢æˆ·ä¸å­˜åœ¨æˆ–å·²ç»ˆæ­¢ï¼Œæ— æ³•åˆ›å»ºåˆåŒ")

# åˆ›å»ºåˆåŒåï¼Œè‡ªåŠ¨åŒæ­¥å®¢æˆ·çŠ¶æ€
from webapp.services.customer_status_sync_service import CustomerStatusSyncService
sync_service = CustomerStatusSyncService(self.db)
sync_service.sync_status_on_contract_create(
    customer_id=customer_id,
    contract_start_month=contract_data["purchase_start_month"],
    operator=operator
)
```

#### 1.2 è‡ªåŠ¨çŠ¶æ€æ›´æ–°é€»è¾‘

**ä¸šåŠ¡è§„åˆ™**:

1. **åˆ›å»ºåˆåŒæ—¶**:
   - å¦‚æœå®¢æˆ·æ˜¯ `prospect` ä¸”åˆåŒæœªæ¥ç”Ÿæ•ˆ â†’ æ›´æ–°ä¸º `pending`
   - å¦‚æœå®¢æˆ·æ˜¯ `prospect` ä¸”åˆåŒç«‹å³ç”Ÿæ•ˆ â†’ æ›´æ–°ä¸º `active`
   - å¦‚æœå®¢æˆ·æ˜¯ `pending` ä¸”åˆåŒç«‹å³ç”Ÿæ•ˆ â†’ æ›´æ–°ä¸º `active`
   - å¦‚æœå®¢æˆ·å·²æ˜¯ `active` â†’ ä¿æŒä¸å˜

2. **åˆ é™¤åˆåŒæ—¶**:
   - æ£€æŸ¥å®¢æˆ·æ˜¯å¦è¿˜æœ‰å…¶ä»–åˆåŒ
   - å¦‚æœæ˜¯æœ€åä¸€ä¸ªåˆåŒ â†’ æ›´æ–°ä¸º `prospect`

3. **æ›´æ–°åˆåŒæ—¶**:
   - å¦‚æœåˆåŒç”Ÿæ•ˆæ—¥æœŸå˜åŒ–ï¼Œé‡æ–°è®¡ç®—å®¢æˆ·çŠ¶æ€

---

### Phase 2: å®æ–½é€šç”¨å®šæ—¶ä»»åŠ¡æ¨¡å—ï¼ˆä¼˜å…ˆçº§ï¼šğŸŸ¡ é‡è¦ï¼‰

#### 2.1 æŠ€æœ¯é€‰å‹

- **è°ƒåº¦å™¨**: APScheduler (Advanced Python Scheduler)
- **å­˜å‚¨åç«¯**: MongoDB (å¤ç”¨ç°æœ‰æ•°æ®åº“)
- **æ—¥å¿—**: Python logging + æ•°æ®åº“è®°å½•

#### 2.2 ç›®å½•ç»“æ„

```
webapp/
â”œâ”€â”€ scheduler/
â”‚   â”œâ”€â”€ __init__.py                    # æ¨¡å—åˆå§‹åŒ–
â”‚   â”œâ”€â”€ base_task.py                   # ä»»åŠ¡åŸºç±»
â”‚   â”œâ”€â”€ task_registry.py               # ä»»åŠ¡æ³¨å†Œå™¨
â”‚   â”œâ”€â”€ scheduler_manager.py           # APScheduler ç®¡ç†å™¨
â”‚   â””â”€â”€ tasks/
â”‚       â”œâ”€â”€ __init__.py
â”‚       â””â”€â”€ customer_status_sync_task.py  # å®¢æˆ·çŠ¶æ€åŒæ­¥ä»»åŠ¡
```

#### 2.3 æ ¸å¿ƒç»„ä»¶è®¾è®¡

**2.3.1 ä»»åŠ¡åŸºç±»** (`base_task.py`)

```python
from abc import ABC, abstractmethod
from typing import Optional
from datetime import datetime

class BaseTask(ABC):
    """å®šæ—¶ä»»åŠ¡åŸºç±»"""

    def __init__(self, db):
        self.db = db
        self.task_name = self.__class__.__name__
        self.logger = logging.getLogger(f"scheduler.{self.task_name}")

    @abstractmethod
    def execute(self) -> dict:
        """
        ä»»åŠ¡æ‰§è¡Œé€»è¾‘ï¼ˆå­ç±»å¿…é¡»å®ç°ï¼‰

        è¿”å›:
            dict: æ‰§è¡Œç»“æœï¼ŒåŒ…å« success, message, data ç­‰å­—æ®µ
        """
        pass

    def run(self) -> dict:
        """
        æ‰§è¡Œä»»åŠ¡å¹¶è®°å½•æ—¥å¿—
        """
        start_time = datetime.utcnow()
        self.logger.info(f"ä»»åŠ¡ {self.task_name} å¼€å§‹æ‰§è¡Œ")

        try:
            result = self.execute()

            # è®°å½•æ‰§è¡Œå†å²åˆ°æ•°æ®åº“
            self._save_execution_history(
                start_time=start_time,
                end_time=datetime.utcnow(),
                status="success",
                result=result
            )

            self.logger.info(f"ä»»åŠ¡ {self.task_name} æ‰§è¡ŒæˆåŠŸ")
            return result

        except Exception as e:
            self.logger.error(f"ä»»åŠ¡ {self.task_name} æ‰§è¡Œå¤±è´¥: {str(e)}", exc_info=True)

            self._save_execution_history(
                start_time=start_time,
                end_time=datetime.utcnow(),
                status="failed",
                error=str(e)
            )

            raise

    def _save_execution_history(self, start_time, end_time, status, result=None, error=None):
        """ä¿å­˜ä»»åŠ¡æ‰§è¡Œå†å²"""
        self.db.task_execution_history.insert_one({
            "task_name": self.task_name,
            "start_time": start_time,
            "end_time": end_time,
            "duration_seconds": (end_time - start_time).total_seconds(),
            "status": status,
            "result": result,
            "error": error,
            "created_at": datetime.utcnow()
        })
```

**2.3.2 è°ƒåº¦å™¨ç®¡ç†å™¨** (`scheduler_manager.py`)

```python
from apscheduler.schedulers.background import BackgroundScheduler
from apscheduler.jobstores.mongodb import MongoDBJobStore
from apscheduler.executors.pool import ThreadPoolExecutor
import logging

class SchedulerManager:
    """å®šæ—¶ä»»åŠ¡è°ƒåº¦å™¨ç®¡ç†å™¨"""

    def __init__(self, db):
        self.db = db
        self.logger = logging.getLogger("scheduler.manager")

        # é…ç½® APScheduler
        jobstores = {
            'default': MongoDBJobStore(
                database=db.name,
                collection='apscheduler_jobs',
                client=db.client
            )
        }

        executors = {
            'default': ThreadPoolExecutor(max_workers=5)
        }

        job_defaults = {
            'coalesce': True,           # åˆå¹¶å †ç§¯çš„ä»»åŠ¡
            'max_instances': 1,         # åŒä¸€ä»»åŠ¡åŒæ—¶åªè¿è¡Œä¸€ä¸ªå®ä¾‹
            'misfire_grace_time': 3600  # é”™è¿‡æ‰§è¡Œæ—¶é—´1å°æ—¶å†…ä»å¯æ‰§è¡Œ
        }

        self.scheduler = BackgroundScheduler(
            jobstores=jobstores,
            executors=executors,
            job_defaults=job_defaults,
            timezone='Asia/Shanghai'
        )

    def start(self):
        """å¯åŠ¨è°ƒåº¦å™¨"""
        if not self.scheduler.running:
            self.scheduler.start()
            self.logger.info("å®šæ—¶ä»»åŠ¡è°ƒåº¦å™¨å·²å¯åŠ¨")

    def shutdown(self, wait=True):
        """å…³é—­è°ƒåº¦å™¨"""
        if self.scheduler.running:
            self.scheduler.shutdown(wait=wait)
            self.logger.info("å®šæ—¶ä»»åŠ¡è°ƒåº¦å™¨å·²å…³é—­")

    def add_cron_job(self, task_instance, **cron_kwargs):
        """
        æ·»åŠ  Cron å®šæ—¶ä»»åŠ¡

        å‚æ•°:
            task_instance: ä»»åŠ¡å®ä¾‹ï¼ˆBaseTask å­ç±»ï¼‰
            cron_kwargs: Cron è¡¨è¾¾å¼å‚æ•° (hour, minute, day_of_week ç­‰)
        """
        job_id = task_instance.task_name

        self.scheduler.add_job(
            func=task_instance.run,
            trigger='cron',
            id=job_id,
            replace_existing=True,
            **cron_kwargs
        )

        self.logger.info(f"å·²æ³¨å†Œå®šæ—¶ä»»åŠ¡: {job_id}, è°ƒåº¦è§„åˆ™: {cron_kwargs}")
```

**2.3.3 ä»»åŠ¡æ³¨å†Œå™¨** (`task_registry.py`)

```python
from webapp.scheduler.tasks.customer_status_sync_task import CustomerStatusSyncTask

class TaskRegistry:
    """ä»»åŠ¡æ³¨å†Œå™¨"""

    @staticmethod
    def register_all_tasks(scheduler_manager, db):
        """æ³¨å†Œæ‰€æœ‰å®šæ—¶ä»»åŠ¡"""

        # 1. å®¢æˆ·çŠ¶æ€åŒæ­¥ä»»åŠ¡ï¼ˆæ¯æ—¥å‡Œæ™¨2:00æ‰§è¡Œï¼‰
        customer_sync_task = CustomerStatusSyncTask(db)
        scheduler_manager.add_cron_job(
            task_instance=customer_sync_task,
            hour=2,
            minute=0
        )

        # 2. æœªæ¥å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ æ›´å¤šä»»åŠ¡...
        # example_task = ExampleTask(db)
        # scheduler_manager.add_cron_job(example_task, hour=3, minute=0)
```

#### 2.4 é›†æˆåˆ° FastAPI åº”ç”¨

**ä¿®æ”¹æ–‡ä»¶**: `webapp/main.py`

```python
from webapp.scheduler.scheduler_manager import SchedulerManager
from webapp.scheduler.task_registry import TaskRegistry

# å…¨å±€è°ƒåº¦å™¨å®ä¾‹
scheduler_manager = None

@app.on_event("startup")
async def startup_event():
    """åº”ç”¨å¯åŠ¨æ—¶æ‰§è¡Œ"""
    global scheduler_manager

    # åˆå§‹åŒ–è°ƒåº¦å™¨
    scheduler_manager = SchedulerManager(DATABASE)

    # æ³¨å†Œæ‰€æœ‰å®šæ—¶ä»»åŠ¡
    TaskRegistry.register_all_tasks(scheduler_manager, DATABASE)

    # å¯åŠ¨è°ƒåº¦å™¨
    scheduler_manager.start()

    logger.info("åº”ç”¨å¯åŠ¨å®Œæˆï¼Œå®šæ—¶ä»»åŠ¡è°ƒåº¦å™¨å·²å¯åŠ¨")

@app.on_event("shutdown")
async def shutdown_event():
    """åº”ç”¨å…³é—­æ—¶æ‰§è¡Œ"""
    if scheduler_manager:
        scheduler_manager.shutdown()
    logger.info("åº”ç”¨å·²å…³é—­ï¼Œå®šæ—¶ä»»åŠ¡è°ƒåº¦å™¨å·²åœæ­¢")
```

---

### Phase 3: å®ç°å®¢æˆ·çŠ¶æ€è‡ªåŠ¨åŒæ­¥ï¼ˆä¼˜å…ˆçº§ï¼šğŸŸ¡ é‡è¦ï¼‰

#### 3.1 å®æ—¶åŒæ­¥æœåŠ¡

**æ–°å¢æ–‡ä»¶**: `webapp/services/customer_status_sync_service.py`

```python
from datetime import datetime
from bson import ObjectId
from webapp.models.contract import calculate_contract_status
import logging

class CustomerStatusSyncService:
    """å®¢æˆ·çŠ¶æ€è‡ªåŠ¨åŒæ­¥æœåŠ¡"""

    def __init__(self, db):
        self.db = db
        self.logger = logging.getLogger("customer_status_sync")

    def sync_status_on_contract_create(
        self,
        customer_id: str,
        contract_start_month: datetime,
        operator: str
    ):
        """
        åˆåŒåˆ›å»ºæ—¶åŒæ­¥å®¢æˆ·çŠ¶æ€

        ä¸šåŠ¡è§„åˆ™:
        - prospect + åˆåŒæœªæ¥ç”Ÿæ•ˆ â†’ pending
        - prospect + åˆåŒç«‹å³ç”Ÿæ•ˆ â†’ active
        - pending + åˆåŒç«‹å³ç”Ÿæ•ˆ â†’ active
        - active â†’ ä¿æŒ active
        """
        customer = self.db.customers.find_one({"_id": ObjectId(customer_id)})
        if not customer:
            return

        current_status = customer.get("status")
        current_month = datetime.utcnow().replace(day=1, hour=0, minute=0, second=0, microsecond=0)
        contract_immediately_active = contract_start_month <= current_month

        new_status = None

        if current_status == "prospect":
            new_status = "active" if contract_immediately_active else "pending"

        elif current_status == "pending":
            if contract_immediately_active:
                new_status = "active"

        # æ›´æ–°å®¢æˆ·çŠ¶æ€
        if new_status and new_status != current_status:
            self._update_customer_status(
                customer_id=customer_id,
                new_status=new_status,
                operator=operator,
                reason="åˆåŒåˆ›å»ºè§¦å‘è‡ªåŠ¨æ›´æ–°"
            )

    def sync_status_on_contract_update(
        self,
        customer_id: str,
        old_start_month: datetime,
        new_start_month: datetime,
        operator: str
    ):
        """
        åˆåŒæ›´æ–°æ—¶åŒæ­¥å®¢æˆ·çŠ¶æ€

        ä¸»è¦å¤„ç†åˆåŒç”Ÿæ•ˆæ—¥æœŸå˜åŒ–çš„æƒ…å†µ
        """
        # å¦‚æœç”Ÿæ•ˆæ—¥æœŸæ²¡æœ‰å˜åŒ–ï¼Œæ— éœ€åŒæ­¥
        if old_start_month == new_start_month:
            return

        # é‡æ–°è®¡ç®—å®¢æˆ·åº”æœ‰çŠ¶æ€
        target_status = self.calculate_customer_status(customer_id)

        customer = self.db.customers.find_one({"_id": ObjectId(customer_id)})
        if not customer:
            return

        current_status = customer.get("status")

        if target_status and target_status != current_status:
            self._update_customer_status(
                customer_id=customer_id,
                new_status=target_status,
                operator=operator,
                reason="åˆåŒæ›´æ–°è§¦å‘è‡ªåŠ¨æ›´æ–°"
            )

    def sync_status_on_contract_delete(
        self,
        customer_id: str,
        operator: str
    ):
        """
        åˆåŒåˆ é™¤æ—¶åŒæ­¥å®¢æˆ·çŠ¶æ€

        å¦‚æœå®¢æˆ·æ²¡æœ‰å…¶ä»–åˆåŒäº†ï¼Œå›é€€åˆ° prospect çŠ¶æ€
        """
        # æ£€æŸ¥å®¢æˆ·æ˜¯å¦è¿˜æœ‰å…¶ä»–åˆåŒ
        remaining_contracts = self.db.retail_contracts.count_documents({
            "customer_id": customer_id
        })

        if remaining_contracts == 0:
            # æ²¡æœ‰åˆåŒäº†ï¼Œå›é€€åˆ° prospect
            customer = self.db.customers.find_one({"_id": ObjectId(customer_id)})
            if customer and customer.get("status") != "prospect":
                self._update_customer_status(
                    customer_id=customer_id,
                    new_status="prospect",
                    operator=operator,
                    reason="åˆ é™¤æœ€åä¸€ä¸ªåˆåŒï¼Œå›é€€åˆ°æ„å‘å®¢æˆ·"
                )
        else:
            # è¿˜æœ‰å…¶ä»–åˆåŒï¼Œé‡æ–°è®¡ç®—çŠ¶æ€
            target_status = self.calculate_customer_status(customer_id)

            customer = self.db.customers.find_one({"_id": ObjectId(customer_id)})
            if not customer:
                return

            current_status = customer.get("status")

            if target_status and target_status != current_status:
                self._update_customer_status(
                    customer_id=customer_id,
                    new_status=target_status,
                    operator=operator,
                    reason="åˆåŒåˆ é™¤è§¦å‘è‡ªåŠ¨æ›´æ–°"
                )

    def calculate_customer_status(self, customer_id: str) -> str:
        """
        æ ¹æ®å®¢æˆ·çš„æ‰€æœ‰åˆåŒè®¡ç®—åº”æœ‰çŠ¶æ€

        ä¸šåŠ¡è§„åˆ™:
        1. æœ‰ active åˆåŒ â†’ active
        2. ä»…æœ‰ pending åˆåŒ â†’ pending
        3. æ— åˆåŒæˆ–ä»…æœ‰ expired åˆåŒ â†’ prospect

        è¿”å›:
            str: è®¡ç®—å‡ºçš„å®¢æˆ·çŠ¶æ€ï¼Œå¦‚æœæ— æ³•ç¡®å®šåˆ™è¿”å› None
        """
        current_month = datetime.utcnow().replace(day=1, hour=0, minute=0, second=0, microsecond=0)

        # æŸ¥è¯¢å®¢æˆ·çš„æ‰€æœ‰åˆåŒ
        contracts = list(self.db.retail_contracts.find({"customer_id": customer_id}))

        if not contracts:
            return "prospect"

        has_active = False
        has_pending = False

        for contract in contracts:
            status = calculate_contract_status(
                contract["purchase_start_month"],
                contract["purchase_end_month"]
            )

            if status == "active":
                has_active = True
                break  # æœ‰ä¸€ä¸ª active å°±å¤Ÿäº†
            elif status == "pending":
                has_pending = True

        if has_active:
            return "active"
        elif has_pending:
            return "pending"
        else:
            # ä»…æœ‰ expired åˆåŒ
            return "prospect"

    def _update_customer_status(
        self,
        customer_id: str,
        new_status: str,
        operator: str,
        reason: str
    ):
        """
        æ›´æ–°å®¢æˆ·çŠ¶æ€å¹¶è®°å½•æ—¥å¿—
        """
        customer = self.db.customers.find_one({"_id": ObjectId(customer_id)})
        if not customer:
            return

        old_status = customer.get("status")

        self.db.customers.update_one(
            {"_id": ObjectId(customer_id)},
            {
                "$set": {
                    "status": new_status,
                    "updated_at": datetime.utcnow(),
                    "updated_by": operator
                }
            }
        )

        self.logger.info(
            f"å®¢æˆ·çŠ¶æ€è‡ªåŠ¨æ›´æ–°: customer_id={customer_id}, "
            f"{old_status} â†’ {new_status}, "
            f"åŸå› : {reason}, æ“ä½œäºº: {operator}"
        )

        # è®°å½•çŠ¶æ€å˜æ›´å†å²ï¼ˆå¯é€‰ï¼‰
        self.db.customer_status_change_history.insert_one({
            "customer_id": customer_id,
            "customer_name": customer.get("user_name"),
            "old_status": old_status,
            "new_status": new_status,
            "change_type": "auto",  # è‡ªåŠ¨æ›´æ–°
            "reason": reason,
            "operator": operator,
            "created_at": datetime.utcnow()
        })
```

#### 3.2 å®šæ—¶ä»»åŠ¡å…œåº•ä¿®æ­£

**æ–°å¢æ–‡ä»¶**: `webapp/scheduler/tasks/customer_status_sync_task.py`

```python
from webapp.scheduler.base_task import BaseTask
from webapp.services.customer_status_sync_service import CustomerStatusSyncService
from datetime import datetime

class CustomerStatusSyncTask(BaseTask):
    """å®¢æˆ·çŠ¶æ€åŒæ­¥å®šæ—¶ä»»åŠ¡ï¼ˆæ¯æ—¥å‡Œæ™¨2:00æ‰§è¡Œï¼‰"""

    def execute(self) -> dict:
        """
        æ‰«ææ‰€æœ‰å®¢æˆ·ï¼Œæ£€æŸ¥å¹¶ä¿®æ­£çŠ¶æ€ä¸ä¸€è‡´çš„è®°å½•

        è¿”å›:
            dict: æ‰§è¡Œç»“æœç»Ÿè®¡
        """
        sync_service = CustomerStatusSyncService(self.db)

        total_customers = 0
        fixed_customers = 0
        fixed_details = []

        # éå†æ‰€æœ‰é terminated çš„å®¢æˆ·
        customers = self.db.customers.find({
            "status": {"$ne": "terminated"}
        })

        for customer in customers:
            total_customers += 1
            customer_id = str(customer["_id"])
            current_status = customer.get("status")

            # è®¡ç®—å®¢æˆ·åº”æœ‰çŠ¶æ€
            target_status = sync_service.calculate_customer_status(customer_id)

            if target_status and target_status != current_status:
                # çŠ¶æ€ä¸ä¸€è‡´ï¼Œéœ€è¦ä¿®æ­£
                sync_service._update_customer_status(
                    customer_id=customer_id,
                    new_status=target_status,
                    operator="system_scheduler",
                    reason="å®šæ—¶ä»»åŠ¡æ£€æµ‹åˆ°çŠ¶æ€ä¸ä¸€è‡´å¹¶ä¿®æ­£"
                )

                fixed_customers += 1
                fixed_details.append({
                    "customer_id": customer_id,
                    "customer_name": customer.get("user_name"),
                    "old_status": current_status,
                    "new_status": target_status
                })

        return {
            "success": True,
            "message": f"å®¢æˆ·çŠ¶æ€åŒæ­¥ä»»åŠ¡æ‰§è¡Œå®Œæˆ",
            "data": {
                "total_customers": total_customers,
                "fixed_customers": fixed_customers,
                "fixed_details": fixed_details,
                "execution_time": datetime.utcnow().isoformat()
            }
        }
```

#### 3.3 é›†æˆåˆ°åˆåŒæœåŠ¡

**ä¿®æ”¹æ–‡ä»¶**: `webapp/services/contract_service.py`

åœ¨ä»¥ä¸‹æ–¹æ³•ä¸­æ·»åŠ çŠ¶æ€åŒæ­¥è°ƒç”¨ï¼š

1. **åˆ›å»ºåˆåŒååŒæ­¥** (`create_contract`)
```python
# åœ¨æ’å…¥åˆåŒåï¼Œæ·»åŠ ä»¥ä¸‹ä»£ç 
from webapp.services.customer_status_sync_service import CustomerStatusSyncService

sync_service = CustomerStatusSyncService(self.db)
sync_service.sync_status_on_contract_create(
    customer_id=customer_id,
    contract_start_month=contract_data["purchase_start_month"],
    operator=operator
)
```

2. **æ›´æ–°åˆåŒååŒæ­¥** (`update_contract`)
```python
# åœ¨æ›´æ–°åˆåŒåï¼Œæ·»åŠ ä»¥ä¸‹ä»£ç 
if "purchase_start_month" in update_data:
    sync_service = CustomerStatusSyncService(self.db)
    sync_service.sync_status_on_contract_update(
        customer_id=existing_contract["customer_id"],
        old_start_month=existing_contract["purchase_start_month"],
        new_start_month=update_data["purchase_start_month"],
        operator=operator
    )
```

3. **åˆ é™¤åˆåŒååŒæ­¥** (`delete_contract`)
```python
# åœ¨åˆ é™¤åˆåŒåï¼Œæ·»åŠ ä»¥ä¸‹ä»£ç 
sync_service = CustomerStatusSyncService(self.db)
sync_service.sync_status_on_contract_delete(
    customer_id=contract["customer_id"],
    operator=operator
)
```

---

### Phase 4: ä¼˜åŒ–ç­¾çº¦ç”µé‡è®¡ç®—ï¼ˆä¼˜å…ˆçº§ï¼šğŸŸ¢ ä¼˜åŒ–ï¼‰

#### 4.1 æ”¹è¿›å®¢æˆ·åˆ—è¡¨çš„ç­¾çº¦ç”µé‡é€»è¾‘

**ä¿®æ”¹æ–‡ä»¶**: `webapp/services/customer_service.py`

**å½“å‰é—®é¢˜**:
- ä¸åŒºåˆ†å®¢æˆ·çŠ¶æ€ï¼Œç»Ÿä¸€ç»Ÿè®¡æœªè¿‡æœŸåˆåŒ
- `pending` å®¢æˆ·ä¼šæ˜¾ç¤ºæœªæ¥æ‰ç”Ÿæ•ˆçš„åˆåŒç”µé‡

**æ”¹è¿›æ–¹æ¡ˆ**:

```python
def list_customers(self, filters: dict, page: int = 1, page_size: int = 20) -> dict:
    # ... çœç•¥å‰é¢çš„æŸ¥è¯¢é€»è¾‘ ...

    current_month = datetime.now().replace(day=1, hour=0, minute=0, second=0, microsecond=0)

    # ä¸ºæ¯ä¸ªå®¢æˆ·è®¡ç®—ç­¾çº¦ç”µé‡ï¼ˆæ ¹æ®å®¢æˆ·çŠ¶æ€å†³å®šç»Ÿè®¡å“ªäº›åˆåŒï¼‰
    for customer in customers:
        customer_id = str(customer["_id"])
        status = customer.get("status")

        # æ ¹æ®å®¢æˆ·çŠ¶æ€å†³å®šæŸ¥è¯¢æ¡ä»¶
        if status == "prospect" or status == "terminated":
            # æ„å‘å®¢æˆ·å’Œå·²ç»ˆæ­¢å®¢æˆ·ä¸ç»Ÿè®¡ç­¾çº¦ç”µé‡
            contracted_capacity = None

        elif status == "pending":
            # å¾…ç”Ÿæ•ˆå®¢æˆ·ï¼šç»Ÿè®¡ pending åˆåŒ
            pipeline = [
                {
                    "$match": {
                        "customer_id": customer_id,
                        "purchase_start_month": {"$gt": current_month}  # æœªæ¥ç”Ÿæ•ˆ
                    }
                },
                {
                    "$group": {
                        "_id": None,
                        "total": {"$sum": "$purchasing_electricity_quantity"}
                    }
                }
            ]
            result = list(self.db.retail_contracts.aggregate(pipeline))
            contracted_capacity = result[0]["total"] if result else 0.0

        elif status in ["active", "suspended"]:
            # æ‰§è¡Œä¸­/å·²æš‚åœå®¢æˆ·ï¼šç»Ÿè®¡ active åˆåŒ
            pipeline = [
                {
                    "$match": {
                        "customer_id": customer_id,
                        "purchase_start_month": {"$lte": current_month},
                        "purchase_end_month": {"$gte": current_month}
                    }
                },
                {
                    "$group": {
                        "_id": None,
                        "total": {"$sum": "$purchasing_electricity_quantity"}
                    }
                }
            ]
            result = list(self.db.retail_contracts.aggregate(pipeline))
            contracted_capacity = result[0]["total"] if result else 0.0

        else:
            contracted_capacity = None

        # æ·»åŠ åˆ°å®¢æˆ·æ•°æ®
        customer["contracted_capacity"] = contracted_capacity

    # ... çœç•¥åç»­é€»è¾‘ ...
```

---

### Phase 5: å®Œå–„æ–‡æ¡£å’Œæµ‹è¯•ï¼ˆä¼˜å…ˆçº§ï¼šğŸŸ¢ ä¿éšœï¼‰

#### 5.1 æŠ€æœ¯æ–‡æ¡£

**æ–°å¢æ–‡æ¡£**:

1. `docs/pages/å®¢æˆ·æ¡£æ¡ˆç®¡ç†/å®¢æˆ·çŠ¶æ€è‡ªåŠ¨åŒæ­¥è®¾è®¡æ–¹æ¡ˆ.md` - æœ¬æ–‡æ¡£
2. `docs/pages/é€šç”¨å®šæ—¶ä»»åŠ¡/å®æ–½æŒ‡å—.md` - å®šæ—¶ä»»åŠ¡ä½¿ç”¨æŒ‡å—
3. `docs/pages/é€šç”¨å®šæ—¶ä»»åŠ¡/ä¸šåŠ¡ä»»åŠ¡å®ç°ç¤ºä¾‹.md` - ä»»åŠ¡å¼€å‘ç¤ºä¾‹

**æ›´æ–°æ–‡æ¡£**:

1. `docs/pages/å®¢æˆ·æ¡£æ¡ˆç®¡ç†/å®¢æˆ·æ¡£æ¡ˆçŠ¶æ€é€»è¾‘.md` - æ·»åŠ è‡ªåŠ¨åŒæ­¥è¯´æ˜
2. `docs/pages/é›¶å”®åˆåŒç®¡ç†/é›¶å”®åˆåŒç®¡ç†æ¨¡å—è®¾è®¡æ–¹æ¡ˆ.md` - æ·»åŠ çŠ¶æ€åŒæ­¥è¯´æ˜

#### 5.2 API æ–‡æ¡£æ›´æ–°

åœ¨ä»¥ä¸‹ API ç«¯ç‚¹çš„ docstring ä¸­æ·»åŠ è‡ªåŠ¨çŠ¶æ€æ›´æ–°è¯´æ˜ï¼š

1. `POST /retail-contracts` - åˆ›å»ºåˆåŒ
   ```python
   """
   åˆ›å»ºé›¶å”®åˆåŒ

   **è‡ªåŠ¨çŠ¶æ€æ›´æ–°**:
   - å¦‚æœå®¢æˆ·æ˜¯ prospect ä¸”åˆåŒç«‹å³ç”Ÿæ•ˆ â†’ è‡ªåŠ¨æ›´æ–°ä¸º active
   - å¦‚æœå®¢æˆ·æ˜¯ prospect ä¸”åˆåŒæœªæ¥ç”Ÿæ•ˆ â†’ è‡ªåŠ¨æ›´æ–°ä¸º pending
   - å¦‚æœå®¢æˆ·æ˜¯ pending ä¸”åˆåŒç«‹å³ç”Ÿæ•ˆ â†’ è‡ªåŠ¨æ›´æ–°ä¸º active
   """
   ```

2. `PUT /retail-contracts/{contract_id}` - æ›´æ–°åˆåŒ
   ```python
   """
   æ›´æ–°é›¶å”®åˆåŒ

   **è‡ªåŠ¨çŠ¶æ€æ›´æ–°**:
   - å¦‚æœåˆåŒç”Ÿæ•ˆæ—¥æœŸå˜åŒ–ï¼Œä¼šè‡ªåŠ¨é‡æ–°è®¡ç®—å®¢æˆ·çŠ¶æ€
   """
   ```

3. `DELETE /retail-contracts/{contract_id}` - åˆ é™¤åˆåŒ
   ```python
   """
   åˆ é™¤é›¶å”®åˆåŒ

   **è‡ªåŠ¨çŠ¶æ€æ›´æ–°**:
   - å¦‚æœåˆ é™¤çš„æ˜¯å®¢æˆ·çš„æœ€åä¸€ä¸ªåˆåŒï¼Œå®¢æˆ·çŠ¶æ€ä¼šè‡ªåŠ¨å›é€€åˆ° prospect
   """
   ```

#### 5.3 å•å…ƒæµ‹è¯•

**æ–°å¢æµ‹è¯•æ–‡ä»¶**:

1. **çŠ¶æ€åŒæ­¥æœåŠ¡æµ‹è¯•** (`tests/test_customer_status_sync_service.py`)

```python
import pytest
from datetime import datetime, timedelta
from webapp.services.customer_status_sync_service import CustomerStatusSyncService

class TestCustomerStatusSyncService:
    """å®¢æˆ·çŠ¶æ€åŒæ­¥æœåŠ¡æµ‹è¯•"""

    def test_sync_on_contract_create_prospect_to_pending(self, db, test_customer, test_contract):
        """æµ‹è¯•ï¼šåˆ›å»ºæœªæ¥ç”Ÿæ•ˆåˆåŒï¼Œprospect â†’ pending"""
        # å‡†å¤‡æµ‹è¯•æ•°æ®
        customer_id = test_customer["_id"]
        future_month = datetime.utcnow() + timedelta(days=60)

        # æ‰§è¡ŒåŒæ­¥
        sync_service = CustomerStatusSyncService(db)
        sync_service.sync_status_on_contract_create(
            customer_id=str(customer_id),
            contract_start_month=future_month,
            operator="test_user"
        )

        # éªŒè¯ç»“æœ
        customer = db.customers.find_one({"_id": customer_id})
        assert customer["status"] == "pending"

    def test_sync_on_contract_create_prospect_to_active(self, db, test_customer):
        """æµ‹è¯•ï¼šåˆ›å»ºç«‹å³ç”Ÿæ•ˆåˆåŒï¼Œprospect â†’ active"""
        # ... æµ‹è¯•ä»£ç  ...

    def test_sync_on_contract_delete_last_contract(self, db, test_customer, test_contract):
        """æµ‹è¯•ï¼šåˆ é™¤æœ€åä¸€ä¸ªåˆåŒï¼Œå®¢æˆ·å›é€€åˆ° prospect"""
        # ... æµ‹è¯•ä»£ç  ...

    def test_calculate_customer_status_with_active_contract(self, db):
        """æµ‹è¯•ï¼šæœ‰ active åˆåŒï¼Œåº”è¿”å› active"""
        # ... æµ‹è¯•ä»£ç  ...
```

2. **å®šæ—¶ä»»åŠ¡æ¡†æ¶æµ‹è¯•** (`tests/test_scheduler.py`)

```python
import pytest
from webapp.scheduler.scheduler_manager import SchedulerManager
from webapp.scheduler.base_task import BaseTask

class TestSchedulerManager:
    """å®šæ—¶ä»»åŠ¡è°ƒåº¦å™¨æµ‹è¯•"""

    def test_scheduler_start_stop(self, db):
        """æµ‹è¯•ï¼šè°ƒåº¦å™¨å¯åŠ¨å’Œåœæ­¢"""
        manager = SchedulerManager(db)

        manager.start()
        assert manager.scheduler.running is True

        manager.shutdown()
        assert manager.scheduler.running is False

    def test_add_cron_job(self, db):
        """æµ‹è¯•ï¼šæ·»åŠ  Cron ä»»åŠ¡"""
        # ... æµ‹è¯•ä»£ç  ...
```

3. **å®¢æˆ·çŠ¶æ€åŒæ­¥å®šæ—¶ä»»åŠ¡æµ‹è¯•** (`tests/test_customer_status_sync_task.py`)

```python
import pytest
from webapp.scheduler.tasks.customer_status_sync_task import CustomerStatusSyncTask

class TestCustomerStatusSyncTask:
    """å®¢æˆ·çŠ¶æ€åŒæ­¥å®šæ—¶ä»»åŠ¡æµ‹è¯•"""

    def test_task_execution_success(self, db, test_customers_with_contracts):
        """æµ‹è¯•ï¼šä»»åŠ¡æ‰§è¡ŒæˆåŠŸ"""
        task = CustomerStatusSyncTask(db)
        result = task.run()

        assert result["success"] is True
        assert "total_customers" in result["data"]
        assert "fixed_customers" in result["data"]

    def test_task_fixes_inconsistent_status(self, db):
        """æµ‹è¯•ï¼šä»»åŠ¡ä¿®æ­£ä¸ä¸€è‡´çŠ¶æ€"""
        # ... æµ‹è¯•ä»£ç  ...
```

**æµ‹è¯•è¦†ç›–ç›®æ ‡**:
- å•å…ƒæµ‹è¯•è¦†ç›–ç‡ > 80%
- æ ¸å¿ƒä¸šåŠ¡é€»è¾‘è¦†ç›–ç‡ = 100%

---

## å®æ–½è®¡åˆ’

### å¼€å‘é˜¶æ®µåˆ’åˆ†

| é˜¶æ®µ | ä»»åŠ¡ | å·¥æ—¶ | è´Ÿè´£äºº | ä¾èµ– |
|------|------|------|--------|------|
| Phase 1 | ä¿®å¤ä¸šåŠ¡é€»è¾‘çŸ›ç›¾ | 2h | - | - |
| Phase 2 | å®æ–½é€šç”¨å®šæ—¶ä»»åŠ¡æ¨¡å— | 4h | - | Phase 1 |
| Phase 3 | å®ç°å®¢æˆ·çŠ¶æ€è‡ªåŠ¨åŒæ­¥ | 6h | - | Phase 1, 2 |
| Phase 4 | ä¼˜åŒ–ç­¾çº¦ç”µé‡è®¡ç®— | 2h | - | Phase 3 |
| Phase 5 | å®Œå–„æ–‡æ¡£å’Œæµ‹è¯• | 4h | - | Phase 3, 4 |

**æ€»è®¡**: çº¦ 18 å°æ—¶ï¼ˆ2-3 ä¸ªå·¥ä½œæ—¥ï¼‰

### è¯¦ç»†æ—¶é—´è¡¨

**Day 1 (8å°æ—¶)**:
- [ ] Phase 1: ä¿®å¤ä¸šåŠ¡é€»è¾‘çŸ›ç›¾ (2h)
- [ ] Phase 2: å®æ–½é€šç”¨å®šæ—¶ä»»åŠ¡æ¨¡å— (4h)
- [ ] Phase 3: å¼€å§‹å®ç°å®¢æˆ·çŠ¶æ€è‡ªåŠ¨åŒæ­¥ (2h)

**Day 2 (8å°æ—¶)**:
- [ ] Phase 3: å®Œæˆå®¢æˆ·çŠ¶æ€è‡ªåŠ¨åŒæ­¥ (4h)
- [ ] Phase 4: ä¼˜åŒ–ç­¾çº¦ç”µé‡è®¡ç®— (2h)
- [ ] Phase 5: å¼€å§‹ç¼–å†™æ–‡æ¡£å’Œæµ‹è¯• (2h)

**Day 3 (2å°æ—¶)**:
- [ ] Phase 5: å®Œæˆæ–‡æ¡£å’Œæµ‹è¯• (2h)
- [ ] è”è°ƒæµ‹è¯•å’Œ Bug ä¿®å¤

### é‡Œç¨‹ç¢‘

- **M1** (Day 1 ç»“æŸ): å®Œæˆå®šæ—¶ä»»åŠ¡æ¡†æ¶ï¼Œå¯ä»¥æ‰‹åŠ¨è§¦å‘ä»»åŠ¡
- **M2** (Day 2 ç»“æŸ): å®ç°è‡ªåŠ¨çŠ¶æ€åŒæ­¥ï¼Œé€šè¿‡å•å…ƒæµ‹è¯•
- **M3** (Day 3 ç»“æŸ): å®Œæˆæ‰€æœ‰å¼€å‘å’Œæµ‹è¯•ï¼Œå‡†å¤‡ä¸Šçº¿

---

## éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶

#### 1. ä¸šåŠ¡é€»è¾‘ä¿®å¤
- [ ] âœ… å¯ä»¥ä¸º `prospect` çŠ¶æ€çš„å®¢æˆ·åˆ›å»ºåˆåŒ
- [ ] âœ… å¯ä»¥ä¸º `pending` çŠ¶æ€çš„å®¢æˆ·åˆ›å»ºåˆåŒ
- [ ] âœ… åˆ›å»ºåˆåŒåå®¢æˆ·çŠ¶æ€è‡ªåŠ¨æ›´æ–°ï¼ˆæ— éœ€æ‰‹åŠ¨æ“ä½œï¼‰
- [ ] âœ… åˆ é™¤æœ€åä¸€ä¸ªåˆåŒåå®¢æˆ·çŠ¶æ€è‡ªåŠ¨å›é€€

#### 2. å®æ—¶çŠ¶æ€åŒæ­¥
- [ ] âœ… åˆ›å»ºç«‹å³ç”Ÿæ•ˆåˆåŒæ—¶ï¼Œ`prospect` â†’ `active`
- [ ] âœ… åˆ›å»ºæœªæ¥ç”Ÿæ•ˆåˆåŒæ—¶ï¼Œ`prospect` â†’ `pending`
- [ ] âœ… åˆ›å»ºç«‹å³ç”Ÿæ•ˆåˆåŒæ—¶ï¼Œ`pending` â†’ `active`
- [ ] âœ… æ›´æ–°åˆåŒç”Ÿæ•ˆæ—¥æœŸæ—¶ï¼Œå®¢æˆ·çŠ¶æ€è‡ªåŠ¨è°ƒæ•´
- [ ] âœ… åˆ é™¤åˆåŒåï¼Œå®¢æˆ·çŠ¶æ€è‡ªåŠ¨é‡æ–°è®¡ç®—

#### 3. å®šæ—¶ä»»åŠ¡
- [ ] âœ… å®šæ—¶ä»»åŠ¡æ¯æ—¥å‡Œæ™¨2:00è‡ªåŠ¨æ‰§è¡Œ
- [ ] âœ… å®šæ—¶ä»»åŠ¡æ‰«ææ‰€æœ‰å®¢æˆ·å¹¶ä¿®æ­£ä¸ä¸€è‡´çŠ¶æ€
- [ ] âœ… å®šæ—¶ä»»åŠ¡ç”Ÿæˆæ‰§è¡Œæ—¥å¿—å’ŒæŠ¥å‘Š
- [ ] âœ… å¯ä»¥é€šè¿‡ API æŸ¥çœ‹ä»»åŠ¡æ‰§è¡Œå†å²

#### 4. ç­¾çº¦ç”µé‡ä¼˜åŒ–
- [ ] âœ… `prospect` å®¢æˆ·ç­¾çº¦ç”µé‡æ˜¾ç¤ºä¸ºç©º
- [ ] âœ… `pending` å®¢æˆ·ä»…ç»Ÿè®¡ `pending` åˆåŒ
- [ ] âœ… `active` å®¢æˆ·ä»…ç»Ÿè®¡ `active` åˆåŒ
- [ ] âœ… `terminated` å®¢æˆ·ç­¾çº¦ç”µé‡æ˜¾ç¤ºä¸ºç©º

### è´¨é‡éªŒæ”¶

#### 1. ä»£ç è´¨é‡
- [ ] âœ… ä»£ç ç¬¦åˆ PEP 8 è§„èŒƒ
- [ ] âœ… æ‰€æœ‰æ–°ä»£ç æ·»åŠ äº†ç±»å‹æç¤º
- [ ] âœ… å…³é”®å‡½æ•°æ·»åŠ äº†å®Œæ•´çš„ docstring
- [ ] âœ… æ— æ˜æ˜¾çš„ä»£ç é‡å¤

#### 2. æµ‹è¯•è¦†ç›–
- [ ] âœ… å•å…ƒæµ‹è¯•è¦†ç›–ç‡ > 80%
- [ ] âœ… æ ¸å¿ƒä¸šåŠ¡é€»è¾‘æµ‹è¯•è¦†ç›–ç‡ = 100%
- [ ] âœ… æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹é€šè¿‡

#### 3. æ–‡æ¡£å®Œæ•´æ€§
- [ ] âœ… æŠ€æœ¯æ–‡æ¡£å®Œæ•´ï¼ˆæœ¬æ–‡æ¡£ï¼‰
- [ ] âœ… API æ–‡æ¡£å·²æ›´æ–°
- [ ] âœ… å®šæ—¶ä»»åŠ¡ä½¿ç”¨æŒ‡å—å®Œå–„
- [ ] âœ… ä»»åŠ¡å¼€å‘ç¤ºä¾‹æ¸…æ™°

### æ€§èƒ½éªŒæ”¶

- [ ] âœ… åˆ›å»ºåˆåŒå“åº”æ—¶é—´ < 500msï¼ˆåŒ…å«çŠ¶æ€åŒæ­¥ï¼‰
- [ ] âœ… å®šæ—¶ä»»åŠ¡æ‰§è¡Œæ—¶é—´ < 5åˆ†é’Ÿï¼ˆ1000ä¸ªå®¢æˆ·ï¼‰
- [ ] âœ… å®¢æˆ·åˆ—è¡¨æŸ¥è¯¢å“åº”æ—¶é—´ < 1ç§’ï¼ˆ100æ¡è®°å½•ï¼‰

### å…¼å®¹æ€§éªŒæ”¶

- [ ] âœ… ä¸å½±å“ç°æœ‰å®¢æˆ·çŠ¶æ€æµè½¬ APIï¼ˆç­¾çº¦ã€æ¿€æ´»ç­‰ï¼‰
- [ ] âœ… ä¸å½±å“ç°æœ‰åˆåŒç®¡ç†åŠŸèƒ½
- [ ] âœ… å‘å‰å…¼å®¹å†å²æ•°æ®

---

## é£é™©è¯„ä¼°

### æŠ€æœ¯é£é™©

| é£é™© | æ¦‚ç‡ | å½±å“ | åº”å¯¹æªæ–½ |
|------|------|------|---------|
| APScheduler ä¸ MongoDB é›†æˆé—®é¢˜ | ä½ | ä¸­ | æå‰è¿›è¡Œé›†æˆæµ‹è¯•ï¼Œå‡†å¤‡å¤‡ç”¨æ–¹æ¡ˆï¼ˆä½¿ç”¨å†…å­˜å­˜å‚¨ï¼‰ |
| çŠ¶æ€åŒæ­¥é€»è¾‘å¤æ‚ï¼Œæ˜“å‡ºé”™ | ä¸­ | é«˜ | ç¼–å†™å®Œæ•´çš„å•å…ƒæµ‹è¯•ï¼Œè¦†ç›–æ‰€æœ‰çŠ¶æ€è½¬æ¢åœºæ™¯ |
| å®šæ—¶ä»»åŠ¡æ‰§è¡Œå¤±è´¥æœªè¢«å‘ç° | ä¸­ | ä¸­ | æ·»åŠ ä»»åŠ¡ç›‘æ§å’Œå‘Šè­¦æœºåˆ¶ |
| å¤§é‡æ•°æ®åŒæ­¥å¯¼è‡´æ€§èƒ½é—®é¢˜ | ä½ | ä¸­ | åˆ†æ‰¹å¤„ç†ï¼Œæ·»åŠ è¿›åº¦æ—¥å¿— |

### ä¸šåŠ¡é£é™©

| é£é™© | æ¦‚ç‡ | å½±å“ | åº”å¯¹æªæ–½ |
|------|------|------|---------|
| è‡ªåŠ¨çŠ¶æ€æ›´æ–°ä¸äººå·¥æ“ä½œå†²çª | ä¸­ | é«˜ | è®°å½•çŠ¶æ€å˜æ›´å†å²ï¼ŒåŒºåˆ†è‡ªåŠ¨/æ‰‹åŠ¨æ›´æ–° |
| å†å²æ•°æ®çŠ¶æ€ä¸ä¸€è‡´ | é«˜ | ä¸­ | ä¸Šçº¿å‰è¿è¡Œä¸€æ¬¡å…¨é‡ä¿®æ­£è„šæœ¬ |
| ä¸šåŠ¡è§„åˆ™ç†è§£åå·® | ä¸­ | é«˜ | å®æ–½å‰ä¸ä¸šåŠ¡äººå‘˜ç¡®è®¤æ‰€æœ‰çŠ¶æ€è½¬æ¢è§„åˆ™ |

### è¿ç»´é£é™©

| é£é™© | æ¦‚ç‡ | å½±å“ | åº”å¯¹æªæ–½ |
|------|------|------|---------|
| å®šæ—¶ä»»åŠ¡æœªæ­£å¸¸å¯åŠ¨ | ä½ | é«˜ | æ·»åŠ åº”ç”¨å¯åŠ¨æ—¥å¿—ï¼Œç›‘æ§è°ƒåº¦å™¨çŠ¶æ€ |
| ä»»åŠ¡æ‰§è¡Œæ—¥å¿—å ç”¨å¤§é‡å­˜å‚¨ | ä¸­ | ä½ | è®¾ç½®æ—¥å¿—ä¿ç•™æœŸé™ï¼ˆå¦‚90å¤©ï¼‰ï¼Œå®šæœŸæ¸…ç† |
| æ•°æ®åº“è¿æ¥å¼‚å¸¸å¯¼è‡´ä»»åŠ¡å¤±è´¥ | ä¸­ | ä¸­ | æ·»åŠ é‡è¯•æœºåˆ¶ï¼Œè®°å½•å¤±è´¥æ—¥å¿— |

### é£é™©ç¼“è§£ç­–ç•¥

1. **ç°åº¦å‘å¸ƒ**:
   - å…ˆåœ¨æµ‹è¯•ç¯å¢ƒå®Œæ•´æµ‹è¯•1å‘¨
   - ä¸Šçº¿åè§‚å¯Ÿ3å¤©ï¼Œç›‘æ§æ—¥å¿—å’Œé”™è¯¯

2. **æ•°æ®å¤‡ä»½**:
   - ä¸Šçº¿å‰å¤‡ä»½ `customers` é›†åˆ
   - ä¿ç•™å›æ»šè„šæœ¬

3. **ç›‘æ§å‘Šè­¦**:
   - æ·»åŠ å®šæ—¶ä»»åŠ¡æ‰§è¡Œç›‘æ§
   - çŠ¶æ€ä¸ä¸€è‡´æ•°é‡è¶…è¿‡é˜ˆå€¼æ—¶å‘Šè­¦

4. **å¿«é€Ÿå›æ»š**:
   - å‡†å¤‡åŠŸèƒ½å¼€å…³ï¼Œå¯å¿«é€Ÿç¦ç”¨è‡ªåŠ¨åŒæ­¥
   - å‡†å¤‡æ•°æ®å›æ»šè„šæœ¬

---

## é™„å½•

### A. ç›¸å…³ä»£ç æ–‡ä»¶æ¸…å•

#### æ–°å¢æ–‡ä»¶ï¼ˆ12ä¸ªï¼‰

1. `webapp/scheduler/__init__.py` - è°ƒåº¦å™¨æ¨¡å—åˆå§‹åŒ–
2. `webapp/scheduler/base_task.py` - ä»»åŠ¡åŸºç±»
3. `webapp/scheduler/task_registry.py` - ä»»åŠ¡æ³¨å†Œå™¨
4. `webapp/scheduler/scheduler_manager.py` - è°ƒåº¦å™¨ç®¡ç†å™¨
5. `webapp/scheduler/tasks/__init__.py` - ä»»åŠ¡åŒ…åˆå§‹åŒ–
6. `webapp/scheduler/tasks/customer_status_sync_task.py` - å®¢æˆ·çŠ¶æ€åŒæ­¥ä»»åŠ¡
7. `webapp/services/customer_status_sync_service.py` - çŠ¶æ€åŒæ­¥æœåŠ¡
8. `tests/test_customer_status_sync_service.py` - çŠ¶æ€åŒæ­¥æœåŠ¡æµ‹è¯•
9. `tests/test_scheduler.py` - è°ƒåº¦å™¨æ¡†æ¶æµ‹è¯•
10. `tests/test_customer_status_sync_task.py` - å®šæ—¶ä»»åŠ¡æµ‹è¯•
11. `docs/pages/é€šç”¨å®šæ—¶ä»»åŠ¡/å®æ–½æŒ‡å—.md` - å®šæ—¶ä»»åŠ¡ä½¿ç”¨æŒ‡å—
12. `docs/pages/é€šç”¨å®šæ—¶ä»»åŠ¡/ä¸šåŠ¡ä»»åŠ¡å®ç°ç¤ºä¾‹.md` - ä»»åŠ¡å¼€å‘ç¤ºä¾‹

#### ä¿®æ”¹æ–‡ä»¶ï¼ˆ5ä¸ªï¼‰

1. `webapp/services/contract_service.py` - é›†æˆå®æ—¶çŠ¶æ€åŒæ­¥
2. `webapp/services/customer_service.py` - ä¼˜åŒ–ç­¾çº¦ç”µé‡è®¡ç®—
3. `webapp/main.py` - é›†æˆå®šæ—¶ä»»åŠ¡è°ƒåº¦å™¨
4. `requirements.txt` - æ·»åŠ  `apscheduler` ä¾èµ–
5. `docs/pages/å®¢æˆ·æ¡£æ¡ˆç®¡ç†/å®¢æˆ·æ¡£æ¡ˆçŠ¶æ€é€»è¾‘.md` - æ·»åŠ è‡ªåŠ¨åŒæ­¥è¯´æ˜

### B. æ•°æ®åº“é›†åˆ

#### æ–°å¢é›†åˆ

1. **apscheduler_jobs** - APScheduler ä»»åŠ¡å­˜å‚¨
   ```javascript
   {
     _id: ObjectId,
     next_run_time: ISODate,
     job_state: Binary,
     ...
   }
   ```

2. **task_execution_history** - ä»»åŠ¡æ‰§è¡Œå†å²
   ```javascript
   {
     _id: ObjectId,
     task_name: String,
     start_time: ISODate,
     end_time: ISODate,
     duration_seconds: Number,
     status: String,  // "success" | "failed"
     result: Object,
     error: String,
     created_at: ISODate
   }
   ```

3. **customer_status_change_history** - å®¢æˆ·çŠ¶æ€å˜æ›´å†å²ï¼ˆå¯é€‰ï¼‰
   ```javascript
   {
     _id: ObjectId,
     customer_id: String,
     customer_name: String,
     old_status: String,
     new_status: String,
     change_type: String,  // "auto" | "manual"
     reason: String,
     operator: String,
     created_at: ISODate
   }
   ```

### C. ä¾èµ–é¡¹

**æ–°å¢ Python åŒ…**:
```
apscheduler>=3.10.0
```

**ç°æœ‰ä¾èµ–**ï¼ˆæ— éœ€æ›´æ”¹ï¼‰:
- FastAPI
- Motor (MongoDB async driver)
- Pydantic

### D. å‚è€ƒæ–‡æ¡£

1. [å®¢æˆ·æ¡£æ¡ˆçŠ¶æ€é€»è¾‘.md](./å®¢æˆ·æ¡£æ¡ˆçŠ¶æ€é€»è¾‘.md) - å®¢æˆ·çŠ¶æ€ä¸šåŠ¡éœ€æ±‚
2. [å®¢æˆ·æ¡£æ¡ˆçŠ¶æ€é‡æ„æ€»ç»“.md](./å®¢æˆ·æ¡£æ¡ˆçŠ¶æ€é‡æ„æ€»ç»“.md) - ä¹‹å‰çš„çŠ¶æ€é‡æ„æ€»ç»“
3. [é€šç”¨å®šæ—¶ä»»åŠ¡æ¨¡å—è®¾è®¡æ–¹æ¡ˆ.md](../é€šç”¨å®šæ—¶ä»»åŠ¡/é€šç”¨å®šæ—¶ä»»åŠ¡æ¨¡å—è®¾è®¡æ–¹æ¡ˆ.md) - å®šæ—¶ä»»åŠ¡æ¡†æ¶è®¾è®¡
4. [é›¶å”®åˆåŒç®¡ç†æ¨¡å—è®¾è®¡æ–¹æ¡ˆ.md](../é›¶å”®åˆåŒç®¡ç†/é›¶å”®åˆåŒç®¡ç†æ¨¡å—è®¾è®¡æ–¹æ¡ˆ.md) - åˆåŒç®¡ç†è®¾è®¡

### E. è”ç³»æ–¹å¼

**æŠ€æœ¯æ”¯æŒ**: å¼€å‘å›¢é˜Ÿ
**ä¸šåŠ¡å’¨è¯¢**: äº§å“å›¢é˜Ÿ
**é—®é¢˜åé¦ˆ**: æäº¤ Issue åˆ°é¡¹ç›®ä»“åº“

---

**æ–‡æ¡£ç»“æŸ**
