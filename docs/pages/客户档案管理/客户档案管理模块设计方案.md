

### 客户档案管理数据库方案：单一集合（嵌入式）

**集合名称：** `customers`

此集合将合并 `user_profiles`、`meters` 和 `measure_point` 的信息。

#### 1\. 数据结构 (Schema)

```json
// "customers" 集合
{
  "_id": ObjectId(),
  
  // --- 客户档案 (来自 7.1 user_profiles) ---
  "user_name": "丰城超胜塑业有限公司", //
  "short_name": "超胜塑业", //
  "industry": "制造业", //
  "voltage": "10kV", //
  "region": "宜春市", //
  "address": "丰城市...", //
  "location": { "type": "Point", "coordinates": [ 115.78, 28.19 ] }, //
  // --- 嵌入的电力资产 (来自 7.2, 7.3, user_hierarchy_final.json) ---
  "utility_accounts": [ //
    {
      "account_id": "3600581282967", //
      "metering_points": [ //
        {
          "metering_point_id": "235904607", //
          "allocation_percentage": 97.0, //
          
          // --- 嵌入的电表信息 ---
          "meter": {
            "meter_id": "3630001201800010787577", //
            "multiplier": 1.5 // (来自 7.2 meters)
          }
        },
        {
          "metering_point_id": "235904611", //
          "allocation_percentage": 3.0, //
          
          // --- 冗余的电表信息 ---
          "meter": {
            "meter_id": "3630001201800010787577", //
            "multiplier": 1.5 // (来自 7.2 meters)
          }
        }
      ]
    }
  ]
}
```

#### 2\. 方案的优缺点

**优点 (Pros):**

  * **读取性能极高**：
      * 获取一个客户的**所有**档案信息（包括户号、计量点、电表倍率）只需要**一次数据库查询** (`db.customers.findOne(...)`)。
      * 这使得客户档案详情页的后端逻辑非常简单，不需要 `$lookup` 或多次查询。
  * **开发简单直观**：
      * 数据结构与您的业务对象（和UI界面）完全匹配。从数据库读取的JSON可以直接发送到前端使用。
  * **数据原子性**：
      * 对单个客户（包括其所有户号和计量点）的修改在单个文档内完成，是原子操作。

**缺点 (Cons) - 以及为什么在您的小规模下可以接受：**

  * **数据冗余（核心缺点）**：
      * 如上例所示，电表 "..."7577" 的信息（尤其是 `multiplier`）被**重复存储了两次**。
      * *权衡*：在总数据量\<1000的情况下，这点硬盘空间冗余可以忽略不计。
  * **更新复杂度高**：
      * 如果电表 "..."7577" 的倍率（`multiplier`）变了，您必须执行一个复杂的 `updateMany` 操作，搜索 `customers` 集合中**所有** `utility_accounts.metering_points.meter.meter_id` 为 "..."7577" 的地方，并全部更新。
      * *权衡*：在数据量\<1000时，这个更新操作虽然“不优雅”，但执行速度**仍然会非常快**。您只需要确保更新脚本是正确的。
  * **查询灵活性差**：
      * 无法简单地“查询所有电表”。您必须通过聚合（Aggregation）才能从所有客户文档中“提取”出唯一的电表列表。
      * *权衡*：如果您的系统**几乎所有查询都是“以客户为中心”**（例如：99%的查询都是 `find by user_name` 或 `find by user_id`），那么这个缺点对您没有影响。

-----

### ‼️ 重要建议：必须分离“时间序列数据”

这个“单一集合”方案**仅适用于“客户档案”**（即 `user_profiles`、`meters`、`measure_point`）。

您**绝对不能**将以下数据也嵌入到 `customers` 集合中：

1.  **`mp_load_curve` (计量点负荷曲线)**
2.  **`meter_data` (电表数据)**
3.  **`real_time_spot_price` (现货价格)**
4.  **`spot_settlement_period` (分时结算明细)**

**结论**：这个方案（`customers` 集合采用嵌入模式）是可行的，它**最大化了开发简单性**，并且其缺点在您的小数据量规模下是完全可控的。

---

### 客户档案管理 UI 方案（单一集合版）

#### 1. 主页面：客户列表 (Customer List)

**目的**：搜索、浏览并选择一个客户进行管理。

* **布局**：标准表格。
* **操作栏**：
    * `[ + 新建客户 ]` 按钮
    * `[ 搜索框 ]` (按客户全称、简称搜索)
    * `[ 筛选器 ]` (按下拉菜单：客户类型、行业、电压等级)
* **表格列**：
    * **客户全称** (主链接，点击进入详情页)
    * **客户类型** (`user_type` - 例如 "标准工商业", "电气化铁路")
    * **行业**
    * **电压等级**
    * **户号数量** (计算值：`utility_accounts` 数组的长度)
    * **操作** (`[ 编辑 ]` (即进入详情页), `[ 删除 ]`)
* **删除操作**：点击 `[ 删除 ]` 时，弹窗确认：“您确定要删除 [客户名称] 及其所有户号和计量点信息吗？”。由于是单一集合，一次删除即可。

---

#### 2. 详情/编辑页：客户档案 (Customer Profile)

**目的**：管理一个客户的**所有**信息，包括其嵌套的户号、计量点和电表。

* **URL**：`/customers/{customer_id}`
* **页面标题**：`[ 客户全称 ]` (例如："丰城超胜塑业有限公司")
* **布局**：使用**标签页 (Tabs)** 来分离不同的关注点。

##### 标签页 1: 客户档案 (Profile)

**目的**：编辑文档的“根级别”字段。

* **布局**：一个简单的表单。
* **表单字段**：
    * `客户全称`: `[ 丰城超胜塑业有限公司 ]`
    * `客户简称`: `[ 超胜塑业 ]`
    * `客户类型`: `[ 下拉菜单: 标准工商业 | 电气化铁路牵引 | ... ]`
    * `行业`: `[ 制造业 ]`
    * `电压等级`: `[ 10kV ]`
    * `地区`: `[ 宜春市 ]`
    * `详细地址`: `[ 丰城市... ]`
    * `[ 保存 ]` `[ 取消 ]` 按钮（仅保存此标签页的更改）。

##### 标签页 2: 户号与计量点 (Accounts & Metering Points)

**目的**：管理 `utility_accounts` 嵌套数组。这是**核心管理界面**。

* **布局**：采用**“卡片列表”**，每个“户号”一张卡片。
* **页面操作**：`[ + 添加户号 ]` 按钮。
    * **点击**：弹出一个简单模态框，只需输入 `户号 (account_id)`。
    * **保存**：向 `customers` 文档的 `utility_accounts` 数组中添加一个新对象 `{ "account_id": "...", "metering_points": [] }`，并刷新此标签页。

* **[ 户号卡片 1 ]**
    * **卡片标题**：`户号: 3600581282967`
    * **卡片操作**：`[ + 添加计量点 ]` `[ 🗑️ 删除此户号 ]`
    * **卡片内容**：一个显示 `metering_points` 数组的表格。

| 计量点ID (mp_id) | 电表资产号 (meter_id) | 倍率 (multiplier) | 分摊比例 (%) | 操作 |
| :--- | :--- | :--- | :--- | :--- |
| `235904607` | `...7577` | `1.5` | `97.0` | `[ 编辑 ]` `[ 删除 ]` |
| `235904611` | `...7577` | `1.5` | `3.0` | `[ 编辑 ]` `[ 删除 ]` |

* **[ 户号卡片 2 ]**
    * **卡片标题**：`户号: (另一个户号...)`
    * ... (内容同上) ...

---

### 3. 核心交互：添加/编辑计量点（模态框）

这是管理**“单一集合”方案中冗余数据**的关键界面。

当用户点击 `[ + 添加计量点 ]` 或 `[ 编辑 ]` 时，弹出此模态框：

**模态框标题**：`为户号 3600581282967 添加/编辑计量点`

**表单字段**：
1.  `计量点ID`: `[ 文本输入 ]`
2.  `分摊比例 (%)`: `[ 数字输入 ]`
3.  **电表信息 (嵌入的 `meter` 对象)**:
    * `电表资产号 (meter_id)`: `[ 文本输入 ]`
    * `倍率 (multiplier)`: `[ 数字输入 ]`

**[ 保存 ]** **[ 取消 ]**

---

### ‼️ 关键 UI 交互：管理数据冗余

单一集合的**最大风险**是数据不一致（例如，同一个 `meter_id` 在两个地方有不同的 `multiplier`）。UI 必须帮助用户避免这个问题。

**建议：在“电表资产号”字段上增加“智能辅助”：**

1.  **自动填充 (Autofill)**：
    * 当用户在 `电表资产号` 字段输入时 (例如 `...7577`)，系统**立即在当前客户的整个文档中**搜索该 `meter_id`。
    * 如果找到匹配项（如上例中的 `...4607`），系统**自动填充** `倍率` 字段（例如 `1.5`）。
    * 并在字段下显示一条帮助信息：`ⓘ 检测到该电表已在别处使用 (倍率 1.5)，已自动填充。`

2.  **同步更新确认 (Update Consistency Check)**：
    * 如果用户**编辑**一个已存在的计量点，并**修改了 `倍率`**（例如，将 `1.5` 改为 `2.0`）。
    * 在点击 `[ 保存 ]` 时，系统检测到这个 `meter_id` (`...7577`) 在此客户文档中还被其他计量点（`...4611`）使用。
    * 系统应弹出一个**确认框**：

    > **同步更新？**
    >
    > 您修改了电表 `...7577` 的倍率。该电表在此客户名下共被 `2` 个计量点使用。
    >
    > * `[ (•) 仅更新此计量点 ]` (这可能导致数据不一致)
    > * `[ ( ) 同步更新所有 X 个计量点 ]` (推荐)
    >
    > **[ 确认 ]** **[ 取消 ]**

通过这个 UI 辅助功能，您可以享受到“单一集合”带来的开发和读取便利，同时又在应用层上解决了其最大的数据一致性风险。