# 负荷数据校验功能 - 业务需求文档 v1.2

**版本**: 1.2
**日期**: 2025-11-12
**状态**: 待开发
**修订**: 完善UI设计和数据导入逻辑

---

## 📋 版本变更说明

### v1.1 → v1.2 主要变更

1. **UI设计大幅简化**：从3个Tab简化为单页面，一张表同时展示完整性和校核状态
2. **明确数据导入逻辑**：支持单文件/批量导入，明确数据覆盖策略和失败处理
3. **增加负荷曲线重新生成功能**：修改分配系数后可重新生成历史曲线
4. **完整度详情增加刷新按钮**：支持单独重新计算完整度
5. **移动端适配**：卡片式布局支持手机/平板
6. **去除冗余功能**：不保存校核历史、不导出报告、不计算复杂统计指标

---

## 1. 项目背景

### 1.1 数据源说明

系统存在两种核心的负荷数据来源：

1.  **手工导入的电表示数数据（负荷曲线）**
    - **来源**: 电力交易中心，通过Excel文件手工导入
    - **用途**: 用于负荷预测、曲线展示、用电特征分析
    - **粒度**: 96点/日（15分钟）
    - **特点**:
      - 数据周期长（可达1年以上）
      - 更新频率较低（每日一次或按需导入）
      - **是获取近期（T-1日）数据的最快途径**
      - 数据为电能表示数（累计值）

2.  **RPA自动采集的结算数据**
    - **来源**: 电力交易中心平台，通过RPA程序自动爬取
    - **用途**: 用于交易结算（权威数据）
    - **粒度**: 48点/日（30分钟）
    - **特点**:
      - 权威性高（官方处理，用于最终结算）
      - 自动化获取，包含官方的缺点补录、换表处理等
      - 数据周期短（仅客户签约后）
      - **延迟高（T-2，即今天只能获取前天的数据）**
      - 数据为计量点级别的时段用电量（差值）

### 1.2 核心问题

**数据同源性**：
- 手工导入数据和RPA采集数据**本质上来自同一数据源**（电力交易中心）
- 但处理方式不同：
  - RPA数据：官方处理后的权威数据
  - 手工数据：我方自行处理

**核心问题**：
- 手工导入数据中的**电表-计量点分配系数（allocation_percentage）是自行估算的**
- 这些估算的系数可能存在较大误差
- 需要通过与权威的RPA结算数据对比来**验证和定位分配系数问题**

**误差容忍度**：
- ✅ 可忽略：两者因处理方法差异（如缺点补录方法不同）产生的小幅度误差（<5%）
- ⚠️ 需修正：分配系数不准确导致的系统性偏差（≥5%）

### 1.3 数据关系

**用户-电力户号-计量点-电能表关系**：
```
用户 (Customer)
  └─ 户号 (Utility Account) [1对多]
       └─ 计量点 (Metering Point) [1对多]
            └─ 电表 (Meter) [多对1]
                 └─ 分配系数 (allocation_percentage)
```

**关键约束**：
- 一个电表可以被多个计量点共享
- 每个电表下所有计量点的分配系数总和 ≤ 100%
- 每个计量点的分配系数：0% ≤ allocation_percentage ≤ 100%

---

## 2. 业务目标

1.  **验证分配系数准确性**：通过对比手工数据和权威RPA数据，识别分配系数是否合理
2.  **快速定位问题计量点**：深入到计量点级别，找出哪个计量点的系数有问题
3.  **提升数据质量监控能力**：建立简洁的可视化界面，直观展示每个客户的数据完整度
4.  **构建健壮的分析基础**：确保负荷预测等核心功能在部分数据缺失时依然能可靠运行

---

## 3. 核心功能

### 3.1 数据质量管理主页面

**设计原则**：
- 简洁至上：一张表同时展示完整性和校核状态
- 快速定位：支持搜索、排序，一眼发现问题客户
- 移动优先：支持手机/平板操作

**页面结构**：
```
┌─ 全局统计卡片（4个）─┐
│ 总客户 | 健康 | 警告 | 严重 │
└───────────────────────┘

┌─ 搜索与操作区 ─────────┐
│ [搜索] [排序▼]        │
│ [数据导入][批量校核][完整度分析] │
└───────────────────────┘

┌─ 客户数据质量表 ───────────────────────────┐
│ 客户 | 负荷曲线 | 结算曲线 | 校核状态 | 操作 │
│      | 天/更新/率 | 天/更新/率 | 日期/偏差 |     │
│ ────┼────────┼────────┼────────┼─────── │
│ xx物资│71/11-11│67/11-09│11-10   │[详情]  │
│      │   /90% │   /97% │ -2.1%✓ │[校核]  │
└───────────────────────────────────────────┘
```

**表格列说明**：
1. **客户名称**：仅显示签约客户
2. **负荷曲线**：
   - 总天数：从第一条数据到最后一条数据的天数
   - 最后更新：最后一条数据的日期
   - 完整率：实际天数/期望天数（期望截止=T-1）
3. **结算曲线**：
   - 总天数、最后更新、完整率（期望截止=T-2）
4. **校核状态**：
   - 校核日期：最近一次校核的日期
   - 偏差率：用户级平均偏差率
5. **操作**：
   - 📊 详情：弹窗查看完整度详情
   - 🔍 校核：弹窗执行数据校核

**全局操作按钮**：
1. **📤 数据导入**：导入96点电表示数数据
2. **⚡ 批量校核**：选择多个客户执行用户级校核
3. **🔄 完整度分析**：重新分析所有客户的数据完整度

### 3.2 完整度详情（弹窗）

**功能**：
- 查看单个客户的数据完整性详情
- 可视化数据时间线
- 列出缺失日期
- 支持单独刷新该客户的完整度

**页面元素**：
```
┌─ 完整度详情 - 客户名称 ───┐
│ [🔄 刷新] [❌ 关闭]      │
├───────────────────────────┤
│ 上次更新: 2025-11-11 08:00 │
│                            │
│ ┌─ 负荷曲线 ─┬─ 结算曲线 ─┐│
│ │完整度 90%  │完整度 97%  ││
│ │总天数 71天 │总天数 67天 ││
│ │缺失 7天    │缺失 2天    ││
│ │起始 09-01  │起始 09-05  ││
│ │截止 11-10  │截止 11-08  ││
│ └───────────┴───────────┘│
│                            │
│ 📊 数据覆盖时间线          │
│ [可视化条形图]             │
│                            │
│ ▼ 缺失日期明细             │
│ 负荷: 09-15, 10-03, ...   │
│ 结算: 09-20, 10-15        │
│                            │
│         [关闭]             │
└───────────────────────────┘
```

**刷新按钮**：
- 功能：重新计算该客户的数据完整度
- 适用场景：导入新数据后，单独更新某个客户
- 操作流程：点击刷新 → 显示进度 → 自动更新页面

### 3.3 数据校核（弹窗）

**设计原则**：
- 分两步：先用户级（自动）→ 再计量点级（手动）
- 简化输出：只显示偏差率，不计算其他统计指标
- 聚焦目标：找出问题计量点即可，不做系数推荐

**Step 1: 用户级校核（自动执行）**

```
┌─ 数据校核 - 客户名称 ─────┐
│ [❌ 关闭]                 │
├───────────────────────────┤
│ 校核日期: [◀ 11-10 ▶]    │
│           [🔄 重新校核]   │
│                            │
│ 📊 用户级校核结果          │
│                            │
│ ┌─────────────────────┐   │
│ │ 平均偏差率: -6.8% ⚠️│   │
│ │ 偏差率≥5%，建议深入 │   │
│ │ 分析计量点级数据    │   │
│ └─────────────────────┘   │
│                            │
│ 📈 曲线对比图 (48点)      │
│ [折线图可视化]            │
│                            │
│ [📋 计量点级校核] [关闭]  │
└───────────────────────────┘
```

**判断逻辑**：
- 偏差率 < 5%：显示"✓ 偏差正常"，无需深入
- 偏差率 ≥ 5%：显示"⚠️ 建议深入分析"，启用"计量点级校核"按钮

**Step 2: 计量点级校核（手动触发）**

点击"计量点级校核"按钮后：

```
┌─ 计量点级校核 ─ 客户名称 ─┐
│ [❌ 关闭]                 │
├───────────────────────────┤
│ ⏳ 正在分析...（临时计算） │
│ [████████░░] 80%          │
└───────────────────────────┘
```

计算完成后：

```
┌─ 计量点级校核 ─ 客户名称 ─┐
│ [❌ 关闭]                 │
├───────────────────────────┤
│ 📋 计量点偏差分析          │
│                            │
│ ┌─ 表格 ─────────────┐   │
│ │计量点│电表│系数│偏差││   │
│ ├──────┼────┼────┼────┤│   │
│ │211474│...9│65% │-9% ││   │
│ │252   │8898│    │ ⚠️ ││   │
│ ├──────┼────┼────┼────┤│   │
│ │211474│...1│63% │-4% ││   │
│ │253   │1259│    │ ✓  ││   │
│ └──────┴────┴────┴────┘│   │
│                            │
│ ⚠️ 问题定位:              │
│ 计量点 211474252          │
│ 偏差率 -9.2%，显著偏低    │
│                            │
│ 💡 建议:                  │
│ 检查该计量点的分配系数    │
│ 65% 是否准确              │
│                            │
│         [关闭]             │
└───────────────────────────┘
```

**输出内容**：
- 计量点级偏差率表格
- 问题定位（偏差最大的计量点）
- 建议操作（无自动推荐系数）

### 3.4 数据导入

**支持两种模式**：
1. **单文件导入**：选择单个Excel文件
2. **批量导入**：选择目录，自动扫描所有Excel文件

**Excel文件识别规则**：
- **优先**：读取Excel内容，查找"电表ID"列
- **回退**：如果Excel内无电表ID列，从文件名提取
- **格式要求**：
  - 文件名格式：`电表ID_月份.xlsx`（如：`3630001492249049029898_2025-11.xlsx`）
  - Excel格式：包含"日期时间"、"电表ID"（可选）、"示数"列

**数据处理策略**：
- **覆盖策略**：跳过重复数据（不覆盖已有数据）
- **失败处理**：部分成功（失败的跳过，成功的保留）
- **自动处理**：
  1. 保存原始96点数据到 `user_load_data`
  2. 转换聚合为48点用户级数据到 `load_curve_user`
  3. 可选：自动触发完整度分析

**导入界面流程**：

```
Step 1: 选择文件/目录
  ↓
Step 2: 预览扫描结果（识别电表ID、数据点数）
  ↓
Step 3: 设置导入选项
  - ☑ 跳过重复数据
  - ☑ 导入后自动生成用户级曲线
  - ☑ 导入后自动触发完整度分析
  ↓
Step 4: 开始导入（显示进度）
  ↓
Step 5: 完成报告（成功/失败统计）
```

### 3.5 批量校核

**功能**：
- 选择多个客户
- 指定校核日期
- 批量执行用户级校核

**流程**：
```
Step 1: 选择客户（支持全选）
  ↓
Step 2: 指定校核日期
  ↓
Step 3: 开始校核（显示进度）
  ↓
Step 4: 更新主表格的"校核状态"列
```

**输出**：仅更新主表格，不保存历史记录

### 3.6 完整度分析

**功能**：
- 一键重新分析所有客户的数据完整度
- 更新主表格的"负荷曲线"和"结算曲线"列

**触发时机**：
- 手动：点击"完整度分析"按钮
- 自动：数据导入后（可选）

### 3.7 负荷曲线重新生成

**场景**：修改客户档案中的分配系数后，需要重新生成历史用户级曲线

**入口1：客户档案管理（主要）**

修改分配系数并保存后：
```
弹窗提示：
  ✓ 分配系数已更新
  ⚠️ 需要重新生成用户负荷曲线
  是否立即重新生成？

  [立即重新生成] [稍后手动执行]
```

选择"立即重新生成"：
```
显示进度：
  ⏳ 正在处理...
  [████████░░] 75%
  当前进度: 2025-11-08
  已处理: 54天 / 共71天
```

完成后：
```
弹窗提示：
  ✓ 用户负荷曲线重新生成完成
  处理结果:
  • 重新生成: 71天数据
  • 耗时: 2分15秒

  💡 建议: 前往【数据质量管理】
     重新执行数据校核，查看改进效果
```

**入口2：数据质量管理（辅助）**

在主表格中增加操作按钮：
```
┌─ 操作列 ─────────┐
│ [📊详情]         │
│ [🔍校核]         │
│ [🔄重新生成曲线] │
└──────────────────┘
```

点击"重新生成曲线"直接开始重新生成

**重要说明**：
- 重新生成会覆盖该客户所有历史用户级曲线数据
- 基于当前客户档案中的分配系数重新计算
- 原始96点数据不受影响

---

## 4. 核心业务逻辑

### 4.1 数据处理与存储（数据源纯粹性原则）

#### A. 原始数据保留
- `user_load_data`：96点电能表示数，作为不可更改的原始凭证
- `mp_load_curve`：48点RPA结算数据（计量点级），作为权威数据源

#### B. 标准化曲线存储
系统维护**两份完全独立**的48点用户级曲线数据库：

1. **负荷曲线库（load_curve_user）**
   - 来源：手工导入的96点示数数据
   - 处理：聚合转换（示数→用电量，96点→48点）→ 按分配系数聚合到用户级
   - 用途：负荷预测、用电分析

2. **结算曲线库（settlement_curve_user）**
   - 来源：RPA采集的48点结算数据（计量点级）
   - 处理：按分配系数聚合到用户级
   - 用途：交易结算、权威对比基准

**严禁混合**：两个库的数据不能相互污染

### 4.2 数据校核

#### A. 校核目的
- 对比"负荷曲线库"与"结算曲线库"的偏差
- 识别分配系数是否合理
- 定位问题计量点

#### B. 校核流程（简化版）

```
Step 1: 用户级快速对比
  - 查询 load_curve_user[选定日期] → 48点数据L
  - 查询 settlement_curve_user[选定日期] → 48点数据S
  - 计算偏差率：deviation_rate = mean((L - S) / S × 100)
  - 生成曲线对比图
  ↓
Step 2: 判断是否需要深入
  - 如果 |偏差率| < 5% → 结束，系数可能合理
  - 如果 |偏差率| ≥ 5% → 用户可选择进入Step 3
  ↓
Step 3: 计量点级深入分析（手动触发）
  - 临时计算：user_load_data → 计量点级48点数据
  - 对比：计量点级负荷数据 vs mp_load_curve
  - 计算：各计量点的偏差率
  - 输出：问题计量点列表 + 建议
```

#### C. 简化要点
- **不保存历史**：校核结果仅更新主表格，不创建历史记录
- **只算偏差率**：不计算RMSE、相关系数等复杂指标
- **不做推荐**：只定位问题，不自动推荐系数
- **手动深入**：不设阈值自动触发，由用户决定是否深入分析

### 4.3 数据完整性分析

#### A. 分析目的
- 分析两个曲线库的数据完整性
- 识别数据起止日期、缺失日期
- 计算完整度指标

#### B. 触发时机
- **自动触发**：数据导入后（可选）
- **手动触发**：
  1. 点击"完整度分析"按钮（全局）
  2. 点击"刷新"按钮（单客户，在完整度详情弹窗中）

#### C. 完整性计算

```python
# 负荷曲线库（手工导入）
first_date = 第一条数据的日期
expected_end_date = today - 1天  # T-1
期望天数 = (expected_end_date - first_date) + 1
实际天数 = 有完整48点数据的天数
完整度 = (实际天数 / 期望天数) × 100%

# 结算曲线库（RPA采集）
first_date = 第一条数据的日期
expected_end_date = today - 2天  # T-2
期望天数 = (expected_end_date - first_date) + 1
实际天数 = 有完整48点数据的天数
完整度 = (实际天数 / 期望天数) × 100%
```

**注意**：两类数据的完整度**分开计算**

### 4.4 应用层数据借用逻辑

#### A. 负荷预测模块

**目标**：优先使用T-1日的手工导入数据

```
[负荷预测请求]
  ↓
[1] 查询 load_curve_user[T-1日]
  ├─ 有数据 → 返回，使用模式A（高精度预测）
  └─ 无数据 → 进入步骤2
  ↓
[2] 查询 settlement_curve_user[T-2日]
  ├─ 有数据 → 返回，使用模式B（备用预测）
  └─ 无数据 → 进入步骤3
  ↓
[3] 都无数据
  └─ 跳过预测，标记"数据不足，无法预测"
```

#### B. 预结算模块

**目标**：优先使用权威的RPA结算数据

```
[预结算请求]
  ↓
[1] 查询 settlement_curve_user[指定日期]
  ├─ 有数据 → 返回（权威数据）
  └─ 无数据 → 进入步骤2
  ↓
[2] 查询 load_curve_user[指定日期]
  ├─ 有数据 → 返回（临时代理，需标注）
  └─ 无数据 → 进入步骤3
  ↓
[3] 都无数据
  └─ 提示"数据不足，无法计算预结算"
```

**重要**：
- 借用的数据仅在内存中使用
- **不持久化**到对方的数据库
- 预结算使用手工数据时，需明确标注为"临时估算"

---

## 5. 特殊场景处理

### 5.1 换表事件

**场景**：电表更换（发生概率极小）

**处理方案**：数据库手工修正

#### 步骤1：更新客户档案
```javascript
// MongoDB Shell
db.customers.updateOne(
  { "_id": ObjectId("customer_id") },
  {
    "$set": {
      "utility_accounts.0.metering_points.0.meter.meter_id": "新电表ID",
      "updated_at": new Date(),
      "updated_by": "admin",
      "update_reason": "2025-10-16换表"
    }
  }
)
```

#### 步骤2：标记历史数据（可选）
```javascript
// 在user_load_data中标记换表前的数据
db.user_load_data.updateMany(
  {
    "meter_id": "旧电表ID",
    "timestamp": { "$lte": ISODate("2025-10-15T23:59:59Z") }
  },
  {
    "$set": {
      "meter_replaced": true,
      "replaced_date": "2025-10-16"
    }
  }
)
```

#### 步骤3：重新生成负荷曲线
- 使用"负荷曲线重新生成"功能
- 基于新的电表配置重新计算

#### 步骤4：校核建议
- 换表前数据：使用旧配置
- 换表后数据：使用新配置
- 不建议跨换表日期进行校核

---

## 6. 数据质量标准

### 6.1 完整度等级

| 等级 | 完整度范围 | 状态 | 建议操作 |
|------|-----------|------|---------|
| 健康 | ≥ 90% | 🟢 绿色 | 保持现状 |
| 警告 | 70% ~ 89% | 🟡 黄色 | 建议补充数据 |
| 严重 | < 70% | 🔴 红色 | 必须补充数据 |

### 6.2 偏差容忍度

| 偏差率 | 评估 | 建议操作 |
|--------|------|---------|
| < 5% | 正常 | 无需调整系数 |
| ≥ 5% | 异常 | 建议深入分析 |

---

## 7. 响应式设计要求

### 7.1 桌面端（≥1200px）
- 完整表格显示（9列）
- 统计卡片横排4个
- 弹窗宽度：600-800px

### 7.2 平板端（768px - 1199px）
- 表格横向滚动或合并部分列
- 统计卡片2×2网格
- 弹窗宽度：自适应（80%屏宽）

### 7.3 手机端（<768px）
- 卡片式列表布局（替代表格）
- 统计卡片2×2网格
- 弹窗全屏显示
- 操作按钮堆叠排列

### 7.4 移动端关键适配
```
主页面：
┌─────────────────┐
│ [统计卡片2×2]  │
│ [搜索框]        │
│ [按钮堆叠]      │
│ ┌─ 卡片1 ─────┐│
│ │ 客户名称     ││
│ │ 负荷: 71天   ││
│ │      90% 🟢  ││
│ │ 结算: 67天   ││
│ │      97% 🟢  ││
│ │ 校核: 11-10  ││
│ │      -2.1%✓  ││
│ │ [详情][校核] ││
│ └─────────────┘│
│ [卡片2...]      │
└─────────────────┘
```

---

## 8. 交互流程

### 8.1 日常监控流程
```
1. 进入数据质量管理页面
2. 查看全局统计卡片（快速了解整体情况）
3. 扫描主表格，查看各客户的完整度和校核状态
4. 发现异常客户（完整度<90% 或 偏差率≥5%）
5. 点击"详情"或"校核"按钮深入分析
```

### 8.2 数据导入流程
```
1. 点击"数据导入"按钮
2. 选择单文件或目录（批量）
3. 预览扫描结果，确认电表ID识别正确
4. 设置导入选项：
   - ☑ 跳过重复数据
   - ☑ 导入后自动生成用户级曲线
   - ☑ 导入后自动触发完整度分析
5. 开始导入，查看进度
6. 完成后查看导入报告
7. 返回主页面，查看更新后的完整度
```

### 8.3 数据校核流程
```
1. 在主表格中找到目标客户
2. 点击"校核"按钮
3. 选择或确认校核日期
4. 查看用户级校核结果（偏差率、曲线对比图）
5. 如果偏差率≥5%：
   a. 点击"计量点级校核"按钮
   b. 等待临时计算完成
   c. 查看各计量点的偏差率
   d. 识别问题计量点
6. 前往客户档案管理，修改分配系数
7. 触发负荷曲线重新生成
8. 返回数据质量管理，重新校核验证
```

### 8.4 系数修正流程
```
1. 数据校核发现计量点211474252偏差-9.2%
2. 前往【客户档案管理】
3. 找到该客户，编辑计量点信息
4. 修改分配系数：65% → 70%
5. 保存，弹窗提示"需要重新生成用户负荷曲线"
6. 选择"立即重新生成"
7. 等待处理完成（1-3分钟）
8. 返回【数据质量管理】
9. 重新校核该客户
10. 验证偏差率是否改善
```

---

## 9. 非功能需求

### 9.1 性能要求
- 主页面加载时间：< 2秒
- 单客户校核时间：< 5秒
- 批量校核（50客户）：< 3分钟
- 负荷曲线重新生成（1年数据）：< 5分钟

### 9.2 可用性要求
- 支持Chrome、Edge、Safari最新两个版本
- 移动端支持iOS Safari、Android Chrome
- 弹窗操作不阻塞主页面（可最小化）

### 9.3 数据一致性
- 原始数据（user_load_data）不可修改
- 用户级曲线数据可重新生成
- 校核结果不持久化，每次实时计算

---

## 10. 版本历史

| 版本 | 日期 | 修订内容 |
|------|------|---------|
| 1.0 | 2025-11-12 | 初始版本 |
| 1.1 | 2025-11-12 | 明确数据同源性、核心问题、存储策略、校核流程、系数约束规则 |
| 1.2 | 2025-11-12 | 简化UI设计、明确数据导入逻辑、增加负荷曲线重新生成功能、完善交互流程 |

---

## 11. 待开发功能（v2.0+）

以下功能当前版本**不实现**，留待后续迭代：

1. **校核历史记录**：保存历史校核报告，支持趋势分析
2. **自动推荐系数**：基于最小二乘法自动推荐最优分配系数
3. **数据导出**：导出校核报告为PDF/Excel
4. **告警通知**：完整度<70%时自动发送邮件/短信通知
5. **批量修改系数**：在数据质量管理页面直接批量修改分配系数
6. **多日期校核**：支持7天/30天的校核周期
7. **高级统计**：计算RMSE、相关系数、时段偏差等复杂指标

---

## 12. 附录

### A. UI色彩规范
- **🟢 绿色（#4CAF50）**：健康状态，完整度≥90%，偏差<5%
- **🟡 黄色（#FF9800）**：警告状态，完整度70-89%
- **🔴 红色（#F44336）**：严重状态，完整度<70%
- **⚠️ 橙色（#FF5722）**：异常状态，偏差率≥5%

### B. 图标规范
- 📊 = 查看详情
- 🔍 = 执行校核
- 🔄 = 刷新/重新生成
- 📤 = 数据导入
- ⚡ = 批量操作
- ✓ = 正常
- ⚠️ = 警告/异常

### C. 业务术语表
- **负荷曲线**：手工导入的用户级48点电量数据
- **结算曲线**：RPA采集的用户级48点电量数据
- **分配系数（allocation_percentage）**：计量点从电表分摊用电量的比例
- **偏差率**：(负荷曲线 - 结算曲线) / 结算曲线 × 100%
- **完整度**：实际有数据天数 / 期望天数 × 100%
- **T-1日**：昨天
- **T-2日**：前天

---

**文档结束**