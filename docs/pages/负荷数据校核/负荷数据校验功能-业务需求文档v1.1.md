# 负荷数据校验功能 - 业务需求文档 v1.1

**版本**: 1.1
**日期**: 2025-11-12
**修订**: 基于最终确认的核心决策更新

---

## 1. 项目背景

我们需要为电力市场交易员和客户经理提供一个强大的工具，用于评估和分析用户负荷数据的完整性和准确性。当前，系统存在两种核心的负荷数据来源：

### 1.1 数据源说明

1.  **手工导入的电表示数数据（负荷曲线）**:

    - **来源**: 电力交易中心，通过文件手工导入
    - **用途**: 用于负荷预测、曲线展示、用电特征分析
    - **粒度**: 96点/日（15分钟）
    - **特点**:
      - 数据周期长（可达1年以上）
      - 更新频率较低（每日一次或按需导入）
      - **是获取近期（T-1日）数据的最快途径**
      - 依赖人工操作，数据中间偶尔会有断点，导入时会做插值处理
      - 数据为电能表示数（累计值）

2.  **RPA自动采集的结算数据**:

    - **来源**: 电力交易中心平台，通过RPA程序自动爬取
    - **用途**: 用于交易结算（权威数据）
    - **粒度**: 48点/日（30分钟）
    - **特点**:
      - 权威性高（官方处理，用于最终结算）
      - 自动化获取，包含官方的缺点补录、换表处理等
      - 数据周期短（仅客户签约后）
      - **延迟高（T-2，即今天只能获取前天的数据）**
      - 数据为计量点级别的时段用电量（差值）

### 1.2 核心问题识别

**数据同源性**：
- 手工导入数据和RPA采集数据**本质上来自同一数据源**（电力交易中心）
- 但处理方式不同：
  - RPA数据：官方处理后的权威数据
  - 手工数据：我方自行处理

**核心问题**：
- 手工导入数据中的**电表-计量点分配系数（allocation_percentage）是自行估算的**
- 这些估算的系数可能存在较大误差
- 需要通过与权威的RPA结算数据对比来**验证和优化这些分配系数**

**误差容忍度**：
- ✅ 可忽略：两者因处理方法差异（如缺点补录方法不同）产生的小幅度误差（通常<5%）
- ⚠️ 需修正：分配系数不准确导致的系统性偏差（可能>10%）

### 1.3 数据关系

**用户-电力户号-计量点-电能表关系**：
```
用户 (Customer)
  └─ 户号 (Utility Account) [1对多]
       └─ 计量点 (Metering Point) [1对多]
            └─ 电表 (Meter) [多对1]
                 └─ 分配系数 (allocation_percentage)
```

**关键约束**：
- 一个电表可以被多个计量点共享
- 每个电表下所有计量点的分配系数总和 ≤ 100%
- 每个计量点的分配系数：0% ≤ allocation_percentage ≤ 100%

**示例**：
```json
{
  "user_name": "江西省xx物资公司",
  "utility_accounts": [
    {
      "account_id": "3600015996813",
      "metering_points": [
        {
          "metering_point_id": "211474252",
          "meter_id": "3630001492249049029898",
          "allocation_percentage": 65.0
        },
        {
          "metering_point_id": "227324023",
          "meter_id": "3630001492249049029898",  // 同一电表
          "allocation_percentage": 25.0
        }
      ]
    }
  ]
}
// 电表 xxx898 的系数总和：65.0 + 25.0 = 90.0% ✅（≤100%）
```

---

## 2. 业务目标

1.  **验证分配系数准确性**：通过对比手工数据和权威RPA数据，识别分配系数是否合理
2.  **优化分配系数**：基于数据对比结果，推荐更准确的分配系数，提升负荷预测精度
3.  **提升数据质量监控能力**：建立可视化界面，直观展示每个客户的数据完整度
4.  **构建健壮的分析基础**：确保负荷预测等核心功能在部分数据缺失时，通过自动数据借用机制依然能可靠运行

---

## 3. 核心决策

### 3.1 存储策略

| 决策点 | 方案 | 理由 |
|--------|------|------|
| **存储粒度** | 用户级为主，计量点级按需临时计算 | 降低存储成本，避免冗余；校核时临时计算计量点数据 |
| **原始数据** | 保留不变 | 作为不可更改的原始凭证 |
| **标准化曲线** | 两份独立的48点用户级曲线库 | 负荷曲线库（手工）+ 结算曲线库（RPA） |

**数据链路**：
```
手工导入：
user_load_data (96点示数)
  → [转换聚合] → load_curve_user (48点电量，用户级)
  → [临时计算] → 计量点级48点数据（校核时）

RPA采集：
mp_load_curve (48点电量，计量点级原始)
  → [聚合] → settlement_curve_user (48点电量，用户级)
```

### 3.2 校核策略

| 决策点 | 方案 | 理由 |
|--------|------|------|
| **校核触发** | 完全手动 | 按需执行，节省计算资源 |
| **校核周期** | 用户选择1天（可扩展） | 快速定位问题，1天=48个数据点 |
| **校核流程** | 先用户级快速对比，再计量点级详细分析 | 如果用户级偏差小，无需深入计量点级 |
| **缓存策略** | 不缓存 | 确保每次使用最新数据 |

### 3.3 完整性分析

| 决策点 | 方案 | 理由 |
|--------|------|------|
| **触发时机** | 数据导入后自动触发 | 实时发现数据质量问题 |
| **完整度指标** | (实际天数 / 期望天数) × 100% | - |
| **期望天数** | 从第一条数据到T-1（手工）/T-2（RPA）的所有日历日 | 符合数据时效性特点 |
| **缺失判定** | 某日的48个点中缺失任意一个点即视为该日缺失 | 严格标准 |

### 3.4 数据借用策略

| 场景 | 优先级 | 回退策略 | 处理方式 |
|------|--------|---------|---------|
| **负荷预测** | 负荷曲线优先 | → 结算曲线借用 → 无数据跳过 | 内存中借用，不持久化 |
| **预结算** | 结算曲线优先 | → 负荷曲线临时代理 → 无数据提示 | 内存中借用，不持久化 |

**重要原则**：
- 借用的数据**仅在内存中使用**
- **不持久化**到对方的数据库中
- 保持数据源纯粹性

---

## 4. 核心业务逻辑

### 4.1 数据处理与存储（数据源纯粹性原则）

#### A. 原始数据保留
- `user_load_data`：96点电能表示数，作为不可更改的原始凭证
- `mp_load_curve`：48点RPA结算数据（计量点级），作为权威数据源

#### B. 标准化曲线存储
系统维护**两份完全独立**的48点用户级曲线数据库：

1. **负荷曲线库（load_curve_user）**
   - 来源：手工导入的96点示数数据
   - 处理：聚合转换（示数→用电量，96点→48点）→ 按分配系数聚合到用户级
   - 用途：负荷预测、用电分析

2. **结算曲线库（settlement_curve_user）**
   - 来源：RPA采集的48点结算数据（计量点级）
   - 处理：按分配系数聚合到用户级
   - 用途：交易结算、权威对比基准

**严禁混合**：两个库的数据不能相互污染

### 4.2 数据校核

#### A. 校核目的
- 分析"负荷曲线库"与"结算曲线库"之间的偏差
- 识别分配系数是否合理
- 推荐优化后的分配系数

#### B. 校核流程

```
Step 1: 用户选择
  - 选择客户
  - 选择校核日期（默认最近有数据的日期）
  - 可选：选择校核周期（1天/7天/30天）
  ↓
Step 2: 用户级快速对比
  - 查询 load_curve_user[选定日期]
  - 查询 settlement_curve_user[选定日期]
  - 计算偏差：deviation = load - settlement
  - 计算偏差率：deviation_rate = (deviation / settlement) × 100
  ↓
Step 3: 判断是否需要深入分析
  - 如果 |平均偏差率| < 阈值（如5%）
    → 结束，系数可能合理，无需调整
  - 如果 |平均偏差率| ≥ 阈值
    → 进入Step 4
  ↓
Step 4: 计量点级详细分析（临时计算）
  - 临时计算：user_load_data → 计量点级48点数据
  - 对比：计量点级负荷数据 vs mp_load_curve
  - 定位：哪些计量点偏差大
  - 分析：是否特定电表的系数有问题
  ↓
Step 5: 分配系数优化（可选）
  - 基于最小二乘法推荐最优系数
  - 约束条件：
    * 每个计量点：0 ≤ allocation ≤ 100
    * 每个电表下所有计量点：sum(allocation) ≤ 100
  ↓
Step 6: 生成报告
  - 用户级偏差统计
  - 计量点级偏差明细（如果执行了Step 4）
  - 推荐系数（如果执行了优化）
  - 保存到 data_quality_report
```

#### C. 统计指标

**用户级指标**：
- 平均偏差（kWh）
- 平均偏差率（%）
- 最大正/负偏差（kWh）
- 均方根误差（RMSE）
- 相关系数

**计量点级指标**（深入分析时）：
- 各计量点的平均偏差率
- 各电表的贡献度分析
- 推荐的系数调整幅度

### 4.3 数据完整性分析

#### A. 分析目的
- 分析两个曲线库的数据完整性
- 识别数据起止日期、缺失日期
- 计算完整度指标

#### B. 触发时机
- **自动触发**：每次数据导入后
- **手动触发**：用户在数据质量看板手动刷新

#### C. 完整性计算

```python
# 负荷曲线库（手工导入）
first_date = 第一条数据的日期
expected_end_date = today - 1天  # T-1
期望天数 = (expected_end_date - first_date) + 1
实际天数 = 有完整48点数据的天数
缺失天数 = 期望天数 - 实际天数
完整度 = (实际天数 / 期望天数) × 100%

# 结算曲线库（RPA采集）
first_date = 第一条数据的日期
expected_end_date = today - 2天  # T-2
期望天数 = (expected_end_date - first_date) + 1
实际天数 = 有完整48点数据的天数
缺失天数 = 期望天数 - 实际天数
完整度 = (实际天数 / 期望天数) × 100%
```

**注意**：两类数据的完整度**分开计算**，因为期望截止日期不同

#### D. 输出报告
- 负荷曲线库：起止日期、完整度、缺失日期列表
- 结算曲线库：起止日期、完整度、缺失日期列表
- 交集分析：两者都有数据的天数、交集完整度

### 4.4 应用层数据借用逻辑

#### A. 负荷预测模块

**目标**：优先使用T-1日的手工导入数据（时效性好）

```
[负荷预测请求]
  ↓
[1] 查询 load_curve_user[T-1日]
  ├─ 有数据 → 返回，使用模式A（高精度预测）
  └─ 无数据 → 进入步骤2
  ↓
[2] 查询 settlement_curve_user[T-2日]
  ├─ 有数据 → 返回，使用模式B（备用预测）
  └─ 无数据 → 进入步骤3
  ↓
[3] 都无数据
  └─ 跳过预测，标记"数据不足，无法预测"
```

#### B. 预结算模块

**目标**：优先使用权威的RPA结算数据

```
[预结算请求]
  ↓
[1] 查询 settlement_curve_user[指定日期]
  ├─ 有数据 → 返回（权威数据）
  └─ 无数据 → 进入步骤2
  ↓
[2] 查询 load_curve_user[指定日期]
  ├─ 有数据 → 返回（临时代理，需标注）
  └─ 无数据 → 进入步骤3
  ↓
[3] 都无数据
  └─ 提示"数据不足，无法计算预结算"
```

**重要**：
- 借用的数据仅在内存中使用
- **不持久化**到对方的数据库
- 预结算使用手工数据时，需明确标注为"临时估算"

---

## 5. 特殊场景处理

### 5.1 换表事件

**场景**：电表更换（发生概率极小）

**处理方案**：数据库手工修正

#### 步骤1：更新客户档案
```javascript
// MongoDB Shell
db.customers.updateOne(
  { "_id": ObjectId("customer_id") },
  {
    "$set": {
      "utility_accounts.0.metering_points.0.meter.meter_id": "新电表ID",
      "updated_at": new Date(),
      "updated_by": "admin",
      "update_reason": "2025-10-16换表"
    }
  }
)
```

#### 步骤2：标记历史数据（可选）
```javascript
// 在user_load_data中标记换表前的数据
db.user_load_data.updateMany(
  {
    "meter_id": "旧电表ID",
    "timestamp": { "$lte": ISODate("2025-10-15T23:59:59Z") }
  },
  {
    "$set": {
      "meter_replaced": true,
      "replaced_date": "2025-10-16"
    }
  }
)
```

#### 步骤3：校核建议
- 换表前数据：使用旧的分配系数
- 换表后数据：使用新的分配系数（需要重新校核优化）
- 不建议跨换表日期进行校核

---

## 6. 数据质量标准

### 6.1 完整度等级

| 等级 | 完整度范围 | 状态 | 建议操作 |
|------|-----------|------|---------|
| 健康 | ≥ 90% | 🟢 绿色 | 保持现状 |
| 警告 | 70% ~ 89% | 🟡 黄色 | 建议补充数据 |
| 严重 | < 70% | 🔴 红色 | 必须补充数据 |

### 6.2 偏差容忍度

| 偏差率 | 评估 | 建议操作 |
|--------|------|---------|
| < 5% | 正常 | 无需调整系数 |
| 5% ~ 10% | 关注 | 建议校核分析 |
| > 10% | 异常 | 必须优化系数 |

---

## 7. 版本历史

| 版本 | 日期 | 修订内容 | 修订人 |
|------|------|---------|--------|
| 1.0 | 2025-11-12 | 初始版本 | 需求方 |
| 1.1 | 2025-11-12 | 明确数据同源性、核心问题、存储策略、校核流程、系数约束规则 | Claude |

---

## 8. 待讨论事项

1. ✅ 校核周期是否需要支持多周期（1天/7天/30天）？→ 主要1天，可扩展
2. ✅ 是否需要自动检测换表事件？→ 不需要，手工处理
3. ✅ 分配系数优化的约束条件？→ 每电表≤100%，每计量点0-100%
4. ⏳ 完整性分析的告警通知机制？
5. ⏳ 推荐系数的自动应用权限控制？

---

**文档结束**
