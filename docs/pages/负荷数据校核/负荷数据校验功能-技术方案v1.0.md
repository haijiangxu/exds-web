# è´Ÿè·æ•°æ®æ ¡éªŒåŠŸèƒ½ - å®Œæ•´æŠ€æœ¯æ–¹æ¡ˆ v1.0

**ç‰ˆæœ¬**: 1.0
**æ—¥æœŸ**: 2025-11-12
**çŠ¶æ€**: å¾…è¯„å®¡

---

## ğŸ“‹ ä¸€ã€ä¸šåŠ¡éœ€æ±‚å®Œå–„

### 1.1 æ ¸å¿ƒå†³ç­–ç¡®è®¤

åŸºäºä¸æ‚¨çš„è®¨è®ºï¼Œæ˜ç¡®ä»¥ä¸‹å…³é”®ç­–ç•¥ï¼š

| å†³ç­–ç‚¹ | é€‰æ‹©æ–¹æ¡ˆ | ç†ç”± |
|--------|---------|------|
| **å­˜å‚¨ç²’åº¦** | åŒå±‚å­˜å‚¨ï¼ˆè®¡é‡ç‚¹çº§ + ç”¨æˆ·çº§ï¼‰ | æ—¢æ”¯æŒç»†ç²’åº¦æ ¡æ ¸ï¼Œåˆæ–¹ä¾¿åº”ç”¨å±‚ä½¿ç”¨ |
| **æ ¡æ ¸è§¦å‘** | å®Œå…¨æ‰‹åŠ¨ | æŒ‰éœ€æ‰§è¡Œï¼ŒèŠ‚çœè®¡ç®—èµ„æº |
| **å®Œæ•´æ€§åˆ†æ** | æ•°æ®å¯¼å…¥åè‡ªåŠ¨è§¦å‘ | å®æ—¶å‘ç°æ•°æ®è´¨é‡é—®é¢˜ |
| **é¢„æµ‹å›é€€** | æ•°æ®ç¼ºå¤±æ—¶è·³è¿‡å¹¶æ ‡è®° | é¿å…ä½è´¨é‡é¢„æµ‹ç»“æœ |

### 1.2 ä¸šåŠ¡è§„åˆ™æ˜ç¡®

#### A. æ•°æ®æºçº¯ç²¹æ€§åŸåˆ™
- **é¢„æµ‹æ›²çº¿åº“**ï¼šä»…å­˜å‚¨æºè‡ªæ‰‹å·¥å¯¼å…¥çš„æ•°æ®
- **ç»“ç®—æ›²çº¿åº“**ï¼šä»…å­˜å‚¨æºè‡ªRPAçš„æ•°æ®
- **ä¸¥ç¦æ··åˆ**ï¼šä¸¤ä¸ªåº“çš„æ•°æ®ä¸èƒ½ç›¸äº’æ±¡æŸ“

#### B. æ•°æ®å€Ÿç”¨è§„åˆ™ï¼ˆåº”ç”¨å±‚å†…å­˜æ“ä½œï¼‰
- **è´Ÿè·é¢„æµ‹**ï¼šé¢„æµ‹æ›²çº¿ä¼˜å…ˆ â†’ ç»“ç®—æ›²çº¿å›é€€ â†’ æ— æ•°æ®è·³è¿‡
- **é¢„ç»“ç®—**ï¼šç»“ç®—æ›²çº¿ä¼˜å…ˆ â†’ é¢„æµ‹æ›²çº¿ä¸´æ—¶ä»£ç† â†’ æ— æ•°æ®æç¤º
- **é‡è¦**ï¼šå€Ÿç”¨çš„æ•°æ®ä»…åœ¨å†…å­˜ä¸­ä½¿ç”¨ï¼Œä¸æŒä¹…åŒ–åˆ°å¯¹æ–¹çš„åº“ä¸­

#### C. æ•°æ®å®Œæ•´æ€§æ ‡å‡†
- **å®Œæ•´åº¦æŒ‡æ ‡**ï¼š(å®é™…å¤©æ•° / æœŸæœ›å¤©æ•°) Ã— 100%
- **æœŸæœ›å¤©æ•°**ï¼šä»ç¬¬ä¸€æ¡æ•°æ®åˆ°æœ€åä¸€æ¡æ•°æ®ä¹‹é—´çš„æ‰€æœ‰æ—¥å†æ—¥
- **ç¼ºå¤±åˆ¤å®š**ï¼šæŸæ—¥çš„48ä¸ªç‚¹ä¸­ç¼ºå¤±ä»»æ„ä¸€ä¸ªç‚¹å³è§†ä¸ºè¯¥æ—¥ç¼ºå¤±

#### D. æ ¡æ ¸åˆ†æé€»è¾‘
- **åˆ†æå‘¨æœŸ**ï¼šé»˜è®¤æœ€è¿‘30å¤©ï¼Œå¯è‡ªå®šä¹‰
- **æ•°æ®è¦æ±‚**ï¼šä¸¤æ¡æ›²çº¿åœ¨åˆ†æå‘¨æœŸå†…å‡æœ‰æ•°æ®
- **ç»Ÿè®¡æŒ‡æ ‡**ï¼š
  - å¹³å‡åå·®ï¼ˆkWhï¼‰
  - å¹³å‡åå·®ç‡ï¼ˆ%ï¼‰
  - æœ€å¤§åå·®ï¼ˆkWhï¼‰
  - å‡æ–¹æ ¹è¯¯å·®ï¼ˆRMSEï¼‰
  - ç›¸å…³ç³»æ•°
- **ç³»æ•°ä¼˜åŒ–**ï¼šåŸºäºæœ€å°äºŒä¹˜æ³•æ¨èæœ€ä¼˜çš„ allocation_percentage

---

## ğŸ—ï¸ äºŒã€æ•°æ®åº“è®¾è®¡

### 2.1 æ–°å¢é›†åˆ

#### A. forecast_load_curve_mpï¼ˆé¢„æµ‹æ›²çº¿åº“-è®¡é‡ç‚¹çº§ï¼‰

**ç”¨é€”**ï¼šå­˜å‚¨æ‰‹å·¥å¯¼å…¥æ•°æ®è½¬æ¢åçš„48ç‚¹æ›²çº¿ï¼ˆè®¡é‡ç‚¹çº§åˆ«ï¼‰

```javascript
{
  _id: ObjectId("..."),
  mp_id: "211474252",              // è®¡é‡ç‚¹ID
  meter_id: "3630001492249049029898", // ç”µè¡¨èµ„äº§å·ï¼ˆå†—ä½™ï¼Œä¾¿äºæŸ¥è¯¢ï¼‰
  datetime: ISODate("2025-11-10T00:30:00Z"), // æ—¶é—´æˆ³ï¼ˆ30åˆ†é’Ÿé—´éš”ï¼‰
  load_kwh: 125.5,                 // è´Ÿè·ï¼ˆkWhï¼‰
  source: "manual_import",         // æ•°æ®æ¥æºæ ‡è¯†
  created_at: ISODate("2025-11-11T08:00:00Z"), // åˆ›å»ºæ—¶é—´
  import_batch_id: "batch_20251111_080000"     // å¯¼å…¥æ‰¹æ¬¡IDï¼ˆå¯é€‰ï¼Œä¾¿äºè¿½æº¯ï¼‰
}
```

**ç´¢å¼•**ï¼š
```javascript
// å”¯ä¸€ç´¢å¼•ï¼šé˜²æ­¢é‡å¤æ•°æ®
{ mp_id: 1, datetime: 1 }  // unique: true

// æŸ¥è¯¢ç´¢å¼•
{ meter_id: 1, datetime: 1 }
{ datetime: 1 }
{ created_at: -1 }
```

#### B. forecast_load_curve_userï¼ˆé¢„æµ‹æ›²çº¿åº“-ç”¨æˆ·çº§ï¼‰

**ç”¨é€”**ï¼šå­˜å‚¨æŒ‰åˆ†é…ç³»æ•°èšåˆåçš„ç”¨æˆ·çº§48ç‚¹æ›²çº¿

```javascript
{
  _id: ObjectId("..."),
  customer_id: "673f9f87069d137d83be63a6", // å®¢æˆ·IDï¼ˆå…³è”customersè¡¨ï¼‰
  datetime: ISODate("2025-11-10T00:30:00Z"),
  load_kwh: 853.2,                 // èšåˆè´Ÿè·ï¼ˆkWhï¼‰
  source: "manual_import",
  created_at: ISODate("2025-11-11T08:00:00Z"),
  import_batch_id: "batch_20251111_080000",

  // å…ƒæ•°æ®ï¼šè®°å½•å‚ä¸èšåˆçš„è®¡é‡ç‚¹ï¼ˆä¾¿äºè°ƒè¯•ï¼‰
  aggregation_meta: {
    mp_count: 4,                   // å‚ä¸èšåˆçš„è®¡é‡ç‚¹æ•°é‡
    mp_contributions: [            // å„è®¡é‡ç‚¹çš„è´¡çŒ®
      { mp_id: "211474252", load_kwh: 200.0, percentage: 65.0 },
      { mp_id: "211474253", load_kwh: 180.5, percentage: 63.4569 },
      // ...
    ]
  }
}
```

**ç´¢å¼•**ï¼š
```javascript
{ customer_id: 1, datetime: 1 }  // unique: true
{ datetime: 1 }
{ created_at: -1 }
```

#### C. settlement_load_curve_mpï¼ˆç»“ç®—æ›²çº¿åº“-è®¡é‡ç‚¹çº§ï¼‰

**ç”¨é€”**ï¼šå­˜å‚¨RPAé‡‡é›†çš„æƒå¨ç»“ç®—æ•°æ®ï¼ˆè®¡é‡ç‚¹çº§åˆ«ï¼‰

```javascript
{
  _id: ObjectId("..."),
  mp_id: "211474252",
  datetime: ISODate("2025-11-08T00:30:00Z"), // æ³¨æ„ï¼šRPAæ•°æ®æœ‰T-2å»¶è¿Ÿ
  load_kwh: 127.3,                 // ä»MWhè½¬æ¢ä¸ºkWh
  source: "rpa_settlement",
  created_at: ISODate("2025-11-10T02:00:00Z"), // RPAé‡‡é›†æ—¶é—´
  rpa_batch_id: "rpa_20251110_020000"
}
```

**ç´¢å¼•**ï¼š
```javascript
{ mp_id: 1, datetime: 1 }  // unique: true
{ datetime: 1 }
{ created_at: -1 }
```

#### D. settlement_load_curve_userï¼ˆç»“ç®—æ›²çº¿åº“-ç”¨æˆ·çº§ï¼‰

**ç”¨é€”**ï¼šå­˜å‚¨èšåˆåçš„ç”¨æˆ·çº§ç»“ç®—æ›²çº¿

```javascript
{
  _id: ObjectId("..."),
  customer_id: "673f9f87069d137d83be63a6",
  datetime: ISODate("2025-11-08T00:30:00Z"),
  load_kwh: 860.1,
  source: "rpa_settlement",
  created_at: ISODate("2025-11-10T02:00:00Z"),
  rpa_batch_id: "rpa_20251110_020000",

  aggregation_meta: {
    mp_count: 4,
    mp_contributions: [
      { mp_id: "211474252", load_kwh: 205.2, percentage: 65.0 },
      // ...
    ]
  }
}
```

**ç´¢å¼•**ï¼š
```javascript
{ customer_id: 1, datetime: 1 }  // unique: true
{ datetime: 1 }
{ created_at: -1 }
```

#### E. data_quality_reportï¼ˆæ•°æ®è´¨é‡æŠ¥å‘Šï¼‰

**ç”¨é€”**ï¼šå­˜å‚¨æ•°æ®å®Œæ•´æ€§åˆ†æå’Œæ ¡æ ¸åˆ†æçš„ç»“æœ

```javascript
{
  _id: ObjectId("..."),
  customer_id: "673f9f87069d137d83be63a6",
  customer_name: "æ±Ÿè¥¿çœxxç‰©èµ„å…¬å¸",  // å†—ä½™ï¼Œä¾¿äºå±•ç¤º
  report_type: "completeness",      // "completeness" | "validation"
  generated_at: ISODate("2025-11-11T08:00:00Z"),

  // ===== å®Œæ•´æ€§åˆ†æç»“æœï¼ˆæ‰€æœ‰æŠ¥å‘Šç±»å‹éƒ½æœ‰ï¼‰=====
  completeness_analysis: {
    forecast_curve: {
      start_date: "2025-09-01",      // ç¬¬ä¸€æ¡æ•°æ®çš„æ—¥æœŸ
      end_date: "2025-11-10",        // æœ€åä¸€æ¡æ•°æ®çš„æ—¥æœŸ
      total_days: 71,                // æœŸæœ›å¤©æ•°
      actual_days: 65,               // å®é™…æœ‰æ•°æ®çš„å¤©æ•°
      missing_days: 6,               // ç¼ºå¤±å¤©æ•°
      missing_dates: [               // ç¼ºå¤±çš„å…·ä½“æ—¥æœŸ
        "2025-09-15",
        "2025-10-03",
        "2025-10-04",
        "2025-11-02",
        "2025-11-05",
        "2025-11-09"
      ],
      completeness_rate: 91.55       // å®Œæ•´åº¦ï¼ˆ%ï¼‰
    },

    settlement_curve: {
      start_date: "2025-09-05",
      end_date: "2025-11-08",        // RPAæ•°æ®æœ‰å»¶è¿Ÿ
      total_days: 65,
      actual_days: 63,
      missing_days: 2,
      missing_dates: [
        "2025-09-20",
        "2025-10-15"
      ],
      completeness_rate: 96.92
    },

    // äº¤é›†åˆ†æ
    overlap_analysis: {
      overlap_start: "2025-09-05",   // ä¸¤æ¡æ›²çº¿éƒ½æœ‰æ•°æ®çš„èµ·å§‹æ—¥æœŸ
      overlap_end: "2025-11-08",     // ä¸¤æ¡æ›²çº¿éƒ½æœ‰æ•°æ®çš„ç»“æŸæ—¥æœŸ
      overlap_days: 65,              // äº¤é›†æœŸé—´çš„å¤©æ•°
      both_available_days: 60,       // ä¸¤æ¡æ›²çº¿éƒ½æœ‰æ•°æ®çš„å¤©æ•°
      overlap_rate: 92.31            // äº¤é›†å®Œæ•´åº¦ï¼ˆ%ï¼‰
    }
  },

  // ===== æ ¡æ ¸åˆ†æç»“æœï¼ˆä»… validation ç±»å‹æŠ¥å‘Šï¼‰=====
  validation_result: {
    analysis_period: {
      start_date: "2025-10-11",      // ç”¨æˆ·æŒ‡å®šæˆ–é»˜è®¤æœ€è¿‘30å¤©
      end_date: "2025-11-10"
    },

    data_points_compared: 1440,      // å‚ä¸å¯¹æ¯”çš„æ•°æ®ç‚¹æ•°é‡ï¼ˆ30å¤©Ã—48ç‚¹ï¼‰

    // ç»Ÿè®¡æŒ‡æ ‡
    statistics: {
      mean_deviation: -3.2,          // å¹³å‡åå·®ï¼ˆkWhï¼‰è´Ÿå€¼è¡¨ç¤ºé¢„æµ‹æ›²çº¿åå°
      mean_deviation_rate: -2.1,     // å¹³å‡åå·®ç‡ï¼ˆ%ï¼‰
      max_positive_deviation: 15.8,  // æœ€å¤§æ­£åå·®
      max_negative_deviation: -12.3, // æœ€å¤§è´Ÿåå·®
      rmse: 5.6,                     // å‡æ–¹æ ¹è¯¯å·®
      correlation: 0.985,            // ç›¸å…³ç³»æ•°ï¼ˆ0-1ï¼‰
      mae: 4.2                       // å¹³å‡ç»å¯¹è¯¯å·®
    },

    // æ—¶æ®µåå·®åˆ†æï¼ˆå¯é€‰ï¼‰
    period_analysis: [
      {
        period_range: "00:00-08:00",
        mean_deviation_rate: -1.5,
        sample_count: 480
      },
      {
        period_range: "08:00-20:00",
        mean_deviation_rate: -2.8,
        sample_count: 720
      },
      {
        period_range: "20:00-24:00",
        mean_deviation_rate: -1.2,
        sample_count: 240
      }
    ],

    // æ¨èçš„åˆ†é…ç³»æ•°ä¼˜åŒ–ï¼ˆå¦‚æœapplicableï¼‰
    allocation_optimization: {
      method: "least_squares",       // ä¼˜åŒ–æ–¹æ³•
      current_allocations: [
        { mp_id: "211474252", meter_id: "36300...898", percentage: 65.0 },
        { mp_id: "211474253", meter_id: "36300...259", percentage: 63.4569 },
        { mp_id: "227324023", meter_id: "36300...898", percentage: 25.0 },
        { mp_id: "227324032", meter_id: "36300...259", percentage: 25.0 }
      ],
      recommended_allocations: [
        { mp_id: "211474252", meter_id: "36300...898", percentage: 67.2, change: +2.2 },
        { mp_id: "211474253", meter_id: "36300...259", percentage: 65.1, change: +1.6431 },
        { mp_id: "227324023", meter_id: "36300...898", percentage: 22.8, change: -2.2 },
        { mp_id: "227324032", meter_id: "36300...259", percentage: 23.4, change: -1.6 }
      ],
      estimated_improvement: 18.5    // é¢„è®¡æ”¹è¿›å¹…åº¦ï¼ˆåå·®å‡å°‘%ï¼‰
    }
  },

  // æŠ¥å‘Šå…ƒæ•°æ®
  metadata: {
    analysis_duration_ms: 1250,      // åˆ†æè€—æ—¶
    triggered_by: "manual",          // "auto_import" | "manual" | "scheduled"
    trigger_user: "admin"            // è§¦å‘ç”¨æˆ·ï¼ˆå¦‚æœæ˜¯æ‰‹åŠ¨ï¼‰
  }
}
```

**ç´¢å¼•**ï¼š
```javascript
{ customer_id: 1, generated_at: -1 }
{ customer_id: 1, report_type: 1, generated_at: -1 }
{ report_type: 1, generated_at: -1 }
```

### 2.2 ç°æœ‰é›†åˆæ”¹é€ 

#### user_load_dataï¼ˆä¿æŒä¸å˜ï¼‰
- ç»§ç»­å­˜å‚¨96ç‚¹åŸå§‹æ‰‹å·¥å¯¼å…¥æ•°æ®
- ä½œä¸ºä¸å¯æ›´æ”¹çš„åŸå§‹å‡­è¯
- ä¸éœ€è¦ä¿®æ”¹ç»“æ„

#### mp_load_curveï¼ˆå¯é€‰æ”¹é€ ï¼‰
- å½“å‰æ˜¯RPAæ•°æ®çš„åŸå§‹å­˜å‚¨ä½ç½®
- **å»ºè®®**ï¼šä½œä¸º `settlement_load_curve_mp` çš„æ•°æ®æºï¼Œä¿æŒåŸæ ·
- æˆ–è€…ç›´æ¥å°† RPA æ•°æ®å¯¼å…¥åˆ° `settlement_load_curve_mp`

---

## ğŸ”§ ä¸‰ã€åç«¯APIè®¾è®¡

### 3.1 APIè·¯ç”±ç»“æ„

æ–°å¢è·¯ç”±æ–‡ä»¶ï¼š`webapp/api/v1_data_validation.py`

```python
from fastapi import APIRouter, Depends, HTTPException, Query
from typing import Literal, Optional
from datetime import date

router = APIRouter(prefix="/data-validation", tags=["Data Validation"])
```

### 3.2 APIç«¯ç‚¹è¯¦ç»†è®¾è®¡

#### A. æ•°æ®è½¬æ¢ä¸å­˜å‚¨

```python
@router.post("/transform-manual-data")
async def transform_manual_data(
    import_batch_id: str = Query(..., description="å¯¼å…¥æ‰¹æ¬¡ID"),
    current_user: dict = Depends(get_current_active_user)
):
    """
    å°†96ç‚¹æ‰‹å·¥å¯¼å…¥æ•°æ®è½¬æ¢ä¸º48ç‚¹å¹¶å­˜å…¥é¢„æµ‹æ›²çº¿åº“

    æµç¨‹ï¼š
    1. ä» user_load_data è¯»å–æŒ‡å®šæ‰¹æ¬¡çš„96ç‚¹æ•°æ®
    2. æŒ‰30åˆ†é’Ÿèšåˆï¼ˆæ¯2ä¸ª15åˆ†é’Ÿç‚¹åˆå¹¶ï¼‰
    3. ç¤ºæ•°è½¬å·®å€¼ï¼ˆç›¸é‚»ç‚¹ç›¸å‡ï¼‰
    4. å­˜å…¥ forecast_load_curve_mpï¼ˆè®¡é‡ç‚¹çº§ï¼‰
    5. æŒ‰åˆ†é…ç³»æ•°èšåˆåˆ° forecast_load_curve_userï¼ˆç”¨æˆ·çº§ï¼‰
    6. è§¦å‘æ•°æ®å®Œæ•´æ€§åˆ†æ

    è¿”å›ï¼š
    {
        "status": "success",
        "processed_meters": 5,
        "processed_customers": 2,
        "mp_records_created": 240,  # 5ä¸ªç”µè¡¨ Ã— 48ç‚¹
        "user_records_created": 96,  # 2ä¸ªå®¢æˆ· Ã— 48ç‚¹
        "completeness_reports_generated": 2
    }
    """
```

```python
@router.post("/import-rpa-data")
async def import_rpa_data(
    rpa_batch_id: str = Query(...),
    source_collection: str = Query("mp_load_curve", description="RPAæºæ•°æ®é›†åˆ"),
    current_user: dict = Depends(get_current_active_user)
):
    """
    å¯¼å…¥RPAæ•°æ®åˆ°ç»“ç®—æ›²çº¿åº“

    æµç¨‹ï¼š
    1. ä» mp_load_curve è¯»å–RPAæ•°æ®
    2. å•ä½è½¬æ¢ï¼ˆMWh â†’ kWhï¼‰
    3. å­˜å…¥ settlement_load_curve_mp
    4. èšåˆåˆ° settlement_load_curve_user
    5. è§¦å‘æ•°æ®å®Œæ•´æ€§åˆ†æ
    """
```

#### B. æ•°æ®å®Œæ•´æ€§åˆ†æ

```python
@router.post("/analyze-completeness")
async def analyze_completeness(
    customer_id: str,
    current_user: dict = Depends(get_current_active_user)
):
    """
    åˆ†ææŒ‡å®šå®¢æˆ·çš„æ•°æ®å®Œæ•´æ€§

    è¿”å›ï¼šç”Ÿæˆçš„æŠ¥å‘ŠID
    """
```

```python
@router.get("/completeness-report/{customer_id}")
async def get_completeness_report(
    customer_id: str,
    latest: bool = Query(True, description="æ˜¯å¦åªè¿”å›æœ€æ–°æŠ¥å‘Š"),
    current_user: dict = Depends(get_current_active_user)
):
    """
    è·å–å®Œæ•´æ€§æŠ¥å‘Š

    è¿”å›ï¼šdata_quality_report æ–‡æ¡£ï¼ˆreport_type="completeness"ï¼‰
    """
```

```python
@router.get("/completeness-dashboard")
async def get_completeness_dashboard(
    min_completeness: float = Query(0.0, ge=0, le=100),
    current_user: dict = Depends(get_current_active_user)
):
    """
    è·å–æ‰€æœ‰å®¢æˆ·çš„æ•°æ®å®Œæ•´æ€§æ¦‚è§ˆ

    è¿”å›ï¼š
    {
        "total_customers": 50,
        "healthy_customers": 45,  # å®Œæ•´åº¦ >= 90%
        "warning_customers": 3,   # 70% <= å®Œæ•´åº¦ < 90%
        "critical_customers": 2,  # å®Œæ•´åº¦ < 70%
        "customers": [
            {
                "customer_id": "...",
                "customer_name": "...",
                "forecast_completeness": 91.5,
                "settlement_completeness": 96.2,
                "last_update": "2025-11-11T08:00:00Z"
            },
            // ...
        ]
    }
    """
```

#### C. æ•°æ®æ ¡æ ¸

```python
@router.post("/validate-curves")
async def validate_curves(
    customer_id: str,
    start_date: Optional[date] = Query(None, description="é»˜è®¤æœ€è¿‘30å¤©"),
    end_date: Optional[date] = Query(None),
    optimize_allocation: bool = Query(True, description="æ˜¯å¦è®¡ç®—æ¨èåˆ†é…ç³»æ•°"),
    current_user: dict = Depends(get_current_active_user)
):
    """
    æ‰§è¡Œé¢„æµ‹æ›²çº¿ vs ç»“ç®—æ›²çº¿çš„æ ¡æ ¸åˆ†æ

    è¿”å›ï¼šç”Ÿæˆçš„æŠ¥å‘ŠID
    """
```

```python
@router.get("/validation-report/{customer_id}")
async def get_validation_report(
    customer_id: str,
    latest: bool = Query(True),
    current_user: dict = Depends(get_current_active_user)
):
    """
    è·å–æ ¡æ ¸æŠ¥å‘Š

    è¿”å›ï¼šdata_quality_report æ–‡æ¡£ï¼ˆreport_type="validation"ï¼‰
    """
```

#### D. æ•°æ®æŸ¥è¯¢

```python
@router.get("/forecast-curve")
async def get_forecast_curve(
    customer_id: Optional[str] = Query(None),
    mp_id: Optional[str] = Query(None),
    start_date: date = Query(...),
    end_date: date = Query(...),
    level: Literal["mp", "user"] = Query("user"),
    current_user: dict = Depends(get_current_active_user)
):
    """
    æŸ¥è¯¢é¢„æµ‹æ›²çº¿æ•°æ®

    å‚æ•°ï¼š
    - customer_id æˆ– mp_idï¼šäºŒé€‰ä¸€å¿…å¡«
    - level: "mp" æˆ– "user"

    è¿”å›ï¼š
    [
        { "datetime": "2025-11-10T00:30:00Z", "load_kwh": 125.5 },
        // ...
    ]
    """
```

```python
@router.get("/settlement-curve")
async def get_settlement_curve(
    # å‚æ•°åŒä¸Š
):
    """æŸ¥è¯¢ç»“ç®—æ›²çº¿æ•°æ®"""
```

```python
@router.get("/curve-comparison")
async def get_curve_comparison(
    customer_id: str,
    start_date: date,
    end_date: date,
    current_user: dict = Depends(get_current_active_user)
):
    """
    è·å–ä¸¤æ¡æ›²çº¿çš„å¯¹æ¯”æ•°æ®ï¼ˆç”¨äºå‰ç«¯å›¾è¡¨å±•ç¤ºï¼‰

    è¿”å›ï¼š
    {
        "dates": ["2025-11-10", "2025-11-11"],
        "forecast_curve": [
            [120.5, 118.2, ...],  # 48ç‚¹
            [122.1, 119.8, ...]
        ],
        "settlement_curve": [
            [123.2, 120.1, ...],
            [124.5, 121.3, ...]
        ],
        "deviation": [
            [-2.7, -1.9, ...],
            [-2.4, -1.5, ...]
        ]
    }
    """
```

#### E. æ•°æ®å€Ÿç”¨æœåŠ¡ï¼ˆå†…éƒ¨APIï¼‰

```python
@router.get("/load-data-with-fallback")
async def get_load_data_with_fallback(
    customer_id: str,
    date: date,
    preferred_source: Literal["forecast", "settlement"] = Query("forecast"),
    current_user: dict = Depends(get_current_active_user)
):
    """
    æ™ºèƒ½æ•°æ®å€Ÿç”¨ï¼šæ ¹æ®ä¼˜å…ˆçº§è¿”å›å¯ç”¨æ•°æ®

    é€»è¾‘ï¼š
    1. å¦‚æœ preferred_source="forecast":
       - å…ˆæŸ¥ forecast_load_curve_user
       - æ— æ•°æ®åˆ™æŸ¥ settlement_load_curve_user
    2. å¦‚æœ preferred_source="settlement":
       - å…ˆæŸ¥ settlement_load_curve_user
       - æ— æ•°æ®åˆ™æŸ¥ forecast_load_curve_user

    è¿”å›ï¼š
    {
        "data": [...],  # 48ç‚¹æ•°æ®
        "source": "forecast" | "settlement",
        "mode": "primary" | "fallback" | null,
        "date": "2025-11-10",
        "available": true | false,
        "message": "ä½¿ç”¨é¢„æµ‹æ›²çº¿æ•°æ®" | "æ•°æ®ä¸è¶³ï¼Œæ— æ³•æä¾›"
    }
    """
```

---

## ğŸ¨ å››ã€å‰ç«¯é¡µé¢è®¾è®¡

### 4.1 é¡µé¢ç»“æ„

**æ–°å¢é¡µé¢**ï¼š`frontend/src/pages/DataQualityPage.tsx`

**è·¯ç”±**ï¼š`/data-quality`

**å¯¼èˆªä½ç½®**ï¼šä¸»èœå• "æ•°æ®ç®¡ç†" â†’ "æ•°æ®è´¨é‡ç®¡ç†"

### 4.2 Tab ç»“æ„

```typescript
export const DataQualityPage: React.FC = () => {
    const [tabValue, setTabValue] = useState(0);

    return (
        <Container maxWidth={false} sx={{ mt: 4, mb: 4 }}>
            <Typography variant="h4" gutterBottom>
                æ•°æ®è´¨é‡ç®¡ç†
            </Typography>

            <Tabs value={tabValue} onChange={(e, v) => setTabValue(v)}>
                <Tab label="æ•°æ®å®Œæ•´æ€§åˆ†æ" />
                <Tab label="æ•°æ®æ ¡æ ¸" />
                <Tab label="æ•°æ®è´¨é‡çœ‹æ¿" />
            </Tabs>

            <Box sx={{ mt: 3 }}>
                {tabValue === 0 && <CompletenessAnalysisTab />}
                {tabValue === 1 && <DataValidationTab />}
                {tabValue === 2 && <QualityDashboardTab />}
            </Box>
        </Container>
    );
};
```

### 4.3 Tab 1: æ•°æ®å®Œæ•´æ€§åˆ†æ

**æ–‡ä»¶**ï¼š`frontend/src/pages/DataQualityPage/CompletenessAnalysisTab.tsx`

**åŠŸèƒ½ç»„ä»¶**ï¼š

1. **å®¢æˆ·é€‰æ‹©å™¨**
   ```typescript
   <Autocomplete
       options={customers}
       getOptionLabel={(option) => option.user_name}
       renderInput={(params) => <TextField {...params} label="é€‰æ‹©å®¢æˆ·" />}
       onChange={(e, value) => setSelectedCustomer(value)}
   />
   ```

2. **å®Œæ•´åº¦æŒ‡æ ‡å¡ç‰‡**ï¼ˆ4ä¸ªå¡ç‰‡ï¼‰
   ```typescript
   <Grid container spacing={2}>
       <Grid size={{ xs: 12, sm: 6, md: 3 }}>
           <MetricCard
               title="é¢„æµ‹æ›²çº¿å®Œæ•´åº¦"
               value="91.5%"
               trend="up"
               color="success"
           />
       </Grid>
       <Grid size={{ xs: 12, sm: 6, md: 3 }}>
           <MetricCard
               title="ç»“ç®—æ›²çº¿å®Œæ•´åº¦"
               value="96.2%"
               trend="stable"
               color="success"
           />
       </Grid>
       <Grid size={{ xs: 12, sm: 6, md: 3 }}>
           <MetricCard
               title="æ•°æ®äº¤é›†å®Œæ•´åº¦"
               value="92.3%"
               trend="up"
               color="warning"
           />
       </Grid>
       <Grid size={{ xs: 12, sm: 6, md: 3 }}>
           <MetricCard
               title="ç¼ºå¤±å¤©æ•°"
               value="6å¤©"
               trend="down"
               color="error"
           />
       </Grid>
   </Grid>
   ```

3. **æ•°æ®æ—¶é—´çº¿å¯è§†åŒ–**
   - ä½¿ç”¨ç”˜ç‰¹å›¾æˆ–çƒ­åŠ›å›¾å±•ç¤ºæ•°æ®è¦†ç›–èŒƒå›´
   - Xè½´ï¼šæ—¥æœŸ
   - Yè½´ï¼šæ•°æ®æºï¼ˆé¢„æµ‹æ›²çº¿ã€ç»“ç®—æ›²çº¿ï¼‰
   - é¢œè‰²ï¼šç»¿è‰²=æœ‰æ•°æ®ï¼Œçº¢è‰²=ç¼ºå¤±

   ```typescript
   <Paper variant="outlined" sx={{ p: 2, mt: 2 }}>
       <Typography variant="h6">æ•°æ®è¦†ç›–æ—¶é—´çº¿</Typography>
       <ResponsiveContainer width="100%" height={300}>
           <BarChart data={timelineData}>
               <XAxis dataKey="date" />
               <YAxis dataKey="source" type="category" />
               <Tooltip />
               <Bar dataKey="forecast" fill="#4caf50" />
               <Bar dataKey="settlement" fill="#2196f3" />
           </BarChart>
       </ResponsiveContainer>
   </Paper>
   ```

4. **ç¼ºå¤±æ—¥æœŸè¯¦æƒ…è¡¨**
   ```typescript
   <TableContainer component={Paper} sx={{ mt: 2 }}>
       <Table>
           <TableHead>
               <TableRow>
                   <TableCell>æ•°æ®æº</TableCell>
                   <TableCell>æ•°æ®èµ·å§‹</TableCell>
                   <TableCell>æ•°æ®æˆªæ­¢</TableCell>
                   <TableCell>ç¼ºå¤±å¤©æ•°</TableCell>
                   <TableCell>ç¼ºå¤±æ—¥æœŸ</TableCell>
               </TableRow>
           </TableHead>
           <TableBody>
               <TableRow>
                   <TableCell>é¢„æµ‹æ›²çº¿</TableCell>
                   <TableCell>2025-09-01</TableCell>
                   <TableCell>2025-11-10</TableCell>
                   <TableCell>6</TableCell>
                   <TableCell>
                       <Chip label="2025-09-15" size="small" />
                       <Chip label="2025-10-03" size="small" />
                       {/* ... */}
                   </TableCell>
               </TableRow>
               <TableRow>
                   <TableCell>ç»“ç®—æ›²çº¿</TableCell>
                   <TableCell>2025-09-05</TableCell>
                   <TableCell>2025-11-08</TableCell>
                   <TableCell>2</TableCell>
                   <TableCell>
                       <Chip label="2025-09-20" size="small" />
                       <Chip label="2025-10-15" size="small" />
                   </TableCell>
               </TableRow>
           </TableBody>
       </Table>
   </TableContainer>
   ```

### 4.4 Tab 2: æ•°æ®æ ¡æ ¸

**æ–‡ä»¶**ï¼š`frontend/src/pages/DataQualityPage/DataValidationTab.tsx`

**åŠŸèƒ½ç»„ä»¶**ï¼š

1. **æ ¡æ ¸å‚æ•°è®¾ç½®**
   ```typescript
   <Paper variant="outlined" sx={{ p: 2 }}>
       <Grid container spacing={2} alignItems="center">
           <Grid size={{ xs: 12, md: 4 }}>
               <Autocomplete
                   options={customers}
                   renderInput={(params) => <TextField {...params} label="é€‰æ‹©å®¢æˆ·" />}
               />
           </Grid>
           <Grid size={{ xs: 12, sm: 6, md: 3 }}>
               <DatePicker label="å¼€å§‹æ—¥æœŸ" value={startDate} onChange={setStartDate} />
           </Grid>
           <Grid size={{ xs: 12, sm: 6, md: 3 }}>
               <DatePicker label="ç»“æŸæ—¥æœŸ" value={endDate} onChange={setEndDate} />
           </Grid>
           <Grid size={{ xs: 12, md: 2 }}>
               <Button
                   variant="contained"
                   fullWidth
                   onClick={handleValidate}
                   disabled={loading}
               >
                   {loading ? <CircularProgress size={24} /> : "æ‰§è¡Œæ ¡æ ¸"}
               </Button>
           </Grid>
       </Grid>
   </Paper>
   ```

2. **åå·®ç»Ÿè®¡å¡ç‰‡**ï¼ˆ6ä¸ªæŒ‡æ ‡ï¼‰
   ```typescript
   <Grid container spacing={2} sx={{ mt: 2 }}>
       <Grid size={{ xs: 12, sm: 6, md: 4 }}>
           <StatCard title="å¹³å‡åå·®" value="-3.2 kWh" />
       </Grid>
       <Grid size={{ xs: 12, sm: 6, md: 4 }}>
           <StatCard title="å¹³å‡åå·®ç‡" value="-2.1%" />
       </Grid>
       <Grid size={{ xs: 12, sm: 6, md: 4 }}>
           <StatCard title="ç›¸å…³ç³»æ•°" value="0.985" />
       </Grid>
       <Grid size={{ xs: 12, sm: 6, md: 4 }}>
           <StatCard title="å‡æ–¹æ ¹è¯¯å·®" value="5.6 kWh" />
       </Grid>
       <Grid size={{ xs: 12, sm: 6, md: 4 }}>
           <StatCard title="æœ€å¤§æ­£åå·®" value="+15.8 kWh" />
       </Grid>
       <Grid size={{ xs: 12, sm: 6, md: 4 }}>
           <StatCard title="æœ€å¤§è´Ÿåå·®" value="-12.3 kWh" />
       </Grid>
   </Grid>
   ```

3. **æ›²çº¿å¯¹æ¯”å›¾è¡¨**
   ```typescript
   <Paper variant="outlined" sx={{ p: 2, mt: 2 }}>
       <Typography variant="h6">æ›²çº¿å¯¹æ¯”ï¼ˆ2025-11-10ï¼‰</Typography>
       <ResponsiveContainer width="100%" height={400}>
           <LineChart data={comparisonData}>
               <CartesianGrid strokeDasharray="3 3" />
               <XAxis dataKey="time" tickFormatter={formatTime} />
               <YAxis label={{ value: 'è´Ÿè· (kWh)', angle: -90 }} />
               <Tooltip />
               <Legend />
               <Line
                   type="monotone"
                   dataKey="forecast"
                   stroke="#4caf50"
                   name="é¢„æµ‹æ›²çº¿"
               />
               <Line
                   type="monotone"
                   dataKey="settlement"
                   stroke="#2196f3"
                   name="ç»“ç®—æ›²çº¿"
               />
               <Line
                   type="monotone"
                   dataKey="deviation"
                   stroke="#ff9800"
                   name="åå·®"
                   strokeDasharray="5 5"
               />
           </LineChart>
       </ResponsiveContainer>
   </Paper>
   ```

4. **æ—¶æ®µåå·®åˆ†æè¡¨**
   ```typescript
   <TableContainer component={Paper} sx={{ mt: 2 }}>
       <Table>
           <TableHead>
               <TableRow>
                   <TableCell>æ—¶æ®µ</TableCell>
                   <TableCell align="right">å¹³å‡åå·®ç‡</TableCell>
                   <TableCell align="right">æ ·æœ¬æ•°</TableCell>
                   <TableCell>åå·®è¶‹åŠ¿</TableCell>
               </TableRow>
           </TableHead>
           <TableBody>
               <TableRow>
                   <TableCell>00:00-08:00</TableCell>
                   <TableCell align="right">-1.5%</TableCell>
                   <TableCell align="right">480</TableCell>
                   <TableCell>
                       <Chip label="åä½" color="warning" size="small" />
                   </TableCell>
               </TableRow>
               {/* ... */}
           </TableBody>
       </Table>
   </TableContainer>
   ```

5. **æ¨èåˆ†é…ç³»æ•°**
   ```typescript
   <Paper variant="outlined" sx={{ p: 2, mt: 2 }}>
       <Typography variant="h6">æ¨èåˆ†é…ç³»æ•°ä¼˜åŒ–</Typography>
       <Alert severity="info" sx={{ mt: 1 }}>
           é‡‡ç”¨æœ€å°äºŒä¹˜æ³•ä¼˜åŒ–ï¼Œé¢„è®¡å¯å°†åå·®å‡å°‘ 18.5%
       </Alert>
       <TableContainer sx={{ mt: 2 }}>
           <Table>
               <TableHead>
                   <TableRow>
                       <TableCell>è®¡é‡ç‚¹ID</TableCell>
                       <TableCell>ç”µè¡¨èµ„äº§å·</TableCell>
                       <TableCell align="right">å½“å‰ç³»æ•°</TableCell>
                       <TableCell align="right">æ¨èç³»æ•°</TableCell>
                       <TableCell align="right">å˜åŒ–</TableCell>
                       <TableCell>æ“ä½œ</TableCell>
                   </TableRow>
               </TableHead>
               <TableBody>
                   <TableRow>
                       <TableCell>211474252</TableCell>
                       <TableCell>36300...898</TableCell>
                       <TableCell align="right">65.0%</TableCell>
                       <TableCell align="right">67.2%</TableCell>
                       <TableCell align="right">
                           <Chip label="+2.2%" color="success" size="small" />
                       </TableCell>
                       <TableCell>
                           <Button size="small">åº”ç”¨</Button>
                       </TableCell>
                   </TableRow>
                   {/* ... */}
               </TableBody>
           </Table>
       </TableContainer>
       <Box sx={{ mt: 2, display: 'flex', gap: 2 }}>
           <Button variant="contained" onClick={handleApplyAll}>
               åº”ç”¨å…¨éƒ¨æ¨èç³»æ•°
           </Button>
           <Button variant="outlined">
               å¯¼å‡ºæŠ¥å‘Š
           </Button>
       </Box>
   </Paper>
   ```

### 4.5 Tab 3: æ•°æ®è´¨é‡çœ‹æ¿

**æ–‡ä»¶**ï¼š`frontend/src/pages/DataQualityPage/QualityDashboardTab.tsx`

**åŠŸèƒ½ç»„ä»¶**ï¼š

1. **å…¨å±€ç»Ÿè®¡å¡ç‰‡**
   ```typescript
   <Grid container spacing={2}>
       <Grid size={{ xs: 12, sm: 6, md: 3 }}>
           <MetricCard title="æ€»å®¢æˆ·æ•°" value="50" icon={<PeopleIcon />} />
       </Grid>
       <Grid size={{ xs: 12, sm: 6, md: 3 }}>
           <MetricCard
               title="å¥åº·å®¢æˆ·"
               value="45"
               subtitle="å®Œæ•´åº¦â‰¥90%"
               color="success"
           />
       </Grid>
       <Grid size={{ xs: 12, sm: 6, md: 3 }}>
           <MetricCard
               title="è­¦å‘Šå®¢æˆ·"
               value="3"
               subtitle="70%â‰¤å®Œæ•´åº¦<90%"
               color="warning"
           />
       </Grid>
       <Grid size={{ xs: 12, sm: 6, md: 3 }}>
           <MetricCard
               title="ä¸¥é‡å®¢æˆ·"
               value="2"
               subtitle="å®Œæ•´åº¦<70%"
               color="error"
           />
       </Grid>
   </Grid>
   ```

2. **å®¢æˆ·æ•°æ®è´¨é‡åˆ—è¡¨**
   ```typescript
   <Paper variant="outlined" sx={{ mt: 2 }}>
       <Box sx={{ p: 2, display: 'flex', justifyContent: 'space-between' }}>
           <TextField
               placeholder="æœç´¢å®¢æˆ·..."
               size="small"
               InputProps={{
                   startAdornment: <SearchIcon />
               }}
           />
           <Button variant="outlined" startIcon={<RefreshIcon />}>
               åˆ·æ–°å…¨éƒ¨
           </Button>
       </Box>
       <TableContainer>
           <Table>
               <TableHead>
                   <TableRow>
                       <TableCell>å®¢æˆ·åç§°</TableCell>
                       <TableCell align="center">é¢„æµ‹æ›²çº¿å®Œæ•´åº¦</TableCell>
                       <TableCell align="center">ç»“ç®—æ›²çº¿å®Œæ•´åº¦</TableCell>
                       <TableCell align="center">äº¤é›†å®Œæ•´åº¦</TableCell>
                       <TableCell align="center">æœ€åæ›´æ–°</TableCell>
                       <TableCell align="center">æ“ä½œ</TableCell>
                   </TableRow>
               </TableHead>
               <TableBody>
                   {customers.map((customer) => (
                       <TableRow key={customer.id}>
                           <TableCell>{customer.name}</TableCell>
                           <TableCell align="center">
                               <CompletenessChip value={customer.forecast_completeness} />
                           </TableCell>
                           <TableCell align="center">
                               <CompletenessChip value={customer.settlement_completeness} />
                           </TableCell>
                           <TableCell align="center">
                               <CompletenessChip value={customer.overlap_completeness} />
                           </TableCell>
                           <TableCell align="center">
                               {formatDateTime(customer.last_update)}
                           </TableCell>
                           <TableCell align="center">
                               <IconButton size="small">
                                   <VisibilityIcon />
                               </IconButton>
                               <IconButton size="small">
                                   <RefreshIcon />
                               </IconButton>
                           </TableCell>
                       </TableRow>
                   ))}
               </TableBody>
           </Table>
       </TableContainer>
   </Paper>
   ```

   **CompletenessChip ç»„ä»¶**ï¼š
   ```typescript
   const CompletenessChip: React.FC<{ value: number }> = ({ value }) => {
       const getColor = () => {
           if (value >= 90) return 'success';
           if (value >= 70) return 'warning';
           return 'error';
       };

       return (
           <Chip
               label={`${value.toFixed(1)}%`}
               color={getColor()}
               size="small"
           />
       );
   };
   ```

---

## ğŸ”„ äº”ã€æ•°æ®å¤„ç†æµç¨‹

### 5.1 æµç¨‹Aï¼šæ‰‹å·¥æ•°æ®å¯¼å…¥ä¸è½¬æ¢

```
[ç”¨æˆ·ä¸Šä¼ Excel]
    â†“
[1] è§£æ96ç‚¹ç”µè¡¨ç¤ºæ•°æ•°æ®
    â†“
[2] ä¿å­˜åŸå§‹æ•°æ®åˆ° user_load_data
    â†“
[3] æ•°æ®è½¬æ¢æœåŠ¡ (DataTransformationService)
    â”œâ”€ 3.1 èšåˆï¼šæ¯2ä¸ª15åˆ†é’Ÿç‚¹åˆå¹¶ä¸º1ä¸ª30åˆ†é’Ÿç‚¹
    â”œâ”€ 3.2 ç¤ºæ•°è½¬å·®å€¼ï¼šç›¸é‚»ç‚¹ç›¸å‡å¾—åˆ°æ—¶æ®µç”¨ç”µé‡
    â”œâ”€ 3.3 åº”ç”¨ç”µè¡¨å€ç‡
    â””â”€ 3.4 å­˜å…¥ forecast_load_curve_mpï¼ˆè®¡é‡ç‚¹çº§ï¼‰
    â†“
[4] ç”¨æˆ·çº§èšåˆ (AggregationService)
    â”œâ”€ 4.1 æŸ¥è¯¢å®¢æˆ·æ¡£æ¡ˆï¼Œè·å–åˆ†é…ç³»æ•°
    â”œâ”€ 4.2 è®¡ç®—ï¼šç”¨æˆ·è´Ÿè· = Î£(è®¡é‡ç‚¹è´Ÿè· Ã— åˆ†é…ç³»æ•° / 100)
    â””â”€ 4.3 å­˜å…¥ forecast_load_curve_userï¼ˆç”¨æˆ·çº§ï¼‰
    â†“
[5] è§¦å‘æ•°æ®å®Œæ•´æ€§åˆ†æ (CompletenessAnalyzer)
    â”œâ”€ 5.1 åˆ†æé¢„æµ‹æ›²çº¿çš„è¦†ç›–èŒƒå›´å’Œç¼ºå¤±æ—¥æœŸ
    â”œâ”€ 5.2 åˆ†æç»“ç®—æ›²çº¿çš„è¦†ç›–èŒƒå›´å’Œç¼ºå¤±æ—¥æœŸ
    â”œâ”€ 5.3 è®¡ç®—äº¤é›†åˆ†æ
    â””â”€ 5.4 ç”ŸæˆæŠ¥å‘Šå¹¶å­˜å…¥ data_quality_report
    â†“
[å®Œæˆ]
```

**å…³é”®ä»£ç é€»è¾‘**ï¼ˆç¤ºä¾‹ï¼‰ï¼š

```python
# æ­¥éª¤3ï¼š96ç‚¹â†’48ç‚¹è½¬æ¢
def aggregate_96_to_48(points_96: List[float]) -> List[float]:
    """
    å°†96ä¸ª15åˆ†é’Ÿç‚¹èšåˆä¸º48ä¸ª30åˆ†é’Ÿç‚¹

    Args:
        points_96: 96ä¸ªç‚¹çš„ç¤ºæ•°åˆ—è¡¨ï¼ˆæŒ‰æ—¶é—´é¡ºåºï¼‰

    Returns:
        48ä¸ªç‚¹çš„ç”¨ç”µé‡åˆ—è¡¨
    """
    points_48 = []
    for i in range(0, 96, 2):
        # è®¡ç®—å·®å€¼ï¼ˆç¤ºæ•°è½¬ç”¨ç”µé‡ï¼‰
        load = points_96[i + 1] - points_96[i]
        points_48.append(load)
    return points_48

# æ­¥éª¤4ï¼šç”¨æˆ·çº§èšåˆ
def aggregate_to_user_level(
    customer_id: str,
    datetime: datetime
) -> float:
    """
    èšåˆè®¡é‡ç‚¹è´Ÿè·åˆ°ç”¨æˆ·çº§

    Args:
        customer_id: å®¢æˆ·ID
        datetime: æ—¶é—´æˆ³

    Returns:
        ç”¨æˆ·æ€»è´Ÿè·ï¼ˆkWhï¼‰
    """
    # 1. æŸ¥è¯¢å®¢æˆ·æ¡£æ¡ˆ
    customer = customers_collection.find_one({"_id": ObjectId(customer_id)})

    # 2. æå–æ‰€æœ‰è®¡é‡ç‚¹å’Œåˆ†é…ç³»æ•°
    mp_allocations = []
    for account in customer["utility_accounts"]:
        for mp in account["metering_points"]:
            mp_allocations.append({
                "mp_id": mp["metering_point_id"],
                "percentage": mp["allocation_percentage"]
            })

    # 3. æŸ¥è¯¢å„è®¡é‡ç‚¹çš„è´Ÿè·
    total_load = 0.0
    for mp_alloc in mp_allocations:
        mp_data = forecast_load_curve_mp.find_one({
            "mp_id": mp_alloc["mp_id"],
            "datetime": datetime
        })
        if mp_data:
            total_load += mp_data["load_kwh"] * mp_alloc["percentage"] / 100.0

    return total_load
```

### 5.2 æµç¨‹Bï¼šRPAæ•°æ®å¯¼å…¥

```
[RPAçˆ¬å–]
    â†“
[1] åŸå§‹æ•°æ®å­˜å…¥ mp_load_curveï¼ˆ48ç‚¹ï¼ŒMWhï¼‰
    â†“
[2] æ•°æ®è½¬æ¢æœåŠ¡
    â”œâ”€ 2.1 å•ä½è½¬æ¢ï¼šMWh â†’ kWh (Ã—1000)
    â””â”€ 2.2 å­˜å…¥ settlement_load_curve_mpï¼ˆè®¡é‡ç‚¹çº§ï¼‰
    â†“
[3] ç”¨æˆ·çº§èšåˆ
    â”œâ”€ 3.1 æŒ‰åˆ†é…ç³»æ•°èšåˆ
    â””â”€ 3.2 å­˜å…¥ settlement_load_curve_userï¼ˆç”¨æˆ·çº§ï¼‰
    â†“
[4] è§¦å‘æ•°æ®å®Œæ•´æ€§åˆ†æ
    â†“
[å®Œæˆ]
```

### 5.3 æµç¨‹Cï¼šæ•°æ®æ ¡æ ¸ï¼ˆæ‰‹åŠ¨è§¦å‘ï¼‰

```
[ç”¨æˆ·ç‚¹å‡»"æ‰§è¡Œæ ¡æ ¸"]
    â†“
[1] å‚æ•°éªŒè¯
    â”œâ”€ å®¢æˆ·ID
    â”œâ”€ æ—¥æœŸèŒƒå›´ï¼ˆé»˜è®¤æœ€è¿‘30å¤©ï¼‰
    â””â”€ æ˜¯å¦ä¼˜åŒ–åˆ†é…ç³»æ•°
    â†“
[2] æ•°æ®å‡†å¤‡
    â”œâ”€ 2.1 æŸ¥è¯¢é¢„æµ‹æ›²çº¿ï¼ˆç”¨æˆ·çº§ï¼‰
    â”œâ”€ 2.2 æŸ¥è¯¢ç»“ç®—æ›²çº¿ï¼ˆç”¨æˆ·çº§ï¼‰
    â””â”€ 2.3 å–äº¤é›†ï¼ˆä¸¤æ¡æ›²çº¿éƒ½æœ‰æ•°æ®çš„æ—¶é—´ç‚¹ï¼‰
    â†“
[3] åå·®è®¡ç®— (CurveValidator.calculate_deviation)
    â”œâ”€ 3.1 é€ç‚¹è®¡ç®—åå·®ï¼šdeviation = forecast - settlement
    â”œâ”€ 3.2 è®¡ç®—åå·®ç‡ï¼šdeviation_rate = (deviation / settlement) Ã— 100
    â”œâ”€ 3.3 ç»Ÿè®¡æŒ‡æ ‡ï¼š
    â”‚   â”œâ”€ mean_deviation = mean(deviation)
    â”‚   â”œâ”€ mean_deviation_rate = mean(deviation_rate)
    â”‚   â”œâ”€ max_positive_deviation = max(deviation)
    â”‚   â”œâ”€ max_negative_deviation = min(deviation)
    â”‚   â”œâ”€ rmse = sqrt(mean(deviationÂ²))
    â”‚   â”œâ”€ mae = mean(|deviation|)
    â”‚   â””â”€ correlation = corr(forecast, settlement)
    â””â”€ 3.4 æ—¶æ®µåˆ†æï¼ˆå¯é€‰ï¼‰ï¼šåˆ†00-08ã€08-20ã€20-24ä¸‰ä¸ªæ—¶æ®µ
    â†“
[4] åˆ†é…ç³»æ•°ä¼˜åŒ–ï¼ˆå¦‚æœå¯ç”¨ï¼‰
    â”œâ”€ 4.1 æŸ¥è¯¢è®¡é‡ç‚¹çº§æ•°æ®
    â”œâ”€ 4.2 æ„å»ºä¼˜åŒ–é—®é¢˜ï¼š
    â”‚   ç›®æ ‡å‡½æ•°ï¼šmin Î£(é¢„æµ‹_i - ç»“ç®—_i)Â²
    â”‚   çº¦æŸæ¡ä»¶ï¼šÎ£(åˆ†é…ç³»æ•°_j) = åŸæ€»å’Œï¼ˆæ¯ä¸ªç”µè¡¨ï¼‰
    â”œâ”€ 4.3 ä½¿ç”¨æœ€å°äºŒä¹˜æ³•æˆ–æ¢¯åº¦ä¸‹é™æ±‚è§£
    â””â”€ 4.4 è¿”å›æ¨èç³»æ•°
    â†“
[5] ç”ŸæˆæŠ¥å‘Š
    â”œâ”€ 5.1 åˆ›å»º data_quality_report æ–‡æ¡£
    â”‚   â”œâ”€ report_type = "validation"
    â”‚   â”œâ”€ completeness_analysisï¼ˆå¤ç”¨æœ€æ–°å®Œæ•´æ€§æŠ¥å‘Šï¼‰
    â”‚   â””â”€ validation_resultï¼ˆæ­¥éª¤3å’Œ4çš„ç»“æœï¼‰
    â””â”€ 5.2 ä¿å­˜åˆ°æ•°æ®åº“
    â†“
[6] è¿”å›æŠ¥å‘ŠIDç»™å‰ç«¯
    â†“
[å®Œæˆ]
```

**å…³é”®ç®—æ³•**ï¼š

```python
# åˆ†é…ç³»æ•°ä¼˜åŒ–ï¼ˆæœ€å°äºŒä¹˜æ³•ï¼‰
import numpy as np
from scipy.optimize import minimize

def optimize_allocation_coefficients(
    customer_id: str,
    start_date: date,
    end_date: date
):
    """
    ä¼˜åŒ–åˆ†é…ç³»æ•°ä»¥æœ€å°åŒ–é¢„æµ‹æ›²çº¿ä¸ç»“ç®—æ›²çº¿çš„åå·®
    """
    # 1. æŸ¥è¯¢æ•°æ®
    forecast_mp = fetch_forecast_mp_data(customer_id, start_date, end_date)
    settlement_mp = fetch_settlement_mp_data(customer_id, start_date, end_date)
    settlement_user = fetch_settlement_user_data(customer_id, start_date, end_date)

    # 2. æ„é€ çŸ©é˜µ
    # X: (n_samples, n_metering_points) - å„è®¡é‡ç‚¹è´Ÿè·
    # y: (n_samples,) - ç»“ç®—æ›²çº¿ï¼ˆç”¨æˆ·çº§ï¼‰
    # w: (n_metering_points,) - åˆ†é…ç³»æ•°ï¼ˆå¾…ä¼˜åŒ–ï¼‰

    X = np.array([[mp[mp_id] for mp_id in mp_ids] for mp in forecast_mp])
    y = np.array(settlement_user)

    # å½“å‰åˆ†é…ç³»æ•°
    w_current = np.array([mp_info["percentage"] / 100 for mp_info in mp_infos])

    # 3. ä¼˜åŒ–ç›®æ ‡å‡½æ•°
    def objective(w):
        y_pred = X @ w  # çŸ©é˜µä¹˜æ³•ï¼šé¢„æµ‹çš„ç”¨æˆ·è´Ÿè·
        return np.sum((y_pred - y) ** 2)  # æœ€å°åŒ–å¹³æ–¹è¯¯å·®

    # 4. çº¦æŸæ¡ä»¶ï¼šæ¯ä¸ªç”µè¡¨çš„åˆ†é…ç³»æ•°æ€»å’Œä¿æŒä¸å˜
    constraints = []
    for meter_id in unique_meter_ids:
        mp_indices = [i for i, mp in enumerate(mp_infos) if mp["meter_id"] == meter_id]
        current_sum = sum(w_current[i] for i in mp_indices)
        constraints.append({
            'type': 'eq',
            'fun': lambda w, indices=mp_indices, target=current_sum:
                   sum(w[i] for i in indices) - target
        })

    # 5. è¾¹ç•Œï¼š0 <= w <= 1
    bounds = [(0, 1) for _ in range(len(w_current))]

    # 6. æ±‚è§£
    result = minimize(
        objective,
        w_current,
        method='SLSQP',
        bounds=bounds,
        constraints=constraints
    )

    # 7. è¿”å›æ¨èç³»æ•°
    w_optimized = result.x
    recommendations = []
    for i, mp_info in enumerate(mp_infos):
        recommendations.append({
            "mp_id": mp_info["mp_id"],
            "meter_id": mp_info["meter_id"],
            "current_percentage": w_current[i] * 100,
            "recommended_percentage": w_optimized[i] * 100,
            "change": (w_optimized[i] - w_current[i]) * 100
        })

    # è®¡ç®—æ”¹è¿›å¹…åº¦
    current_error = objective(w_current)
    optimized_error = objective(w_optimized)
    improvement = (1 - optimized_error / current_error) * 100

    return {
        "recommendations": recommendations,
        "estimated_improvement": improvement
    }
```

### 5.4 æµç¨‹Dï¼šè´Ÿè·é¢„æµ‹æ•°æ®å€Ÿç”¨

```
[è´Ÿè·é¢„æµ‹æ¨¡å—è¯·æ±‚æ•°æ®]
    â†“
[è°ƒç”¨ /load-data-with-fallback API]
    â”œâ”€ customer_id: "xxx"
    â”œâ”€ date: "2025-11-10"
    â””â”€ preferred_source: "forecast"
    â†“
[1] æŸ¥è¯¢ forecast_load_curve_userï¼ˆT-1ä¼˜å…ˆï¼‰
    â”œâ”€ æœ‰æ•°æ® â†’ è¿”å› { data, source: "forecast", mode: "A" }
    â””â”€ æ— æ•°æ® â†’ è¿›å…¥æ­¥éª¤2
    â†“
[2] æŸ¥è¯¢ settlement_load_curve_userï¼ˆT-2å›é€€ï¼‰
    â”œâ”€ æœ‰æ•°æ® â†’ è¿”å› { data, source: "settlement", mode: "B" }
    â””â”€ æ— æ•°æ® â†’ è¿›å…¥æ­¥éª¤3
    â†“
[3] éƒ½æ— æ•°æ®
    â””â”€ è¿”å› { data: null, mode: null, error: "æ•°æ®ä¸è¶³ï¼Œæ— æ³•é¢„æµ‹" }
    â†“
[è´Ÿè·é¢„æµ‹æ¨¡å—å¤„ç†è¿”å›ç»“æœ]
    â”œâ”€ mode="A" â†’ æ‰§è¡Œé«˜ç²¾åº¦é¢„æµ‹
    â”œâ”€ mode="B" â†’ æ‰§è¡Œå¤‡ç”¨é¢„æµ‹
    â””â”€ mode=null â†’ è·³è¿‡é¢„æµ‹ï¼Œæ ‡è®°"æ•°æ®ä¸è¶³"
    â†“
[å®Œæˆ]
```

**é‡è¦**ï¼šå€Ÿç”¨çš„æ•°æ®ä»…åœ¨å†…å­˜ä¸­ä½¿ç”¨ï¼Œä¸å†™å…¥å¯¹æ–¹çš„æ•°æ®åº“ã€‚

---

## ğŸ“… å…­ã€å®æ–½æ­¥éª¤è¯¦ç»†è§„åˆ’

### é˜¶æ®µ1ï¼šæ•°æ®åŸºç¡€è®¾æ–½ï¼ˆ3-4å¤©ï¼‰

#### ç¬¬1å¤©ï¼šæ•°æ®åº“è®¾è®¡ä¸é›†åˆåˆ›å»º

**ä»»åŠ¡**ï¼š
1. åˆ›å»ºMongoDBé›†åˆåŠç´¢å¼•
2. ç¼–å†™æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬

**äº¤ä»˜ç‰©**ï¼š
```python
# scripts/init_data_validation_collections.py

from webapp.tools.mongo import DATABASE

def create_collections_and_indexes():
    """åˆ›å»ºæ•°æ®éªŒè¯ç›¸å…³çš„é›†åˆå’Œç´¢å¼•"""

    # 1. forecast_load_curve_mp
    forecast_mp = DATABASE['forecast_load_curve_mp']
    forecast_mp.create_index([("mp_id", 1), ("datetime", 1)], unique=True)
    forecast_mp.create_index([("meter_id", 1), ("datetime", 1)])
    forecast_mp.create_index([("datetime", 1)])

    # 2. forecast_load_curve_user
    forecast_user = DATABASE['forecast_load_curve_user']
    forecast_user.create_index([("customer_id", 1), ("datetime", 1)], unique=True)

    # 3. settlement_load_curve_mp
    settlement_mp = DATABASE['settlement_load_curve_mp']
    settlement_mp.create_index([("mp_id", 1), ("datetime", 1)], unique=True)

    # 4. settlement_load_curve_user
    settlement_user = DATABASE['settlement_load_curve_user']
    settlement_user.create_index([("customer_id", 1), ("datetime", 1)], unique=True)

    # 5. data_quality_report
    quality_report = DATABASE['data_quality_report']
    quality_report.create_index([("customer_id", 1), ("generated_at", -1)])
    quality_report.create_index([("customer_id", 1), ("report_type", 1), ("generated_at", -1)])

    print("âœ… æ‰€æœ‰é›†åˆå’Œç´¢å¼•åˆ›å»ºå®Œæˆ")

if __name__ == "__main__":
    create_collections_and_indexes()
```

#### ç¬¬2-3å¤©ï¼šæ•°æ®è½¬æ¢æœåŠ¡å¼€å‘

**ä»»åŠ¡**ï¼š
1. å®ç°96ç‚¹â†’48ç‚¹è½¬æ¢
2. å®ç°ç¤ºæ•°â†’å·®å€¼è½¬æ¢
3. å®ç°è®¡é‡ç‚¹â†’ç”¨æˆ·èšåˆ
4. å•å…ƒæµ‹è¯•

**äº¤ä»˜ç‰©**ï¼š
```python
# webapp/services/data_transformation.py

from typing import List, Dict
from datetime import datetime, timedelta
from webapp.tools.mongo import DATABASE

class DataTransformationService:
    """æ•°æ®è½¬æ¢æœåŠ¡"""

    def __init__(self):
        self.user_load_data = DATABASE['user_load_data']
        self.forecast_mp = DATABASE['forecast_load_curve_mp']
        self.forecast_user = DATABASE['forecast_load_curve_user']
        self.customers = DATABASE['customers']

    def transform_manual_data(self, import_batch_id: str) -> Dict:
        """
        å°†æ‰‹å·¥å¯¼å…¥çš„96ç‚¹æ•°æ®è½¬æ¢ä¸º48ç‚¹é¢„æµ‹æ›²çº¿

        Args:
            import_batch_id: å¯¼å…¥æ‰¹æ¬¡ID

        Returns:
            è½¬æ¢ç»Ÿè®¡ä¿¡æ¯
        """
        # å®ç°é€»è¾‘...
        pass

    def aggregate_96_to_48(self, points_96: List[float]) -> List[float]:
        """96ç‚¹èšåˆä¸º48ç‚¹"""
        pass

    def convert_reading_to_load(self, readings: List[float]) -> List[float]:
        """ç¤ºæ•°è½¬ç”¨ç”µé‡"""
        pass

    def aggregate_to_user_level(
        self,
        customer_id: str,
        date: datetime
    ) -> List[Dict]:
        """èšåˆåˆ°ç”¨æˆ·çº§"""
        pass
```

#### ç¬¬4å¤©ï¼šæ•°æ®è¿ç§»è„šæœ¬

**ä»»åŠ¡**ï¼š
1. ç¼–å†™è¿ç§»è„šæœ¬ï¼Œå°†ç°æœ‰æ•°æ®è¿ç§»åˆ°æ–°é›†åˆ
2. éªŒè¯æ•°æ®ä¸€è‡´æ€§

**äº¤ä»˜ç‰©**ï¼š
```python
# scripts/migrate_load_curves.py

def migrate_existing_data():
    """è¿ç§»ç°æœ‰æ•°æ®åˆ°æ–°çš„æ›²çº¿åº“"""

    # 1. è¿ç§»æ‰‹å·¥æ•°æ®
    migrate_manual_data()

    # 2. è¿ç§»RPAæ•°æ®
    migrate_rpa_data()

    # 3. æ•°æ®éªŒè¯
    validate_migration()
```

### é˜¶æ®µ2ï¼šæ•°æ®å®Œæ•´æ€§åˆ†æï¼ˆ2-3å¤©ï¼‰

#### ç¬¬5å¤©ï¼šå®Œæ•´æ€§åˆ†æç®—æ³•

**ä»»åŠ¡**ï¼š
1. å®ç°æ•°æ®è¦†ç›–èŒƒå›´åˆ†æ
2. å®ç°ç¼ºå¤±æ—¥æœŸæ£€æµ‹
3. å®ç°äº¤é›†åˆ†æ

**äº¤ä»˜ç‰©**ï¼š
```python
# webapp/services/completeness_analyzer.py

from typing import List, Dict
from datetime import date, datetime, timedelta

class CompletenessAnalyzer:
    """æ•°æ®å®Œæ•´æ€§åˆ†æå™¨"""

    def analyze_customer_completeness(
        self,
        customer_id: str
    ) -> Dict:
        """
        åˆ†ææŒ‡å®šå®¢æˆ·çš„æ•°æ®å®Œæ•´æ€§

        Returns:
            å®Œæ•´æ€§æŠ¥å‘Šï¼ˆå­—å…¸æ ¼å¼ï¼‰
        """
        forecast_analysis = self._analyze_curve(
            customer_id,
            "forecast"
        )

        settlement_analysis = self._analyze_curve(
            customer_id,
            "settlement"
        )

        overlap_analysis = self._analyze_overlap(
            customer_id,
            forecast_analysis,
            settlement_analysis
        )

        return {
            "customer_id": customer_id,
            "report_type": "completeness",
            "generated_at": datetime.utcnow(),
            "completeness_analysis": {
                "forecast_curve": forecast_analysis,
                "settlement_curve": settlement_analysis,
                "overlap_analysis": overlap_analysis
            }
        }

    def _analyze_curve(
        self,
        customer_id: str,
        curve_type: str
    ) -> Dict:
        """åˆ†æå•æ¡æ›²çº¿"""
        # 1. æŸ¥è¯¢æ‰€æœ‰æ•°æ®æ—¥æœŸ
        # 2. è®¡ç®—èµ·æ­¢æ—¥æœŸ
        # 3. æ£€æµ‹ç¼ºå¤±æ—¥æœŸ
        # 4. è®¡ç®—å®Œæ•´åº¦
        pass

    def _analyze_overlap(
        self,
        customer_id: str,
        forecast_analysis: Dict,
        settlement_analysis: Dict
    ) -> Dict:
        """åˆ†æä¸¤æ¡æ›²çº¿çš„äº¤é›†"""
        pass
```

#### ç¬¬6-7å¤©ï¼šAPIç«¯ç‚¹ä¸å‰ç«¯é¡µé¢

**ä»»åŠ¡**ï¼š
1. å®ç°å®Œæ•´æ€§åˆ†æAPIç«¯ç‚¹
2. å¼€å‘å‰ç«¯Tab 1ï¼šæ•°æ®å®Œæ•´æ€§åˆ†æ
3. é›†æˆåˆ°æ•°æ®å¯¼å…¥æµç¨‹

**äº¤ä»˜ç‰©**ï¼š
- `webapp/api/v1_data_validation.py`ï¼ˆéƒ¨åˆ†ï¼‰
- `frontend/src/pages/DataQualityPage/CompletenessAnalysisTab.tsx`

### é˜¶æ®µ3ï¼šæ•°æ®æ ¡æ ¸åŠŸèƒ½ï¼ˆ3-4å¤©ï¼‰

#### ç¬¬8å¤©ï¼šæ ¡æ ¸ç®—æ³•æ ¸å¿ƒ

**ä»»åŠ¡**ï¼š
1. å®ç°æ›²çº¿å¯¹æ¯”
2. å®ç°åå·®ç»Ÿè®¡
3. å®ç°æ—¶æ®µåˆ†æ

**äº¤ä»˜ç‰©**ï¼š
```python
# webapp/services/curve_validator.py

import numpy as np
from scipy.stats import pearsonr

class CurveValidator:
    """æ›²çº¿æ ¡æ ¸éªŒè¯å™¨"""

    def validate_curves(
        self,
        customer_id: str,
        start_date: date,
        end_date: date,
        optimize_allocation: bool = True
    ) -> Dict:
        """
        æ‰§è¡Œæ›²çº¿æ ¡æ ¸

        Returns:
            æ ¡æ ¸æŠ¥å‘Šï¼ˆå­—å…¸æ ¼å¼ï¼‰
        """
        # 1. æ•°æ®å‡†å¤‡
        forecast_data = self._fetch_forecast_data(customer_id, start_date, end_date)
        settlement_data = self._fetch_settlement_data(customer_id, start_date, end_date)

        # 2. åå·®è®¡ç®—
        statistics = self._calculate_statistics(forecast_data, settlement_data)

        # 3. æ—¶æ®µåˆ†æ
        period_analysis = self._analyze_by_period(forecast_data, settlement_data)

        # 4. åˆ†é…ç³»æ•°ä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰
        allocation_optimization = None
        if optimize_allocation:
            allocation_optimization = self._optimize_allocation(
                customer_id, start_date, end_date
            )

        # 5. ç»„è£…æŠ¥å‘Š
        return {
            "customer_id": customer_id,
            "report_type": "validation",
            "generated_at": datetime.utcnow(),
            "validation_result": {
                "analysis_period": {
                    "start_date": start_date.isoformat(),
                    "end_date": end_date.isoformat()
                },
                "statistics": statistics,
                "period_analysis": period_analysis,
                "allocation_optimization": allocation_optimization
            }
        }

    def _calculate_statistics(
        self,
        forecast: List[float],
        settlement: List[float]
    ) -> Dict:
        """è®¡ç®—ç»Ÿè®¡æŒ‡æ ‡"""
        forecast_arr = np.array(forecast)
        settlement_arr = np.array(settlement)
        deviation = forecast_arr - settlement_arr
        deviation_rate = (deviation / settlement_arr) * 100

        return {
            "mean_deviation": float(np.mean(deviation)),
            "mean_deviation_rate": float(np.mean(deviation_rate)),
            "max_positive_deviation": float(np.max(deviation)),
            "max_negative_deviation": float(np.min(deviation)),
            "rmse": float(np.sqrt(np.mean(deviation ** 2))),
            "mae": float(np.mean(np.abs(deviation))),
            "correlation": float(pearsonr(forecast_arr, settlement_arr)[0])
        }
```

#### ç¬¬9å¤©ï¼šåˆ†é…ç³»æ•°ä¼˜åŒ–

**ä»»åŠ¡**ï¼š
1. å®ç°æœ€å°äºŒä¹˜æ³•ä¼˜åŒ–
2. å®ç°çº¦æŸæ¡ä»¶å¤„ç†

**äº¤ä»˜ç‰©**ï¼š
- `curve_validator.py` ä¸­çš„ä¼˜åŒ–æ–¹æ³•

#### ç¬¬10-11å¤©ï¼šAPIä¸å‰ç«¯

**ä»»åŠ¡**ï¼š
1. å®ç°æ ¡æ ¸APIç«¯ç‚¹
2. å¼€å‘å‰ç«¯Tab 2ï¼šæ•°æ®æ ¡æ ¸
3. å®ç°æ¨èç³»æ•°åº”ç”¨åŠŸèƒ½

**äº¤ä»˜ç‰©**ï¼š
- APIç«¯ç‚¹è¡¥å……
- `frontend/src/pages/DataQualityPage/DataValidationTab.tsx`

### é˜¶æ®µ4ï¼šæ•°æ®å€Ÿç”¨ä¸é›†æˆï¼ˆ2-3å¤©ï¼‰

#### ç¬¬12å¤©ï¼šæ•°æ®å€Ÿç”¨æœåŠ¡

**ä»»åŠ¡**ï¼š
1. å®ç°æ•°æ®å€Ÿç”¨API
2. ç¼–å†™æ–‡æ¡£

**äº¤ä»˜ç‰©**ï¼š
```python
# webapp/services/data_fallback.py

class DataFallbackService:
    """æ•°æ®å€Ÿç”¨æœåŠ¡"""

    def get_load_data_with_fallback(
        self,
        customer_id: str,
        date: date,
        preferred_source: str = "forecast"
    ) -> Dict:
        """
        æ™ºèƒ½æ•°æ®å€Ÿç”¨

        Args:
            customer_id: å®¢æˆ·ID
            date: æ—¥æœŸ
            preferred_source: "forecast" | "settlement"

        Returns:
            {
                "data": [...],  # 48ç‚¹æ•°æ®
                "source": "forecast" | "settlement",
                "mode": "primary" | "fallback" | null,
                "available": bool
            }
        """
        pass
```

#### ç¬¬13å¤©ï¼šæ¨¡å—é›†æˆ

**ä»»åŠ¡**ï¼š
1. é›†æˆåˆ°è´Ÿè·é¢„æµ‹æ¨¡å—
2. é›†æˆåˆ°é¢„ç»“ç®—æ¨¡å—
3. æµ‹è¯•å›é€€é€»è¾‘

#### ç¬¬14å¤©ï¼šçœ‹æ¿ä¸æ–‡æ¡£

**ä»»åŠ¡**ï¼š
1. å¼€å‘å‰ç«¯Tab 3ï¼šæ•°æ®è´¨é‡çœ‹æ¿
2. ç³»ç»Ÿæµ‹è¯•
3. ç¼–å†™ç”¨æˆ·æ‰‹å†Œ

**äº¤ä»˜ç‰©**ï¼š
- `frontend/src/pages/DataQualityPage/QualityDashboardTab.tsx`
- `docs/pages/è´Ÿè·æ•°æ®æ ¡éªŒ/ç”¨æˆ·æ‰‹å†Œ.md`

---

## âš ï¸ ä¸ƒã€å…³é”®æŠ€æœ¯è¦ç‚¹

### 7.1 æ—¶é—´æˆ³è§„èŒƒï¼ˆæå…¶é‡è¦ï¼ï¼‰

æ ¹æ® `docs/todo/è´Ÿè·æ•°æ®å¤„ç†ä¸å±•ç¤ºæŠ€æœ¯è¦ç‚¹.md`ï¼š

**è§„åˆ™**ï¼šä¸šåŠ¡æ—¥çš„24:00å¿…é¡»å­˜å‚¨ä¸ºä¸‹ä¸€æ—¥çš„00:00:00

```python
# âŒ é”™è¯¯
{ "datetime": ISODate("2025-11-10T24:00:00Z") }  # MongoDBä¸æ”¯æŒ

# âœ… æ­£ç¡®
{ "datetime": ISODate("2025-11-11T00:00:00Z") }  # 2025-11-10çš„24:00
```

**æŸ¥è¯¢åŒºé—´**ï¼šå·¦å¼€å³é—­ `(start_of_day, end_of_day]`

```python
# æŸ¥è¯¢2025-11-10çš„æ‰€æœ‰æ•°æ®ï¼ˆ48ç‚¹ï¼‰
query = {
    "datetime": {
        "$gt": datetime(2025, 11, 10, 0, 0, 0),   # ä¸åŒ…å«00:00
        "$lte": datetime(2025, 11, 11, 0, 0, 0)   # åŒ…å«24:00ï¼ˆä¸‹ä¸€æ—¥00:00ï¼‰
    }
}
```

### 7.2 æ•°æ®çº¯æ´æ€§åŸåˆ™

- **é¢„æµ‹æ›²çº¿åº“** = 100%æ‰‹å·¥å¯¼å…¥æ•°æ®
- **ç»“ç®—æ›²çº¿åº“** = 100%RPAæ•°æ®
- **ä¸¥ç¦æ··åˆ**ï¼šä¸èƒ½å°†RPAæ•°æ®å­˜å…¥é¢„æµ‹æ›²çº¿åº“ï¼Œåä¹‹äº¦ç„¶
- **å€Ÿç”¨è§„åˆ™**ï¼šæ•°æ®èåˆä»…å‘ç”Ÿåœ¨åº”ç”¨å±‚å†…å­˜ï¼Œä¸æŒä¹…åŒ–

### 7.3 èšåˆè®¡ç®—è§„èŒƒ

#### è®¡é‡ç‚¹â†’ç”¨æˆ·èšåˆ

```python
ç”¨æˆ·è´Ÿè· = Î£(è®¡é‡ç‚¹_içš„è´Ÿè· Ã— åˆ†é…ç³»æ•°_i / 100)
```

**æ³¨æ„**ï¼š
- ä¸€ä¸ªå®¢æˆ·å¯èƒ½æœ‰å¤šä¸ªæˆ·å·
- ä¸€ä¸ªæˆ·å·å¯èƒ½æœ‰å¤šä¸ªè®¡é‡ç‚¹
- ä¸€ä¸ªè®¡é‡ç‚¹å¯¹åº”ä¸€ä¸ªç”µè¡¨
- åŒä¸€ä¸ªç”µè¡¨å¯èƒ½è¢«å¤šä¸ªè®¡é‡ç‚¹å…±äº«ï¼ˆé€šè¿‡ä¸åŒåˆ†é…ç³»æ•°ï¼‰

**ç¤ºä¾‹**ï¼š
```python
# å®¢æˆ·Açš„æˆ·å·1åŒ…å«4ä¸ªè®¡é‡ç‚¹
mp1: load=100kWh, allocation=65%   â†’ è´¡çŒ® 100 Ã— 0.65 = 65kWh
mp2: load=80kWh,  allocation=63.4569% â†’ è´¡çŒ® 80 Ã— 0.634569 = 50.77kWh
mp3: load=100kWh, allocation=25%   â†’ è´¡çŒ® 100 Ã— 0.25 = 25kWh
mp4: load=80kWh,  allocation=25%   â†’ è´¡çŒ® 80 Ã— 0.25 = 20kWh

ç”¨æˆ·Aæ€»è´Ÿè· = 65 + 50.77 + 25 + 20 = 160.77kWh
```

### 7.4 æ€§èƒ½ä¼˜åŒ–

#### A. ä½¿ç”¨MongoDBèšåˆç®¡é“

```python
# âŒ ä½æ•ˆï¼šå¾ªç¯æŸ¥è¯¢
for customer_id in customer_ids:
    for datetime in datetimes:
        data = collection.find_one({"customer_id": customer_id, "datetime": datetime})

# âœ… é«˜æ•ˆï¼šèšåˆç®¡é“
pipeline = [
    {"$match": {
        "customer_id": {"$in": customer_ids},
        "datetime": {"$gte": start, "$lte": end}
    }},
    {"$group": {
        "_id": "$customer_id",
        "data": {"$push": {"datetime": "$datetime", "load_kwh": "$load_kwh"}}
    }}
]
results = collection.aggregate(pipeline)
```

#### B. æ‰¹é‡å†™å…¥

```python
# âŒ ä½æ•ˆï¼šé€æ¡æ’å…¥
for record in records:
    collection.insert_one(record)

# âœ… é«˜æ•ˆï¼šæ‰¹é‡æ’å…¥
collection.insert_many(records, ordered=False)
```

#### C. ç´¢å¼•ä¼˜åŒ–

- æŸ¥è¯¢é¢‘ç¹çš„å­—æ®µå¿…é¡»å»ºç«‹ç´¢å¼•
- ä½¿ç”¨å¤åˆç´¢å¼•åŠ é€Ÿå¤šå­—æ®µæŸ¥è¯¢
- å®šæœŸç›‘æ§æ…¢æŸ¥è¯¢

### 7.5 äº‹åŠ¡æ€§ä¿è¯

æ•°æ®å¯¼å…¥å’Œèšåˆåº”ä½¿ç”¨MongoDBäº‹åŠ¡ï¼š

```python
from pymongo import MongoClient

client = MongoClient(...)
with client.start_session() as session:
    with session.start_transaction():
        # æ­¥éª¤1ï¼šæ’å…¥è®¡é‡ç‚¹çº§æ•°æ®
        forecast_mp.insert_many(mp_records, session=session)

        # æ­¥éª¤2ï¼šèšåˆåˆ°ç”¨æˆ·çº§
        user_records = aggregate_to_user_level(...)
        forecast_user.insert_many(user_records, session=session)

        # å¦‚æœä»»ä½•æ­¥éª¤å¤±è´¥ï¼Œè‡ªåŠ¨å›æ»š
```

### 7.6 é”™è¯¯å¤„ç†

```python
# APIé”™è¯¯å¤„ç†ç¤ºä¾‹
@router.post("/validate-curves")
async def validate_curves(customer_id: str, ...):
    try:
        # 1. å‚æ•°éªŒè¯
        if not customer_id:
            raise HTTPException(400, "customer_idä¸èƒ½ä¸ºç©º")

        # 2. æ£€æŸ¥å®¢æˆ·å­˜åœ¨
        customer = customers_collection.find_one({"_id": ObjectId(customer_id)})
        if not customer:
            raise HTTPException(404, f"å®¢æˆ· {customer_id} ä¸å­˜åœ¨")

        # 3. æ£€æŸ¥æ•°æ®å¯ç”¨æ€§
        forecast_count = forecast_user.count_documents({
            "customer_id": customer_id,
            "datetime": {"$gte": start_date, "$lte": end_date}
        })
        if forecast_count == 0:
            raise HTTPException(400, "é¢„æµ‹æ›²çº¿æ— æ•°æ®ï¼Œæ— æ³•æ‰§è¡Œæ ¡æ ¸")

        # 4. æ‰§è¡Œæ ¡æ ¸
        report = validator.validate_curves(...)

        return {"status": "success", "report_id": str(report["_id"])}

    except HTTPException:
        raise
    except Exception as e:
        logger.error(f"æ ¡æ ¸å¤±è´¥: {e}", exc_info=True)
        raise HTTPException(500, "æ ¡æ ¸å¤±è´¥ï¼Œè¯·è”ç³»ç®¡ç†å‘˜")
```

---

## ğŸ“Š å…«ã€æµ‹è¯•è®¡åˆ’

### 8.1 å•å…ƒæµ‹è¯•

```python
# tests/services/test_data_transformation.py

def test_aggregate_96_to_48():
    """æµ‹è¯•96ç‚¹â†’48ç‚¹èšåˆ"""
    service = DataTransformationService()
    points_96 = [100.0, 102.5, 105.0, ...]  # 96ä¸ªç‚¹
    points_48 = service.aggregate_96_to_48(points_96)

    assert len(points_48) == 48
    assert points_48[0] == 2.5  # 102.5 - 100.0

def test_aggregate_to_user_level():
    """æµ‹è¯•ç”¨æˆ·çº§èšåˆ"""
    service = DataTransformationService()
    user_load = service.aggregate_to_user_level(
        customer_id="xxx",
        datetime=datetime(2025, 11, 10, 0, 30)
    )

    assert user_load > 0
    # æ›´å¤šæ–­è¨€...
```

### 8.2 é›†æˆæµ‹è¯•

```python
# tests/integration/test_data_validation_flow.py

def test_full_validation_flow():
    """æµ‹è¯•å®Œæ•´çš„æ•°æ®éªŒè¯æµç¨‹"""

    # 1. å¯¼å…¥æ‰‹å·¥æ•°æ®
    response = client.post("/api/v1/data-validation/transform-manual-data", ...)
    assert response.status_code == 200

    # 2. æ£€æŸ¥æ•°æ®å·²å­˜å…¥é¢„æµ‹æ›²çº¿åº“
    count = forecast_mp.count_documents({...})
    assert count > 0

    # 3. è§¦å‘å®Œæ•´æ€§åˆ†æ
    response = client.post("/api/v1/data-validation/analyze-completeness", ...)
    assert response.status_code == 200

    # 4. æ‰§è¡Œæ ¡æ ¸
    response = client.post("/api/v1/data-validation/validate-curves", ...)
    assert response.status_code == 200

    # 5. éªŒè¯æŠ¥å‘Šå·²ç”Ÿæˆ
    report = quality_report.find_one({...})
    assert report is not None
```

### 8.3 å‰ç«¯æµ‹è¯•

```typescript
// frontend/src/pages/DataQualityPage/__tests__/CompletenessAnalysisTab.test.tsx

describe('CompletenessAnalysisTab', () => {
    it('displays completeness metrics correctly', async () => {
        render(<CompletenessAnalysisTab />);

        // é€‰æ‹©å®¢æˆ·
        const customerSelect = screen.getByLabelText('é€‰æ‹©å®¢æˆ·');
        fireEvent.click(customerSelect);
        fireEvent.click(screen.getByText('æ±Ÿè¥¿çœxxç‰©èµ„å…¬å¸'));

        // ç­‰å¾…æ•°æ®åŠ è½½
        await waitFor(() => {
            expect(screen.getByText('91.5%')).toBeInTheDocument();
        });
    });
});
```

---

## ğŸ“ ä¹ã€ç”¨æˆ·æ‰‹å†Œå¤§çº²

ï¼ˆè¯¦ç»†å†…å®¹å°†åœ¨é˜¶æ®µ4å®Œæˆï¼‰

1. **åŠŸèƒ½æ¦‚è¿°**
   - æ•°æ®å®Œæ•´æ€§åˆ†æ
   - æ•°æ®æ ¡æ ¸
   - æ•°æ®è´¨é‡çœ‹æ¿

2. **æ“ä½œæŒ‡å—**
   - å¦‚ä½•æŸ¥çœ‹æ•°æ®å®Œæ•´æ€§æŠ¥å‘Š
   - å¦‚ä½•æ‰§è¡Œæ•°æ®æ ¡æ ¸
   - å¦‚ä½•åº”ç”¨æ¨èåˆ†é…ç³»æ•°

3. **å¸¸è§é—®é¢˜**
   - ä¸ºä»€ä¹ˆå®Œæ•´åº¦æ˜¾ç¤ºä¸º0ï¼Ÿ
   - å¦‚ä½•å¤„ç†æ•°æ®ç¼ºå¤±ï¼Ÿ
   - æ¨èç³»æ•°å¯ä»¥ç›´æ¥åº”ç”¨å—ï¼Ÿ

4. **æœ€ä½³å®è·µ**
   - å»ºè®®æ¯å‘¨æ‰§è¡Œä¸€æ¬¡æ•°æ®æ ¡æ ¸
   - å®Œæ•´åº¦ä½äº90%åº”åŠæ—¶è¡¥å……æ•°æ®
   - åˆ†é…ç³»æ•°è°ƒæ•´å‰åº”å¤‡ä»½åŸå€¼

---

## ğŸ¯ åã€é¢„æœŸæˆæœ

å®æ–½å®Œæˆåï¼Œç³»ç»Ÿå°†å…·å¤‡ä»¥ä¸‹èƒ½åŠ›ï¼š

1. **æ•°æ®è´¨é‡é€æ˜åŒ–**
   - æ¸…æ™°å±•ç¤ºæ¯ä¸ªå®¢æˆ·çš„æ•°æ®è¦†ç›–èŒƒå›´
   - ä¸»åŠ¨è¯†åˆ«æ•°æ®ç¼ºå¤±
   - é‡åŒ–æ•°æ®å®Œæ•´åº¦

2. **åå·®ç²¾å‡†å®šä½**
   - è®¡ç®—é¢„æµ‹æ›²çº¿ä¸ç»“ç®—æ›²çº¿çš„ç³»ç»Ÿæ€§åå·®
   - è¯†åˆ«æ—¶æ®µæ€§åå·®ç‰¹å¾
   - æ¨èä¼˜åŒ–æ–¹æ¡ˆ

3. **å¥å£®çš„æ•°æ®åŸºç¡€**
   - è´Ÿè·é¢„æµ‹åœ¨T-1æ•°æ®ç¼ºå¤±æ—¶è‡ªåŠ¨å›é€€åˆ°T-2
   - é¢„ç»“ç®—åœ¨RPAæ•°æ®å»¶è¿Ÿæ—¶ä¸´æ—¶ä½¿ç”¨æ‰‹å·¥æ•°æ®
   - é¿å…å› å±€éƒ¨æ•°æ®ç¼ºå¤±å¯¼è‡´åŠŸèƒ½ä¸­æ–­

4. **è¿è¥æ•ˆç‡æå‡**
   - å‡å°‘äººå·¥æ ¸å¯¹æ•°æ®çš„æ—¶é—´æˆæœ¬
   - è‡ªåŠ¨åŒ–çš„æ•°æ®è´¨é‡ç›‘æ§
   - ä¸ºç®¡ç†å†³ç­–æä¾›æ•°æ®æ”¯æŒ

---

**æ€»å·¥æœŸ**ï¼š10-14å¤©
**æŠ€æœ¯é£é™©**ï¼šä¸­
**ä¸šåŠ¡ä»·å€¼**ï¼šé«˜

---

## ğŸ“Œ é™„å½•

### A. ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | ä¿®è®¢å†…å®¹ | ä¿®è®¢äºº |
|------|------|---------|--------|
| 1.0  | 2025-11-12 | åˆå§‹ç‰ˆæœ¬ | Claude |

### B. å¾…è®¨è®ºäº‹é¡¹

1. åˆ†é…ç³»æ•°ä¼˜åŒ–ç®—æ³•çš„é€‰æ‹©ï¼ˆæœ€å°äºŒä¹˜æ³• vs æ¢¯åº¦ä¸‹é™ vs é—ä¼ ç®—æ³•ï¼‰
2. æ•°æ®å®Œæ•´æ€§åˆ†æçš„è§¦å‘æ—¶æœºï¼ˆæ˜¯å¦éœ€è¦å®šæ—¶ä»»åŠ¡è¡¥å……ï¼Ÿï¼‰
3. å†å²æ•°æ®è¿ç§»çš„å…·ä½“æ‰§è¡Œæ—¶é—´å’Œå½±å“èŒƒå›´
4. æ¨èåˆ†é…ç³»æ•°çš„è‡ªåŠ¨åº”ç”¨æƒé™æ§åˆ¶

### C. å‚è€ƒæ–‡æ¡£

- `docs/pages/è´Ÿè·æ•°æ®æ ¡æ ¸/è´Ÿè·æ•°æ®æ ¡éªŒåŠŸèƒ½-ä¸šåŠ¡éœ€æ±‚æ–‡æ¡£.md`
- `docs/todo/è´Ÿè·æ•°æ®å¤„ç†ä¸å±•ç¤ºæŠ€æœ¯è¦ç‚¹.md`
- `docs/å‰ç«¯é¡µé¢è®¾è®¡è§„èŒƒ.md`
- `docs/æŠ€æœ¯æ–¹æ¡ˆä¸ç¼–ç è§„èŒƒ.md`

---

**æ–‡æ¡£ç»“æŸ**
