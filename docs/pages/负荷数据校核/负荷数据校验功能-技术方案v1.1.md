# è´Ÿè·æ•°æ®æ ¡éªŒåŠŸèƒ½ - æŠ€æœ¯æ–¹æ¡ˆ v1.1

**ç‰ˆæœ¬**: 1.1
**æ—¥æœŸ**: 2025-11-12
**çŠ¶æ€**: å¾…è¯„å®¡
**åŸºäº**: ä¸šåŠ¡éœ€æ±‚æ–‡æ¡£v1.1

---

## ğŸ“‹ ç‰ˆæœ¬å˜æ›´è¯´æ˜

### v1.0 â†’ v1.1 ä¸»è¦å˜æ›´

1. **å­˜å‚¨æ¶æ„ç®€åŒ–**ï¼šå»æ‰è®¡é‡ç‚¹çº§æŒä¹…åŒ–é›†åˆï¼Œä»…ä¿ç•™ç”¨æˆ·çº§æ›²çº¿åº“ï¼ˆå‡å°‘50%å­˜å‚¨ï¼‰
2. **æ ¡æ ¸æµç¨‹ä¼˜åŒ–**ï¼šå…ˆç”¨æˆ·çº§å¿«é€Ÿå¯¹æ¯”ï¼Œå†æŒ‰éœ€æ·±å…¥è®¡é‡ç‚¹çº§åˆ†æ
3. **ç¼“å­˜ç­–ç•¥æ˜ç¡®**ï¼šä¸ä½¿ç”¨ç¼“å­˜ï¼Œæ¯æ¬¡å®æ—¶è®¡ç®—ç¡®ä¿æ•°æ®æœ€æ–°
4. **æ ¡æ ¸å‘¨æœŸè°ƒæ•´**ï¼šé»˜è®¤1å¤©ï¼ˆå¯æ‰©å±•ä¸º7å¤©/30å¤©ï¼‰
5. **ç³»æ•°çº¦æŸä¿®æ­£**ï¼šæ¯ç”µè¡¨ä¸‹æ‰€æœ‰è®¡é‡ç‚¹ç³»æ•°å’Œâ‰¤100%
6. **æ¢è¡¨å¤„ç†**ï¼šæä¾›æ‰‹å·¥ä¿®æ­£æ–¹æ¡ˆï¼Œä¸åšè‡ªåŠ¨æ£€æµ‹

---

## ğŸ¯ ä¸€ã€æ ¸å¿ƒä¸šåŠ¡ç†è§£

### 1.1 é—®é¢˜æœ¬è´¨

**èƒŒæ™¯**ï¼š
- æ‰‹å·¥å¯¼å…¥æ•°æ®å’ŒRPAæ•°æ®**åŒæº**ï¼ˆç”µåŠ›äº¤æ˜“ä¸­å¿ƒï¼‰
- RPAæ•°æ®æ˜¯å®˜æ–¹æƒå¨å¤„ç†ï¼ˆç¼ºç‚¹è¡¥å½•ã€æ¢è¡¨ç­‰ï¼‰
- æ‰‹å·¥æ•°æ®çš„**ç”µè¡¨-è®¡é‡ç‚¹åˆ†é…ç³»æ•°æ˜¯è‡ªè¡Œä¼°ç®—çš„**ï¼Œå¯èƒ½ä¸å‡†ç¡®

**ç›®æ ‡**ï¼š
- éªŒè¯å¹¶ä¼˜åŒ–è‡ªå·±è®¡ç®—çš„åˆ†é…ç³»æ•°
- å°è¯¯å·®ï¼ˆå¤„ç†æ–¹æ³•å·®å¼‚ï¼‰å¯å¿½ç•¥
- å¤§è¯¯å·®ï¼ˆåˆ†é…ç³»æ•°ä¸å‡†ï¼‰éœ€å®šä½å’Œä¿®æ­£

### 1.2 æ ¸å¿ƒå†³ç­–

| å†³ç­–ç‚¹ | æ–¹æ¡ˆ | å½±å“ |
|--------|------|------|
| å­˜å‚¨ç²’åº¦ | ç”¨æˆ·çº§ä¸ºä¸»ï¼Œè®¡é‡ç‚¹çº§ä¸´æ—¶è®¡ç®— | â¬‡ï¸ å­˜å‚¨æˆæœ¬50%ï¼Œâ¬†ï¸ æ ¡æ ¸è®¡ç®—æ—¶é—´ |
| ç¼“å­˜ç­–ç•¥ | ä¸ç¼“å­˜ | ç¡®ä¿æ•°æ®æœ€æ–°ï¼Œæ¯æ¬¡é‡æ–°è®¡ç®— |
| æ ¡æ ¸å‘¨æœŸ | 1å¤©ï¼ˆä¸»ï¼‰+ 7å¤©/30å¤©ï¼ˆæ‰©å±•ï¼‰ | å¿«é€Ÿå®šä½é—®é¢˜ |
| ç³»æ•°çº¦æŸ | æ¯ç”µè¡¨â‰¤100%ï¼Œæ¯è®¡é‡ç‚¹0-100% | ç®€åŒ–ä¼˜åŒ–ç®—æ³• |
| æ¢è¡¨å¤„ç† | æ•°æ®åº“æ‰‹å·¥ä¿®æ­£ | æ— éœ€å¼€å‘è‡ªåŠ¨æ£€æµ‹ |

---

## ğŸ—ï¸ äºŒã€æ•°æ®åº“è®¾è®¡

### 2.1 æ–°å¢é›†åˆï¼ˆ2ä¸ªç”¨æˆ·çº§æ›²çº¿åº“ï¼‰

#### A. load_curve_userï¼ˆè´Ÿè·æ›²çº¿åº“-ç”¨æˆ·çº§ï¼‰

**ç”¨é€”**ï¼šå­˜å‚¨æ‰‹å·¥å¯¼å…¥æ•°æ®è½¬æ¢åçš„48ç‚¹ç”¨æˆ·çº§æ›²çº¿

```javascript
{
  _id: ObjectId("..."),
  customer_id: "673f9f87069d137d83be63a6",    // å®¢æˆ·IDï¼ˆå…³è”customersè¡¨ï¼‰
  customer_name: "æ±Ÿè¥¿çœxxç‰©èµ„å…¬å¸",          // å†—ä½™ï¼Œä¾¿äºå±•ç¤º
  datetime: ISODate("2025-11-10T00:30:00Z"),  // æ—¶é—´æˆ³ï¼ˆ30åˆ†é’Ÿé—´éš”ï¼‰
  load_kwh: 853.2,                            // èšåˆè´Ÿè·ï¼ˆkWhï¼‰
  source: "manual_import",                    // æ•°æ®æ¥æºæ ‡è¯†
  created_at: ISODate("2025-11-11T08:00:00Z"),
  import_batch_id: "batch_20251111_080000",

  // å…ƒæ•°æ®ï¼šè®°å½•å‚ä¸èšåˆçš„è®¡é‡ç‚¹ï¼ˆä¾¿äºè¿½æº¯ï¼‰
  aggregation_meta: {
    mp_count: 4,                              // å‚ä¸èšåˆçš„è®¡é‡ç‚¹æ•°é‡
    mp_contributions: [                       // å„è®¡é‡ç‚¹çš„è´¡çŒ®
      {
        mp_id: "211474252",
        meter_id: "3630001492249049029898",
        load_kwh: 200.0,
        allocation_percentage: 65.0
      },
      {
        mp_id: "211474253",
        meter_id: "3630001492249049031259",
        load_kwh: 180.5,
        allocation_percentage: 63.4569
      }
      // ...
    ]
  }
}
```

**ç´¢å¼•**ï¼š
```javascript
{ customer_id: 1, datetime: 1 }  // unique: true, ä¸»æŸ¥è¯¢ç´¢å¼•
{ datetime: 1 }                  // æŒ‰æ—¥æœŸæŸ¥è¯¢
{ created_at: -1 }               // æŒ‰å¯¼å…¥æ—¶é—´æŸ¥è¯¢
{ import_batch_id: 1 }           // æŒ‰æ‰¹æ¬¡æŸ¥è¯¢
```

#### B. settlement_curve_userï¼ˆç»“ç®—æ›²çº¿åº“-ç”¨æˆ·çº§ï¼‰

**ç”¨é€”**ï¼šå­˜å‚¨RPAé‡‡é›†æ•°æ®èšåˆåçš„48ç‚¹ç”¨æˆ·çº§æ›²çº¿

```javascript
{
  _id: ObjectId("..."),
  customer_id: "673f9f87069d137d83be63a6",
  customer_name: "æ±Ÿè¥¿çœxxç‰©èµ„å…¬å¸",
  datetime: ISODate("2025-11-08T00:30:00Z"),  // æ³¨æ„ï¼šRPAæ•°æ®æœ‰T-2å»¶è¿Ÿ
  load_kwh: 860.1,
  source: "rpa_settlement",
  created_at: ISODate("2025-11-10T02:00:00Z"),
  rpa_batch_id: "rpa_20251110_020000",

  aggregation_meta: {
    mp_count: 4,
    mp_contributions: [
      {
        mp_id: "211474252",
        load_kwh: 205.2,
        allocation_percentage: 65.0
      }
      // ...
    ]
  }
}
```

**ç´¢å¼•**ï¼š
```javascript
{ customer_id: 1, datetime: 1 }  // unique: true
{ datetime: 1 }
{ created_at: -1 }
{ rpa_batch_id: 1 }
```

### 2.2 æ–°å¢é›†åˆï¼ˆæ•°æ®è´¨é‡æŠ¥å‘Šï¼‰

#### C. data_quality_reportï¼ˆæ•°æ®è´¨é‡æŠ¥å‘Šï¼‰

**ç”¨é€”**ï¼šå­˜å‚¨æ•°æ®å®Œæ•´æ€§åˆ†æå’Œæ ¡æ ¸åˆ†æçš„ç»“æœ

```javascript
{
  _id: ObjectId("..."),
  customer_id: "673f9f87069d137d83be63a6",
  customer_name: "æ±Ÿè¥¿çœxxç‰©èµ„å…¬å¸",
  report_type: "completeness" | "validation",  // æŠ¥å‘Šç±»å‹
  generated_at: ISODate("2025-11-11T08:00:00Z"),

  // ===== å®Œæ•´æ€§åˆ†æç»“æœï¼ˆæ‰€æœ‰æŠ¥å‘Šéƒ½æœ‰ï¼‰=====
  completeness_analysis: {
    // è´Ÿè·æ›²çº¿åº“
    load_curve: {
      start_date: "2025-09-01",              // ç¬¬ä¸€æ¡æ•°æ®æ—¥æœŸ
      end_date: "2025-11-10",                // æœ€åä¸€æ¡æ•°æ®æ—¥æœŸ
      expected_end_date: "2025-11-11",       // æœŸæœ›æˆªæ­¢æ—¥æœŸï¼ˆT-1ï¼‰
      total_days: 72,                        // æœŸæœ›å¤©æ•°
      actual_days: 65,                       // å®é™…æœ‰æ•°æ®çš„å¤©æ•°
      missing_days: 7,
      missing_dates: [                       // ç¼ºå¤±æ—¥æœŸåˆ—è¡¨
        "2025-09-15",
        "2025-10-03",
        // ...
      ],
      completeness_rate: 90.28               // å®Œæ•´åº¦ï¼ˆ%ï¼‰
    },

    // ç»“ç®—æ›²çº¿åº“
    settlement_curve: {
      start_date: "2025-09-05",
      end_date: "2025-11-08",
      expected_end_date: "2025-11-10",       // æœŸæœ›æˆªæ­¢æ—¥æœŸï¼ˆT-2ï¼‰
      total_days: 67,
      actual_days: 65,
      missing_days: 2,
      missing_dates: [
        "2025-09-20",
        "2025-10-15"
      ],
      completeness_rate: 97.01
    },

    // äº¤é›†åˆ†æ
    overlap_analysis: {
      overlap_start: "2025-09-05",           // ä¸¤æ¡æ›²çº¿éƒ½æœ‰æ•°æ®çš„èµ·å§‹æ—¥æœŸ
      overlap_end: "2025-11-08",
      overlap_days: 65,
      both_available_days: 60,               // ä¸¤æ¡æ›²çº¿éƒ½æœ‰æ•°æ®çš„å¤©æ•°
      overlap_rate: 92.31                    // äº¤é›†å®Œæ•´åº¦
    }
  },

  // ===== æ ¡æ ¸åˆ†æç»“æœï¼ˆä»… validation ç±»å‹ï¼‰=====
  validation_result: {
    analysis_period: {
      start_date: "2025-11-10",              // æ ¡æ ¸æ—¥æœŸ
      end_date: "2025-11-10",                // ï¼ˆ1å¤©ï¼‰
      days: 1
    },

    data_points_compared: 48,                // å‚ä¸å¯¹æ¯”çš„æ•°æ®ç‚¹æ•°é‡

    // ç”¨æˆ·çº§åå·®ç»Ÿè®¡
    user_level_statistics: {
      mean_deviation: -3.2,                  // å¹³å‡åå·®ï¼ˆkWhï¼‰
      mean_deviation_rate: -2.1,             // å¹³å‡åå·®ç‡ï¼ˆ%ï¼‰
      max_positive_deviation: 15.8,
      max_negative_deviation: -12.3,
      rmse: 5.6,                             // å‡æ–¹æ ¹è¯¯å·®
      mae: 4.2,                              // å¹³å‡ç»å¯¹è¯¯å·®
      correlation: 0.985                     // ç›¸å…³ç³»æ•°
    },

    // æ˜¯å¦éœ€è¦æ·±å…¥åˆ†æ
    deep_analysis_required: true,            // |å¹³å‡åå·®ç‡| â‰¥ 5%

    // è®¡é‡ç‚¹çº§åå·®æ˜ç»†ï¼ˆä»…deep_analysis_required=trueæ—¶ï¼‰
    metering_point_analysis: [
      {
        mp_id: "211474252",
        meter_id: "3630001492249049029898",
        current_allocation: 65.0,
        mean_deviation_rate: -5.2,           // è¯¥è®¡é‡ç‚¹çš„åå·®ç‡
        contribution_to_total_deviation: 0.6 // å¯¹æ€»åå·®çš„è´¡çŒ®åº¦
      },
      {
        mp_id: "211474253",
        meter_id: "3630001492249049031259",
        current_allocation: 63.4569,
        mean_deviation_rate: 1.8,
        contribution_to_total_deviation: 0.3
      }
      // ...
    ],

    // æ¨èçš„åˆ†é…ç³»æ•°ä¼˜åŒ–
    allocation_optimization: {
      method: "least_squares",               // ä¼˜åŒ–æ–¹æ³•
      optimization_successful: true,         // æ˜¯å¦æˆåŠŸæ±‚è§£

      recommendations: [
        {
          mp_id: "211474252",
          meter_id: "3630001492249049029898",
          current_percentage: 65.0,
          recommended_percentage: 67.2,
          change: +2.2,
          reason: "è´Ÿè·æ•°æ®ç³»ç»Ÿæ€§åä½"
        },
        {
          mp_id: "211474253",
          meter_id: "3630001492249049031259",
          current_percentage: 63.4569,
          recommended_percentage: 62.1,
          change: -1.3569,
          reason: "è´Ÿè·æ•°æ®ç³»ç»Ÿæ€§åé«˜"
        }
        // ...
      ],

      // éªŒè¯çº¦æŸ
      constraint_validation: [
        {
          meter_id: "3630001492249049029898",
          mp_count: 2,
          current_sum: 90.0,                 // å½“å‰æ€»å’Œ
          recommended_sum: 90.0,             // æ¨èåæ€»å’Œ
          constraint_met: true               // â‰¤100%
        },
        {
          meter_id: "3630001492249049031259",
          mp_count: 2,
          current_sum: 88.4569,
          recommended_sum: 87.1,
          constraint_met: true
        }
      ],

      estimated_improvement: 18.5            // é¢„è®¡åå·®å‡å°‘ï¼ˆ%ï¼‰
    }
  },

  // æŠ¥å‘Šå…ƒæ•°æ®
  metadata: {
    analysis_duration_ms: 850,               // åˆ†æè€—æ—¶
    triggered_by: "manual",                  // "auto_import" | "manual"
    trigger_user: "admin"
  }
}
```

**ç´¢å¼•**ï¼š
```javascript
{ customer_id: 1, generated_at: -1 }
{ customer_id: 1, report_type: 1, generated_at: -1 }
{ report_type: 1, generated_at: -1 }
```

### 2.3 ç°æœ‰é›†åˆä¿æŒä¸å˜

- `user_load_data`ï¼š96ç‚¹åŸå§‹æ‰‹å·¥å¯¼å…¥æ•°æ®ï¼ˆä¸æ”¹ï¼‰
- `mp_load_curve`ï¼š48ç‚¹RPAç»“ç®—æ•°æ®-è®¡é‡ç‚¹çº§ï¼ˆä¸æ”¹ï¼‰
- `customers`ï¼šå®¢æˆ·æ¡£æ¡ˆï¼ˆä¸æ”¹ï¼‰

---

## ğŸ”§ ä¸‰ã€åç«¯APIè®¾è®¡

### 3.1 APIè·¯ç”±ç»“æ„

æ–°å¢è·¯ç”±æ–‡ä»¶ï¼š`webapp/api/v1_data_validation.py`

```python
from fastapi import APIRouter, Depends, HTTPException, Query
from typing import Literal, Optional
from datetime import date

router = APIRouter(prefix="/data-validation", tags=["Data Validation"])
```

### 3.2 æ ¸å¿ƒAPIç«¯ç‚¹

#### A. æ•°æ®è½¬æ¢ä¸å­˜å‚¨

```python
@router.post("/transform-manual-data")
async def transform_manual_data(
    import_batch_id: str = Query(..., description="å¯¼å…¥æ‰¹æ¬¡ID"),
    current_user: dict = Depends(get_current_active_user)
):
    """
    å°†96ç‚¹æ‰‹å·¥å¯¼å…¥æ•°æ®è½¬æ¢ä¸º48ç‚¹å¹¶å­˜å…¥è´Ÿè·æ›²çº¿åº“ï¼ˆç”¨æˆ·çº§ï¼‰

    æµç¨‹ï¼š
    1. ä» user_load_data è¯»å–æŒ‡å®šæ‰¹æ¬¡çš„96ç‚¹æ•°æ®
    2. æŒ‰30åˆ†é’Ÿèšåˆï¼ˆæ¯2ä¸ª15åˆ†é’Ÿç‚¹åˆå¹¶ï¼‰
    3. ç¤ºæ•°è½¬å·®å€¼ï¼ˆç›¸é‚»ç‚¹ç›¸å‡ï¼‰
    4. åº”ç”¨ç”µè¡¨å€ç‡
    5. æŒ‰åˆ†é…ç³»æ•°èšåˆåˆ°ç”¨æˆ·çº§
    6. å­˜å…¥ load_curve_user
    7. è§¦å‘æ•°æ®å®Œæ•´æ€§åˆ†æ

    è¿”å›ï¼š
    {
        "status": "success",
        "processed_customers": 2,
        "user_records_created": 96,  # 2ä¸ªå®¢æˆ· Ã— 48ç‚¹
        "completeness_reports_generated": 2
    }
    """
```

```python
@router.post("/import-rpa-data")
async def import_rpa_data(
    rpa_batch_id: str = Query(...),
    source_collection: str = Query("mp_load_curve"),
    current_user: dict = Depends(get_current_active_user)
):
    """
    å¯¼å…¥RPAæ•°æ®åˆ°ç»“ç®—æ›²çº¿åº“ï¼ˆç”¨æˆ·çº§ï¼‰

    æµç¨‹ï¼š
    1. ä» mp_load_curve è¯»å–RPAæ•°æ®ï¼ˆè®¡é‡ç‚¹çº§ï¼‰
    2. å•ä½è½¬æ¢ï¼ˆMWh â†’ kWhï¼‰
    3. æŒ‰åˆ†é…ç³»æ•°èšåˆåˆ°ç”¨æˆ·çº§
    4. å­˜å…¥ settlement_curve_user
    5. è§¦å‘æ•°æ®å®Œæ•´æ€§åˆ†æ
    """
```

#### B. æ•°æ®å®Œæ•´æ€§åˆ†æ

```python
@router.post("/analyze-completeness")
async def analyze_completeness(
    customer_id: str,
    current_user: dict = Depends(get_current_active_user)
):
    """
    åˆ†ææŒ‡å®šå®¢æˆ·çš„æ•°æ®å®Œæ•´æ€§

    è¿”å›ï¼š
    {
        "report_id": "...",
        "customer_id": "...",
        "load_curve_completeness": 90.28,
        "settlement_curve_completeness": 97.01,
        "overlap_completeness": 92.31
    }
    """
```

```python
@router.get("/completeness-report/{customer_id}")
async def get_completeness_report(
    customer_id: str,
    latest: bool = Query(True),
    current_user: dict = Depends(get_current_active_user)
):
    """è·å–å®Œæ•´æ€§æŠ¥å‘Š"""
```

```python
@router.get("/completeness-dashboard")
async def get_completeness_dashboard(
    min_completeness: float = Query(0.0, ge=0, le=100),
    current_user: dict = Depends(get_current_active_user)
):
    """
    è·å–æ‰€æœ‰å®¢æˆ·çš„æ•°æ®å®Œæ•´æ€§æ¦‚è§ˆ

    è¿”å›ï¼š
    {
        "total_customers": 50,
        "healthy_customers": 45,    # å®Œæ•´åº¦â‰¥90%
        "warning_customers": 3,     # 70%â‰¤å®Œæ•´åº¦<90%
        "critical_customers": 2,    # å®Œæ•´åº¦<70%
        "customers": [...]
    }
    """
```

#### C. æ•°æ®æ ¡æ ¸

```python
@router.post("/validate-curves")
async def validate_curves(
    customer_id: str,
    validation_date: date = Query(..., description="æ ¡æ ¸æ—¥æœŸ"),
    deep_analysis_threshold: float = Query(5.0, description="æ·±å…¥åˆ†æé˜ˆå€¼ï¼ˆ%ï¼‰"),
    optimize_allocation: bool = Query(True),
    current_user: dict = Depends(get_current_active_user)
):
    """
    æ‰§è¡Œæ•°æ®æ ¡æ ¸

    æµç¨‹ï¼š
    1. ç”¨æˆ·çº§å¿«é€Ÿå¯¹æ¯”
    2. å¦‚æœåå·®ç‡ â‰¥ thresholdï¼Œæ‰§è¡Œæ·±å…¥åˆ†æ
    3. ä¸´æ—¶è®¡ç®—è®¡é‡ç‚¹çº§æ•°æ®
    4. æ¨èç³»æ•°ä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰

    è¿”å›ï¼š
    {
        "report_id": "...",
        "deep_analysis_performed": true,
        "optimization_successful": true,
        "mean_deviation_rate": -2.1,
        "estimated_improvement": 18.5
    }
    """
```

```python
@router.get("/validation-report/{customer_id}")
async def get_validation_report(
    customer_id: str,
    latest: bool = Query(True),
    current_user: dict = Depends(get_current_active_user)
):
    """è·å–æ ¡æ ¸æŠ¥å‘Š"""
```

#### D. æ•°æ®æŸ¥è¯¢

```python
@router.get("/curve-data")
async def get_curve_data(
    customer_id: str,
    curve_type: Literal["load", "settlement"],
    start_date: date,
    end_date: date,
    current_user: dict = Depends(get_current_active_user)
):
    """
    æŸ¥è¯¢æ›²çº¿æ•°æ®ï¼ˆç”¨æˆ·çº§ï¼‰

    è¿”å›ï¼š
    {
        "customer_id": "...",
        "curve_type": "load",
        "data": [
            {"datetime": "2025-11-10T00:30:00Z", "load_kwh": 125.5},
            ...
        ]
    }
    """
```

```python
@router.get("/curve-comparison")
async def get_curve_comparison(
    customer_id: str,
    comparison_date: date,
    current_user: dict = Depends(get_current_active_user)
):
    """
    è·å–ä¸¤æ¡æ›²çº¿çš„å¯¹æ¯”æ•°æ®ï¼ˆç”¨äºå‰ç«¯å›¾è¡¨ï¼‰

    è¿”å›ï¼š
    {
        "date": "2025-11-10",
        "time_labels": ["00:30", "01:00", ...],
        "load_curve": [120.5, 118.2, ...],      // 48ç‚¹
        "settlement_curve": [123.2, 120.1, ...],
        "deviation": [-2.7, -1.9, ...],
        "deviation_rate": [-2.2, -1.6, ...]
    }
    """
```

#### E. æ•°æ®å€Ÿç”¨æœåŠ¡

```python
@router.get("/load-data-with-fallback")
async def get_load_data_with_fallback(
    customer_id: str,
    target_date: date,
    preferred_source: Literal["load", "settlement"] = Query("load"),
    current_user: dict = Depends(get_current_active_user)
):
    """
    æ™ºèƒ½æ•°æ®å€Ÿç”¨ï¼ˆå†…éƒ¨APIï¼Œä¾›è´Ÿè·é¢„æµ‹ç­‰æ¨¡å—è°ƒç”¨ï¼‰

    é€»è¾‘ï¼š
    1. å¦‚æœ preferred_source="load":
       - å…ˆæŸ¥ load_curve_user
       - æ— æ•°æ®åˆ™æŸ¥ settlement_curve_user
    2. å¦‚æœ preferred_source="settlement":
       - å…ˆæŸ¥ settlement_curve_user
       - æ— æ•°æ®åˆ™æŸ¥ load_curve_user

    è¿”å›ï¼š
    {
        "data": [...],  // 48ç‚¹æ•°æ®
        "source": "load" | "settlement",
        "mode": "primary" | "fallback" | null,
        "available": true | false,
        "message": "ä½¿ç”¨è´Ÿè·æ›²çº¿æ•°æ®" | "æ•°æ®ä¸è¶³"
    }
    """
```

---

## ğŸ”„ å››ã€æ•°æ®å¤„ç†æµç¨‹

### 4.1 æµç¨‹Aï¼šæ‰‹å·¥æ•°æ®å¯¼å…¥ä¸è½¬æ¢

```
[ç”¨æˆ·ä¸Šä¼ Excel]
    â†“
[1] è§£æ96ç‚¹ç”µè¡¨ç¤ºæ•°æ•°æ®
    â†“
[2] ä¿å­˜åŸå§‹æ•°æ®åˆ° user_load_data
    â†“
[3] æ•°æ®è½¬æ¢æœåŠ¡ (DataTransformationService)
    â”œâ”€ 3.1 èšåˆï¼šæ¯2ä¸ª15åˆ†é’Ÿç‚¹åˆå¹¶ä¸º1ä¸ª30åˆ†é’Ÿç‚¹
    â”‚   points_48[i] = (points_96[2*i] + points_96[2*i+1]) / 2
    â”‚
    â”œâ”€ 3.2 ç¤ºæ•°è½¬å·®å€¼ï¼šç›¸é‚»ç‚¹ç›¸å‡å¾—åˆ°æ—¶æ®µç”¨ç”µé‡
    â”‚   load[i] = reading[i+1] - reading[i]
    â”‚
    â”œâ”€ 3.3 åº”ç”¨ç”µè¡¨å€ç‡
    â”‚   load[i] = load[i] * multiplier
    â”‚
    â””â”€ 3.4 ç”¨æˆ·çº§èšåˆ
        â”œâ”€ æŸ¥è¯¢å®¢æˆ·æ¡£æ¡ˆï¼Œè·å–æ‰€æœ‰è®¡é‡ç‚¹å’Œåˆ†é…ç³»æ•°
        â”œâ”€ è®¡ç®—ï¼šuser_load = Î£(mp_load Ã— allocation% / 100)
        â””â”€ å­˜å…¥ load_curve_userï¼ˆå¸¦aggregation_metaå…ƒæ•°æ®ï¼‰
    â†“
[4] è§¦å‘æ•°æ®å®Œæ•´æ€§åˆ†æ
    â”œâ”€ åˆ†æè´Ÿè·æ›²çº¿åº“çš„è¦†ç›–èŒƒå›´
    â”œâ”€ åˆ†æç»“ç®—æ›²çº¿åº“çš„è¦†ç›–èŒƒå›´
    â”œâ”€ è®¡ç®—äº¤é›†åˆ†æ
    â””â”€ ç”ŸæˆæŠ¥å‘Šå­˜å…¥ data_quality_report
    â†“
[å®Œæˆ]
```

**å…³é”®ä»£ç **ï¼š

```python
# æ­¥éª¤3.1ï¼š96ç‚¹â†’48ç‚¹èšåˆ
def aggregate_96_to_48(points_96: List[float]) -> List[float]:
    """æ¯2ä¸ª15åˆ†é’Ÿç‚¹åˆå¹¶ä¸º1ä¸ª30åˆ†é’Ÿç‚¹"""
    points_48 = []
    for i in range(0, 96, 2):
        avg_reading = (points_96[i] + points_96[i+1]) / 2
        points_48.append(avg_reading)
    return points_48

# æ­¥éª¤3.2ï¼šç¤ºæ•°è½¬å·®å€¼
def reading_to_load(readings: List[float]) -> List[float]:
    """ç›¸é‚»ç‚¹ç›¸å‡å¾—åˆ°ç”¨ç”µé‡"""
    loads = []
    for i in range(len(readings) - 1):
        load = readings[i+1] - readings[i]
        loads.append(max(0, load))  # è´Ÿå€¼å¤„ç†
    return loads

# æ­¥éª¤3.4ï¼šç”¨æˆ·çº§èšåˆ
def aggregate_to_user_level(customer_id: str, datetime: datetime) -> float:
    """æŒ‰åˆ†é…ç³»æ•°èšåˆåˆ°ç”¨æˆ·çº§"""
    # 1. æŸ¥è¯¢å®¢æˆ·æ¡£æ¡ˆ
    customer = customers_collection.find_one({"_id": ObjectId(customer_id)})

    # 2. æå–æ‰€æœ‰è®¡é‡ç‚¹å’Œåˆ†é…ç³»æ•°
    mp_allocations = []
    for account in customer["utility_accounts"]:
        for mp in account["metering_points"]:
            mp_allocations.append({
                "mp_id": mp["metering_point_id"],
                "meter_id": mp["meter"]["meter_id"],
                "percentage": mp["allocation_percentage"],
                "multiplier": mp["meter"]["multiplier"]
            })

    # 3. ä¸´æ—¶è®¡ç®—å„è®¡é‡ç‚¹çš„è´Ÿè·ï¼ˆä»user_load_dataï¼‰
    total_load = 0.0
    contributions = []

    for mp_alloc in mp_allocations:
        # æŸ¥è¯¢è¯¥ç”µè¡¨è¯¥æ—¶é—´çš„96ç‚¹ç¤ºæ•°æ•°æ®
        meter_data = user_load_data.find({
            "meter_id": mp_alloc["meter_id"],
            "timestamp": {"$gte": date_start, "$lte": date_end}
        }).sort("timestamp", 1)

        # è½¬æ¢ï¼š96ç‚¹ç¤ºæ•° â†’ 48ç‚¹ç”µé‡
        points_96 = [doc["load_value"] for doc in meter_data]
        points_48_readings = aggregate_96_to_48(points_96)
        points_48_loads = reading_to_load(points_48_readings)

        # åº”ç”¨å€ç‡å’Œåˆ†é…ç³»æ•°
        mp_load = points_48_loads[time_index] * mp_alloc["multiplier"] * mp_alloc["percentage"] / 100
        total_load += mp_load

        contributions.append({
            "mp_id": mp_alloc["mp_id"],
            "meter_id": mp_alloc["meter_id"],
            "load_kwh": mp_load,
            "allocation_percentage": mp_alloc["percentage"]
        })

    return total_load, contributions
```

### 4.2 æµç¨‹Bï¼šRPAæ•°æ®å¯¼å…¥

```
[RPAçˆ¬å–]
    â†“
[1] åŸå§‹æ•°æ®å­˜å…¥ mp_load_curveï¼ˆ48ç‚¹ï¼ŒMWhï¼Œè®¡é‡ç‚¹çº§ï¼‰
    â†“
[2] æ•°æ®è½¬æ¢æœåŠ¡
    â”œâ”€ 2.1 å•ä½è½¬æ¢ï¼šMWh â†’ kWh (Ã—1000)
    â””â”€ 2.2 ç”¨æˆ·çº§èšåˆ
        â”œâ”€ æŸ¥è¯¢å®¢æˆ·æ¡£æ¡ˆï¼Œè·å–åˆ†é…ç³»æ•°
        â”œâ”€ è®¡ç®—ï¼šuser_load = Î£(mp_load Ã— allocation% / 100)
        â””â”€ å­˜å…¥ settlement_curve_userï¼ˆå¸¦aggregation_metaï¼‰
    â†“
[3] è§¦å‘æ•°æ®å®Œæ•´æ€§åˆ†æ
    â†“
[å®Œæˆ]
```

### 4.3 æµç¨‹Cï¼šæ•°æ®æ ¡æ ¸ï¼ˆæ‰‹åŠ¨ï¼‰

```
[ç”¨æˆ·é€‰æ‹©å®¢æˆ· + æ—¥æœŸ]
    â†“
[Step 1: ç”¨æˆ·çº§å¿«é€Ÿå¯¹æ¯”]
    â”œâ”€ æŸ¥è¯¢ load_curve_user[é€‰å®šæ—¥æœŸ] â†’ 48ç‚¹æ•°æ®L
    â”œâ”€ æŸ¥è¯¢ settlement_curve_user[é€‰å®šæ—¥æœŸ] â†’ 48ç‚¹æ•°æ®S
    â”œâ”€ è®¡ç®—åå·®ï¼šdeviation = L - S
    â”œâ”€ è®¡ç®—åå·®ç‡ï¼šdeviation_rate = (deviation / S) Ã— 100
    â”œâ”€ ç»Ÿè®¡æŒ‡æ ‡ï¼š
    â”‚   - mean_deviation_rate = mean(deviation_rate)
    â”‚   - rmse = sqrt(mean(deviationÂ²))
    â”‚   - correlation = corr(L, S)
    â””â”€ åˆ¤æ–­ï¼š|mean_deviation_rate| â‰¥ thresholdï¼ˆå¦‚5%ï¼‰ï¼Ÿ
        â”œâ”€ å¦ â†’ åå·®å°ï¼Œç³»æ•°å¯èƒ½åˆç†ï¼Œç”Ÿæˆç®€å•æŠ¥å‘Šï¼Œç»“æŸ
        â””â”€ æ˜¯ â†’ è¿›å…¥Step 2
    â†“
[Step 2: è®¡é‡ç‚¹çº§æ·±å…¥åˆ†æ]
    â”œâ”€ ä¸´æ—¶è®¡ç®—è®¡é‡ç‚¹çº§è´Ÿè·æ•°æ®ï¼ˆfrom user_load_dataï¼‰
    â”‚   â””â”€ å¯¹äºæ¯ä¸ªè®¡é‡ç‚¹ï¼š96ç‚¹ç¤ºæ•° â†’ 48ç‚¹ç”µé‡
    â”œâ”€ æŸ¥è¯¢ mp_load_curve[é€‰å®šæ—¥æœŸ] â†’ è®¡é‡ç‚¹çº§RPAæ•°æ®
    â”œâ”€ é€è®¡é‡ç‚¹å¯¹æ¯”ï¼š
    â”‚   - mp_deviation_rate[mp_i] = mean((mp_load[mp_i] - mp_settlement[mp_i]) / mp_settlement[mp_i])
    â”‚   - contribution_to_total[mp_i] = è¯¥è®¡é‡ç‚¹å¯¹æ€»åå·®çš„è´¡çŒ®åº¦
    â””â”€ è¯†åˆ«ï¼šå“ªäº›è®¡é‡ç‚¹åå·®å¤§
    â†“
[Step 3: åˆ†é…ç³»æ•°ä¼˜åŒ–]ï¼ˆå¦‚æœç”¨æˆ·å¯ç”¨ï¼‰
    â”œâ”€ æ„å»ºä¼˜åŒ–é—®é¢˜ï¼š
    â”‚   ç›®æ ‡ï¼šmin Î£((predicted_user_load - actual_settlement_load)Â²)
    â”‚   å˜é‡ï¼šallocations = [alloc_1, alloc_2, ..., alloc_n]
    â”‚   çº¦æŸï¼š
    â”‚     - æ¯ä¸ªè®¡é‡ç‚¹ï¼š0 â‰¤ alloc_i â‰¤ 100
    â”‚     - æ¯ä¸ªç”µè¡¨ï¼šÎ£(alloc for mps on same meter) â‰¤ 100
    â”‚
    â”œâ”€ æ±‚è§£ï¼ˆscipy.optimize.minimize, SLSQPæ–¹æ³•ï¼‰
    â”‚
    â””â”€ è¿”å›æ¨èç³»æ•° + é¢„è®¡æ”¹è¿›å¹…åº¦
    â†“
[Step 4: ç”ŸæˆæŠ¥å‘Š]
    â”œâ”€ ç”¨æˆ·çº§ç»Ÿè®¡
    â”œâ”€ è®¡é‡ç‚¹çº§æ˜ç»†ï¼ˆå¦‚æœæ‰§è¡Œäº†Step 2ï¼‰
    â”œâ”€ æ¨èç³»æ•°ï¼ˆå¦‚æœæ‰§è¡Œäº†Step 3ï¼‰
    â””â”€ ä¿å­˜åˆ° data_quality_report (report_type="validation")
    â†“
[å®Œæˆ]
```

**å…³é”®ç®—æ³•**ï¼š

```python
# åˆ†é…ç³»æ•°ä¼˜åŒ–
import numpy as np
from scipy.optimize import minimize

def optimize_allocation_coefficients(
    customer_id: str,
    validation_date: date
):
    """ä¼˜åŒ–åˆ†é…ç³»æ•°"""

    # 1. æ•°æ®å‡†å¤‡
    # è®¡é‡ç‚¹çº§è´Ÿè·æ•°æ®ï¼ˆä¸´æ—¶è®¡ç®—ï¼‰
    mp_loads = calculate_mp_loads(customer_id, validation_date)  # shape: (48, n_mp)

    # è®¡é‡ç‚¹çº§ç»“ç®—æ•°æ®ï¼ˆRPAï¼‰
    mp_settlements = fetch_mp_settlements(customer_id, validation_date)  # shape: (48, n_mp)

    # ç”¨æˆ·çº§ç»“ç®—æ•°æ®ï¼ˆæƒå¨åŸºå‡†ï¼‰
    user_settlement = fetch_user_settlement(customer_id, validation_date)  # shape: (48,)

    # å½“å‰åˆ†é…ç³»æ•°
    current_allocations = get_current_allocations(customer_id)  # shape: (n_mp,)

    # 2. ä¼˜åŒ–ç›®æ ‡å‡½æ•°
    def objective(allocations):
        """æœ€å°åŒ–ç”¨æˆ·çº§åå·®çš„å¹³æ–¹å’Œ"""
        predicted_user_load = np.sum(
            mp_loads * allocations.reshape(1, -1) / 100,
            axis=1
        )  # shape: (48,)

        deviation = predicted_user_load - user_settlement
        return np.sum(deviation ** 2)

    # 3. çº¦æŸæ¡ä»¶
    constraints = []

    # çº¦æŸ1ï¼šæ¯ä¸ªç”µè¡¨ä¸‹çš„è®¡é‡ç‚¹ç³»æ•°å’Œ â‰¤ 100
    meter_mp_map = get_meter_mp_map(customer_id)
    for meter_id, mp_indices in meter_mp_map.items():
        constraints.append({
            'type': 'ineq',
            'fun': lambda x, idx=mp_indices: 100 - np.sum(x[idx])
        })

    # 4. è¾¹ç•Œï¼š0 â‰¤ alloc â‰¤ 100
    bounds = [(0, 100) for _ in range(len(current_allocations))]

    # 5. æ±‚è§£
    result = minimize(
        objective,
        current_allocations,
        method='SLSQP',
        bounds=bounds,
        constraints=constraints
    )

    if not result.success:
        return {"optimization_successful": False}

    # 6. ç”Ÿæˆæ¨è
    optimized_allocations = result.x
    recommendations = []

    for i, mp_info in enumerate(get_mp_info(customer_id)):
        recommendations.append({
            "mp_id": mp_info["mp_id"],
            "meter_id": mp_info["meter_id"],
            "current_percentage": current_allocations[i],
            "recommended_percentage": optimized_allocations[i],
            "change": optimized_allocations[i] - current_allocations[i]
        })

    # 7. éªŒè¯çº¦æŸ
    constraint_validation = []
    for meter_id, mp_indices in meter_mp_map.items():
        current_sum = np.sum(current_allocations[mp_indices])
        recommended_sum = np.sum(optimized_allocations[mp_indices])

        constraint_validation.append({
            "meter_id": meter_id,
            "current_sum": current_sum,
            "recommended_sum": recommended_sum,
            "constraint_met": recommended_sum <= 100
        })

    # 8. è®¡ç®—æ”¹è¿›å¹…åº¦
    current_error = objective(current_allocations)
    optimized_error = objective(optimized_allocations)
    improvement = (1 - optimized_error / current_error) * 100

    return {
        "optimization_successful": True,
        "recommendations": recommendations,
        "constraint_validation": constraint_validation,
        "estimated_improvement": improvement
    }
```

### 4.4 æµç¨‹Dï¼šè´Ÿè·é¢„æµ‹æ•°æ®å€Ÿç”¨

```
[è´Ÿè·é¢„æµ‹æ¨¡å—è¯·æ±‚æ•°æ®]
    â†“
[è°ƒç”¨ /load-data-with-fallback API]
    customer_id="xxx"
    target_date="2025-11-10"
    preferred_source="load"
    â†“
[1] æŸ¥è¯¢ load_curve_user[2025-11-10]
    â”œâ”€ æœ‰48ç‚¹å®Œæ•´æ•°æ® â†’ è¿”å› {data, source="load", mode="primary"}
    â””â”€ æ— æ•°æ®æˆ–ä¸å®Œæ•´ â†’ è¿›å…¥æ­¥éª¤2
    â†“
[2] æŸ¥è¯¢ settlement_curve_user[2025-11-10æˆ–2025-11-09]
    â”œâ”€ æœ‰æ•°æ® â†’ è¿”å› {data, source="settlement", mode="fallback"}
    â””â”€ æ— æ•°æ® â†’ è¿›å…¥æ­¥éª¤3
    â†“
[3] éƒ½æ— æ•°æ®
    â””â”€ è¿”å› {data=null, available=false, message="æ•°æ®ä¸è¶³"}
    â†“
[è´Ÿè·é¢„æµ‹æ¨¡å—å¤„ç†]
    â”œâ”€ mode="primary" â†’ æ‰§è¡Œæ¨¡å¼Aï¼ˆé«˜ç²¾åº¦é¢„æµ‹ï¼‰
    â”œâ”€ mode="fallback" â†’ æ‰§è¡Œæ¨¡å¼Bï¼ˆå¤‡ç”¨é¢„æµ‹ï¼‰
    â””â”€ available=false â†’ è·³è¿‡é¢„æµ‹ï¼Œæ ‡è®°"æ•°æ®ä¸è¶³"
    â†“
[å®Œæˆ]
```

**é‡è¦**ï¼šå€Ÿç”¨çš„æ•°æ®ä»…åœ¨å†…å­˜ä¸­ä½¿ç”¨ï¼Œä¸æŒä¹…åŒ–

---

## ğŸ¨ äº”ã€å‰ç«¯é¡µé¢è®¾è®¡

### 5.1 é¡µé¢ç»“æ„

**æ–°å¢é¡µé¢**ï¼š`frontend/src/pages/DataQualityPage.tsx`

**è·¯ç”±**ï¼š`/data-quality`

**Tabç»“æ„**ï¼š
```typescript
<Tabs>
    <Tab label="æ•°æ®å®Œæ•´æ€§åˆ†æ" />
    <Tab label="æ•°æ®æ ¡æ ¸" />
    <Tab label="æ•°æ®è´¨é‡çœ‹æ¿" />
</Tabs>
```

### 5.2 Tab 1: æ•°æ®å®Œæ•´æ€§åˆ†æ

**æ ¸å¿ƒç»„ä»¶**ï¼š
1. å®¢æˆ·é€‰æ‹©å™¨ï¼ˆAutocompleteï¼‰
2. å®Œæ•´åº¦æŒ‡æ ‡å¡ç‰‡ï¼ˆ4ä¸ªï¼‰
3. æ•°æ®æ—¶é—´çº¿å¯è§†åŒ–ï¼ˆç”˜ç‰¹å›¾ï¼‰
4. ç¼ºå¤±æ—¥æœŸè¯¦æƒ…è¡¨

**å…³é”®UI**ï¼š

```typescript
// å®Œæ•´åº¦æŒ‡æ ‡å¡ç‰‡
<Grid container spacing={2}>
    <Grid size={{ xs: 12, sm: 6, md: 3 }}>
        <MetricCard
            title="è´Ÿè·æ›²çº¿å®Œæ•´åº¦"
            value="90.3%"
            status="success"  // â‰¥90%
        />
    </Grid>
    <Grid size={{ xs: 12, sm: 6, md: 3 }}>
        <MetricCard
            title="ç»“ç®—æ›²çº¿å®Œæ•´åº¦"
            value="97.0%"
            status="success"
        />
    </Grid>
    <Grid size={{ xs: 12, sm: 6, md: 3 }}>
        <MetricCard
            title="äº¤é›†å®Œæ•´åº¦"
            value="92.3%"
            status="success"
        />
    </Grid>
    <Grid size={{ xs: 12, sm: 6, md: 3 }}>
        <MetricCard
            title="ç¼ºå¤±å¤©æ•°"
            value="7å¤©"
            status="warning"
        />
    </Grid>
</Grid>
```

### 5.3 Tab 2: æ•°æ®æ ¡æ ¸

**æ ¸å¿ƒç»„ä»¶**ï¼š
1. æ ¡æ ¸å‚æ•°è®¾ç½®ï¼ˆå®¢æˆ·ã€æ—¥æœŸã€é˜ˆå€¼ï¼‰
2. æ‰§è¡Œæ ¡æ ¸æŒ‰é’®
3. ç”¨æˆ·çº§åå·®ç»Ÿè®¡å¡ç‰‡ï¼ˆ6ä¸ªæŒ‡æ ‡ï¼‰
4. æ›²çº¿å¯¹æ¯”å›¾è¡¨ï¼ˆLine Chartï¼‰
5. è®¡é‡ç‚¹çº§åå·®è¡¨ï¼ˆæ¡ä»¶æ˜¾ç¤ºï¼‰
6. æ¨èåˆ†é…ç³»æ•°è¡¨ï¼ˆæ¡ä»¶æ˜¾ç¤ºï¼‰

**å…³é”®UI**ï¼š

```typescript
// æ ¡æ ¸å‚æ•°
<Paper variant="outlined" sx={{ p: 2 }}>
    <Grid container spacing={2} alignItems="center">
        <Grid size={{ xs: 12, md: 4 }}>
            <Autocomplete
                options={customers}
                renderInput={(params) => <TextField {...params} label="é€‰æ‹©å®¢æˆ·" />}
                onChange={(e, v) => setSelectedCustomer(v)}
            />
        </Grid>
        <Grid size={{ xs: 12, sm: 6, md: 3 }}>
            <DatePicker
                label="æ ¡æ ¸æ—¥æœŸ"
                value={validationDate}
                onChange={setValidationDate}
            />
        </Grid>
        <Grid size={{ xs: 12, sm: 6, md: 3 }}>
            <TextField
                label="æ·±å…¥åˆ†æé˜ˆå€¼ï¼ˆ%ï¼‰"
                type="number"
                value={threshold}
                onChange={(e) => setThreshold(e.target.value)}
            />
        </Grid>
        <Grid size={{ xs: 12, md: 2 }}>
            <Button
                variant="contained"
                fullWidth
                onClick={handleValidate}
                disabled={loading}
            >
                æ‰§è¡Œæ ¡æ ¸
            </Button>
        </Grid>
    </Grid>
</Paper>

// åå·®ç»Ÿè®¡å¡ç‰‡
<Grid container spacing={2} sx={{ mt: 2 }}>
    <Grid size={{ xs: 12, sm: 6, md: 4 }}>
        <StatCard title="å¹³å‡åå·®" value="-3.2 kWh" />
    </Grid>
    <Grid size={{ xs: 12, sm: 6, md: 4 }}>
        <StatCard
            title="å¹³å‡åå·®ç‡"
            value="-2.1%"
            color={Math.abs(-2.1) < 5 ? "success" : "warning"}
        />
    </Grid>
    <Grid size={{ xs: 12, sm: 6, md: 4 }}>
        <StatCard title="ç›¸å…³ç³»æ•°" value="0.985" />
    </Grid>
    // ...
</Grid>

// æ›²çº¿å¯¹æ¯”å›¾è¡¨
<Paper variant="outlined" sx={{ p: 2, mt: 2 }}>
    <Typography variant="h6">æ›²çº¿å¯¹æ¯”ï¼ˆ{validationDate}ï¼‰</Typography>
    <ResponsiveContainer width="100%" height={400}>
        <LineChart data={comparisonData}>
            <CartesianGrid strokeDasharray="3 3" />
            <XAxis dataKey="time" tickFormatter={formatTime} />
            <YAxis label={{ value: 'è´Ÿè· (kWh)', angle: -90 }} />
            <Tooltip />
            <Legend />
            <Line dataKey="load" stroke="#4caf50" name="è´Ÿè·æ›²çº¿" />
            <Line dataKey="settlement" stroke="#2196f3" name="ç»“ç®—æ›²çº¿" />
            <Line dataKey="deviation" stroke="#ff9800" name="åå·®" strokeDasharray="5 5" />
        </LineChart>
    </ResponsiveContainer>
</Paper>

// æ¨èåˆ†é…ç³»æ•°ï¼ˆæ¡ä»¶æ˜¾ç¤ºï¼‰
{validationReport?.validation_result?.allocation_optimization && (
    <Paper variant="outlined" sx={{ p: 2, mt: 2 }}>
        <Typography variant="h6">æ¨èåˆ†é…ç³»æ•°ä¼˜åŒ–</Typography>
        <Alert severity="info" sx={{ mt: 1 }}>
            é¢„è®¡å¯å°†åå·®å‡å°‘ {validationReport.validation_result.allocation_optimization.estimated_improvement.toFixed(1)}%
        </Alert>
        <TableContainer sx={{ mt: 2 }}>
            <Table>
                <TableHead>
                    <TableRow>
                        <TableCell>è®¡é‡ç‚¹ID</TableCell>
                        <TableCell>ç”µè¡¨ID</TableCell>
                        <TableCell align="right">å½“å‰ç³»æ•°</TableCell>
                        <TableCell align="right">æ¨èç³»æ•°</TableCell>
                        <TableCell align="right">å˜åŒ–</TableCell>
                    </TableRow>
                </TableHead>
                <TableBody>
                    {validationReport.validation_result.allocation_optimization.recommendations.map((rec) => (
                        <TableRow key={rec.mp_id}>
                            <TableCell>{rec.mp_id}</TableCell>
                            <TableCell>{rec.meter_id.slice(-8)}</TableCell>
                            <TableCell align="right">{rec.current_percentage.toFixed(2)}%</TableCell>
                            <TableCell align="right">{rec.recommended_percentage.toFixed(2)}%</TableCell>
                            <TableCell align="right">
                                <Chip
                                    label={`${rec.change >= 0 ? '+' : ''}${rec.change.toFixed(2)}%`}
                                    color={rec.change >= 0 ? "success" : "warning"}
                                    size="small"
                                />
                            </TableCell>
                        </TableRow>
                    ))}
                </TableBody>
            </Table>
        </TableContainer>
    </Paper>
)}
```

### 5.4 Tab 3: æ•°æ®è´¨é‡çœ‹æ¿

**æ ¸å¿ƒç»„ä»¶**ï¼š
1. å…¨å±€ç»Ÿè®¡å¡ç‰‡ï¼ˆ4ä¸ªï¼‰
2. å®¢æˆ·æ•°æ®è´¨é‡åˆ—è¡¨ï¼ˆTableï¼‰
3. æœç´¢å’Œåˆ·æ–°åŠŸèƒ½

**å…³é”®UI**ï¼š

```typescript
// å…¨å±€ç»Ÿè®¡
<Grid container spacing={2}>
    <Grid size={{ xs: 12, sm: 6, md: 3 }}>
        <MetricCard title="æ€»å®¢æˆ·æ•°" value="50" />
    </Grid>
    <Grid size={{ xs: 12, sm: 6, md: 3 }}>
        <MetricCard
            title="å¥åº·å®¢æˆ·"
            value="45"
            subtitle="å®Œæ•´åº¦â‰¥90%"
            color="success"
        />
    </Grid>
    <Grid size={{ xs: 12, sm: 6, md: 3 }}>
        <MetricCard
            title="è­¦å‘Šå®¢æˆ·"
            value="3"
            subtitle="70%â‰¤å®Œæ•´åº¦<90%"
            color="warning"
        />
    </Grid>
    <Grid size={{ xs: 12, sm: 6, md: 3 }}>
        <MetricCard
            title="ä¸¥é‡å®¢æˆ·"
            value="2"
            subtitle="å®Œæ•´åº¦<70%"
            color="error"
        />
    </Grid>
</Grid>

// å®¢æˆ·åˆ—è¡¨
<TableContainer component={Paper} sx={{ mt: 2 }}>
    <Table>
        <TableHead>
            <TableRow>
                <TableCell>å®¢æˆ·åç§°</TableCell>
                <TableCell align="center">è´Ÿè·æ›²çº¿å®Œæ•´åº¦</TableCell>
                <TableCell align="center">ç»“ç®—æ›²çº¿å®Œæ•´åº¦</TableCell>
                <TableCell align="center">æœ€åæ›´æ–°</TableCell>
                <TableCell align="center">æ“ä½œ</TableCell>
            </TableRow>
        </TableHead>
        <TableBody>
            {customers.map((customer) => (
                <TableRow key={customer.id}>
                    <TableCell>{customer.name}</TableCell>
                    <TableCell align="center">
                        <CompletenessChip value={customer.load_completeness} />
                    </TableCell>
                    <TableCell align="center">
                        <CompletenessChip value={customer.settlement_completeness} />
                    </TableCell>
                    <TableCell align="center">
                        {formatDateTime(customer.last_update)}
                    </TableCell>
                    <TableCell align="center">
                        <IconButton size="small" onClick={() => handleView(customer.id)}>
                            <VisibilityIcon />
                        </IconButton>
                        <IconButton size="small" onClick={() => handleRefresh(customer.id)}>
                            <RefreshIcon />
                        </IconButton>
                    </TableCell>
                </TableRow>
            ))}
        </TableBody>
    </Table>
</TableContainer>

// CompletenessChipç»„ä»¶
const CompletenessChip: React.FC<{ value: number }> = ({ value }) => {
    const getColor = () => {
        if (value >= 90) return 'success';
        if (value >= 70) return 'warning';
        return 'error';
    };

    return (
        <Chip
            label={`${value.toFixed(1)}%`}
            color={getColor()}
            size="small"
        />
    );
};
```

---

## ğŸ“… å…­ã€å®æ–½æ­¥éª¤ï¼ˆ10-12å¤©ï¼‰

### é˜¶æ®µ1ï¼šæ•°æ®åŸºç¡€è®¾æ–½ï¼ˆ3å¤©ï¼‰

**Day 1ï¼šæ•°æ®åº“è®¾è®¡**
- åˆ›å»º2ä¸ªç”¨æˆ·çº§æ›²çº¿é›†åˆ
- åˆ›å»ºæ•°æ®è´¨é‡æŠ¥å‘Šé›†åˆ
- åˆ›å»ºç´¢å¼•

**Day 2-3ï¼šæ•°æ®è½¬æ¢æœåŠ¡**
- å®ç°96ç‚¹â†’48ç‚¹è½¬æ¢
- å®ç°ç”¨æˆ·çº§èšåˆ
- ç¼–å†™å•å…ƒæµ‹è¯•

### é˜¶æ®µ2ï¼šæ•°æ®å®Œæ•´æ€§åˆ†æï¼ˆ2-3å¤©ï¼‰

**Day 4-5ï¼šå®Œæ•´æ€§åˆ†æç®—æ³•**
- å®ç°æ•°æ®è¦†ç›–èŒƒå›´åˆ†æ
- å®ç°ç¼ºå¤±æ—¥æœŸæ£€æµ‹
- å®ç°äº¤é›†åˆ†æ

**Day 6ï¼šAPIä¸å‰ç«¯Tab1**
- å®Œæ•´æ€§åˆ†æAPI
- å‰ç«¯æ•°æ®å®Œæ•´æ€§åˆ†æTab

### é˜¶æ®µ3ï¼šæ•°æ®æ ¡æ ¸åŠŸèƒ½ï¼ˆ4-5å¤©ï¼‰

**Day 7ï¼šç”¨æˆ·çº§æ ¡æ ¸ç®—æ³•**
- å®ç°åå·®è®¡ç®—
- å®ç°ç»Ÿè®¡æŒ‡æ ‡

**Day 8ï¼šè®¡é‡ç‚¹çº§æ·±å…¥åˆ†æ**
- ä¸´æ—¶è®¡ç®—è®¡é‡ç‚¹æ•°æ®
- å®ç°é€è®¡é‡ç‚¹å¯¹æ¯”

**Day 9ï¼šåˆ†é…ç³»æ•°ä¼˜åŒ–**
- å®ç°æœ€å°äºŒä¹˜æ³•ä¼˜åŒ–
- å®ç°çº¦æŸæ¡ä»¶å¤„ç†

**Day 10-11ï¼šAPIä¸å‰ç«¯Tab2**
- æ ¡æ ¸APIç«¯ç‚¹
- å‰ç«¯æ•°æ®æ ¡æ ¸Tab

### é˜¶æ®µ4ï¼šé›†æˆä¸æµ‹è¯•ï¼ˆ2å¤©ï¼‰

**Day 12ï¼šæ•°æ®å€Ÿç”¨ä¸çœ‹æ¿**
- æ•°æ®å€Ÿç”¨API
- å‰ç«¯æ•°æ®è´¨é‡çœ‹æ¿Tab
- ç³»ç»Ÿæµ‹è¯•

---

## âš ï¸ ä¸ƒã€å…³é”®æŠ€æœ¯è¦ç‚¹

### 7.1 æ—¶é—´æˆ³è§„èŒƒ

**24:00è§„åˆ™**ï¼š
```python
# âŒ é”™è¯¯
{ "datetime": ISODate("2025-11-10T24:00:00Z") }

# âœ… æ­£ç¡®
{ "datetime": ISODate("2025-11-11T00:00:00Z") }  # 2025-11-10çš„24:00
```

**æŸ¥è¯¢åŒºé—´**ï¼šå·¦å¼€å³é—­ `(start, end]`
```python
query = {
    "datetime": {
        "$gt": datetime(2025, 11, 10, 0, 0, 0),   # ä¸åŒ…å«00:00
        "$lte": datetime(2025, 11, 11, 0, 0, 0)   # åŒ…å«24:00
    }
}
```

### 7.2 æ•°æ®çº¯æ´æ€§åŸåˆ™

- è´Ÿè·æ›²çº¿åº“ = 100%æ‰‹å·¥æ•°æ®
- ç»“ç®—æ›²çº¿åº“ = 100%RPAæ•°æ®
- ä¸¥ç¦æ··åˆ
- å€Ÿç”¨æ•°æ®ä»…åœ¨å†…å­˜ï¼Œä¸æŒä¹…åŒ–

### 7.3 èšåˆè®¡ç®—è§„èŒƒ

```python
ç”¨æˆ·è´Ÿè· = Î£(è®¡é‡ç‚¹_iè´Ÿè· Ã— åˆ†é…ç³»æ•°_i / 100)

# ç¤ºä¾‹
mp1: 100kWh Ã— 65% = 65kWh
mp2: 80kWh Ã— 63.4569% = 50.77kWh
mp3: 100kWh Ã— 25% = 25kWh
mp4: 80kWh Ã— 25% = 20kWh
ç”¨æˆ·æ€»è´Ÿè· = 160.77kWh
```

### 7.4 æ€§èƒ½ä¼˜åŒ–

**æ‰¹é‡å†™å…¥**ï¼š
```python
# âœ… é«˜æ•ˆ
collection.insert_many(records, ordered=False)

# âŒ ä½æ•ˆ
for record in records:
    collection.insert_one(record)
```

**èšåˆç®¡é“**ï¼š
```python
# âœ… é«˜æ•ˆ
pipeline = [
    {"$match": {"customer_id": {"$in": customer_ids}}},
    {"$group": {"_id": "$customer_id", "data": {"$push": "$$ROOT"}}}
]
results = collection.aggregate(pipeline)
```

---

## ğŸ“Š å…«ã€æµ‹è¯•è®¡åˆ’

### 8.1 å•å…ƒæµ‹è¯•

```python
def test_aggregate_96_to_48():
    service = DataTransformationService()
    points_96 = [100.0, 102.5, ...] * 96
    points_48 = service.aggregate_96_to_48(points_96)
    assert len(points_48) == 48

def test_optimize_allocation():
    result = optimize_allocation_coefficients("customer_id", "2025-11-10")
    assert result["optimization_successful"] == True
    # éªŒè¯çº¦æŸ
    for validation in result["constraint_validation"]:
        assert validation["recommended_sum"] <= 100
```

### 8.2 é›†æˆæµ‹è¯•

```python
def test_full_validation_flow():
    # 1. å¯¼å…¥æ‰‹å·¥æ•°æ®
    response = client.post("/api/v1/data-validation/transform-manual-data", ...)
    assert response.status_code == 200

    # 2. æ‰§è¡Œæ ¡æ ¸
    response = client.post("/api/v1/data-validation/validate-curves", ...)
    assert response.status_code == 200

    # 3. éªŒè¯æŠ¥å‘Š
    report = quality_report.find_one({...})
    assert report["validation_result"]["optimization_successful"] == True
```

---

## ğŸ¯ ä¹ã€é¢„æœŸæˆæœ

1. **åˆ†é…ç³»æ•°éªŒè¯ä¸ä¼˜åŒ–**
   - è¯†åˆ«ä¸åˆç†çš„åˆ†é…ç³»æ•°
   - æ¨èä¼˜åŒ–æ–¹æ¡ˆï¼Œé¢„è®¡æ”¹è¿›10-30%

2. **æ•°æ®è´¨é‡é€æ˜åŒ–**
   - æ¸…æ™°å±•ç¤ºæ•°æ®è¦†ç›–èŒƒå›´
   - ä¸»åŠ¨è¯†åˆ«æ•°æ®ç¼ºå¤±

3. **å¥å£®çš„æ•°æ®åŸºç¡€**
   - è´Ÿè·é¢„æµ‹è‡ªåŠ¨å›é€€æœºåˆ¶
   - é¿å…å› æ•°æ®ç¼ºå¤±å¯¼è‡´åŠŸèƒ½ä¸­æ–­

4. **è¿è¥æ•ˆç‡æå‡**
   - å‡å°‘äººå·¥æ ¸å¯¹å·¥ä½œé‡
   - å¿«é€Ÿå®šä½æ•°æ®é—®é¢˜

---

## ğŸ“Œ é™„å½•

### A. ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | ä¿®è®¢å†…å®¹ |
|------|------|---------|
| 1.0 | 2025-11-12 | åˆå§‹ç‰ˆæœ¬ |
| 1.1 | 2025-11-12 | ç®€åŒ–å­˜å‚¨æ¶æ„ï¼Œä¼˜åŒ–æ ¡æ ¸æµç¨‹ï¼Œæ˜ç¡®ç³»æ•°çº¦æŸ |

### B. æ¢è¡¨å¤„ç†æ‰‹å†Œ

**åœºæ™¯**ï¼š2025-10-16æ¢è¡¨

**æ­¥éª¤1ï¼šæ›´æ–°å®¢æˆ·æ¡£æ¡ˆ**
```javascript
db.customers.updateOne(
  { "_id": ObjectId("customer_id") },
  {
    "$set": {
      "utility_accounts.0.metering_points.0.meter.meter_id": "æ–°ç”µè¡¨ID",
      "updated_at": new Date(),
      "update_reason": "2025-10-16æ¢è¡¨"
    }
  }
)
```

**æ­¥éª¤2ï¼šæ ‡è®°å†å²æ•°æ®**
```javascript
db.user_load_data.updateMany(
  {
    "meter_id": "æ—§ç”µè¡¨ID",
    "timestamp": { "$lte": ISODate("2025-10-15T23:59:59Z") }
  },
  { "$set": { "meter_replaced": true, "replaced_date": "2025-10-16" } }
)
```

**æ­¥éª¤3ï¼šæ ¡æ ¸å»ºè®®**
- æ¢è¡¨å‰ï¼šä½¿ç”¨æ—§ç³»æ•°
- æ¢è¡¨åï¼šä½¿ç”¨æ–°ç³»æ•°
- ä¸è·¨æ¢è¡¨æ—¥æœŸæ ¡æ ¸

---

**æ–‡æ¡£ç»“æŸ**
