## 1\. 项目背景

我们需要为电力市场交易员和客户经理提供一个强大的工具，用于评估和分析用户负荷数据的完整性和准确性。当前，系统存在两种核心的负荷数据来源：

1.  **手工导入的电表示数数据**:
    
    - **来源**: 用户现场电表，通过文件手工导入。
    - **用途**: 用于负荷预测、曲线展示、用电特征分析。
    - **粒度**: 96点/日（15分钟）。
    - **特点**: 数据周期长（可达1年以上），但**更新频率较低（如每日一次或按需导入），是获取近期（如T-1日）数据的最快途径**。此过程依赖人工操作，数据中间偶尔会有断点，数据导入时会做插值处理。数据为电能表示数（累计值）。
2.  **RPA自动采集的结算数据**:
    
    - **来源**: 电力交易中心平台，通过RPA程序自动爬取。
    - **用途**: 用于交易结算。
    - **粒度**: 48点/日（30分钟）。
    - **特点**: 权威性高（用于最终结算），自动化获取。但数据周期短（仅客户签约后），**延迟高（T-2，即今天只能获取前天的数据）**。数据为计量点级别的时段用电量（差值）。
3.  **用户-电力户号-计量点-电能表相互关系**：  
    四者之间是1对多的关系，一个用户-多个户号；一个户号-多个电表，一个电表-多个计量点。
    

```
    {
   "user_name": "江西省xx物资公司",
   "utility_accounts": [
     {
       "account_id": "3600015996813",
       "metering_points": [
       "metering_points": [
         {
           "metering_point_id": "211474252",
           "meter_id": "3630001492249049029898",
           "allocation_percentage": 65.0
         },
         {
           "metering_point_id": "211474253",
           "meter_id": "3630001492249049031259",
           "allocation_percentage": 63.4569
         },
         {
           "metering_point_id": "227324023",
           "meter_id": "3630001492249049029898",
           "allocation_percentage": 25.0
         },
         {
           "metering_point_id": "227324032",
           "meter_id": "3630001492249049031259",
           "allocation_percentage": 25.0
         }
       ]
     }
   ]
 },
```

这两种数据源在粒度、时效性、数据类型和覆盖范围上存在显著差异。为了确保结算的准确性、识别潜在的数据质量问题并为客户提供精细化服务，必须对这两者进行融合分析，并建立一套健壮的容错机制。

### 2 业务目标

1.  **提升数据质量校验能力**: 建立一个可视化界面，直观展示每个客户的数据完整度，主动识别数据缺失或数值差异。
2.  **保障结算准确性**: 通过对比权威的结算数据和及时的计量数据，提前发现和定位可能导致结算争议的差异点。
3.  **提高运营效率**: 减少人工核对数据的工作量，将交易员从繁琐的数据检查工作中解放出来，专注于分析和决策。
4.  **构建健壮的分析基础**: 为未来高级功能（如负荷预测、偏差分析等）提供可靠、完整的数据基础。**确保核心分析功能在部分数据缺失时，通过自动化的数据补充和回退机制，依然能够可靠运行。**

## 2\. 核心业务逻辑与数据分析策略

### 2.1 数据处理与存储策略 (数据源纯粹性原则)

1.  **原始数据保留**: 手工导入的96点电能表示数原始数据记录应予以保留，作为不可更改的原始凭证。
2.  **标准化曲线存储**: 系统将维护**两份完全独立**的48点负荷曲线数据库，是否以**计量点**为存储单位，待讨论：
    - **预测曲线库 (源自手工导入)**: 由96点手工导入数据经过聚合和转换（示数转用电量）后生成的48点曲线。**由于用途是基于用户级别，计量点级别存储只为和rpa数据做校核。**
    - **结算曲线库 (源自RPA)**: 由RPA采集的48点结算数据直接存储形成。**此数据库只包含源于RPA的数据。原始数据是计量点级别。**

### 2.2 数据校核

- **目的**: 分析并量化“预测曲线库”与“结算曲线库”之间的系统性偏差，为其他模块提供数据保证。
- **逻辑**:
    1.  在数据校核页面。用户可为每个用户手工启动校核，也可一次全部校核。
    2.  系统选取两条曲线最近均存在的时段，计算整体偏差的统计特征（如平均差异率或平均差值），并推荐误差最小的电能表分配系数，如数据集中的allocation_percentage参数。
    3.  没必要每天自动校核。（可讨论)，主要是校核用于预测手工导入的曲线数据，允许存在小的偏差。

### 2.3 数据完整性分析

- **目的**: 分析“预测曲线库”与“结算曲线库”数据的完整性，数据起止日期，是否有缺失的日期。以及缺点的日期。什么是否执行分析？是定时任务还是每次数据导入后调用？

### 2.3 应用层数据借用逻辑

#### 2.3.1负荷预测

当下游功能（如负荷预测、用户负荷分析）需要数据时，缺少手工导入的数据，则直接复制rpa结算数据。如果“预测曲线库”中无数据，则尝试从“结算曲线库”中获取数据作为替代。

1.  **双模型策略**:
    - **模式A (T-1高精度预测)**: 输入数据来自手工导入数据，并成功获取了T-1日的数据。
    - **模式B (T-2备用预测)**: 未能获取T-1日数据，只能获取到T-2日的数据（通常来自RPA补充）。
2.  **自动化执行**:
    - 系统每日自动触发一次负荷预测。
    - 优先尝试执行**模式A**。如果数据借用逻辑无法返回T-1日的数据，则自动**降级**执行**模式B**。
    - **如果数据借用逻辑最终仍无法为预测模型提供有效的数据输入（即两天数据均无），则当天的自动预测将不会执行，并应在系统中标记为“数据不足，无法预测”。**
3.  **手动覆盖**:
    - 当用户当天补充导入了昨日的手工数据后，可以**手动触发**一次新的预测。
    - 这次手动预测将执行模式A，其生成的更高精度的结果将**覆盖**早上自动生成的备用结果。

### 2.3.2 预结算模块集成逻辑

1.  **RPA数据优先**: 在进行预结算时，应**优先使用**权威的“结算曲线库”（RPA数据）。
2.  **手工数据临时代理**: 当需要对昨日（T-1）进行预结算模拟，而此时RPA数据尚未发布时，模块可**临时调用**“预测曲线库”（手工数据）作为代理数据进行估算。**注意:借用的手工数据不能存储到预算数据曲线库中**
3.  **数据缺失处理**: 如果进行预结算所需日期的两条曲线库中均无数据，则相关计算无法完成，系统应给出明确提示。