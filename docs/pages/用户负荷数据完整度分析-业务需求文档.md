# 用户负荷数据完整度分析功能 - 业务需求文档 (BRD)

**文档版本: 1.3**

## 1. 项目背景与目标

### 1.1 背景

在现有的客户档案管理模块中，我们需要为电力市场交易员和客户经理提供一个强大的工具，用于评估和分析用户负荷数据的完整性和准确性。当前，系统存在两种核心的负荷数据来源：

1.  **手工导入的电表示数数据**:
    *   **来源**: 用户现场电表，通过文件手工导入。
    *   **粒度**: 96点/日（15分钟）。
    *   **特点**: 数据周期长（可达1年以上），但**更新频率较低（如每日一次或按需导入），是获取近期（如T-1日）数据的最快途径**。此过程依赖人工操作，可能存在操作失误。数据为电能表示数（累计值）。

2.  **RPA自动采集的结算数据**:
    *   **来源**: 电力交易中心平台，通过RPA程序自动爬取。
    *   **粒度**: 48点/日（30分钟）。
    *   **特点**: 权威性高（用于最终结算），自动化获取。但数据周期短（仅客户签约后），**延迟高（T-2，即今天只能获取前天的数据）**。数据为计量点级别的时段用电量（差值）。

这两种数据源在粒度、时效性、数据类型和覆盖范围上存在显著差异。为了确保结算的准确性、识别潜在的数据质量问题并为客户提供精细化服务，必须对这两者进行融合分析，并建立一套健壮的容错机制。

### 1.2 业务目标

1.  **提升数据质量监控能力**: 建立一个可视化界面，直观展示每个客户、每个计量点的数据完整度，主动识别数据缺失或异常。
2.  **保障结算准确性**: 通过对比权威的结算数据和及时的计量数据，提前发现和定位可能导致结算争议的差异点。
3.  **提高运营效率**: 减少人工核对数据的工作量，将交易员从繁琐的数据检查工作中解放出来，专注于分析和决策。
4.  **构建健壮的分析基础**: 为未来高级功能（如负荷预测、偏差分析等）提供可靠、完整的数据基础。**确保核心分析功能在部分数据缺失时，通过自动化的数据补充和回退机制，依然能够可靠运行。**

## 2. 目标用户

| 用户角色 | 主要诉求 |
| :--- | :--- |
| **电力交易员/数据分析师** | 需要快速评估用于分析和预测的数据是否完整、准确，并信任系统能够在数据不完美时依然给出可靠的分析结果。 |
| **客户经理** | 当出现数据问题时，需要清晰了解数据来源（是手工导入还是结算补充），并与客户进行有效沟通。 |
| **系统管理员** | 监控数据导入和采集流程，确保数据按预期流入系统。 |

## 3. 功能需求 (Functional Requirements)

### FR-1: 数据完整度概览仪表盘
*(此功能为FR-2和FR-4的前置和补充，细节在对应章节)*

### FR-2: 日度数据对比分析视图

当用户在日历热力图中点击某一天时，页面下方或新页面将展示该日的详细对比分析。

*   **FR-2.1: 数据处理与对齐**
    *   **FR-2.1.1 (粒度统一)**: 系统需自动将96点的手工导入数据聚合为48点，以便与RPA数据进行比较。聚合规则：每两个连续的15分钟数据点合并为一个30分钟数据点。
    *   **FR-2.1.2 (类型统一)**: 手工导入的电表示数（累计值）需转换为时段用电量（差值）。转换规则：`T 时刻用电量 = T 时刻示数 - (T-15分钟) 时刻示数`。
    *   **FR-2.1.3 (层级统一)**: 手工导入数据是基于电表的，系统需自动将其按所属计量点进行加总，得到计量点维度的手工导入用电量。

*   **FR-2.2: 可视化对比图表**
    *   **FR-2.2.1**: 在一个图表中同时绘制两条曲线：
        1.  **曲线A**: “预测曲线库”中的数据（源自手工导入）。
        2.  **曲线B**: “结算曲线库”中的数据（源自RPA）。
    *   **FR-2.2.2**: 图表应支持缩放、平移，并提供工具提示（Tooltip）显示在任一时点两条曲线的具体数值和差异值。
    *   **FR-2.2.3**: 对于两个数据源数值差异超过阈值（例如 5%）的时点，在图表上应有特殊标记（如高亮背景区域或标记点）。

*   **FR-2.3: 差异明细数据表**
    *   **FR-2.3.1**: 在图表下方提供一个数据表格，逐行展示48个时间点的数据对比情况。
    *   **FR-2.3.2**: 表格列应包括：序号、时间点（如 00:30, 01:00...）、手工导入数据(kWh)、RPA结算数据(kWh)、差异值(kWh)、差异率(%)、**数据来源/状态**。
    *   **FR-2.3.3**: “数据来源/状态”列应明确标识该时间点最终采纳的数据来源及对比结果：
        *   **匹配 (来源: 手工)**: 手工数据与结算数据都存在且差异在阈值内。
        *   **偏差 (来源: 手工)**: 手工数据与结算数据都存在但差异超过阈值。
        *   **仅手工数据**: 只有手工导入数据存在。
        *   **补充 (来源: 结算)**: 手工数据缺失，使用RPA结算数据自动补充。
        *   **仅结算数据**: 只有RPA结算数据存在。
        *   **数据双缺**: 两种数据源在该时间点均无数据。

*   **FR-2.4: 数据校准与补偿功能 (新增)**
    *   **FR-2.4.1**: 在日度数据对比分析视图中，系统应提供一个“计算补偿系数”的功能。
    *   **FR-2.4.2**: 用户点击后，系统可基于当前时间范围（如过去30天）内两条曲线的系统性偏差，自动计算出一个建议的补偿系数（或固定差值）。
    *   **FR-2.4.3**: 用户可以确认并保存此补偿系数。保存后，系统在后续生成“统一负荷曲线”时，可选择性地应用此系数对长周期的手工导入数据进行校准。

### FR-3: 数据导出功能

*   **FR-3.1**: 用户应能将日度数据对比分析的明細表格（FR-2.3）导出为 Excel 文件，以供离线分析和存档。

### FR-4: 全局数据完整度监控仪表盘 (支持下钻)

#### FR-4.1 核心交互模式

仪表盘将以一个**两级可展开的表格**呈现。

1.  **默认视图（客户层级）**: 表格的每一行代表一个**客户**，显示的是该客户所有计量点聚合后的整体数据健康状况。
2.  **展开视图（计量点层级）**: 用户可以点击每个客户行旁边的“展开”图标（`+`），表格会在该客户下方展开，显示其下属每个计量点的详细数据行。

#### FR-4.2 客户层级表格设计 (默认视图)

| 列名 | 数据说明 | 示例 | 备注 |
| :--- | :--- | :--- | :--- |
| **客户名称** | 客户的名称。 | `XX化工` | 支持筛选和排序 |
| **计量点数量** | 该客户下的计量点总数。 | `3` | |
| **数据健康度** | 一个综合性的状态灯，快速反映问题。 | 🟢 / 🟡 / 🔴 | 绿色:一切正常; 黄色:有缺失/差异; 红色:问题严重 |
| **数据覆盖范围** | 该客户最早和最晚的数据日期。 | `2024-01-15 ~ 2025-11-09` | |
| **平均完整度(手工)** | 所有计量点手工导入数据的加权平均完整度。 | `99.1%` | |
| **平均完整度(RPA)** | 所有计量点RPA结算数据的加权平均完整度。 | `99.8%` | |
| **问题计量点(缺失)** | 有数据缺失的计量点数量 / 总数量。 | `1 / 3` | **关键问题指标**，支持排序 |
| **问题计量点(差异)** | 与结算数据存在偏差的计量点数量 / 总数量。 | `2 / 3` | **关键问题指标**，支持排序 |
| **操作** | 提供一个操作入口。 | `[查看详情]` | 点击后跳转到该客户的深度分析页面 |

#### FR-4.3 计量点层级表格设计 (展开视图)

当用户展开某个客户行后，下方会显示其计量点的详细数据，其列结构与FR-2.3中的表格类似，但聚焦于单个数据源的统计。

#### FR-4.4 后端与缓存策略

*   **API 设计**: 后端将提供一个API，一次性返回这个两级嵌套结构的数据。
*   **缓存策略**:
    *   系统将为这个全局聚合查询的结果建立缓存。
    *   该缓存的**刷新机制是事件驱动的**：
        1.  当**手工导入流程成功执行完毕**后，自动触发缓存刷新。
        2.  当**RPA数据采集流程成功执行完毕**后，自动触发缓存刷新。

## 4. 核心业务逻辑与数据分析策略 (v1.3)

### 4.1 数据处理与存储策略

1.  **原始数据保留**: 手工导入的96点电能表示数原始文件或数据记录应予以保留，作为不可更改的原始凭证。
2.  **标准化曲线存储**: 系统将维护两份核心的、标准化的48点负荷曲线数据，均以**计量点**为存储单位：
    *   **预测曲线库 (源自手工导入)**: 由96点手工导入数据经过聚合和转换（示数转用电量）后生成的48点曲线。此数据库周期长，主要用于负荷预测。
    *   **结算曲线库 (源自RPA)**: 由RPA采集的48点结算数据直接存储形成。此数据库权威性高，主要用于结算和数据校准。

### 4.2 数据校准与补偿

*   **目的**: 消除“预测曲线库”与“结算曲线库”之间的系统性偏差（如固定的线损差异），生成一条更接近结算口径的“校准后预测曲线”。
*   **逻辑**:
    1.  在数据分析视图中，用户可触发“计算补偿系数”功能 (FR-2.4)。
    2.  系统选取两条曲线均存在的时段，计算整体偏差的统计特征（如平均差异率或平均差值）。
    3.  用户可将此系数保存，作为该计量点的“校准模型”。
    4.  在执行负荷预测等高级应用时，可选择是否对“预测曲线库”应用此校准模型。

### 4.3 “统一负荷曲线”生成策略 (核心容错机制)

为了保证下游应用的稳定运行，系统在需要某一天的数据时，将通过以下**两级优先级**策略，实时生成一条单一、最可信的“统一负荷曲线”：

#### **优先级 1：校准后的手工导入数据 (最优过程数据)**
*   **逻辑：** 如果当天的“预测曲线库”中有数据，并且该计量点存在已保存的“校准模型”，则优先应用该模型进行校准后的数据。如果不存在校准模型，则直接使用原始的“预测曲线库”数据。
*   **理由：** 这是最及时、最精细，且最接近结算口径的数据。

#### **优先级 2：RPA 结算数据 (权威结果数据)**
*   **逻辑：** 如果在某个时间点**没有**手工导入数据，系统会自动检查“结算曲线库”中是否存在对应的RPA结算数据。如果存在，则用它来**补充**。
*   **理由：** 这是权威的结算数据，是最佳的补充数据源。

**注意：如果以上两种数据源在某个时间点均无数据，则“统一负荷曲线”在该点的值为空缺，依赖此数据的下游功能（如自动负荷预测）将不会执行。**

### 4.4 负荷预测模块集成逻辑

1.  **双模型策略**: 系统需支持两种预测执行模式，以应对不同的数据时效性：
    *   **模式A (T-1高精度预测)**: 使用了截止到昨日（T-1）的“统一负荷曲线”作为输入。这是最高精度的预测模式。
    *   **模式B (T-2备用预测)**: 因昨日手工数据未导入，最新的“统一负荷曲线”只到前日（T-2）。这是备用预测模式。
2.  **自动化执行**:
    *   系统每日自动触发一次负荷预测。
    *   优先尝试执行**模式A**。如果检测到T-1日的数据不完整（即手工数据未导入），则自动**降级**执行**模式B**。
    *   **如果为某天生成的“统一负荷曲线”中存在数据空缺，则当天的自动预测将不会执行，并应在系统中标记为“数据不足，无法预测”。**
3.  **手动覆盖**:
    *   当用户当天补充导入了昨日的手工数据后，可以**手动触发**一次新的预测。
    *   这次手动预测将执行模式A，其生成的更高精度的结果将**覆盖**早上自动生成的备用结果。

### 4.5 预结算模块集成逻辑

1.  **RPA数据优先**: 在进行预结算时，应**优先使用**权威的“结算曲线库”（RPA数据）。
2.  **手工数据临时代理**: 当需要对昨日（T-1）进行预结算模拟，而此时RPA数据尚未发布时，模块可**临时调用**“预测曲线库”（手工数据）作为代理数据进行估算。
3.  **数据缺失处理**: 如果进行预结算所需日期的“统一负荷曲线”存在数据空缺，则相关计算无法完成，系统应给出明确提示。

## 5. UI/UX 设计建议

*   **整体布局**:
    *   **全局监控页 (FR-4)**: 提供一个独立的、以客户为中心的两级可展开表格，用于宏观监控。
    *   **深度分析页 (FR-1, FR-2)**: 采用经典的“筛选器-概览-详情”上下布局，用于单个计量点的钻取分析。
*   **交互设计**:
    *   点击日历中的某一天，下方区域**异步加载**并显示该日的详细分析，避免页面整体刷新。
    *   图表和表格应紧密联动，例如鼠标悬停在图表某个点上时，表格中对应行高亮。
    *   **在数据表格的“数据来源/状态”列，使用不同颜色或图标清晰地标识出数据来源（如手工、结算补充），增强信息透明度。**
*   **组件风格**: 遵循项目现有的 Material-UI 设计规范，使用 `Paper`, `Grid`, `Card`, `Table`, `DatePicker` 等组件，确保视觉风格统一。
*   **响应式设计**:
    *   在移动端，日历热力图可简化为列表视图。
    *   图表和表格应支持水平滚动，保证在小屏幕上信息的可访问性。

## 6. 非功能性需求 (Non-Functional Requirements)

| 类别 | 需求描述 |
| :--- | :--- |
| **性能** | - 页面加载时间应在3秒以内。<br>- 切换日期或客户后，详细数据应在5秒内加载完成（针对一年内的数据量）。<br>- 后端数据聚合与计算应通过高效的数据库查询（如MongoDB聚合管道）实现。 |
| **可用性** | - 界面应直观易懂，关键指标（如差异率）应有明确的视觉提示。<br>- 所有的筛选和交互操作应有清晰的加载状态指示（如加载动画）。 |
| **可靠性** | - 数据转换和计算逻辑必须经过充分测试，确保准确无误。<br>- **系统必须能优雅地处理数据源缺失的情况。如果因数据不足导致功能（如预测）无法执行，应有明确的系统状态或日志记录。** |
| **可扩展性** | - 差异告警的阈值应设计为可配置项，方便未来根据业务调整。<br>- 数据校准模型应支持未来扩展更复杂的算法。 |

## 7. 假设与依赖

*   **假设1**: 客户、计量点、电表之间的层级关系在数据库中是准确且最新的。
*   **假设2**: 手工导入的数据文件格式是固定的，系统可以稳定解析。
*   **依赖1**: 需要一个后台服务或定时任务来执行RPA爬虫，并将数据存入数据库。
*   **依赖2**: 客户档案管理模块已提供查询客户及其下属计量点和电表的基础API。

## 8. 超出范围 (Out of Scope)

*   **自动数据清洗与修复**: 本期功能专注于“分析和发现”问题，不包含自动修正数据的功能（数据校准除外）。
*   **实时告警与通知**: 不包含当检测到数据差异时，通过邮件或短信等方式主动通知用户的功能。
*   **机器学习驱动的异常检测**: 不包含使用高级算法自动识别非典型负荷形态的功能。

---
**创建日期**: 2025年11月10日
**最后更新**: 2025年11月10日