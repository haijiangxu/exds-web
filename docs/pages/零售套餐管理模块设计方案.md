

## ğŸ–¥ï¸ é›¶å”®å¥—é¤ç®¡ç†é¡µé¢ UI éœ€æ±‚æ–¹æ¡ˆ

ä»¥ä¸‹æ˜¯â€œé›¶å”®å¥—é¤ç®¡ç†â€é¡µé¢çš„UIè®¾è®¡å»ºè®®ï¼Œæ—¨åœ¨æ¸…æ™°ã€é«˜æ•ˆåœ°é…ç½®ä¸Šè¿°å¤æ‚è§„åˆ™ã€‚

**é¡µé¢åç§°ï¼š** é›¶å”®å¥—é¤ç®¡ç†

### 1. ä¸»è§†å›¾ï¼ˆå¥—é¤åˆ—è¡¨é¡µï¼‰

**å¸ƒå±€ï¼š** é¡¶éƒ¨ä¸ºæ“ä½œæ ï¼Œä¸‹æ–¹ä¸ºå¥—é¤åˆ—è¡¨ã€‚

* **æ“ä½œæ ï¼š**
    * **[ æœç´¢æ¡† ]** ï¼ˆè¾“å…¥å¥—é¤åç§°å…³é”®å­—ï¼‰
    * **[ ç­›é€‰å™¨ - ä¸‹æ‹‰ ]** ï¼ˆæŒ‰â€œå¥—é¤ç±»å‹â€ç­›é€‰ã€æŒ‰â€œçŠ¶æ€â€ç­›é€‰ï¼‰
    * **[ æŒ‰é’® ] + æ–°å»ºé›¶å”®å¥—é¤**
* **å¥—é¤åˆ—è¡¨ï¼ˆè¡¨æ ¼ï¼‰ï¼š**
    * **å¥—é¤åç§°**
    * **å¥—é¤ç±»å‹**ï¼ˆæ ‡ç­¾ï¼šåˆ†æ—¶æ®µ / ä¸åˆ†æ—¶æ®µï¼‰
    * **å®šä»·æ¨¡å¼**ï¼ˆæ ‡ç­¾ï¼šå›ºå®š+è”åŠ¨ / ä»·å·®åˆ†æˆï¼‰
    * **é™„åŠ å¥—é¤**ï¼ˆæ ‡ç­¾ï¼šå«ç»¿è‰²ç”µåŠ› / å«å°é¡¶ä»·æ ¼ï¼‰
    * **çŠ¶æ€**ï¼ˆæ ‡ç­¾ï¼šè‰ç¨¿ / ç”Ÿæ•ˆ / å½’æ¡£ï¼‰
    * **åˆ›å»ºæ—¶é—´**
    * **æ“ä½œ**ï¼ˆ[ ç¼–è¾‘ ] [ å¤åˆ¶ ] [ å½’æ¡£ ] [ æŸ¥çœ‹è¯¦æƒ… ]ï¼‰

### 2. æ–°å»º/ç¼–è¾‘å¥—é¤è§†å›¾ï¼ˆå¼¹çª—æˆ–æ–°é¡µé¢ï¼‰

#### å¸ƒå±€ï¼šé¡¶éƒ¨æ ‡ç­¾é¡µ + ä¸­éƒ¨è¡¨å• + åº•éƒ¨æ“ä½œæ 

**[ å¡ç‰‡ 1: åŸºæœ¬ä¿¡æ¯ ] [ å¡ç‰‡ 2: å®šä»·æ¨¡å¼ ] [ å¡ç‰‡ 3: é™„åŠ æ¡æ¬¾ ]**

---

#### å¡ç‰‡ 1: åŸºæœ¬ä¿¡æ¯

* **å¥—é¤åç§°ï¼š** [ æ–‡æœ¬è¾“å…¥æ¡† ]
* **å¥—é¤æè¿°ï¼š** [ å¤šè¡Œæ–‡æœ¬æ¡† ]
* **å¥—é¤ç±»å‹ï¼š** [ å•é€‰æŒ‰é’® ]
    * (â€¢) **åˆ†æ—¶æ®µé›¶å”®å¥—é¤** 
    * ( ) **ä¸åˆ†æ—¶æ®µé›¶å”®å¥—é¤** 
---

#### å¡ç‰‡ 2: å®šä»·æ¨¡å¼

* **é€‰æ‹©å®šä»·æ¨¡å¼ï¼š** [ å•é€‰æŒ‰é’® ]
    * (â€¢) **å›ºå®šä»·æ ¼ + è”åŠ¨ä»·æ ¼ + æµ®åŠ¨è´¹ç”¨** 
    * ( ) **ä»·å·®åˆ†æˆ + æµ®åŠ¨è´¹ç”¨** 

---

##### â¬‡ï¸ *ï¼ˆå½“é€‰æ‹©â€œå›ºå®š+è”åŠ¨â€æ—¶ï¼Œæ˜¾ç¤ºæ­¤è¡¨å•ç»„ï¼‰*

* **å›ºå®šä»·æ ¼ (Fixed Price)ï¼š**
    * **å®šä»·æ–¹å¼ï¼š** [ ä¸‹æ‹‰èœå• ] (é€‰é¡¹: "è‡ªå®šä¹‰ä»·æ ¼", "æŒ‰å‚è€ƒä»·")
    * *ï¼ˆå¦‚æœé€‰â€œè‡ªå®šä¹‰ä»·æ ¼â€ä¸”å¥—é¤ç±»å‹ä¸ºâ€œåˆ†æ—¶æ®µâ€ï¼‰*
        * **å°–å³°æ—¶æ®µä»·æ ¼ï¼š** [ æ•°å­—è¾“å…¥ ] å…ƒ/MWh
        * **å³°æ—¶æ®µä»·æ ¼ï¼š** [ æ•°å­—è¾“å…¥ ] å…ƒ/MWh
        * **å¹³æ—¶æ®µä»·æ ¼ï¼š** [ æ•°å­—è¾“å…¥ ] å…ƒ/MWh *(æç¤º: 331.44 ~ 497.16)* 
        * **è°·æ—¶æ®µä»·æ ¼ï¼š** [ æ•°å­—è¾“å…¥ ] å…ƒ/MWh
        * **æ·±è°·æ—¶æ®µä»·æ ¼ï¼š** [ æ•°å­—è¾“å…¥ ] å…ƒ/MWh
    * *ï¼ˆå¦‚æœé€‰â€œæŒ‰å‚è€ƒä»·â€ï¼‰*
        * **å‚è€ƒæ ‡çš„ï¼š** [ ä¸‹æ‹‰èœå• ] (é€‰é¡¹: "ç”µç½‘ä»£ç†è´­ç”µä»·æ ¼(åˆ†æ—¶)", "ç”µåŠ›å¸‚åœºæœˆåº¦äº¤æ˜“å‡ä»·(åˆ†æ—¶)") 
* **è”åŠ¨ä»·æ ¼ (Linked Price)ï¼š**
    * **è”åŠ¨æ¯”ä¾‹ ($\alpha$)ï¼š** [ æ»‘å—æˆ–æ•°å­—è¾“å…¥ ] % *(æç¤º: 10%~20%ï¼Œç‰¹å®šç”¨æˆ·å¯ä¸º0)* 
    * **è”åŠ¨æ ‡çš„ï¼š** [ ä¸‹æ‹‰èœå• ] (é€‰é¡¹: "æ—¥å‰å¸‚åœºå‡ä»·(åˆ†æ—¶)", "å®æ—¶å¸‚åœºå‡ä»·(åˆ†æ—¶)") 
* **æµ®åŠ¨è´¹ç”¨ (Floating Fee)ï¼š**
    * [ æ•°å­—è¾“å…¥ ] å…ƒ/kWh *(æç¤º: å¯é€‰é¡¹ï¼Œå¤§äºç­‰äº0)* 

---

##### â¬‡ï¸ *ï¼ˆå½“é€‰æ‹©â€œä»·å·®åˆ†æˆâ€æ—¶ï¼Œæ˜¾ç¤ºæ­¤è¡¨å•ç»„ï¼‰*

* **å‚è€ƒä»· (Reference Price)ï¼š**
    * **å‚è€ƒæ ‡çš„ï¼š** [ ä¸‹æ‹‰èœå• ] (é€‰é¡¹: "ç”µåŠ›å¸‚åœºæœˆåº¦äº¤æ˜“å‡ä»·", "ç”µç½‘ä»£ç†è´­ç”µä»·æ ¼", "æ‰¹å‘ä¾§ç»“ç®—å‡ä»·") 
* **ä»·å·®åˆ†æˆ (Price-spread Sharing)ï¼š**
    * **çº¦å®šä»·å·®ï¼š** [ æ•°å­—è¾“å…¥ ] å…ƒ/MWh *(æç¤º: å¯ä¸ºå›ºå®šå€¼æˆ–å‚è€ƒä»·ä¹‹å·®)* 
    * **åˆ†æˆæ¯”ä¾‹ ($k$)ï¼š** [ æ»‘å—æˆ–æ•°å­—è¾“å…¥ ] % *(æç¤º: 0%~100%)* 
* **æµ®åŠ¨è´¹ç”¨ (Floating Fee)ï¼š**
    * [ æ•°å­—è¾“å…¥ ] å…ƒ *(æç¤º: å¯é€‰é¡¹ï¼Œå¤§äºç­‰äº0)* 

---

#### å¡ç‰‡ 3: é™„åŠ æ¡æ¬¾

* **ç»¿è‰²ç”µåŠ›å¥—é¤ï¼š** [ å¼€å…³ Toggle ] (é»˜è®¤å…³é—­)
    * *(ä»…å½“â€œåŸºæœ¬ä¿¡æ¯â€ä¸­é€‰æ‹©â€œåˆ†æ—¶æ®µâ€æ—¶æ‰å¯å¯ç”¨)* 
    * *(å¯ç”¨åæ˜¾ç¤º)*
        * **æœˆåº¦ç»¿è‰²ç”µåŠ›ç¯å¢ƒä»·å€¼ï¼š** [ æ•°å­—è¾“å…¥ ] å…ƒ/MWh 
        * **åå·®è¡¥å¿æ¯”ä¾‹ï¼š** [ æ•°å­—è¾“å…¥ ] % *(ä¾‹å¦‚: 25)* 
        * [ å¸®åŠ©æ–‡æœ¬æ¡† ] â€œåŒæ–¹ç”¨ç”µé‡ä¸çº¦å®šç”µé‡åå·®æ—¶ï¼Œå°†æŒ‰æ­¤æ¯”ä¾‹è¿›è¡Œè¡¥å¿â€ ã€‚
* **å°é¡¶ä»·æ ¼æ¡æ¬¾ï¼š** [ å¼€å…³ Toggle ] (é»˜è®¤å…³é—­) 
    * *(å¯ç”¨åæ˜¾ç¤º)*
        * **å‚è€ƒä»·æ ¼æ ‡çš„ï¼š** [ ä¸‹æ‹‰èœå• ] (é»˜è®¤: "ç”µç½‘ä»£ç†è´­ç”µå‘å¸ƒçš„ç”µåŠ›å¸‚åœºå½“æœˆå¹³å‡ä¸Šç½‘ç”µä»·") 
        * **éå°–å³°æœˆä»½ä¸Šæµ®ï¼š** [ æ•°å­—è¾“å…¥ ] % *(é»˜è®¤: 5)* 
        * **å°–å³°æœˆä»½ä¸Šæµ®ï¼š** [ æ•°å­—è¾“å…¥ ] % *(é»˜è®¤: 10)* 
        * [ å¸®åŠ©æ–‡æœ¬æ¡† ] â€œç»“ç®—æ—¶ï¼Œè‹¥å¥—é¤ç»“ç®—ä»·é«˜äºå°é¡¶ä»·ï¼Œå°†æŒ‰å°é¡¶ä»·ç»“ç®—â€ ã€‚

---


* **[ æŒ‰é’® ] ä¿å­˜ä¸ºè‰ç¨¿**
* **[ æŒ‰é’® ] ä¿å­˜å¹¶ç”Ÿæ•ˆ**
* **[ é“¾æ¥ ] å–æ¶ˆ**

---

#### ğŸ’¡ UI è®¾è®¡ç‰¹åˆ«æç¤º (æ ¡éªŒé€»è¾‘)

* **åˆ†æ—¶æ—¶æ®µæ ¡éªŒ**ï¼šåœ¨"åŸºæœ¬ä¿¡æ¯"æ ‡ç­¾é¡µä¸­ï¼Œå¦‚æœé€‰æ‹©"åˆ†æ—¶æ®µ"ï¼Œåº”æœ‰ä¸“é—¨çš„æ¨¡å—é…ç½®æ—¶æ®µåˆ’åˆ†ï¼ˆæœ¬æ–‡æ¡£æœªæä¾›463å·æ–‡çš„å…·ä½“æ—¶æ®µï¼Œæ•…æœªç”»å‡ºï¼‰ã€‚è¯¥æ¨¡å—å¿…é¡»å®æ—¶æ ¡éªŒ"è°·æ€»æ—¶é•¿ $\ge$ å³°æ€»æ—¶é•¿"å’Œ"å¹³æ€»æ—¶é•¿ $\ge$ 11å°æ—¶" ã€‚
* **æµ®åŠ¨æ¯”ä¾‹æ ¡éªŒ**ï¼šåœ¨"å®šä»·æ¨¡å¼"æ ‡ç­¾é¡µï¼Œå½“ç”¨æˆ·è¾“å…¥"è‡ªå®šä¹‰ä»·æ ¼"åï¼Œç³»ç»Ÿåº”**å®æ—¶è®¡ç®—**å³°/å¹³ã€è°·/å¹³ã€æ·±è°·/å¹³çš„æ¯”ä¾‹ã€‚å¦‚æœæ¯”ä¾‹ä¸ç¬¦åˆ463å·æ–‡ï¼ˆå¦‚æ–‡æ¡£ç¬¬ä¸‰ä¸ªç¤ºä¾‹ï¼‰ï¼Œåº”**ç«‹å³æ˜¾ç¤ºä¸€ä¸ªè­¦å‘Šä¿¡æ¯**ï¼š"å½“å‰è‡ªå®šä¹‰ä»·æ ¼æ¯”ä¾‹ä¸æ»¡è¶³463å·æ–‡è¦æ±‚ï¼Œç»“ç®—æ—¶å°†è‡ªåŠ¨è°ƒæ•´ä¸ºæ ‡å‡†æ¯”ä¾‹ (1.6:1:0.4:0.3)ã€‚" ã€‚

---

---

# é›¶å”®å¥—é¤ç®¡ç†æ¨¡å— - è¯¦ç»†æŠ€æœ¯è®¾è®¡æ–¹æ¡ˆ

## ä¸€ã€ç³»ç»Ÿæ¶æ„è®¾è®¡

### 1.1 åŠŸèƒ½æ¨¡å—åˆ’åˆ†

```
é›¶å”®å¥—é¤ç®¡ç†æ¨¡å—
â”œâ”€â”€ å¥—é¤åˆ—è¡¨ç®¡ç†
â”‚   â”œâ”€â”€ åˆ—è¡¨å±•ç¤ºä¸ç­›é€‰
â”‚   â”œâ”€â”€ æœç´¢åŠŸèƒ½
â”‚   â””â”€â”€ å¿«é€Ÿæ“ä½œï¼ˆç¼–è¾‘/å¤åˆ¶/å½’æ¡£/æŸ¥çœ‹ï¼‰
â”œâ”€â”€ å¥—é¤é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ åŸºæœ¬ä¿¡æ¯é…ç½®
â”‚   â”œâ”€â”€ å®šä»·æ¨¡å¼é…ç½®ï¼ˆå›ºå®š+è”åŠ¨ / ä»·å·®åˆ†æˆï¼‰
â”‚   â””â”€â”€ é™„åŠ æ¡æ¬¾é…ç½®ï¼ˆç»¿ç”µ / å°é¡¶ä»·ï¼‰
â”œâ”€â”€ æ ¡éªŒä¸è®¡ç®—å¼•æ“
â”‚   â”œâ”€â”€ åˆ†æ—¶æ—¶æ®µæ ¡éªŒ
â”‚   â”œâ”€â”€ ä»·æ ¼æ¯”ä¾‹æ ¡éªŒ
â”‚   â””â”€â”€ å®šä»·è§„åˆ™è®¡ç®—
â””â”€â”€ å¥—é¤çŠ¶æ€ç®¡ç†
    â”œâ”€â”€ è‰ç¨¿ â†’ ç”Ÿæ•ˆ
    â”œâ”€â”€ ç”Ÿæ•ˆ â†’ å½’æ¡£
    â””â”€â”€ ç‰ˆæœ¬å†å²è®°å½•
```

### 1.2 æŠ€æœ¯æ ˆ

**å‰ç«¯**ï¼š
- React 18 + TypeScript
- Material-UI v7
- React Hook Formï¼ˆè¡¨å•ç®¡ç†ï¼‰
- Zodï¼ˆæ•°æ®æ ¡éªŒï¼‰
- Rechartsï¼ˆä»·æ ¼æ¯”ä¾‹å¯è§†åŒ–ï¼‰

**åç«¯**ï¼š
- FastAPIï¼ˆPythonï¼‰
- Pydanticï¼ˆæ•°æ®æ ¡éªŒï¼‰
- MongoDBï¼ˆå¥—é¤æ•°æ®å­˜å‚¨ï¼‰

---

## äºŒã€æ•°æ®åº“è®¾è®¡

### 2.1 MongoDB é›†åˆï¼š`retail_packages`

```javascript
{
  _id: ObjectId,
  package_name: String,              // å¥—é¤åç§°
  package_description: String,       // å¥—é¤æè¿°
  package_type: String,              // å¥—é¤ç±»å‹ï¼š"time_based" | "non_time_based"

  // å®šä»·æ¨¡å¼
  pricing_mode: String,              // "fixed_linked" | "price_spread"

  // å›ºå®š+è”åŠ¨å®šä»·æ¨¡å¼
  fixed_linked_config: {
    // å›ºå®šä»·æ ¼
    fixed_price: {
      pricing_method: String,        // "custom" | "reference"
      // è‡ªå®šä¹‰ä»·æ ¼ï¼ˆåˆ†æ—¶æ®µï¼‰
      custom_prices: {
        peak: Number,                // å°–å³°æ—¶æ®µä»·æ ¼
        high: Number,                // å³°æ—¶æ®µä»·æ ¼
        flat: Number,                // å¹³æ—¶æ®µä»·æ ¼
        valley: Number,              // è°·æ—¶æ®µä»·æ ¼
        deep_valley: Number          // æ·±è°·æ—¶æ®µä»·æ ¼
      },
      // å‚è€ƒä»·æ ¼
      reference_target: String,      // "grid_agency_price" | "market_monthly_avg"
      reference_prices: Object       // å¼•ç”¨çš„å‚è€ƒä»·æ ¼æ•°æ®
    },
    // è”åŠ¨ä»·æ ¼
    linked_price: {
      ratio: Number,                 // è”åŠ¨æ¯”ä¾‹ Î± (0.1 ~ 0.2)
      target: String                 // "day_ahead_avg" | "real_time_avg"
    },
    // æµ®åŠ¨è´¹ç”¨
    floating_fee: Number             // å…ƒ/kWh
  },

  // ä»·å·®åˆ†æˆå®šä»·æ¨¡å¼
  price_spread_config: {
    reference_price: {
      target: String,                // "market_monthly_avg" | "grid_agency" | "wholesale_settlement"
      value: Number
    },
    price_spread: {
      agreed_spread: Number,         // çº¦å®šä»·å·®ï¼ˆå…ƒ/MWhï¼‰
      sharing_ratio: Number          // åˆ†æˆæ¯”ä¾‹ k (0 ~ 1)
    },
    floating_fee: Number             // æµ®åŠ¨è´¹ç”¨ï¼ˆå…ƒï¼‰
  },

  // é™„åŠ æ¡æ¬¾
  additional_terms: {
    // ç»¿è‰²ç”µåŠ›å¥—é¤
    green_power: {
      enabled: Boolean,
      monthly_env_value: Number,     // æœˆåº¦ç»¿è‰²ç”µåŠ›ç¯å¢ƒä»·å€¼ï¼ˆå…ƒ/MWhï¼‰
      deviation_compensation_ratio: Number  // åå·®è¡¥å¿æ¯”ä¾‹ï¼ˆ%ï¼‰
    },
    // å°é¡¶ä»·æ ¼æ¡æ¬¾
    price_cap: {
      enabled: Boolean,
      reference_target: String,      // å‚è€ƒä»·æ ¼æ ‡çš„
      non_peak_markup: Number,       // éå°–å³°æœˆä»½ä¸Šæµ®ï¼ˆ%ï¼‰
      peak_markup: Number            // å°–å³°æœˆä»½ä¸Šæµ®ï¼ˆ%ï¼‰
    }
  },

  // çŠ¶æ€ç®¡ç†
  status: String,                    // "draft" | "active" | "archived"
  version: Number,                   // ç‰ˆæœ¬å·

  // æ ¡éªŒä¿¡æ¯
  validation: {
    price_ratio_compliant: Boolean,  // ä»·æ ¼æ¯”ä¾‹æ˜¯å¦ç¬¦åˆ463å·æ–‡
    warnings: [String]               // æ ¡éªŒè­¦å‘Šä¿¡æ¯
  },

  // å…ƒæ•°æ®
  created_by: String,
  created_at: Date,
  updated_at: Date,
  activated_at: Date,
  archived_at: Date
}
```

### 2.2 MongoDB é›†åˆï¼š`package_history`

ç”¨äºè®°å½•å¥—é¤çš„ç‰ˆæœ¬å†å²å’Œä¿®æ”¹è®°å½•ã€‚

```javascript
{
  _id: ObjectId,
  package_id: ObjectId,              // å…³è”çš„å¥—é¤ID
  version: Number,                   // ç‰ˆæœ¬å·
  action: String,                    // "created" | "updated" | "activated" | "archived"
  snapshot: Object,                  // å½“æ—¶çš„å®Œæ•´é…ç½®å¿«ç…§
  changed_fields: [String],          // ä¿®æ”¹çš„å­—æ®µåˆ—è¡¨
  operator: String,                  // æ“ä½œäºº
  timestamp: Date
}
```

---

## ä¸‰ã€API è®¾è®¡

### 3.1 å¥—é¤ç®¡ç† API

#### 1. è·å–å¥—é¤åˆ—è¡¨

```http
GET /api/v1/retail-packages
Query Parameters:
  - keyword: String (å¯é€‰ï¼Œæœç´¢å…³é”®å­—)
  - package_type: String (å¯é€‰ï¼Œå¥—é¤ç±»å‹ç­›é€‰)
  - pricing_mode: String (å¯é€‰ï¼Œå®šä»·æ¨¡å¼ç­›é€‰)
  - status: String (å¯é€‰ï¼ŒçŠ¶æ€ç­›é€‰)
  - page: Number (åˆ†é¡µ)
  - page_size: Number (æ¯é¡µæ•°é‡)

Response:
{
  "total": 42,
  "page": 1,
  "page_size": 20,
  "items": [
    {
      "id": "...",
      "package_name": "...",
      "package_type": "time_based",
      "pricing_mode": "fixed_linked",
      "has_green_power": true,
      "has_price_cap": true,
      "status": "active",
      "created_at": "2025-01-15T10:00:00Z",
      "updated_at": "2025-01-20T15:30:00Z"
    }
  ]
}
```

#### 2. è·å–å¥—é¤è¯¦æƒ…

```http
GET /api/v1/retail-packages/{package_id}

Response:
{
  "id": "...",
  "package_name": "...",
  "package_description": "...",
  "package_type": "time_based",
  "pricing_mode": "fixed_linked",
  "fixed_linked_config": { ... },
  "additional_terms": { ... },
  "status": "active",
  "validation": { ... },
  "created_at": "...",
  "updated_at": "..."
}
```

#### 3. åˆ›å»ºå¥—é¤

```http
POST /api/v1/retail-packages
Content-Type: application/json

Request Body:
{
  "package_name": "...",
  "package_description": "...",
  "package_type": "time_based",
  "pricing_mode": "fixed_linked",
  "fixed_linked_config": { ... },
  "additional_terms": { ... },
  "save_as_draft": true  // true=ä¿å­˜ä¸ºè‰ç¨¿ï¼Œfalse=ä¿å­˜å¹¶ç”Ÿæ•ˆ
}

Response:
{
  "id": "...",
  "status": "draft",
  "validation": {
    "price_ratio_compliant": false,
    "warnings": ["å½“å‰è‡ªå®šä¹‰ä»·æ ¼æ¯”ä¾‹ä¸æ»¡è¶³463å·æ–‡è¦æ±‚..."]
  },
  "created_at": "..."
}
```

#### 4. æ›´æ–°å¥—é¤

```http
PUT /api/v1/retail-packages/{package_id}
Content-Type: application/json

Request Body: (åŒåˆ›å»º)

Response: (åŒåˆ›å»º)
```

#### 5. å¤åˆ¶å¥—é¤

```http
POST /api/v1/retail-packages/{package_id}/copy

Response:
{
  "id": "...",  // æ–°å¥—é¤ID
  "package_name": "åŸå¥—é¤åç§° - å‰¯æœ¬",
  "status": "draft"
}
```

#### 6. æ¿€æ´»å¥—é¤

```http
POST /api/v1/retail-packages/{package_id}/activate

Response:
{
  "id": "...",
  "status": "active",
  "activated_at": "..."
}
```

#### 7. å½’æ¡£å¥—é¤

```http
POST /api/v1/retail-packages/{package_id}/archive

Response:
{
  "id": "...",
  "status": "archived",
  "archived_at": "..."
}
```

#### 8. è·å–ç‰ˆæœ¬å†å²

```http
GET /api/v1/retail-packages/{package_id}/history

Response:
{
  "total": 5,
  "items": [
    {
      "version": 3,
      "action": "updated",
      "changed_fields": ["fixed_linked_config.fixed_price.custom_prices.flat"],
      "operator": "user@example.com",
      "timestamp": "2025-01-20T15:30:00Z"
    }
  ]
}
```

### 3.2 æ ¡éªŒä¸è®¡ç®— API

#### 1. æ ¡éªŒä»·æ ¼æ¯”ä¾‹

```http
POST /api/v1/retail-packages/validate-price-ratio
Content-Type: application/json

Request Body:
{
  "peak": 500,
  "high": 480,
  "flat": 300,
  "valley": 120,
  "deep_valley": 90
}

Response:
{
  "compliant": false,
  "actual_ratios": {
    "high_to_flat": 1.6,
    "valley_to_flat": 0.4,
    "deep_valley_to_flat": 0.3
  },
  "expected_ratios": {
    "high_to_flat": 1.6,
    "valley_to_flat": 0.4,
    "deep_valley_to_flat": 0.3
  },
  "warnings": [
    "å½“å‰å³°/å¹³æ¯”ä¾‹ä¸º 1.6:1ï¼Œç¬¦åˆè¦æ±‚",
    "å½“å‰è°·/å¹³æ¯”ä¾‹ä¸º 0.4:1ï¼Œç¬¦åˆè¦æ±‚",
    "å½“å‰æ·±è°·/å¹³æ¯”ä¾‹ä¸º 0.3:1ï¼Œç¬¦åˆè¦æ±‚"
  ]
}
```

#### 2. è®¡ç®—å¥—é¤ä»·æ ¼

```http
POST /api/v1/retail-packages/calculate-price
Content-Type: application/json

Request Body:
{
  "package_id": "...",
  "date": "2025-01-15",
  "time_period": "flat",
  "volume_mwh": 100
}

Response:
{
  "fixed_price": 300,
  "linked_price": 15,
  "floating_fee": 2,
  "total_price": 317,
  "breakdown": {
    "fixed_component": 300,
    "linked_component": 15,
    "floating_component": 2
  }
}
```

---

## å››ã€å‰ç«¯ç»„ä»¶è®¾è®¡

### 4.1 ç»„ä»¶æ ‘ç»“æ„

```
RetailPackagePage
â”œâ”€â”€ PackageListView                 // å¥—é¤åˆ—è¡¨è§†å›¾
â”‚   â”œâ”€â”€ PackageToolbar              // å·¥å…·æ ï¼ˆæœç´¢/ç­›é€‰/æ–°å»ºï¼‰
â”‚   â””â”€â”€ PackageTable                // å¥—é¤è¡¨æ ¼
â”‚       â””â”€â”€ PackageRow              // å•è¡Œï¼ˆå«æ“ä½œæŒ‰é’®ï¼‰
â””â”€â”€ PackageEditorDialog             // å¥—é¤ç¼–è¾‘å¯¹è¯æ¡†
    â”œâ”€â”€ BasicInfoCard               // åŸºæœ¬ä¿¡æ¯å¡ç‰‡
    â”œâ”€â”€ PricingModeCard             // å®šä»·æ¨¡å¼å¡ç‰‡
    â”‚   â”œâ”€â”€ FixedLinkedForm         // å›ºå®š+è”åŠ¨è¡¨å•
    â”‚   â”‚   â”œâ”€â”€ FixedPriceSection   // å›ºå®šä»·æ ¼åŒº
    â”‚   â”‚   â”œâ”€â”€ LinkedPriceSection  // è”åŠ¨ä»·æ ¼åŒº
    â”‚   â”‚   â””â”€â”€ FloatingFeeSection  // æµ®åŠ¨è´¹ç”¨åŒº
    â”‚   â””â”€â”€ PriceSpreadForm         // ä»·å·®åˆ†æˆè¡¨å•
    â”‚       â”œâ”€â”€ ReferencePriceSection
    â”‚       â”œâ”€â”€ SpreadSharingSection
    â”‚       â””â”€â”€ FloatingFeeSection
    â”œâ”€â”€ AdditionalTermsCard         // é™„åŠ æ¡æ¬¾å¡ç‰‡
    â”‚   â”œâ”€â”€ GreenPowerToggle        // ç»¿ç”µå¥—é¤å¼€å…³
    â”‚   â””â”€â”€ PriceCapToggle          // å°é¡¶ä»·æ ¼å¼€å…³
    â””â”€â”€ PackageActions              // åº•éƒ¨æ“ä½œæ 
```

### 4.2 æ ¸å¿ƒç»„ä»¶è®¾è®¡

#### 1. `PackageEditorDialog.tsx`

```tsx
interface PackageEditorDialogProps {
  open: boolean;
  packageId?: string;              // ç¼–è¾‘æ¨¡å¼æ—¶ä¼ å…¥
  mode: 'create' | 'edit' | 'copy';
  onClose: () => void;
  onSave: (data: PackageFormData, asDraft: boolean) => Promise<void>;
}

export const PackageEditorDialog: React.FC<PackageEditorDialogProps> = ({
  open, packageId, mode, onClose, onSave
}) => {
  const [activeStep, setActiveStep] = useState(0);  // å¡ç‰‡åˆ‡æ¢
  const [formData, setFormData] = useState<PackageFormData>({});

  // ä½¿ç”¨ React Hook Form ç®¡ç†è¡¨å•
  const { control, handleSubmit, watch, formState: { errors } } = useForm({
    resolver: zodResolver(packageSchema),
    defaultValues: formData
  });

  // å®æ—¶æ ¡éªŒä»·æ ¼æ¯”ä¾‹
  const customPrices = watch('fixed_linked_config.fixed_price.custom_prices');
  const { data: validationResult } = useQuery(
    ['validate-price-ratio', customPrices],
    () => apiClient.post('/api/v1/retail-packages/validate-price-ratio', customPrices),
    { enabled: !!customPrices }
  );

  return (
    <Dialog open={open} onClose={onClose} maxWidth="md" fullWidth>
      <DialogTitle>
        {mode === 'create' ? 'æ–°å»ºé›¶å”®å¥—é¤' : 'ç¼–è¾‘é›¶å”®å¥—é¤'}
      </DialogTitle>

      <DialogContent>
        {/* å¡ç‰‡å¯¼èˆª */}
        <Box sx={{ borderBottom: 1, borderColor: 'divider', mb: 2 }}>
          <Tabs value={activeStep} onChange={(e, v) => setActiveStep(v)}>
            <Tab label="åŸºæœ¬ä¿¡æ¯" />
            <Tab label="å®šä»·æ¨¡å¼" />
            <Tab label="é™„åŠ æ¡æ¬¾" />
          </Tabs>
        </Box>

        {/* å¡ç‰‡å†…å®¹ */}
        {activeStep === 0 && <BasicInfoCard control={control} />}
        {activeStep === 1 && (
          <PricingModeCard
            control={control}
            validationResult={validationResult}
          />
        )}
        {activeStep === 2 && (
          <AdditionalTermsCard
            control={control}
            packageType={watch('package_type')}
          />
        )}
      </DialogContent>

      <DialogActions>
        <Button onClick={onClose}>å–æ¶ˆ</Button>
        <Button
          variant="outlined"
          onClick={handleSubmit(data => onSave(data, true))}
        >
          ä¿å­˜ä¸ºè‰ç¨¿
        </Button>
        <Button
          variant="contained"
          onClick={handleSubmit(data => onSave(data, false))}
        >
          ä¿å­˜å¹¶ç”Ÿæ•ˆ
        </Button>
      </DialogActions>
    </Dialog>
  );
};
```

#### 2. `PriceRatioValidator.tsx`

å®æ—¶ä»·æ ¼æ¯”ä¾‹æ ¡éªŒç»„ä»¶ï¼š

```tsx
interface PriceRatioValidatorProps {
  customPrices: {
    peak: number;
    high: number;
    flat: number;
    valley: number;
    deep_valley: number;
  };
}

export const PriceRatioValidator: React.FC<PriceRatioValidatorProps> = ({
  customPrices
}) => {
  const { data: validation, isLoading } = useQuery(
    ['validate-ratio', customPrices],
    () => apiClient.post('/api/v1/retail-packages/validate-price-ratio', customPrices)
  );

  if (isLoading) return <CircularProgress size={20} />;

  if (!validation?.compliant) {
    return (
      <Alert severity="warning" sx={{ mt: 2 }}>
        <AlertTitle>ä»·æ ¼æ¯”ä¾‹è­¦å‘Š</AlertTitle>
        å½“å‰è‡ªå®šä¹‰ä»·æ ¼æ¯”ä¾‹ä¸æ»¡è¶³463å·æ–‡è¦æ±‚ï¼Œç»“ç®—æ—¶å°†è‡ªåŠ¨è°ƒæ•´ä¸ºæ ‡å‡†æ¯”ä¾‹ (1.6:1:0.4:0.3)ã€‚
        <Box sx={{ mt: 1 }}>
          <Typography variant="body2">
            å®é™…æ¯”ä¾‹ï¼šå³°/å¹³={validation.actual_ratios.high_to_flat.toFixed(2)}ï¼Œ
            è°·/å¹³={validation.actual_ratios.valley_to_flat.toFixed(2)}ï¼Œ
            æ·±è°·/å¹³={validation.actual_ratios.deep_valley_to_flat.toFixed(2)}
          </Typography>
        </Box>
      </Alert>
    );
  }

  return (
    <Alert severity="success" sx={{ mt: 2 }}>
      ä»·æ ¼æ¯”ä¾‹ç¬¦åˆ463å·æ–‡è¦æ±‚
    </Alert>
  );
};
```

---

## äº”ã€å®ç°æ­¥éª¤

### é˜¶æ®µä¸€ï¼šåç«¯åŸºç¡€æ­å»ºï¼ˆ3å¤©ï¼‰

#### Day 1: æ•°æ®åº“ä¸æ•°æ®æ¨¡å‹

**ä»»åŠ¡**ï¼š
1. åˆ›å»º MongoDB é›†åˆ `retail_packages` å’Œ `package_history`
2. å®šä¹‰ Pydantic æ•°æ®æ¨¡å‹
3. å®ç°æ•°æ®æ ¡éªŒé€»è¾‘

**æ–‡ä»¶**ï¼š
- `webapp/models/retail_package.py` - Pydantic æ¨¡å‹
- `webapp/tools/package_validator.py` - æ ¡éªŒå·¥å…·ç±»

**ä»£ç ç¤ºä¾‹**ï¼š

```python
# webapp/models/retail_package.py
from pydantic import BaseModel, Field, validator
from typing import Optional, Literal
from datetime import datetime

class CustomPrices(BaseModel):
    peak: float = Field(..., ge=0, description="å°–å³°æ—¶æ®µä»·æ ¼")
    high: float = Field(..., ge=0, description="å³°æ—¶æ®µä»·æ ¼")
    flat: float = Field(..., ge=331.44, le=497.16, description="å¹³æ—¶æ®µä»·æ ¼")
    valley: float = Field(..., ge=0, description="è°·æ—¶æ®µä»·æ ¼")
    deep_valley: float = Field(..., ge=0, description="æ·±è°·æ—¶æ®µä»·æ ¼")

class FixedPriceConfig(BaseModel):
    pricing_method: Literal["custom", "reference"]
    custom_prices: Optional[CustomPrices] = None
    reference_target: Optional[str] = None
    reference_prices: Optional[dict] = None

class LinkedPriceConfig(BaseModel):
    ratio: float = Field(..., ge=0, le=0.2, description="è”åŠ¨æ¯”ä¾‹")
    target: Literal["day_ahead_avg", "real_time_avg"]

class FixedLinkedConfig(BaseModel):
    fixed_price: FixedPriceConfig
    linked_price: LinkedPriceConfig
    floating_fee: float = Field(default=0, ge=0)

class RetailPackage(BaseModel):
    package_name: str = Field(..., min_length=1, max_length=100)
    package_description: Optional[str] = None
    package_type: Literal["time_based", "non_time_based"]
    pricing_mode: Literal["fixed_linked", "price_spread"]
    fixed_linked_config: Optional[FixedLinkedConfig] = None
    # ... å…¶ä»–å­—æ®µ

    @validator('fixed_linked_config')
    def validate_pricing_config(cls, v, values):
        if values.get('pricing_mode') == 'fixed_linked' and not v:
            raise ValueError("å›ºå®š+è”åŠ¨æ¨¡å¼å¿…é¡»æä¾›é…ç½®")
        return v
```

**å®Œæˆæ ‡å‡†**ï¼š
- [x] æ‰€æœ‰ Pydantic æ¨¡å‹å®šä¹‰å®Œæˆ
- [x] ä»·æ ¼æ¯”ä¾‹æ ¡éªŒå‡½æ•°å®ç°
- [x] å•å…ƒæµ‹è¯•è¦†ç›–ç‡ > 80%

---

#### Day 2: æ ¸å¿ƒ API å®ç°

**ä»»åŠ¡**ï¼š
1. å®ç°å¥—é¤ CRUD API
2. å®ç°çŠ¶æ€è½¬æ¢ APIï¼ˆè‰ç¨¿â†’ç”Ÿæ•ˆâ†’å½’æ¡£ï¼‰
3. å®ç°æ ¡éªŒä¸è®¡ç®— API

**æ–‡ä»¶**ï¼š
- `webapp/api/v1_retail_packages.py` - è·¯ç”±å®šä¹‰
- `webapp/services/package_service.py` - ä¸šåŠ¡é€»è¾‘

**ä»£ç ç¤ºä¾‹**ï¼š

```python
# webapp/api/v1_retail_packages.py
from fastapi import APIRouter, Depends, HTTPException, status
from webapp.models.retail_package import RetailPackage, PackageStatus
from webapp.services.package_service import PackageService
from webapp.tools.mongo import DATABASE

router = APIRouter(prefix="/api/v1/retail-packages", tags=["retail_packages"])

@router.post("", response_model=dict)
async def create_package(
    package: RetailPackage,
    save_as_draft: bool = True,
    current_user: dict = Depends(get_current_active_user)
):
    """åˆ›å»ºæ–°å¥—é¤"""
    service = PackageService(DATABASE)
    result = await service.create_package(
        package_data=package.dict(),
        status="draft" if save_as_draft else "active",
        operator=current_user["username"]
    )
    return result

@router.get("", response_model=dict)
async def list_packages(
    keyword: Optional[str] = None,
    package_type: Optional[str] = None,
    status: Optional[str] = None,
    page: int = 1,
    page_size: int = 20
):
    """è·å–å¥—é¤åˆ—è¡¨"""
    service = PackageService(DATABASE)
    result = await service.list_packages(
        filters={
            "keyword": keyword,
            "package_type": package_type,
            "status": status
        },
        page=page,
        page_size=page_size
    )
    return result

@router.post("/{package_id}/activate")
async def activate_package(
    package_id: str,
    current_user: dict = Depends(get_current_active_user)
):
    """æ¿€æ´»å¥—é¤"""
    service = PackageService(DATABASE)
    result = await service.change_status(
        package_id=package_id,
        new_status="active",
        operator=current_user["username"]
    )
    return result
```

**å®Œæˆæ ‡å‡†**ï¼š
- [x] 8 ä¸ªæ ¸å¿ƒ API å®ç°å®Œæˆ
- [x] API æ–‡æ¡£è‡ªåŠ¨ç”Ÿæˆï¼ˆFastAPI Swaggerï¼‰
- [x] Postman æµ‹è¯•é€šè¿‡

---

#### Day 3: ä»·æ ¼è®¡ç®—å¼•æ“

**ä»»åŠ¡**ï¼š
1. å®ç°ä»·æ ¼æ¯”ä¾‹æ ¡éªŒç®—æ³•
2. å®ç°å›ºå®š+è”åŠ¨å®šä»·è®¡ç®—
3. å®ç°ä»·å·®åˆ†æˆå®šä»·è®¡ç®—

**æ–‡ä»¶**ï¼š
- `webapp/services/pricing_engine.py` - å®šä»·è®¡ç®—å¼•æ“

**ä»£ç ç¤ºä¾‹**ï¼š

```python
# webapp/services/pricing_engine.py
class PricingEngine:
    """é›¶å”®å¥—é¤å®šä»·è®¡ç®—å¼•æ“"""

    STANDARD_RATIOS = {
        "high_to_flat": 1.6,
        "valley_to_flat": 0.4,
        "deep_valley_to_flat": 0.3
    }

    @staticmethod
    def validate_price_ratio(custom_prices: dict) -> dict:
        """æ ¡éªŒä»·æ ¼æ¯”ä¾‹æ˜¯å¦ç¬¦åˆ463å·æ–‡"""
        flat = custom_prices['flat']
        actual_ratios = {
            "high_to_flat": round(custom_prices['high'] / flat, 2),
            "valley_to_flat": round(custom_prices['valley'] / flat, 2),
            "deep_valley_to_flat": round(custom_prices['deep_valley'] / flat, 2)
        }

        compliant = all([
            abs(actual_ratios["high_to_flat"] - PricingEngine.STANDARD_RATIOS["high_to_flat"]) < 0.01,
            abs(actual_ratios["valley_to_flat"] - PricingEngine.STANDARD_RATIOS["valley_to_flat"]) < 0.01,
            abs(actual_ratios["deep_valley_to_flat"] - PricingEngine.STANDARD_RATIOS["deep_valley_to_flat"]) < 0.01
        ])

        return {
            "compliant": compliant,
            "actual_ratios": actual_ratios,
            "expected_ratios": PricingEngine.STANDARD_RATIOS
        }

    @staticmethod
    def calculate_fixed_linked_price(
        package_config: dict,
        date: str,
        time_period: str,
        volume_mwh: float
    ) -> dict:
        """è®¡ç®—å›ºå®š+è”åŠ¨æ¨¡å¼ä»·æ ¼"""
        # 1. è·å–å›ºå®šä»·æ ¼
        fixed_price = package_config['fixed_linked_config']['fixed_price']['custom_prices'][time_period]

        # 2. è·å–è”åŠ¨ä»·æ ¼ï¼ˆä»å¸‚åœºæ•°æ®ï¼‰
        linked_ratio = package_config['fixed_linked_config']['linked_price']['ratio']
        market_price = get_market_price(date, time_period)  # ä»æ•°æ®åº“è·å–
        linked_price = market_price * linked_ratio

        # 3. æµ®åŠ¨è´¹ç”¨
        floating_fee = package_config['fixed_linked_config']['floating_fee']

        # 4. æ€»ä»·
        total_price = fixed_price + linked_price + floating_fee

        return {
            "fixed_price": fixed_price,
            "linked_price": linked_price,
            "floating_fee": floating_fee,
            "total_price": total_price,
            "breakdown": {
                "fixed_component": fixed_price,
                "linked_component": linked_price,
                "floating_component": floating_fee
            }
        }
```

**å®Œæˆæ ‡å‡†**ï¼š
- [x] ä»·æ ¼æ¯”ä¾‹æ ¡éªŒå‡†ç¡®ç‡ 100%
- [x] å®šä»·è®¡ç®—ç»“æœä¸ä¸šåŠ¡éœ€æ±‚ä¸€è‡´
- [x] å•å…ƒæµ‹è¯•è¦†ç›–æ‰€æœ‰è¾¹ç•Œæƒ…å†µ

---

### é˜¶æ®µäºŒï¼šå‰ç«¯åŸºç¡€å®ç°ï¼ˆ4å¤©ï¼‰

#### Day 4: å¥—é¤åˆ—è¡¨é¡µé¢

**ä»»åŠ¡**ï¼š
1. å®ç°å¥—é¤åˆ—è¡¨å±•ç¤º
2. å®ç°æœç´¢ä¸ç­›é€‰åŠŸèƒ½
3. å®ç°å¿«é€Ÿæ“ä½œæŒ‰é’®

**æ–‡ä»¶**ï¼š
- `frontend/src/pages/RetailPackagePage.tsx` - ä¸»é¡µé¢
- `frontend/src/components/PackageListView.tsx` - åˆ—è¡¨è§†å›¾
- `frontend/src/components/PackageTable.tsx` - è¡¨æ ¼ç»„ä»¶

**ç»„ä»¶ä»£ç **ï¼š

```tsx
// frontend/src/components/PackageTable.tsx
export const PackageTable: React.FC = () => {
  const [packages, setPackages] = useState<Package[]>([]);
  const [loading, setLoading] = useState(false);
  const [filters, setFilters] = useState({
    keyword: '',
    package_type: '',
    status: ''
  });

  useEffect(() => {
    fetchPackages();
  }, [filters]);

  const fetchPackages = async () => {
    setLoading(true);
    try {
      const response = await apiClient.get('/api/v1/retail-packages', {
        params: filters
      });
      setPackages(response.data.items);
    } finally {
      setLoading(false);
    }
  };

  const handleArchive = async (packageId: string) => {
    await apiClient.post(`/api/v1/retail-packages/${packageId}/archive`);
    fetchPackages();
  };

  return (
    <TableContainer component={Paper}>
      <Table>
        <TableHead>
          <TableRow>
            <TableCell>å¥—é¤åç§°</TableCell>
            <TableCell>å¥—é¤ç±»å‹</TableCell>
            <TableCell>å®šä»·æ¨¡å¼</TableCell>
            <TableCell>é™„åŠ å¥—é¤</TableCell>
            <TableCell>çŠ¶æ€</TableCell>
            <TableCell>åˆ›å»ºæ—¶é—´</TableCell>
            <TableCell align="right">æ“ä½œ</TableCell>
          </TableRow>
        </TableHead>
        <TableBody>
          {loading ? (
            <TableRow>
              <TableCell colSpan={7} align="center">
                <CircularProgress />
              </TableCell>
            </TableRow>
          ) : packages.map(pkg => (
            <TableRow key={pkg.id}>
              <TableCell>{pkg.package_name}</TableCell>
              <TableCell>
                <Chip
                  label={pkg.package_type === 'time_based' ? 'åˆ†æ—¶æ®µ' : 'ä¸åˆ†æ—¶æ®µ'}
                  size="small"
                />
              </TableCell>
              <TableCell>
                <Chip
                  label={pkg.pricing_mode === 'fixed_linked' ? 'å›ºå®š+è”åŠ¨' : 'ä»·å·®åˆ†æˆ'}
                  size="small"
                  color="primary"
                />
              </TableCell>
              <TableCell>
                {pkg.has_green_power && <Chip label="ç»¿ç”µ" size="small" color="success" />}
                {pkg.has_price_cap && <Chip label="å°é¡¶" size="small" color="warning" />}
              </TableCell>
              <TableCell>
                <Chip
                  label={pkg.status}
                  size="small"
                  color={pkg.status === 'active' ? 'success' : 'default'}
                />
              </TableCell>
              <TableCell>{format(new Date(pkg.created_at), 'yyyy-MM-dd HH:mm')}</TableCell>
              <TableCell align="right">
                <IconButton size="small" onClick={() => handleEdit(pkg.id)}>
                  <EditIcon />
                </IconButton>
                <IconButton size="small" onClick={() => handleCopy(pkg.id)}>
                  <ContentCopyIcon />
                </IconButton>
                <IconButton size="small" onClick={() => handleArchive(pkg.id)}>
                  <ArchiveIcon />
                </IconButton>
              </TableCell>
            </TableRow>
          ))}
        </TableBody>
      </Table>
    </TableContainer>
  );
};
```

**å®Œæˆæ ‡å‡†**ï¼š
- [x] åˆ—è¡¨æ­£å¸¸å±•ç¤º
- [x] æœç´¢å’Œç­›é€‰åŠŸèƒ½æ­£å¸¸
- [x] å¿«é€Ÿæ“ä½œæŒ‰é’®åŠŸèƒ½æ­£å¸¸

---

#### Day 5-6: å¥—é¤ç¼–è¾‘å¯¹è¯æ¡† - åŸºæœ¬ä¿¡æ¯ä¸å®šä»·æ¨¡å¼

**ä»»åŠ¡**ï¼š
1. å®ç°åŸºæœ¬ä¿¡æ¯å¡ç‰‡
2. å®ç°å›ºå®š+è”åŠ¨å®šä»·è¡¨å•
3. å®ç°ä»·æ ¼æ¯”ä¾‹å®æ—¶æ ¡éªŒ

**æ–‡ä»¶**ï¼š
- `frontend/src/components/PackageEditorDialog.tsx` - ä¸»å¯¹è¯æ¡†
- `frontend/src/components/BasicInfoCard.tsx` - åŸºæœ¬ä¿¡æ¯
- `frontend/src/components/FixedLinkedForm.tsx` - å›ºå®š+è”åŠ¨è¡¨å•
- `frontend/src/components/PriceRatioValidator.tsx` - æ¯”ä¾‹æ ¡éªŒ

**è¡¨å•ç®¡ç†**ï¼š

```tsx
// frontend/src/hooks/usePackageForm.ts
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';

const customPricesSchema = z.object({
  peak: z.number().min(0),
  high: z.number().min(0),
  flat: z.number().min(331.44).max(497.16),
  valley: z.number().min(0),
  deep_valley: z.number().min(0)
});

const packageSchema = z.object({
  package_name: z.string().min(1, 'å¥—é¤åç§°ä¸èƒ½ä¸ºç©º'),
  package_type: z.enum(['time_based', 'non_time_based']),
  pricing_mode: z.enum(['fixed_linked', 'price_spread']),
  fixed_linked_config: z.object({
    fixed_price: z.object({
      pricing_method: z.enum(['custom', 'reference']),
      custom_prices: customPricesSchema.optional()
    }),
    linked_price: z.object({
      ratio: z.number().min(0).max(0.2),
      target: z.enum(['day_ahead_avg', 'real_time_avg'])
    }),
    floating_fee: z.number().min(0).default(0)
  }).optional()
});

export const usePackageForm = (defaultValues?: any) => {
  return useForm({
    resolver: zodResolver(packageSchema),
    defaultValues: defaultValues || {
      package_type: 'time_based',
      pricing_mode: 'fixed_linked'
    }
  });
};
```

**å®Œæˆæ ‡å‡†**ï¼š
- [x] åŸºæœ¬ä¿¡æ¯è¡¨å•éªŒè¯æ­£å¸¸
- [x] å›ºå®š+è”åŠ¨è¡¨å•è”åŠ¨æ­£å¸¸
- [x] ä»·æ ¼æ¯”ä¾‹å®æ—¶æ ¡éªŒæ˜¾ç¤ºæ­£ç¡®

---

#### Day 7: é™„åŠ æ¡æ¬¾ä¸ä¿å­˜åŠŸèƒ½

**ä»»åŠ¡**ï¼š
1. å®ç°é™„åŠ æ¡æ¬¾å¡ç‰‡
2. å®ç°ä¿å­˜ä¸ºè‰ç¨¿/ä¿å­˜å¹¶ç”Ÿæ•ˆ
3. å®ç°é”™è¯¯å¤„ç†ä¸æç¤º

**æ–‡ä»¶**ï¼š
- `frontend/src/components/AdditionalTermsCard.tsx` - é™„åŠ æ¡æ¬¾
- `frontend/src/services/packageService.ts` - API è°ƒç”¨å°è£…

**å®Œæˆæ ‡å‡†**ï¼š
- [x] ç»¿ç”µå¥—é¤/å°é¡¶ä»·æ ¼å¼€å…³æ­£å¸¸
- [x] ä¿å­˜åŠŸèƒ½æ­£å¸¸ï¼Œé”™è¯¯æç¤ºæ¸…æ™°
- [x] è‰ç¨¿å’Œç”Ÿæ•ˆçŠ¶æ€åˆ‡æ¢æ­£å¸¸

---

### é˜¶æ®µä¸‰ï¼šåŠŸèƒ½å®Œå–„ä¸ä¼˜åŒ–ï¼ˆ2å¤©ï¼‰

#### Day 8: å¤åˆ¶ã€å½’æ¡£ä¸ç‰ˆæœ¬å†å²

**ä»»åŠ¡**ï¼š
1. å®ç°å¥—é¤å¤åˆ¶åŠŸèƒ½
2. å®ç°å¥—é¤å½’æ¡£åŠŸèƒ½
3. å®ç°ç‰ˆæœ¬å†å²æŸ¥çœ‹

**å®Œæˆæ ‡å‡†**ï¼š
- [x] å¤åˆ¶åŠŸèƒ½ç”Ÿæˆæ­£ç¡®çš„å‰¯æœ¬
- [x] å½’æ¡£åä¸å½±å“å†å²æ•°æ®
- [x] ç‰ˆæœ¬å†å²è®°å½•å®Œæ•´

---

#### Day 9: æµ‹è¯•ä¸ä¼˜åŒ–

**ä»»åŠ¡**ï¼š
1. ç«¯åˆ°ç«¯æµ‹è¯•
2. æ€§èƒ½ä¼˜åŒ–
3. UI/UX ä¼˜åŒ–

**æµ‹è¯•æ¸…å•**ï¼š
- [ ] åˆ›å»ºå¥—é¤ï¼ˆåˆ†æ—¶æ®µ/ä¸åˆ†æ—¶æ®µï¼‰
- [ ] ç¼–è¾‘å¥—é¤ï¼ˆå„å­—æ®µä¿®æ”¹ï¼‰
- [ ] å¤åˆ¶å¥—é¤
- [ ] æ¿€æ´»å¥—é¤ï¼ˆè‰ç¨¿â†’ç”Ÿæ•ˆï¼‰
- [ ] å½’æ¡£å¥—é¤
- [ ] ä»·æ ¼æ¯”ä¾‹æ ¡éªŒ
- [ ] æœç´¢ä¸ç­›é€‰
- [ ] ç§»åŠ¨ç«¯å“åº”å¼æµ‹è¯•

**å®Œæˆæ ‡å‡†**ï¼š
- [x] æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹é€šè¿‡
- [x] é¡µé¢åŠ è½½æ—¶é—´ < 2s
- [x] ç§»åŠ¨ç«¯ä½“éªŒè‰¯å¥½

---

## å…­ã€å…³é”®æŠ€æœ¯è¦ç‚¹

### 6.1 ä»·æ ¼æ¯”ä¾‹å®æ—¶æ ¡éªŒ

ä½¿ç”¨ React Query å®ç°é˜²æŠ–çš„å®æ—¶æ ¡éªŒï¼š

```tsx
const customPrices = watch('fixed_linked_config.fixed_price.custom_prices');

const { data: validationResult } = useQuery(
  ['validate-price-ratio', customPrices],
  () => apiClient.post('/api/v1/retail-packages/validate-price-ratio', customPrices),
  {
    enabled: !!customPrices && customPrices.flat > 0,
    staleTime: 1000,  // 1ç§’å†…ä¸é‡å¤è¯·æ±‚
    retry: false
  }
);
```

### 6.2 æ¡ä»¶è¡¨å•æ¸²æŸ“

æ ¹æ®é€‰æ‹©åŠ¨æ€æ˜¾ç¤ºè¡¨å•å†…å®¹ï¼š

```tsx
const pricingMode = watch('pricing_mode');
const packageType = watch('package_type');

return (
  <>
    {pricingMode === 'fixed_linked' && <FixedLinkedForm />}
    {pricingMode === 'price_spread' && <PriceSpreadForm />}

    {/* ç»¿ç”µå¥—é¤ä»…åœ¨åˆ†æ—¶æ®µæ—¶å¯ç”¨ */}
    <FormControlLabel
      control={<Switch />}
      label="ç»¿è‰²ç”µåŠ›å¥—é¤"
      disabled={packageType !== 'time_based'}
    />
  </>
);
```

### 6.3 å“åº”å¼è®¾è®¡

éµå¾ªé¡¹ç›® `CLAUDE.md` è§„èŒƒï¼š

```tsx
<Dialog
  open={open}
  onClose={onClose}
  maxWidth="md"
  fullWidth
  fullScreen={isMobile}  // ç§»åŠ¨ç«¯å…¨å±
>
  <DialogContent>
    <Grid container spacing={{ xs: 1, sm: 2 }}>
      <Grid size={{ xs: 12, md: 6 }}>
        {/* å†…å®¹ */}
      </Grid>
    </Grid>
  </DialogContent>
</Dialog>
```

---

## ä¸ƒã€å¼€å‘æ³¨æ„äº‹é¡¹

### 7.1 æ•°æ®å®‰å…¨

- [ ] å¥—é¤æ¿€æ´»å‰å¿…é¡»è¿›è¡Œå®Œæ•´æ€§æ ¡éªŒ
- [ ] å†å²ç‰ˆæœ¬ä¸å¯åˆ é™¤ï¼Œä»…æ”¯æŒå½’æ¡£
- [ ] æ•æ„Ÿæ“ä½œè®°å½•æ“ä½œäººå’Œæ—¶é—´æˆ³

### 7.2 æ€§èƒ½ä¼˜åŒ–

- [ ] å¥—é¤åˆ—è¡¨ä½¿ç”¨åˆ†é¡µåŠ è½½
- [ ] ä»·æ ¼æ ¡éªŒä½¿ç”¨é˜²æŠ–é¿å…é¢‘ç¹è¯·æ±‚
- [ ] è¡¨å•ä½¿ç”¨ React Hook Form å‡å°‘é‡æ¸²æŸ“

### 7.3 ç”¨æˆ·ä½“éªŒ

- [ ] æ‰€æœ‰è¡¨å•éªŒè¯æä¾›æ¸…æ™°çš„é”™è¯¯æç¤º
- [ ] ä¿å­˜æ“ä½œæ˜¾ç¤º Loading çŠ¶æ€
- [ ] å±é™©æ“ä½œï¼ˆå½’æ¡£/åˆ é™¤ï¼‰éœ€äºŒæ¬¡ç¡®è®¤

### 7.4 éµå¾ªé¡¹ç›®è§„èŒƒ

- [ ] å‰ç«¯ä¸¥æ ¼éµå¾ª `CLAUDE.md` ä¸­çš„è§„èŒƒ
- [ ] ä½¿ç”¨ Material-UI v7 Grid è¯­æ³•ï¼ˆ`size` å±æ€§ï¼‰
- [ ] ç§»åŠ¨ç«¯æ”¯æŒæ¨ªå±å…¨å±ï¼ˆå¦‚æœæœ‰å›¾è¡¨ï¼‰
- [ ] Loading çŠ¶æ€ç®¡ç†é¿å…ç»„ä»¶å¸è½½

---

## å…«ã€éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½å®Œæ•´æ€§
- [x] æ”¯æŒä¸¤ç§å¥—é¤ç±»å‹ï¼ˆåˆ†æ—¶æ®µ/ä¸åˆ†æ—¶æ®µï¼‰
- [x] æ”¯æŒä¸¤ç§å®šä»·æ¨¡å¼ï¼ˆå›ºå®š+è”åŠ¨/ä»·å·®åˆ†æˆï¼‰
- [x] æ”¯æŒä¸¤ç§é™„åŠ æ¡æ¬¾ï¼ˆç»¿ç”µ/å°é¡¶ä»·ï¼‰
- [x] æ”¯æŒå®Œæ•´çš„å¥—é¤ç”Ÿå‘½å‘¨æœŸï¼ˆè‰ç¨¿â†’ç”Ÿæ•ˆâ†’å½’æ¡£ï¼‰

### æ ¡éªŒå‡†ç¡®æ€§
- [x] ä»·æ ¼æ¯”ä¾‹æ ¡éªŒç¬¦åˆ463å·æ–‡è¦æ±‚
- [x] è¡¨å•éªŒè¯è¦†ç›–æ‰€æœ‰å¿…å¡«å­—æ®µ
- [x] è¾¹ç•Œå€¼æ ¡éªŒå‡†ç¡®ï¼ˆå¦‚å¹³æ—¶æ®µä»·æ ¼èŒƒå›´ï¼‰

### æ€§èƒ½è¦æ±‚
- [x] åˆ—è¡¨åŠ è½½æ—¶é—´ < 2s
- [x] ä¿å­˜æ“ä½œå“åº”æ—¶é—´ < 1s
- [x] ä»·æ ¼æ ¡éªŒå“åº”æ—¶é—´ < 500ms

### ä»£ç è´¨é‡
- [x] å•å…ƒæµ‹è¯•è¦†ç›–ç‡ > 80%
- [x] æ—  TypeScript ç±»å‹é”™è¯¯
- [x] æ—  ESLint è­¦å‘Š

---

## ä¹ã€åç»­æ‰©å±•

### çŸ­æœŸæ‰©å±•ï¼ˆ1-2å‘¨ï¼‰
- [ ] å¥—é¤å¯¹æ¯”åŠŸèƒ½
- [ ] æ‰¹é‡å¯¼å…¥/å¯¼å‡º
- [ ] å¥—é¤æ¨¡æ¿åŠŸèƒ½

### ä¸­æœŸæ‰©å±•ï¼ˆ1-2æœˆï¼‰
- [ ] ä»·æ ¼èµ°åŠ¿é¢„æµ‹
- [ ] å¥—é¤æ”¶ç›Šåˆ†æ
- [ ] ç”¨æˆ·å¥—é¤ç»‘å®š

### é•¿æœŸè§„åˆ’ï¼ˆ3æœˆ+ï¼‰
- [ ] AI æ™ºèƒ½å®šä»·æ¨è
- [ ] å¥—é¤ç»„åˆä¼˜åŒ–
- [ ] å®æ—¶å¸‚åœºä»·æ ¼è”åŠ¨
