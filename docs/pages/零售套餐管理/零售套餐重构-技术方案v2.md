# 零售套餐新建编辑功能重构 - 技术方案 v2

## 一、需求概述

### 1.1 核心变更
1. **绿色电力套餐类型化**：将绿电从附加条款改为独立的套餐类型
2. **封顶价格条款**：新增不可编辑的封顶价格说明

### 1.2 业务规则
1. **绿色电力套餐**
   - 作为独立的 `package_type`（与"分时段"、"不分时段"并列）
   - 选择时自动启用绿电配置
   - 显示红色警告文字："按照所代理零售用户月度零售套餐约定的绿色电力环境价值从高到低进行排序，交易电量优先分配环境价值高的零售用户"
   - 问号提示文本：
     ```
     1. 套餐选择开启绿电合同，用户下单时需录入绿电合同电量，售电公司在批发侧成交的绿电合同电量按此电量等比例分摊给签署了绿电套餐的零售用户。
     2. 按照绿电交易"优先交易、优先出清、优先执行、优先结算"原则，绿电交易的电能量优先常规交易电量能结算。
     3. 售电公司通过批侧成交的绿电合同的电能量价、环境价值直接传递给零售用户，零售用户分时绿电结算量、结算价根据其用电量、各绿电合同电量、各合同对应电厂上网电量三者取小确定。
     ```

2. **封顶价格条款**
   - 不可编辑，仅在详情和编辑页面显示
   - 文本内容：`零售用户月度结算均价封顶，零售用户月度结算均价对比参考价（按照电网代理购电发布的电力市场月度交易均价(当月平均上网电价)）上浮不超过5%(非尖峰月份）、上浮不超过10%（尖峰月份），若零售套餐结算价格高于封顶价格时，按照封顶价格结算。`

## 二、当前代码修改分析

### 2.1 已完成的修改
1. ✅ **后端模型** (`webapp/models/retail_package.py`)
   - `package_type` 类型添加了 `"green_power"` 选项

2. ✅ **前端列表页面** (`frontend/src/pages/RetailPackagePage.tsx`)
   - 筛选器添加"绿色电力套餐"选项
   - 列表显示逻辑改为基于 `package_type === 'green_power'` 判断
   - 移除了 `has_green_power` 字段（接口定义）

3. ⚠️ **前端编辑对话框** (`frontend/src/components/PackageEditorDialog.tsx`)
   - 添加了"绿色电力套餐"单选按钮
   - 添加了问号提示图标（但 `greenPowerHint` 变量未定义）
   - 添加了红色警告提示（但实现有问题）
   - 添加了自动启用绿电配置的逻辑

### 2.2 存在的问题
1. ❌ **编译错误**：`greenPowerHint` 变量未定义
2. ❌ **类型不匹配**：`usePackageForm.ts` 中 `PackageFormData.package_type` 类型未更新
3. ❌ **UI 问题**：红色警告使用 `severity="info"` 但文字想要红色（矛盾）
4. ❌ **逻辑混乱**：绿电配置显示逻辑复杂且不清晰
5. ❌ **功能缺失**：封顶价格条款未实现
6. ❌ **后端逻辑**：列表项 `has_green_power` 字段计算逻辑需调整

## 三、详细技术方案

### 3.1 后端修改

#### 3.1.1 模型层 (`webapp/models/retail_package.py`)
**已完成**，无需修改。

#### 3.1.2 列表响应逻辑
**问题**：`RetailPackageListItem` 仍有 `has_green_power` 字段，但前端已不再使用。

**解决方案**：调整计算逻辑，基于 `package_type` 或 `additional_terms.green_power.enabled` 判断。

```python
# 在构建列表项时
has_green_power = (
    package.package_type == "green_power" or
    (package.additional_terms and package.additional_terms.green_power.enabled)
)
```

### 3.2 前端修改

#### 3.2.1 类型定义 (`frontend/src/hooks/usePackageForm.ts`)
**问题**：`PackageFormData.package_type` 类型缺少 `'green_power'`

**修改**：
```typescript
export interface PackageFormData {
  package_name: string;
  package_description?: string;
  package_type: 'time_based' | 'non_time_based' | 'green_power';  // 添加 'green_power'
  // ...其他字段
}
```

#### 3.2.2 编辑对话框 (`frontend/src/components/PackageEditorDialog.tsx`)

##### (1) 添加常量定义（文件顶部）
```typescript
// 绿电提示文本
const GREEN_POWER_HINT = `1. 套餐选择开启绿电合同，用户下单时需录入绿电合同电量，售电公司在批发侧成交的绿电合同电量按此电量等比例分摊给签署了绿电套餐的零售用户。
2. 按照绿电交易"优先交易、优先出清、优先执行、优先结算"原则，绿电交易的电能量优先常规交易电量能结算。
3. 售电公司通过批侧成交的绿电合同的电能量价、环境价值直接传递给零售用户，零售用户分时绿电结算量、结算价根据其用电量、各绿电合同电量、各合同对应电厂上网电量三者取小确定。`;

// 绿电警告文字
const GREEN_POWER_WARNING = "按照所代理零售用户月度零售套餐约定的绿色电力环境价值从高到低进行排序，交易电量优先分配环境价值高的零售用户";

// 封顶价格说明
const PRICE_CAP_DESCRIPTION = "零售用户月度结算均价封顶，零售用户月度结算均价对比参考价（按照电网代理购电发布的电力市场月度交易均价(当月平均上网电价)）上浮不超过5%(非尖峰月份）、上浮不超过10%（尖峰月份），若零售套餐结算价格高于封顶价格时，按照封顶价格结算。";
```

##### (2) 修正问号提示
```typescript
// 将 greenPowerHint 改为 GREEN_POWER_HINT
<Tooltip title={GREEN_POWER_HINT} arrow>
  <IconButton size="small" sx={{ ml: 0.5 }}>
    <HelpOutlineIcon fontSize="small" />
  </IconButton>
</Tooltip>
```

##### (3) 修正红色警告提示
```typescript
// 在基本信息区域后，定价模式前插入
{packageType === 'green_power' && (
  <Alert
    severity="warning"
    sx={{
      mb: 2,
      '& .MuiAlert-message': {
        color: 'error.main',
        fontWeight: 'bold'
      }
    }}
  >
    {GREEN_POWER_WARNING}
  </Alert>
)}
```

##### (4) 简化绿电配置逻辑

**当前问题**：代码中同时使用 `greenPowerEnabled` 变量和 `packageType === 'green_power'` 判断，逻辑混乱。

**新逻辑**：
- 当 `package_type` 为 `'green_power'` 时，强制启用绿电配置（通过 useEffect）
- 当 `package_type` 为 `'time_based'` 时，允许通过 Switch 手动切换
- 当 `package_type` 为 `'non_time_based'` 时，禁用绿电配置

```typescript
// 在附加条款区域
const greenPowerEnabled = watch('additional_terms.green_power.enabled');
const isGreenPowerAutoEnabled = packageType === 'green_power';
const showGreenPowerSwitch = packageType === 'time_based';

<Paper variant="outlined" sx={{ p: 2, height: '100%' }}>
  {/* 只有分时段套餐才显示 Switch */}
  {showGreenPowerSwitch && (
    <FormControlLabel
      control={
        <Controller
          name="additional_terms.green_power.enabled"
          control={control}
          render={({ field }) => <Switch {...field} checked={field.value} />}
        />
      }
      label="绿色电力套餐"
    />
  )}

  {/* 绿电套餐类型自动启用，显示提示文本 */}
  {isGreenPowerAutoEnabled && (
    <Typography variant="body2" color="text.secondary" sx={{ mb: 2 }}>
      已自动启用绿色电力配置
    </Typography>
  )}

  {/* 显示绿电配置表单 */}
  {(greenPowerEnabled || isGreenPowerAutoEnabled) && (
    <Box sx={{ mt: 2 }}>
      {/* 月度环境价值输入 */}
      <Controller
        name="additional_terms.green_power.monthly_env_value"
        control={control}
        render={({ field }) => (
          <TextField
            {...field}
            label="月度环境价值 (元/MWh)"
            type="number"
            fullWidth
            size="small"
          />
        )}
      />

      {/* 偏差补偿比例输入 */}
      <Controller
        name="additional_terms.green_power.deviation_compensation_ratio"
        control={control}
        render={({ field }) => (
          <TextField
            {...field}
            label="偏差补偿比例 (%)"
            type="number"
            fullWidth
            size="small"
            sx={{ mt: 2 }}
          />
        )}
      />
    </Box>
  )}
</Paper>
```

##### (5) 实现封顶价格条款显示

```typescript
<Paper variant="outlined" sx={{ p: 2, height: '100%' }}>
  <Typography variant="subtitle2" gutterBottom>
    封顶价格条款
  </Typography>

  <Alert severity="info" sx={{ mt: 1 }}>
    <Typography variant="body2">
      {PRICE_CAP_DESCRIPTION}
    </Typography>
  </Alert>

  <Typography variant="caption" color="text.secondary" sx={{ mt: 1, display: 'block' }}>
    注：此条款为系统默认条款，不可编辑
  </Typography>
</Paper>
```

### 3.3 测试要点

1. **类型选择测试**
   - 选择"分时段"：可通过 Switch 切换绿电
   - 选择"不分时段"：不显示绿电 Switch
   - 选择"绿色电力套餐"：自动启用绿电配置，显示红色警告

2. **UI 显示测试**
   - 问号提示能正常显示完整文本
   - 红色警告文字颜色正确
   - 封顶价格条款正常显示

3. **数据流测试**
   - 创建绿电套餐，保存后 `package_type` 为 `'green_power'`
   - 编辑绿电套餐，绿电配置自动加载
   - 列表页面正确显示"绿电"标签

## 四、实施步骤

### Step 1: 修复 TypeScript 类型定义
- 文件：`frontend/src/hooks/usePackageForm.ts`
- 修改：`PackageFormData.package_type` 类型添加 `'green_power'`

### Step 2: 添加常量定义
- 文件：`frontend/src/components/PackageEditorDialog.tsx`
- 在文件顶部添加 `GREEN_POWER_HINT`、`GREEN_POWER_WARNING`、`PRICE_CAP_DESCRIPTION` 常量

### Step 3: 修正问号提示
- 文件：`frontend/src/components/PackageEditorDialog.tsx`
- 将 `greenPowerHint` 改为 `GREEN_POWER_HINT`

### Step 4: 修正红色警告提示
- 文件：`frontend/src/components/PackageEditorDialog.tsx`
- 在基本信息区域后插入正确的 Alert 组件

### Step 5: 重构绿电配置显示逻辑
- 文件：`frontend/src/components/PackageEditorDialog.tsx`
- 简化条件判断，清晰区分三种场景

### Step 6: 实现封顶价格条款
- 文件：`frontend/src/components/PackageEditorDialog.tsx`
- 在附加条款区域添加封顶价格说明

### Step 7: 调整后端列表逻辑
- 文件：`webapp/api/v1.py` 或相应的路由文件
- 修改 `has_green_power` 字段的计算逻辑

### Step 8: 启动前端开发服务器测试
```bash
npm start --prefix frontend > tmp\frontend_dev.log 2>&1 &
```

### Step 9: 全面测试
- 测试三种套餐类型的创建、编辑
- 验证 UI 显示正确
- 验证数据保存和加载

### Step 10: 代码审查和优化
- 检查代码规范
- 确认响应式布局
- 提交代码

## 五、风险评估

### 5.1 兼容性风险
**风险**：现有数据库中的套餐数据 `package_type` 字段只有 `'time_based'` 和 `'non_time_based'`

**缓解措施**：
- 前端列表过滤兼容旧数据
- 不强制迁移旧数据（除非有业务需求）

### 5.2 数据一致性风险
**风险**：`package_type` 和 `additional_terms.green_power.enabled` 可能不一致

**缓解措施**：
- useEffect 自动同步状态
- 后端保存时校验一致性

## 六、后续优化建议

1. **数据迁移脚本**：将旧的绿电套餐（`has_green_power=true`）迁移为 `package_type='green_power'`
2. **后端校验**：添加业务规则校验（如绿电套餐必须启用绿电配置）
3. **前端优化**：将编辑对话框拆分为更小的子组件，提升可维护性
