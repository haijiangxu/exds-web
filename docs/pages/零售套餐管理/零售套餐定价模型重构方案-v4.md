# é›¶å”®å¥—é¤å®šä»·æ¨¡å‹é‡æ„æ–¹æ¡ˆ v4

> è®¾è®¡æ—¶é—´ï¼š2025-01-07
> çŠ¶æ€ï¼šæ–¹æ¡ˆå·²æ‰¹å‡†ï¼Œå¾…å®æ–½

## ä¸€ã€ç°çŠ¶åˆ†æ

### 1.1 å½“å‰æ¨¡å‹çš„å±€é™æ€§
- ä»…æ”¯æŒ2ç§å®šä»·æ¨¡å¼ï¼š`fixed_linked`ï¼ˆå›ºå®š+è”åŠ¨ï¼‰å’Œ `price_spread`ï¼ˆä»·å·®åˆ†æˆï¼‰
- ç¼ºå°‘å¯¹"æµ®åŠ¨è´¹ç”¨"å’Œ"æµ®åŠ¨ä»·"çš„åŒºåˆ†
- æ²¡æœ‰æ”¯æŒ"å•ä¸€ç»¼åˆä»·"æ¨¡å‹
- å‚è€ƒä»·é€‰é¡¹æœ‰é™
- ç¼ºå°‘å¯¹"ä»·å·®å…¬å¼"ç±»å‹çš„æ”¯æŒ

### 1.2 ç›®æ ‡æ¨¡å‹ç»“æ„ï¼ˆ16ç§ï¼‰

**ä¸åˆ†æ—¶æ¨¡å‹ï¼ˆ8ç§ï¼‰**ï¼š
1. å›ºå®šä»·æ ¼+è”åŠ¨ä»·æ ¼+æµ®åŠ¨è´¹ç”¨
2. å›ºå®šä»·æ ¼+è”åŠ¨ä»·æ ¼+æµ®åŠ¨ä»·
3. å‚è€ƒä»·+è”åŠ¨ä»·æ ¼+æµ®åŠ¨è´¹ç”¨
4. å‚è€ƒä»·+è”åŠ¨ä»·æ ¼+æµ®åŠ¨ä»·
5. ä»·å·®åˆ†æˆ+æµ®åŠ¨è´¹ç”¨
6. ä»·å·®åˆ†æˆ+æµ®åŠ¨ä»·
7. ä»·å·®åˆ†æˆ+æµ®åŠ¨è´¹ç”¨ï¼ˆä»·å·®å…¬å¼ï¼‰
8. ä»·å·®åˆ†æˆ+æµ®åŠ¨ä»·ï¼ˆä»·å·®å…¬å¼ï¼‰

**åˆ†æ—¶æ¨¡å‹ï¼ˆ8ç§ï¼‰**ï¼š
1-6: ä¸ä¸åˆ†æ—¶æ¨¡å‹1-6å¯¹åº”
7-8: ä»·å·®åˆ†æˆ+æµ®åŠ¨è´¹ç”¨/ä»·ï¼ˆä»·å·®å…¬å¼ï¼‰
9. å•ä¸€ç»¼åˆä»·_å›ºå®šä»·
10. å•ä¸€ç»¼åˆä»·_å‚è€ƒä»·

---

## äºŒã€æ ¸å¿ƒè®¾è®¡æ€è·¯

### 2.1 æ•°æ®æ¨¡å‹è®¾è®¡ï¼ˆæ··åˆæ–¹æ¡ˆï¼‰

**æ¨èæ··åˆæ–¹æ¡ˆçš„åŸå› **ï¼š
- âœ… **æ¨¡å‹å…ƒæ•°æ®å­˜å‚¨åœ¨æ•°æ®åº“**ï¼šæ¨¡å‹åç§°ã€è®¡ç®—å…¬å¼ã€å¥—é¤è¯´æ˜ï¼ˆä¾¿äºæŸ¥è¯¢å’Œå±•ç¤ºï¼‰
- âœ… **å‚æ•°å®šä¹‰ç¡¬ç¼–ç åœ¨ä»£ç **ï¼šç±»å‹å®šä¹‰ã€æ ¡éªŒè§„åˆ™ã€è®¡ç®—é€»è¾‘ï¼ˆç¡®ä¿ç±»å‹å®‰å…¨ï¼‰
- âœ… **UIæ•ˆæœæœ€ä½³**ï¼šå‰ç«¯å¯ä»¥ç›´æ¥æ ¹æ®æ¨¡å‹IDæ¸²æŸ“å¯¹åº”çš„è¡¨å•ï¼Œæ— éœ€åŠ¨æ€è§£æå¤æ‚å…¬å¼

### 2.2 æ¨¡å‹åˆ†ç±»ç­–ç•¥

é‡‡ç”¨**ä¸‰å±‚åˆ†ç±»**ï¼š
1. **ç¬¬ä¸€å±‚ï¼šåˆ†æ—¶ç»´åº¦** - `package_type: 'time_based' | 'non_time_based'`
2. **ç¬¬äºŒå±‚ï¼šå®šä»·æ¨¡å¼** - `pricing_mode: string`ï¼ˆæ¨¡å‹å”¯ä¸€æ ‡è¯†ï¼‰
3. **ç¬¬ä¸‰å±‚ï¼šæµ®åŠ¨ç±»å‹** - `floating_type: 'fee' | 'price'`ï¼ˆè´¹ç”¨ vs å›ºå®šä»·ï¼‰

**å®šä»·æ¨¡å¼æšä¸¾**ï¼š
```typescript
pricing_mode:
  | 'fixed_linked'           // å›ºå®šä»·æ ¼+è”åŠ¨ä»·æ ¼
  | 'reference_linked'       // å‚è€ƒä»·+è”åŠ¨ä»·æ ¼
  | 'price_spread_simple'    // ä»·å·®åˆ†æˆï¼ˆç®€å•ï¼‰
  | 'price_spread_formula'   // ä»·å·®åˆ†æˆï¼ˆä»·å·®å…¬å¼ï¼‰
  | 'single_comprehensive'   // å•ä¸€ç»¼åˆä»·ï¼ˆä»…åˆ†æ—¶ï¼‰
```

---

## ä¸‰ã€æŠ€æœ¯å®ç°æ–¹æ¡ˆ

### 3.1 åç«¯æ•°æ®æ¨¡å‹é‡æ„

#### 3.1.1 æ–°å¢æ¨¡å‹é…ç½®é›†åˆï¼ˆæ•°æ®åº“ï¼‰

```python
# æ–°å¢é›†åˆï¼špricing_modelsï¼ˆå®šä»·æ¨¡å‹é…ç½®ï¼‰
{
  "_id": ObjectId,
  "model_code": "fixed_linked_fee_non_time",  # æ¨¡å‹å”¯ä¸€æ ‡è¯†
  "display_name": "å›ºå®šä»·æ ¼+è”åŠ¨ä»·æ ¼+æµ®åŠ¨è´¹ç”¨ï¼ˆå¸¸è§„ï¼‰",
  "package_type": "non_time_based",
  "pricing_mode": "fixed_linked",
  "floating_type": "fee",
  "formula": "é›¶å”®ç”¨æˆ·ç»“ç®—ä»·æ ¼=...",  # è®¡ç®—å…¬å¼æ–‡æœ¬
  "description": "1ã€æœ¬å¥—é¤è®¾ç½®...",  # å¥—é¤è¯´æ˜HTML
  "enabled": true,
  "sort_order": 1
}
```

#### 3.1.2 RetailPackageæ¨¡å‹é‡æ„

```python
class RetailPackage(BaseMongoModel):
    # åŸºæœ¬ä¿¡æ¯
    package_name: str
    package_type: Literal["time_based", "non_time_based"]
    pricing_mode: str  # å®šä»·æ¨¡å¼æ ‡è¯†ï¼ˆå¦‚ 'fixed_linked'ï¼‰
    model_code: str  # å®Œæ•´æ¨¡å‹ä»£ç ï¼ˆå¦‚ 'fixed_linked_fee_non_time'ï¼‰

    # ä»·æ ¼é…ç½®ï¼ˆæ ¹æ®æ¨¡å‹åŠ¨æ€ä½¿ç”¨ï¼‰
    pricing_config: dict  # ç»Ÿä¸€çš„é…ç½®å­—å…¸

    # ç»¿ç”µé…ç½®
    is_green_power: bool = False
    green_power_config: Optional[GreenPowerConfig] = None

    # çŠ¶æ€å’Œå…ƒæ•°æ®
    status: Literal["draft", "active", "archived"] = "draft"
    validation: Optional[ValidationResult] = None
    # ... å…¶ä»–å­—æ®µ
```

#### 3.1.3 å®šä»·é…ç½®ç»“æ„ï¼ˆpricing_configï¼‰

é‡‡ç”¨**æ‰å¹³åŒ–å­—å…¸ç»“æ„**ï¼Œæ ¹æ®ä¸åŒæ¨¡å‹åŒ…å«ä¸åŒå­—æ®µï¼š

```python
# ç¤ºä¾‹1: å›ºå®šä»·æ ¼+è”åŠ¨ä»·æ ¼+æµ®åŠ¨è´¹ç”¨ï¼ˆä¸åˆ†æ—¶ï¼‰
pricing_config = {
    # å›ºå®šä»·æ ¼éƒ¨åˆ†
    "fixed_price_value": 0.42,  # å…ƒ/kWh

    # è”åŠ¨ä»·æ ¼éƒ¨åˆ†
    "linked_ratio": 15,  # %
    "linked_target": "day_ahead_avg",  # æ—¥å‰/å®æ—¶å¸‚åœºå‡ä»·

    # æµ®åŠ¨è´¹ç”¨éƒ¨åˆ†
    "floating_fee": 5000,  # å…ƒï¼ˆæœˆåº¦æ€»é¢ï¼‰
}

# ç¤ºä¾‹2: å‚è€ƒä»·+è”åŠ¨ä»·æ ¼+æµ®åŠ¨ä»·ï¼ˆåˆ†æ—¶ï¼‰
pricing_config = {
    # å‚è€ƒä»·éƒ¨åˆ†
    "reference_type": "grid_agency_price",  # å‚è€ƒæ ‡çš„ç±»å‹
    "reference_snapshot": {...},  # å‚è€ƒä»·å¿«ç…§

    # è”åŠ¨ä»·æ ¼éƒ¨åˆ†
    "linked_ratio": 20,  # %
    "linked_target": "real_time_avg",

    # æµ®åŠ¨ä»·éƒ¨åˆ†
    "floating_price": 0.05,  # å…ƒ/kWhï¼ˆå›ºå®šå•ä»·ï¼‰
}

# ç¤ºä¾‹3: ä»·å·®åˆ†æˆ+æµ®åŠ¨è´¹ç”¨ï¼ˆä»·å·®å…¬å¼ï¼Œåˆ†æ—¶ï¼‰
pricing_config = {
    # ä»·å·®å…¬å¼éƒ¨åˆ†
    "reference_1_type": "market_monthly_avg",  # å‚è€ƒä»·1
    "reference_2_type": "grid_agency_price",   # å‚è€ƒä»·2
    "reference_3_type": "wholesale_settlement",# å‚è€ƒä»·3

    # åˆ†æˆæ¯”ä¾‹
    "sharing_ratio": 0.5,  # 50%

    # æµ®åŠ¨è´¹ç”¨
    "floating_fee": 8000,  # å…ƒ
}

# ç¤ºä¾‹4: å•ä¸€ç»¼åˆä»·_å›ºå®šä»·ï¼ˆåˆ†æ—¶ï¼‰
pricing_config = {
    "single_price_type": "fixed",  # fixed | reference
    "single_price_value": 0.45,  # å¹³æ®µåŸºå‡†ä»·
    # è‡ªåŠ¨æŒ‰æ”¿ç­–æ¯”ä¾‹æµ®åŠ¨ï¼špeak=0.72, high=0.45*1.6, valley=0.45*0.4...
}
```

### 3.2 å‰ç«¯é‡æ„æ–¹æ¡ˆ

#### 3.2.1 æ¨¡å‹é€‰æ‹©æµç¨‹

```typescript
// Step 1: ç”¨æˆ·é€‰æ‹©åˆ†æ—¶ç»´åº¦
package_type: 'time_based' | 'non_time_based'

// Step 2: è·å–è¯¥ç»´åº¦ä¸‹çš„å¯ç”¨æ¨¡å‹åˆ—è¡¨
GET /api/v1/pricing-models?package_type={package_type}

// Step 3: ç”¨æˆ·é€‰æ‹©å…·ä½“æ¨¡å‹
model_code: 'fixed_linked_fee_time'

// Step 4: æ ¹æ®model_codeåŠ¨æ€æ¸²æŸ“è¡¨å•
<PricingConfigForm modelCode={modelCode} />
```

#### 3.2.2 åŠ¨æ€è¡¨å•ç»„ä»¶è®¾è®¡

```typescript
// PricingConfigForm.tsx
interface PricingConfigFormProps {
  modelCode: string;
  control: Control<PackageFormData>;
}

export const PricingConfigForm: React.FC<PricingConfigFormProps> = ({ modelCode, control }) => {
  // æ ¹æ®modelCodeæ¸²æŸ“ä¸åŒçš„è¡¨å•ç»„ä»¶
  switch (modelCode) {
    case 'fixed_linked_fee_non_time':
      return <FixedLinkedFeeForm control={control} isTimeBased={false} />;

    case 'reference_linked_price_time':
      return <ReferenceLinkedPriceForm control={control} isTimeBased={true} />;

    case 'price_spread_formula_fee_time':
      return <PriceSpreadFormulaForm control={control} isTimeBased={true} />;

    case 'single_comprehensive_fixed_time':
      return <SingleComprehensiveForm control={control} priceType="fixed" />;

    // ... å…¶ä»–16ç§æ¨¡å‹

    default:
      return <Alert severity="error">æœªçŸ¥çš„å®šä»·æ¨¡å‹</Alert>;
  }
};
```

#### 3.2.3 è¡¨å•ç»„ä»¶ç¤ºä¾‹

```typescript
// FixedLinkedFeeForm.tsx - å›ºå®šä»·æ ¼+è”åŠ¨ä»·æ ¼+æµ®åŠ¨è´¹ç”¨
const FixedLinkedFeeForm: React.FC<FormProps> = ({ control, isTimeBased }) => {
  return (
    <Grid container spacing={2}>
      {/* å›ºå®šä»·æ ¼éƒ¨åˆ† */}
      <Grid size={{ xs: 12 }}>
        <Paper variant="outlined" sx={{ p: 2 }}>
          <Typography variant="h6">å›ºå®šä»·æ ¼</Typography>
          {isTimeBased ? (
            // åˆ†æ—¶ï¼šéœ€è¦è¾“å…¥å„æ—¶æ®µä»·æ ¼
            <>
              <Controller name="pricing_config.fixed_price_peak" ... />
              <Controller name="pricing_config.fixed_price_high" ... />
              <Controller name="pricing_config.fixed_price_flat" ... />
              <Controller name="pricing_config.fixed_price_valley" ... />
              <Controller name="pricing_config.fixed_price_deep_valley" ... />
            </>
          ) : (
            // ä¸åˆ†æ—¶ï¼šè¾“å…¥å•ä¸€ä»·æ ¼
            <Controller name="pricing_config.fixed_price_value" ... />
          )}
          <FormHelperText>ä¸Šé™ä¸é«˜äº0.49716å…ƒ/kWhï¼Œä¸‹é™ä¸ä½äº0.33144å…ƒ/kWh</FormHelperText>
        </Paper>
      </Grid>

      {/* è”åŠ¨ä»·æ ¼éƒ¨åˆ† */}
      <Grid size={{ xs: 12 }}>
        <Paper variant="outlined" sx={{ p: 2 }}>
          <Typography variant="h6">è”åŠ¨ä»·æ ¼</Typography>
          <Controller
            name="pricing_config.linked_ratio"
            render={({ field }) => (
              <TextField
                {...field}
                label="è”åŠ¨ç”µé‡æ¯”ä¾‹ (%)"
                type="number"
                helperText={isTimeBased ? "10%-20%" : "ä¸é«˜äº20%"}
              />
            )}
          />
          <Controller
            name="pricing_config.linked_target"
            render={({ field }) => (
              <Select {...field} label="è”åŠ¨æ ‡çš„">
                <MenuItem value="day_ahead_avg">
                  æ—¥å‰å¸‚åœºå‡ä»·{isTimeBased ? 'ï¼ˆåˆ†æ—¶ï¼‰' : ''}
                </MenuItem>
                <MenuItem value="real_time_avg">
                  å®æ—¶å¸‚åœºå‡ä»·{isTimeBased ? 'ï¼ˆåˆ†æ—¶ï¼‰' : ''}
                </MenuItem>
              </Select>
            )}
          />
        </Paper>
      </Grid>

      {/* æµ®åŠ¨è´¹ç”¨éƒ¨åˆ† */}
      <Grid size={{ xs: 12 }}>
        <Paper variant="outlined" sx={{ p: 2 }}>
          <Typography variant="h6">æµ®åŠ¨è´¹ç”¨</Typography>
          <Controller
            name="pricing_config.floating_fee"
            render={({ field }) => (
              <TextField
                {...field}
                label="æœˆåº¦æ€»æµ®åŠ¨è´¹ç”¨ (å…ƒ)"
                type="number"
                helperText="ç»“ç®—æ—¶è‡ªåŠ¨é™¤ä»¥æœˆåº¦ç”¨ç”µé‡"
              />
            )}
          />
        </Paper>
      </Grid>
    </Grid>
  );
};
```

### 3.3 APIæ¥å£è®¾è®¡

#### 3.3.1 æ–°å¢æ¥å£

```python
# è·å–å®šä»·æ¨¡å‹åˆ—è¡¨
GET /api/v1/pricing-models
Queryå‚æ•°:
  - package_type: time_based | non_time_basedï¼ˆå¯é€‰ï¼‰
  - enabled: true | falseï¼ˆå¯é€‰ï¼‰

å“åº”:
[
  {
    "model_code": "fixed_linked_fee_non_time",
    "display_name": "å›ºå®šä»·æ ¼+è”åŠ¨ä»·æ ¼+æµ®åŠ¨è´¹ç”¨ï¼ˆå¸¸è§„ï¼‰",
    "package_type": "non_time_based",
    "pricing_mode": "fixed_linked",
    "floating_type": "fee",
    "formula": "...",
    "description": "..."
  },
  ...
]

# è·å–å•ä¸ªæ¨¡å‹è¯¦æƒ…
GET /api/v1/pricing-models/{model_code}

# éªŒè¯å®šä»·é…ç½®
POST /api/v1/pricing-models/{model_code}/validate
Body: { pricing_config: {...} }
å“åº”: { valid: boolean, errors: [...], warnings: [...] }
```

#### 3.3.2 ä¿®æ”¹ç°æœ‰æ¥å£

```python
# åˆ›å»º/æ›´æ–°å¥—é¤æ¥å£ä¿æŒä¸å˜
POST /api/v1/retail-packages
PUT /api/v1/retail-packages/{id}

# ä½†è¯·æ±‚ä½“ç»“æ„å˜åŒ–ï¼š
{
  "package_name": "æµ‹è¯•å¥—é¤",
  "package_type": "time_based",
  "model_code": "fixed_linked_fee_time",  # æ–°å¢å­—æ®µ
  "pricing_config": {  # æ‰å¹³åŒ–é…ç½®å­—å…¸
    "fixed_price_peak": 0.60,
    "fixed_price_high": 0.50,
    ...
  },
  "is_green_power": false,
  ...
}
```

---

## å››ã€å®æ–½æ­¥éª¤

### ç¬¬ä¸€é˜¶æ®µï¼šæ•°æ®æ¨¡å‹å’ŒAPIï¼ˆåç«¯ï¼‰

#### Step 1: åˆ›å»ºå®šä»·æ¨¡å‹é…ç½®é›†åˆ
- [ ] è®¾è®¡ `pricing_models` é›†åˆç»“æ„
- [ ] ç¼–å†™æ•°æ®åˆå§‹åŒ–è„šæœ¬ï¼Œå¯¼å…¥16ç§æ¨¡å‹é…ç½®
- [ ] åˆ›å»º `PricingModel` Pydanticæ¨¡å‹

#### Step 2: é‡æ„RetailPackageæ¨¡å‹
- [ ] ä¿®æ”¹ `RetailPackage` æ¨¡å‹ï¼š
  - æ·»åŠ  `model_code` å­—æ®µ
  - åˆ é™¤ `pricing_mode`ï¼ˆæ”¹ä¸ºä»model_codeæ¨å¯¼ï¼‰
  - å°† `fixed_linked_config` å’Œ `price_spread_config` åˆå¹¶ä¸º `pricing_config: dict`
- [ ] æ›´æ–°æ•°æ®åº“ç´¢å¼•ï¼ˆæ·»åŠ model_codeç´¢å¼•ï¼‰

#### Step 3: å®ç°æ¨¡å‹ç®¡ç†API
- [ ] `GET /api/v1/pricing-models` - è·å–æ¨¡å‹åˆ—è¡¨
- [ ] `GET /api/v1/pricing-models/{model_code}` - è·å–æ¨¡å‹è¯¦æƒ…
- [ ] `POST /api/v1/pricing-models/{model_code}/validate` - éªŒè¯é…ç½®

#### Step 4: æ›´æ–°å¥—é¤CRUDæ¥å£
- [ ] ä¿®æ”¹ `package_service.py`ï¼š
  - é€‚é…æ–°çš„ `pricing_config` ç»“æ„
  - æ ¹æ® `model_code` è¿›è¡Œä¸åŒçš„æ ¡éªŒé€»è¾‘
- [ ] æ›´æ–°åˆ—è¡¨æ¥å£ï¼ˆæ·»åŠ model_codeè¿”å›ï¼‰

### ç¬¬äºŒé˜¶æ®µï¼šå‰ç«¯é‡æ„

#### Step 5: åˆ›å»ºå®šä»·æ¨¡å‹é€‰æ‹©æµç¨‹
- [ ] ä¿®æ”¹ `PackageEditorDialog.tsx`ï¼š
  - ç¬¬ä¸€æ­¥ï¼šé€‰æ‹©åˆ†æ—¶ç»´åº¦
  - ç¬¬äºŒæ­¥ï¼šé€‰æ‹©å®šä»·æ¨¡å‹ï¼ˆä»APIè·å–å¯ç”¨åˆ—è¡¨ï¼‰
  - ç¬¬ä¸‰æ­¥ï¼šæ˜¾ç¤ºå¯¹åº”çš„é…ç½®è¡¨å•

#### Step 6: å®ç°åŠ¨æ€è¡¨å•ç»„ä»¶
- [ ] åˆ›å»º `PricingConfigForm.tsx`ï¼ˆè·¯ç”±ç»„ä»¶ï¼‰
- [ ] å®ç°16ä¸ªå…·ä½“è¡¨å•ç»„ä»¶ï¼š
  - `FixedLinkedFeeForm.tsx`
  - `FixedLinkedPriceForm.tsx`
  - `ReferenceLinkedFeeForm.tsx`
  - `ReferenceLinkedPriceForm.tsx`
  - `PriceSpreadSimpleFeeForm.tsx`
  - `PriceSpreadSimplePriceForm.tsx`
  - `PriceSpreadFormulaFeeForm.tsx`
  - `PriceSpreadFormulaPriceForm.tsx`
  - `SingleComprehensiveFixedForm.tsx`ï¼ˆä»…åˆ†æ—¶ï¼‰
  - `SingleComprehensiveReferenceForm.tsx`ï¼ˆä»…åˆ†æ—¶ï¼‰

#### Step 7: æ›´æ–°è¯¦æƒ…å±•ç¤ºç»„ä»¶
- [ ] ä¿®æ”¹ `PackageDetailsDialog.tsx`ï¼š
  - æ ¹æ® `model_code` åŠ¨æ€æ¸²æŸ“å®šä»·é…ç½®è¯¦æƒ…
  - æ˜¾ç¤ºè®¡ç®—å…¬å¼å’Œå¥—é¤è¯´æ˜

#### Step 8: æ›´æ–°åˆ—è¡¨é¡µé¢
- [ ] ä¿®æ”¹ `RetailPackagePage.tsx`ï¼š
  - åˆ—è¡¨æ˜¾ç¤ºå®šä»·æ¨¡å‹åç§°ï¼ˆä»model_codeè½¬æ¢ï¼‰
  - ç­›é€‰å™¨æ”¯æŒæŒ‰æ¨¡å‹ç­›é€‰

### ç¬¬ä¸‰é˜¶æ®µï¼šæµ‹è¯•å’Œè¿ç§»

#### Step 9: æ•°æ®è¿ç§»ï¼ˆå¯é€‰ï¼‰
- [ ] ç”±äºæ—§æ•°æ®å¯åºŸå¼ƒï¼Œæ¸…ç©ºç°æœ‰å¥—é¤æ•°æ®
- [ ] æˆ–ç¼–å†™è¿ç§»è„šæœ¬è½¬æ¢æ—§æ•°æ®æ ¼å¼

#### Step 10: æµ‹è¯•éªŒè¯
- [ ] æµ‹è¯•16ç§æ¨¡å‹çš„åˆ›å»ºå’Œç¼–è¾‘æµç¨‹
- [ ] éªŒè¯ä»·æ ¼æ ¡éªŒè§„åˆ™ï¼ˆ463å·æ–‡æ¯”ä¾‹ã€å°é¡¶ä»·æ ¼ç­‰ï¼‰
- [ ] æµ‹è¯•è¯¦æƒ…å±•ç¤ºå’Œå…¬å¼æ¸²æŸ“
- [ ] ç§»åŠ¨ç«¯å“åº”å¼æµ‹è¯•

---

## äº”ã€å…³é”®æŠ€æœ¯ç»†èŠ‚

### 5.1 å‚è€ƒä»·ç±»å‹æšä¸¾

```python
REFERENCE_TYPES = Literal[
    "market_monthly_avg",        # ç”µåŠ›å¸‚åœºæœˆåº¦äº¤æ˜“å‡ä»·(å½“æœˆå¹³å‡ä¸Šç½‘ç”µä»·)
    "grid_agency_price",         # ç”µç½‘ä»£ç†è´­ç”µä»·æ ¼
    "ceiling_price",             # ä¸Šé™ä»·
    "wholesale_settlement",      # æ‰¹å‘ä¾§ç»“ç®—å‡ä»·
    "annual_longterm_time",      # å”®ç”µä¾§å¹´åº¦ä¸­é•¿æœŸåˆ†æ—¶äº¤æ˜“ä»·æ ¼
    "monthly_settlement_avg",    # å”®ç”µä¾§æœˆåº¦ç»“ç®—åŠ æƒä»·ï¼ˆä¸åˆ†æ—¶ï¼‰
    "longterm_time",             # å”®ç”µä¾§ä¸­é•¿æœŸåˆ†æ—¶äº¤æ˜“ä»·æ ¼
]
```

### 5.2 ä»·æ ¼æ ¡éªŒè§„åˆ™

```python
class PricingValidator:
    @staticmethod
    def validate_fixed_price(price: float, is_peak: bool = False) -> ValidationResult:
        """éªŒè¯å›ºå®šä»·æ ¼ä¸Šä¸‹é™"""
        UPPER_LIMIT = 0.49716  # å…ƒ/kWh
        LOWER_LIMIT = 0.33144  # å…ƒ/kWh

        if price < LOWER_LIMIT or price > UPPER_LIMIT:
            return ValidationResult(
                valid=False,
                errors=[f"ä»·æ ¼ {price} è¶…å‡ºèŒƒå›´ [{LOWER_LIMIT}, {UPPER_LIMIT}]"]
            )
        return ValidationResult(valid=True)

    @staticmethod
    def validate_linked_ratio(ratio: float, is_time_based: bool) -> ValidationResult:
        """éªŒè¯è”åŠ¨ç”µé‡æ¯”ä¾‹"""
        if is_time_based:
            if ratio < 10 or ratio > 20:
                return ValidationResult(
                    valid=False,
                    errors=["åˆ†æ—¶å¥—é¤è”åŠ¨ç”µé‡æ¯”ä¾‹åº”åœ¨10%-20%ä¹‹é—´"]
                )
        else:
            if ratio > 20:
                return ValidationResult(
                    valid=False,
                    errors=["ä¸åˆ†æ—¶å¥—é¤è”åŠ¨ç”µé‡æ¯”ä¾‹ä¸å¾—è¶…è¿‡20%"]
                )
        return ValidationResult(valid=True)

    @staticmethod
    def validate_time_based_ratio(prices: dict) -> ValidationResult:
        """éªŒè¯463å·æ–‡åˆ†æ—¶æ¯”ä¾‹"""
        flat = prices.get('flat', 0)
        if flat == 0:
            return ValidationResult(valid=False, errors=["å¹³æ®µä»·æ ¼ä¸èƒ½ä¸º0"])

        STANDARD_RATIOS = {
            'peak_to_flat': 2.0,      # å°–å³°/å¹³ = 2.0
            'high_to_flat': 1.6,      # å³°/å¹³ = 1.6
            'valley_to_flat': 0.4,    # è°·/å¹³ = 0.4
            'deep_valley_to_flat': 0.3  # æ·±è°·/å¹³ = 0.3
        }

        actual_ratios = {
            'peak_to_flat': prices.get('peak', 0) / flat,
            'high_to_flat': prices.get('high', 0) / flat,
            'valley_to_flat': prices.get('valley', 0) / flat,
            'deep_valley_to_flat': prices.get('deep_valley', 0) / flat,
        }

        # å…è®¸0.01çš„è¯¯å·®
        compliant = all(
            abs(actual_ratios[k] - STANDARD_RATIOS[k]) < 0.01
            for k in STANDARD_RATIOS
        )

        if not compliant:
            return ValidationResult(
                valid=True,  # ä¸é˜»æ­¢ä¿å­˜ï¼Œä½†æç¤ºè­¦å‘Š
                warnings=["ä»·æ ¼æ¯”ä¾‹ä¸ç¬¦åˆ463å·æ–‡æ ‡å‡†ï¼Œç»“ç®—æ—¶å°†è‡ªåŠ¨è°ƒæ•´"],
                metadata={
                    'actual_ratios': actual_ratios,
                    'expected_ratios': STANDARD_RATIOS
                }
            )

        return ValidationResult(valid=True)
```

### 5.3 æ¨¡å‹ä»£ç å‘½åè§„èŒƒ

```
{pricing_mode}_{floating_type}_{package_type}

ç¤ºä¾‹:
- fixed_linked_fee_non_time       # å›ºå®š+è”åŠ¨+æµ®åŠ¨è´¹ç”¨ï¼ˆä¸åˆ†æ—¶ï¼‰
- reference_linked_price_time     # å‚è€ƒä»·+è”åŠ¨+æµ®åŠ¨ä»·ï¼ˆåˆ†æ—¶ï¼‰
- price_spread_formula_fee_time   # ä»·å·®åˆ†æˆ(å…¬å¼)+æµ®åŠ¨è´¹ç”¨ï¼ˆåˆ†æ—¶ï¼‰
- single_comprehensive_fixed_time # å•ä¸€ç»¼åˆä»·_å›ºå®šä»·ï¼ˆåˆ†æ—¶ï¼‰
```

---

## å…­ã€é¢„æœŸæ•ˆæœ

### 6.1 ç”¨æˆ·ä½“éªŒ
- âœ… æ”¯æŒæ‰€æœ‰16ç§å®šä»·æ¨¡å‹
- âœ… åŠ¨æ€è¡¨å•ï¼Œä»…æ˜¾ç¤ºå½“å‰æ¨¡å‹æ‰€éœ€çš„è¾“å…¥é¡¹
- âœ… æ¯ä¸ªæ¨¡å‹éƒ½å±•ç¤ºå¯¹åº”çš„è®¡ç®—å…¬å¼å’Œè¯´æ˜
- âœ… å®æ—¶æ ¡éªŒè¾“å…¥å‚æ•°çš„åˆè§„æ€§

### 6.2 å¯ç»´æŠ¤æ€§
- âœ… æ¨¡å‹é…ç½®ä¸ä¸šåŠ¡é€»è¾‘åˆ†ç¦»
- âœ… æ¯ä¸ªæ¨¡å‹å¯¹åº”ç‹¬ç«‹çš„è¡¨å•ç»„ä»¶ï¼Œæ˜“äºç»´æŠ¤
- âœ… ç±»å‹å®‰å…¨çš„é…ç½®ç»“æ„ï¼ˆTypeScript + Pydanticï¼‰

### 6.3 å¯æ‰©å±•æ€§
- âœ… æ–°å¢æ¨¡å‹åªéœ€ï¼š
  1. æ•°æ®åº“æ·»åŠ æ¨¡å‹é…ç½®
  2. å‰ç«¯åˆ›å»ºå¯¹åº”çš„è¡¨å•ç»„ä»¶
  3. åç«¯æ·»åŠ æ ¡éªŒé€»è¾‘
- âœ… æ— éœ€ä¿®æ”¹æ ¸å¿ƒæ•°æ®ç»“æ„

---

## ä¸ƒã€é£é™©å’Œæ³¨æ„äº‹é¡¹

### 7.1 æŠ€æœ¯é£é™©
- âš ï¸ 16ä¸ªè¡¨å•ç»„ä»¶å·¥ä½œé‡è¾ƒå¤§ï¼Œå»ºè®®ä¼˜å…ˆå®ç°å¸¸ç”¨æ¨¡å‹
- âš ï¸ è®¡ç®—é€»è¾‘å¤æ‚åº¦é«˜ï¼Œéœ€è¦å……åˆ†æµ‹è¯•
- âš ï¸ å‚è€ƒä»·æ•°æ®æ¥æºï¼ˆç”µç½‘ä»£è´­ä»·ã€å¸‚åœºå‡ä»·ï¼‰éœ€è¦ç¡®ä¿åŠæ—¶æ›´æ–°

### 7.2 ä¸šåŠ¡é£é™©
- âš ï¸ ä¸åŒæ¨¡å‹çš„ç»“ç®—é€»è¾‘å·®å¼‚å¤§ï¼Œéœ€è¦ä¸ä¸šåŠ¡æ–¹å……åˆ†æ²Ÿé€š
- âš ï¸ æ—§æ•°æ®åºŸå¼ƒåæ— æ³•å›é€€ï¼Œå»ºè®®å¤‡ä»½

### 7.3 å»ºè®®
- ğŸ’¡ åˆ†2-3ä¸ªè¿­ä»£å®Œæˆï¼Œæ¯æ¬¡å®Œæˆ5-6ä¸ªæ¨¡å‹
- ğŸ’¡ ä¼˜å…ˆå®ç°"å›ºå®š+è”åŠ¨"å’Œ"ä»·å·®åˆ†æˆ"ç³»åˆ—ï¼ˆæœ€å¸¸ç”¨ï¼‰
- ğŸ’¡ é¢„ç•™"è‡ªå®šä¹‰æ¨¡å‹"æ‰©å±•æ¥å£ï¼Œä¾¿äºæœªæ¥æ”¯æŒæ›´å¤æ‚çš„å®šä»·ç­–ç•¥

---

## å…«ã€é™„å½•ï¼š16ç§æ¨¡å‹å®Œæ•´æ˜ å°„è¡¨

| åºå· | æ¨¡å‹ä»£ç  | æ˜¾ç¤ºåç§° | åˆ†æ—¶ | å®šä»·æ¨¡å¼ | æµ®åŠ¨ç±»å‹ |
|------|---------|---------|------|---------|---------|
| 1 | `fixed_linked_fee_non_time` | å›ºå®šä»·æ ¼+è”åŠ¨ä»·æ ¼+æµ®åŠ¨è´¹ç”¨ï¼ˆå¸¸è§„ï¼‰ | å¦ | fixed_linked | fee |
| 2 | `fixed_linked_price_non_time` | å›ºå®šä»·æ ¼+è”åŠ¨ä»·æ ¼+æµ®åŠ¨ä»·ï¼ˆå¸¸è§„ï¼‰ | å¦ | fixed_linked | price |
| 3 | `reference_linked_fee_non_time` | å‚è€ƒä»·+è”åŠ¨ä»·æ ¼+æµ®åŠ¨è´¹ç”¨ï¼ˆå¸¸è§„ï¼‰ | å¦ | reference_linked | fee |
| 4 | `reference_linked_price_non_time` | å‚è€ƒä»·+è”åŠ¨ä»·æ ¼+æµ®åŠ¨ä»·ï¼ˆå¸¸è§„ï¼‰ | å¦ | reference_linked | price |
| 5 | `price_spread_simple_fee_non_time` | ä»·å·®åˆ†æˆ+æµ®åŠ¨è´¹ç”¨ï¼ˆå¸¸è§„ï¼‰ | å¦ | price_spread_simple | fee |
| 6 | `price_spread_simple_price_non_time` | ä»·å·®åˆ†æˆ+æµ®åŠ¨ä»·ï¼ˆå¸¸è§„ï¼‰ | å¦ | price_spread_simple | price |
| 7 | `price_spread_formula_fee_non_time` | ä»·å·®åˆ†æˆ+æµ®åŠ¨è´¹ç”¨ï¼ˆå¸¸è§„ï¼‰2 | å¦ | price_spread_formula | fee |
| 8 | `price_spread_formula_price_non_time` | ä»·å·®åˆ†æˆ+æµ®åŠ¨ä»·ï¼ˆå¸¸è§„ï¼‰2 | å¦ | price_spread_formula | price |
| 9 | `fixed_linked_fee_time` | å›ºå®šä»·æ ¼+è”åŠ¨ä»·æ ¼+æµ®åŠ¨è´¹ç”¨ï¼ˆåˆ†æ—¶ï¼‰ | æ˜¯ | fixed_linked | fee |
| 10 | `fixed_linked_price_time` | å›ºå®šä»·æ ¼+è”åŠ¨ä»·æ ¼+æµ®åŠ¨ä»·ï¼ˆåˆ†æ—¶ï¼‰ | æ˜¯ | fixed_linked | price |
| 11 | `reference_linked_fee_time` | å‚è€ƒä»·+è”åŠ¨ä»·æ ¼+æµ®åŠ¨è´¹ç”¨ï¼ˆåˆ†æ—¶ï¼‰ | æ˜¯ | reference_linked | fee |
| 12 | `reference_linked_price_time` | å‚è€ƒä»·+è”åŠ¨ä»·æ ¼+æµ®åŠ¨ä»·ï¼ˆåˆ†æ—¶ï¼‰ | æ˜¯ | reference_linked | price |
| 13 | `price_spread_simple_fee_time` | ä»·å·®åˆ†æˆ+æµ®åŠ¨è´¹ç”¨ï¼ˆåˆ†æ—¶ï¼‰ | æ˜¯ | price_spread_simple | fee |
| 14 | `price_spread_simple_price_time` | ä»·å·®åˆ†æˆ+æµ®åŠ¨ä»·ï¼ˆåˆ†æ—¶ï¼‰ | æ˜¯ | price_spread_simple | price |
| 15 | `price_spread_formula_fee_time` | ä»·å·®åˆ†æˆ+æµ®åŠ¨è´¹ç”¨ï¼ˆåˆ†æ—¶ï¼‰2 | æ˜¯ | price_spread_formula | fee |
| 16 | `price_spread_formula_price_time` | ä»·å·®åˆ†æˆ+æµ®åŠ¨ä»·ï¼ˆåˆ†æ—¶ï¼‰2 | æ˜¯ | price_spread_formula | price |
| 17 | `single_comprehensive_fixed_time` | å•ä¸€ç»¼åˆä»·_å›ºå®šä»· | æ˜¯ | single_comprehensive | - |
| 18 | `single_comprehensive_reference_time` | å•ä¸€ç»¼åˆä»·_å‚è€ƒä»· | æ˜¯ | single_comprehensive | - |

**æ³¨æ„**ï¼šå®é™…ä¸º18ç§æ¨¡å‹ï¼ˆæ–°å¢äº†2ç§å•ä¸€ç»¼åˆä»·æ¨¡å‹ï¼‰
