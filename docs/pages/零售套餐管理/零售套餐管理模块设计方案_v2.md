# 零售套餐管理模块 - 详细技术设计方案 (V2 - 增强版)

> V2 版本根据最新讨论进行了全面修订和功能增强。本文档在原V2版基础上，整合了后续新增的状态机管理和CRUD功能完善，形成最终版本。
> 
> **核心设计原则**:
> 
> 1.  **布局**: 列表页采用“上查询、下列表”的双卡片布局；新建/编辑页采用单页滚动式表单。
> 2.  **移除校验**: *（V2初始要求）* 移除了所有前端的价格比例、数据格式等实时校验逻辑。
> 3.  **功能增强 (新增)**: 新增了删除草稿、套餐名称唯一性校验、操作按钮提示等功能。
> 4.  **状态机 (新增)**: 引入了严格的状态管理机制，规范了不同状态下的允许操作。

* * *

## 一、系统架构设计

### 1.1 功能模块划分

```
零售套餐管理模块
├── 套餐列表管理
│   ├── 列表展示与筛选
│   ├── 搜索功能
│   └── 快速操作（新增/导出/编辑/复制/归档/删除）
├── 套餐配置管理 (单页表单)
│   ├── 基本信息配置
│   ├── 定价模式配置（固定+联动 / 价差分成）
│   └── 附加条款配置（绿电 / 封顶价）
└── 套餐状态管理 (状态机)
    ├── 草稿 → 生效
    ├── 草稿 → 删除
    ├── 生效 → 归档
```

### 1.2 技术栈

**前端**：

- React 18 + TypeScript
- Material-UI v7
- React Hook Form（表单管理）

**后端**：

- FastAPI（Python）
- Pydantic（数据模型）
- MongoDB（套餐数据存储）

* * *

## 二、UI 需求方案

### 2.1. 主视图（套餐列表页）

页面采用“上查询、下列表”的双卡片布局，不设页面主标题。

#### 2.1.1. 查询条件卡片

- **描述**：页面顶部的独立 `Paper` 组件，用于封装所有过滤和搜索功能。
- **查询字段**:
    - **套餐名称**: `TextField`，支持模糊搜索。
    - **套餐类型**: `Select`，选项：所有、分时段、不分时段。
    - **定价模式**: `Select`，选项：所有、固定+联动、价差分成。
    - **状态**: `Select`，选项：所有、草稿、生效、归档。
- **操作按钮**:
    - 位于卡片右侧。
    - **\[ 查询 \]** 按钮 (`variant="contained"`, `color="primary"`)。
    - **\[ 重置 \]** 按钮 (`variant="outlined"`)。

#### 2.1.2. 套餐列表卡片

- **描述**：页面下方的独立 `Paper` 组件，用于展示数据列表及其相关操作。
- **内部工具栏**:
    - 位于列表格的上方。
    - **左侧**:
        - **\[ + 新增 \]** 按钮 (`variant="contained"`, `color="primary"`)。
        - **\[ 导出 \]** 按钮 (`variant="outlined"`)。
- **数据表格 (`Table`)**:
    - **列**: 套餐名称, 套餐类型, 定价模式, 附加套餐, 状态, 创建时间, 操作。
    - **操作列**: 每行包含图标按钮，并根据\*\*状态机（详见第8节）\*\*规则进行禁用/启用。
        - `[ 编辑 ]` (EditIcon)
        - `[ 复制 ]` (ContentCopyIcon)
        - `[ 归档 ]` (ArchiveIcon)
        - `[ 删除 ]` (DeleteIcon) - *仅草稿状态可见*
- **分页组件 (`TablePagination`)**:
    - 位于表格的底部。

#### 2.1.3. UI/UX 优化 (新增)

- **操作提示 (Tooltip)**: 表格操作列中的所有图标按钮，在鼠标悬停时都应使用 `Tooltip` 组件显示其功能文字（如“编辑”、“删除”）。
- **危险操作二次确认**: 对“删除”和“归档”等不可逆或关键操作，必须弹出确认对话框，防止用户误操作。
- **操作反馈**: 所有写操作（保存、删除、归档等）完成后，应使用 `Snackbar` 组件在页面顶部给出明确的成功或失败信息。

### 2.2. 新建/编辑/查看视图

采用单页滚动式表单设计，统一桌面端和移动端体验。

- **整体布局**:
    - **桌面端**: 使用 `Dialog` 弹窗。
    - **移动端**: `Dialog` 自动切换为 `fullScreen` 全屏模式。
- **内容组织**:
    - `DialogContent` 内部是一个可滚动的容器。
    - 内容被划分为三个独立的 `Paper` 卡片区域，垂直排列，每个卡片都有明确的标题。
- **卡片一：基本信息**
    - 标题：“基本信息”。
    - 包含“套餐名称”、“套餐描述”、“套餐类型”等表单控件。
- **卡片二：定价模式**
    - 标题：“定价模式”。
    - 内部首先是“选择定价模式”的单选按钮。
    - 根据用户的选择，在当前卡片内部动态渲染“固定+联动”或“价差分成”的详细表单。
- **卡片三：附加条款**
    - 标题：“附加条款”。
    - 包含“绿色电力套餐”和“封顶价格条款”的 `Switch` 开关。
    - 启用开关后，相关的配置项会在其下方动态出现。
- **操作栏**:
    - `DialogActions` 固定在弹窗/页面的底部，始终可见。
    - 包含 `[ 取消 ]`, `[ 保存为草稿 ]`, `[ 保存并生效 ]` 按钮。

* * *

## 三、数据库设计

### 3.1 MongoDB 集合：`retail_packages`

为保证数据完整性和查询性能，建议进行以下设计：

- **唯一索引**: 为 `package_name` 字段创建唯一索引，从数据库层面杜绝重名套餐。
    
    ```javascript
    db.retail_packages.createIndex({ "package_name": 1 }, { unique: true })
    ```
    
- **集合结构**:
    

```javascript
{
  _id: ObjectId,
  package_name: String,              // 套餐名称 (唯一)
  package_description: String,       // 套餐描述
  package_type: String,              // 套餐类型："time_based" | "non_time_based"

  // 定价模式
  pricing_mode: String,              // "fixed_linked" | "price_spread"

  // 固定+联动定价模式
  fixed_linked_config: { /* ... */ },

  // 价差分成定价模式
  price_spread_config: { /* ... */ },

  // 附加条款
  additional_terms: { /* ... */ },

  // 状态管理
  status: String,                    // "draft" | "active" | "archived"

  // 校验信息
  validation: {
    price_ratio_compliant: Boolean,
    warnings: [String]
  },

  // 元数据
  created_by: String,
  created_at: Date,
  updated_by: String,
  updated_at: Date,
  activated_at: Date,
  archived_at: Date
}
```

* * *

## 四、API 设计

### 4.1 套餐管理 API

#### 1\. 获取套餐列表

`GET /api/v1/retail-packages`

- **Query Parameters**: `keyword`, `package_type`, `pricing_mode`, `status`, `page`, `page_size`

#### 2\. 获取套餐详情

`GET /api/v1/retail-packages/{package_id}`

#### 3\. 创建套餐

`POST /api/v1/retail-packages`

- **Request Body**: 包含套餐所有配置及 `save_as_draft: bool` 的 JSON 对象。
- **Success Response**: `201 Created`, `{ "id": "...", "status": "..." }`
- **Error Response**: `409 Conflict` (如果套餐名称已存在)。

#### 4\. 更新套餐

`PUT /api/v1/retail-packages/{package_id}`

- **Request Body**: 同创建。
- **Logic**: 后端服务层必须校验，只有 `draft` 状态的套餐才能被更新。
- **Error Response**: `400 Bad Request` (如果套餐不是草稿), `409 Conflict` (如果修改后的名称与其他套餐冲突)。

#### 5\. 删除套餐 (新增)

`DELETE /api/v1/retail-packages/{package_id}`

- **Logic**: 后端服务层必须校验，只有 `draft` 状态的套餐才能被删除。
- **Success Response**: `204 No Content`
- **Error Response**: `400 Bad Request` (如果套餐不是草稿)。

#### 6\. 复制套餐

`POST /api/v1/retail-packages/{package_id}/copy`

#### 7\. 激活套餐

`POST /api/v1/retail-packages/{package_id}/activate`

- **Logic**: 后端服务层校验，只有 `draft` 状态的套餐才能被激活。

#### 8\. 归档套餐

`POST /api/v1/retail-packages/{package_id}/archive`

- **Logic**: 后端服务层校验，`archived` 状态的套餐不能被再次归档。

* * *

## 五、前端组件设计

### 5.1 组件树结构

```
RetailPackagePage
├── QueryCard (Paper)
└── ListCard (Paper)
    ├── Toolbar (Box)
    └── PackageTable (Table)
        └── TableActions (包含所有操作按钮和逻辑)

PackageEditorDialog
// (内部通过辅助渲染函数构建UI)

DeleteConfirmationDialog
// (用于删除和归档的确认弹窗)

FeedbackSnackbar
// (用于操作结果的全局提示)
```

### 5.2 核心组件实现策略

#### `PackageEditorDialog.tsx`

- **单一文件实现**：组件内部通过定义多个**辅助渲染函数**（如 `renderBasicInfoSection`, `renderPricingModeSection`）来构建UI，每个函数负责渲染一个 `Paper` 卡片区域。
- **状态管理**：使用 `useForm` Hook 统一管理整个表单的数据和状态。所有辅助渲染函数都从主组件接收 `control`, `watch` 等 `useForm` 的返回对象。
- **前端校验**：浮动比例校验。**计算**峰/平、谷/平、深谷/平的比例。如果比例不符合(1.6:1:0.4:0.3)，应**立即显示一个警告信息**："当前自定义价格比例不满足463号文要求，结算时将自动调整为标准比例 (1.6:1:0.4:0.3)。"
- **错误处理**：在 `onSave` 方法中 `catch` 来自后端的错误（如409名称冲突），并在对应表单字段上显示错误信息。

#### `RetailPackagePage.tsx`

- **核心职责**：管理列表数据获取、筛选、分页、删除和归档的逻辑，以及控制 `PackageEditorDialog` 和 `DeleteConfirmationDialog` 的显示。
- **操作逻辑**：`renderTableActions` 辅助函数根据传入的套餐 `status` 决定各个 `IconButton` 的 `disabled` 状态和 `DeleteIcon` 的可见性。

* * *

## 六、响应式设计策略

为了在不同尺寸的设备上都提供最佳体验，我们将采用以下响应式策略，覆盖手机、平板和桌面端：

### 6.1 列表页 (`RetailPackagePage`)

- **桌面端与平板端 (`md` 及以上断点)**: 采用完整的双卡片布局，查询字段横向排列，列表区域显示为数据表格 (`Table`)。
- **手机端 (`sm` 及以下断点)**:
    - 查询卡片内的字段垂直堆叠。
    - 列表卡片的内容从数据表格切换为**卡片列表视图**，以优化竖屏阅读和触摸体验。

### 6.2 新建/编辑页 (`PackageEditorDialog`)

- **桌面端与平板端 (`md` 及以上断点)**:
    - 采用**弹窗 (Dialog) 模式**。
    - 表单内部的字段可以根据屏幕宽度采用**两列布局**（例如，`Grid size={{ xs: 12, md: 6 }}`），以提高信息密度，减少滚动。
- **手机端 (`sm` 及以下断点)**:
    - 采用**全屏 (fullScreen) 模式**。
    - 表单内部所有字段强制为单列垂直布局，以保证可读性。

### 6.3 策略总结

| 屏幕尺寸 | 设备类型 | 列表页 (`RetailPackagePage`) | 新建/编辑页 (`PackageEditorDialog`) |
| :--- | :--- | :--- | :--- |
| `xs`, `sm` | 手机  | **卡片列表视图** | **全屏模式**，纯垂直布局 |
| `md` | 平板电脑 | **表格视图** (同桌面) | **弹窗模式**，表单内可变为**两列布局** |
| `lg`, `xl` | 桌面电脑 | **表格视图** | **弹窗模式**，表单内为两列布局 |

* * *

## 七、开发注意事项

- **数据一致性**：后端必须对所有写操作（`create`, `update`, `delete`, `change_status`）进行严格的状态和权限校验，不能信任前端传递的数据。
- **性能优化**：列表页使用分页加载；`useForm` Hook 能有效减少表单重渲染次数。
- **用户体验**：所有操作（如保存、删除）应有明确的加载（`LoadingButton`）和反馈状态（`Snackbar`）。危险操作（删除、归档）必须有二次确认。
- **遵循项目规范**：严格遵循 `GEMINI.md` 中定义的开发规范，特别是 Material-UI v7 `Grid` 组件的 `size` 属性用法。

* * *

## 八、状态机管理 (State Machine)

为保证业务流程的严谨性，套餐状态的流转遵循以下状态机模型。此规则在前后端同时强制执行。

### 8.1. 状态定义与流转规则

| 当前状态 | 可执行操作 | 目标状态 | 描述  |
| :--- | :--- | :--- | :--- |
| **(无)** | 新建  | `草稿` / `生效` | 通过“保存为草稿”或“保存并生效”创建 |
| **草稿** | 编辑、删除、复制、激活 | `草稿` / `(已删除)` / `草稿` / `生效` | 草稿状态拥有最高自由度 |
| **生效** | 复制、归档 | `草稿` / `归档` | 生效后不可编辑或删除，只能归档 |
| **归档** | 复制  | `草稿` | 归档为最终状态，只能被复制为新的草稿 |

### 8.2. 实现策略

- **后端强制**：在 `PackageService` 的 `update_package`, `delete_package`, `change_status` 等方法中，第一步就是检查当前记录的状态是否允许执行该操作，否则直接抛出 `ValueError`，由API层转换为 `400 Bad Request`。
- **前端引导**：在 `RetailPackagePage.tsx` 的 `renderTableActions` 方法中，根据记录的 `status` 动态设置按钮的 `disabled` 属性或直接不渲染（如删除按钮），从UI上引导用户执行合法操作。

## 九、零售套餐管理模块增强方案：新增详情视图

#### 1. 核心问题
当前设计中，新建、编辑和查看共享同一个 `PackageEditorDialog` 组件。这导致了几个问题：
- **界面混淆**：用户在只想查看详情时，却看到了一个可编辑的表单，容易产生误解。
- **操作风险**：对于已生效或已归档的套餐，展示可编辑的UI元素（即使它们被禁用）在逻辑上不清晰。
- **体验不佳**：只读信息的展示方式（如文本）应比表单输入框更紧凑、更易读。

#### 2. UI/UX 改进方案

##### 2.1. 新增“套餐详情”专属视图

我们建议引入一个全新的、只读的 **`PackageDetailsDialog`** 组件，专门用于展示套餐的完整信息。

##### 2.2. 交互入口

为了访问这个新的详情视图，用户可以通过以下方式：

- **点击套餐名称**：在套餐列表的数据表格中，点击任意行的“套餐名称”字段，将打开该套餐的 `PackageDetailsDialog`。

这将使操作意图更加明确：- 点击“套餐名称” -> 打开只读详情页。
- `[ 编辑 ]` (`EditIcon`) -> 打开编辑表单（仅草稿状态可用）。

##### 2.3. 详情视图 UI 设计

新 `PackageDetailsDialog` 的设计将遵循现有编辑页的风格以保持一致性，但有以下关键区别：

1.  **整体布局**:
    - **桌面端**: 依然使用 `Dialog` 弹窗。
    - **移动端**: 自动切换为 `fullScreen` 全屏模式。
    
2.  **内容展示 (只读)**:
    - 沿用“基本信息”、“定价模式”、“附加条款”三个 `Paper` 卡片的结构。
    - **所有表单控件将被替换为纯文本展示**。我们将使用 `Grid` 布局来优雅地展示“标签-值”对，提高信息密度和可读性。
    - **示例 (基本信息卡片)**:
    ```
        基本信息
        ------------------------------------
        套餐名称:   2024年商业尖峰平谷套餐
        套餐描述:   适用于商业综合体的年度套餐...
        套餐类型:   分时段
    ```
    
3.  **操作栏 (`DialogActions`)**:
    - 底部操作栏将替换为以下按钮：
    - **`[ 关闭 ]`** (`variant=\"outlined\"`): 关闭详情弹窗。
    - **`[ 复制 ]`** (`variant=\"outlined\"`): 触发“复制套餐”流程，创建一个新的草稿。
    - **`[ 编辑 ]`** (`variant=\"contained\"`, `color=\"primary\"`): **仅在套餐为“草稿”状态时显示**。点击后，关闭详情弹窗，并立即打开该套餐的 `PackageEditorDialog` 编辑弹窗。
    
#### 3. 组件与API方案

- **新组件**:
    - `PackageDetailsDialog.tsx`: 负责获取并以只读形式渲染单个套餐的数据。
    - **组件修改**:
    - `RetailPackagePage.tsx`:
    - 修改表格中“套餐名称”列的渲染逻辑，使其可点击并触发 `PackageDetailsDialog` 的打开。
    - 添加状态和逻辑来控制 `PackageDetailsDialog` 的开关。
    - **API**:
        - 无需新增API。详情页将使用现有的 `GET /api/v1/retail-packages/{package_id}` 接口获取数据。
          
* * *