# 零售套餐新建编辑功能重构 - 技术方案 v3（正确版）

## 一、需求重新理解

### 1.1 核心变更
1. **是否分时段** 和 **是否绿电** 是两个**独立的并列属性**
   - 是否分时段：`package_type` (time_based / non_time_based)
   - 是否绿电：独立的布尔属性（如 `is_green_power`）

2. **绿电可以与分时段/不分时段自由组合**：
   - 分时段 + 绿电 ✅
   - 分时段 + 非绿电 ✅
   - 不分时段 + 绿电 ✅
   - 不分时段 + 非绿电 ✅

3. **附加条款改为"价格说明"**：
   - 删除绿电配置部分
   - 只保留封顶价格说明

### 1.2 业务规则

**绿色电力套餐**
- 在基本信息区域显示为独立的开关
- 选择时显示红色警告文字和问号提示
- 警告文字："按照所代理零售用户月度零售套餐约定的绿色电力环境价值从高到低进行排序，交易电量优先分配环境价值高的零售用户"
- 问号提示：（同原需求）

**封顶价格条款**
- 在"价格说明"部分显示
- 不可编辑，仅展示说明文本

## 二、数据结构设计

### 2.1 前端表单数据结构

```typescript
export interface PackageFormData {
  package_name: string;
  package_description?: string;
  package_type: 'time_based' | 'non_time_based';  // 只有两个值
  is_green_power: boolean;  // 新增：是否绿电
  pricing_mode: 'fixed_linked' | 'price_spread';
  fixed_linked_config?: FixedLinkedConfig;
  price_spread_config?: PriceSpreadConfig;
  green_power_config?: GreenPowerConfig;  // 绿电配置（当 is_green_power=true 时）
}

export interface GreenPowerConfig {
  monthly_env_value: number;  // 月度环境价值
  deviation_compensation_ratio: number;  // 偏差补偿比例
}
```

### 2.2 后端模型结构

```python
class RetailPackage(BaseMongoModel):
    package_name: str
    package_type: Literal["time_based", "non_time_based"]  # 只有两个值
    is_green_power: bool = False  # 新增字段
    pricing_mode: Literal["fixed_linked", "price_spread"]

    green_power_config: Optional[GreenPowerConfig] = None  # 绿电配置
    # ... 其他字段

class RetailPackageListItem(BaseMongoModel):
    package_name: str
    package_type: Literal["time_based", "non_time_based"]
    is_green_power: bool = False  # 列表中显示
    # ... 其他字段
```

## 三、UI 设计

### 3.1 基本信息区域

```
┌─ 基本信息 ────────────────────────────────────┐
│ 套餐名称: [___________]                       │
│ 套餐描述: [___________]                       │
│                                                │
│ 套餐类型:                                      │
│   ◉ 分时段零售套餐   ○ 不分时段零售套餐      │
│                                                │
│ 绿色电力: [开关] 绿色电力套餐 (?)             │
│                                                │
│ [红色警告提示 - 仅在开关开启时显示]           │
└────────────────────────────────────────────────┘
```

### 3.2 绿电配置（当开关开启时）

在基本信息下方或独立区域显示：

```
┌─ 绿色电力配置 ────────────────────────────────┐
│ 月度绿色电力环境价值 (元/MWh): [_____]        │
│ 偏差补偿比例 (%): [_____]                     │
└────────────────────────────────────────────────┘
```

### 3.3 价格说明部分（原附加条款）

```
┌─ 价格说明 ────────────────────────────────────┐
│ 【封顶价格条款】                              │
│ [说明文字 - 不可编辑]                         │
└────────────────────────────────────────────────┘
```

## 四、实施步骤

### Step 1: 回退 package_type 类型定义
**文件**：
- `frontend/src/hooks/usePackageForm.ts`
- `webapp/models/retail_package.py`

**修改**：
- 移除 `'green_power'` 选项
- 添加 `is_green_power: boolean` 字段
- 添加 `green_power_config` 配置对象

### Step 2: 重构基本信息区域
**文件**：`frontend/src/components/PackageEditorDialog.tsx`

**修改**：
- 移除"绿色电力套餐"单选按钮
- 添加"绿色电力"Switch 开关
- 添加问号提示图标
- 添加红色警告提示（条件显示）

### Step 3: 添加绿电配置区域
**位置**：基本信息区域后，定价模式前

**内容**：
- 月度环境价值输入框
- 偏差补偿比例输入框

### Step 4: 重构价格说明部分
**原名称**：附加条款
**新名称**：价格说明

**修改**：
- 删除绿电配置部分
- 删除封顶价格开关
- 只保留封顶价格说明文本

### Step 5: 更新列表页面
**文件**：`frontend/src/pages/RetailPackagePage.tsx`

**修改**：
- 筛选器移除"绿色电力套餐"选项
- 添加"绿电"筛选器（是/否）
- 列表显示基于 `is_green_power` 字段

### Step 6: 更新后端逻辑
**文件**：`webapp/services/package_service.py`

**修改**：
- 列表查询支持 `is_green_power` 筛选
- 移除 `has_green_power` 计算逻辑

### Step 7: 更新自动启用逻辑
**原逻辑**：选择"绿电套餐类型"自动启用配置
**新逻辑**：开启"绿电开关"显示配置区域

## 五、开发检查清单

### 前端
- [ ] `package_type` 类型只包含 `'time_based'` 和 `'non_time_based'`
- [ ] 添加 `is_green_power` 布尔字段
- [ ] 添加 `green_power_config` 配置对象
- [ ] 基本信息显示两个独立控制：单选按钮 + Switch
- [ ] 绿电开关开启时显示红色警告和配置表单
- [ ] 问号提示正常工作
- [ ] "附加条款"改名为"价格说明"
- [ ] 删除价格说明中的绿电配置部分

### 后端
- [ ] 模型添加 `is_green_power` 字段
- [ ] 模型添加 `green_power_config` 字段
- [ ] 列表接口支持 `is_green_power` 筛选
- [ ] 移除 `package_type` 的 `'green_power'` 选项

## 六、测试用例

1. **分时段 + 绿电**
   - 选择"分时段"，开启绿电开关
   - 填写绿电配置
   - 保存并验证

2. **不分时段 + 绿电**
   - 选择"不分时段"，开启绿电开关
   - 填写绿电配置
   - 保存并验证

3. **分时段 + 非绿电**
   - 选择"分时段"，关闭绿电开关
   - 保存并验证

4. **列表筛选**
   - 按"是否绿电"筛选
   - 验证结果正确

## 七、与 v2 方案的差异对比

| 项目 | v2（错误） | v3（正确） |
|------|-----------|-----------|
| package_type | 三个值（time_based, non_time_based, green_power） | 两个值（time_based, non_time_based） |
| 绿电控制 | package_type 的一个选项 | 独立的 is_green_power 布尔字段 |
| 基本信息UI | 三个单选按钮 | 两个单选按钮 + 一个 Switch |
| 绿电配置位置 | 附加条款区域 | 基本信息下方或独立区域 |
| 附加条款 | 包含绿电配置和封顶价格 | 改名为"价格说明"，只有封顶价格 |
