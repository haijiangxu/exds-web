# é›¶å”®å¥—é¤ç®¡ç†æ¨¡å— - åŠŸèƒ½å®Œæ•´åº¦åˆ†ææŠ¥å‘Š

> åŸºäºè®¾è®¡æ–¹æ¡ˆV2ç‰ˆæœ¬çš„ä»£ç å®ç°åˆ†æ
>
> ç”Ÿæˆæ—¶é—´ï¼š2025-11-06

---

## ä¸€ã€æ•´ä½“å®Œæˆåº¦è¯„ä¼°

**æ€»ä½“å®Œæˆåº¦ï¼š85%**

- âœ… æ ¸å¿ƒCRUDåŠŸèƒ½ï¼š100%
- âœ… çŠ¶æ€æœºç®¡ç†ï¼š100%
- âœ… UIå¸ƒå±€è®¾è®¡ï¼š95%
- âœ… å“åº”å¼è®¾è®¡ï¼š100%
- âŒ å¢å¼ºåŠŸèƒ½ï¼ˆè¯¦æƒ…è§†å›¾ï¼‰ï¼š0%
- âš ï¸ è¿‡æ»¤åŠŸèƒ½ï¼š90%ï¼ˆç¼ºå°‘pricing_modeæ”¯æŒï¼‰

---

## äºŒã€å·²å®ç°åŠŸèƒ½æ¸…å•

### 2.1 å‰ç«¯åŠŸèƒ½ï¼ˆRetailPackagePage.tsxï¼‰

#### âœ… å·²å®Œç¾å®ç°ï¼š

**1. åŒå¡ç‰‡å¸ƒå±€** - å®Œå…¨ç¬¦åˆè®¾è®¡è¦æ±‚
- æŸ¥è¯¢æ¡ä»¶å¡ç‰‡ï¼ˆPaper, variant="outlined"ï¼‰
- åˆ—è¡¨å¡ç‰‡ï¼ˆPaper, variant="outlined"ï¼‰
- æœªä½¿ç”¨é¡µé¢ä¸»æ ‡é¢˜ï¼ˆç¬¦åˆè®¾è®¡è§„èŒƒï¼‰

**2. ç­›é€‰åŠŸèƒ½**
- å¥—é¤åç§°æ¨¡ç³Šæœç´¢
- å¥—é¤ç±»å‹ä¸‹æ‹‰é€‰æ‹©ï¼ˆåˆ†æ—¶æ®µ/ä¸åˆ†æ—¶æ®µï¼‰
- å®šä»·æ¨¡å¼ä¸‹æ‹‰é€‰æ‹©ï¼ˆå›ºå®š+è”åŠ¨/ä»·å·®åˆ†æˆï¼‰
- çŠ¶æ€ä¸‹æ‹‰é€‰æ‹©ï¼ˆè‰ç¨¿/ç”Ÿæ•ˆ/å½’æ¡£ï¼‰
- æŸ¥è¯¢/é‡ç½®æŒ‰é’®

**3. æ“ä½œåŠŸèƒ½**
- âœ… æ–°å¢å¥—é¤
- âœ… ç¼–è¾‘å¥—é¤ï¼ˆä»…è‰ç¨¿çŠ¶æ€å¯ç”¨ï¼‰
- âœ… å¤åˆ¶å¥—é¤ï¼ˆæ‰€æœ‰çŠ¶æ€å¯ç”¨ï¼‰
- âœ… åˆ é™¤å¥—é¤ï¼ˆä»…è‰ç¨¿çŠ¶æ€ï¼Œå«äºŒæ¬¡ç¡®è®¤å¯¹è¯æ¡†ï¼‰
- âœ… å½’æ¡£å¥—é¤ï¼ˆä»…ç”Ÿæ•ˆçŠ¶æ€ï¼Œå«äºŒæ¬¡ç¡®è®¤å¯¹è¯æ¡†ï¼‰

**4. çŠ¶æ€æœºçº¦æŸ**ï¼ˆä»£ç ä½ç½®ï¼šç¬¬66-70è¡Œï¼‰
```typescript
const canEdit = (status: string) => status === 'draft';
const canDelete = (status: string) => status === 'draft';
const canActivate = (status: string) => status === 'draft';
const canArchive = (status: string) => status === 'active';
const canCopy = (status: string) => true; // æ‰€æœ‰çŠ¶æ€éƒ½èƒ½å¤åˆ¶
```

**5. å“åº”å¼è®¾è®¡**
- ç§»åŠ¨ç«¯ï¼ˆsmåŠä»¥ä¸‹ï¼‰ï¼šå¡ç‰‡åˆ—è¡¨è§†å›¾
- æ¡Œé¢ç«¯ï¼ˆmdåŠä»¥ä¸Šï¼‰ï¼šæ•°æ®è¡¨æ ¼è§†å›¾
- æ–­ç‚¹åˆ¤æ–­ï¼š`useMediaQuery(theme.breakpoints.down('sm'))`
- æŸ¥è¯¢å­—æ®µè‡ªé€‚åº”ï¼šç§»åŠ¨ç«¯å‚ç›´å †å ï¼Œæ¡Œé¢ç«¯æ¨ªå‘æ’åˆ—

**6. UXä¼˜åŒ–**
- Tooltipæ“ä½œæç¤ºï¼šæ‰€æœ‰å›¾æ ‡æŒ‰é’®éƒ½æœ‰æ‚¬åœæç¤ºï¼ˆç¬¬396-433è¡Œï¼‰
- Snackbarå…¨å±€åé¦ˆï¼šæˆåŠŸ/å¤±è´¥æ“ä½œæç¤ºï¼ˆç¬¬603-616è¡Œï¼‰
- åŠ è½½çŠ¶æ€æ˜¾ç¤ºï¼šCircularProgressç»„ä»¶
- ç©ºæ•°æ®å‹å¥½æç¤ºï¼š"æš‚æ— æ•°æ®"æ–‡æ¡ˆ
- åˆ†é¡µç»„ä»¶ï¼šä¸­æ–‡åŒ–æ ‡ç­¾ï¼ˆ"æ¯é¡µè¡Œæ•°"ã€"å…±Xæ¡"ï¼‰

### 2.2 ç¼–è¾‘å¯¹è¯æ¡†ï¼ˆPackageEditorDialog.tsxï¼‰

#### âœ… å·²å®Œç¾å®ç°ï¼š

**1. ä¸‰ç§æ¨¡å¼æ”¯æŒ**
- `create` - æ–°å»ºå¥—é¤
- `edit` - ç¼–è¾‘è‰ç¨¿
- `copy` - å¤åˆ¶å¥—é¤ï¼ˆè‡ªåŠ¨ç”Ÿæˆå‰¯æœ¬åç§°ï¼‰

**2. å•é¡µæ»šåŠ¨å¼è¡¨å•** - ä¸‰ä¸ªPaperå¡ç‰‡åŒºåŸŸ
- **åŸºæœ¬ä¿¡æ¯å¡ç‰‡**ï¼ˆç¬¬57-99è¡Œï¼‰
  - å¥—é¤åç§°ï¼ˆå¿…å¡«ï¼Œå«é”™è¯¯æç¤ºï¼‰
  - å¥—é¤ç±»å‹ï¼ˆå•é€‰ï¼šåˆ†æ—¶æ®µ/ä¸åˆ†æ—¶æ®µï¼‰

- **å®šä»·æ¨¡å¼å¡ç‰‡**ï¼ˆç¬¬101-435è¡Œï¼‰
  - å®šä»·æ¨¡å¼é€‰æ‹©ï¼ˆå•é€‰ï¼‰
  - å›ºå®š+è”åŠ¨é…ç½®ï¼ˆæ¡ä»¶æ¸²æŸ“ï¼‰
  - ä»·å·®åˆ†æˆé…ç½®ï¼ˆæ¡ä»¶æ¸²æŸ“ï¼‰

- **é™„åŠ æ¡æ¬¾å¡ç‰‡**ï¼ˆç¬¬437-525è¡Œï¼‰
  - ç»¿è‰²ç”µåŠ›å¥—é¤ï¼ˆSwitchå¼€å…³ + é…ç½®é¡¹ï¼‰
  - å°é¡¶ä»·æ ¼æ¡æ¬¾ï¼ˆSwitchå¼€å…³ + é…ç½®é¡¹ï¼‰

**3. åŠ¨æ€è¡¨å•æ¸²æŸ“**

**å›ºå®š+è”åŠ¨å®šä»·é…ç½®**ï¼ˆç¬¬159-330è¡Œï¼‰
- å›ºå®šä»·æ ¼éƒ¨åˆ†ï¼š
  - å®šä»·æ–¹å¼é€‰æ‹©ï¼ˆè‡ªå®šä¹‰ä»·æ ¼/æŒ‰å‚è€ƒä»·ï¼‰
  - è‡ªå®šä¹‰ä»·æ ¼ï¼š5ä¸ªæ—¶æ®µä»·æ ¼è¾“å…¥ï¼ˆä»…åˆ†æ—¶æ®µå¥—é¤æ˜¾ç¤ºï¼‰
  - æŒ‰å‚è€ƒä»·ï¼šå‚è€ƒæ ‡çš„ä¸‹æ‹‰é€‰æ‹©
- è”åŠ¨ä»·æ ¼éƒ¨åˆ†ï¼š
  - è”åŠ¨æ¯”ä¾‹è¾“å…¥ï¼ˆÎ±ï¼Œ10%-20%ï¼‰
  - è”åŠ¨æ ‡çš„é€‰æ‹©ï¼ˆæ—¥å‰/å®æ—¶å¸‚åœºå‡ä»·ï¼‰
- æµ®åŠ¨è´¹ç”¨è¾“å…¥

**ä»·å·®åˆ†æˆå®šä»·é…ç½®**ï¼ˆç¬¬332-431è¡Œï¼‰
- å‚è€ƒä»·é…ç½®ï¼šå‚è€ƒæ ‡çš„é€‰æ‹©
- ä»·å·®åˆ†æˆé…ç½®ï¼šçº¦å®šä»·å·®ã€åˆ†æˆæ¯”ä¾‹
- æµ®åŠ¨è´¹ç”¨è¾“å…¥

**4. ä»·æ ¼æ¯”ä¾‹æ ¡éªŒ**ï¼ˆç¬¬106-137è¡Œï¼‰
- å®æ—¶è®¡ç®—å³°/å¹³ã€è°·/å¹³ã€æ·±è°·/å¹³æ¯”ä¾‹
- ä¸æ ‡å‡†æ¯”ä¾‹(1.6:1:0.4:0.3)å¯¹æ¯”
- å…è®¸0.01è¯¯å·®
- ä¸ç¬¦åˆæ—¶æ˜¾ç¤ºAlertè­¦å‘Šï¼ˆç¬¬224-236è¡Œï¼‰ï¼š
  > "å½“å‰è‡ªå®šä¹‰ä»·æ ¼æ¯”ä¾‹ä¸æ»¡è¶³463å·æ–‡è¦æ±‚ï¼Œç»“ç®—æ—¶å°†è‡ªåŠ¨è°ƒæ•´ä¸ºæ ‡å‡†æ¯”ä¾‹ (1.6:1:0.4:0.3)ã€‚"

**5. é”™è¯¯å¤„ç†**
- 409å†²çªé”™è¯¯ â†’ å¥—é¤åç§°å­—æ®µæ˜¾ç¤ºé”™è¯¯æç¤ºï¼ˆç¬¬542-546è¡Œï¼‰
- è¾“å…¥æ—¶è‡ªåŠ¨æ¸…é™¤é”™è¯¯ï¼ˆç¬¬75-77è¡Œï¼‰
- åŠ è½½å¤±è´¥è‡ªåŠ¨å…³é—­å¯¹è¯æ¡†
- ä¿å­˜ä¸­ç¦ç”¨æ‰€æœ‰æŒ‰é’®

**6. å“åº”å¼è®¾è®¡**
- ç§»åŠ¨ç«¯ï¼š`fullScreen` å…¨å±æ¨¡å¼ï¼ˆç¬¬528è¡Œï¼‰
- æ¡Œé¢ç«¯ï¼š`Dialog` å¼¹çª—æ¨¡å¼ï¼ˆmaxWidth="md", fullWidthï¼‰
- è¡¨å•æ§ä»¶è‡ªé€‚åº”ï¼šä½¿ç”¨Gridçš„sizeå±æ€§

**7. æ“ä½œæŒ‰é’®**ï¼ˆç¬¬575-591è¡Œï¼‰
- [å–æ¶ˆ] - å…³é—­å¯¹è¯æ¡†
- [ä¿å­˜ä¸ºè‰ç¨¿] - ä¿å­˜ä¸ºdraftçŠ¶æ€
- [ä¿å­˜å¹¶ç”Ÿæ•ˆ] - ä¿å­˜ä¸ºactiveçŠ¶æ€
- ä¿å­˜ä¸­æ˜¾ç¤º"ä¿å­˜ä¸­..."æ–‡æ¡ˆ

### 2.3 åç«¯APIï¼ˆv1_retail_packages.pyï¼‰

#### âœ… å®Œæ•´å®ç°8ä¸ªç«¯ç‚¹ï¼š

| HTTPæ–¹æ³• | è·¯å¾„ | åŠŸèƒ½ | çŠ¶æ€ç  | çŠ¶æ€ |
|---------|------|------|--------|------|
| POST | `/api/v1/retail-packages` | åˆ›å»ºå¥—é¤ | 201 | âœ… |
| GET | `/api/v1/retail-packages` | åˆ—è¡¨æŸ¥è¯¢ï¼ˆåˆ†é¡µ+ç­›é€‰ï¼‰ | 200 | âš ï¸ ç¼ºå°‘pricing_mode |
| GET | `/api/v1/retail-packages/{id}` | è·å–å¥—é¤è¯¦æƒ… | 200 | âœ… |
| PUT | `/api/v1/retail-packages/{id}` | æ›´æ–°å¥—é¤ï¼ˆä»…è‰ç¨¿ï¼‰ | 200 | âœ… |
| DELETE | `/api/v1/retail-packages/{id}` | åˆ é™¤å¥—é¤ï¼ˆä»…è‰ç¨¿ï¼‰ | 204 | âœ… |
| POST | `/api/v1/retail-packages/{id}/copy` | å¤åˆ¶å¥—é¤ | 201 | âœ… |
| POST | `/api/v1/retail-packages/{id}/activate` | æ¿€æ´»å¥—é¤ï¼ˆè‰ç¨¿â†’ç”Ÿæ•ˆï¼‰ | 200 | âœ… |
| POST | `/api/v1/retail-packages/{id}/archive` | å½’æ¡£å¥—é¤ï¼ˆç”Ÿæ•ˆâ†’å½’æ¡£ï¼‰ | 200 | âœ… |

#### âœ… å®Œå–„çš„é”™è¯¯å¤„ç†ï¼š

| é”™è¯¯ç±»å‹ | çŠ¶æ€ç  | è§¦å‘æ¡ä»¶ | ç¤ºä¾‹ |
|---------|--------|---------|------|
| Conflict | 409 | å¥—é¤åç§°å·²å­˜åœ¨ | åˆ›å»º/æ›´æ–°æ—¶åç§°é‡å¤ |
| Bad Request | 400 | çŠ¶æ€ä¸å…è®¸æ“ä½œ | ç¼–è¾‘ç”Ÿæ•ˆçŠ¶æ€çš„å¥—é¤ |
| Not Found | 404 | å¥—é¤ä¸å­˜åœ¨ | æ— æ•ˆçš„package_id |
| Unauthorized | 401 | æœªè®¤è¯ | æ— JWT tokenæˆ–tokenè¿‡æœŸ |

#### âœ… JWTè®¤è¯ä¿æŠ¤
- æ‰€æœ‰ç«¯ç‚¹éƒ½éœ€è¦ `Depends(get_current_active_user)`
- é€šè¿‡ `current_user.username` è®°å½•æ“ä½œäºº

### 2.4 æœåŠ¡å±‚ï¼ˆpackage_service.pyï¼‰

#### âœ… æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼š

**1. çŠ¶æ€æœºç®¡ç†**ï¼ˆç¬¬14-18è¡Œï¼‰
```python
STATE_TRANSITIONS = {
    "draft": ["active"],      # è‰ç¨¿ â†’ ç”Ÿæ•ˆ
    "active": ["archived"],   # ç”Ÿæ•ˆ â†’ å½’æ¡£
    "archived": []            # å½’æ¡£ä¸èƒ½è½¬æ¢
}
```

**2. çŠ¶æ€è½¬æ¢æ–¹æ³• `change_status`**ï¼ˆç¬¬115-180è¡Œï¼‰
- è·å–å½“å‰å¥—é¤çŠ¶æ€
- æ ¡éªŒçŠ¶æ€è½¬æ¢æ˜¯å¦åˆæ³•
- è®°å½•çŠ¶æ€å˜æ›´æ—¶é—´ï¼ˆactivated_at / archived_atï¼‰
- æ›´æ–°æ“ä½œäººå’Œæ—¶é—´

**3. å¥—é¤åç§°å”¯ä¸€æ€§**
- MongoDBå”¯ä¸€ç´¢å¼•ï¼ˆåœ¨ç´¢å¼•è„šæœ¬ä¸­å®šä¹‰ï¼‰
- æ•è· `DuplicateKeyError` å¼‚å¸¸ï¼ˆç¬¬58è¡Œã€ç¬¬275è¡Œï¼‰
- è½¬æ¢ä¸ºå‹å¥½é”™è¯¯æ¶ˆæ¯

**4. å¤åˆ¶å¥—é¤æ™ºèƒ½å‘½å**ï¼ˆç¬¬313-367è¡Œï¼‰
- è‡ªåŠ¨ç”Ÿæˆ "{åŸåç§°}_å‰¯æœ¬" åç¼€
- åç§°å†²çªæ—¶è¿½åŠ æ•°å­—ï¼š"{åŸåç§°}_å‰¯æœ¬2"
- å¾ªç¯æ£€æŸ¥ç›´åˆ°æ‰¾åˆ°å¯ç”¨åç§°
- æ–°å¥—é¤å¼ºåˆ¶è®¾ä¸ºdraftçŠ¶æ€

**5. æ›´æ–°å¥—é¤æ ¡éªŒ**ï¼ˆç¬¬207-282è¡Œï¼‰
- åªæœ‰draftçŠ¶æ€æ‰èƒ½ç¼–è¾‘ï¼ˆç¬¬232-233è¡Œï¼‰
- æ£€æŸ¥åç§°å†²çªï¼ˆæ’é™¤è‡ªèº«ï¼Œç¬¬236-243è¡Œï¼‰
- æ›´æ–°å…ƒæ•°æ®ï¼ˆupdated_by, updated_atï¼‰

**6. åˆ é™¤å¥—é¤æ ¡éªŒ**ï¼ˆç¬¬284-311è¡Œï¼‰
- åªæœ‰draftçŠ¶æ€æ‰èƒ½åˆ é™¤ï¼ˆç¬¬304-305è¡Œï¼‰
- ç‰©ç†åˆ é™¤ï¼ˆç›´æ¥ä»æ•°æ®åº“ç§»é™¤ï¼‰

**7. ä»·æ ¼æ¯”ä¾‹æ ¡éªŒ**ï¼ˆç¬¬44-53è¡Œã€ç¬¬249-267è¡Œï¼‰
- ä»…å¯¹å›ºå®š+è”åŠ¨æ¨¡å¼çš„è‡ªå®šä¹‰ä»·æ ¼è¿›è¡Œæ ¡éªŒ
- è°ƒç”¨ `PricingEngine.validate_price_ratio`
- å°†æ ¡éªŒç»“æœå­˜å‚¨åœ¨ `validation` å­—æ®µ

**8. åˆ—è¡¨æŸ¥è¯¢**ï¼ˆç¬¬68-113è¡Œï¼‰
- æ”¯æŒå…³é”®è¯æ¨¡ç³Šæœç´¢ï¼ˆæ­£åˆ™è¡¨è¾¾å¼ï¼‰
- æ”¯æŒå¥—é¤ç±»å‹ã€çŠ¶æ€ç­›é€‰
- âš ï¸ **ç¼ºå°‘pricing_modeç­›é€‰æ”¯æŒ**
- åˆ†é¡µå¤„ç†
- è¿”å›è½»é‡åŒ–åˆ—è¡¨é¡¹ï¼ˆRetailPackageListItemï¼‰

### 2.5 æ•°æ®æ¨¡å‹ï¼ˆretail_package.pyï¼‰

#### âœ… å®Œæ•´çš„Pydanticæ¨¡å‹ï¼š

**æ ¸å¿ƒæ¨¡å‹ï¼š**
- `CustomPrices` - 5ä¸ªæ—¶æ®µä»·æ ¼
- `FixedPriceConfig` - å›ºå®šä»·æ ¼é…ç½®ï¼ˆè‡ªå®šä¹‰/å‚è€ƒä»·ï¼‰
- `LinkedPriceConfig` - è”åŠ¨ä»·æ ¼é…ç½®
- `FixedLinkedConfig` - å›ºå®š+è”åŠ¨ç»„åˆ
- `PriceSpreadConfig` - ä»·å·®åˆ†æˆé…ç½®
- `GreenPowerTerm` - ç»¿è‰²ç”µåŠ›æ¡æ¬¾
- `PriceCapTerm` - å°é¡¶ä»·æ ¼æ¡æ¬¾
- `AdditionalTerms` - é™„åŠ æ¡æ¬¾å®¹å™¨
- `ValidationResult` - ä»·æ ¼æ¯”ä¾‹æ ¡éªŒç»“æœ

**ä¸»æ¨¡å‹ï¼š**
- `RetailPackage` - å®Œæ•´å¥—é¤æ•°æ®ï¼ˆç”¨äºåˆ›å»º/æ›´æ–°/è¯¦æƒ…ï¼‰
- `RetailPackageListItem` - åˆ—è¡¨é¡¹è½»é‡çº§æ¨¡å‹
- `PackageListResponse` - åˆ†é¡µå“åº”æ¨¡å‹

**ç‰¹æ€§ï¼š**
- ObjectIdè‡ªåŠ¨è½¬æ¢ï¼ˆPyObjectIdç±»ï¼‰
- å­—æ®µåˆ«åï¼ˆ_id â†” idï¼‰
- é»˜è®¤å€¼å·¥å‚ï¼ˆdatetime.utcnow, AdditionalTermsï¼‰
- Literalç±»å‹çº¦æŸï¼ˆå¥—é¤ç±»å‹ã€å®šä»·æ¨¡å¼ã€çŠ¶æ€ï¼‰

### 2.6 æ•°æ®åº“è®¾è®¡

#### âœ… MongoDBé›†åˆï¼š`retail_packages`

**ç´¢å¼•è„šæœ¬**ï¼š`webapp/scripts/create_retail_package_indexes.js`

**å·²åˆ›å»ºçš„ç´¢å¼•ï¼š**
1. `idx_package_name_unique` - å”¯ä¸€ç´¢å¼•ï¼ˆpackage_nameï¼‰
2. `idx_status` - æ™®é€šç´¢å¼•ï¼ˆstatusï¼‰
3. `idx_package_type` - æ™®é€šç´¢å¼•ï¼ˆpackage_typeï¼‰
4. `idx_created_at` - æ™®é€šç´¢å¼•ï¼ˆcreated_at, é™åºï¼‰
5. `idx_status_type_created` - å¤åˆç´¢å¼•ï¼ˆstatus + package_type + created_atï¼‰

**æŸ¥è¯¢ä¼˜åŒ–ï¼š**
- å”¯ä¸€ç´¢å¼•ä¿è¯å¥—é¤åç§°ä¸é‡å¤
- å¤åˆç´¢å¼•æ”¯æŒå¸¸è§ç­›é€‰ç»„åˆ
- created_até™åºä¼˜åŒ–"æœ€æ–°åˆ›å»º"æ’åº

---

## ä¸‰ã€ç¼ºå¤±å’Œéœ€æ”¹è¿›çš„åŠŸèƒ½

### 3.1 ç¼ºå¤±åŠŸèƒ½ï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰

#### ğŸ”´ é«˜ä¼˜å…ˆçº§

**1. pricing_mode è¿‡æ»¤æ”¯æŒ**

**ç°è±¡ï¼š**
- å‰ç«¯ä¼ é€’äº† `pricing_mode` å‚æ•°ï¼ˆRetailPackagePage.tsx ç¬¬31è¡Œã€ç¬¬291-299è¡Œï¼‰
- åç«¯APIæ²¡æœ‰æ¥æ”¶æ­¤å‚æ•°ï¼ˆv1_retail_packages.py ç¬¬93-113è¡Œï¼‰
- åç«¯æœåŠ¡å±‚æ²¡æœ‰å¤„ç†æ­¤å‚æ•°ï¼ˆpackage_service.py ç¬¬68-80è¡Œï¼‰

**å¯¼è‡´é—®é¢˜ï¼š**
- APIè¿”å› 500 Internal Server Error
- åç«¯æ§åˆ¶å°æ— é”™è¯¯æ—¥å¿—ï¼ˆå‚æ•°è¢«å¿½ç•¥ä½†æœªæŠ¥é”™ï¼‰

**éœ€è¦ä¿®æ”¹ï¼š**
```python
# æ–‡ä»¶1ï¼šwebapp/api/v1_retail_packages.py (ç¬¬93-113è¡Œ)
@router.get("", response_model=PackageListResponse)
async def list_packages(
    keyword: Optional[str] = None,
    package_type: Optional[str] = None,
    pricing_mode: Optional[str] = None,  # â† æ·»åŠ æ­¤å‚æ•°
    status: Optional[str] = None,
    page: int = 1,
    page_size: int = 20,
    current_user: User = Depends(get_current_active_user)
):
    """è·å–å¥—é¤åˆ—è¡¨"""
    service = PackageService(DATABASE)
    result = service.list_packages(
        filters={
            "keyword": keyword,
            "package_type": package_type,
            "pricing_mode": pricing_mode,  # â† ä¼ é€’å‚æ•°
            "status": status
        },
        page=page,
        page_size=page_size
    )
    return result

# æ–‡ä»¶2ï¼šwebapp/services/package_service.py (ç¬¬68-80è¡Œ)
def list_packages(self, filters: dict, page: int, page_size: int) -> dict:
    query = {}
    if filters.get("keyword"):
        query["package_name"] = {"$regex": filters["keyword"], "$options": "i"}
    if filters.get("package_type"):
        query["package_type"] = filters["package_type"]
    if filters.get("pricing_mode"):  # â† æ·»åŠ è¿™3è¡Œ
        query["pricing_mode"] = filters["pricing_mode"]
    if filters.get("status"):
        query["status"] = filters["status"]
    # ... åç»­ä»£ç ä¸å˜
```

**2. PackageDetailsDialog ç»„ä»¶**

**å½“å‰çŠ¶æ€ï¼š** å®Œå…¨ç¼ºå¤±

**è®¾è®¡è¦æ±‚ï¼š**ï¼ˆé›¶å”®å¥—é¤ç®¡ç†æ¨¡å—è®¾è®¡æ–¹æ¡ˆ_v2.md ç¬¬ä¹èŠ‚ï¼‰
- ç‚¹å‡»å¥—é¤åç§°æ‰“å¼€åªè¯»è¯¦æƒ…è§†å›¾
- ä¸ç¼–è¾‘é¡µç›¸åŒçš„ä¸‰å¡ç‰‡ç»“æ„ï¼Œä½†æ‰€æœ‰è¡¨å•æ§ä»¶æ›¿æ¢ä¸ºæ–‡æœ¬å±•ç¤º
- åº•éƒ¨æ“ä½œæ ï¼š
  - [å…³é—­] - æ‰€æœ‰çŠ¶æ€å¯ç”¨
  - [å¤åˆ¶] - æ‰€æœ‰çŠ¶æ€å¯ç”¨
  - [ç¼–è¾‘] - ä»…è‰ç¨¿çŠ¶æ€æ˜¾ç¤º
- å“åº”å¼è®¾è®¡ï¼šç§»åŠ¨ç«¯å…¨å±ï¼Œæ¡Œé¢ç«¯Dialog

**å½±å“ï¼š**
- æ— æ³•æŸ¥çœ‹ç”Ÿæ•ˆçŠ¶æ€å’Œå½’æ¡£çŠ¶æ€å¥—é¤çš„è¯¦ç»†é…ç½®
- åªèƒ½é€šè¿‡ç¼–è¾‘æŒ‰é’®æŸ¥çœ‹è‰ç¨¿ï¼Œä½†ä¼šè¿›å…¥å¯ç¼–è¾‘æ¨¡å¼

**å®ç°æ­¥éª¤ï¼š**

**æ­¥éª¤1ï¼šåˆ›å»ºç»„ä»¶æ–‡ä»¶**
```bash
æ–°å»ºï¼šfrontend/src/components/PackageDetailsDialog.tsx
```

**æ­¥éª¤2ï¼šç»„ä»¶ç»“æ„**
```typescript
import React, { useState, useEffect } from 'react';
import {
  Dialog, DialogTitle, DialogContent, DialogActions, Button,
  Box, CircularProgress, Paper, Typography, Grid, Chip,
  useMediaQuery, useTheme, Alert
} from '@mui/material';
import apiClient from '../api/client';
import { format } from 'date-fns';

interface PackageDetailsDialogProps {
  open: boolean;
  packageId: string | null;
  onClose: () => void;
  onEdit?: (id: string) => void;
  onCopy?: (id: string) => void;
}

export const PackageDetailsDialog: React.FC<PackageDetailsDialogProps> = ({
  open, packageId, onClose, onEdit, onCopy
}) => {
  const [loading, setLoading] = useState(false);
  const [data, setData] = useState<any>(null);
  const [error, setError] = useState<string | null>(null);

  const theme = useTheme();
  const isMobile = useMediaQuery(theme.breakpoints.down('sm'));

  useEffect(() => {
    if (open && packageId) {
      setLoading(true);
      setError(null);
      apiClient.get(`/api/v1/retail-packages/${packageId}`)
        .then(response => setData(response.data))
        .catch(error => {
          console.error('åŠ è½½å¥—é¤è¯¦æƒ…å¤±è´¥', error);
          setError(error.response?.data?.detail || 'åŠ è½½å¤±è´¥');
        })
        .finally(() => setLoading(false));
    }
  }, [open, packageId]);

  const renderBasicInfo = () => (
    <Paper variant="outlined" sx={{ p: 2, mb: 2 }}>
      <Typography variant="h6" gutterBottom>åŸºæœ¬ä¿¡æ¯</Typography>
      <Grid container spacing={2}>
        <Grid size={{ xs: 12, md: 6 }}>
          <Typography variant="body2" color="text.secondary">å¥—é¤åç§°</Typography>
          <Typography variant="body1">{data?.package_name}</Typography>
        </Grid>
        <Grid size={{ xs: 12, md: 6 }}>
          <Typography variant="body2" color="text.secondary">å¥—é¤ç±»å‹</Typography>
          <Chip
            label={data?.package_type === 'time_based' ? 'åˆ†æ—¶æ®µ' : 'ä¸åˆ†æ—¶æ®µ'}
            size="small"
          />
        </Grid>
        {/* æ›´å¤šå­—æ®µ... */}
      </Grid>
    </Paper>
  );

  const renderPricingMode = () => {
    // æ ¹æ® pricing_mode æ¸²æŸ“ä¸åŒçš„é…ç½®ä¿¡æ¯
    // ä½¿ç”¨ Typography æ›¿ä»£ TextField
    // ...
  };

  const renderAdditionalTerms = () => {
    // æ¸²æŸ“é™„åŠ æ¡æ¬¾ä¿¡æ¯
    // ...
  };

  return (
    <Dialog open={open} onClose={onClose} fullScreen={isMobile} maxWidth="md" fullWidth>
      <DialogTitle>å¥—é¤è¯¦æƒ…</DialogTitle>
      <DialogContent dividers>
        {loading ? (
          <Box sx={{ display: 'flex', justifyContent: 'center', p: 3 }}>
            <CircularProgress />
          </Box>
        ) : error ? (
          <Alert severity="error">{error}</Alert>
        ) : data ? (
          <>
            {renderBasicInfo()}
            {renderPricingMode()}
            {renderAdditionalTerms()}
          </>
        ) : null}
      </DialogContent>
      <DialogActions>
        <Button onClick={onClose}>å…³é—­</Button>
        <Button variant="outlined" onClick={() => onCopy?.(packageId!)}>
          å¤åˆ¶
        </Button>
        {data?.status === 'draft' && (
          <Button
            variant="contained"
            onClick={() => {
              onClose();
              onEdit?.(packageId!);
            }}
          >
            ç¼–è¾‘
          </Button>
        )}
      </DialogActions>
    </Dialog>
  );
};
```

**æ­¥éª¤3ï¼šé›†æˆåˆ°ä¸»é¡µé¢**
```typescript
// RetailPackagePage.tsx

// æ·»åŠ çŠ¶æ€
const [detailsDialogOpen, setDetailsDialogOpen] = useState(false);
const [detailsPackageId, setDetailsPackageId] = useState<string | null>(null);

// ç‚¹å‡»å¥—é¤åç§°å¤„ç†å‡½æ•°
const handleViewDetails = (packageId: string) => {
  setDetailsPackageId(packageId);
  setDetailsDialogOpen(true);
};

// ä¿®æ”¹è¡¨æ ¼ä¸­å¥—é¤åç§°åˆ—ï¼ˆç¬¬463è¡Œï¼‰
<TableCell>
  <Typography
    sx={{
      cursor: 'pointer',
      color: 'primary.main',
      '&:hover': { textDecoration: 'underline' }
    }}
    onClick={() => handleViewDetails(pkg.id)}
  >
    {pkg.package_name}
  </Typography>
</TableCell>

// ä¿®æ”¹ç§»åŠ¨ç«¯å¡ç‰‡ä¸­å¥—é¤åç§°ï¼ˆç¬¬371è¡Œï¼‰
<Typography
  variant="subtitle1"
  gutterBottom
  sx={{
    cursor: 'pointer',
    color: 'primary.main',
    '&:hover': { textDecoration: 'underline' }
  }}
  onClick={() => handleViewDetails(pkg.id)}
>
  {pkg.package_name}
</Typography>

// æ·»åŠ å¯¹è¯æ¡†ç»„ä»¶ï¼ˆç¬¬617è¡Œä¹‹å‰ï¼‰
<PackageDetailsDialog
  open={detailsDialogOpen}
  packageId={detailsPackageId}
  onClose={() => {
    setDetailsDialogOpen(false);
    setDetailsPackageId(null);
  }}
  onEdit={(id) => {
    setDetailsDialogOpen(false);
    handleEdit(id);
  }}
  onCopy={(id) => {
    setDetailsDialogOpen(false);
    handleCopy(id);
  }}
/>
```

#### ğŸŸ¡ ä¸­ä¼˜å…ˆçº§

**3. å¯¼å‡ºåŠŸèƒ½**

**å½“å‰çŠ¶æ€ï¼š**
- æŒ‰é’®å·²å­˜åœ¨ï¼ˆRetailPackagePage.tsx ç¬¬324è¡Œï¼‰
- `<Button variant="outlined">å¯¼å‡º</Button>`
- onClickäº‹ä»¶æœªç»‘å®š

**å®ç°æ–¹æ¡ˆï¼š**

**å‰ç«¯å®ç°ï¼š**
```typescript
// RetailPackagePage.tsx

const handleExport = async () => {
  try {
    const response = await apiClient.get('/api/v1/retail-packages/export', {
      params: {
        ...filters,
        // ä¸ä¼ pageå’Œpage_sizeï¼Œå¯¼å‡ºå…¨éƒ¨
      },
      responseType: 'blob'
    });

    const url = window.URL.createObjectURL(new Blob([response.data]));
    const link = document.createElement('a');
    link.href = url;
    link.setAttribute('download', `é›¶å”®å¥—é¤åˆ—è¡¨_${format(new Date(), 'yyyyMMdd_HHmmss')}.xlsx`);
    document.body.appendChild(link);
    link.click();
    link.remove();

    showSnackbar('å¯¼å‡ºæˆåŠŸ', 'success');
  } catch (error: any) {
    console.error('å¯¼å‡ºå¤±è´¥', error);
    showSnackbar(error.response?.data?.detail || 'å¯¼å‡ºå¤±è´¥', 'error');
  }
};

// ä¿®æ”¹å¯¼å‡ºæŒ‰é’®
<Button variant="outlined" onClick={handleExport}>å¯¼å‡º</Button>
```

**åç«¯å®ç°ï¼š**
```python
# webapp/api/v1_retail_packages.py

from fastapi.responses import StreamingResponse
import io
import pandas as pd

@router.get("/export")
async def export_packages(
    keyword: Optional[str] = None,
    package_type: Optional[str] = None,
    pricing_mode: Optional[str] = None,
    status: Optional[str] = None,
    current_user: User = Depends(get_current_active_user)
):
    """å¯¼å‡ºå¥—é¤åˆ—è¡¨ä¸ºExcel"""
    service = PackageService(DATABASE)
    result = service.list_packages(
        filters={
            "keyword": keyword,
            "package_type": package_type,
            "pricing_mode": pricing_mode,
            "status": status
        },
        page=1,
        page_size=10000  # å¯¼å‡ºå…¨éƒ¨æ•°æ®
    )

    # è½¬æ¢ä¸ºDataFrame
    items = result['items']
    df = pd.DataFrame(items)

    # å­—æ®µæ˜ å°„ï¼ˆä¸­æ–‡åˆ—åï¼‰
    df = df.rename(columns={
        'package_name': 'å¥—é¤åç§°',
        'package_type': 'å¥—é¤ç±»å‹',
        'pricing_mode': 'å®šä»·æ¨¡å¼',
        'status': 'çŠ¶æ€',
        'has_green_power': 'ç»¿è‰²ç”µåŠ›',
        'has_price_cap': 'å°é¡¶ä»·æ ¼',
        'created_at': 'åˆ›å»ºæ—¶é—´',
        'updated_at': 'æ›´æ–°æ—¶é—´'
    })

    # è½¬æ¢æšä¸¾å€¼ä¸ºä¸­æ–‡
    df['å¥—é¤ç±»å‹'] = df['å¥—é¤ç±»å‹'].map({
        'time_based': 'åˆ†æ—¶æ®µ',
        'non_time_based': 'ä¸åˆ†æ—¶æ®µ'
    })
    df['å®šä»·æ¨¡å¼'] = df['å®šä»·æ¨¡å¼'].map({
        'fixed_linked': 'å›ºå®š+è”åŠ¨',
        'price_spread': 'ä»·å·®åˆ†æˆ'
    })
    df['çŠ¶æ€'] = df['çŠ¶æ€'].map({
        'draft': 'è‰ç¨¿',
        'active': 'ç”Ÿæ•ˆ',
        'archived': 'å½’æ¡£'
    })
    df['ç»¿è‰²ç”µåŠ›'] = df['ç»¿è‰²ç”µåŠ›'].map({True: 'æ˜¯', False: 'å¦'})
    df['å°é¡¶ä»·æ ¼'] = df['å°é¡¶ä»·æ ¼'].map({True: 'æ˜¯', False: 'å¦'})

    # æ ¼å¼åŒ–æ—¶é—´
    df['åˆ›å»ºæ—¶é—´'] = pd.to_datetime(df['åˆ›å»ºæ—¶é—´']).dt.strftime('%Y-%m-%d %H:%M:%S')
    df['æ›´æ–°æ—¶é—´'] = pd.to_datetime(df['æ›´æ–°æ—¶é—´']).dt.strftime('%Y-%m-%d %H:%M:%S')

    # å†™å…¥Excel
    output = io.BytesIO()
    with pd.ExcelWriter(output, engine='openpyxl') as writer:
        df.to_excel(writer, index=False, sheet_name='é›¶å”®å¥—é¤åˆ—è¡¨')
    output.seek(0)

    return StreamingResponse(
        output,
        media_type='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
        headers={
            'Content-Disposition': 'attachment; filename=retail_packages.xlsx'
        }
    )
```

**ä¾èµ–å®‰è£…ï¼š**
```bash
pip install pandas openpyxl
```

#### ğŸŸ¢ ä½ä¼˜å…ˆçº§

**4. æ•°æ®è·å–ä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰**

**å½“å‰å®ç°ï¼š**
- ä½¿ç”¨ `useEffect` + `useState` æ‰‹åŠ¨ç®¡ç†æ•°æ®è·å–
- éœ€è¦æ‰‹åŠ¨å¤„ç†loadingã€errorçŠ¶æ€
- æ— ç¼“å­˜æœºåˆ¶

**å»ºè®®æ–¹æ¡ˆï¼š**
ä½¿ç”¨ TanStack Query (React Query) æ›¿ä»£

**ä¼˜åŠ¿ï¼š**
- è‡ªåŠ¨ç¼“å­˜ç®¡ç†
- è‡ªåŠ¨åå°é‡æ–°éªŒè¯
- é‡è¯•æœºåˆ¶
- æ›´å°‘çš„æ ·æ¿ä»£ç 

**å®ç°ç¤ºä¾‹ï¼š**
```typescript
// å®‰è£…ä¾èµ–
npm install @tanstack/react-query

// é…ç½®Providerï¼ˆApp.tsxï¼‰
import { QueryClient, QueryClientProvider } from '@tanstack/react-query';

const queryClient = new QueryClient();

function App() {
  return (
    <QueryClientProvider client={queryClient}>
      {/* ... */}
    </QueryClientProvider>
  );
}

// ä½¿ç”¨Queryï¼ˆRetailPackagePage.tsxï¼‰
import { useQuery } from '@tanstack/react-query';

const { data, isLoading, error, refetch } = useQuery({
  queryKey: ['packages', filters, page, rowsPerPage],
  queryFn: async () => {
    const response = await apiClient.get('/api/v1/retail-packages', {
      params: {
        ...filters,
        page: page + 1,
        page_size: rowsPerPage,
      }
    });
    return response.data;
  },
  staleTime: 5000, // 5ç§’å†…ä¸é‡æ–°è¯·æ±‚
});

// åˆ é™¤ååˆ·æ–°
const handleDeleteConfirm = async () => {
  // ...
  await apiClient.delete(`/api/v1/retail-packages/${packageToDelete}`);
  refetch(); // æ›¿ä»£ fetchPackages()
  // ...
};
```

**5. è¡¨å•éªŒè¯å¢å¼º**

**å½“å‰çŠ¶æ€ï¼š**
- ä¸»è¦ä¾èµ–åç«¯æ ¡éªŒ
- å‰ç«¯ä»…æœ‰ä»·æ ¼æ¯”ä¾‹è­¦å‘Šï¼ˆéé˜»å¡ï¼‰

**å»ºè®®å¢å¼ºï¼š**
```typescript
// PackageEditorDialog.tsx

// ä½¿ç”¨react-hook-formçš„rules
<Controller
  name="fixed_linked_config.linked_price.ratio"
  control={control}
  rules={{
    min: { value: 10, message: 'è”åŠ¨æ¯”ä¾‹ä¸èƒ½ä½äº10%' },
    max: { value: 20, message: 'è”åŠ¨æ¯”ä¾‹ä¸èƒ½è¶…è¿‡20%' }
  }}
  render={({ field, fieldState: { error } }) => (
    <TextField
      {...field}
      type="number"
      label="è”åŠ¨æ¯”ä¾‹ (Î±) (%)"
      error={!!error}
      helperText={error?.message || "æç¤º: 10%~20%"}
    />
  )}
/>
```

### 3.2 ä»£ç è´¨é‡é—®é¢˜

**1. æœªä½¿ç”¨çš„å¯¼å…¥**
```typescript
// RetailPackagePage.tsx ç¬¬8è¡Œ
import { PageHeader } from '../components/PageHeader'; // â† æœªä½¿ç”¨
```
**å»ºè®®ï¼š** åˆ é™¤æ­¤è¡Œ

**2. ç±»å‹å®šä¹‰åˆ†æ•£**
```typescript
// RetailPackagePage.tsx ç¬¬13-23è¡Œ
interface Package {
  id: string;
  package_name: string;
  // ...
}
```
**å»ºè®®ï¼š**
- æå–åˆ°å•ç‹¬çš„ç±»å‹æ–‡ä»¶ï¼š`frontend/src/types/package.ts`
- è€ƒè™‘ä½¿ç”¨ä»£ç ç”Ÿæˆå·¥å…·ä»åç«¯æ¨¡å‹ç”ŸæˆTypeScriptç±»å‹

**3. é­”æ³•æ•°å­—**
```typescript
// PackageEditorDialog.tsx ç¬¬122-126è¡Œ
const STANDARD_RATIOS = {
  high_to_flat: 1.6,
  valley_to_flat: 0.4,
  deep_valley_to_flat: 0.3,
};
```
**å»ºè®®ï¼š** æå–åˆ°å¸¸é‡æ–‡ä»¶
```typescript
// frontend/src/constants/pricing.ts
export const STANDARD_PRICE_RATIOS = {
  HIGH_TO_FLAT: 1.6,
  VALLEY_TO_FLAT: 0.4,
  DEEP_VALLEY_TO_FLAT: 0.3,
} as const;
```

**4. APIè°ƒç”¨å¯ä»¥å°è£…**
```typescript
// å»ºè®®åˆ›å»ºï¼šfrontend/src/api/packages.ts
export const packageApi = {
  list: (params) => apiClient.get('/api/v1/retail-packages', { params }),
  get: (id) => apiClient.get(`/api/v1/retail-packages/${id}`),
  create: (data, asDraft) => apiClient.post('/api/v1/retail-packages', { ...data, save_as_draft: asDraft }),
  update: (id, data) => apiClient.put(`/api/v1/retail-packages/${id}`, data),
  delete: (id) => apiClient.delete(`/api/v1/retail-packages/${id}`),
  copy: (id) => apiClient.post(`/api/v1/retail-packages/${id}/copy`),
  activate: (id) => apiClient.post(`/api/v1/retail-packages/${id}/activate`),
  archive: (id) => apiClient.post(`/api/v1/retail-packages/${id}/archive`),
};
```

---

## å››ã€ä»£ç ä¼˜åŒ–æ€è·¯å’Œå®ç°æ­¥éª¤

### å®æ–½è·¯çº¿å›¾

#### ç¬¬ä¸€é˜¶æ®µï¼šä¿®å¤ç´§æ€¥é—®é¢˜ï¼ˆé¢„è®¡0.5å°æ—¶ï¼‰

**ä»»åŠ¡1ï¼šä¿®å¤ pricing_mode è¿‡æ»¤**
- [ ] ä¿®æ”¹ `webapp/api/v1_retail_packages.py`ï¼ˆæ·»åŠ å‚æ•°æ¥æ”¶ï¼‰
- [ ] ä¿®æ”¹ `webapp/services/package_service.py`ï¼ˆæ·»åŠ è¿‡æ»¤é€»è¾‘ï¼‰
- [ ] é‡å¯åç«¯æœåŠ¡
- [ ] æµ‹è¯•å‰ç«¯ç­›é€‰åŠŸèƒ½

**éªŒæ”¶æ ‡å‡†ï¼š**
- é€‰æ‹©"å›ºå®š+è”åŠ¨"æˆ–"ä»·å·®åˆ†æˆ"åç‚¹å‡»æŸ¥è¯¢ï¼Œä¸å†æŠ¥500é”™è¯¯
- åˆ—è¡¨æ­£ç¡®æ˜¾ç¤ºç­›é€‰åçš„æ•°æ®

---

#### ç¬¬äºŒé˜¶æ®µï¼šæ ¸å¿ƒåŠŸèƒ½è¡¥å…¨ï¼ˆé¢„è®¡4-6å°æ—¶ï¼‰

**ä»»åŠ¡2ï¼šå®ç° PackageDetailsDialog ç»„ä»¶**

**2.1 åˆ›å»ºç»„ä»¶æ–‡ä»¶**ï¼ˆ1å°æ—¶ï¼‰
- [ ] æ–°å»º `frontend/src/components/PackageDetailsDialog.tsx`
- [ ] å®ç°æ•°æ®åŠ è½½é€»è¾‘ï¼ˆuseEffect + apiClientï¼‰
- [ ] å®ç°ä¸‰ä¸ªæ¸²æŸ“å‡½æ•°ï¼š
  - [ ] `renderBasicInfo` - åŸºæœ¬ä¿¡æ¯å¡ç‰‡
  - [ ] `renderPricingMode` - å®šä»·æ¨¡å¼å¡ç‰‡
  - [ ] `renderAdditionalTerms` - é™„åŠ æ¡æ¬¾å¡ç‰‡
- [ ] å®ç°å“åº”å¼è®¾è®¡ï¼ˆfullScreen for mobileï¼‰

**2.2 è¯¦ç»†å±•ç¤ºé€»è¾‘**ï¼ˆ2å°æ—¶ï¼‰
- [ ] å›ºå®š+è”åŠ¨å®šä»·æ¨¡å¼å±•ç¤ºï¼š
  - [ ] å›ºå®šä»·æ ¼ï¼ˆè‡ªå®šä¹‰ä»·æ ¼5ä¸ªæ—¶æ®µ / å‚è€ƒä»·æ ‡çš„ï¼‰
  - [ ] è”åŠ¨ä»·æ ¼ï¼ˆæ¯”ä¾‹ + æ ‡çš„ï¼‰
  - [ ] æµ®åŠ¨è´¹ç”¨
- [ ] ä»·å·®åˆ†æˆå®šä»·æ¨¡å¼å±•ç¤ºï¼š
  - [ ] å‚è€ƒä»·æ ‡çš„
  - [ ] çº¦å®šä»·å·® + åˆ†æˆæ¯”ä¾‹
  - [ ] æµ®åŠ¨è´¹ç”¨
- [ ] é™„åŠ æ¡æ¬¾å±•ç¤ºï¼š
  - [ ] ç»¿è‰²ç”µåŠ›ï¼ˆå¯ç”¨çŠ¶æ€ + ç¯å¢ƒä»·å€¼ + åå·®è¡¥å¿æ¯”ä¾‹ï¼‰
  - [ ] å°é¡¶ä»·æ ¼ï¼ˆå¯ç”¨çŠ¶æ€ + å‚è€ƒæ ‡çš„ + ä¸Šæµ®æ¯”ä¾‹ï¼‰

**2.3 é›†æˆåˆ°ä¸»é¡µé¢**ï¼ˆ0.5å°æ—¶ï¼‰
- [ ] ä¿®æ”¹ `RetailPackagePage.tsx`ï¼š
  - [ ] æ·»åŠ çŠ¶æ€ç®¡ç†ï¼ˆdetailsDialogOpen, detailsPackageIdï¼‰
  - [ ] æ·»åŠ å¤„ç†å‡½æ•°ï¼ˆhandleViewDetailsï¼‰
  - [ ] ä¿®æ”¹å¥—é¤åç§°åˆ—ä¸ºå¯ç‚¹å‡»ï¼ˆæ¡Œé¢ç«¯è¡¨æ ¼ï¼‰
  - [ ] ä¿®æ”¹å¥—é¤åç§°ä¸ºå¯ç‚¹å‡»ï¼ˆç§»åŠ¨ç«¯å¡ç‰‡ï¼‰
  - [ ] æ·»åŠ  PackageDetailsDialog ç»„ä»¶

**2.4 æµ‹è¯•**ï¼ˆ0.5å°æ—¶ï¼‰
- [ ] æµ‹è¯•ç‚¹å‡»å¥—é¤åç§°æ‰“å¼€è¯¦æƒ…
- [ ] æµ‹è¯•è¯¦æƒ…é¡µæ•°æ®å®Œæ•´å±•ç¤º
- [ ] æµ‹è¯•å…³é—­/å¤åˆ¶/ç¼–è¾‘æŒ‰é’®åŠŸèƒ½
- [ ] æµ‹è¯•è‰ç¨¿/ç”Ÿæ•ˆ/å½’æ¡£çŠ¶æ€çš„æŒ‰é’®æ˜¾ç¤ºé€»è¾‘
- [ ] æµ‹è¯•ç§»åŠ¨ç«¯å…¨å±æ¨¡å¼
- [ ] æµ‹è¯•åŠ è½½çŠ¶æ€å’Œé”™è¯¯å¤„ç†

---

#### ç¬¬ä¸‰é˜¶æ®µï¼šåŠŸèƒ½å¢å¼ºï¼ˆé¢„è®¡2-3å°æ—¶ï¼‰

**ä»»åŠ¡3ï¼šå®ç°å¯¼å‡ºåŠŸèƒ½**ï¼ˆ2å°æ—¶ï¼‰

**3.1 åç«¯å®ç°**
- [ ] å®‰è£…ä¾èµ–ï¼š`pip install pandas openpyxl`
- [ ] åœ¨ `v1_retail_packages.py` æ·»åŠ  `/export` ç«¯ç‚¹
- [ ] å®ç°æ•°æ®è½¬æ¢ï¼ˆå­—æ®µä¸­æ–‡åŒ–ã€æšä¸¾å€¼ç¿»è¯‘ï¼‰
- [ ] å®ç°Excelç”Ÿæˆ

**3.2 å‰ç«¯å®ç°**
- [ ] æ·»åŠ  `handleExport` å‡½æ•°
- [ ] ä¿®æ”¹å¯¼å‡ºæŒ‰é’®ç»‘å®šonClickäº‹ä»¶
- [ ] å¤„ç†ä¸‹è½½é€»è¾‘ï¼ˆBlob + aæ ‡ç­¾ï¼‰
- [ ] æ·»åŠ æˆåŠŸ/å¤±è´¥åé¦ˆ

**3.3 æµ‹è¯•**
- [ ] æµ‹è¯•æ— ç­›é€‰å¯¼å‡º
- [ ] æµ‹è¯•å¸¦ç­›é€‰æ¡ä»¶å¯¼å‡º
- [ ] æµ‹è¯•Excelæ–‡ä»¶æ ¼å¼å’Œå†…å®¹
- [ ] æµ‹è¯•ä¸­æ–‡åˆ—åå’Œæšä¸¾å€¼ç¿»è¯‘

**ä»»åŠ¡4ï¼šä»£ç æ¸…ç†**ï¼ˆ0.5å°æ—¶ï¼‰
- [ ] åˆ é™¤æœªä½¿ç”¨çš„ PageHeader å¯¼å…¥
- [ ] æå–ä»·æ ¼æ¯”ä¾‹æ ‡å‡†å€¼ä¸ºå¸¸é‡
- [ ] ä»£ç æ ¼å¼åŒ–ï¼ˆPrettierï¼‰

---

#### ç¬¬å››é˜¶æ®µï¼šä»£ç ä¼˜åŒ–ï¼ˆå¯é€‰ï¼Œé¢„è®¡4-6å°æ—¶ï¼‰

**ä»»åŠ¡5ï¼šå¼•å…¥ TanStack Query**ï¼ˆ2å°æ—¶ï¼‰
- [ ] å®‰è£…ä¾èµ–
- [ ] é…ç½® QueryClientProvider
- [ ] é‡æ„ RetailPackagePage æ•°æ®è·å–é€»è¾‘
- [ ] é‡æ„ PackageEditorDialog æ•°æ®åŠ è½½é€»è¾‘
- [ ] æµ‹è¯•ç¼“å­˜å’Œè‡ªåŠ¨åˆ·æ–°åŠŸèƒ½

**ä»»åŠ¡6ï¼šç±»å‹å®šä¹‰ä¼˜åŒ–**ï¼ˆ1å°æ—¶ï¼‰
- [ ] åˆ›å»º `frontend/src/types/package.ts`
- [ ] æå–æ‰€æœ‰æ¥å£å®šä¹‰
- [ ] è€ƒè™‘ä½¿ç”¨ OpenAPI Generator

**ä»»åŠ¡7ï¼šAPIè°ƒç”¨å°è£…**ï¼ˆ1å°æ—¶ï¼‰
- [ ] åˆ›å»º `frontend/src/api/packages.ts`
- [ ] å°è£…æ‰€æœ‰å¥—é¤ç›¸å…³API
- [ ] é‡æ„é¡µé¢ç»„ä»¶ä½¿ç”¨å°è£…åçš„API

**ä»»åŠ¡8ï¼šè¡¨å•éªŒè¯å¢å¼º**ï¼ˆ1å°æ—¶ï¼‰
- [ ] æ·»åŠ è”åŠ¨æ¯”ä¾‹èŒƒå›´æ ¡éªŒï¼ˆ10%-20%ï¼‰
- [ ] æ·»åŠ åˆ†æˆæ¯”ä¾‹èŒƒå›´æ ¡éªŒï¼ˆ0-100%ï¼‰
- [ ] æ·»åŠ ä»·æ ¼æ­£æ•°æ ¡éªŒ
- [ ] æ·»åŠ å¿…å¡«é¡¹æ ¡éªŒ

**ä»»åŠ¡9ï¼šå•å…ƒæµ‹è¯•**ï¼ˆå¯é€‰ï¼Œ2-3å°æ—¶ï¼‰
- [ ] å®‰è£…æµ‹è¯•åº“ï¼ˆVitest / Jestï¼‰
- [ ] ç¼–å†™çŠ¶æ€æœºé€»è¾‘æµ‹è¯•
- [ ] ç¼–å†™ä»·æ ¼æ¯”ä¾‹è®¡ç®—æµ‹è¯•
- [ ] ç¼–å†™APIè°ƒç”¨Mockæµ‹è¯•

---

## äº”ã€å®æ–½å»ºè®®

### ä¼˜å…ˆçº§æ’åºï¼ˆæ¨èæ‰§è¡Œé¡ºåºï¼‰

**ç«‹å³æ‰§è¡Œï¼ˆå¿…é¡»ï¼‰ï¼š**
1. âœ… **ä¿®å¤ pricing_mode è¿‡æ»¤** - è§£å†³å½“å‰500é”™è¯¯

**æœ¬å‘¨å®Œæˆï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰ï¼š**
2. âœ… **å®ç° PackageDetailsDialog** - è¡¥å……æ ¸å¿ƒæŸ¥çœ‹åŠŸèƒ½

**è¿‘æœŸå®Œæˆï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰ï¼š**
3. â­ **å®ç°å¯¼å‡ºåŠŸèƒ½** - å®Œå–„ç”¨æˆ·ä½“éªŒ
4. â­ **ä»£ç æ¸…ç†** - æå‡ä»£ç è´¨é‡

**å¯é€‰ä¼˜åŒ–ï¼ˆä½ä¼˜å…ˆçº§ï¼‰ï¼š**
5. ğŸ’¡ å¼•å…¥ TanStack Query - æå‡å¼€å‘ä½“éªŒ
6. ğŸ’¡ ç±»å‹å®šä¹‰ä¼˜åŒ– - æå‡ç±»å‹å®‰å…¨
7. ğŸ’¡ APIè°ƒç”¨å°è£… - æå‡å¯ç»´æŠ¤æ€§
8. ğŸ’¡ è¡¨å•éªŒè¯å¢å¼º - å‡å°‘åç«¯é”™è¯¯
9. ğŸ’¡ å•å…ƒæµ‹è¯• - æå‡ä»£ç å¯é æ€§

---

## å…­ã€æ€»ç»“

### æ ¸å¿ƒç»“è®º

å½“å‰é›¶å”®å¥—é¤ç®¡ç†æ¨¡å—å·²ç»å®ç°äº† **85%çš„æ ¸å¿ƒåŠŸèƒ½**ï¼ŒåŒ…æ‹¬ï¼š

âœ… **å·²å®Œæˆï¼š**
- å®Œæ•´çš„CRUDæ“ä½œ
- ä¸¥æ ¼çš„çŠ¶æ€æœºç®¡ç†ï¼ˆè‰ç¨¿â†’ç”Ÿæ•ˆâ†’å½’æ¡£ï¼‰
- ä¼˜ç§€çš„å“åº”å¼è®¾è®¡ï¼ˆç§»åŠ¨ç«¯+æ¡Œé¢ç«¯ï¼‰
- å®Œå–„çš„UXåé¦ˆæœºåˆ¶ï¼ˆTooltip + Snackbar + äºŒæ¬¡ç¡®è®¤ï¼‰
- ä»·æ ¼æ¯”ä¾‹å®æ—¶æ ¡éªŒå’Œè­¦å‘Š
- å¥—é¤åç§°å”¯ä¸€æ€§çº¦æŸ
- æ™ºèƒ½å¤åˆ¶å‘½å
- JWTè®¤è¯ä¿æŠ¤

âŒ **ä¸»è¦ç¼ºå¤±ï¼š**
- **pricing_mode è¿‡æ»¤æ”¯æŒ**ï¼ˆå¯¼è‡´å½“å‰500é”™è¯¯ï¼‰
- **è¯¦æƒ…è§†å›¾ç»„ä»¶**ï¼ˆè®¾è®¡æ–¹æ¡ˆç¬¬ä¹èŠ‚çš„å¢å¼ºåŠŸèƒ½ï¼‰
- **å¯¼å‡ºåŠŸèƒ½**ï¼ˆæŒ‰é’®å·²å­˜åœ¨ä½†æœªå®ç°ï¼‰

### è®¾è®¡æ–¹æ¡ˆç¬¦åˆåº¦è¯„ä¼°

| è®¾è®¡æ–¹æ¡ˆç« èŠ‚ | ç¬¦åˆåº¦ | è¯´æ˜ |
|------------|--------|------|
| ä¸€ã€ç³»ç»Ÿæ¶æ„è®¾è®¡ | 100% | æŠ€æœ¯æ ˆå®Œå…¨ä¸€è‡´ |
| äºŒã€UIéœ€æ±‚æ–¹æ¡ˆ | 95% | åŒå¡ç‰‡å¸ƒå±€å®Œç¾å®ç°ï¼Œç¼ºè¯¦æƒ…è§†å›¾ |
| ä¸‰ã€æ•°æ®åº“è®¾è®¡ | 100% | é›†åˆç»“æ„å’Œç´¢å¼•å®Œå…¨ä¸€è‡´ |
| å››ã€APIè®¾è®¡ | 95% | 8ä¸ªç«¯ç‚¹å®ç°ï¼Œç¼ºpricing_modeå‚æ•° |
| äº”ã€å‰ç«¯ç»„ä»¶è®¾è®¡ | 90% | æ ¸å¿ƒç»„ä»¶å®Œæˆï¼Œç¼ºPackageDetailsDialog |
| å…­ã€å“åº”å¼è®¾è®¡ç­–ç•¥ | 100% | ç§»åŠ¨ç«¯å¡ç‰‡+æ¡Œé¢ç«¯è¡¨æ ¼å®Œç¾å®ç° |
| å…«ã€çŠ¶æ€æœºç®¡ç† | 100% | çŠ¶æ€è½¬æ¢è§„åˆ™ä¸¥æ ¼å®ç° |
| ä¹ã€è¯¦æƒ…è§†å›¾å¢å¼º | 0% | å®Œå…¨æœªå®ç° |

**æ€»ä½“ç¬¦åˆåº¦ï¼š85%**

### é£é™©æç¤º

ğŸ”´ **å½“å‰é˜»å¡é—®é¢˜ï¼š**
- pricing_mode è¿‡æ»¤å¯¼è‡´çš„500é”™è¯¯å¿…é¡»ç«‹å³ä¿®å¤ï¼Œå¦åˆ™å½±å“åŸºæœ¬ä½¿ç”¨

ğŸŸ¡ **ç”¨æˆ·ä½“éªŒç¼ºé™·ï¼š**
- æ— æ³•æŸ¥çœ‹ç”Ÿæ•ˆ/å½’æ¡£å¥—é¤çš„è¯¦ç»†é…ç½®ï¼Œéœ€è¦å°½å¿«è¡¥å……è¯¦æƒ…è§†å›¾

ğŸŸ¢ **å¯æ¥å—çš„ç¼ºå¤±ï¼š**
- å¯¼å‡ºåŠŸèƒ½ä¸å½±å“æ ¸å¿ƒä¸šåŠ¡æµç¨‹
- ä»£ç ä¼˜åŒ–å¯ä»¥æ¸è¿›å¼è¿›è¡Œ

---

**æŠ¥å‘Šç”Ÿæˆå®Œæ¯•**

å»ºè®®ä¼˜å…ˆçº§ï¼š**ä¿®å¤è¿‡æ»¤bug â†’ å®ç°è¯¦æƒ…è§†å›¾ â†’ å®Œå–„å¯¼å‡ºåŠŸèƒ½**
