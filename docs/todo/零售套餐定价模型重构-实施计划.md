# 零售套餐定价模型重构 - 分会话实施计划

> 基于方案：零售套餐定价模型重构方案-v4.md
> 创建时间：2025-01-07
> 预计总Token消耗：180-220k
> 预计会话数：6-8个

---

## 📋 会话划分总览

| 会话 | 主要内容 | 预计Token | 关键文件 | 状态 |
|------|---------|-----------|---------|------|
| 1 | 后端模型配置 | 15-20k | pricing_model.py, 初始化脚本 | ⏳ 待开始 |
| 2 | RetailPackage重构 | 20-25k | retail_package.py, 迁移脚本 | ⏳ 待开始 |
| 3 | API和服务层 | 25-30k | pricing_model_service.py, v1.py, package_service.py | ⏳ 待开始 |
| 4 | 前端架构 | 25-30k | usePackageForm.ts, PackageEditorDialog.tsx, PricingConfigForm.tsx | ⏳ 待开始 |
| 5 | 表单组件（第一批） | 30-35k | 8个表单组件 | ⏳ 待开始 |
| 6 | 表单组件（第二批） | 30-35k | 10个表单组件 | ⏳ 待开始 |
| 7 | 展示和列表 | 20-25k | PackageDetailsDialog.tsx, RetailPackagePage.tsx | ⏳ 待开始 |
| 8 | 测试优化 | 15-20k | 全面测试、优化 | ⏳ 待开始 |

**状态说明**：
- ⏳ 待开始
- 🚧 进行中
- ✅ 已完成
- ⚠️ 遇到问题

---

## 会话1：后端数据模型基础

**预计token消耗：15-20k**

### 提示词
```
零售套餐定价模型重构 - 会话1：后端数据模型基础

参考文档：docs/todo/零售套餐定价模型重构方案-v4.md

本次任务：
1. 创建 pricing_models 数据库集合（MongoDB）
2. 编写初始化脚本，导入18种定价模型配置（从 docs/零售套餐模型.json 转换）
3. 在 webapp/models/ 下创建 pricing_model.py，定义 PricingModel Pydantic模型
4. 测试模型配置的读取

注意事项：
- model_code 命名遵循规范：{pricing_mode}_{floating_type}_{package_type}
- 确保 formula 和 description 字段完整迁移
- 所有18种模型都要导入
```

### 交付物清单
- [ ] `webapp/models/pricing_model.py` - PricingModel Pydantic模型
- [ ] `webapp/scripts/init_pricing_models.py` - 数据初始化脚本
- [ ] MongoDB `pricing_models` 集合（包含18条记录）
- [ ] 简单的读取测试脚本

### 验收标准
- 数据库中成功创建18条定价模型记录
- 每条记录包含完整的 formula 和 description
- model_code 命名符合规范
- 可以通过 Python 脚本成功查询所有模型

---

## 会话2：后端RetailPackage模型重构

**预计token消耗：20-25k**

### 提示词
```
零售套餐定价模型重构 - 会话2：RetailPackage模型重构

参考文档：docs/todo/零售套餐定价模型重构方案-v4.md（第3.1.2节）

本次任务：
1. 备份当前 webapp/models/retail_package.py
2. 重构 RetailPackage 模型：
   - 添加 model_code: str 字段
   - 删除 pricing_mode 枚举字段
   - 删除 fixed_linked_config 和 price_spread_config
   - 添加统一的 pricing_config: dict 字段
3. 保留 is_green_power、green_power_config、validation 等字段
4. 更新 RetailPackageListItem 模型（添加 model_code）
5. 编写数据迁移脚本（清空旧数据或转换格式）

关键点：
- pricing_config 采用扁平化字典结构
- 保持向后兼容性（如果有旧数据需要转换）
```

### 交付物清单
- [ ] `webapp/models/retail_package.py.bak` - 旧模型备份
- [ ] `webapp/models/retail_package.py` - 重构后的模型
- [ ] `webapp/scripts/migrate_retail_packages.py` - 数据迁移脚本
- [ ] 迁移执行日志

### 验收标准
- RetailPackage 模型包含 model_code 和 pricing_config 字段
- 旧的 pricing_mode、fixed_linked_config、price_spread_config 已删除
- 数据库中的旧套餐数据已清空或成功转换
- 模型可以正常序列化和反序列化

---

## 会话3：后端API和服务层

**预计token消耗：25-30k**

### 提示词
```
零售套餐定价模型重构 - 会话3：API和服务层实现

参考文档：docs/todo/零售套餐定价模型重构方案-v4.md（第3.3节）

本次任务：
1. 创建 webapp/services/pricing_model_service.py，实现：
   - list_pricing_models(package_type: Optional[str])
   - get_pricing_model(model_code: str)
   - validate_pricing_config(model_code: str, config: dict)

2. 在 webapp/api/v1.py 中添加路由：
   - GET /api/v1/pricing-models
   - GET /api/v1/pricing-models/{model_code}
   - POST /api/v1/pricing-models/{model_code}/validate

3. 更新 webapp/services/package_service.py：
   - 适配新的 pricing_config 结构
   - 根据 model_code 执行不同的校验逻辑
   - 更新 create_package、update_package 方法

4. 测试所有API端点

关键点：
- 参考方案第5.2节实现价格校验规则
- 确保API响应格式正确
```

### 交付物清单
- [ ] `webapp/services/pricing_model_service.py` - 定价模型服务
- [ ] `webapp/api/v1.py` - 新增API路由
- [ ] `webapp/services/package_service.py` - 更新后的套餐服务
- [ ] API测试脚本或Postman集合

### 验收标准
- GET /api/v1/pricing-models 返回18条记录
- GET /api/v1/pricing-models/{model_code} 返回正确的模型详情
- POST /api/v1/pricing-models/{model_code}/validate 能正确校验配置
- 套餐创建/更新API适配新的数据结构
- 价格校验规则正确实现（固定价格上下限、联动比例、463号文比例）

---

## 会话4：前端架构重构

**预计token消耗：25-30k**

### 提示词
```
零售套餐定价模型重构 - 会话4：前端架构重构

参考文档：docs/todo/零售套餐定价模型重构方案-v4.md（第3.2节）

本次任务：
1. 修改 frontend/src/hooks/usePackageForm.ts：
   - 更新 PackageFormData 接口：添加 model_code，删除 pricing_mode
   - pricing_config 改为 Record<string, any>

2. 重构 frontend/src/components/PackageEditorDialog.tsx：
   - 实现三步流程：选择分时维度 → 选择定价模型 → 配置参数
   - 从 API 获取可用模型列表
   - 根据 model_code 显示对应表单

3. 创建 frontend/src/components/pricing/PricingConfigForm.tsx（路由组件）：
   - 根据 model_code 渲染不同的子表单
   - 提供统一的 props 接口

4. 创建表单组件目录结构：
   frontend/src/components/pricing/forms/
   ├── FixedLinkedFeeForm.tsx
   ├── FixedLinkedPriceForm.tsx
   ├── ReferenceLinkedFeeForm.tsx
   └── ... (其他表单组件的占位文件)

5. 实现 PricingConfigForm 的 switch 路由逻辑

关键点：
- 遵循 CLAUDE.md 中的 Grid v7 语法和响应式规范
- 表单组件需要支持 isTimeBased 参数区分分时/不分时
```

### 交付物清单
- [ ] `frontend/src/hooks/usePackageForm.ts` - 更新后的表单Hook
- [ ] `frontend/src/components/PackageEditorDialog.tsx` - 重构后的编辑对话框
- [ ] `frontend/src/components/pricing/PricingConfigForm.tsx` - 路由组件
- [ ] `frontend/src/components/pricing/forms/` - 表单组件目录（含占位文件）
- [ ] `frontend/src/types/pricing.ts` - 定价相关类型定义（可选）

### 验收标准
- 编辑对话框可以正常显示模型选择流程
- 从API成功获取18种定价模型列表
- PricingConfigForm 根据 model_code 正确路由到占位组件
- 前端编译无错误
- 遵循Material-UI v7 Grid语法（使用 size 属性）

---

## 会话5：前端表单组件（第一批）

**预计token消耗：30-35k**

### 提示词
```
零售套餐定价模型重构 - 会话5：表单组件实现（固定价+联动价系列）

参考文档：docs/todo/零售套餐定价模型重构方案-v4.md（第3.2.3节）

本次任务：
完整实现以下4个表单组件（每个支持分时/不分时）：

1. FixedLinkedFeeForm.tsx - 固定价格+联动价格+浮动费用
2. FixedLinkedPriceForm.tsx - 固定价格+联动价格+浮动价
3. ReferenceLinkedFeeForm.tsx - 参考价+联动价格+浮动费用
4. ReferenceLinkedPriceForm.tsx - 参考价+联动价格+浮动价

每个组件需要：
- 使用 react-hook-form 的 Controller
- 遵循 Material-UI v7 Grid 语法（size 属性）
- 响应式布局（xs/sm/md断点）
- 显示对应的 helperText（取自套餐说明）
- 分时模式下显示5个时段价格输入（peak/high/flat/valley/deep_valley）
- 不分时模式下显示单一价格输入

测试要点：
- 在编辑对话框中选择对应模型，验证表单正确渲染
- 验证表单数据能正确提交到后端
```

### 交付物清单
- [ ] `frontend/src/components/pricing/forms/FixedLinkedFeeForm.tsx`
- [ ] `frontend/src/components/pricing/forms/FixedLinkedPriceForm.tsx`
- [ ] `frontend/src/components/pricing/forms/ReferenceLinkedFeeForm.tsx`
- [ ] `frontend/src/components/pricing/forms/ReferenceLinkedPriceForm.tsx`

### 验收标准
- 4个表单组件完整实现
- 分时/不分时模式显示正确
- 表单字段验证正确（必填项、数值范围）
- 响应式布局在移动端和桌面端均正常
- 可以成功创建套餐并保存到数据库
- helperText 显示套餐说明的关键内容

---

## 会话6：前端表单组件（第二批）

**预计token消耗：30-35k**

### 提示词
```
零售套餐定价模型重构 - 会话6：表单组件实现（价差分成+单一综合价系列）

参考文档：docs/todo/零售套餐定价模型重构方案-v4.md（第3.2.3节）

本次任务：
完整实现以下6个表单组件：

1. PriceSpreadSimpleFeeForm.tsx - 价差分成+浮动费用
2. PriceSpreadSimplePriceForm.tsx - 价差分成+浮动价
3. PriceSpreadFormulaFeeForm.tsx - 价差分成（价差公式）+浮动费用
4. PriceSpreadFormulaPriceForm.tsx - 价差分成（价差公式）+浮动价
5. SingleComprehensiveFixedForm.tsx - 单一综合价_固定价（仅分时）
6. SingleComprehensiveReferenceForm.tsx - 单一综合价_参考价（仅分时）

特殊要点：
- 价差公式型表单需要3个参考价下拉框（reference_1/2/3_type）
- 单一综合价表单只需输入平段基准价（其他时段自动计算）
- 参考价下拉框选项需要根据分时/不分时区分

测试要点：
- 测试价差公式的3个参考价选择
- 测试单一综合价的自动浮动说明显示
```

### 交付物清单
- [ ] `frontend/src/components/pricing/forms/PriceSpreadSimpleFeeForm.tsx`
- [ ] `frontend/src/components/pricing/forms/PriceSpreadSimplePriceForm.tsx`
- [ ] `frontend/src/components/pricing/forms/PriceSpreadFormulaFeeForm.tsx`
- [ ] `frontend/src/components/pricing/forms/PriceSpreadFormulaPriceForm.tsx`
- [ ] `frontend/src/components/pricing/forms/SingleComprehensiveFixedForm.tsx`
- [ ] `frontend/src/components/pricing/forms/SingleComprehensiveReferenceForm.tsx`

### 验收标准
- 6个表单组件完整实现
- 价差公式型表单的3个参考价选择正确
- 单一综合价表单显示自动浮动说明（Alert组件）
- 参考价选项根据分时/不分时正确显示
- 所有模型都能成功创建和保存
- 前端编译无错误

---

## 会话7：前端展示和列表页面

**预计token消耗：20-25k**

### 提示词
```
零售套餐定价模型重构 - 会话7：详情展示和列表页面更新

参考文档：docs/todo/零售套餐定价模型重构方案-v4.md（第四阶段 Step 7-8）

本次任务：
1. 更新 PackageDetailsDialog.tsx：
   - 根据 model_code 动态渲染定价配置详情
   - 显示模型的计算公式（从 API 获取）
   - 显示套餐说明（HTML格式）
   - 创建不同模型的详情展示组件（复用表单组件的布局）

2. 更新 RetailPackagePage.tsx：
   - 表格列显示定价模型名称（从 model_code 转换，或从 API 查询）
   - 筛选器添加"定价模型"下拉框
   - 前端缓存 pricing_models 列表（减少API调用）

3. 创建 hooks/usePricingModels.ts：
   - 封装模型列表的获取和缓存逻辑
   - 提供 getModelDisplayName(model_code) 工具函数

测试要点：
- 测试不同模型的详情展示正确性
- 测试列表页筛选功能
- 验证模型名称显示正确
```

### 交付物清单
- [ ] `frontend/src/components/PackageDetailsDialog.tsx` - 更新后的详情对话框
- [ ] `frontend/src/pages/RetailPackagePage.tsx` - 更新后的列表页面
- [ ] `frontend/src/hooks/usePricingModels.ts` - 定价模型Hook
- [ ] `frontend/src/components/pricing/details/` - 详情展示组件目录（可选）

### 验收标准
- 详情对话框正确显示计算公式和套餐说明
- 列表页显示定价模型名称（中文）
- 筛选器可以按定价模型筛选
- 模型列表有缓存机制，避免重复请求
- 所有页面响应式布局正常

---

## 会话8：测试验证和优化

**预计token消耗：15-20k**

### 提示词
```
零售套餐定价模型重构 - 会话8：测试验证和优化

参考文档：docs/todo/零售套餐定价模型重构方案-v4.md（第四阶段 Step 10）

本次任务：
1. 完整功能测试：
   - 测试所有18种模型的创建流程
   - 测试编辑功能（草稿状态）
   - 测试复制功能
   - 测试详情查看
   - 测试列表筛选

2. 价格校验测试：
   - 测试固定价格上下限校验
   - 测试联动比例校验（分时10-20%，不分时≤20%）
   - 测试463号文比例校验（分时）
   - 测试封顶价格提示

3. 响应式测试：
   - 移动端测试（iPhone/Android）
   - 桌面端测试
   - 不同屏幕尺寸测试

4. 性能优化：
   - 检查 API 调用次数
   - 优化表单渲染性能
   - 添加必要的 loading 状态

5. 代码整理：
   - 删除旧代码注释
   - 统一代码风格
   - 补充必要的注释

6. 提交代码：
   - 编写完整的 commit message
   - 更新相关文档
```

### 交付物清单
- [ ] 测试报告（markdown文档）
- [ ] 已知问题清单（如果有）
- [ ] 性能优化记录
- [ ] Git提交记录

### 验收标准
- 所有18种模型创建、编辑、复制、查看功能正常
- 价格校验规则全部生效
- 移动端和桌面端响应式布局正常
- 无明显性能问题
- 代码风格统一，注释完整
- Git提交信息清晰

---

## 💡 使用指南

### 1. 开始新会话
直接复制对应会话的**提示词**部分，在新的Claude Code会话中粘贴。

### 2. 每次会话结束前
```bash
# 查看改动
git status

# 临时提交
git add .
git commit -m "WIP: 会话X完成"

# 验证编译（前端）
npm run build --prefix frontend

# 或运行测试（后端）
pytest webapp/tests/
```

### 3. 继续未完成的会话
如果某个会话中断或遇到问题：
```
继续会话X的任务，上次在{具体步骤}遇到问题：{问题描述}

参考文档：docs/todo/零售套餐定价模型重构方案-v4.md
参考实施计划：docs/todo/零售套餐定价模型重构-实施计划.md
```

### 4. 最终提交
所有会话完成后：
```bash
git add .
git commit -m "feat(retail): 零售套餐定价模型重构完成

- 支持18种定价模型
- 动态表单配置
- 完整的价格校验
- 响应式UI优化

🤖 Generated with Claude Code

Co-Authored-By: Claude <noreply@anthropic.com>"
```

---

## 📊 进度跟踪

### 当前进度
- [ ] 会话1：后端数据模型基础
- [ ] 会话2：RetailPackage模型重构
- [ ] 会话3：后端API和服务层
- [ ] 会话4：前端架构重构
- [ ] 会话5：前端表单组件（第一批）
- [ ] 会话6：前端表单组件（第二批）
- [ ] 会话7：前端展示和列表页面
- [ ] 会话8：测试验证和优化

### 完成时间记录
- 会话1：____年__月__日
- 会话2：____年__月__日
- 会话3：____年__月__日
- 会话4：____年__月__日
- 会话5：____年__月__日
- 会话6：____年__月__日
- 会话7：____年__月__日
- 会话8：____年__月__日

### 遇到的问题和解决方案
记录每个会话中遇到的问题和解决方案，供后续参考：

#### 会话1问题记录
- 问题：
- 解决方案：

#### 会话2问题记录
- 问题：
- 解决方案：

（以此类推...）

---

## 📝 注意事项

1. **必须按顺序执行**：后续会话依赖前面的成果
2. **每次验证编译**：前端修改后运行 `npm run build`
3. **及时提交代码**：每个会话结束后创建临时提交
4. **参考CLAUDE.md**：前端开发严格遵循项目规范
5. **保持沟通**：遇到问题及时在会话中反馈
6. **文档同步**：重要决策和修改记录在本文档中

---

## 🎯 预期成果

完成所有8个会话后，将实现：

✅ **后端**：
- 18种定价模型配置存储在数据库
- 统一的 pricing_config 数据结构
- 完整的API接口和服务层
- 完善的价格校验规则

✅ **前端**：
- 三步式模型选择流程
- 18个动态表单组件
- 详情展示和列表筛选
- 完全响应式的UI

✅ **质量保障**：
- 完整的功能测试
- 价格校验测试
- 移动端和桌面端兼容
- 代码规范和注释完整

---

**最后更新**：2025-01-07
**维护者**：项目团队
