# 会话过期处理测试指南

## 功能概述

本项目已实现混合模式的会话过期处理方案，包含：
1. **前端主动超时机制**：基于 JWT 过期时间的自动登出定时器
2. **401 响应拦截器**：作为安全网处理边缘情况

## 实现文件

- `frontend/src/contexts/AuthContext.tsx` - 认证上下文和 Provider
- `frontend/src/api/client.ts` - API 客户端和 401 拦截器
- `frontend/src/pages/LoginPage.tsx` - 登录页面集成
- `frontend/src/App.tsx` - 应用入口集成 AuthProvider

## 测试场景

### 测试 1：正常登录和定时器启动

**步骤：**
1. 打开浏览器开发者工具（F12），切换到 Console 标签
2. 访问 `http://localhost:3000/login`
3. 输入用户名和密码，点击登录

**预期结果：**
- Console 中应显示类似：`会话将在 30 分钟后过期`
- 成功跳转到主页
- localStorage 中应存储 `token`

---

### 测试 2：页面刷新后定时器恢复

**步骤：**
1. 在已登录状态下，刷新浏览器页面（F5）
2. 观察 Console 输出

**预期结果：**
- Console 中应显示类似：`恢复会话，将在 X 分钟后过期`（X 为剩余时间）
- 用户仍然保持登录状态
- 不会跳转到登录页

---

### 测试 3：手动清除 Token 后的处理

**步骤：**
1. 在已登录状态下，打开浏览器开发者工具
2. 切换到 Application（或 Storage）标签
3. 在 Local Storage 中删除 `token` 项
4. 刷新页面

**预期结果：**
- 自动跳转到登录页
- Console 中没有错误信息

---

### 测试 4：Token 过期后的自动登出

**步骤：**
1. 修改后端 JWT 过期时间为 1 分钟（用于快速测试）
   - 编辑 `webapp/main.py`，找到 `ACCESS_TOKEN_EXPIRE_MINUTES = 30`
   - 临时改为 `ACCESS_TOKEN_EXPIRE_MINUTES = 1`
   - 重启后端服务器
2. 重新登录系统
3. 观察 Console，应显示 `会话将在 1 分钟后过期`
4. 等待 1 分钟

**预期结果：**
- 1 分钟后，Console 显示 `会话已过期，自动登出`
- 自动跳转到登录页
- localStorage 中的 `token` 被清除

---

### 测试 5：401 响应拦截器（安全网）

**步骤：**
1. 确保已登录状态
2. 在浏览器开发者工具中，修改 localStorage 中的 `token` 为无效值
   - Application → Local Storage → token
   - 修改为任意字符串，如 `invalid_token_xxx`
3. 在系统中执行任何需要认证的操作（如切换页面、查看数据）

**预期结果：**
- Console 显示 `收到 401 响应，会话已失效`
- 自动跳转到登录页
- 无效的 token 被清除

---

### 测试 6：多标签页同步（可选高级测试）

**步骤：**
1. 打开两个浏览器标签页，都登录到系统
2. 在其中一个标签页中等待会话过期

**预期结果：**
- 过期的标签页会自动跳转到登录页
- 另一个标签页在下次执行 API 操作时，会因为 401 响应而自动登出

**注意：** 当前实现不支持跨标签页实时同步登出状态，但通过 401 拦截器可以确保安全性。

---

## 预期的 Console 日志输出

### 正常登录流程
```
会话将在 30 分钟后过期
```

### 页面刷新流程
```
恢复会话，将在 29 分钟后过期
```

### 会话过期流程
```
会话已过期，自动登出
```

### 401 响应拦截
```
收到 401 响应，会话已失效
```

---

## 测试后恢复操作

如果修改了后端的 JWT 过期时间用于测试，记得改回原值：
```python
# webapp/main.py
ACCESS_TOKEN_EXPIRE_MINUTES = 30  # 改回 30 分钟
```

然后重启后端服务器。

---

## 常见问题排查

### 问题 1：Console 没有任何日志输出

**可能原因：**
- Console 被过滤或清除了
- 浏览器禁用了控制台输出

**解决方案：**
- 确保 Console 过滤器设置为显示所有级别（Verbose、Info、Warning、Error）
- 刷新页面重新观察

### 问题 2：定时器没有触发自动登出

**可能原因：**
- JWT 的 `exp` 字段解析失败
- 定时器在页面关闭/刷新前就被清除了

**解决方案：**
- 检查后端返回的 JWT 格式是否正确
- 在 `AuthContext.tsx` 中添加更多调试日志

### 问题 3：401 拦截器没有工作

**可能原因：**
- 后端没有返回 401 状态码
- axios 拦截器配置错误

**解决方案：**
- 使用 Network 标签检查 API 响应的状态码
- 确保 `client.ts` 中的拦截器正确配置

---

## 技术细节

### JWT 过期时间计算
```typescript
const decoded = jwtDecode<JwtPayload>(token);
const expTimestamp = decoded.exp * 1000; // 转换为毫秒
const currentTime = Date.now();
const expiresIn = expTimestamp - currentTime; // 剩余时间（毫秒）
```

### 定时器清理机制
```typescript
useEffect(() => {
    // 初始化逻辑...

    return () => {
        // 组件卸载时清除定时器
        if (logoutTimer) {
            clearTimeout(logoutTimer);
        }
    };
}, []);
```

---

## 总结

本方案提供了双重保障：
1. **用户体验优先**：前端定时器确保用户在会话过期时立即感知
2. **安全性保障**：401 拦截器确保在任何边缘情况下都能正确处理认证失败

这种混合模式既提升了用户体验，又确保了系统的安全性和可靠性。
