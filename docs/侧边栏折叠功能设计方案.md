# 侧边栏折叠功能设计方案

## 文档信息

| 项目 | 内容 |
|------|------|
| 文档版本 | v1.0 |
| 创建日期 | 2025-11-04 |
| 适用范围 | 桌面端侧边栏交互优化 |
| 目标平台 | Desktop (≥900px) |

---

## 一、需求概述

### 1.1 背景

当前系统侧边栏固定显示，在某些场景下（大屏展示、数据密集型页面）需要更多的内容显示空间。用户需要能够按需隐藏/显示侧边栏。

### 1.2 目标

- **提升空间利用率**：折叠侧边栏后，主内容区可扩展至全宽
- **保持交互一致性**：折叠/展开操作简单直观
- **记忆用户偏好**：保存折叠状态，刷新后恢复
- **保持响应式兼容**：移动端不受影响，保持原有交互

### 1.3 适用场景

✅ **适用**：
- 桌面端浏览器（屏幕宽度 ≥900px）
- 需要大幅面数据展示的场景（图表、表格等）

❌ **不适用**：
- 移动端（<900px）
- 平板竖屏模式

---

## 二、设计方案

### 2.1 方案选型对比

#### 方案A：完全隐藏模式 ⭐ **最终选定**

**描述**：点击按钮完全隐藏侧边栏，主内容区扩展到全宽。

**优点**：
- ✅ 实现简单，维护成本低
- ✅ 最大化内容显示空间
- ✅ 交互逻辑清晰，无歧义
- ✅ 性能优秀（纯CSS动画）

**缺点**：
- ⚠️ 完全隐藏后需要点击按钮才能访问菜单

**选型理由**：
1. 符合项目当前架构
2. 用户行为明确，学习成本低
3. 实现周期短，风险可控

---

#### 方案B：迷你侧边栏模式（备选）

**描述**：折叠时保留60px宽度，仅显示图标。

**优点**：
- 快速访问常用菜单
- 视觉连续性好

**缺点**：
- 实现复杂度高
- 需要重新设计图标版菜单
- 仍占用一定空间

**评估结论**：未来可考虑，当前不采用。

---

#### 方案C：抽屉式悬浮（不推荐）

**描述**：隐藏时不占空间，点击按钮悬浮显示。

**缺点**：
- 与移动端行为混淆
- 遮挡内容影响体验

**评估结论**：不符合桌面端交互习惯。

---

### 2.2 UI/UX 设计

#### 2.2.1 视觉状态

**展开状态**（默认）

```
┌────────────────────────────────────────────────────────┐
│ [📊] 电力交易辅助分析系统 [<<]    [2025-11-04 14:30] [👤] │ ← AppBar
├──────────┬─────────────────────────────────────────────┤
│          │ 现货价格分析 [×]  总体负荷分析 [×]          │ ← 页签栏
│ 🏠 总览  ├─────────────────────────────────────────────┤
│ 👥 客户  │                                             │
│ 📈 负荷  │           主内容区                          │
│ 💹 价格  │                                             │
│          │                                             │
└──────────┴─────────────────────────────────────────────┘
  260px                  剩余宽度
```

**折叠状态**

```
┌────────────────────────────────────────────────────────┐
│ [📊] 电力交易辅助分析系统 [>>]    [2025-11-04 14:30] [👤] │ ← AppBar
├────────────────────────────────────────────────────────┤
│ 现货价格分析 [×]  总体负荷分析 [×]  日前分析 [×]      │ ← 页签栏
├────────────────────────────────────────────────────────┤
│                                                        │
│              主内容区（全屏宽度）                      │
│                                                        │
└────────────────────────────────────────────────────────┘
                    100% 宽度
```

#### 2.2.2 交互元素

**折叠按钮**

| 位置 | AppBar 中，系统标题右侧 |
|------|------------------------|
| 图标 | 展开时：`ChevronLeft`；折叠时：`Menu` |
| 颜色 | 继承 AppBar 主题色（白色） |
| 尺寸 | 默认 IconButton 尺寸 |
| Tooltip | "折叠菜单" / "展开菜单" |
| 快捷键 | `Ctrl + B` |

**按钮位置示意**

```typescript
<Toolbar>
    <InsightsIcon />
    <Typography>电力交易辅助分析系统</Typography>
    <IconButton> {/* ← 折叠按钮 */}
        {sidebarCollapsed ? <MenuIcon /> : <ChevronLeftIcon />}
    </IconButton>
    <Box sx={{ flexGrow: 1 }} />
    {/* 右侧：日期时间、账号菜单 */}
</Toolbar>
```

#### 2.2.3 动画效果

| 属性 | 配置 |
|------|------|
| 动画类型 | CSS Transition |
| 持续时间 | 300ms |
| 缓动函数 | `ease-in-out` |
| 影响元素 | Drawer 宽度、主内容区宽度 |

**动画时序**

```
用户点击按钮
    ↓
状态切换（立即）
    ↓
    ├─→ Drawer 宽度变化（300ms）
    └─→ 主内容区宽度变化（300ms）
           ↓
        内容自适应重排
```

---

## 三、技术实现方案

### 3.1 架构设计

#### 3.1.1 组件关系

```
DesktopTabLayout (父组件)
  ├─ AppBar (顶部工具栏)
  │   └─ 折叠按钮
  ├─ Drawer (侧边栏容器)
  │   └─ Sidebar (菜单内容)
  └─ Box (主内容区)
      ├─ Tabs (页签栏)
      └─ TabPanel (页面内容)
```

#### 3.1.2 状态管理

**状态定义**

```typescript
const [sidebarCollapsed, setSidebarCollapsed] = useState<boolean>(false);
```

**持久化策略**

- **存储位置**：`localStorage`
- **存储键**：`sidebarCollapsed`
- **存储格式**：JSON 布尔值
- **读取时机**：组件挂载时
- **保存时机**：状态变更时

### 3.2 核心代码实现

#### 3.2.1 状态初始化与持久化

```typescript
import { useState, useEffect } from 'react';

export const DesktopTabLayout: React.FC = () => {
    const [sidebarCollapsed, setSidebarCollapsed] = useState(false);

    // 组件挂载时读取持久化状态
    useEffect(() => {
        const savedState = localStorage.getItem('sidebarCollapsed');
        if (savedState !== null) {
            try {
                setSidebarCollapsed(JSON.parse(savedState));
            } catch (e) {
                console.error('Failed to parse sidebar state:', e);
            }
        }
    }, []);

    // 状态变更时保存
    useEffect(() => {
        localStorage.setItem('sidebarCollapsed', JSON.stringify(sidebarCollapsed));
    }, [sidebarCollapsed]);

    // ...
};
```

#### 3.2.2 宽度计算

```typescript
const drawerWidth = 260;
const collapsedDrawerWidth = 0;

const currentDrawerWidth = sidebarCollapsed ? collapsedDrawerWidth : drawerWidth;
```

#### 3.2.3 Drawer 组件配置

```typescript
<Drawer
    variant="permanent"
    sx={{
        display: { xs: 'none', sm: 'block' },
        '& .MuiDrawer-paper': {
            boxSizing: 'border-box',
            width: currentDrawerWidth,
            transition: 'width 0.3s ease-in-out',
            overflowX: 'hidden',
            borderRight: sidebarCollapsed ? 'none' : '1px solid',
            borderColor: 'divider',
        },
    }}
    open
>
    {!sidebarCollapsed && <Sidebar />}
</Drawer>
```

**关键配置说明**：

- `width: currentDrawerWidth`：动态宽度
- `transition: 'width 0.3s ease-in-out'`：平滑过渡
- `overflowX: 'hidden'`：防止内容溢出
- `{!sidebarCollapsed && <Sidebar />}`：折叠时卸载内容，提升性能

#### 3.2.4 主内容区适配

```typescript
<Box
    component="main"
    sx={{
        flexGrow: 1,
        width: { sm: `calc(100% - ${currentDrawerWidth}px)` },
        transition: 'width 0.3s ease-in-out',
        display: 'flex',
        flexDirection: 'column',
    }}
>
    {/* 页签栏和内容 */}
</Box>
```

#### 3.2.5 切换按钮实现

```typescript
import ChevronLeftIcon from '@mui/icons-material/ChevronLeft';
import MenuIcon from '@mui/icons-material/Menu';
import { Tooltip } from '@mui/material';

<Tooltip title={sidebarCollapsed ? "展开菜单" : "折叠菜单"}>
    <IconButton
        color="inherit"
        onClick={() => setSidebarCollapsed(!sidebarCollapsed)}
        sx={{
            ml: 1,
            display: { xs: 'none', sm: 'inline-flex' },
        }}
        aria-label={sidebarCollapsed ? "展开菜单" : "折叠菜单"}
    >
        {sidebarCollapsed ? <MenuIcon /> : <ChevronLeftIcon />}
    </IconButton>
</Tooltip>
```

#### 3.2.6 快捷键支持（可选）

```typescript
useEffect(() => {
    const handleKeyPress = (e: KeyboardEvent) => {
        // Ctrl + B 切换侧边栏
        if (e.ctrlKey && e.key === 'b') {
            e.preventDefault();
            setSidebarCollapsed(prev => !prev);
        }
    };

    window.addEventListener('keydown', handleKeyPress);
    return () => window.removeEventListener('keydown', handleKeyPress);
}, []);
```

### 3.3 响应式断点配置

| 断点 | 屏幕宽度 | 折叠按钮显示 | 侧边栏行为 |
|------|---------|-------------|-----------|
| `xs` | 0-600px | 隐藏 | 移动端抽屉（不受影响） |
| `sm` | 600-900px | 隐藏 | 移动端抽屉（不受影响） |
| `md+` | ≥900px | 显示 | 可折叠固定侧边栏 |

**实现代码**

```typescript
sx={{ display: { xs: 'none', sm: 'none', md: 'inline-flex' } }}
```

---

## 四、分步实现计划

### 阶段1：基础功能实现（30分钟）

#### Step 1.1：添加状态管理（5分钟）

**文件**：`frontend/src/layouts/DesktopTabLayout.tsx`

**任务**：
1. 导入 `useState`
2. 添加 `sidebarCollapsed` 状态
3. 计算 `currentDrawerWidth`

```typescript
// 新增导入
import { useState } from 'react';

// 新增状态
const [sidebarCollapsed, setSidebarCollapsed] = useState(false);

// 新增常量
const drawerWidth = 260;
const currentDrawerWidth = sidebarCollapsed ? 0 : drawerWidth;
```

#### Step 1.2：修改 Drawer 组件（10分钟）

**任务**：
1. 修改 Drawer 宽度为动态值
2. 添加过渡动画
3. 条件渲染 Sidebar

```typescript
<Drawer
    variant="permanent"
    sx={{
        display: { xs: 'none', sm: 'block' },
        '& .MuiDrawer-paper': {
            boxSizing: 'border-box',
            width: currentDrawerWidth,  // ← 修改
            transition: 'width 0.3s ease-in-out',  // ← 新增
            overflowX: 'hidden',  // ← 新增
            borderRight: sidebarCollapsed ? 'none' : '1px solid',  // ← 修改
            borderColor: 'divider',
        },
    }}
    open
>
    {!sidebarCollapsed && <Sidebar />}  {/* ← 修改 */}
</Drawer>
```

#### Step 1.3：适配主内容区（5分钟）

**任务**：修改主内容区宽度计算

```typescript
<Box
    component="main"
    sx={{
        flexGrow: 1,
        width: { sm: `calc(100% - ${currentDrawerWidth}px)` },  // ← 修改
        transition: 'width 0.3s ease-in-out',  // ← 新增
        display: 'flex',
        flexDirection: 'column',
    }}
>
```

#### Step 1.4：添加切换按钮（10分钟）

**任务**：
1. 导入图标
2. 在 Toolbar 添加按钮
3. 配置响应式显示

```typescript
// 新增导入
import ChevronLeftIcon from '@mui/icons-material/ChevronLeft';
import MenuIcon from '@mui/icons-material/Menu';

// 在 Toolbar 中添加（Typography 后）
<IconButton
    color="inherit"
    onClick={() => setSidebarCollapsed(!sidebarCollapsed)}
    sx={{ ml: 1, display: { xs: 'none', sm: 'inline-flex' } }}
>
    {sidebarCollapsed ? <MenuIcon /> : <ChevronLeftIcon />}
</IconButton>
```

---

### 阶段2：功能优化（15分钟）

#### Step 2.1：添加状态持久化（5分钟）

```typescript
import { useEffect } from 'react';

// 读取持久化状态
useEffect(() => {
    const saved = localStorage.getItem('sidebarCollapsed');
    if (saved !== null) {
        setSidebarCollapsed(JSON.parse(saved));
    }
}, []);

// 保存状态
useEffect(() => {
    localStorage.setItem('sidebarCollapsed', JSON.stringify(sidebarCollapsed));
}, [sidebarCollapsed]);
```

#### Step 2.2：添加 Tooltip（5分钟）

```typescript
import { Tooltip } from '@mui/material';

<Tooltip title={sidebarCollapsed ? "展开菜单" : "折叠菜单"}>
    <IconButton {...}>
        {/* ... */}
    </IconButton>
</Tooltip>
```

#### Step 2.3：添加无障碍标签（5分钟）

```typescript
<IconButton
    aria-label={sidebarCollapsed ? "展开菜单" : "折叠菜单"}
    {...}
>
```

---

### 阶段3：测试与验证（15分钟）

#### Step 3.1：功能测试

- [ ] 点击按钮能正常折叠/展开
- [ ] 动画流畅无卡顿
- [ ] 主内容区宽度正确调整
- [ ] 页面内容自适应重排正常

#### Step 3.2：持久化测试

- [ ] 折叠后刷新页面，状态保持
- [ ] 展开后刷新页面，状态保持
- [ ] 清除 localStorage 后恢复默认状态

#### Step 3.3：响应式测试

- [ ] 桌面端（≥900px）显示折叠按钮
- [ ] 平板端（600-900px）不显示折叠按钮
- [ ] 移动端（<600px）不显示折叠按钮
- [ ] 移动端原有抽屉功能不受影响

#### Step 3.4：兼容性测试

- [ ] Chrome 最新版
- [ ] Firefox 最新版
- [ ] Safari 最新版
- [ ] Edge 最新版

---

## 五、技术规范

### 5.1 代码规范

**命名约定**

| 类型 | 命名规则 | 示例 |
|------|---------|------|
| 状态变量 | camelCase | `sidebarCollapsed` |
| 常量 | camelCase | `drawerWidth` |
| 函数 | camelCase | `handleSidebarToggle` |
| 组件 | PascalCase | `DesktopTabLayout` |

**TypeScript 类型**

```typescript
// 状态类型明确
const [sidebarCollapsed, setSidebarCollapsed] = useState<boolean>(false);

// 常量类型推断
const drawerWidth: number = 260;
```

### 5.2 性能优化

**优化策略**

1. **条件渲染**：折叠时卸载 Sidebar 组件
   ```typescript
   {!sidebarCollapsed && <Sidebar />}
   ```

2. **CSS 动画**：使用纯 CSS transition，避免 JavaScript 动画
   ```typescript
   transition: 'width 0.3s ease-in-out'
   ```

3. **防抖处理**：快捷键多次触发时防抖（如需要）

4. **状态持久化**：仅在状态变更时写入 localStorage

### 5.3 可访问性（A11y）

**WCAG 2.1 合规**

- ✅ 键盘可访问（支持 Tab 键导航）
- ✅ `aria-label` 属性明确
- ✅ Tooltip 提供操作提示
- ✅ 图标语义清晰（展开/折叠）

---

## 六、风险评估

### 6.1 技术风险

| 风险 | 等级 | 影响 | 缓解措施 |
|------|------|------|---------|
| 动画卡顿 | 低 | 用户体验下降 | 使用 CSS transition，避免 JS 动画 |
| 状态同步失败 | 低 | 状态不一致 | localStorage 读写加异常处理 |
| 移动端误触 | 低 | 功能错乱 | 响应式断点严格控制 |

### 6.2 兼容性风险

| 浏览器 | 风险 | 缓解措施 |
|--------|------|---------|
| IE 11 | 高（不支持） | 项目不支持 IE 11 |
| Safari | 低 | 标准 CSS transition 支持良好 |
| Firefox | 低 | 标准 CSS transition 支持良好 |
| Chrome | 低 | 标准 CSS transition 支持良好 |

---

## 七、验收标准

### 7.1 功能验收

- [x] **F1**：点击按钮能切换侧边栏显示/隐藏
- [x] **F2**：折叠状态保存到 localStorage
- [x] **F3**：刷新页面后状态保持
- [x] **F4**：仅桌面端显示折叠按钮
- [x] **F5**：移动端功能不受影响

### 7.2 性能验收

- [x] **P1**：动画流畅，无明显卡顿（60fps）
- [x] **P2**：状态切换响应时间 < 50ms
- [x] **P3**：不影响页面整体加载速度

### 7.3 用户体验验收

- [x] **U1**：按钮位置易于发现
- [x] **U2**：图标语义清晰易懂
- [x] **U3**：Tooltip 提供操作提示
- [x] **U4**：动画效果自然流畅

---

## 八、后续优化方向

### 8.1 短期优化（1-2周）

1. **按钮图标动画**：旋转 180 度增强视觉反馈
2. **快捷键支持**：`Ctrl + B` 切换
3. **平板适配**：根据实际使用反馈调整断点

### 8.2 中期优化（1-2月）

1. **迷你侧边栏模式**：保留 60px 图标栏
2. **鼠标悬停展开**：迷你模式下悬停临时展开
3. **自定义宽度**：用户可拖拽调整侧边栏宽度

### 8.3 长期优化（3-6月）

1. **多布局切换**：支持左侧/右侧/顶部布局
2. **主题联动**：根据主题自动调整动画效果
3. **个性化配置**：全局设置中心统一管理

---

## 九、附录

### 9.1 相关文件清单

| 文件路径 | 修改内容 | 优先级 |
|---------|---------|-------|
| `frontend/src/layouts/DesktopTabLayout.tsx` | 主要修改 | 高 |
| `frontend/src/components/Sidebar.tsx` | 无需修改 | - |
| `docs/侧边栏折叠功能设计方案.md` | 本文档 | 高 |

### 9.2 参考资料

- [Material-UI Drawer API](https://mui.com/material-ui/api/drawer/)
- [React Hooks 最佳实践](https://react.dev/reference/react)
- [Web 动画性能优化](https://web.dev/animations/)
- [WCAG 2.1 无障碍指南](https://www.w3.org/WAI/WCAG21/quickref/)

### 9.3 更新日志

| 版本 | 日期 | 修改内容 | 作者 |
|------|------|---------|------|
| v1.0 | 2025-11-04 | 初始版本 | Claude |

---

## 十、审批记录

| 角色 | 姓名 | 审批意见 | 日期 | 签名 |
|------|------|---------|------|------|
| 产品经理 |  |  |  |  |
| 技术负责人 |  |  |  |  |
| UI/UX 设计师 |  |  |  |  |
| 前端开发负责人 |  |  |  |  |

---

**文档结束**
